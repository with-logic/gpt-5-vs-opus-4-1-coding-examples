<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regex Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #1e1e1e;
            --panel: #252526;
            --border: #3e3e42;
            --text: #d4d4d4;
            --accent: #007acc;
            --match-bg: #264f78;
            --group1: #ce9178;
            --group2: #4ec9b0;
            --error: #f48771;
        }

        body.light {
            --bg: #ffffff;
            --panel: #f3f3f3;
            --border: #e5e5e5;
            --text: #333;
            --match-bg: #add6ff;
            --group1: #a31515;
            --group2: #008080;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Fira Code', monospace;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            padding: 10px 20px;
            background-color: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 1.2rem; }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
        }

        button.secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        /* Main Layout */
        .workspace {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
        }

        .left-pane {
            width: 300px;
            border-right: 1px solid var(--border);
            background-color: var(--panel);
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow-y: auto;
        }

        .center-pane {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
            overflow-y: auto;
        }

        /* Inputs */
        .regex-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 1.1rem;
        }

        .input-wrapper {
            position: relative;
            flex-grow: 1;
            display: flex;
            align-items: center;
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 5px 10px;
            border-radius: 4px;
        }

        .slash { color: #888; font-weight: bold; }

        input[type="text"] {
            border: none;
            background: transparent;
            color: var(--text);
            font-family: inherit;
            font-size: inherit;
            width: 100%;
            outline: none;
        }

        /* Flags */
        .flags {
            font-size: 0.9rem;
            color: var(--accent);
            cursor: pointer;
            user-select: none;
        }

        /* Test Area */
        .test-area {
            position: relative;
            flex-grow: 1;
            min-height: 200px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg);
            font-size: 1rem;
            line-height: 1.5;
        }

        .backdrop, textarea {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 10px;
            margin: 0;
            border: none;
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        textarea {
            background: transparent;
            color: transparent;
            caret-color: var(--text);
            resize: none;
            outline: none;
            z-index: 2;
        }

        .backdrop {
            z-index: 1;
            color: var(--text);
            pointer-events: none;
        }

        mark {
            background-color: var(--match-bg);
            color: inherit;
            border-radius: 2px;
        }

        .error-msg {
            color: var(--error);
            font-size: 0.9rem;
            min-height: 1.2em;
        }

        /* Utilities */
        .cheatsheet h3 { font-size: 0.9rem; text-transform: uppercase; color: #888; }
        .token-btn {
            display: block;
            width: 100%;
            text-align: left;
            background: transparent;
            border: none;
            color: var(--text);
            padding: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
        }
        .token-btn:hover { background: rgba(255,255,255,0.1); }
        .token-code { color: var(--accent); font-weight: bold; margin-right: 8px; }

        /* Matches Table */
        .matches-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9rem;
        }
        .matches-table th { text-align: left; border-bottom: 1px solid var(--border); padding: 5px; color: #888; }
        .matches-table td { padding: 5px; border-bottom: 1px solid var(--border); }

    </style>
</head>
<body>

    <header>
        <h1>Regex Lab</h1>
        <div style="display:flex; gap:10px;">
            <button class="secondary" onclick="toggleTheme()">Theme</button>
            <button onclick="copyPermalink()">Share</button>
        </div>
    </header>

    <div class="workspace">
        <div class="left-pane">
            <div class="cheatsheet">
                <h3>Quick Insert</h3>
                <button class="token-btn" onclick="insertToken('\\d')"><span class="token-code">\d</span> Digit</button>
                <button class="token-btn" onclick="insertToken('\\w')"><span class="token-code">\w</span> Word Char</button>
                <button class="token-btn" onclick="insertToken('\\s')"><span class="token-code">\s</span> Whitespace</button>
                <button class="token-btn" onclick="insertToken('.')"><span class="token-code">.</span> Any Char</button>
                <button class="token-btn" onclick="insertToken('[A-Z]')"><span class="token-code">[A-Z]</span> Range</button>
                <button class="token-btn" onclick="insertToken('^')"><span class="token-code">^</span> Start</button>
                <button class="token-btn" onclick="insertToken('$')"><span class="token-code">$</span> End</button>
                <button class="token-btn" onclick="insertToken('( )')"><span class="token-code">()</span> Group</button>
                <button class="token-btn" onclick="insertToken('(?:)')"><span class="token-code">(?:)</span> Non-capture</button>
                <button class="token-btn" onclick="insertToken('(?=)')"><span class="token-code">(?=)</span> Lookahead</button>
            </div>
            <div style="margin-top: 20px;">
                <h3>Matches</h3>
                <div id="match-list"></div>
            </div>
        </div>

        <div class="center-pane">
            <div class="regex-bar">
                <span class="slash">/</span>
                <div class="input-wrapper">
                    <input type="text" id="regexInput" value="(\\w+)@(\\w+)\\.(\\w+)" placeholder="Pattern">
                </div>
                <span class="slash">/</span>
                <input type="text" id="flagsInput" value="g" style="width: 50px; border: 1px solid var(--border); padding: 5px; border-radius: 4px;">
            </div>
            <div class="error-msg" id="errorDisplay"></div>

            <div class="test-area">
                <div class="backdrop" id="highlights"></div>
                <textarea id="testString" spellcheck="false">Contact us at support@example.com or sales@company.org for more info.</textarea>
            </div>
        </div>
    </div>

    <script>
        const regexInput = document.getElementById('regexInput');
        const flagsInput = document.getElementById('flagsInput');
        const testString = document.getElementById('testString');
        const highlights = document.getElementById('highlights');
        const errorDisplay = document.getElementById('errorDisplay');
        const matchList = document.getElementById('match-list');

        // State
        function update() {
            const pattern = regexInput.value;
            const flags = flagsInput.value;
            const text = testString.value;

            // Sync scroll
            highlights.scrollTop = testString.scrollTop;
            highlights.scrollLeft = testString.scrollLeft;

            if (!pattern) {
                highlights.textContent = text;
                errorDisplay.textContent = "";
                matchList.innerHTML = "";
                return;
            }

            try {
                const re = new RegExp(pattern, flags);
                errorDisplay.textContent = "";
                
                // Find matches
                let match;
                let matches = [];
                
                // Prevent infinite loop on empty match
                if (pattern === "") return; 

                // Reset lastIndex if global
                if (!flags.includes('g')) {
                    match = re.exec(text);
                    if (match) matches.push(match);
                } else {
                    let safeCounter = 0;
                    while ((match = re.exec(text)) !== null && safeCounter < 1000) {
                        matches.push(match);
                        if (match.index === re.lastIndex) re.lastIndex++; // Avoid infinite loop for zero-width matches
                        safeCounter++;
                    }
                }

                renderHighlights(text, matches);
                renderMatchTable(matches);
                updateHash();

            } catch (e) {
                errorDisplay.textContent = e.message;
                highlights.textContent = text;
                matchList.innerHTML = "";
            }
        }

        function renderHighlights(text, matches) {
            if (matches.length === 0) {
                highlights.textContent = text;
                return;
            }

            let html = "";
            let lastIdx = 0;

            matches.forEach(m => {
                // Text before match
                html += escapeHtml(text.substring(lastIdx, m.index));
                // Match
                html += `<mark>${escapeHtml(m[0])}</mark>`;
                lastIdx = m.index + m[0].length;
            });

            // Remaining text
            html += escapeHtml(text.substring(lastIdx));
            
            // Handle newlines for backdrop alignment
            html = html.replace(/\n/g, '<br>');
            
            highlights.innerHTML = html;
        }

        function renderMatchTable(matches) {
            if (matches.length === 0) {
                matchList.innerHTML = "No matches.";
                return;
            }

            let html = `<table class="matches-table"><thead><tr><th>#</th><th>Match</th><th>Groups</th></tr></thead><tbody>`;
            
            matches.forEach((m, i) => {
                const groups = m.slice(1).map(g => g ? escapeHtml(g) : "<i>undefined</i>").join(", ");
                html += `<tr><td>${i + 1}</td><td>${escapeHtml(m[0])}</td><td>${groups}</td></tr>`;
            });

            html += `</tbody></table>`;
            matchList.innerHTML = html;
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function insertToken(token) {
            const start = regexInput.selectionStart;
            const end = regexInput.selectionEnd;
            const text = regexInput.value;
            regexInput.value = text.substring(0, start) + token + text.substring(end);
            regexInput.focus();
            regexInput.selectionStart = regexInput.selectionEnd = start + token.length;
            update();
        }

        function toggleTheme() {
            document.body.classList.toggle('light');
        }

        function updateHash() {
            const state = {
                p: regexInput.value,
                f: flagsInput.value,
                t: testString.value
            };
            // Avoid flooding history
            // history.replaceState(null, null, '#' + encodeURIComponent(JSON.stringify(state)));
        }

        function copyPermalink() {
            const state = {
                p: regexInput.value,
                f: flagsInput.value,
                t: testString.value
            };
            const url = window.location.origin + window.location.pathname + '#' + encodeURIComponent(JSON.stringify(state));
            navigator.clipboard.writeText(url);
            alert("Link copied to clipboard!");
        }

        // Load from hash
        if (window.location.hash) {
            try {
                const state = JSON.parse(decodeURIComponent(window.location.hash.substring(1)));
                if (state.p) regexInput.value = state.p;
                if (state.f) flagsInput.value = state.f;
                if (state.t) testString.value = state.t;
            } catch (e) { console.log("Invalid hash"); }
        }

        // Listeners
        regexInput.addEventListener('input', update);
        flagsInput.addEventListener('input', update);
        testString.addEventListener('input', update);
        testString.addEventListener('scroll', () => {
            highlights.scrollTop = testString.scrollTop;
            highlights.scrollLeft = testString.scrollLeft;
        });

        update();

    </script>
</body>
</html>
