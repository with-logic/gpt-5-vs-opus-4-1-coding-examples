<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Journey Flow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            overflow: hidden;
        }

        .toolbar {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        h1 {
            font-size: 20px;
            margin-right: 20px;
            color: #2c3e50;
        }

        .btn {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        #canvas {
            width: 100%;
            height: calc(100vh - 60px);
            cursor: grab;
            position: relative;
            background:
                repeating-linear-gradient(0deg, transparent, transparent 19px, #e0e0e0 19px, #e0e0e0 20px),
                repeating-linear-gradient(90deg, transparent, transparent 19px, #e0e0e0 19px, #e0e0e0 20px);
            background-size: 20px 20px;
        }

        .stage {
            position: absolute;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 15px 20px;
            cursor: move;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 150px;
            z-index: 10;
        }

        .stage.dragging {
            opacity: 0.7;
            cursor: grabbing;
        }

        .stage:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .stage-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
            color: #2c3e50;
            outline: none;
        }

        .stage-desc {
            font-size: 12px;
            color: #7f8c8d;
            outline: none;
        }

        .delete-stage {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
        }

        .connector-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #3498db;
            border-radius: 50%;
            cursor: crosshair;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #3498db;
        }

        .connector-dot.right {
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connector-dot.left {
            left: -5px;
            top: 50%;
            transform: translateY(-50%);
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .awareness { border-color: #9b59b6; background: #f4ecf7; }
        .consideration { border-color: #3498db; background: #ebf5fb; }
        .decision { border-color: #f39c12; background: #fef5e7; }
        .purchase { border-color: #27ae60; background: #eafaf1; }
        .retention { border-color: #e74c3c; background: #fadbd8; }
    </style>
</head>
<body>
    <div class="toolbar">
        <h1>Customer Journey Flow</h1>
        <button class="btn" onclick="addStage('Awareness')">+ Awareness</button>
        <button class="btn" onclick="addStage('Consideration')">+ Consideration</button>
        <button class="btn" onclick="addStage('Decision')">+ Decision</button>
        <button class="btn" onclick="addStage('Purchase')">+ Purchase</button>
        <button class="btn" onclick="addStage('Retention')">+ Retention</button>
        <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>
    </div>

    <div id="canvas">
        <svg id="connections"></svg>
    </div>

    <script>
        let stages = [];
        let connections = [];
        let draggedElement = null;
        let offset = { x: 0, y: 0 };
        let connectingFrom = null;
        let stageCounter = 0;

        function addStage(type) {
            const stage = {
                id: stageCounter++,
                type: type,
                x: 100 + (stages.length * 50),
                y: 100 + (stages.length * 30),
                title: type,
                description: `${type} stage`
            };

            stages.push(stage);
            renderStages();
        }

        function renderStages() {
            const canvas = document.getElementById('canvas');
            const existingStages = canvas.querySelectorAll('.stage');
            existingStages.forEach(s => s.remove());

            stages.forEach(stage => {
                const el = document.createElement('div');
                el.className = `stage ${stage.type.toLowerCase()}`;
                el.style.left = stage.x + 'px';
                el.style.top = stage.y + 'px';
                el.dataset.id = stage.id;

                el.innerHTML = `
                    <button class="delete-stage" onclick="deleteStage(${stage.id})">Ã—</button>
                    <div class="connector-dot right" onclick="startConnection(${stage.id}, event)"></div>
                    <div class="connector-dot left"></div>
                    <div class="stage-title" contenteditable="true" onblur="updateStage(${stage.id}, 'title', this.textContent)">${stage.title}</div>
                    <div class="stage-desc" contenteditable="true" onblur="updateStage(${stage.id}, 'description', this.textContent)">${stage.description}</div>
                `;

                el.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('stage-title') ||
                        e.target.classList.contains('stage-desc') ||
                        e.target.classList.contains('delete-stage') ||
                        e.target.classList.contains('connector-dot')) {
                        return;
                    }

                    draggedElement = el;
                    offset.x = e.clientX - stage.x;
                    offset.y = e.clientY - stage.y;
                    el.classList.add('dragging');
                });

                canvas.appendChild(el);
            });

            renderConnections();
        }

        document.addEventListener('mousemove', (e) => {
            if (draggedElement) {
                const id = parseInt(draggedElement.dataset.id);
                const stage = stages.find(s => s.id === id);

                stage.x = e.clientX - offset.x;
                stage.y = e.clientY - offset.y;

                draggedElement.style.left = stage.x + 'px';
                draggedElement.style.top = stage.y + 'px';

                renderConnections();
            }
        });

        document.addEventListener('mouseup', () => {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }
        });

        function updateStage(id, field, value) {
            const stage = stages.find(s => s.id === id);
            if (stage) {
                stage[field] = value;
            }
        }

        function deleteStage(id) {
            stages = stages.filter(s => s.id !== id);
            connections = connections.filter(c => c.from !== id && c.to !== id);
            renderStages();
        }

        function startConnection(fromId, e) {
            e.stopPropagation();
            connectingFrom = fromId;

            const canvas = document.getElementById('canvas');
            const mouseHandler = (e) => {
                const target = e.target.closest('.stage');
                if (target && connectingFrom !== null) {
                    const toId = parseInt(target.dataset.id);
                    if (toId !== connectingFrom && !connections.find(c => c.from === connectingFrom && c.to === toId)) {
                        connections.push({ from: connectingFrom, to: toId });
                        renderConnections();
                    }
                    connectingFrom = null;
                    canvas.removeEventListener('click', mouseHandler);
                }
            };

            canvas.addEventListener('click', mouseHandler);
        }

        function renderConnections() {
            const svg = document.getElementById('connections');
            svg.innerHTML = '';

            connections.forEach(conn => {
                const fromStage = stages.find(s => s.id === conn.from);
                const toStage = stages.find(s => s.id === conn.to);

                if (!fromStage || !toStage) return;

                const fromEl = document.querySelector(`[data-id="${conn.from}"]`);
                const toEl = document.querySelector(`[data-id="${conn.to}"]`);

                if (!fromEl || !toEl) return;

                const fromRect = fromEl.getBoundingClientRect();
                const toRect = toEl.getBoundingClientRect();

                const x1 = fromStage.x + fromRect.width;
                const y1 = fromStage.y + fromRect.height / 2;
                const x2 = toStage.x;
                const y2 = toStage.y + toRect.height / 2;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const midX = (x1 + x2) / 2;

                path.setAttribute('d', `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
                path.setAttribute('stroke', '#3498db');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('fill', 'none');
                path.setAttribute('marker-end', 'url(#arrowhead)');

                svg.appendChild(path);
            });

            // Add arrowhead marker
            if (connections.length > 0 && !svg.querySelector('defs')) {
                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                defs.innerHTML = `
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#3498db" />
                    </marker>
                `;
                svg.insertBefore(defs, svg.firstChild);
            }
        }

        function clearAll() {
            if (confirm('Clear all stages and connections?')) {
                stages = [];
                connections = [];
                renderStages();
            }
        }

        // Add initial stages
        addStage('Awareness');
        setTimeout(() => {
            stages[0].x = 150;
            stages[0].y = 200;
            addStage('Consideration');
            stages[1].x = 400;
            stages[1].y = 200;
            addStage('Purchase');
            stages[2].x = 650;
            stages[2].y = 200;
            connections.push({ from: 0, to: 1 }, { from: 1, to: 2 });
            renderStages();
        }, 100);
    </script>
</body>
</html>