<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinetic Typography Studio | Elite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script>
        window.React = window.React || React;
        window.ReactDOM = window.ReactDOM || ReactDOM;
    </script>
    <script src="https://unpkg.com/lucide-react@0.454.0/dist/umd/lucide-react.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Playfair+Display:ital,wght@0,700;1,700&family=Space+Mono:wght@400;700&family=Bungee&family=Roboto+Condensed:wght@700&family=Permanent+Marker&family=Syncopate:wght@400;700&family=Outfit:wght@100;400;900&display=swap');
        
        :root {
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.4);
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Outfit', sans-serif;
            user-select: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .timeline-grid {
            background-image: 
                linear-gradient(to right, rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 50px 100%, 100% 48px;
        }

        .keyframe {
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .keyframe:hover { transform: scale(1.4) rotate(45deg); background-color: #fff; }

        .range-input {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #1e293b;
            border-radius: 2px;
            outline: none;
        }
        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #fff;
            border: 2px solid var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glow-text {
            text-shadow: 0 0 20px var(--accent-glow);
        }

        @keyframes pulse-slow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-slow { animation: pulse-slow 3s infinite; }

        @media (prefers-reduced-motion: reduce) {
            * { animation: none !important; transition: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        
        // Robust icon access
        const Lucide = window.lucide || window.lucideReact || {};
        const { 
            Play, Pause, SkipBack, SkipForward, Plus, Trash2, 
            Download, Music, Type, Layers, Maximize, 
            Minimize, Move, Scale, RotateCcw, Ghost, Eye, EyeOff,
            Activity, Box, Grid, ChevronRight, ChevronDown, Save, 
            MousePointer2, Scissors, Copy, Share2, Palette, Waves,
            Wind, Zap, Sparkles, Sliders, Lock, Unlock,
            DownloadCloud, Settings2, HelpCircle
        } = Lucide;

        // Fallback for icons to prevent Error #130
        const IconSafe = (IconComp) => {
            return (props) => IconComp ? <IconComp {...props} /> : <div className="w-4 h-4 bg-slate-700 rounded-sm" />;
        };

        const icons = {
            Play: IconSafe(Play),
            Pause: IconSafe(Pause),
            SkipBack: IconSafe(SkipBack),
            SkipForward: IconSafe(SkipForward),
            Plus: IconSafe(Plus),
            Trash2: IconSafe(Trash2),
            Download: IconSafe(Download),
            Music: IconSafe(Music),
            Type: IconSafe(Type),
            Layers: IconSafe(Layers),
            Maximize: IconSafe(Maximize),
            Minimize: IconSafe(Minimize),
            Move: IconSafe(Move),
            Scale: IconSafe(Scale),
            RotateCcw: IconSafe(RotateCcw),
            Ghost: IconSafe(Ghost),
            Eye: IconSafe(Eye),
            EyeOff: IconSafe(EyeOff),
            Activity: IconSafe(Activity),
            Box: IconSafe(Box),
            Grid: IconSafe(Grid),
            ChevronRight: IconSafe(ChevronRight),
            ChevronDown: IconSafe(ChevronDown),
            Save: IconSafe(Save),
            MousePointer2: IconSafe(MousePointer2),
            Scissors: IconSafe(Scissors),
            Copy: IconSafe(Copy),
            Share2: IconSafe(Share2),
            Palette: IconSafe(Palette),
            Waves: IconSafe(Waves),
            Wind: IconSafe(Wind),
            Zap: IconSafe(Zap),
            Sparkles: IconSafe(Sparkles),
            Sliders: IconSafe(Sliders),
            Lock: IconSafe(Lock),
            Unlock: IconSafe(Unlock),
            DownloadCloud: IconSafe(DownloadCloud),
            Settings2: IconSafe(Settings2),
            HelpCircle: IconSafe(HelpCircle)
        };

        const { 
            Play, Pause, SkipBack, SkipForward, Plus, Trash2, 
            Download, Music, Type, Layers, Maximize, 
            Minimize, Move, Scale, RotateCcw, Ghost, Eye, EyeOff,
            Activity, Box, Grid, ChevronRight, ChevronDown, Save, 
            MousePointer2, Scissors, Copy, Share2, Palette, Waves,
            Wind, Zap, Sparkles, Sliders, Lock, Unlock,
            DownloadCloud, Settings2, HelpCircle
        } = icons;

        // --- UTILS ---
        const ASPECT_RATIOS = {
            '16:9': { w: 1920, h: 1080, ratio: 16/9 },
            '9:16': { w: 1080, h: 1920, ratio: 9/16 },
            '1:1': { w: 1080, h: 1080, ratio: 1/1 }
        };

        const EASINGS = {
            linear: (t) => t,
            easeIn: (t) => t * t,
            easeOut: (t) => t * (2 - t),
            easeInOut: (t) => t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t,
            bounce: (t) => {
                const n1 = 7.5625, d1 = 2.75;
                if (t < 1 / d1) return n1 * t * t;
                else if (t < 2 / d1) return n1 * (t -= 1.5 / d1) * t + 0.75;
                else if (t < 2.5 / d1) return n1 * (t -= 2.25 / d1) * t + 0.9375;
                else return n1 * (t -= 2.625 / d1) * t + 0.984375;
            },
            elastic: (t) => t === 0 || t === 1 ? t : -Math.pow(2, 10 * t - 10) * Math.sin((t * 10 - 10.75) * (2 * Math.PI) / 3)
        };

        const DEFAULT_LAYER = (id) => ({
            id,
            name: `Text ${id}`,
            text: 'CREATIVE',
            visible: true,
            // Style
            fontFamily: 'Outfit',
            fontSize: 200,
            fontWeight: '900',
            fill: '#ffffff',
            gradient: false,
            gradientEnd: '#6366f1',
            outline: '#ffffff',
            outlineWidth: 0,
            shadow: true,
            shadowColor: 'rgba(99, 102, 241, 0.4)',
            shadowBlur: 30,
            // Layout
            tracking: -2,
            lineHeight: 1,
            align: 'center',
            stagger: 0.04,
            // Transform
            x: 960, y: 540, scale: 1, rotation: 0, opacity: 1,
            keyframes: { x: [], y: [], scale: [], rotation: [], opacity: [] },
            presets: [] 
        });

        const App = () => {
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(8);
            const [isPlaying, setIsPlaying] = useState(false);
            const [layers, setLayers] = useState([DEFAULT_LAYER(1)]);
            const [selectedLayerId, setSelectedLayerId] = useState(1);
            const [aspectRatio, setAspectRatio] = useState('16:9');
            const [resolution, setResolution] = useState(ASPECT_RATIOS['16:9']);
            const [bgColor, setBgColor] = useState('#020617');
            const [showGrid, setShowGrid] = useState(true);
            const [showSafeAreas, setShowSafeAreas] = useState(false);
            const [fps, setFps] = useState(60);
            const [isExporting, setIsExporting] = useState(false);
            const [audioBuffer, setAudioBuffer] = useState(null);
            const [beats, setBeats] = useState([]);
            const [audioData, setAudioData] = useState(null);
            const [snapToBeats, setSnapToBeats] = useState(true);

            const canvasRef = useRef(null);
            const audioCtxRef = useRef(null);
            const audioSourceRef = useRef(null);
            const analyserRef = useRef(null);
            const requestRef = useRef();
            const lastTimeRef = useRef(0);

            // Interpolation
            const getVal = useCallback((layer, prop, time) => {
                const keys = layer.keyframes[prop]?.sort((a, b) => a.time - b.time) || [];
                if (keys.length === 0) return layer[prop];
                if (time <= keys[0].time) return keys[0].value;
                if (time >= keys[keys.length - 1].time) return keys[keys.length - 1].value;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (time >= keys[i].time && time <= keys[i + 1].time) {
                        const t = (time - keys[i].time) / (keys[i + 1].time - keys[i].time);
                        const ease = EASINGS[keys[i].easing] || EASINGS.easeInOut;
                        return keys[i].value + (keys[i + 1].value - keys[i].value) * ease(t);
                    }
                }
                return layer[prop];
            }, []);

            // Renderer
            const render = useCallback((time, ctx, isExport = false) => {
                const { w, h } = resolution;
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, w, h);

                if (showGrid && !isExport) {
                    ctx.strokeStyle = 'rgba(255,255,255,0.03)';
                    for (let x = 0; x <= w; x += 100) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke(); }
                    for (let y = 0; y <= h; y += 100) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke(); }
                }

                layers.forEach(l => {
                    if (!l.visible) return;
                    ctx.save();
                    const x = getVal(l, 'x', time);
                    const y = getVal(l, 'y', time);
                    const scale = getVal(l, 'scale', time);
                    const rot = getVal(l, 'rotation', time);
                    const opac = getVal(l, 'opacity', time);

                    ctx.translate(x, y);
                    ctx.scale(scale, scale);
                    ctx.rotate(rot * Math.PI / 180);
                    ctx.globalAlpha = opac;

                    if (l.shadow) {
                        ctx.shadowColor = l.shadowColor;
                        ctx.shadowBlur = l.shadowBlur;
                    }

                    ctx.font = `italic ${l.fontWeight} ${l.fontSize}px "${l.fontFamily}"`;
                    ctx.textAlign = l.align;
                    ctx.textBaseline = 'middle';

                    const lines = l.text.split('\n');
                    lines.forEach((line, lIdx) => {
                        const lineY = (lIdx - (lines.length - 1) / 2) * l.fontSize * l.lineHeight;
                        const chars = line.split('');
                        let curX = 0;
                        const widths = chars.map(c => ctx.measureText(c).width);
                        const totW = widths.reduce((a, b) => a + b, 0) + (chars.length - 1) * l.tracking;
                        let startX = l.align === 'center' ? -totW/2 : l.align === 'right' ? -totW : 0;

                        chars.forEach((char, cIdx) => {
                            const cw = widths[cIdx];
                            const px = startX + curX + cw/2;
                            curX += cw + l.tracking;
                            const charT = time - (cIdx * l.stagger);
                            
                            ctx.save();
                            ctx.translate(px, lineY);

                            // Animation Presets
                            if (l.presets.includes('typewriter') && charT < 0) ctx.globalAlpha = 0;
                            if (l.presets.includes('bounce')) ctx.translate(0, -Math.abs(Math.sin(charT * 8)) * 40);
                            if (l.presets.includes('glitch') && isPlaying && Math.random() > 0.95) {
                                ctx.translate((Math.random()-0.5)*30, (Math.random()-0.5)*30);
                                ctx.fillStyle = Math.random() > 0.5 ? '#6366f1' : '#f43f5e';
                            }
                            if (l.presets.includes('cascade')) {
                                const fall = Math.max(0, 1 - charT * 2.5) * 300;
                                ctx.translate(0, -fall);
                                ctx.scale(1, Math.min(1, charT * 3));
                            }
                            if (l.presets.includes('liquid') && audioData) {
                                const v = audioData[Math.floor((cIdx/chars.length)*audioData.length)] || 0;
                                ctx.scale(1 + v/500, 1 + v/255);
                                ctx.rotate((v/255) * 0.1);
                            }

                            if (l.gradient) {
                                const g = ctx.createLinearGradient(-cw/2, -l.fontSize/2, cw/2, l.fontSize/2);
                                g.addColorStop(0, l.fill); g.addColorStop(1, l.gradientEnd);
                                ctx.fillStyle = g;
                            } else ctx.fillStyle = l.fill;

                            ctx.fillText(char, 0, 0);
                            if (l.outlineWidth > 0) {
                                ctx.strokeStyle = l.outline; ctx.lineWidth = l.outlineWidth;
                                ctx.strokeText(char, 0, 0);
                            }
                            ctx.restore();
                        });
                    });
                    ctx.restore();
                });
            }, [resolution, bgColor, layers, showGrid, isPlaying, audioData]);

            // Loop
            const loop = useCallback((t) => {
                if (isPlaying) {
                    const dt = (t - lastTimeRef.current) / 1000;
                    lastTimeRef.current = t;
                    setCurrentTime(p => (p + dt) >= duration ? 0 : p + dt);
                } else lastTimeRef.current = t;

                if (analyserRef.current && isPlaying) {
                    const d = new Uint8Array(analyserRef.current.frequencyBinCount);
                    analyserRef.current.getByteFrequencyData(d);
                    setAudioData(d);
                }

                const ctx = canvasRef.current.getContext('2d');
                render(currentTime, ctx);
                requestRef.current = requestAnimationFrame(loop);
            }, [isPlaying, currentTime, duration, render]);

            useEffect(() => {
                requestRef.current = requestAnimationFrame(loop);
                return () => cancelAnimationFrame(requestRef.current);
            }, [loop]);

            // Handlers
            const handleAudio = async (e) => {
                const f = e.target.files[0]; if (!f) return;
                const ab = await f.arrayBuffer();
                if (!audioCtxRef.current) audioCtxRef.current = new AudioContext();
                const b = await audioCtxRef.current.decodeAudioData(ab);
                setAudioBuffer(b); setDuration(b.duration);
                const d = b.getChannelData(0), beatsFound = [], step = b.sampleRate / 4;
                for (let i = 0; i < d.length; i += step) {
                    let m = 0; for(let j=0; j<step; j++) if(Math.abs(d[i+j])>m) m=Math.abs(d[i+j]);
                    if (m > 0.65) beatsFound.push(i/b.sampleRate);
                }
                setBeats(beatsFound);
            };

            const play = () => {
                if (!isPlaying) {
                    if (audioBuffer) {
                        audioSourceRef.current = audioCtxRef.current.createBufferSource();
                        audioSourceRef.current.buffer = audioBuffer;
                        analyserRef.current = audioCtxRef.current.createAnalyser();
                        audioSourceRef.current.connect(analyserRef.current);
                        analyserRef.current.connect(audioCtxRef.current.destination);
                        audioSourceRef.current.start(0, currentTime);
                    }
                } else if (audioSourceRef.current) audioSourceRef.current.stop();
                setIsPlaying(!isPlaying);
            };

            const kf = (p) => {
                const l = layers.find(l => l.id === selectedLayerId); if (!l) return;
                let t = currentTime;
                if (snapToBeats && beats.length) {
                    const c = beats.reduce((pr, cu) => Math.abs(cu-t) < Math.abs(pr-t) ? cu : pr);
                    if (Math.abs(c-t) < 0.25) t = c;
                }
                const n = { ...l.keyframes };
                n[p] = [...(n[p]||[]).filter(k => Math.abs(k.time-t)>0.05), {time:t, value:l[p], easing:'easeInOut'}].sort((a,b)=>a.time-b.time);
                setLayers(layers.map(ly => ly.id === selectedLayerId ? {...ly, keyframes:n} : ly));
            };

            const exportVid = () => {
                setIsExporting(true); setCurrentTime(0);
                const stream = canvasRef.current.captureStream(fps);
                const rec = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
                const chunks = []; rec.ondataavailable = e => chunks.push(e.data);
                rec.onstop = () => {
                    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(chunks, {type:'video/webm'}));
                    a.download = `kinetic-${Date.now()}.webm`; a.click(); setIsExporting(false);
                };
                rec.start(); setIsPlaying(true);
                const interval = setInterval(() => { if (currentTime >= duration-0.1) { rec.stop(); setIsPlaying(false); clearInterval(interval); } }, 100);
            };

            const sel = layers.find(l => l.id === selectedLayerId);

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-200">
                    {/* TOP BAR */}
                    <nav className="h-16 glass border-b border-white/10 px-8 flex items-center justify-between z-50">
                        <div className="flex items-center gap-6">
                            <div className="flex items-center gap-2 bg-indigo-600 px-3 py-1.5 rounded-lg text-white font-black italic shadow-lg shadow-indigo-500/30">
                                <Zap size={18} fill="white" /> STUDIO
                            </div>
                            <div className="flex bg-slate-800/40 p-1 rounded-xl">
                                {Object.keys(ASPECT_RATIOS).map(r => (
                                    <button key={r} onClick={() => {setAspectRatio(r); setResolution(ASPECT_RATIOS[r]);}} className={`px-4 py-1 rounded-lg text-[10px] font-black uppercase transition-all ${aspectRatio===r ? 'bg-indigo-500 text-white' : 'text-slate-500 hover:text-white'}`}>{r}</button>
                                ))}
                            </div>
                        </div>
                        <button onClick={exportVid} disabled={isExporting} className="bg-white text-black hover:bg-indigo-500 hover:text-white px-8 py-2.5 rounded-full text-xs font-black flex items-center gap-2 transition-all active:scale-90 disabled:opacity-50">
                            <DownloadCloud size={16} /> {isExporting ? 'RENDERING...' : 'EXPORT'}
                        </button>
                    </nav>

                    <div className="flex flex-1 overflow-hidden">
                        {/* LAYERS */}
                        <aside className="w-72 glass border-r border-white/5 flex flex-col p-4 gap-4">
                            <div className="flex items-center justify-between px-2">
                                <span className="text-[10px] font-black tracking-[0.2em] text-slate-500 uppercase">Layers</span>
                                <button onClick={() => setLayers([...layers, DEFAULT_LAYER(layers.length+1)])} className="text-indigo-400 hover:text-white"><Plus size={20} /></button>
                            </div>
                            <div className="flex-1 overflow-y-auto no-scrollbar space-y-2">
                                {layers.map(l => (
                                    <div key={l.id} onClick={()=>setSelectedLayerId(l.id)} className={`group flex items-center justify-between p-4 rounded-2xl cursor-pointer transition-all border ${selectedLayerId===l.id ? 'bg-indigo-600/10 border-indigo-500/40 shadow-inner' : 'bg-transparent border-transparent hover:bg-white/5'}`}>
                                        <div className="flex items-center gap-3 overflow-hidden">
                                            <div className={`w-2 h-2 rounded-full ${selectedLayerId===l.id ? 'bg-indigo-400 animate-pulse' : 'bg-slate-700'}`}></div>
                                            <span className="text-xs font-bold truncate">{l.name}</span>
                                        </div>
                                        <div className="flex gap-2 opacity-0 group-hover:opacity-100">
                                            <button onClick={(e)=>{e.stopPropagation(); setLayers(layers.map(ly=>ly.id===l.id?{...ly,visible:!ly.visible}:ly))}}>{l.visible?<Eye size={14}/>:<EyeOff size={14}/>}</button>
                                            <button onClick={(e)=>{e.stopPropagation(); setLayers(layers.filter(ly=>ly.id!==l.id))}} className="text-red-400"><Trash2 size={14}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </aside>

                        {/* PREVIEW */}
                        <main className="flex-1 bg-[#010409] flex flex-col relative overflow-hidden">
                            <div className="flex-1 flex items-center justify-center p-12">
                                <div className="relative bg-[#020617] shadow-[0_0_120px_rgba(0,0,0,0.8)] border border-white/5 overflow-hidden transition-all duration-700" style={{ width: '100%', maxWidth: aspectRatio==='9:16'?'420px':'960px', aspectRatio: resolution.ratio }}>
                                    <canvas ref={canvasRef} width={resolution.w} height={resolution.h} className="w-full h-full object-contain" />
                                    {showSafeAreas && <div className="absolute inset-0 pointer-events-none border-[60px] border-indigo-500/5"><div className="w-full h-full border border-dashed border-indigo-500/10"></div></div>}
                                </div>
                            </div>
                            <div className="h-24 glass border-t border-white/5 flex items-center justify-center gap-12">
                                <button onClick={()=>setCurrentTime(Math.max(0,currentTime-1))} className="text-slate-500 hover:text-white transition-colors"><SkipBack size={24}/></button>
                                <button onClick={play} className="w-16 h-16 bg-white text-black rounded-full flex items-center justify-center shadow-2xl hover:scale-110 active:scale-90 transition-all">
                                    {isPlaying ? <Pause size={32} fill="black"/> : <Play size={32} fill="black" className="ml-1"/>}
                                </button>
                                <button onClick={()=>setCurrentTime(Math.min(duration,currentTime+1))} className="text-slate-500 hover:text-white transition-colors"><SkipForward size={24}/></button>
                                <div className="absolute right-12 text-[11px] font-black tracking-widest text-slate-500 bg-slate-800/50 px-4 py-2 rounded-full border border-white/5">
                                    <span className="text-white">{currentTime.toFixed(2)}s</span> / {duration.toFixed(2)}s
                                </div>
                            </div>
                        </main>

                        {/* PANEL */}
                        <aside className="w-80 glass border-l border-white/5 flex flex-col overflow-y-auto no-scrollbar p-6 gap-8">
                            {!sel ? <div className="flex-1 flex flex-col items-center justify-center opacity-20 text-center"><Settings2 size={48} className="mb-4"/><p className="text-[10px] font-black uppercase tracking-widest">Select Layer<br/>to begin</p></div> : (
                                <>
                                    <section className="space-y-4">
                                        <div className="flex items-center gap-2 text-indigo-400"><Type size={14}/><span className="text-[10px] font-black uppercase tracking-[0.2em]">Typo</span></div>
                                        <textarea value={sel.text} onChange={e=>setLayers(layers.map(l=>l.id===selectedLayerId?{...l,text:e.target.value}:l))} className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-sm font-bold outline-none focus:border-indigo-500 h-28 resize-none transition-all"/>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-1">
                                                <label className="text-[9px] text-slate-500 uppercase font-black">Font</label>
                                                <select value={sel.fontFamily} onChange={e=>setLayers(layers.map(l=>l.id===selectedLayerId?{...l,fontFamily:e.target.value}:l))} className="w-full bg-white/5 border border-white/10 rounded-xl p-2.5 text-[10px] outline-none">
                                                    <option>Outfit</option><option>Syncopate</option><option>Bungee</option><option>Space Mono</option><option>Permanent Marker</option>
                                                </select>
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[9px] text-slate-500 uppercase font-black">Align</label>
                                                <div className="flex bg-white/5 rounded-xl p-1 gap-1">
                                                    {['left','center','right'].map(a=><button key={a} onClick={()=>setLayers(layers.map(l=>l.id===selectedLayerId?{...l,align:a}:l))} className={`flex-1 h-6 rounded-lg ${sel.align===a?'bg-indigo-500':'hover:bg-white/5'}`}></button>)}
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <section className="space-y-4">
                                        <div className="flex items-center gap-2 text-indigo-400"><Palette size={14}/><span className="text-[10px] font-black uppercase tracking-[0.2em]">Style</span></div>
                                        <div className="flex items-center justify-between">
                                            <input type="color" value={sel.fill} onChange={e=>setLayers(layers.map(l=>l.id===selectedLayerId?{...l,fill:e.target.value}:l))} className="w-10 h-10 rounded-full bg-transparent border-none cursor-pointer shadow-xl"/>
                                            <div className="flex items-center gap-3">
                                                <span className="text-[9px] font-black text-slate-500">GRADIENT</span>
                                                <button onClick={()=>setLayers(layers.map(l=>l.id===selectedLayerId?{...l,gradient:!l.gradient}:l))} className={`w-10 h-5 rounded-full transition-all relative ${sel.gradient?'bg-indigo-500':'bg-slate-800'}`}><div className={`absolute top-1 w-3 h-3 rounded-full bg-white transition-all ${sel.gradient?'left-6':'left-1'}`}></div></button>
                                            </div>
                                        </div>
                                        {['fontSize','tracking','stagger'].map(p=>(
                                            <div key={p} className="space-y-2">
                                                <div className="flex justify-between text-[9px] font-black text-slate-500"><span>{p.toUpperCase()}</span><span>{sel[p]}</span></div>
                                                <input type="range" min={p==='fontSize'?20:p==='tracking'?-50:0} max={p==='fontSize'?600:p==='tracking'?100:0.5} step={p==='stagger'?0.01:1} value={sel[p]} onChange={e=>setLayers(layers.map(l=>l.id===selectedLayerId?{...l,[p]:parseFloat(e.target.value)}:l))} className="range-input"/>
                                            </div>
                                        ))}
                                    </section>

                                    <section className="space-y-4">
                                        <div className="flex items-center justify-between text-indigo-400">
                                            <div className="flex items-center gap-2"><Activity size={14}/><span className="text-[10px] font-black uppercase tracking-[0.2em]">Motion</span></div>
                                            <button onClick={()=>setSnapToBeats(!snapToBeats)} className={`text-[8px] px-2 py-1 rounded border ${snapToBeats?'border-indigo-500 text-indigo-400':'border-white/10 text-slate-600'}`}>SNAP TO BEAT</button>
                                        </div>
                                        {['x','y','scale','rotation','opacity'].map(p=>(
                                            <div key={p} className="space-y-2">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-[9px] font-black text-slate-400 uppercase">{p}</span>
                                                    <button onClick={()=>kf(p)} className={`p-1.5 rounded-lg transition-all ${sel.keyframes[p]?.some(k=>Math.abs(k.time-currentTime)<0.05)?'bg-indigo-500 shadow-lg shadow-indigo-500/40':'bg-white/5 text-slate-600 hover:text-white'}`}><Activity size={12}/></button>
                                                </div>
                                                <input type="range" min={p==='scale'?0:p==='opacity'?0:-1500} max={p==='scale'?4:p==='opacity'?1:1500} step={p==='scale'||p==='opacity'?0.01:1} value={sel[p]} onChange={e=>setLayers(layers.map(l=>l.id===selectedLayerId?{...l,[p]:parseFloat(e.target.value)}:l))} className="range-input"/>
                                            </div>
                                        ))}
                                    </section>

                                    <section className="space-y-4">
                                        <div className="flex items-center gap-2 text-indigo-400"><Sparkles size={14}/><span className="text-[10px] font-black uppercase tracking-[0.2em]">Presets</span></div>
                                        <div className="grid grid-cols-2 gap-2">
                                            {['typewriter','bounce','glitch','cascade','liquid'].map(pr=>(
                                                <button key={pr} onClick={()=>{const n=sel.presets.includes(pr)?sel.presets.filter(x=>x!==pr):[...sel.presets,pr]; setLayers(layers.map(l=>l.id===selectedLayerId?{...l,presets:n}:l))}} className={`px-3 py-2 rounded-xl text-[9px] font-black uppercase transition-all ${sel.presets.includes(pr)?'bg-indigo-600 shadow-lg':'bg-white/5 hover:bg-white/10 text-slate-500'}`}>{pr}</button>
                                            ))}
                                        </div>
                                    </section>

                                    <section className="space-y-4 pt-6 border-t border-white/5">
                                        <div className="flex items-center gap-2 text-indigo-400"><Waves size={14}/><span className="text-[10px] font-black uppercase tracking-[0.2em]">Audio</span></div>
                                        <input type="file" accept="audio/*" onChange={handleAudio} className="w-full text-[10px] file:bg-indigo-600 file:border-none file:px-4 file:py-2 file:rounded-lg file:text-white file:font-black file:mr-4 file:cursor-pointer text-slate-500"/>
                                        {beats.length > 0 && <div className="p-3 bg-green-500/10 border border-green-500/20 rounded-xl text-[9px] font-black text-green-400 text-center uppercase tracking-widest">{beats.length} beats synchronized</div>}
                                    </section>
                                </>
                            )}
                        </aside>
                    </div>

                    {/* TIMELINE */}
                    <footer className="h-60 glass border-t border-white/10 flex flex-col">
                        <div className="h-10 border-b border-white/5 flex items-center px-8 justify-between text-[9px] font-black text-slate-500 uppercase tracking-widest">
                            <div className="flex items-center gap-8">
                                <span className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]"></div> MASTER TIMELINE</span>
                                <span className="bg-slate-800 text-white px-3 py-1 rounded-full font-mono">{currentTime.toFixed(3)}s</span>
                            </div>
                            <div className="flex gap-6">
                                <button onClick={()=>setShowGrid(!showGrid)} className={showGrid?'text-indigo-400':''}>GRID</button>
                                <button onClick={()=>setShowSafeAreas(!showSafeAreas)} className={showSafeAreas?'text-indigo-400':''}>GUIDES</button>
                                <span>{fps} FPS</span>
                            </div>
                        </div>
                        <div className="flex-1 overflow-x-auto relative timeline-grid no-scrollbar cursor-crosshair" onClick={e=>{const r=e.currentTarget.getBoundingClientRect(); if(e.target===e.currentTarget) setCurrentTime(((e.clientX-r.left)/r.width)*duration)}}> 
                            {beats.map((b,i)=><div key={i} className="absolute top-0 bottom-0 w-[1px] bg-indigo-500/10" style={{left:`${(b/duration)*100}%`}}></div>)}
                            <div className="absolute top-0 bottom-0 w-[2px] bg-red-500 z-40" style={{left:`${(currentTime/duration)*100}%`}}>
                                <div className="absolute -top-1 -left-[4px] w-2.5 h-2.5 bg-red-500 rotate-45"></div>
                            </div>
                            <div className="flex flex-col min-w-full">
                                {layers.map(l=>(
                                    <div key={l.id} className={`h-12 border-b border-white/5 flex items-center relative transition-colors ${selectedLayerId===l.id?'bg-indigo-600/5':''}`} onClick={()=>setSelectedLayerId(l.id)}>
                                        <div className="sticky left-0 w-32 h-full glass border-r border-white/5 flex items-center px-4 z-20 text-[9px] font-black truncate text-slate-500 uppercase">{l.name}</div>
                                        <div className="flex-1 h-full relative">
                                            {Object.keys(l.keyframes).map(p=>l.keyframes[p].map((k,i)=>(
                                                <div key={`${p}-${i}`} className="absolute top-1/2 -translate-y-1/2 w-3 h-3 bg-white keyframe z-10 shadow-xl cursor-move" style={{left:`calc(${(k.time/duration)*100}% - 6px)`}} onClick={e=>{e.stopPropagation(); setCurrentTime(k.time)}}></div>
                                            )))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        window.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (e.code === 'Space') { e.preventDefault(); document.querySelector('button')?.click(); }
        });
    </script>
</body>
</html>
