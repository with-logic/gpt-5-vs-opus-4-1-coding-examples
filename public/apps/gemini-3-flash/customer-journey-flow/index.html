<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Journey Flow | Professional Diagram Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f8fafc;
        }
        .canvas-grid {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }
        .node-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .connection-line {
            fill: none;
            stroke: #94a3b8;
            stroke-width: 2.5;
            transition: stroke 0.2s, stroke-width 0.2s;
            stroke-linecap: round;
        }
        .connection-line:hover {
            stroke: #6366f1;
            stroke-width: 4;
            cursor: pointer;
        }
        .dot-handle {
            width: 14px;
            height: 14px;
            background: #fff;
            border: 3px solid #6366f1;
            border-radius: 50%;
            cursor: crosshair;
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.8);
        }
        .dot-handle:hover {
            transform: scale(1.4);
            background: #6366f1;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }
        .node-selected {
            ring: 3px solid #6366f1;
            ring-offset: 4px;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }
        @keyframes flow {
            from { stroke-dashoffset: 30; }
            to { stroke-dashoffset: 0; }
        }
        .animate-flow {
            stroke-dasharray: 10, 5;
            animation: flow 1.5s linear infinite;
        }
        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { motion, AnimatePresence } = Motion;

        const NODE_TYPES = {
            AWARENESS: { color: 'bg-indigo-500', icon: 'eye', label: 'Awareness' },
            CONSIDERATION: { color: 'bg-blue-500', icon: 'search', label: 'Consideration' },
            PURCHASE: { color: 'bg-emerald-500', icon: 'shopping-cart', label: 'Purchase' },
            RETENTION: { color: 'bg-amber-500', icon: 'refresh-cw', label: 'Retention' },
            ADVOCACY: { color: 'bg-rose-500', icon: 'heart', label: 'Advocacy' },
            GENERAL: { color: 'bg-slate-500', icon: 'box', label: 'Other' }
        };

        const INITIAL_NODES = [
            { id: '1', x: 80, y: 120, title: 'Social Media Ad', type: 'AWARENESS', description: 'User sees a sponsored post on Instagram or Facebook.' },
            { id: '2', x: 380, y: 120, title: 'Product Showcase', type: 'CONSIDERATION', description: 'User clicks through to the product features and testimonials page.' },
            { id: '3', x: 680, y: 120, title: 'Safe Checkout', type: 'PURCHASE', description: 'User completes the purchase using a one-click payment method.' },
            { id: '4', x: 380, y: 320, title: 'Pricing Table', type: 'CONSIDERATION', description: 'User compares different subscription plans.' }
        ];

        const INITIAL_CONNECTIONS = [
            { id: 'c1', from: '1', to: '2' },
            { id: 'c2', from: '2', to: '3' },
            { id: 'c3', from: '1', to: '4' },
            { id: 'c4', from: '4', to: '2' }
        ];

        const Icon = ({ name, size = 18, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons({
                        attrs: {
                            class: className,
                            'stroke-width': 2,
                            width: size,
                            height: size
                        },
                        name: name,
                        element: iconRef.current
                    });
                }
            }, [name, size, className]);
            return <i ref={iconRef} data-lucide={name} className={className}></i>;
        };

        const App = () => {
            const [nodes, setNodes] = useState(() => {
                const saved = localStorage.getItem('cj-nodes-v2');
                return saved ? JSON.parse(saved) : INITIAL_NODES;
            });
            const [connections, setConnections] = useState(() => {
                const saved = localStorage.getItem('cj-connections-v2');
                return saved ? JSON.parse(saved) : INITIAL_CONNECTIONS;
            });
            const [selectedId, setSelectedId] = useState(null);
            const [isDraggingNode, setIsDraggingNode] = useState(false);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const [connectingFrom, setConnectingFrom] = useState(null);
            const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
            const [canvasOffset, setCanvasOffset] = useState({ x: 0, y: 0 });
            const canvasRef = useRef(null);

            useEffect(() => {
                const updateOffset = () => {
                    if (canvasRef.current) {
                        const rect = canvasRef.current.getBoundingClientRect();
                        setCanvasOffset({ x: rect.left, y: rect.top });
                    }
                };
                updateOffset();
                window.addEventListener('resize', updateOffset);
                return () => window.removeEventListener('resize', updateOffset);
            }, []);

            useEffect(() => {
                localStorage.setItem('cj-nodes-v2', JSON.stringify(nodes));
                localStorage.setItem('cj-connections-v2', JSON.stringify(connections));
            }, [nodes, connections]);

            const handleMouseDown = (e) => {
                if (e.target === canvasRef.current || e.target.tagName === 'svg') {
                    setSelectedId(null);
                }
            };

            const handleMouseMove = (e) => {
                const x = e.clientX - canvasOffset.x;
                const y = e.clientY - canvasOffset.y;
                setMousePos({ x, y });
                
                if (isDraggingNode && selectedId) {
                    setNodes(prev => prev.map(n => 
                        n.id === selectedId 
                        ? { ...n, x: x - dragOffset.x, y: y - dragOffset.y } 
                        : n
                    ));
                }
            };

            const handleMouseUp = () => {
                setIsDraggingNode(false);
                setConnectingFrom(null);
            };

            const addNode = (type = 'GENERAL') => {
                const newNode = {
                    id: Date.now().toString(),
                    x: 100 + (Math.random() * 100),
                    y: 100 + (Math.random() * 100),
                    title: `New ${NODE_TYPES[type].label} Step`,
                    type: type,
                    description: 'Click to describe what happens at this stage of the journey.'
                };
                setNodes([...nodes, newNode]);
                setSelectedId(newNode.id);
            };

            const deleteNode = (id) => {
                setNodes(nodes.filter(n => n.id !== id));
                setConnections(connections.filter(c => c.from !== id && c.to !== id));
                setSelectedId(null);
            };

            const updateNode = (id, data) => {
                setNodes(nodes.map(n => n.id === id ? { ...n, ...data } : n));
            };

            const startConnection = (e, nodeId) => {
                e.stopPropagation();
                setConnectingFrom(nodeId);
            };

            const completeConnection = (toId) => {
                if (connectingFrom && connectingFrom !== toId) {
                    const exists = connections.find(c => c.from === connectingFrom && c.to === toId);
                    if (!exists) {
                        setConnections([...connections, { id: `c-${Date.now()}`, from: connectingFrom, to: toId }]);
                    }
                }
                setConnectingFrom(null);
            };

            const deleteConnection = (id) => {
                setConnections(connections.filter(c => c.id !== id));
            };

            const selectedNode = nodes.find(n => n.id === selectedId);

            return (
                <div className="flex h-screen w-screen bg-slate-100 overflow-hidden select-none">
                    {/* Sidebar */}
                    <aside className="w-80 bg-white border-r border-slate-200 flex flex-col z-20 shadow-2xl">
                        <div className="p-6 bg-slate-900 text-white">
                            <div className="flex items-center gap-3">
                                <div className="bg-indigo-500 p-2 rounded-xl">
                                    <Icon name="map" size={20} className="text-white" />
                                </div>
                                <div>
                                    <h1 className="text-lg font-bold leading-tight">Journey Flow</h1>
                                    <p className="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Visual Designer</p>
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-5 custom-scrollbar space-y-8">
                            <div>
                                <h3 className="text-[10px] font-black text-slate-400 mb-4 uppercase tracking-wider">Components</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    {Object.entries(NODE_TYPES).map(([type, config]) => (
                                        <button 
                                            key={type}
                                            onClick={() => addNode(type)}
                                            className="flex flex-col items-center justify-center p-4 rounded-2xl border border-slate-100 bg-slate-50 hover:border-indigo-300 hover:bg-indigo-50 transition-all group shadow-sm hover:shadow-md"
                                        >
                                            <div className={`${config.color} p-2.5 rounded-xl text-white mb-2 group-hover:scale-110 transition-transform shadow-lg shadow-indigo-200/20`}>
                                                <Icon name={config.icon} size={20} />
                                            </div>
                                            <span className="text-[11px] font-bold text-slate-600 tracking-tight">{config.label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <AnimatePresence mode="wait">
                                {selectedNode ? (
                                    <motion.div 
                                        key={selectedNode.id}
                                        initial={{ opacity: 0, y: 10 }}
                                        animate={{ opacity: 1, y: 0 }}
                                        exit={{ opacity: 0, y: 10 }}
                                        className="space-y-5 pt-5 border-t border-slate-100"
                                    >
                                        <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-wider">Properties</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase mb-1.5 block px-1">Stage Title</label>
                                                <input 
                                                    type="text" 
                                                    value={selectedNode.title}
                                                    onChange={(e) => updateNode(selectedId, { title: e.target.value })}
                                                    className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-medium focus:ring-4 ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all"
                                                />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase mb-1.5 block px-1">Description</label>
                                                <textarea 
                                                    rows="4"
                                                    value={selectedNode.description}
                                                    onChange={(e) => updateNode(selectedId, { description: e.target.value })}
                                                    className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-medium focus:ring-4 ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all resize-none"
                                                />
                                            </div>
                                            <div className="flex gap-2 pt-2">
                                                <button 
                                                    onClick={() => deleteNode(selectedId)}
                                                    className="flex-1 py-3 px-4 bg-rose-50 hover:bg-rose-100 text-rose-600 rounded-xl text-xs font-bold transition-colors flex items-center justify-center gap-2"
                                                >
                                                    <Icon name="trash-2" size={14} /> Remove
                                                </button>
                                            </div>
                                        </div>
                                    </motion.div>
                                ) : (
                                    <div className="text-center py-12 px-6 border-2 border-dashed border-slate-100 rounded-3xl">
                                        <div className="bg-slate-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <Icon name="mouse-pointer-click" size={20} className="text-slate-300" />
                                        </div>
                                        <p className="text-xs font-bold text-slate-400 mb-1">No Element Selected</p>
                                        <p className="text-[10px] text-slate-300 leading-relaxed">Select a stage on the canvas to customize its details and flow.</p>
                                    </div>
                                )}
                            </AnimatePresence>
                        </div>
                        
                        <div className="p-6 border-t border-slate-100 glass">
                            <div className="flex items-center justify-between text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                                <span>Version 1.0</span>
                                <span className="text-emerald-500 flex items-center gap-1">
                                    <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse" /> Live
                                </span>
                            </div>
                        </div>
                    </aside>

                    {/* Canvas */}
                    <main 
                        ref={canvasRef}
                        className="flex-1 relative canvas-grid overflow-hidden cursor-crosshair"
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                    >
                        {/* SVG Connections Layer */}
                        <svg className="absolute inset-0 pointer-events-none w-full h-full">
                            <defs>
                                <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto">
                                    <path d="M0,0 L10,5 L0,10 Z" fill="#94a3b8" />
                                </marker>
                            </defs>
                            
                            {connections.map(conn => {
                                const fromNode = nodes.find(n => n.id === conn.from);
                                const toNode = nodes.find(n => n.id === conn.to);
                                if (!fromNode || !toNode) return null;

                                const startX = fromNode.x + 240;
                                const startY = fromNode.y + 45;
                                const endX = toNode.x;
                                const endY = toNode.y + 45;
                                
                                const deltaX = Math.abs(endX - startX);
                                const cp1x = startX + deltaX * 0.4;
                                const cp2x = endX - deltaX * 0.4;

                                return (
                                    <g key={conn.id} className="group">
                                        <path 
                                            d={`M ${startX} ${startY} C ${cp1x} ${startY}, ${cp2x} ${endY}, ${endX} ${endY}`}
                                            className="connection-line pointer-events-auto"
                                            markerEnd="url(#arrow)"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                deleteConnection(conn.id);
                                            }}
                                        />
                                        <path 
                                            d={`M ${startX} ${startY} C ${cp1x} ${startY}, ${cp2x} ${endY}, ${endX} ${endY}`}
                                            className="connection-line animate-flow opacity-20 pointer-events-none"
                                        />
                                    </g>
                                );
                            })}

                            {connectingFrom && (
                                <path 
                                    d={`M ${nodes.find(n => n.id === connectingFrom).x + 240} ${nodes.find(n => n.id === connectingFrom).y + 45} L ${mousePos.x} ${mousePos.y}`}
                                    stroke="#6366f1"
                                    strokeWidth="3"
                                    strokeDasharray="8,8"
                                    fill="none"
                                    className="animate-pulse"
                                />
                            )}
                        </svg>

                        {/* Elements Layer */}
                        {nodes.map(node => (
                            <div 
                                key={node.id}
                                className={`absolute node-shadow bg-white rounded-3xl w-[240px] transition-all duration-200 border border-slate-200 ${selectedId === node.id ? 'node-selected z-10 scale-[1.02]' : 'hover:scale-[1.01] z-0'}`}
                                style={{ left: node.x, top: node.y, cursor: 'grab' }}
                                onMouseDown={(e) => {
                                    e.stopPropagation();
                                    const rect = e.currentTarget.getBoundingClientRect();
                                    setSelectedId(node.id);
                                    setIsDraggingNode(true);
                                    setDragOffset({ x: e.clientX - rect.left, y: e.clientY - rect.top });
                                }}
                                onMouseUp={() => completeConnection(node.id)}
                            >
                                <div className={`h-2 w-full rounded-t-3xl ${NODE_TYPES[node.type]?.color || 'bg-slate-400'}`} />
                                <div className="p-5">
                                    <div className="flex items-start justify-between mb-3">
                                        <div className={`${NODE_TYPES[node.type]?.color || 'bg-slate-400'} p-2 rounded-xl text-white shadow-lg shadow-indigo-100`}>
                                            <Icon name={NODE_TYPES[node.type]?.icon || 'box'} size={16} />
                                        </div>
                                        <span className="text-[9px] font-black text-slate-300 uppercase tracking-tighter mt-1">{NODE_TYPES[node.type]?.label}</span>
                                    </div>
                                    <h4 className="font-bold text-slate-800 text-[13px] mb-2 leading-tight">{node.title}</h4>
                                    <p className="text-[11px] text-slate-400 leading-relaxed line-clamp-3">
                                        {node.description}
                                    </p>
                                </div>
                                
                                {/* Connectors */}
                                <div 
                                    className="absolute -right-2 top-1/2 -translate-y-1/2 dot-handle z-10 group"
                                    onMouseDown={(e) => startConnection(e, node.id)}
                                >
                                    <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[9px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap font-bold">
                                        Connect Step
                                    </div>
                                </div>
                                <div 
                                    className="absolute -left-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-white border-2 border-slate-100 rounded-full"
                                />
                            </div>
                        ))}

                        {/* Bottom Toolbar */}
                        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 flex items-center gap-4 bg-slate-900/90 backdrop-blur-xl p-2 rounded-2xl shadow-2xl border border-white/10">
                            <button 
                                onClick={() => addNode('AWARENESS')}
                                className="px-5 py-2.5 bg-indigo-500 hover:bg-indigo-400 text-white text-xs font-bold rounded-xl transition-all flex items-center gap-2 shadow-lg shadow-indigo-500/20"
                            >
                                <Icon name="plus" size={16} /> New Stage
                            </button>
                            <div className="w-px h-6 bg-white/10" />
                            <div className="flex items-center gap-1 px-2">
                                <button 
                                    onClick={() => {
                                        if(confirm('Reset entire flow?')) {
                                            setNodes(INITIAL_NODES);
                                            setConnections(INITIAL_CONNECTIONS);
                                        }
                                    }}
                                    className="p-2.5 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all"
                                    title="Reset Journey"
                                >
                                    <Icon name="refresh-ccw" size={18} />
                                </button>
                                <button 
                                    onClick={() => alert('Diagram saved to local storage!')}
                                    className="p-2.5 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all"
                                    title="Save Diagram"
                                >
                                    <Icon name="save" size={18} />
                                </button>
                                <button 
                                    onClick={() => window.print()}
                                    className="p-2.5 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all"
                                    title="Export PDF"
                                >
                                    <Icon name="download" size={18} />
                                </button>
                            </div>
                        </div>

                        {/* Empty State Overlay */}
                        {nodes.length === 0 && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center bg-slate-50/50 backdrop-blur-[2px]">
                                <motion.div 
                                    initial={{ opacity: 0, scale: 0.9 }}
                                    animate={{ opacity: 1, scale: 1 }}
                                    className="text-center"
                                >
                                    <div className="bg-white p-6 rounded-[40px] shadow-2xl mb-6 inline-block border border-slate-100">
                                        <Icon name="layout" size={64} className="text-slate-200" />
                                    </div>
                                    <h2 className="text-2xl font-black text-slate-800 mb-2 tracking-tight">Create your first flow</h2>
                                    <p className="text-slate-400 text-sm mb-8 font-medium">Add a stage to start mapping your customer's journey</p>
                                    <button 
                                        onClick={() => addNode('AWARENESS')}
                                        className="px-10 py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-[20px] font-black text-sm transition-all shadow-xl shadow-indigo-200 uppercase tracking-widest"
                                    >
                                        Get Started
                                    </button>
                                </motion.div>
                            </div>
                        )}
                    </main>
                    
                    {/* Floating Instruction */}
                    <div className="fixed top-8 right-8 pointer-events-none hidden lg:block">
                        <div className="bg-white/60 backdrop-blur-md px-5 py-3 rounded-2xl border border-white/40 shadow-sm text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] flex items-center gap-3">
                            <Icon name="info" size={14} className="text-indigo-400" />
                            Drag node dots to link stages
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>