<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe: Imperium Romanum</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cinzel+Decorative:wght@400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #d4af37;
            --gold-bright: #ffdf00;
            --gold-dark: #aa8a2e;
            --imperial-red: #800000;
            --marble-white: #f5f5f5;
            --marble-vein: #e0e0e0;
            --night-stone: #1a1a1a;
            --night-vein: #2c2c2c;
            --text-color: #333;
            --shadow: 0 10px 30px rgba(0,0,0,0.15);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        [data-theme="night"] {
            --marble-white: #1a1a1a;
            --marble-vein: #2c2c2c;
            --text-color: #f5f5f5;
            --shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--marble-white);
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.8), transparent),
                linear-gradient(135deg, transparent 75%, var(--marble-vein) 75%),
                linear-gradient(225deg, transparent 75%, var(--marble-vein) 75%),
                linear-gradient(45deg, transparent 75%, var(--marble-vein) 75%),
                linear-gradient(315deg, transparent 75%, var(--marble-vein) 75%);
            background-size: 100% 100%, 100px 100px, 100px 100px, 100px 100px, 100px 100px;
            color: var(--text-color);
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: var(--transition);
        }

        /* Decorative Arches */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(ellipse at 50% 120%, transparent 60%, rgba(212, 175, 55, 0.05) 61%, rgba(212, 175, 55, 0.05) 70%, transparent 71%),
                radial-gradient(ellipse at 50% 130%, transparent 60%, rgba(212, 175, 55, 0.03) 61%, rgba(212, 175, 55, 0.03) 70%, transparent 71%);
            z-index: 0;
            pointer-events: none;
        }

        /* Top Bar */
        .top-bar {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.05);
            backdrop-filter: blur(5px);
            border-bottom: 2px solid var(--gold);
            z-index: 100;
        }

        .spqr-crest {
            font-family: 'Cinzel Decorative', cursive;
            color: var(--gold);
            font-size: 1.5rem;
            font-weight: 900;
            letter-spacing: 4px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .spqr-crest span {
            border: 2px solid var(--gold);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        button {
            background: var(--imperial-red);
            color: white;
            border: 1px solid var(--gold);
            padding: 0.6rem 1.2rem;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            cursor: pointer;
            border-radius: 4px;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.8rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        button:hover {
            background: #a00000;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border-color: var(--gold-bright);
        }

        button:active {
            transform: translateY(0);
        }

        /* Scoreboard */
        .scoreboard {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 1rem;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--gold-dark);
        }

        .score-value {
            font-size: 1.8rem;
            color: var(--text-color);
        }

        /* Victory Banner */
        #victory-banner {
            height: 0;
            overflow: hidden;
            background: var(--gold);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Cinzel Decorative', cursive;
            font-size: 1.5rem;
            font-weight: 700;
            transition: height 0.5s ease;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-bottom: 0 solid var(--gold-dark);
        }

        #victory-banner.show {
            height: 60px;
            border-bottom-width: 4px;
        }

        /* Game Board */
        .game-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
            width: 85vmin;
            height: 85vmin;
            max-width: 500px;
            max-height: 500px;
            background: rgba(0,0,0,0.05);
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            position: relative;
            z-index: 10;
        }

        .cell {
            background: white;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05), 0 4px 6px rgba(0,0,0,0.1);
        }

        [data-theme="night"] .cell {
            background: #2a2a2a;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3), 0 4px 6px rgba(0,0,0,0.4);
        }

        .cell:hover {
            transform: scale(1.02);
            background: #fffcf0;
        }

        [data-theme="night"] .cell:hover {
            background: #333;
        }

        .cell.win-highlight {
            background: var(--gold);
            animation: pulse-gold 1.5s infinite;
        }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }

        .glyph {
            width: 70%;
            height: 70%;
            fill: var(--imperial-red);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0);
            opacity: 0;
        }

        .glyph.show {
            transform: scale(1);
            opacity: 1;
        }

        .glyph-o {
            fill: var(--gold-dark);
        }

        /* Customize Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: var(--marble-white);
            width: 100%;
            max-width: 500px;
            border-radius: 12px;
            border: 3px solid var(--gold);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            padding: 2rem;
            position: relative;
        }

        .modal-header {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--imperial-red);
            margin-bottom: 1.5rem;
            text-align: center;
            border-bottom: 1px solid var(--gold);
            padding-bottom: 0.5rem;
        }

        .setting-group {
            margin-bottom: 1.2rem;
        }

        .setting-label {
            display: block;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--gold-dark);
            font-size: 0.9rem;
        }

        .options-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .option-btn {
            flex: 1;
            background: transparent;
            color: var(--text-color);
            border: 1px solid var(--gold);
            padding: 8px;
            font-size: 0.75rem;
            min-width: 80px;
        }

        .option-btn.active {
            background: var(--gold);
            color: white;
        }

        .close-modal {
            margin-top: 1rem;
            width: 100%;
        }

        /* Confetti Canvas */
        #confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* Status for ARIA */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            border: 0;
        }

        /* Responsive Adjustments */
        @media (max-width: 400px) {
            .nav-buttons button {
                padding: 0.5rem 0.8rem;
                font-size: 0.7rem;
            }
            .spqr-crest { font-size: 1.2rem; }
            .scoreboard { gap: 1rem; }
        }

        /* Background Colosseum Decoration */
        .colosseum-bg {
            position: fixed;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.05;
            width: 120%;
            pointer-events: none;
            z-index: 1;
        }
    </style>
</head>
<body data-theme="day">

    <canvas id="confetti"></canvas>

    <div class="top-bar">
        <div class="spqr-crest">
            <span>SPQR</span>
        </div>
        <div class="nav-buttons">
            <button onclick="game.resetRound()">New Round</button>
            <button onclick="ui.toggleModal(true)">Customize</button>
            <button onclick="game.resetScores()">Reset Scores</button>
        </div>
    </div>

    <div id="victory-banner" aria-live="polite"></div>

    <div class="scoreboard">
        <div class="score-item">
            <span>Player X</span>
            <span id="score-x" class="score-value">0</span>
        </div>
        <div class="score-item">
            <span>Draws</span>
            <span id="score-draws" class="score-value">0</span>
        </div>
        <div class="score-item">
            <span>Player O</span>
            <span id="score-o" class="score-value">0</span>
        </div>
    </div>

    <main class="game-container">
        <div class="board" id="board" role="grid" aria-label="Tic Tac Toe Board">
            <!-- Cells generated by JS -->
        </div>
    </main>

    <div id="status-update" class="sr-only" aria-live="assertive"></div>

    <!-- Customize Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <h2 class="modal-header">Imperial Decrees</h2>
            
            <div class="setting-group">
                <span class="setting-label">Theme</span>
                <div class="options-row">
                    <button class="option-btn active" data-setting="theme" data-value="day" onclick="ui.setSetting('theme', 'day')">Marble Day</button>
                    <button class="option-btn" data-setting="theme" data-value="night" onclick="ui.setSetting('theme', 'night')">Night Legion</button>
                </div>
            </div>

            <div class="setting-group">
                <span class="setting-label">Glyphs</span>
                <div class="options-row">
                    <button class="option-btn active" data-setting="glyphs" data-value="standard" onclick="ui.setSetting('glyphs', 'standard')">Standard X/O</button>
                    <button class="option-btn" data-setting="glyphs" data-value="roman" onclick="ui.setSetting('glyphs', 'roman')">Gladius/Laurel</button>
                </div>
            </div>

            <div class="setting-group">
                <span class="setting-label">Opponent</span>
                <div class="options-row">
                    <button class="option-btn active" data-setting="mode" data-value="2p" onclick="ui.setSetting('mode', '2p')">2 Players</button>
                    <button class="option-btn" data-setting="mode" data-value="ai" onclick="ui.setSetting('mode', 'ai')">VS Centurion (AI)</button>
                </div>
            </div>

            <div class="setting-group">
                <span class="setting-label">AI Discipline</span>
                <div class="options-row">
                    <button class="option-btn" data-setting="difficulty" data-value="reckless" onclick="ui.setSetting('difficulty', 'reckless')">Reckless</button>
                    <button class="option-btn" data-setting="difficulty" data-value="pragmatic" onclick="ui.setSetting('difficulty', 'pragmatic')">Pragmatic</button>
                    <button class="option-btn active" data-setting="difficulty" data-value="perfect" onclick="ui.setSetting('difficulty', 'perfect')">Perfect</button>
                </div>
            </div>

            <div class="setting-group">
                <span class="setting-label">First Move</span>
                <div class="options-row">
                    <button class="option-btn active" data-setting="firstMove" data-value="X" onclick="ui.setSetting('firstMove', 'X')">X Begins</button>
                    <button class="option-btn" data-setting="firstMove" data-value="O" onclick="ui.setSetting('firstMove', 'O')">O Begins</button>
                </div>
            </div>

            <button class="close-modal" onclick="ui.toggleModal(false)">Return to Arena</button>
        </div>
    </div>

    <script>
        /**
         * SVG Glyph Definitions
         */
        const GLYPHS = {
            standard: {
                X: `<svg viewBox="0 0 100 100" class="glyph glyph-x"><path d="M20,20 L80,80 M80,20 L20,80" stroke-width="12" stroke-linecap="round" stroke="currentColor"/></svg>`,
                O: `<svg viewBox="0 0 100 100" class="glyph glyph-o"><circle cx="50" cy="50" r="35" stroke-width="12" fill="none" stroke="currentColor"/></svg>`
            },
            roman: {
                X: `<svg viewBox="0 0 100 100" class="glyph glyph-x">
                        <path d="M50,10 L50,90 M30,15 L70,15 M40,90 L60,90 M40,25 L60,25" stroke="currentColor" stroke-width="6" fill="none"/>
                        <path d="M45,25 L45,80 Q50,90 55,80 L55,25 Z" fill="currentColor"/>
                    </svg>`, // Gladius-ish
                O: `<svg viewBox="0 0 100 100" class="glyph glyph-o">
                        <path d="M50,15 A35,35 0 1,0 50,85 A35,35 0 1,0 50,15" fill="none" stroke="currentColor" stroke-width="4"/>
                        <path d="M50,10 Q60,10 65,20 M50,10 Q40,10 35,20 M50,90 Q60,90 65,80 M50,90 Q40,90 35,80" fill="none" stroke="currentColor" stroke-width="6"/>
                        <path d="M15,50 Q15,40 25,35 M15,50 Q15,60 25,65 M85,50 Q85,40 75,35 M85,50 Q85,60 75,65" fill="none" stroke="currentColor" stroke-width="6"/>
                    </svg>` // Laurel-ish
            }
        };

        /**
         * Game Logic Engine
         */
        class TicTacToe {
            constructor() {
                this.board = Array(9).fill(null);
                this.currentPlayer = 'X';
                this.scores = { X: 0, O: 0, Draws: 0 };
                this.gameActive = true;
                this.settings = {
                    theme: 'day',
                    glyphs: 'standard',
                    mode: '2p',
                    difficulty: 'perfect',
                    firstMove: 'X'
                };
            }

            makeMove(index) {
                if (!this.gameActive || this.board[index]) return false;

                this.board[index] = this.currentPlayer;
                const winData = this.checkWinner(this.board);

                if (winData) {
                    this.endGame(winData);
                } else if (this.board.every(cell => cell !== null)) {
                    this.endGame('draw');
                } else {
                    this.currentPlayer = this.currentPlayer === 'X' ? 'O' : 'X';
                    if (this.settings.mode === 'ai' && this.currentPlayer === 'O') {
                        setTimeout(() => this.aiMove(), 500);
                    }
                }
                return true;
            }

            aiMove() {
                if (!this.gameActive) return;

                let move;
                const difficulty = this.settings.difficulty;

                if (difficulty === 'reckless') {
                    move = Math.random() < 0.6 ? this.getRandomMove() : this.getBestMove();
                } else if (difficulty === 'pragmatic') {
                    move = Math.random() < 0.2 ? this.getRandomMove() : this.getBestMove();
                } else {
                    move = this.getBestMove();
                }

                ui.handleCellClick(move);
            }

            getRandomMove() {
                const available = this.board.map((v, i) => v === null ? i : null).filter(v => v !== null);
                return available[Math.floor(Math.random() * available.length)];
            }

            getBestMove() {
                let bestScore = -Infinity;
                let move;
                for (let i = 0; i < 9; i++) {
                    if (this.board[i] === null) {
                        this.board[i] = 'O';
                        let score = this.minimax(this.board, 0, false);
                        this.board[i] = null;
                        if (score > bestScore) {
                            bestScore = score;
                            move = i;
                        }
                    }
                }
                return move;
            }

            minimax(board, depth, isMaximizing) {
                const result = this.checkWinner(board);
                if (result) return result.winner === 'O' ? 10 - depth : depth - 10;
                if (board.every(c => c !== null)) return 0;

                if (isMaximizing) {
                    let bestScore = -Infinity;
                    for (let i = 0; i < 9; i++) {
                        if (board[i] === null) {
                            board[i] = 'O';
                            let score = this.minimax(board, depth + 1, false);
                            board[i] = null;
                            bestScore = Math.max(score, bestScore);
                        }
                    }
                    return bestScore;
                } else {
                    let bestScore = Infinity;
                    for (let i = 0; i < 9; i++) {
                        if (board[i] === null) {
                            board[i] = 'X';
                            let score = this.minimax(board, depth + 1, true);
                            board[i] = null;
                            bestScore = Math.min(score, bestScore);
                        }
                    }
                    return bestScore;
                }
            }

            checkWinner(board) {
                const lines = [
                    [0, 1, 2], [3, 4, 5], [6, 7, 8],
                    [0, 3, 6], [1, 4, 7], [2, 5, 8],
                    [0, 4, 8], [2, 4, 6]
                ];
                for (let line of lines) {
                    const [a, b, c] = line;
                    if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                        return { winner: board[a], line };
                    }
                }
                return null;
            }

            endGame(result) {
                this.gameActive = false;
                if (result === 'draw') {
                    this.scores.Draws++;
                    ui.announceWinner("Pax Romana! (It's a Draw)");
                } else {
                    this.scores[result.winner]++;
                    ui.announceWinner(`Victoria! Player ${result.winner} Triumphs`, result.line);
                    confetti.start();
                }
                ui.updateScores();
            }

            resetRound() {
                this.board = Array(9).fill(null);
                this.currentPlayer = this.settings.firstMove;
                this.gameActive = true;
                ui.clearBoard();
                ui.hideBanner();
                confetti.stop();

                if (this.settings.mode === 'ai' && this.currentPlayer === 'O') {
                    setTimeout(() => this.aiMove(), 500);
                }
            }

            resetScores() {
                this.scores = { X: 0, O: 0, Draws: 0 };
                ui.updateScores();
            }
        }

        /**
         * UI Controller
         */
        const ui = {
            init() {
                const boardEl = document.getElementById('board');
                for (let i = 0; i < 9; i++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.setAttribute('role', 'gridcell');
                    cell.setAttribute('aria-label', `Cell ${i + 1}`);
                    cell.setAttribute('tabindex', '0');
                    cell.dataset.index = i;
                    cell.onclick = () => this.handleCellClick(i);
                    cell.onkeydown = (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.handleCellClick(i);
                        }
                    };
                    boardEl.appendChild(cell);
                }
            },

            handleCellClick(index) {
                const player = game.currentPlayer;
                const success = game.makeMove(index);
                if (success) {
                    const cell = document.querySelector(`.cell[data-index="${index}"]`);
                    const glyphSet = GLYPHS[game.settings.glyphs];
                    cell.innerHTML = glyphSet[player];
                    setTimeout(() => cell.querySelector('.glyph').classList.add('show'), 10);
                    
                    document.getElementById('status-update').textContent = `Player ${player} moved to cell ${index + 1}. Now Player ${game.currentPlayer}'s turn.`;
                }
            },

            updateScores() {
                document.getElementById('score-x').textContent = game.scores.X;
                document.getElementById('score-o').textContent = game.scores.O;
                document.getElementById('score-draws').textContent = game.scores.Draws;
            },

            announceWinner(msg, line = null) {
                const banner = document.getElementById('victory-banner');
                banner.textContent = msg;
                banner.classList.add('show');
                
                if (line) {
                    line.forEach(idx => {
                        document.querySelector(`.cell[data-index="${idx}"]`).classList.add('win-highlight');
                    });
                }
                document.getElementById('status-update').textContent = msg;
            },

            hideBanner() {
                document.getElementById('victory-banner').classList.remove('show');
                document.querySelectorAll('.cell').forEach(c => c.classList.remove('win-highlight'));
            },

            clearBoard() {
                document.querySelectorAll('.cell').forEach(c => {
                    c.innerHTML = '';
                });
            },

            toggleModal(show) {
                document.getElementById('modal-overlay').style.display = show ? 'flex' : 'none';
            },

            setSetting(key, value) {
                game.settings[key] = value;
                
                // Update UI state of buttons
                document.querySelectorAll(`.option-btn[data-setting="${key}"]`).forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === value);
                });

                if (key === 'theme') {
                    document.body.setAttribute('data-theme', value);
                }

                // If critical game settings change, reset round
                if (['mode', 'firstMove', 'glyphs'].includes(key)) {
                    game.resetRound();
                }
            }
        };

        /**
         * Canvas Confetti (Optimized)
         */
        const confetti = {
            canvas: null,
            ctx: null,
            particles: [],
            isActive: false,
            colors: ['#d4af37', '#ffdf00', '#aa8a2e', '#800000', '#ffffff'],

            init() {
                this.canvas = document.getElementById('confetti');
                this.ctx = this.canvas.getContext('2d');
                window.addEventListener('resize', () => this.resize());
                this.resize();
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },

            start() {
                if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
                this.isActive = true;
                this.particles = [];
                for (let i = 0; i < 150; i++) {
                    this.particles.push(this.createParticle());
                }
                this.animate();
            },

            stop() {
                this.isActive = false;
            },

            createParticle() {
                return {
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height - this.canvas.height,
                    size: Math.random() * 8 + 4,
                    color: this.colors[Math.floor(Math.random() * this.colors.length)],
                    speed: Math.random() * 3 + 2,
                    angle: Math.random() * 6.28,
                    spin: Math.random() * 0.2 - 0.1
                };
            },

            animate() {
                if (!this.isActive && this.particles.length === 0) return;

                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    p.y += p.speed;
                    p.angle += p.spin;
                    
                    this.ctx.save();
                    this.ctx.translate(p.x, p.y);
                    this.ctx.rotate(p.angle);
                    this.ctx.fillStyle = p.color;
                    this.ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    this.ctx.restore();

                    if (p.y > this.canvas.height) {
                        if (this.isActive) {
                            this.particles[i] = this.createParticle();
                            this.particles[i].y = -20;
                        } else {
                            this.particles.splice(i, 1);
                        }
                    }
                }

                if (this.isActive || this.particles.length > 0) {
                    requestAnimationFrame(() => this.animate());
                }
            }
        };

        // Initialize Everything
        const game = new TicTacToe();
        ui.init();
        confetti.init();

    </script>
</body>
</html>
