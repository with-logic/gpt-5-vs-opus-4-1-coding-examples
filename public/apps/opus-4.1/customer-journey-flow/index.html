<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Journey Flow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .toolbar {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .stage-templates {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .template-stage {
            padding: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: move;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .template-stage:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .template-stage .icon {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(5px);
            overflow: hidden;
        }

        .canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .stage {
            position: absolute;
            min-width: 180px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
            cursor: move;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .stage:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .stage.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .stage.dragging {
            opacity: 0.8;
            cursor: grabbing;
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stage-title {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .stage-actions {
            display: flex;
            gap: 5px;
        }

        .stage-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .stage-btn:hover {
            background: #667eea;
            color: white;
        }

        .stage-content {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .stage-metrics {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
        }

        .metric {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .metric-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
        }

        .connection-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #667eea;
            border: 2px solid white;
            border-radius: 50%;
            cursor: crosshair;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .connection-point:hover {
            transform: scale(1.3);
            background: #764ba2;
        }

        .connection-point.input {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-point.output {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            transform: scale(0.9);
            transition: all 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.05);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #555;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        .stats-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>Customer Journey Flow</h1>
            <div class="toolbar">
                <button class="btn btn-secondary" onclick="clearCanvas()">Clear All</button>
                <button class="btn btn-secondary" onclick="autoArrange()">Auto Arrange</button>
                <button class="btn" onclick="exportJourney()">Export Journey</button>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <h3>Journey Stages</h3>
                <div class="stage-templates">
                    <div class="template-stage" draggable="true" data-type="awareness">
                        <div class="icon">üëÅÔ∏è</div>
                        <div>
                            <div style="font-weight: 600;">Awareness</div>
                            <div style="font-size: 12px; color: #999;">Customer discovers brand</div>
                        </div>
                    </div>
                    <div class="template-stage" draggable="true" data-type="interest">
                        <div class="icon">üí°</div>
                        <div>
                            <div style="font-weight: 600;">Interest</div>
                            <div style="font-size: 12px; color: #999;">Shows initial interest</div>
                        </div>
                    </div>
                    <div class="template-stage" draggable="true" data-type="consideration">
                        <div class="icon">ü§î</div>
                        <div>
                            <div style="font-weight: 600;">Consideration</div>
                            <div style="font-size: 12px; color: #999;">Evaluates options</div>
                        </div>
                    </div>
                    <div class="template-stage" draggable="true" data-type="intent">
                        <div class="icon">üéØ</div>
                        <div>
                            <div style="font-weight: 600;">Intent</div>
                            <div style="font-size: 12px; color: #999;">Shows purchase intent</div>
                        </div>
                    </div>
                    <div class="template-stage" draggable="true" data-type="evaluation">
                        <div class="icon">‚öñÔ∏è</div>
                        <div>
                            <div style="font-weight: 600;">Evaluation</div>
                            <div style="font-size: 12px; color: #999;">Compares solutions</div>
                        </div>
                    </div>
                    <div class="template-stage" draggable="true" data-type="purchase">
                        <div class="icon">üõí</div>
                        <div>
                            <div style="font-weight: 600;">Purchase</div>
                            <div style="font-size: 12px; color: #999;">Makes the purchase</div>
                        </div>
                    </div>
                    <div class="template-stage" draggable="true" data-type="retention">
                        <div class="icon">‚ù§Ô∏è</div>
                        <div>
                            <div style="font-weight: 600;">Retention</div>
                            <div style="font-size: 12px; color: #999;">Becomes loyal customer</div>
                        </div>
                    </div>
                    <div class="template-stage" draggable="true" data-type="advocacy">
                        <div class="icon">üì¢</div>
                        <div>
                            <div style="font-weight: 600;">Advocacy</div>
                            <div style="font-size: 12px; color: #999;">Promotes to others</div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Instructions</h3>
                <div style="font-size: 13px; color: #666; line-height: 1.6;">
                    <p style="margin-bottom: 10px;">üìå <strong>Add Stages:</strong> Drag stages from the sidebar to the canvas</p>
                    <p style="margin-bottom: 10px;">üîó <strong>Connect:</strong> Click and drag between connection points</p>
                    <p style="margin-bottom: 10px;">‚úèÔ∏è <strong>Edit:</strong> Double-click any stage to edit details</p>
                    <p style="margin-bottom: 10px;">üóëÔ∏è <strong>Delete:</strong> Select a stage and press Delete key</p>
                    <p>üéØ <strong>Auto-Arrange:</strong> Click to organize your journey flow</p>
                </div>
            </aside>

            <div class="canvas-container" id="canvasContainer">
                <canvas class="canvas" id="connectionCanvas"></canvas>
                <div id="stagesContainer"></div>

                <div class="stats-panel">
                    <div class="stat">
                        <div class="stat-value" id="stageCount">0</div>
                        <div class="stat-label">Stages</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="connectionCount">0</div>
                        <div class="stat-label">Connections</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="conversionRate">0%</div>
                        <div class="stat-label">Conversion</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Stage</h2>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <form id="editForm">
                <div class="form-group">
                    <label class="form-label">Stage Name</label>
                    <input type="text" class="form-input" id="stageName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="stageDescription"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Conversion Rate (%)</label>
                    <input type="number" class="form-input" id="stageConversion" min="0" max="100" value="80">
                </div>
                <div class="form-group">
                    <label class="form-label">Average Time (days)</label>
                    <input type="number" class="form-input" id="stageTime" min="0" value="1">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let stages = [];
        let connections = [];
        let selectedStage = null;
        let draggedStage = null;
        let connectionStart = null;
        let currentEditingStage = null;
        let stageIdCounter = 1;

        const canvas = document.getElementById('connectionCanvas');
        const ctx = canvas.getContext('2d');
        const stagesContainer = document.getElementById('stagesContainer');

        // Stage templates data
        const stageTemplates = {
            awareness: { icon: 'üëÅÔ∏è', title: 'Awareness', description: 'Customer discovers your brand', conversion: 100, time: 1 },
            interest: { icon: 'üí°', title: 'Interest', description: 'Shows initial interest in products', conversion: 70, time: 2 },
            consideration: { icon: 'ü§î', title: 'Consideration', description: 'Actively considering your solution', conversion: 50, time: 5 },
            intent: { icon: 'üéØ', title: 'Intent', description: 'Demonstrates purchase intent', conversion: 35, time: 3 },
            evaluation: { icon: '‚öñÔ∏è', title: 'Evaluation', description: 'Comparing with competitors', conversion: 25, time: 7 },
            purchase: { icon: 'üõí', title: 'Purchase', description: 'Completes the purchase', conversion: 20, time: 1 },
            retention: { icon: '‚ù§Ô∏è', title: 'Retention', description: 'Becomes a repeat customer', conversion: 15, time: 30 },
            advocacy: { icon: 'üì¢', title: 'Advocacy', description: 'Recommends to others', conversion: 10, time: 60 }
        };

        // Initialize canvas
        function resizeCanvas() {
            const container = document.getElementById('canvasContainer');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            drawConnections();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Drag and drop from sidebar
        document.querySelectorAll('.template-stage').forEach(template => {
            template.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'copy';
                e.dataTransfer.setData('stageType', template.dataset.type);
            });
        });

        document.getElementById('canvasContainer').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        document.getElementById('canvasContainer').addEventListener('drop', (e) => {
            e.preventDefault();
            const stageType = e.dataTransfer.getData('stageType');
            if (stageType) {
                const rect = document.getElementById('canvasContainer').getBoundingClientRect();
                const x = e.clientX - rect.left - 90;
                const y = e.clientY - rect.top - 50;
                createStage(stageType, x, y);
            }
        });

        // Create stage
        function createStage(type, x, y) {
            const template = stageTemplates[type];
            const stage = {
                id: `stage-${stageIdCounter++}`,
                type: type,
                x: x,
                y: y,
                title: template.title,
                description: template.description,
                icon: template.icon,
                conversion: template.conversion,
                time: template.time
            };

            stages.push(stage);
            renderStage(stage);
            updateStats();
        }

        // Render stage element
        function renderStage(stage) {
            const stageEl = document.createElement('div');
            stageEl.className = 'stage';
            stageEl.id = stage.id;
            stageEl.style.left = stage.x + 'px';
            stageEl.style.top = stage.y + 'px';

            stageEl.innerHTML = `
                <div class="connection-point input"></div>
                <div class="connection-point output"></div>
                <div class="stage-header">
                    <div class="stage-title">${stage.icon} ${stage.title}</div>
                    <div class="stage-actions">
                        <button class="stage-btn" onclick="editStage('${stage.id}')">‚úèÔ∏è</button>
                        <button class="stage-btn" onclick="deleteStage('${stage.id}')">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="stage-content">${stage.description}</div>
                <div class="stage-metrics">
                    <div class="metric">
                        <div class="metric-value">${stage.conversion}%</div>
                        <div class="metric-label">Convert</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${stage.time}d</div>
                        <div class="metric-label">Time</div>
                    </div>
                </div>
            `;

            // Stage dragging
            let isDragging = false;
            let dragOffsetX = 0;
            let dragOffsetY = 0;

            stageEl.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('connection-point')) return;
                if (e.target.classList.contains('stage-btn')) return;

                isDragging = true;
                draggedStage = stage;
                dragOffsetX = e.clientX - stage.x;
                dragOffsetY = e.clientY - stage.y;
                stageEl.classList.add('dragging');
                selectStage(stage);
            });

            // Connection points
            const outputPoint = stageEl.querySelector('.connection-point.output');
            const inputPoint = stageEl.querySelector('.connection-point.input');

            outputPoint.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                connectionStart = { stage: stage, point: 'output' };
            });

            inputPoint.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                if (connectionStart && connectionStart.stage !== stage) {
                    createConnection(connectionStart.stage, stage);
                    connectionStart = null;
                }
            });

            // Double click to edit
            stageEl.addEventListener('dblclick', (e) => {
                if (!e.target.classList.contains('stage-btn')) {
                    editStage(stage.id);
                }
            });

            stagesContainer.appendChild(stageEl);

            // Global mouse events for dragging
            document.addEventListener('mousemove', (e) => {
                if (isDragging && draggedStage) {
                    draggedStage.x = e.clientX - dragOffsetX;
                    draggedStage.y = e.clientY - dragOffsetY;
                    stageEl.style.left = draggedStage.x + 'px';
                    stageEl.style.top = draggedStage.y + 'px';
                    drawConnections();
                }

                if (connectionStart) {
                    drawConnections();
                    // Draw temporary connection line
                    const rect = canvas.getBoundingClientRect();
                    const startStageEl = document.getElementById(connectionStart.stage.id);
                    const outputPoint = startStageEl.querySelector('.connection-point.output');
                    const outputRect = outputPoint.getBoundingClientRect();

                    ctx.strokeStyle = 'rgba(102, 126, 234, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(outputRect.left - rect.left + 6, outputRect.top - rect.top + 6);
                    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    draggedStage = null;
                    stageEl.classList.remove('dragging');
                }
                if (connectionStart) {
                    connectionStart = null;
                    drawConnections();
                }
            });
        }

        // Create connection
        function createConnection(fromStage, toStage) {
            // Check if connection already exists
            const exists = connections.some(c =>
                c.from === fromStage.id && c.to === toStage.id
            );

            if (!exists) {
                connections.push({
                    from: fromStage.id,
                    to: toStage.id
                });
                drawConnections();
                updateStats();
            }
        }

        // Draw connections
        function drawConnections() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const rect = canvas.getBoundingClientRect();

            connections.forEach(conn => {
                const fromEl = document.getElementById(conn.from);
                const toEl = document.getElementById(conn.to);

                if (fromEl && toEl) {
                    const fromPoint = fromEl.querySelector('.connection-point.output');
                    const toPoint = toEl.querySelector('.connection-point.input');

                    const fromRect = fromPoint.getBoundingClientRect();
                    const toRect = toPoint.getBoundingClientRect();

                    const startX = fromRect.left - rect.left + 6;
                    const startY = fromRect.top - rect.top + 6;
                    const endX = toRect.left - rect.left + 6;
                    const endY = toRect.top - rect.top + 6;

                    // Draw curved connection
                    ctx.strokeStyle = '#667eea';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);

                    const controlX1 = startX + (endX - startX) * 0.5;
                    const controlY1 = startY;
                    const controlX2 = startX + (endX - startX) * 0.5;
                    const controlY2 = endY;

                    ctx.bezierCurveTo(controlX1, controlY1, controlX2, controlY2, endX, endY);
                    ctx.stroke();

                    // Draw arrow
                    const angle = Math.atan2(endY - controlY2, endX - controlX2);
                    const arrowLength = 12;
                    ctx.fillStyle = '#667eea';
                    ctx.beginPath();
                    ctx.moveTo(endX, endY);
                    ctx.lineTo(
                        endX - arrowLength * Math.cos(angle - Math.PI / 6),
                        endY - arrowLength * Math.sin(angle - Math.PI / 6)
                    );
                    ctx.lineTo(
                        endX - arrowLength * Math.cos(angle + Math.PI / 6),
                        endY - arrowLength * Math.sin(angle + Math.PI / 6)
                    );
                    ctx.closePath();
                    ctx.fill();
                }
            });
        }

        // Select stage
        function selectStage(stage) {
            document.querySelectorAll('.stage').forEach(el => {
                el.classList.remove('selected');
            });

            if (stage) {
                document.getElementById(stage.id).classList.add('selected');
                selectedStage = stage;
            } else {
                selectedStage = null;
            }
        }

        // Edit stage
        function editStage(stageId) {
            const stage = stages.find(s => s.id === stageId);
            if (stage) {
                currentEditingStage = stage;
                document.getElementById('stageName').value = stage.title;
                document.getElementById('stageDescription').value = stage.description;
                document.getElementById('stageConversion').value = stage.conversion;
                document.getElementById('stageTime').value = stage.time;
                document.getElementById('editModal').classList.add('active');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditingStage = null;
        }

        // Save stage changes
        document.getElementById('editForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (currentEditingStage) {
                currentEditingStage.title = document.getElementById('stageName').value;
                currentEditingStage.description = document.getElementById('stageDescription').value;
                currentEditingStage.conversion = parseInt(document.getElementById('stageConversion').value);
                currentEditingStage.time = parseInt(document.getElementById('stageTime').value);

                // Update stage display
                const stageEl = document.getElementById(currentEditingStage.id);
                stageEl.querySelector('.stage-title').textContent = `${currentEditingStage.icon} ${currentEditingStage.title}`;
                stageEl.querySelector('.stage-content').textContent = currentEditingStage.description;
                stageEl.querySelector('.metric-value').textContent = `${currentEditingStage.conversion}%`;
                stageEl.querySelectorAll('.metric-value')[1].textContent = `${currentEditingStage.time}d`;

                closeModal();
                updateStats();
            }
        });

        // Delete stage
        function deleteStage(stageId) {
            if (confirm('Are you sure you want to delete this stage?')) {
                // Remove stage element
                const stageEl = document.getElementById(stageId);
                if (stageEl) {
                    stageEl.remove();
                }

                // Remove from stages array
                stages = stages.filter(s => s.id !== stageId);

                // Remove related connections
                connections = connections.filter(c => c.from !== stageId && c.to !== stageId);

                drawConnections();
                updateStats();
            }
        }

        // Clear canvas
        function clearCanvas() {
            if (confirm('Are you sure you want to clear all stages and connections?')) {
                stages = [];
                connections = [];
                stagesContainer.innerHTML = '';
                drawConnections();
                updateStats();
            }
        }

        // Auto arrange stages
        function autoArrange() {
            if (stages.length === 0) return;

            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const stageWidth = 200;
            const stageHeight = 150;
            const horizontalGap = 50;
            const verticalGap = 50;

            // Group stages by their connections
            const levels = [];
            const visited = new Set();

            // Find root stages (no incoming connections)
            const rootStages = stages.filter(stage =>
                !connections.some(c => c.to === stage.id)
            );

            if (rootStages.length > 0) {
                levels.push(rootStages);
                rootStages.forEach(s => visited.add(s.id));

                // Build levels based on connections
                let currentLevel = rootStages;
                while (currentLevel.length > 0) {
                    const nextLevel = [];
                    currentLevel.forEach(stage => {
                        const children = connections
                            .filter(c => c.from === stage.id)
                            .map(c => stages.find(s => s.id === c.to))
                            .filter(s => s && !visited.has(s.id));

                        children.forEach(child => {
                            if (!visited.has(child.id)) {
                                nextLevel.push(child);
                                visited.add(child.id);
                            }
                        });
                    });

                    if (nextLevel.length > 0) {
                        levels.push(nextLevel);
                    }
                    currentLevel = nextLevel;
                }
            }

            // Add any unconnected stages
            const unconnected = stages.filter(s => !visited.has(s.id));
            if (unconnected.length > 0) {
                levels.push(unconnected);
            }

            // Position stages
            const totalWidth = levels.length * stageWidth + (levels.length - 1) * horizontalGap;
            const startX = (canvasWidth - totalWidth) / 2;

            levels.forEach((level, levelIndex) => {
                const x = startX + levelIndex * (stageWidth + horizontalGap);
                const totalHeight = level.length * stageHeight + (level.length - 1) * verticalGap;
                const startY = (canvasHeight - totalHeight) / 2;

                level.forEach((stage, stageIndex) => {
                    stage.x = x;
                    stage.y = startY + stageIndex * (stageHeight + verticalGap);

                    const stageEl = document.getElementById(stage.id);
                    if (stageEl) {
                        stageEl.style.left = stage.x + 'px';
                        stageEl.style.top = stage.y + 'px';

                        // Add animation
                        stageEl.style.transition = 'all 0.5s ease';
                        setTimeout(() => {
                            stageEl.style.transition = '';
                        }, 500);
                    }
                });
            });

            setTimeout(() => {
                drawConnections();
            }, 100);
        }

        // Update statistics
        function updateStats() {
            document.getElementById('stageCount').textContent = stages.length;
            document.getElementById('connectionCount').textContent = connections.length;

            // Calculate conversion rate
            if (stages.length > 0) {
                const avgConversion = Math.round(
                    stages.reduce((sum, s) => sum + s.conversion, 0) / stages.length
                );
                document.getElementById('conversionRate').textContent = avgConversion + '%';
            } else {
                document.getElementById('conversionRate').textContent = '0%';
            }
        }

        // Export journey
        function exportJourney() {
            const journeyData = {
                stages: stages,
                connections: connections,
                exportDate: new Date().toISOString(),
                stats: {
                    totalStages: stages.length,
                    totalConnections: connections.length,
                    averageConversion: stages.length > 0 ?
                        Math.round(stages.reduce((sum, s) => sum + s.conversion, 0) / stages.length) : 0
                }
            };

            const dataStr = JSON.stringify(journeyData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = 'customer-journey-' + new Date().toISOString().split('T')[0] + '.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' && selectedStage) {
                deleteStage(selectedStage.id);
            }

            if (e.key === 'Escape') {
                closeModal();
                selectStage(null);
            }

            if (e.ctrlKey && e.key === 'a') {
                e.preventDefault();
                autoArrange();
            }
        });

        // Click outside to deselect
        document.getElementById('canvasContainer').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                selectStage(null);
            }
        });

        // Add initial demo stages
        setTimeout(() => {
            createStage('awareness', 100, 150);
            createStage('interest', 350, 100);
            createStage('consideration', 350, 250);
            createStage('purchase', 600, 175);

            setTimeout(() => {
                createConnection(stages[0], stages[1]);
                createConnection(stages[0], stages[2]);
                createConnection(stages[1], stages[3]);
                createConnection(stages[2], stages[3]);
            }, 100);
        }, 500);
    </script>
</body>
</html>