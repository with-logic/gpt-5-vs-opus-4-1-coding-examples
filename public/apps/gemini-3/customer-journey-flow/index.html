<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Journey Flow</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #f8fafc;
            overflow: hidden;
        }
        
        .dots-pattern {
            background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
            background-size: 24px 24px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .node-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: box-shadow 0.2s, transform 0.1s;
        }
        .node-shadow:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }
        
        .handle {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .handle:hover {
            transform: scale(1.1);
            background-color: #eff6ff;
            border-color: #3b82f6;
        }
        .handle.active-target {
            transform: scale(1.3);
            background-color: #dbeafe;
            border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }

        .noselect { user-select: none; }
    </style>
</head>
<body class="h-screen w-screen text-slate-800">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Icons (Inline SVG for stability) ---
        const IconPlus = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
        );
        const IconTrash = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
        );
        const IconX = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );
        const IconInfo = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        );
        const IconMouse = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="5" y="2" width="14" height="20" rx="7"/><path d="M12 6v4"/></svg>
        );
        const IconCornerRight = () => (
             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 10 20 15 15 20"/><path d="M4 4v7a4 4 0 0 0 4 4h12"/></svg>
        );

        // --- Helper: Generate ID ---
        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- Components ---

        // 1. Connection Line (SVG)
        const Connection = ({ start, end, isTemp = false }) => {
            const dist = Math.abs(end.x - start.x);
            // Dynamic control point offset for smoother curves
            const controlOffset = Math.max(dist * 0.5, 60);
            
            const pathData = `M ${start.x} ${start.y} C ${start.x + controlOffset} ${start.y}, ${end.x - controlOffset} ${end.y}, ${end.x} ${end.y}`;

            return (
                <g className="pointer-events-none">
                    {/* Shadow for depth */}
                    <path d={pathData} fill="none" stroke="white" strokeWidth="8" strokeOpacity="0.8" />
                    {/* The Line */}
                    <path 
                        d={pathData} 
                        fill="none" 
                        stroke={isTemp ? "#3b82f6" : "#64748b"} 
                        strokeWidth={isTemp ? "3" : "2"}
                        strokeDasharray={isTemp ? "6,4" : "none"}
                        strokeLinecap="round"
                        className="transition-colors duration-300"
                        style={{ filter: isTemp ? 'drop-shadow(0 0 2px rgba(59,130,246,0.5))' : 'none' }}
                    />
                    {/* Arrowhead or Dot at end */}
                    {!isTemp && <circle cx={end.x} cy={end.y} r="3" fill="#64748b" />}
                </g>
            );
        };

        // 2. Node Component
        const Node = ({ 
            id, x, y, title, description, color, 
            onDelete, onDragStart, onConnectStart, onConnectEnd, 
            onUpdate, isConnectionTarget
        }) => {
            const handleMouseDown = (e) => {
                // Prevent drag when interacting with inputs or handles
                if (e.target.closest('input, textarea, button, .handle')) return;
                onDragStart(id, e);
            };

            const handleTitleChange = (e) => onUpdate(id, { title: e.target.value });
            const handleDescChange = (e) => onUpdate(id, { description: e.target.value });

            return (
                <div 
                    className={`absolute w-72 bg-white rounded-xl border-t-[6px] ${color} node-shadow flex flex-col group`}
                    style={{ left: x, top: y, zIndex: 10 }}
                    onMouseDown={handleMouseDown}
                >
                    {/* Input Handle (Target) */}
                    <div 
                        className={`handle absolute -left-4 top-[52px] w-8 h-8 bg-white border-2 border-slate-300 rounded-full flex items-center justify-center cursor-crosshair z-30 shadow-sm ${isConnectionTarget ? 'active-target' : ''}`}
                        onMouseUp={(e) => onConnectEnd(id, e)}
                        title="Drop connection here"
                    >
                        <div className={`w-2 h-2 rounded-full pointer-events-none transition-colors ${isConnectionTarget ? 'bg-blue-500' : 'bg-slate-300'}`}></div>
                    </div>

                    {/* Output Handle (Source) */}
                    <div 
                        className="handle absolute -right-4 top-[52px] w-8 h-8 bg-white border-2 border-slate-300 rounded-full flex items-center justify-center cursor-crosshair z-30 shadow-sm hover:border-blue-400"
                        onMouseDown={(e) => onConnectStart(id, e)}
                        title="Drag to connect"
                    >
                        <div className="w-2 h-2 bg-slate-300 rounded-full pointer-events-none group-hover:bg-blue-400 transition-colors"></div>
                    </div>

                    {/* Content */}
                    <div className="p-4 pb-2">
                        <div className="flex justify-between items-start gap-2 mb-2">
                            <input
                                value={title}
                                onChange={handleTitleChange}
                                className="font-bold text-lg text-slate-800 bg-transparent border-none outline-none w-full placeholder-slate-400 focus:placeholder-slate-200 rounded px-1 -ml-1 transition-all focus:bg-slate-50 focus:ring-2 focus:ring-blue-100"
                                placeholder="Stage Name"
                            />
                            <button 
                                onClick={() => onDelete(id)} 
                                className="text-slate-300 hover:text-red-500 hover:bg-red-50 p-1.5 rounded-md transition-all opacity-0 group-hover:opacity-100"
                                title="Delete Stage"
                            >
                                <IconTrash />
                            </button>
                        </div>
                        <textarea
                            value={description}
                            onChange={handleDescChange}
                            rows="2"
                            className="w-full text-sm text-slate-600 bg-transparent border-none outline-none resize-none placeholder-slate-300 focus:placeholder-slate-200 rounded px-1 -ml-1 transition-all focus:bg-slate-50 focus:ring-2 focus:ring-blue-100 leading-relaxed"
                            placeholder="Describe this step..."
                        />
                    </div>
                </div>
            );
        };

        // 3. Toolbar Component
        const Toolbar = ({ onAddNode, onClear, onHelp }) => {
            return (
                <div className="fixed top-6 left-1/2 -translate-x-1/2 bg-white/80 backdrop-blur-md shadow-[0_8px_30px_rgb(0,0,0,0.12)] border border-white/50 rounded-full px-3 py-2 flex gap-1 z-50">
                    <button 
                        onClick={() => onAddNode()} 
                        className="flex items-center gap-2 px-5 py-2.5 bg-slate-900 hover:bg-slate-800 text-white rounded-full text-sm font-semibold transition-all shadow-md active:scale-95"
                    >
                        <IconPlus /> Add Stage
                    </button>
                    <div className="w-px bg-slate-200 mx-2 my-2"></div>
                     <button 
                        onClick={onClear}
                        className="px-4 py-2.5 text-slate-600 hover:text-red-600 hover:bg-red-50/50 rounded-full text-sm font-medium transition-colors"
                        title="Clear Canvas"
                    >
                        Clear
                    </button>
                    <button 
                        onClick={onHelp}
                        className="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-blue-600 hover:bg-blue-50/50 rounded-full transition-colors"
                        title="Help"
                    >
                        <IconInfo />
                    </button>
                </div>
            );
        };

        // 4. Main App
        const App = () => {
            // Initial Data
            const initialNodes = [
                { id: '1', x: 100, y: 200, title: 'Awareness', description: 'User discovers the brand through social media ads.', color: 'border-indigo-500' },
                { id: '2', x: 500, y: 200, title: 'Consideration', description: 'User browses product catalog and reads reviews.', color: 'border-blue-500' },
                { id: '3', x: 900, y: 200, title: 'Purchase', description: 'User adds to cart and completes checkout.', color: 'border-emerald-500' }
            ];
            
            const initialEdges = [
                { id: 'e1-2', source: '1', target: '2' },
                { id: 'e2-3', source: '2', target: '3' }
            ];

            const [nodes, setNodes] = useState(initialNodes);
            const [edges, setEdges] = useState(initialEdges);
            
            const [dragState, setDragState] = useState(null); 
            const [connectState, setConnectState] = useState(null); 
            const [hoveredNodeId, setHoveredNodeId] = useState(null); // Track node under mouse for connection snapping visual

            const [showHelp, setShowHelp] = useState(false);
            
            // --- Actions ---
            const addNode = () => {
                const id = generateId();
                const colors = ['border-indigo-500', 'border-blue-500', 'border-emerald-500', 'border-amber-500', 'border-rose-500', 'border-violet-500'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];

                const newNode = {
                    id,
                    x: Math.max(100, Math.random() * (window.innerWidth - 400)),
                    y: Math.max(150, Math.random() * (window.innerHeight - 300)),
                    title: 'New Stage',
                    description: '',
                    color: randomColor
                };
                setNodes([...nodes, newNode]);
            };

            const updateNode = (id, data) => {
                setNodes(nodes.map(n => n.id === id ? { ...n, ...data } : n));
            };

            const deleteNode = (id) => {
                setNodes(nodes.filter(n => n.id !== id));
                setEdges(edges.filter(e => e.source !== id && e.target !== id));
            };

            // --- Interaction Handlers ---
            const handleNodeDragStart = (id, e) => {
                const node = nodes.find(n => n.id === id);
                setDragState({
                    nodeId: id,
                    offsetX: e.clientX - node.x,
                    offsetY: e.clientY - node.y
                });
            };

            const handleConnectStart = (sourceId, e) => {
                e.stopPropagation(); 
                e.preventDefault(); // Prevent text selection
                const rect = e.target.getBoundingClientRect();
                setConnectState({
                    sourceId,
                    startPos: { x: rect.left + rect.width/2, y: rect.top + rect.height/2 },
                    mousePos: { x: e.clientX, y: e.clientY }
                });
            };

            const handleConnectEnd = (targetId, e) => {
                e.stopPropagation();
                if (connectState && connectState.sourceId !== targetId) {
                    const exists = edges.some(edge => edge.source === connectState.sourceId && edge.target === targetId);
                    if (!exists) {
                        setEdges([...edges, {
                            id: generateId(),
                            source: connectState.sourceId,
                            target: targetId
                        }]);
                    }
                }
                setConnectState(null);
                setHoveredNodeId(null);
            };

            const handleGlobalMouseMove = useCallback((e) => {
                if (dragState) {
                    const newX = e.clientX - dragState.offsetX;
                    const newY = e.clientY - dragState.offsetY;
                    setNodes(prev => prev.map(n => n.id === dragState.nodeId ? { ...n, x: newX, y: newY } : n));
                }
                
                if (connectState) {
                    setConnectState(prev => ({ ...prev, mousePos: { x: e.clientX, y: e.clientY } }));
                    
                    // Hit testing for "snap" effect (purely visual in this simple version)
                    // We check if we are over a .handle element that isn't the source
                    const elementBelow = document.elementFromPoint(e.clientX, e.clientY);
                    const handle = elementBelow?.closest('.handle');
                    // We can't easily get the React ID from the DOM element without data attributes
                    // So we rely on the component's onMouseUp, but for hover effect we might want state
                    // This is handled by CSS mostly, but if we wanted to snap the line to the target *before* dropping
                    // that would require more complex logic. For now, the line follows mouse.
                }
            }, [dragState, connectState]);

            const handleGlobalMouseUp = useCallback(() => {
                setDragState(null);
                setConnectState(null);
                setHoveredNodeId(null);
            }, []);

            useEffect(() => {
                window.addEventListener('mousemove', handleGlobalMouseMove);
                window.addEventListener('mouseup', handleGlobalMouseUp);
                return () => {
                    window.removeEventListener('mousemove', handleGlobalMouseMove);
                    window.removeEventListener('mouseup', handleGlobalMouseUp);
                };
            }, [handleGlobalMouseMove, handleGlobalMouseUp]);


            // --- Helper to get handle positions ---
            const getNodeHandles = (nodeId) => {
                const node = nodes.find(n => n.id === nodeId);
                if (!node) return { in: {x:0, y:0}, out: {x:0, y:0} };
                
                // Matches CSS: Top + 52px (top offset) + 16px (half height of 32px handle) = 68px
                const yOffset = 52 + 16; 
                return {
                    in: { x: node.x, y: node.y + yOffset },
                    out: { x: node.x + 288, y: node.y + yOffset } // 288 is w-72 (18rem = 288px)
                };
            };

            // Detect if a node is a valid drop target during drag
            const isPotentialTarget = (id) => {
                return connectState && connectState.sourceId !== id;
            };

            return (
                <div className="w-full h-full relative dots-pattern bg-slate-50 overflow-hidden select-none">
                    <Toolbar 
                        onAddNode={addNode} 
                        onClear={() => { setNodes([]); setEdges([]); }}
                        onHelp={() => setShowHelp(true)}
                    />

                    {/* Help Modal */}
                    {showHelp && (
                        <div className="fixed inset-0 bg-slate-900/40 z-[100] flex items-center justify-center backdrop-blur-sm p-4">
                            <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-lg w-full transform transition-all">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-slate-800">Customer Journey Flow</h2>
                                    <button onClick={() => setShowHelp(false)} className="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100"><IconX/></button>
                                </div>
                                <div className="space-y-4">
                                    <div className="flex gap-4 items-start">
                                        <div className="p-3 bg-blue-50 text-blue-600 rounded-xl"><IconPlus /></div>
                                        <div>
                                            <h3 className="font-semibold text-slate-800">Add Stages</h3>
                                            <p className="text-slate-500 text-sm">Create new cards to represent steps in your customer's journey.</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-4 items-start">
                                        <div className="p-3 bg-indigo-50 text-indigo-600 rounded-xl"><IconMouse /></div>
                                        <div>
                                            <h3 className="font-semibold text-slate-800">Move & Edit</h3>
                                            <p className="text-slate-500 text-sm">Drag cards to arrange them. Click text to rename stages or add descriptions.</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-4 items-start">
                                        <div className="p-3 bg-emerald-50 text-emerald-600 rounded-xl"><IconCornerRight /></div>
                                        <div>
                                            <h3 className="font-semibold text-slate-800">Connect</h3>
                                            <p className="text-slate-500 text-sm">Drag from the <strong>Right Dot</strong> of one card to the <strong>Left Dot</strong> of another to link them.</p>
                                        </div>
                                    </div>
                                </div>
                                <button 
                                    onClick={() => setShowHelp(false)}
                                    className="mt-8 w-full py-3 bg-slate-900 text-white rounded-xl font-medium hover:bg-slate-800 transition-all hover:shadow-lg active:scale-[0.98]"
                                >
                                    Start Mapping
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Connection Layer (SVG) */}
                    <svg className="absolute inset-0 pointer-events-none w-full h-full z-0 overflow-visible">
                        {edges.map(edge => {
                            const sourceHandles = getNodeHandles(edge.source);
                            const targetHandles = getNodeHandles(edge.target);
                            return <Connection key={edge.id} start={sourceHandles.out} end={targetHandles.in} />;
                        })}
                        
                        {connectState && (
                            <Connection 
                                start={getNodeHandles(connectState.sourceId).out}
                                end={connectState.mousePos}
                                isTemp={true}
                            />
                        )}
                    </svg>

                    {/* Nodes Layer */}
                    <div className="relative z-10 w-full h-full">
                        {nodes.map(node => (
                            <Node 
                                key={node.id} 
                                {...node} 
                                onDelete={deleteNode}
                                onDragStart={handleNodeDragStart}
                                onConnectStart={handleConnectStart}
                                onConnectEnd={handleConnectEnd}
                                onUpdate={updateNode}
                                isConnectionTarget={isPotentialTarget(node.id)}
                            />
                        ))}
                    </div>
                    
                    {/* Empty State */}
                    {nodes.length === 0 && (
                        <div className="absolute inset-0 flex items-center justify-center text-slate-300 pointer-events-none">
                            <div className="text-center">
                                <p className="mb-2 text-2xl font-bold opacity-50">Canvas Empty</p>
                                <p className="opacity-50">Add a stage to begin</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>