<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Asteroid Ace ‚Äî 2D Space Dogfight</title>
  <style>
    :root{
      --bg:#05070c; --ink:#cfe8ff; --accent:#62e0ff; --danger:#ff6b6b; --warning:#ffd166; --ok:#7bfd9a;
      --hud:#0c1220; --hud2:#0c1a33; --glow: drop-shadow(0 0 6px rgba(98,224,255,.45));
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 800px at 70% -10%, #0a1030 0%, #071022 35%, var(--bg) 70%);
      color:var(--ink); font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
      overflow:hidden; touch-action:none; -webkit-tap-highlight-color: transparent;
    }
    canvas{position:fixed; inset:0; width:100%; height:100%;}

    /* HUD */
    .hud{position:fixed; left:0; right:0; top:0; display:flex; align-items:center; gap:10px; padding:10px 14px;
      background: linear-gradient(180deg, rgba(8,12,24,.6), rgba(8,12,24,0)); backdrop-filter: blur(6px);
      border-bottom:1px solid rgba(255,255,255,.06); pointer-events:none;}
    .hud .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .hud .sep{opacity:.25;}
    .right{margin-left:auto; display:flex; gap:8px;}
    .meter{--val:0; width:140px; height:10px; border-radius:999px; background:rgba(255,255,255,.08); position:relative; overflow:hidden}
    .meter::after{content:""; position:absolute; inset:0; width:calc(var(--val)*1%); background:linear-gradient(90deg, var(--accent), #54ffa8);}
    .meter.warn::after{background:linear-gradient(90deg, var(--warning), #ff9b6b)}
    .lives{display:flex; gap:6px}
    .life{width:14px; height:14px; border-radius:3px; background:linear-gradient(180deg, #72f7ff, #1c8dff); box-shadow:0 0 10px #72f7ff77}

    /* Center announcements */
    .center{position:fixed; inset:0; display:grid; place-items:center; pointer-events:none;}
    .panel{pointer-events:auto; text-align:center; padding:22px 20px; border-radius:16px;
      background:linear-gradient(180deg, rgba(15,20,40,.7), rgba(10,14,28,.7));
      border:1px solid rgba(255,255,255,.08); box-shadow:0 12px 50px rgba(0,0,0,.45);
      animation: pop .2s ease-out;
    }
    .title{font-size:28px; letter-spacing:.4px; font-weight:700; margin-bottom:10px; filter:var(--glow)}
    .subtitle{opacity:.9; margin-bottom:14px}
    .kbd{display:inline-block; min-width:24px; padding:3px 7px; border-radius:6px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08);}
    .row{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
    .btn{cursor:pointer; display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02)); box-shadow:0 4px 22px rgba(0,0,0,.3);
      transition:transform .08s ease; user-select:none;}
    .btn:active{transform:translateY(1px)}
    .muted{opacity:.75}

    /* Mobile controls */
    .touch{position:fixed; inset:0; pointer-events:none}
    .stickZone{position:absolute; left:16px; bottom:16px; width:34vw; max-width:320px; aspect-ratio:1; pointer-events:auto}
    .buttons{position:absolute; right:16px; bottom:16px; display:flex; gap:12px; pointer-events:auto}
    .circle{width:70px; height:70px; border-radius:50%; background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.2), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.18); box-shadow:0 6px 30px rgba(0,0,0,.45); display:grid; place-items:center}
    .circle.small{width:64px; height:64px}
    .hint{position:absolute; left:16px; bottom:120px; opacity:.75}

    @keyframes pop{from{transform:scale(.94); opacity:0} to{transform:scale(1); opacity:1}}
    .hidden{display:none}
  </style>
</head>
<body>
  <canvas id="game" aria-label="Asteroid Ace game canvas"></canvas>

  <!-- HUD -->
  <div class="hud" id="hud">
    <div class="pill">Score: <strong id="score">0</strong></div>
    <div class="sep">|</div>
    <div class="pill">Level: <strong id="level">1</strong></div>
    <div class="sep">|</div>
    <div class="pill">Gun Heat
      <div class="meter warn" id="heatMeter" style="--val:0"></div>
    </div>
    <div class="sep">|</div>
    <div class="pill">Boost
      <div class="meter" id="boostMeter" style="--val:100"></div>
    </div>
    <div class="right">
      <div class="pill lives" id="lives"></div>
      <div class="pill muted">H/M: <span class="kbd">P</span> <span class="kbd">R</span> <span class="kbd">M</span></div>
    </div>
  </div>

  <!-- Center panels -->
  <div class="center" id="center">
    <div class="panel" id="panelStart">
      <div class="title">Asteroid Ace</div>
      <div class="subtitle">Fly. Dodge. Shred rocks. Outfox enemy aces.</div>
      <div class="row" style="margin-bottom:8px">
        <div class="kbd">‚Üê</div><div class="kbd">‚Üí</div> rotate
        <div class="kbd">‚Üë</div>/<div class="kbd">W</div> thrust
        <div class="kbd">Space</div> fire
        <div class="kbd">Shift</div> boost
      </div>
      <div class="row muted" style="margin-bottom:14px">On mobile: drag left pad, tap Fire/Boost</div>
      <div class="row">
        <div class="btn" id="btnStart">Play</div>
        <div class="btn" id="btnMute">Mute</div>
      </div>
    </div>

    <div class="panel hidden" id="panelPause">
      <div class="title">Paused</div>
      <div class="row">
        <div class="btn" id="btnResume">Resume (P)</div>
        <div class="btn" id="btnRestart">Restart (R)</div>
      </div>
    </div>

    <div class="panel hidden" id="panelGameOver">
      <div class="title">Game Over</div>
      <div class="subtitle" id="finalScore">Score: 0 ‚Äî Best: 0</div>
      <div class="row">
        <div class="btn" id="btnAgain">Play Again (R)</div>
        <div class="btn" id="btnMenu">Main Menu</div>
      </div>
    </div>
  </div>

  <!-- Mobile Controls -->
  <div class="touch" id="touch">
    <div class="stickZone" id="stickZone"></div>
    <div class="buttons">
      <div class="circle small" id="btnFire">üî•</div>
      <div class="circle" id="btnBoost">‚ö°</div>
    </div>
    <div class="hint muted">Drag left pad to steer + thrust</div>
  </div>

<script>
(() => {
  // ===== Utilities =====
  const TAU = Math.PI * 2;
  const rand = (a=1,b) => b===undefined ? Math.random()*a : a + Math.random()*(b-a);
  const randi = (a,b) => Math.floor(rand(a,b));
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const lerp = (a,b,t)=>a+(b-a)*t;
  const angNorm = a => (a+TAU)%TAU;
  const dist2 = (a,b)=>{const dx=a.x-b.x, dy=a.y-b.y; return dx*dx+dy*dy}

  // PRNG with seed for reproducibility
  function RNG(seed=Date.now()%2**31){
    let s = seed>>>0;
    return () => (s = (s*1664525 + 1013904223)>>>0)/4294967296;
  }

  // ===== Audio (WebAudio beeps, light-weight) =====
  const AudioSys = (()=>{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    let muted = false;
    const master = ctx.createGain(); master.gain.value = 0.2; master.connect(ctx.destination);
    const noiseBuf = (()=>{ // for explosions
      const b = ctx.createBuffer(1, ctx.sampleRate * 1.0, ctx.sampleRate);
      const d = b.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i] = Math.random()*2-1;
      return b;
    })();
    const resume = async()=>{ if(ctx.state !== 'running') try{ await ctx.resume(); }catch(e){} }
    const setMute = (m)=>{ muted=m; master.gain.linearRampToValueAtTime(m?0:0.2, ctx.currentTime+0.05) }
    const click = (freq=440, dur=0.07, type='square', vol=0.3)=>{ if(muted) return;
      resume(); const o=ctx.createOscillator(), g=ctx.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(master);
      const t=ctx.currentTime; g.gain.exponentialRampToValueAtTime(0.001, t+dur);
      o.start(t); o.stop(t+dur);
    };
    const thrust = (()=>{ // continuous engine hum
      const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sawtooth'; o.frequency.value=60; g.gain.value=0.0;
      o.connect(g); g.connect(master); o.start(); return {
        set(on){ if(muted) return; resume(); g.gain.linearRampToValueAtTime(on?0.06:0.0, ctx.currentTime+0.05) },
        pitch(p){ o.frequency.linearRampToValueAtTime(50+150*p, ctx.currentTime+0.05) }
      };
    })();
    const explode = (vol=0.35)=>{ if(muted) return; resume();
      const src = ctx.createBufferSource(); src.buffer = noiseBuf; const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=200; bp.Q.value=0.5;
      const g = ctx.createGain(); g.gain.value = vol; src.connect(bp); bp.connect(g); g.connect(master);
      const t=ctx.currentTime; g.gain.exponentialRampToValueAtTime(0.0001, t+0.8); src.start(t); src.stop(t+0.9);
    }
    return { click, thrust, explode, setMute, get muted(){return muted} };
  })();

  // ===== Input =====
  const Input = (()=>{
    const keys = new Map();
    const down = e => { keys.set(e.code, true); if(['Space','ArrowUp'].includes(e.code)) e.preventDefault() };
    const up = e => keys.set(e.code, false);
    window.addEventListener('keydown', down, {passive:false});
    window.addEventListener('keyup', up);
    const pressed = c => !!keys.get(c);

    // Touch joystick
    const stickZone = document.getElementById('stickZone');
    const btnFire = document.getElementById('btnFire');
    const btnBoost = document.getElementById('btnBoost');
    let stick = {active:false, dx:0, dy:0};
    const pt = {x:0,y:0};
    const onStick = (e)=>{
      const t = e.touches ? e.touches[0] : e; const rect = stickZone.getBoundingClientRect();
      const x = clamp((t.clientX - rect.left)/rect.width, 0, 1);
      const y = clamp((t.clientY - rect.top)/rect.height, 0, 1);
      stick.dx = (x-.5)*2; stick.dy = (y-.5)*2; stick.active = true;
    };
    const endStick = ()=>{ stick.active=false; stick.dx=stick.dy=0 };
    ['mousedown','mousemove','touchstart','touchmove'].forEach(ev=>stickZone.addEventListener(ev, onStick, {passive:false}));
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>stickZone.addEventListener(ev, endStick));

    let fireHold=false, boostHold=false; btnFire.addEventListener('pointerdown',()=>fireHold=true);
    btnFire.addEventListener('pointerup',()=>fireHold=false); btnFire.addEventListener('pointerleave',()=>fireHold=false);
    btnBoost.addEventListener('pointerdown',()=>boostHold=true);
    btnBoost.addEventListener('pointerup',()=>boostHold=false); btnBoost.addEventListener('pointerleave',()=>boostHold=false);

    return { pressed, stick, get fire(){return fireHold || pressed('Space')}, get boost(){return boostHold || pressed('ShiftLeft')||pressed('ShiftRight')},
             get left(){return pressed('ArrowLeft')||pressed('KeyA')}, get right(){return pressed('ArrowRight')||pressed('KeyD')}, get thrust(){return pressed('ArrowUp')||pressed('KeyW')||stick.active}, };
  })();

  // ===== Rendering =====
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let W=0,H=0, DPR=Math.min(2, window.devicePixelRatio||1);
  function resize(){ W=canvas.width = Math.floor(innerWidth*DPR); H=canvas.height = Math.floor(innerHeight*DPR); canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px' }
  window.addEventListener('resize', resize);
  resize();

  // Stars background
  const starRng = RNG(1337);
  const stars = Array.from({length:260},()=>({ x: starRng()*1, y: starRng()*1, z: starRng()*1 }));

  function drawStars(camx, camy){
    ctx.save();
    ctx.globalAlpha = 0.9; // mild brightness
    for(const s of stars){
      const par = 0.15 + s.z*0.55; // parallax factor
      const x = ((s.x*W - camx*par) % W + W) % W;
      const y = ((s.y*H - camy*par) % H + H) % H;
      const r = (1.0 - s.z) * 1.8 + 0.3;
      ctx.fillStyle = `rgba(${200+Math.floor(55*s.z)}, ${210+Math.floor(30*s.z)}, 255, ${0.6 + 0.4*(1-s.z)})`;
      ctx.fillRect(x, y, r, r);
    }
    ctx.restore();
  }

  // ===== Entities =====
  class Bullet{
    constructor(x,y,vx,vy, friendly=true){ this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.life=1.4; this.r=3; this.friendly=friendly }
    update(dt){ this.x+=this.vx*dt; this.y+=this.vy*dt; this.life-=dt; wrap(this); }
    draw(){ ctx.save(); ctx.fillStyle=this.friendly?'#aef':'#ff9b6b'; ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,TAU); ctx.fill(); ctx.restore(); }
  }

  class Particle{
    constructor(x,y,color, life=0.8, size=2){ this.x=x; this.y=y; this.vx=rand(-120,120); this.vy=rand(-120,120); this.life=life; this.max=life; this.s=size; this.c=color }
    update(dt){ this.x+=this.vx*dt; this.y+=this.vy*dt; this.vx*=0.98; this.vy*=0.98; this.life-=dt; wrap(this) }
    draw(){ const a=clamp(this.life/this.max,0,1); ctx.fillStyle=this.c; ctx.globalAlpha=a; ctx.fillRect(this.x|0, this.y|0, this.s, this.s); ctx.globalAlpha=1 }
  }

  class Asteroid{
    constructor(x,y, size=3){
      this.x=x; this.y=y; this.size=size; this.r = size*22 + rand(12,16);
      this.vx=rand(-60,60); this.vy=rand(-60,60); this.spin=rand(-1,1); this.a = rand(0,TAU);
      // build jagged polygon shape
      const points= randi(9,14), rng = RNG(randi(0,1e9)); this.shape=[];
      for(let i=0;i<points;i++){ const ang = i/points*TAU + rng()*0.2; const rad = this.r * (0.75 + rng()*0.5); this.shape.push({ang, rad}); }
      this.hp = 10 * size;
    }
    update(dt){ this.x+=this.vx*dt; this.y+=this.vy*dt; this.a+=this.spin*dt; wrap(this) }
    draw(){ ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.a); ctx.strokeStyle='#bcd7ff'; ctx.lineWidth=2; ctx.beginPath();
      for(let i=0;i<this.shape.length;i++){ const p=this.shape[i]; const x=Math.cos(p.ang)*p.rad, y=Math.sin(p.ang)*p.rad; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y) }
      ctx.closePath(); ctx.stroke(); ctx.restore(); }
  }

  class Ship{
    constructor(x,y, isEnemy=false){
      this.x=x; this.y=y; this.vx=0; this.vy=0; this.a= -Math.PI/2; this.r=15; this.isEnemy=isEnemy;
      this.cool=0; this.heat=0; this.dead=false; this.inv=0; this.energy=100; this.ai = isEnemy ? new EnemyBrain(this) : null;
      this.color = isEnemy ? '#ffb37a' : '#9ce5ff';
    }
    thrust(amount){ const thrust=amount*220*(1+(Input.boost?0.35:0)); this.vx += Math.cos(this.a)*thrust; this.vy += Math.sin(this.a)*thrust }
    update(dt){
      // cooling and timers
      this.cool=Math.max(0,this.cool-dt); this.heat = Math.max(0, this.heat - dt*22); this.inv=Math.max(0,this.inv-dt);
      // control
      if(!this.isEnemy){
        const rotSpeed = 3.6;
        let steer = 0;
        if(Input.left) steer -= 1; if(Input.right) steer += 1;
        if(Input.stick.active){ // map stick to angle + thrust
          const ang = Math.atan2(Input.stick.dy, Input.stick.dx);
          if(!Number.isNaN(ang)) this.a = ang; // direct aim
        } else {
          this.a += steer * rotSpeed * dt;
        }
        const thrusting = Input.thrust || (Input.stick.active && (Input.stick.dx*Input.stick.dx+Input.stick.dy*Input.stick.dy)>0.05);
        const boost = Input.boost && this.energy>0;
        if(thrusting){ this.thrust(dt * (boost?1.4:1)); AudioSys.thrust.set(true); AudioSys.thrust.pitch(Math.random()*0.2 + (boost?0.9:0.5)); }
        else { AudioSys.thrust.set(false); }
        if(boost) this.energy = Math.max(0, this.energy - dt*22); else this.energy = Math.min(100, this.energy + dt*10);
        if(Input.fire) this.fire();
      } else {
        this.ai.update(dt);
      }
      // physics
      const drag = 0.995; this.vx*=drag; this.vy*=drag;
      // clamp
      const maxSp = 420; const sp2=this.vx*this.vx+this.vy*this.vy; if(sp2>maxSp*maxSp){ const s=Math.sqrt(sp2); this.vx*=maxSp/s; this.vy*=maxSp/s }
      this.x+=this.vx*dt; this.y+=this.vy*dt; wrap(this);
    }
    fire(){ if(this.cool>0 || this.heat>95) return; this.cool= this.isEnemy? 0.22: 0.14; this.heat+=10;
      const spread = this.isEnemy? 0.05 : 0.03;
      const a = this.a + rand(-spread, spread);
      const speed = 520; const bx = this.x + Math.cos(a)*this.r*1.2; const by = this.y + Math.sin(a)*this.r*1.2;
      const bvx = this.vx + Math.cos(a)*speed; const bvy = this.vy + Math.sin(a)*speed;
      bullets.push(new Bullet(bx,by,bvx,bvy, !this.isEnemy));
      AudioSys.click(this.isEnemy? 260: 380, 0.06, this.isEnemy? 'square':'triangle', 0.25);
      shake += this.isEnemy? 0.3:0.4;
    }
    hit(force=1){ if(this.inv>0) return; this.inv=1.2; this.dead=false; this.heat+=25; emitExplosion(this.x,this.y,this.color); AudioSys.explode(0.25); shake+=1.2*force;
      if(!this.isEnemy){ lives--; if(lives<0){ gameOver(); } }
      else { // enemy dies
        score+=250; removeEntity(enemies, this); spawnPowerUp(this.x,this.y); }
    }
    draw(){ ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.a);
      const inv = this.inv>0 ? (0.4 + 0.6*Math.sin(perf*20)) : 1;
      ctx.globalAlpha = inv;
      // body
      ctx.strokeStyle=this.color; ctx.lineWidth=2; ctx.beginPath();
      // sleek arrow + fins
      ctx.moveTo(18,0); ctx.lineTo(-12,-10); ctx.lineTo(-6,-5); ctx.lineTo(-10,0); ctx.lineTo(-6,5); ctx.lineTo(-12,10); ctx.closePath(); ctx.stroke();
      // engine glow
      ctx.globalAlpha = Math.min(1, (Input.thrust?1:0)*0.8 + (this.isEnemy?0:0));
      const flame = 8 + 12*Math.random() + (Input.boost?10:0);
      ctx.strokeStyle='#ffb86b'; ctx.beginPath(); ctx.moveTo(-12,0); ctx.lineTo(-12-flame,0); ctx.stroke();
      ctx.globalAlpha = inv;
      ctx.restore(); }
  }

  // Enemy AI: keeps distance, strafes, leads shots
  class EnemyBrain{
    constructor(ship){ this.s=ship; this.cool=0; this.state='approach'; }
    update(dt){ const p = player; if(!p) return; const s=this.s;
      const dx=p.x-s.x, dy=p.y-s.y; const d=Math.hypot(dx,dy)+1e-5; const dir=Math.atan2(dy,dx);
      const desiredDist = 320; // sweet spot
      // lead aim
      const leadTime = Math.min(0.8, d/520); const aimX=p.x + p.vx*leadTime, aimY=p.y + p.vy*leadTime; s.a = Math.atan2(aimY-s.y, aimX-s.x);
      // orbit/approach
      let thrust = 0.7; if(d<desiredDist*0.8) thrust=-0.3; else if(d>desiredDist*1.2) thrust=1.0; s.thrust(dt*thrust);
      // strafe
      const strafeAngle = dir + Math.PI/2 * (Math.sin(perf*0.7)>0?1:-1); s.vx += Math.cos(strafeAngle)*30*dt; s.vy += Math.sin(strafeAngle)*30*dt;
      // evade bullets
      for(const b of bullets){ if(!b.friendly) continue; const dd = Math.hypot(b.x-s.x, b.y-s.y); if(dd<160){ const a=Math.atan2(s.y-b.y, s.x-b.x); s.vx+=Math.cos(a)*80*dt; s.vy+=Math.sin(a)*80*dt } }
      if(s.cool<=0){ s.fire(); s.cool=0.05; } else s.cool-=dt;
    }
  }

  // ===== Game State =====
  let bullets=[], particles=[], asteroids=[], enemies=[];
  let player=null, score=0, level=1, lives=3, running=false, paused=false, shake=0, perf=0;
  const hud = {
    score: document.getElementById('score'),
    level: document.getElementById('level'),
    lives: document.getElementById('lives'),
    heat: document.getElementById('heatMeter'),
    boost: document.getElementById('boostMeter'),
    panelStart: document.getElementById('panelStart'),
    panelPause: document.getElementById('panelPause'),
    panelOver: document.getElementById('panelGameOver'),
    center: document.getElementById('center'),
    final: document.getElementById('finalScore'),
  };

  function setLives(n){ hud.lives.innerHTML=''; for(let i=0;i<Math.max(0,n);i++){ const d=document.createElement('div'); d.className='life'; hud.lives.appendChild(d) } }

  function wrap(o){ if(o.x<0) o.x+=W; if(o.x>W) o.x-=W; if(o.y<0) o.y+=H; if(o.y>H) o.y-=H }

  function removeEntity(arr, item){ const i=arr.indexOf(item); if(i>=0) arr.splice(i,1) }

  function emitExplosion(x,y,color){ for(let i=0;i<36;i++) particles.push(new Particle(x+rand(-2,2), y+rand(-2,2), color, rand(0.4,1.0), randi(2,4))) }

  function spawnAsteroidField(n=5){
    for(let i=0;i<n;i++){
      let x,y; do{ x=rand(0,W); y=rand(0,H) } while(player && Math.hypot(x-player.x,y-player.y)<180);
      asteroids.push(new Asteroid(x,y, randi(2,4)));
    }
  }

  function spawnEnemy(){ let x,y; const edge = randi(0,4); if(edge===0){x=0;y=rand(0,H)} else if(edge===1){x=W;y=rand(0,H)} else if(edge===2){x=rand(0,W);y=0} else {x=rand(0,W);y=H} enemies.push(new Ship(x,y,true)); }

  function newGame(){ bullets.length=0; particles.length=0; asteroids.length=0; enemies.length=0; score=0; level=1; lives=3; setLives(lives); player=new Ship(W/2,H/2,false); player.inv=2; spawnAsteroidField(6); spawnEnemy(); running=true; paused=false; hud.panelStart.classList.add('hidden'); hud.panelPause.classList.add('hidden'); hud.panelOver.classList.add('hidden'); document.body.requestPointerLock?.(); }

  function gameOver(){ running=false; paused=false; releasePointer(); const best = Math.max(+localStorage.getItem('asteroid-ace-best')||0, score); localStorage.setItem('asteroid-ace-best', best); hud.final.textContent = `Score: ${score} ‚Äî Best: ${best}`; hud.panelOver.classList.remove('hidden') }

  function releasePointer(){ if(document.pointerLockElement) document.exitPointerLock?.() }

  // ===== Collisions and scoring =====
  function handleCollisions(){
    // bullets vs asteroids/enemies
    for(const b of bullets){ if(b.life<=0) continue; if(b.friendly){
        for(const a of asteroids){ if(dist2(b,a) < (a.r+b.r)*(a.r+b.r)){ b.life=0; score+=Math.round(20*a.size); AudioSys.explode(0.18); emitExplosion(b.x,b.y,'#bcd7ff'); shake+=0.6; splitAsteroid(a); break } }
        for(const e of enemies){ if(dist2(b,e) < (e.r+b.r)*(e.r+b.r)){ b.life=0; e.hit(1.2) } }
      } else { // enemy bullet
        if(player && dist2(b,player) < (player.r+b.r)*(player.r+b.r)){ b.life=0; player.hit(1) }
      }
    }
    // player vs asteroids
    if(player){ for(const a of asteroids){ if(dist2(player,a) < (a.r+player.r)*(a.r+player.r)){ player.hit(1.4); // nudge away
          const ang=Math.atan2(player.y-a.y, player.x-a.x); player.vx+=Math.cos(ang)*180; player.vy+=Math.sin(ang)*180; }
      }
    }
  }

  function splitAsteroid(a){ removeEntity(asteroids,a); if(a.size>1){ const parts = randi(2,3); for(let i=0;i<parts;i++){ const na = new Asteroid(a.x + rand(-8,8), a.y + rand(-8,8), a.size-1); na.vx += rand(-60,60); na.vy += rand(-60,60); asteroids.push(na) } } else { if(Math.random()<0.12) spawnPowerUp(a.x, a.y) } }

  function spawnPowerUp(x,y){ const t = Math.random(); const type = t<0.5? 'energy' : (t<0.8? 'heal' : 'cool'); powerups.push({x,y,type, life:12}); }

  const powerups=[];
  function drawPowerups(dt){ for(let i=powerups.length-1;i>=0;i--){ const p=powerups[i]; p.life-=dt; const s=12; ctx.save(); ctx.translate(p.x,p.y); const pulse=1+Math.sin(perf*6+p.x*.02)*0.15; ctx.scale(pulse,pulse);
      if(p.type==='energy'){ ctx.fillStyle='#7bfd9a' } else if(p.type==='heal'){ ctx.fillStyle='#9ce5ff' } else { ctx.fillStyle='#ffd166' }
      ctx.beginPath(); ctx.arc(0,0,s,0,TAU); ctx.fill(); ctx.strokeStyle='rgba(255,255,255,.7)'; ctx.stroke(); ctx.restore();
      if(player && dist2(player,p)<(player.r+s)*(player.r+s)){ if(p.type==='energy') player.energy = Math.min(100, player.energy+55); else if(p.type==='heal') { player.inv=1; lives=Math.min(5,lives+1); setLives(lives); } else { player.heat = Math.max(0, player.heat-60) } removeEntity(powerups,p); AudioSys.click(660,0.08,'sine',0.25) }
      if(p.life<=0) removeEntity(powerups,p);
    } }

  // ===== Main Loop =====
  let last=0; function loop(t){ const now=t/1000; const dt=Math.min(0.033, now-last||0.016); last=now; perf=now;
    ctx.setTransform(DPR,0,0,DPR,0,0); // ensure crispness
    // screen shake
    const sx = (Math.random()-0.5)*shake*3, sy=(Math.random()-0.5)*shake*3; ctx.translate(sx,sy); shake=Math.max(0,shake - dt*2.8);

    // background
    drawStars(player?player.x:0, player?player.y:0);

    if(running && !paused){
      // updates
      player && player.update(dt);
      for(const e of enemies) e.update(dt);
      for(const a of asteroids) a.update(dt);
      for(const b of bullets) b.update(dt);
      for(const p of particles) p.update(dt);

      // clear expired
      bullets = bullets.filter(b=>b.life>0);
      particles = particles.filter(p=>p.life>0);

      // collisions
      handleCollisions();

      // wave management
      if(asteroids.length===0){ level++; hud.level.textContent=level; spawnAsteroidField(6+level); if(level%2===0) spawnEnemy(); score+=150 }
    }

    // draw
    for(const a of asteroids) a.draw();
    drawPowerups(dt);
    for(const b of bullets) b.draw();
    for(const e of enemies) e.draw();
    player && player.draw();
    for(const p of particles) p.draw();

    // HUD updates
    hud.score.textContent = score|0; hud.heat.style.setProperty('--val', clamp(player?player.heat:0,0,100)); hud.boost.style.setProperty('--val', clamp(player?player.energy:0,0,100));

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ===== Controls: UI buttons & keys =====
  const btnStart=document.getElementById('btnStart');
  const btnMute = document.getElementById('btnMute');
  const btnResume=document.getElementById('btnResume');
  const btnRestart=document.getElementById('btnRestart');
  const btnAgain=document.getElementById('btnAgain');
  const btnMenu=document.getElementById('btnMenu');

  function showStart(){ hud.panelStart.classList.remove('hidden'); hud.panelPause.classList.add('hidden'); hud.panelOver.classList.add('hidden'); releasePointer(); }

  btnStart.addEventListener('click', ()=>{ newGame() });
  btnMute.addEventListener('click', ()=>{ AudioSys.setMute(!AudioSys.muted); btnMute.textContent = AudioSys.muted? 'Unmute':'Mute' });
  btnResume.addEventListener('click', ()=>{ paused=false; hud.panelPause.classList.add('hidden') });
  btnRestart.addEventListener('click', ()=>{ newGame() });
  btnAgain.addEventListener('click', ()=>{ newGame() });
  btnMenu.addEventListener('click', ()=>{ showStart() });

  window.addEventListener('keydown', (e)=>{
    if(!running && (e.code==='Space' || e.code==='Enter')){ newGame(); }
    if(e.code==='KeyP'){ if(running){ paused=!paused; hud.panelPause.classList.toggle('hidden', !paused); if(paused) releasePointer(); else document.body.requestPointerLock?.(); } }
    if(e.code==='KeyR'){ newGame(); }
    if(e.code==='KeyM'){ AudioSys.setMute(!AudioSys.muted); btnMute.textContent = AudioSys.muted? 'Unmute':'Mute' }
  });

  // ===== Initial lives and welcome =====
  setLives(lives);
})();
</script>
</body>
</html>
