<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Happy Holidays! ‚Äî Kids‚Äô Interactive Card</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;800&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --sky-top:#7cc7ff;
      --sky-mid:#b7e4ff;
      --sky-bottom:#eaf6ff;
      --panel:#ffffff;
      --ink:#17324a;
      --accent:#ff3e7f;
      --accent-2:#00c2b8;
      --gold:#ffd166;
      --pine:#0b7b63;
      --shadow:rgba(0,0,0,.18);
      --soft-shadow:0 10px 30px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      font-family:'Nunito', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 70% -10%, #ffffff66, transparent), linear-gradient(180deg,var(--sky-top) 0%, var(--sky-mid) 40%, var(--sky-bottom) 100%);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      overflow-x:hidden;
    }
    .app{
      max-width:1200px; margin:18px auto 28px; padding:0 14px;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:10px;
    }
    .title{
      font: 800 40px/1 'Baloo 2', cursive; letter-spacing:.5px; color:#0e2a42; display:flex; align-items:center; gap:14px;
      text-shadow:0 2px 0 #fff, 0 6px 22px rgba(0,0,0,.25);
    }
    .title .spark{font-size:30px}
    .sub{
      margin-top:-6px; font-weight:700; color:#0e2a42cc;
    }

    .workspace{
      display:grid; grid-template-columns: 1fr 320px; gap:16px;
    }

    /* Card (stage) */
    .card-wrap{position:relative}
    .card{
      position:relative; height:64vh; min-height:520px; max-height:720px; border-radius:22px; overflow:hidden; background:linear-gradient(180deg, #c6e9ff 0%, #ecf8ff 60%, #f8fbff 100%);
      box-shadow: var(--soft-shadow);
      border: 6px solid #ffffffc9;
    }
    .card::before{ /* distant mountains */
      content:""; position:absolute; inset:0; background:
        radial-gradient(1200px 400px at 20% 0%, #ffffff 0%, transparent 60%),
        radial-gradient(900px 300px at 80% 10%, #ffffff 0%, transparent 60%),
        linear-gradient(180deg, transparent 60%, #e9f6ff 60%);
      pointer-events:none;
    }
    .ground{ position:absolute; inset:auto 0 0 0; height:35%; background:linear-gradient(180deg,#f6fbff 0%, #ffffff 55%); border-top-left-radius:28px; border-top-right-radius:28px; box-shadow: 0 -6px 20px rgba(0,0,0,.06) inset }

    .greeting{ position:absolute; inset:20px 20px auto 20px; text-align:center; width:calc(100% - 40px); pointer-events:none; }
    .greeting h1{ font:800 56px/1.05 'Baloo 2', cursive; color:#0c2a42; margin:0; letter-spacing:.5px; }
    .greeting h1 .heart{ color:var(--accent); filter:drop-shadow(0 4px 0 #fff) }
    .greeting p{ margin:8px 0 0; font-weight:800; color:#0c2a4290 }

    /* Trees on horizon */
    .pines{ position:absolute; left:0; right:0; bottom:26%; height:120px; pointer-events:none; opacity:.9 }
    .pines .tree{ position:absolute; bottom:0; width:0; height:0; border-left: 28px solid transparent; border-right:28px solid transparent; border-bottom:64px solid #0c7e67; filter: drop-shadow(0 6px 0 #fff) drop-shadow(0 12px 18px rgba(0,0,0,.12)); }
    .pines .tree::after{content:""; position:absolute; left:-18px; bottom:-10px; width:36px; height:12px; background:#8c5c36; border-radius:3px}

    /* Layers */
    #stickers-layer{ position:absolute; inset:0; }
    #effects-layer{ position:absolute; inset:0; pointer-events:none; }
    canvas.snow{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }

    /* Palette */
    .panel{background:var(--panel); border-radius:22px; padding:14px 14px 16px; box-shadow:var(--soft-shadow); border:1px solid #ffffffdd}
    .panel h3{font:800 20px/1 'Baloo 2', cursive; margin:2px 2px 8px; color:#0e2a42}

    .palette{ display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; max-height: calc(64vh - 96px); overflow:auto; padding-right:4px }
    .template{ display:flex; align-items:center; justify-content:center; font-size:34px; border-radius:16px; height:64px; background:#fff; border:2px solid #f0f4ff; cursor:grab; position:relative; user-select:none; transition:.15s transform; box-shadow:0 6px 14px rgba(0,0,0,.08); }
    .template:active{ transform:scale(.96) }
    .template .label{ position:absolute; bottom:4px; left:6px; right:6px; font-size:10px; text-align:center; color:#436; opacity:.7; letter-spacing:.2px }

    /* Toolbar */
    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .btn{ appearance:none; border:none; border-radius:999px; padding:10px 14px; font-weight:800; background:#fff; color:#0e2a42; box-shadow:0 6px 14px rgba(0,0,0,.1); cursor:pointer; transition:.15s transform; }
    .btn.small{ padding:8px 11px; font-size:14px }
    .btn:active{ transform:translateY(1px) }
    .btn.toggle[aria-pressed="true"]{ background:linear-gradient(180deg, #ffe7f1, #ffffff); outline:3px solid #ffd2e5 }
    .btn.accent{ background:linear-gradient(180deg, #fef0f5, #ffffff); outline:3px solid #ffd3e4; color:#b11755 }
    .btn.green{ background:linear-gradient(180deg, #ebfff8, #ffffff); outline:3px solid #bff4e7; color:#0b7b63 }

    /* Stickers */
    .sticker{ position:absolute; transform-origin:center; font-size:64px; line-height:1; cursor:grab; user-select:none; touch-action:none; filter: drop-shadow(0 16px 18px rgba(0,0,0,.18)); will-change:transform; }
    .sticker .emoji{ display:inline-block; transform:translateZ(0); text-shadow:
      0 0 0 #fff,
      0 2px 0 #fff, 2px 0 0 #fff, -2px 0 0 #fff, 0 -2px 0 #fff,
      2px 2px 0 #fff, -2px -2px 0 #fff, -2px 2px 0 #fff, 2px -2px 0 #fff;
    }
    .sticker.pop-in{ animation:pop .35s ease-out }
    @keyframes pop{ 0%{ transform:scale(.2) rotate(-10deg); opacity:.0 } 70%{ transform:scale(1.1) rotate(4deg); opacity:1 } 100%{ transform:scale(1) rotate(0) } }
    .sticker.selected{ filter: drop-shadow(0 0 0 #fff) drop-shadow(0 20px 20px rgba(0,0,0,.2)); z-index:999 }

    /* Floating toolbox for selected sticker */
    .floating-tools{ position:absolute; display:flex; gap:8px; padding:8px; background:#ffffffea; border:2px solid #fff; border-radius:999px; box-shadow:var(--soft-shadow); z-index:1000 }
    .floating-tools button{ width:36px; height:36px; border-radius:999px; border:none; background:#fff; font-size:16px; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.12) }

    /* Sparkles + Confetti */
    .sparkle{ position:absolute; font-size:18px; animation:spark 700ms ease-out forwards; pointer-events:none; }
    @keyframes spark{ 0%{opacity:0; transform:translate(-50%,-50%) scale(.2)} 30%{opacity:1} 100%{opacity:0; transform:translate(-50%,-120%) rotate(20deg) scale(1.2)} }

    .confetti{ position:absolute; width:10px; height:10px; border-radius:2px; transform:translate(-50%,-50%); animation:boom 900ms ease-out forwards; pointer-events:none; }
    @keyframes boom{ 0%{opacity:1} 100%{opacity:0; transform:translate(var(--dx), var(--dy)) rotate(420deg)} }

    /* Toast */
    .toast{ position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#081b2b; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:var(--soft-shadow); opacity:0; pointer-events:none }
    .toast.show{ animation:toast 2.4s ease-out forwards }
    @keyframes toast{ 0%{opacity:0; transform:translateX(-50%) translateY(10px)} 10%,85%{opacity:1; transform:translateX(-50%)} 100%{opacity:0; transform:translateX(-50%) translateY(10px)} }

    /* Hints */
    .hint{ font-size:12px; color:#0e2a4288; margin-left:6px }

    /* Mobile */
    @media (max-width: 980px){
      .workspace{ grid-template-columns: 1fr; gap:14px }
      .card{ height:66vh }
      .palette{ grid-template-columns: repeat(7, 1fr); max-height: none; }
    }

    @media (prefers-reduced-motion: reduce){
      .sticker.pop-in{ animation:none }
      .sparkle,.confetti{ display:none }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="brand">
      <div>
        <div class="title"><span class="spark">‚ùÑÔ∏è</span> Happy Holidays! <span class="spark">‚ú®</span></div>
        <div class="sub">Make a cozy card ‚Äî drag stickers, add snow, and save!</div>
      </div>
      <div class="toolbar">
        <button id="toggleSnow" class="btn toggle" aria-pressed="true">üå®Ô∏è Snow: On</button>
        <button id="toggleMusic" class="btn toggle accent" aria-pressed="false">üéµ Music: Off</button>
        <button id="clearBtn" class="btn">üßπ Clear</button>
        <button id="saveBtn" class="btn green">üì∏ Save Image</button>
      </div>
    </div>

    <div class="workspace">
      <div class="card-wrap">
        <div id="stage" class="card" role="img" aria-label="Holiday card crafting area">
          <canvas id="snow" class="snow" aria-hidden="true"></canvas>
          <div id="effects-layer" aria-hidden="true"></div>
          <div id="stickers-layer" aria-live="polite"></div>
          <div class="greeting" id="greeting">
            <h1>Happy Holidays <span class="heart">‚ù§</span></h1>
            <p>Drag cute stickers from the palette! Tap a sticker for tools.</p>
          </div>
          <div class="pines" aria-hidden="true">
            <i class="tree" style="left:4%"></i>
            <i class="tree" style="left:12%; transform:scale(1.2)"></i>
            <i class="tree" style="left:22%; transform:scale(.85)"></i>
            <i class="tree" style="left:35%; transform:scale(1.3)"></i>
            <i class="tree" style="left:58%; transform:scale(1.05)"></i>
            <i class="tree" style="left:72%; transform:scale(1.4)"></i>
            <i class="tree" style="left:86%; transform:scale(.9)"></i>
          </div>
          <div class="ground" aria-hidden="true"></div>
        </div>
      </div>

      <div class="panel">
        <h3>Sticker Palette <span class="hint">(drag or tap)</span></h3>
        <div id="palette" class="palette" aria-label="Sticker palette grid"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved to your device!</div>

  <!-- External helper for exporting as image (allowed CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
  ;(() => {
    const stage = document.getElementById('stage');
    const stickersLayer = document.getElementById('stickers-layer');
    const effectsLayer = document.getElementById('effects-layer');
    const palette = document.getElementById('palette');
    const toggleSnowBtn = document.getElementById('toggleSnow');
    const toggleMusicBtn = document.getElementById('toggleMusic');
    const clearBtn = document.getElementById('clearBtn');
    const saveBtn = document.getElementById('saveBtn');
    const toastEl = document.getElementById('toast');

    /* -------------------- Stickers -------------------- */
    const STICKERS = [
      {label:'Tree', ch:'üéÑ'}, {label:'Snowman', ch:'‚õÑ'}, {label:'Santa', ch:'üéÖ'},
      {label:'Reindeer', ch:'ü¶å'}, {label:'Elf', ch:'üßù‚Äç‚ôÇÔ∏è'}, {label:'Penguin', ch:'üêß'},
      {label:'Polar Bear', ch:'üêª'}, {label:'Gift', ch:'üéÅ'}, {label:'Bell', ch:'üîî'},
      {label:'Star', ch:'‚≠ê'}, {label:'Snowflake', ch:'‚ùÑÔ∏è'}, {label:'Candy', ch:'üç¨'},
      {label:'Lollipop', ch:'üç≠'}, {label:'Cookie', ch:'üç™'}, {label:'Chocolate', ch:'üç´'},
      {label:'Mittens', ch:'üß§'}, {label:'Scarf', ch:'üß£'}, {label:'Sleigh', ch:'üõ∑'},
      {label:'Holly', ch:'üåø'}, {label:'Pine', ch:'üå≤'}, {label:'Candle', ch:'üïØÔ∏è'},
      {label:'Heart', ch:'‚ù§Ô∏è'}, {label:'Sparkles', ch:'‚ú®'}, {label:'Fox', ch:'ü¶ä'},
      {label:'Unicorn', ch:'ü¶Ñ'}, {label:'Llama', ch:'ü¶ô'}
    ];

    function buildPalette(){
      STICKERS.forEach(s => {
        const t = document.createElement('button');
        t.className = 'template';
        t.setAttribute('aria-label', s.label);
        t.title = s.label;
        t.innerHTML = `<span style=\"transform:translateY(-2px)\">${s.ch}</span><span class=\"label\">${s.label}</span>`;
        t.addEventListener('pointerdown', e => spawnFromTemplate(s, e));
        t.addEventListener('click', e => spawnFromTemplate(s, e, true));
        palette.appendChild(t);
      });
    }

    function createSticker(content, opts={}){
      const el = document.createElement('div');
      el.className = 'sticker pop-in';
      el.innerHTML = `<span class=\"emoji\">${content}</span>`;
      el.dataset.scale = (opts.scale ?? 1).toString();
      el.dataset.rot = (opts.rot ?? 0).toString();
      el.style.left = (opts.x ?? 60) + 'px';
      el.style.top  = (opts.y ?? 60) + 'px';
      applyTransform(el);

      el.addEventListener('pointerdown', pointerDownSticker);
      el.addEventListener('click', () => { selectSticker(el); playBell(1180, .08, .14); sparkleAtCenter(el) });

      stickersLayer.appendChild(el);
      raise(el);
      return el;
    }

    function spawnFromTemplate(s, e, quick=false){
      const rect = stage.getBoundingClientRect();
      const x = (e.clientX||rect.left + rect.width*0.5) - rect.left;
      const y = (e.clientY||rect.top + rect.height*0.55) - rect.top;
      const st = createSticker(s.ch, {x:x-24, y:y-24, scale:1});
      if(!quick){ beginDrag(st, e); }
      pop(); sparkle(x,y);
      if(s.ch==='üéÅ') confetti(x,y);
    }

    function applyTransform(el){
      const s = clamp(parseFloat(el.dataset.scale||'1'), .5, 2.2);
      const r = parseFloat(el.dataset.rot||'0');
      el.style.transform = `translateZ(0) scale(${s}) rotate(${r}deg)`;
    }

    function raise(el){
      const max = Array.from(stickersLayer.children).reduce((m,c)=>Math.max(m, +c.style.zIndex||0), 0);
      el.style.zIndex = String(max+1);
    }

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    /* -------------------- Dragging -------------------- */
    let dragging = null; // {el, ox, oy}

    function pointerDownSticker(e){
      if(e.button===1 || e.button===2) return;
      beginDrag(e.currentTarget, e);
    }

    function beginDrag(el, e){
      selectSticker(el);
      const r = el.getBoundingClientRect();
      const sr = stage.getBoundingClientRect();
      dragging = { el, ox: e.clientX - r.left, oy: e.clientY - r.top, limit:{
        minX: sr.left, minY: sr.top, maxX: sr.right, maxY: sr.bottom
      }};
      el.setPointerCapture(e.pointerId);
      el.style.cursor='grabbing';
      window.addEventListener('pointermove', onPointerMove);
      window.addEventListener('pointerup',   onPointerUp, {once:true});
    }

    function onPointerMove(e){
      if(!dragging) return;
      const {el, ox, oy, limit} = dragging;
      const x = clamp(e.clientX - ox, limit.minX, limit.maxX - el.offsetWidth);
      const y = clamp(e.clientY - oy, limit.minY, limit.maxY - el.offsetHeight);
      el.style.left = (x - limit.minX) + 'px';
      el.style.top  = (y - limit.minY) + 'px';
    }

    function onPointerUp(e){
      if(!dragging) return; 
      dragging.el.releasePointerCapture(e.pointerId);
      dragging.el.style.cursor='grab';
      dragging = null; pop();
    }

    /* -------------------- Floating Tools -------------------- */
    let selected = null;
    const toolbox = document.createElement('div');
    toolbox.className = 'floating-tools';
    toolbox.style.display = 'none';
    toolbox.innerHTML = `
      <button data-act=\"rot-\">‚ü≤</button>
      <button data-act=\"rot+\">‚ü≥</button>
      <button data-act=\"big\">Ôºã</button>
      <button data-act=\"small\">Ôºç</button>
      <button data-act=\"dup\">‚ßâ</button>
      <button data-act=\"del\">‚úñ</button>
    `;
    stage.appendChild(toolbox);

    toolbox.addEventListener('click', e => {
      const btn = e.target.closest('button'); if(!btn || !selected) return;
      const act = btn.dataset.act;
      if(act==='rot-') selected.dataset.rot = (parseFloat(selected.dataset.rot||'0') - 15).toString();
      if(act==='rot+') selected.dataset.rot = (parseFloat(selected.dataset.rot||'0') + 15).toString();
      if(act==='big')  selected.dataset.scale = (parseFloat(selected.dataset.scale||'1') + .1).toString();
      if(act==='small')selected.dataset.scale = (parseFloat(selected.dataset.scale||'1') - .1).toString();
      if(act==='dup')  { const r = selected.getBoundingClientRect(); const sr=stage.getBoundingClientRect(); const c = createSticker(selected.textContent.trim(), {x:r.left-sr.left+24, y:r.top-sr.top+24, scale:parseFloat(selected.dataset.scale||'1'), rot:parseFloat(selected.dataset.rot||'0')}); raise(c); pop(); }
      if(act==='del')  { const x = selected.offsetLeft + selected.offsetWidth/2; const y = selected.offsetTop + selected.offsetHeight/2; whoosh(); confetti(x,y); selected.remove(); selected=null; hideTools(); return; }
      applyTransform(selected); pop();
      positionTools();
    });

    function selectSticker(el){
      if(selected===el) { positionTools(); return; }
      Array.from(stickersLayer.children).forEach(c=>c.classList.remove('selected'));
      selected = el; if(!el) { hideTools(); return; }
      el.classList.add('selected'); raise(el); positionTools();
    }

    function hideTools(){ toolbox.style.display='none'; }

    function positionTools(){
      if(!selected){ hideTools(); return; }
      const r = selected.getBoundingClientRect();
      const sr = stage.getBoundingClientRect();
      toolbox.style.left = Math.min(sr.width- toolbox.offsetWidth - 8, Math.max(8, (r.left - sr.left) + r.width/2 - toolbox.offsetWidth/2)) + 'px';
      toolbox.style.top  = Math.max(8, (r.top - sr.top) - toolbox.offsetHeight - 8) + 'px';
      toolbox.style.display='flex';
    }

    window.addEventListener('resize', positionTools);
    stage.addEventListener('pointerdown', e => { if(e.target===stage) { selected=null; hideTools(); }});

    /* -------------------- Effects -------------------- */
    function sparkle(x,y){
      const s = document.createElement('div');
      s.className='sparkle'; s.textContent='‚ú®';
      s.style.left=x+'px'; s.style.top=y+'px';
      effectsLayer.appendChild(s); setTimeout(()=>s.remove(), 800);
    }
    function sparkleAtCenter(el){
      const r = el.getBoundingClientRect(); const sr=stage.getBoundingClientRect();
      sparkle(r.left - sr.left + r.width/2, r.top - sr.top + r.height/2);
    }

    function confetti(x,y){
      for(let i=0;i<28;i++){
        const c = document.createElement('div'); c.className='confetti';
        const colors = ['#ff3e7f','#00c2b8','#ffd166','#6a5cff','#00d26a','#ff8a00'];
        c.style.background=colors[i%colors.length];
        const dx = (Math.random()*160-80)+'px';
        const dy = (Math.random()*160-80)+'px';
        c.style.setProperty('--dx', dx); c.style.setProperty('--dy', dy);
        c.style.left=x+'px'; c.style.top=y+'px'; effectsLayer.appendChild(c);
        setTimeout(()=>c.remove(), 920);
      }
    }

    /* -------------------- Audio -------------------- */
    const Audio = {
      ctx: null,
      ensure(){ if(!this.ctx) { this.ctx = new (window.AudioContext||window.webkitAudioContext)(); } },
      now(){ return this.ctx ? this.ctx.currentTime : 0 }
    };

    function envGain(t, a=.005, d=.12, s=.0, r=.15, p=.8){
      const g = Audio.ctx.createGain(); g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(p, t+a);
      g.gain.linearRampToValueAtTime(s, t+a+d);
      g.gain.exponentialRampToValueAtTime(0.0001, t+a+d+r);
      return g;
    }

    function osc(type='sine', f=440){ const o = Audio.ctx.createOscillator(); o.type=type; o.frequency.value=f; return o; }

    function pop(){
      try{
        Audio.ensure(); const t=Audio.now()+.001;
        const o=osc('sine', 220); const g=envGain(t, .002, .05, .0, .08, .6);
        o.frequency.setValueAtTime(320, t);
        o.frequency.exponentialRampToValueAtTime(120, t+.08);
        o.connect(g).connect(Audio.ctx.destination); o.start(t); o.stop(t+.2);
      }catch{}
    }

    function playBell(freq=880, a=.008, r=.35){
      try{
        Audio.ensure(); const t=Audio.now()+.001;
        const base=osc('sine',freq); const o2=osc('sine', freq*2.01); const o3=osc('sine', freq*2.99);
        const g=envGain(t, a, .08, .0001, r, .7);
        base.connect(g); o2.connect(g); o3.connect(g);
        g.connect(Audio.ctx.destination);
        base.start(t); o2.start(t); o3.start(t); [base,o2,o3].forEach(o=>o.stop(t+a+.1+r+.02));
      }catch{}
    }

    function whoosh(){
      try{
        Audio.ensure(); const t=Audio.now()+.001; const o=osc('triangle', 180);
        o.frequency.exponentialRampToValueAtTime(40, t+.4);
        const g=envGain(t,.01,.2,.0001,.45,.5); o.connect(g).connect(Audio.ctx.destination);
        o.start(t); o.stop(t+.6);
      }catch{}
    }

    // tiny looping melody (jingle-like)
    let musicTimer = null; let musicOn=false;
    const melody = [
      // midi, dur(s)
      [76,.28],[76,.28],[76,.56],[76,.28],[76,.28],[76,.56],[76,.28],[79,.28],[72,.28],[74,.28],[76,.9],
      [77,.28],[77,.28],[77,.42],[77,.28],[77,.28],[76,.28],[76,.28],[76,.28],[79,.28],[79,.28],[77,.42],[74,1.0]
    ];

    function midiToFreq(m){ return 440 * Math.pow(2,(m-69)/12); }

    function startMusic(){
      if(musicTimer||musicOn) return; Audio.ensure(); musicOn=true;
      let i=0; const playNext = () => {
        if(!musicOn){ return; }
        const [m,d] = melody[i%melody.length]; playBell(midiToFreq(m), .006, .22);
        i++; musicTimer = setTimeout(playNext, d*820);
      }; playNext();
    }
    function stopMusic(){ musicOn=false; clearTimeout(musicTimer); musicTimer=null; }

    /* -------------------- Snow (Canvas) -------------------- */
    const snow = document.getElementById('snow');
    const sctx = snow.getContext('2d');
    let flakes = []; let snowActive = true; let snowRAF=null;

    function sizeCanvas(){ const r = stage.getBoundingClientRect(); snow.width=r.width; snow.height=r.height; }

    function spawnFlakes(){
      const count = Math.floor(snow.width * snow.height / 12000); // density
      flakes = new Array(count).fill(0).map(()=>({
        x: Math.random()*snow.width,
        y: Math.random()*snow.height,
        r: Math.random()*2 + .6,
        s: Math.random()*0.6 + 0.3,
        w: Math.random()*0.8 + 0.2
      }));
    }

    function loopSnow(){
      if(!snowActive) { sctx.clearRect(0,0,snow.width,snow.height); return; }
      sctx.clearRect(0,0,snow.width,snow.height);
      sctx.fillStyle='rgba(255,255,255,.95)';
      flakes.forEach(f=>{
        f.y += f.s; f.x += Math.sin(f.y*.015)*f.w*.2;
        if(f.y>snow.height+6){ f.y=-6; f.x=Math.random()*snow.width; }
        sctx.beginPath(); sctx.arc(f.x,f.y,f.r,0,Math.PI*2); sctx.fill();
      });
      snowRAF = requestAnimationFrame(loopSnow);
    }

    function initSnow(){ sizeCanvas(); spawnFlakes(); cancelAnimationFrame(snowRAF); loopSnow(); }
    window.addEventListener('resize', ()=>{ sizeCanvas(); spawnFlakes(); });

    /* -------------------- Controls -------------------- */
    toggleSnowBtn.addEventListener('click', () => {
      snowActive = !snowActive; toggleSnowBtn.setAttribute('aria-pressed', snowActive? 'true':'false');
      toggleSnowBtn.textContent = (snowActive? 'üå®Ô∏è Snow: On' : 'üå®Ô∏è Snow: Off');
      if(snowActive){ loopSnow(); pop(); } else { cancelAnimationFrame(snowRAF); sctx.clearRect(0,0,snow.width,snow.height); }
    });

    toggleMusicBtn.addEventListener('click', () => {
      const isOn = toggleMusicBtn.getAttribute('aria-pressed')==='true';
      if(isOn){ stopMusic(); toggleMusicBtn.setAttribute('aria-pressed','false'); toggleMusicBtn.textContent='üéµ Music: Off'; }
      else { startMusic(); toggleMusicBtn.setAttribute('aria-pressed','true'); toggleMusicBtn.textContent='üéµ Music: On'; }
      pop();
    });

    clearBtn.addEventListener('click', () => {
      stickersLayer.innerHTML=''; hideTools(); whoosh();
    });

    saveBtn.addEventListener('click', async () => {
      try{
        hideTools(); const greet = document.getElementById('greeting');
        greet.style.opacity = '1'; // visible on export
        const oldSnow = snow.style.display; snow.style.display='none';
        const canvas = await html2canvas(stage, {backgroundColor:null, scale:2});
        snow.style.display=oldSnow;
        const a=document.createElement('a'); a.download='holiday-card.png'; a.href=canvas.toDataURL('image/png'); a.click();
        showToast('Saved to your device!'); playBell(1200,.008,.3);
      }catch(err){ showToast('Save failed ‚Äî try again'); }
    });

    function showToast(msg){ toastEl.textContent=msg; toastEl.classList.remove('show'); void toastEl.offsetWidth; toastEl.classList.add('show'); }

    /* -------------------- Boot -------------------- */
    buildPalette(); initSnow();

    // Pre-place a few cute stickers
    const sr = stage.getBoundingClientRect();
    const defaults = [
      {ch:'üéÑ', x: sr.width*0.22, y: sr.height*0.50, scale:1.25},
      {ch:'‚õÑ', x: sr.width*0.62, y: sr.height*0.48, scale:1.15},
      {ch:'üéÅ', x: sr.width*0.40, y: sr.height*0.63, scale:1.0}
    ];
    defaults.forEach(d=>{ const el=createSticker(d.ch,{x:d.x,y:d.y,scale:d.scale}); if(d.ch==='üéÅ'){ el.addEventListener('click', () => { const r=el.getBoundingClientRect(); const srr=stage.getBoundingClientRect(); confetti(r.left-srr.left + r.width/2, r.top-srr.top + r.height/2); }); } });

  })();
  </script>
</body>
</html>
