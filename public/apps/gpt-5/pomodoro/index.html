<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pomodoro ‚Äî Focus Timer</title>
  <meta name="theme-color" content="#101316" />
  <meta name="description" content="A delightful Pomodoro timer with sessions log, SVG charts, auto-start, sound alerts, and dark mode ‚Äî all in a single file." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d1117;
      --panel: #0f141b;
      --panel-2: #0b0f14;
      --text: #e6edf3;
      --muted: #a9b1ba;
      --accent: #7c3aed; /* purple */
      --accent-2: #06b6d4; /* cyan */
      --good: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --focus: #60a5fa;
      --break: #34d399;
      --long: #f472b6;
      --ring-bg: rgba(255,255,255,0.08);
      --shadow-1: 0 10px 30px rgba(0,0,0,.35);
      --shadow-2: 0 20px 40px rgba(0,0,0,.45);
      --radius: 14px;
      --glass: rgba(255,255,255,0.06);
    }
    html[data-theme="light"] {
      --bg: #f7fafc;
      --panel: #ffffff;
      --panel-2: #f3f6fb;
      --text: #0b1220;
      --muted: #475569;
      --ring-bg: rgba(0,0,0,0.08);
      --shadow-1: 0 8px 20px rgba(0,0,0,.12);
      --shadow-2: 0 16px 28px rgba(0,0,0,.18);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 85% -10%, rgba(124,58,237,.25), transparent 60%),
                  radial-gradient(1200px 800px at -10% 110%, rgba(6,182,212,.25), transparent 60%),
                  var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      letter-spacing: 0.1px;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 28px 20px 32px; }
    header {
      display: flex; align-items: center; justify-content: space-between; gap: 14px; margin-bottom: 18px;
    }
    .brand { display:flex; align-items:center; gap:12px; font-weight: 800; letter-spacing: .3px; }
    .logo {
      width: 38px; height: 38px; border-radius: 10px; display:grid; place-items:center; color:white;
      background: conic-gradient(from 210deg at 50% 50%, var(--accent), var(--accent-2));
      box-shadow: var(--shadow-1);
    }
    .tagline { color: var(--muted); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 1.2px; }

    .controls { display:flex; align-items:center; gap:10px; }
    .btn { appearance:none; border:none; background:var(--panel); color:var(--text); padding:10px 12px; border-radius: 10px; cursor:pointer; font-weight: 600; box-shadow: var(--shadow-1); transition: transform .06s ease, box-shadow .3s ease, background .2s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.ghost { background: transparent; box-shadow: none; color: var(--muted); }
    .btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; }
    .btn.small { padding: 8px 10px; font-size: 13px; }

    main.grid { display:grid; grid-template-columns: 1.1fr .9fr; gap: 16px; align-items: stretch; }
    @media (max-width: 980px) { main.grid { grid-template-columns: 1fr; } }

    .panel { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow-2); }
    .panel .p { padding: 18px; }
    .panel h2 { margin: 0 0 10px; font-size: 16px; letter-spacing: .3px; text-transform: uppercase; color: var(--muted); }

    /* Timer card */
    .timer-card { display:grid; grid-template-rows: auto 1fr auto; min-height: 520px; }
    .ring-wrap { display:grid; place-items:center; padding: 14px 14px 0; }
    .ring { position: relative; width: 320px; height: 320px; }
    .ring svg { filter: drop-shadow(0 6px 22px rgba(0,0,0,.35)); }
    .ring .center {
      position:absolute; inset:0; display:grid; place-items:center; text-align:center;
    }
    .time { font-variant-numeric: tabular-nums; font-size: 54px; font-weight: 800; letter-spacing: 1px; }
    .phase { margin-top: -4px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 2px; font-size: 12px; }

    .timer-actions { display:flex; align-items:center; justify-content:center; gap: 10px; padding: 16px; }
    .chip { background: var(--glass); border: 1px solid rgba(255,255,255,.08); padding: 8px 10px; border-radius: 999px; color: var(--muted); font-size: 12px; font-weight: 600; }

    /* Settings + Stats */
    .settings { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 680px) { .settings { grid-template-columns: 1fr; } }
    .field { background: var(--glass); border: 1px solid rgba(255,255,255,.08); padding: 12px; border-radius: 12px; display:grid; gap:8px; }
    .field label { color: var(--muted); font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; }
    .field-row { display:flex; align-items:center; gap:6px; }
    .field input[type="number"] { width: 100%; background: var(--panel); color: var(--text); border: 1px solid rgba(255,255,255,.08); border-radius: 10px; padding: 10px 12px; font-weight: 700; }
    .field input[type="range"] { width: 100%; }
    .switch { display:flex; align-items:center; gap:10px; }
    .switch input { width: 42px; height: 24px; appearance:none; background: var(--ring-bg); border-radius: 999px; position: relative; outline: none; cursor: pointer; transition: background .2s ease; }
    .switch input:checked { background: linear-gradient(90deg, var(--accent), var(--accent-2)); }
    .switch input::after { content:""; position:absolute; top:3px; left:3px; width:18px; height:18px; background:white; border-radius:999px; transition: transform .2s ease; box-shadow: 0 2px 8px rgba(0,0,0,.35); }
    .switch input:checked::after { transform: translateX(18px); }

    /* Log */
    .log { overflow: auto; max-height: 320px; border-top: 1px dashed rgba(255,255,255,.08); }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 10px 14px; text-align: left; font-size: 13px; }
    th { color: var(--muted); text-transform: uppercase; font-weight: 800; letter-spacing: 1px; font-size: 12px; position: sticky; top: 0; background: linear-gradient(180deg, var(--panel), var(--panel-2)); z-index: 1; }
    tr + tr td { border-top: 1px dashed rgba(255,255,255,.06); }

    /* Charts */
    .charts { display:grid; grid-template-columns: 1.2fr .8fr; gap: 12px; }
    @media (max-width: 980px) { .charts { grid-template-columns: 1fr; } }
    .chart { background: var(--glass); border: 1px solid rgba(255,255,255,.08); border-radius: 12px; padding: 12px; }
    .chart h3 { margin: 0 0 8px; font-size: 13px; text-transform: uppercase; color: var(--muted); letter-spacing: 1px; }
    .legend { display:flex; gap: 10px; margin-top: 6px; flex-wrap: wrap; }
    .legend .k { display:flex; align-items:center; gap:6px; color: var(--muted); font-size: 12px; font-weight: 700; }
    .legend .dot { width: 10px; height: 10px; border-radius: 3px; }

    footer { margin-top: 16px; color: var(--muted); font-size: 12px; display:flex; justify-content: space-between; align-items: center; gap: 10px; }
    .kbd { font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding: 2px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,.18); background: var(--panel); color: var(--text); box-shadow: inset 0 -2px 0 rgba(0,0,0,.2); font-size: 12px; }

    /* Floating sparkles */
    .sparkle { position: absolute; pointer-events:none; opacity:.8; mix-blend-mode: screen; filter: blur(.2px) saturate(1.1); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#fff" stop-opacity=".95"/>
                <stop offset="100%" stop-color="#d7d7ff" stop-opacity=".9"/>
              </linearGradient>
            </defs>
            <path d="M12 2l2.6 5.3 5.9.9-4.2 4.1 1 5.8-5.3-2.8-5.3 2.8 1-5.8-4.2-4.1 5.9-.9L12 2z" fill="url(#g1)"/>
          </svg>
        </div>
        <div>
          <div style="font-size:18px; line-height:1;">Pomodoro</div>
          <div class="tagline">Focus ‚Ä¢ Breathe ‚Ä¢ Ship</div>
        </div>
      </div>
      <div class="controls">
        <button id="themeBtn" class="btn small" title="Toggle theme">üåì Theme</button>
        <button id="exportBtn" class="btn small ghost" title="Export history">‚á© Export</button>
        <button id="clearBtn" class="btn small ghost" title="Clear history">üóë Clear</button>
        <a class="btn primary small" href="#" id="helpBtn" title="Shortcuts">‚åò?</a>
      </div>
    </header>

    <main class="grid">
      <!-- TIMER COLUMN -->
      <section class="panel timer-card">
        <div class="p" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
          <h2>Timer</h2>
          <div class="chip" id="sessionChip">Session 1 ‚Ä¢ Next: Long Break</div>
        </div>
        <div class="ring-wrap">
          <div class="ring">
            <!-- SVG PROGRESS RING -->
            <svg id="progressSvg" width="320" height="320" viewBox="0 0 320 320">
              <defs>
                <linearGradient id="gradFocus" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="#60a5fa"/>
                  <stop offset="100%" stop-color="#7c3aed"/>
                </linearGradient>
                <linearGradient id="gradBreak" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="#34d399"/>
                  <stop offset="100%" stop-color="#06b6d4"/>
                </linearGradient>
                <linearGradient id="gradLong" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="#f472b6"/>
                  <stop offset="100%" stop-color="#f59e0b"/>
                </linearGradient>
              </defs>
              <circle cx="160" cy="160" r="138" stroke="var(--ring-bg)" stroke-width="18" fill="none" />
              <circle cx="160" cy="160" r="138" stroke="var(--ring-bg)" stroke-width="18" fill="none" stroke-dasharray="4 10" opacity=".5" />
              <circle id="ring" cx="160" cy="160" r="138" stroke="url(#gradFocus)" stroke-linecap="round" stroke-width="18" fill="none" transform="rotate(-90 160 160)" stroke-dasharray="867" stroke-dashoffset="867"/>
            </svg>
            <div class="center">
              <div class="time" id="time">25:00</div>
              <div class="phase" id="phase">Focus</div>
            </div>
          </div>
        </div>
        <div class="timer-actions">
          <button id="startPauseBtn" class="btn primary" style="min-width:120px;">‚ñ∂ Start</button>
          <button id="resetBtn" class="btn">‚ü≤ Reset</button>
          <button id="skipBtn" class="btn">‚è≠ Skip</button>
        </div>
        <div class="p">
          <div class="settings">
            <div class="field">
              <label>Durations (minutes)</label>
              <div class="field-row" style="gap:8px;">
                <div style="flex:1">
                  <div style="display:flex; justify-content:space-between; align-items:center; gap:6px; margin-bottom:6px;">
                    <span class="chip" style="background:rgba(96,165,250,.18); border-color:rgba(96,165,250,.28); color:#9ec8ff">Focus</span>
                    <input id="focusInput" type="number" min="1" max="240" value="25"/>
                  </div>
                </div>
                <div style="flex:1">
                  <div style="display:flex; justify-content:space-between; align-items:center; gap:6px; margin-bottom:6px;">
                    <span class="chip" style="background:rgba(52,211,153,.18); border-color:rgba(52,211,153,.28); color:#7ae7bf">Short</span>
                    <input id="shortInput" type="number" min="1" max="120" value="5"/>
                  </div>
                </div>
                <div style="flex:1">
                  <div style="display:flex; justify-content:space-between; align-items:center; gap:6px; margin-bottom:6px;">
                    <span class="chip" style="background:rgba(244,114,182,.2); border-color:rgba(244,114,182,.3); color:#ffb7d9">Long</span>
                    <input id="longInput" type="number" min="1" max="180" value="15"/>
                  </div>
                </div>
              </div>
            </div>
            <div class="field">
              <label>Behavior</label>
              <div class="switch">
                <input id="autoStartToggle" type="checkbox" checked />
                <div>
                  <div style="font-weight:800;">Auto-start next session</div>
                  <div style="color:var(--muted); font-size:12px;">Keep momentum between focus/break.</div>
                </div>
              </div>
              <div class="switch" style="margin-top:10px;">
                <input id="notifyToggle" type="checkbox" />
                <div>
                  <div style="font-weight:800;">Desktop notifications</div>
                  <div style="color:var(--muted); font-size:12px;">Alert when time‚Äôs up.</div>
                </div>
              </div>
              <div class="field-row" style="margin-top:12px;">
                <label for="intervalInput" style="margin-right:8px;">Long break after</label>
                <input id="intervalInput" type="number" min="1" max="12" value="4" style="max-width:80px;"/> <span style="align-self:center; color:var(--muted); font-weight:700;">focus sessions</span>
              </div>
            </div>
            <div class="field">
              <label>Sound</label>
              <div class="field-row">
                <input id="volume" type="range" min="0" max="1" step="0.01" value="0.6"/>
                <button id="testBeep" class="btn small">üîä Test</button>
              </div>
              <div style="color:var(--muted); font-size:12px; margin-top:6px;">Chime plays at end of each session.</div>
            </div>
            <div class="field">
              <label>Quick Tips</label>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <span class="kbd">Space</span> start/pause
                <span class="kbd">S</span> skip
                <span class="kbd">R</span> reset
                <span class="kbd">T</span> theme
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- STATS + LOG COLUMN -->
      <section class="panel" style="display:grid; grid-template-rows:auto auto 1fr;">
        <div class="p">
          <h2>Stats</h2>
          <div class="charts">
            <div class="chart">
              <h3>Last 7 Days ‚Ä¢ Focus Minutes</h3>
              <svg id="barChart" width="100%" viewBox="0 0 480 160" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Weekly focus minutes chart"></svg>
              <div class="legend">
                <div class="k"><span class="dot" style="background: var(--focus);"></span>Focus</div>
              </div>
            </div>
            <div class="chart">
              <h3>Today ‚Ä¢ Timeline</h3>
              <svg id="timeline" width="100%" viewBox="0 0 480 80" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Today sessions timeline"></svg>
              <div class="legend">
                <div class="k"><span class="dot" style="background: var(--focus);"></span>Focus</div>
                <div class="k"><span class="dot" style="background: var(--break);"></span>Short</div>
                <div class="k"><span class="dot" style="background: var(--long);"></span>Long</div>
              </div>
            </div>
          </div>
        </div>
        <div class="p" style="border-top: 1px dashed rgba(255,255,255,.08);">
          <h2>Sessions Log</h2>
          <div class="log">
            <table id="logTable">
              <thead>
                <tr><th>#</th><th>Type</th><th>Start</th><th>End</th><th>Duration</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div>Made with focus and a little sparkle ‚ú®</div>
      <div>Goal idea: 4√ó25 focus, 5 short, 1 long.</div>
    </footer>
  </div>

  <!-- Sparkles -->
  <svg class="sparkle" id="sparkle1" width="120" height="120" viewBox="0 0 120 120" style="top:12%; left:6%;">
    <defs>
      <radialGradient id="sp1" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stop-color="#7c3aed" stop-opacity="1" />
        <stop offset="100%" stop-color="#7c3aed" stop-opacity="0" />
      </radialGradient>
    </defs>
    <circle cx="60" cy="60" r="50" fill="url(#sp1)"/>
  </svg>
  <svg class="sparkle" id="sparkle2" width="160" height="160" viewBox="0 0 160 160" style="bottom:10%; right:8%;">
    <defs>
      <radialGradient id="sp2" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stop-color="#06b6d4" stop-opacity="1" />
        <stop offset="100%" stop-color="#06b6d4" stop-opacity="0" />
      </radialGradient>
    </defs>
    <circle cx="80" cy="80" r="70" fill="url(#sp2)"/>
  </svg>

  <script>
  (function(){
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // Elements
    const timeEl = $('#time');
    const phaseEl = $('#phase');
    const ringEl = $('#ring');
    const progressSvg = $('#progressSvg');
    const startPauseBtn = $('#startPauseBtn');
    const resetBtn = $('#resetBtn');
    const skipBtn = $('#skipBtn');
    const focusInput = $('#focusInput');
    const shortInput = $('#shortInput');
    const longInput = $('#longInput');
    const autoStartToggle = $('#autoStartToggle');
    const notifyToggle = $('#notifyToggle');
    const volumeEl = $('#volume');
    const testBeepBtn = $('#testBeep');
    const intervalInput = $('#intervalInput');
    const logTableBody = $('#logTable tbody');
    const barChart = $('#barChart');
    const timeline = $('#timeline');
    const exportBtn = $('#exportBtn');
    const clearBtn = $('#clearBtn');
    const themeBtn = $('#themeBtn');
    const sessionChip = $('#sessionChip');

    // State
    const STORAGE_KEY = 'pomodoro.settings.v1';
    const LOG_KEY = 'pomodoro.log.v1';

    const Mode = Object.freeze({ Focus:'focus', Short:'short', Long:'long' });
    let state = {
      mode: Mode.Focus,
      targetSec: 25*60,
      remainingSec: 25*60,
      running: false,
      startTs: null,
      tickId: null,
      completedFocus: 0,
      sessionIndex: 1,
    };

    // Settings
    let settings = loadSettings() || {
      focusMin: 25,
      shortMin: 5,
      longMin: 15,
      longInterval: 4,
      autoStart: true,
      volume: 0.6,
      notify: false,
      theme: detectInitialTheme(),
    };

    // Apply settings to UI
    function initUI(){
      focusInput.value = settings.focusMin;
      shortInput.value = settings.shortMin;
      longInput.value = settings.longMin;
      intervalInput.value = settings.longInterval;
      autoStartToggle.checked = settings.autoStart;
      volumeEl.value = settings.volume;
      notifyToggle.checked = settings.notify;

      setTheme(settings.theme);

      state.targetSec = settings.focusMin*60;
      state.remainingSec = state.targetSec;
      drawTime();
      updateRing(0);
      updatePhaseText();
      updateSessionChip();
      buildLogTable();
      buildCharts();
    }

    // THEME
    function detectInitialTheme(){
      // honor saved, otherwise prefers-color-scheme
      try {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (saved && saved.theme) return saved.theme;
      } catch(e){}
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
    }
    function setTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      settings.theme = t;
      saveSettings();
    }

    // TIME HELPERS
    function pad(n){ return String(n).padStart(2,'0'); }
    function fmtDuration(sec){ const m=Math.floor(sec/60), s=sec%60; return `${m}:${pad(s)}`; }
    function fmtClock(ts){ const d=new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
    function todayKey(d=new Date()){
      const z=new Date(d); z.setHours(0,0,0,0); return z.toISOString().slice(0,10);
    }

    // RING DRAW
    const CIRC = 2*Math.PI*138; // stroke length
    function updateRing(progress){
      const off = CIRC*(1-Math.max(0,Math.min(1, progress)));
      ringEl.setAttribute('stroke-dasharray', CIRC);
      ringEl.setAttribute('stroke-dashoffset', off);
      // color by mode
      const grad = state.mode===Mode.Focus? 'url(#gradFocus)' : (state.mode===Mode.Short? 'url(#gradBreak)':'url(#gradLong)');
      ringEl.setAttribute('stroke', grad);
    }

    function drawTime(){ timeEl.textContent = fmtDuration(Math.max(0, Math.floor(state.remainingSec))); }
    function updatePhaseText(){
      phaseEl.textContent = state.mode === Mode.Focus ? 'Focus' : (state.mode===Mode.Short? 'Short Break' : 'Long Break');
    }

    function updateSessionChip(){
      const next = nextMode();
      const nextLabel = next===Mode.Focus? 'Focus' : (next===Mode.Short? 'Short Break':'Long Break');
      sessionChip.textContent = `Session ${state.sessionIndex} ‚Ä¢ Next: ${nextLabel}`;
    }

    function startTimer(){
      if (state.running) return;
      state.running = true;
      startPauseBtn.textContent = '‚è∏ Pause';
      state.startTs = Date.now();
      const endTs = state.startTs + state.remainingSec*1000;
      state.tickId = setInterval(()=>{
        const now = Date.now();
        state.remainingSec = Math.max(0, Math.round((endTs - now)/1000));
        drawTime();
        updateRing(1 - (state.remainingSec/state.targetSec));
        if (state.remainingSec <= 0){
          clearInterval(state.tickId); state.tickId=null; state.running=false;
          completeSession();
        }
      }, 250);
    }

    function pauseTimer(){
      if (!state.running) return;
      state.running=false; startPauseBtn.textContent='‚ñ∂ Start';
      if (state.tickId) clearInterval(state.tickId); state.tickId=null;
    }

    function resetTimer(){
      pauseTimer();
      state.remainingSec = state.targetSec;
      updateRing(0); drawTime();
    }

    function skipTimer(){
      if (state.running) pauseTimer();
      // log partial as skipped
      const elapsed = state.targetSec - state.remainingSec;
      if (elapsed>0) logSession({ type: state.mode, start: Date.now()-elapsed*1000, end: Date.now(), duration: elapsed, skipped: true });
      proceedNext();
    }

    function nextMode(){
      if (state.mode===Mode.Focus){
        const willBe = ((state.completedFocus + 1) % settings.longInterval === 0) ? Mode.Long : Mode.Short;
        return willBe;
      }
      return Mode.Focus;
    }

    function proceedNext(){
      // advance mode/index
      if (state.mode===Mode.Focus){ state.completedFocus++; }
      state.mode = nextMode();
      state.sessionIndex++;
      state.targetSec = (state.mode===Mode.Focus? settings.focusMin : state.mode===Mode.Short? settings.shortMin : settings.longMin) * 60;
      state.remainingSec = state.targetSec;
      updatePhaseText();
      updateSessionChip();
      updateRing(0); drawTime();
      if (settings.autoStart) startTimer(); else startPauseBtn.textContent='‚ñ∂ Start';
    }

    function completeSession(){
      // log full session
      logSession({ type: state.mode, start: state.startTs, end: Date.now(), duration: state.targetSec, skipped: false });
      chime();
      notifyUser(`${phaseEl.textContent} finished`, 'Great job!');
      proceedNext();
    }

    // LOGGING
    function loadLog(){
      try { return JSON.parse(localStorage.getItem(LOG_KEY)) || []; } catch(e) { return []; }
    }
    function saveLog(list){ localStorage.setItem(LOG_KEY, JSON.stringify(list)); }
    function logSession(entry){
      const list = loadLog();
      list.push({ id: cryptoRandomId(), ...entry });
      saveLog(list);
      buildLogTable();
      buildCharts();
    }
    function cryptoRandomId(){
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      return 'id-'+Math.random().toString(36).slice(2);
    }
    function clearLog(){ saveLog([]); buildLogTable(); buildCharts(); }

    function buildLogTable(){
      const rows = loadLog().slice().reverse();
      logTableBody.innerHTML = rows.map((r, idx)=>{
        const i = rows.length - idx;
        const type = r.type===Mode.Focus? '<span style="color:var(--focus); font-weight:800;">Focus</span>' : r.type===Mode.Short? '<span style="color:var(--break); font-weight:800;">Short</span>' : '<span style="color:var(--long); font-weight:800;">Long</span>';
        const dur = fmtDuration(r.duration);
        const s = fmtClock(r.start); const e = fmtClock(r.end);
        const skip = r.skipped? ' <span class="chip" style="margin-left:6px; color:#fda4af;">skipped</span>' : '';
        return `<tr><td>${i}</td><td>${type}${skip}</td><td>${s}</td><td>${e}</td><td>${dur}</td></tr>`;
      }).join('');
    }

    // CHARTS
    function groupByDay(){
      const by = {};
      for (const r of loadLog()){
        const d = new Date(r.start); const key = d.toISOString().slice(0,10);
        if (!by[key]) by[key] = { focus:0, short:0, long:0, items: [] };
        by[key][r.type] += Math.round(r.duration/60);
        by[key].items.push(r);
      }
      return by;
    }

    function buildCharts(){
      // 7-day bar chart (focus minutes)
      const by = groupByDay();
      const days = [];
      for (let i=6;i>=0;i--){
        const d = new Date(); d.setDate(d.getDate()-i); const key = d.toISOString().slice(0,10);
        const val = by[key]?.focus || 0;
        days.push({ key, label: d.toLocaleDateString(undefined, { weekday:'short' }), value: val });
      }
      const max = Math.max(30, ...days.map(d=>d.value));
      const W=480, H=120, pad=28, gap=12; const barW = (W - pad*2 - gap*6)/7;
      let bars = '';
      days.forEach((d, i)=>{
        const h = Math.round((d.value/max)*(H-pad));
        const x = pad + i*(barW+gap);
        const y = (H - pad - h);
        const labelY = H-10;
        bars += `<rect x='${x}' y='${y}' width='${barW}' height='${h}' rx='6' fill='var(--focus)' opacity='0.9'></rect>`+
                `<text x='${x+barW/2}' y='${labelY}' text-anchor='middle' font-size='10' fill='var(--muted)'>${d.label}</text>`+
                `<text x='${x+barW/2}' y='${y-6}' text-anchor='middle' font-size='10' fill='var(--muted)'>${d.value}</text>`;
      });
      barChart.innerHTML = `<rect x='0' y='0' width='480' height='160' fill='transparent'/>
                            <g>${bars}</g>`;

      // Today timeline
      const today = todayKey();
      const items = (groupByDay()[today]?.items || []).sort((a,b)=>a.start-b.start);
      const totalMin = items.reduce((s,r)=> s + Math.max(1, Math.round(r.duration/60)), 0) || 1;
      const TW=480, TH=60, tpad=20; let x=10;
      const scale = (TW-20)/totalMin;
      let segs='';
      for (const r of items){
        const m = Math.max(1, Math.round(r.duration/60));
        const w = Math.max(6, m*scale);
        const color = r.type===Mode.Focus? 'var(--focus)' : r.type===Mode.Short? 'var(--break)' : 'var(--long)';
        segs += `<rect x='${x}' y='${(TH-22)/2}' width='${w}' height='22' rx='6' fill='${color}' opacity='.9'>`+
                `<title>${r.type} ‚Ä¢ ${fmtDuration(r.duration)} (${fmtClock(r.start)} ‚Äì ${fmtClock(r.end)})</title></rect>`;
        x += w + 6;
      }
      if (!items.length){
        segs = `<text x='50%' y='50%' text-anchor='middle' fill='var(--muted)' font-size='12'>No sessions yet ‚Äî start one! ‚ú®</text>`;
      }
      timeline.innerHTML = `<rect x='0' y='0' width='480' height='80' fill='transparent'/>${segs}`;
    }

    // SOUND
    let audioCtx = null;
    function useAudio(){ if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
    function beep(f=880, t=0.12){
      const ctx = useAudio();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = 'sine'; o.frequency.value = f;
      g.gain.value = 0;
      o.connect(g).connect(ctx.destination);
      const now = ctx.currentTime;
      g.gain.linearRampToValueAtTime(settings.volume, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + t);
      o.start(now); o.stop(now + t + 0.01);
    }
    function chime(){
      // 3 pleasant beeps
      setTimeout(()=>beep(740, .12), 0);
      setTimeout(()=>beep(880, .12), 160);
      setTimeout(()=>beep(988, .2), 320);
    }

    // NOTIFICATIONS
    function notifyUser(title, body){
      if (!settings.notify) return;
      if (!('Notification' in window)) return;
      if (Notification.permission === 'granted') {
        new Notification(title, { body });
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(p=>{ if(p==='granted') new Notification(title, { body }); });
      }
    }

    // SETTINGS PERSIST
    function loadSettings(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch(e){ return null; } }
    function saveSettings(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(settings)); }

    // EVENTS
    startPauseBtn.addEventListener('click', ()=>{ state.running ? pauseTimer() : startTimer(); });
    resetBtn.addEventListener('click', resetTimer);
    skipBtn.addEventListener('click', skipTimer);

    focusInput.addEventListener('change', ()=>{ settings.focusMin = clamp(parseInt(focusInput.value||'25'), 1, 240); saveSettings(); if (state.mode===Mode.Focus){ state.targetSec = settings.focusMin*60; state.remainingSec=Math.min(state.remainingSec, state.targetSec); drawTime(); updateRing(1 - state.remainingSec/state.targetSec);} });
    shortInput.addEventListener('change', ()=>{ settings.shortMin = clamp(parseInt(shortInput.value||'5'), 1, 120); saveSettings(); if (state.mode===Mode.Short){ state.targetSec = settings.shortMin*60; state.remainingSec=Math.min(state.remainingSec, state.targetSec); drawTime(); updateRing(1 - state.remainingSec/state.targetSec);} });
    longInput.addEventListener('change', ()=>{ settings.longMin = clamp(parseInt(longInput.value||'15'), 1, 180); saveSettings(); if (state.mode===Mode.Long){ state.targetSec = settings.longMin*60; state.remainingSec=Math.min(state.remainingSec, state.targetSec); drawTime(); updateRing(1 - state.remainingSec/state.targetSec);} });
    intervalInput.addEventListener('change', ()=>{ settings.longInterval = clamp(parseInt(intervalInput.value||'4'), 1, 12); saveSettings(); updateSessionChip(); });

    autoStartToggle.addEventListener('change', ()=>{ settings.autoStart = autoStartToggle.checked; saveSettings(); });
    notifyToggle.addEventListener('change', ()=>{
      settings.notify = notifyToggle.checked; saveSettings(); if (settings.notify) notifyUser('Notifications enabled','We‚Äôll let you know when time is up.');
    });

    volumeEl.addEventListener('input', ()=>{ settings.volume = parseFloat(volumeEl.value); saveSettings(); });
    testBeepBtn.addEventListener('click', ()=>{ chime(); });

    exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(loadLog(), null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = `pomodoro-log-${new Date().toISOString().slice(0,10)}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 2000);
    });
    clearBtn.addEventListener('click', ()=>{
      if (confirm('Clear all session history?')) clearLog();
    });

    themeBtn.addEventListener('click', ()=>{ setTheme(settings.theme==='dark' ? 'light' : 'dark'); });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (e.key===' '){ e.preventDefault(); state.running? pauseTimer() : startTimer(); }
      if (e.key.toLowerCase()==='s'){ e.preventDefault(); skipTimer(); }
      if (e.key.toLowerCase()==='r'){ e.preventDefault(); resetTimer(); }
      if (e.key.toLowerCase()==='t'){ e.preventDefault(); themeBtn.click(); }
    });

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    // Sparkle drift
    function animateSparkles(){
      const s1 = $('#sparkle1'), s2 = $('#sparkle2');
      let t=0; function step(){ t+=0.008; if (s1){ s1.style.transform = `translateY(${Math.sin(t)*6}px)`; } if (s2){ s2.style.transform = `translateY(${Math.cos(t*0.8)*8}px)`; } requestAnimationFrame(step); }
      step();
    }

    // INIT
    initUI();
    animateSparkles();

    // ensure ring circumference is set on load
    updateRing(0);

  })();
  </script>
</body>
</html>
