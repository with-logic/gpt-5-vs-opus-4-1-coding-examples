<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Healthy Meal Tracker</title>
  <meta name="description" content="Log meals, ingredients, calories, and macros with a clean, single‚Äëfile tracker." />
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111737;
      --panel-2: #151c45;
      --text: #eef3ff;
      --muted: #aab3d6;
      --accent: #7ee787;
      --accent-2: #7aa2ff;
      --warn: #ff7b72;
      --card: #0f1533;
      --chip: #1a214f;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 14px;
    }
    .light {
      --bg: #f7f9ff;
      --panel: #ffffff;
      --panel-2: #f1f5ff;
      --text: #0a1029;
      --muted: #495079;
      --accent: #1fbf75;
      --accent-2: #2b6bff;
      --warn: #d83a34;
      --card: #ffffff;
      --chip: #eaf0ff;
      --shadow: 0 8px 24px rgba(11,16,32,0.08);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      color: var(--text);
      background: radial-gradient(1200px 600px at 80% -10%, #2a3266 0%, transparent 60%),
                  radial-gradient(1000px 500px at 10% -10%, #183a4d 0%, transparent 60%),
                  var(--bg);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    header {
      display: flex; align-items: center; gap: 16px; justify-content: space-between; flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .brand { display:flex; align-items:center; gap:12px; }
    .brand .logo { width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg,#2b6bff, #1fbf75); display:grid; place-items:center; box-shadow: var(--shadow); }
    .brand .logo svg { width: 24px; height: 24px; }
    h1 { font-size: 22px; margin: 0; letter-spacing: 0.2px; }
    .toolbar { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    .btn { appearance: none; border: 0; border-radius: 999px; padding: 10px 14px; font-weight: 600; cursor: pointer; color: var(--text); background: var(--panel-2); box-shadow: var(--shadow); display:inline-flex; align-items:center; gap:8px; }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: linear-gradient(135deg, var(--accent-2), var(--accent)); color: #0b1020; }
    .icon-btn { width: 36px; height: 36px; border-radius: 50%; display:grid; place-items:center; padding: 0 0; background: var(--panel-2); box-shadow: var(--shadow); }
    .icon { width: 18px; height: 18px; fill: currentColor; opacity: 0.95; }
    input, select { background: var(--panel); border: 1px solid transparent; color: var(--text); padding: 10px 12px; border-radius: 10px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.04); }
    input:focus, select:focus, textarea:focus { outline: 2px solid var(--accent-2); border-color: transparent; }
    .grid { display:grid; grid-template-columns: 360px 1fr; gap: 16px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .card { background: var(--card); border: 1px solid rgba(255,255,255,0.06); border-radius: var(--radius); box-shadow: var(--shadow); }
    .card > .head { display:flex; align-items:center; justify-content:space-between; padding: 16px 18px; border-bottom: 1px dashed rgba(255,255,255,0.08); }
    .card > .body { padding: 16px 18px; }

    .summary { display:grid; gap: 12px; }
    .kpi { display:grid; grid-template-columns: 120px 1fr; gap: 12px; align-items:center; }
    .ring { width: 110px; height: 110px; }
    .progress { height: 10px; border-radius: 999px; background: rgba(255,255,255,0.08); position:relative; overflow:hidden; }
    .progress > i { position:absolute; inset:0; background: linear-gradient(90deg, var(--accent-2), var(--accent)); width: 0%; border-radius: 999px; }

    .macros { display:grid; grid-template-columns: repeat(3,1fr); gap: 10px; }
    .mchip { background: var(--chip); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 10px 12px; display:grid; gap:4px; }
    .mchip small { color: var(--muted); font-weight: 600; }
    .mchip .bar { height: 6px; background: rgba(255,255,255,0.08); border-radius: 999px; overflow:hidden; }
    .mchip .bar i { display:block; height:100%; width:0%; border-radius:999px; }
    .mchip.protein .bar i { background: linear-gradient(90deg, #8b5cf6, #22d3ee); }
    .mchip.carbs .bar i { background: linear-gradient(90deg, #60a5fa, #34d399); }
    .mchip.fat .bar i { background: linear-gradient(90deg, #f59e0b, #ef4444); }

    .meal { margin-bottom: 14px; }
    .meal .mhead { display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 14px 16px; border-bottom: 1px dashed rgba(255,255,255,0.08); }
    .meal .mhead .left { display:flex; align-items:center; gap:10px; font-weight: 700; }
    .meal .mhead .left .emoji { font-size: 22px; }
    .meal .items { padding: 12px 16px; display:grid; gap: 8px; }
    .row { display:grid; grid-template-columns: 1fr 90px 240px 36px; align-items:center; gap: 10px; }
    @media (max-width: 720px) { .row { grid-template-columns: 1fr 90px 160px 36px; } }
    .row .name { display:flex; align-items:center; gap:10px; overflow:hidden; }
    .badge { font-size: 12px; background: var(--chip); padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.06); color: var(--muted); }
    .muted { color: var(--muted); }
    .totals { display:flex; justify-content:flex-end; gap: 18px; padding: 10px 16px 18px; border-top: 1px dashed rgba(255,255,255,0.08); }
    .totals b { min-width: 72px; text-align:right; }

    .add-inline { display:flex; gap:10px; align-items:center; padding: 8px 16px 16px; flex-wrap: wrap; }

    /* Modal */
    .modal { position: fixed; inset: 0; display:none; place-items:center; padding: 24px; background: rgba(5,10,25,0.55); backdrop-filter: blur(6px); }
    .modal .dialog { width: min(680px, 100%); background: var(--panel); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; }
    .modal .dialog .dhead { display:flex; align-items:center; justify-content:space-between; padding: 14px 16px; background: linear-gradient(0deg, rgba(255,255,255,0.04), rgba(255,255,255,0.0)); border-bottom: 1px solid rgba(255,255,255,0.06); }
    .modal .dialog .dbody { padding: 16px; display:grid; gap: 12px; }
    .search { display:flex; gap: 8px; }
    .results { display:grid; gap: 8px; max-height: 200px; overflow:auto; }
    .result { display:flex; justify-content:space-between; align-items:center; background: var(--card); padding: 10px 12px; border-radius: 10px; cursor:pointer; border: 1px solid rgba(255,255,255,0.06); }
    .result:hover { filter: brightness(1.05); }
    .grid2 { display:grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    @media (max-width: 560px) { .grid2 { grid-template-columns: 1fr; } }
    .note { font-size: 12px; color: var(--muted); }

    .chips { display:flex; gap:8px; flex-wrap: wrap; }
    .chip { border:1px solid rgba(255,255,255,0.08); background: var(--chip); padding:6px 10px; border-radius: 999px; cursor:pointer; }
    .chip:hover { filter: brightness(1.05); }

    .pill { padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.06); }

    .footer { display:flex; flex-wrap:wrap; gap:10px; justify-content:space-between; align-items:center; padding: 14px 0 0; color: var(--muted); font-size: 13px; }
    .links { display:flex; gap:6px; align-items:center; }
    .danger { background: linear-gradient(135deg, #ff857f, #ff5c54); color: #0b1020; }
    .ghost { background: transparent; border:1px solid rgba(255,255,255,0.12); box-shadow: none; }
  </style>
</head>
<body>
  <svg aria-hidden="true" style="position:absolute; width:0; height:0; overflow:hidden">
    <symbol id="i-plus" viewBox="0 0 24 24"><path fill="currentColor" d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol>
    <symbol id="i-trash" viewBox="0 0 24 24"><path fill="currentColor" d="M6 7h12l-1 14H7L6 7Zm3-3h6l1 2H8l1-2Z"/></symbol>
    <symbol id="i-edit" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm18-11.5l-2.34-2.34a1.25 1.25 0 0 0-1.77 0l-1.83 1.83 3.75 3.75 1.83-1.83c.49-.49.49-1.28 0-1.77Z"/></symbol>
    <symbol id="i-sun" viewBox="0 0 24 24"><path fill="currentColor" d="M6.76 4.84l-1.8-1.8L3.11 4.9l1.8 1.8l1.85-1.86ZM1 13h3v-2H1v2Zm10 10h2v-3h-2v3ZM4.9 20.89l1.86-1.85l-1.8-1.8l-1.86 1.85l1.8 1.8ZM17.24 4.84l1.86 1.86l1.8-1.8l-1.86-1.85l-1.8 1.8ZM20 13h3v-2h-3v2ZM19.1 20.89l1.8-1.8l-1.86-1.85l-1.8 1.8l1.86 1.85ZM11 1h2v3h-2V1ZM12 7a5 5 0 1 0 0 10a5 5 0 0 0 0-10Z"/></symbol>
    <symbol id="i-moon" viewBox="0 0 24 24"><path fill="currentColor" d="M21 12.79A9 9 0 1 1 11.21 3c.05 0 .1 0 .15.01A7 7 0 1 0 21 12.79Z"/></symbol>
    <symbol id="i-download" viewBox="0 0 24 24"><path fill="currentColor" d="m5 20l14 .01V22H5v-2Zm6-16h2v7l3-3l1.41 1.41L12 16.83L6.59 9.41L8 8l3 3V4Z"/></symbol>
    <symbol id="i-upload" viewBox="0 0 24 24"><path fill="currentColor" d="M5 20h14v2H5v-2Zm6-4h2v-7l3 3l1.41-1.41L12 7.17L6.59 14.59L8 16l3-3v7Z"/></symbol>
    <symbol id="i-calendar" viewBox="0 0 24 24"><path fill="currentColor" d="M7 2h2v2h6V2h2v2h3v18H4V4h3V2Zm13 8H4v10h16V10Z"/></symbol>
    <symbol id="i-search" viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5Zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5S14 7.01 14 9.5S11.99 14 9.5 14Z"/></symbol>
    <symbol id="i-close" viewBox="0 0 24 24"><path fill="currentColor" d="M18.3 5.71L12 12l6.3 6.29l-1.41 1.42L10.59 13.4L4.3 19.71L2.89 18.3L9.17 12L2.89 5.71L4.3 4.29L10.59 10.6l6.3-6.3l1.41 1.41Z"/></symbol>
  </svg>

  <div class="container" id="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true" title="Healthy Meal Tracker">
          <svg class="icon" viewBox="0 0 24 24"><path fill="#0b1020" d="M12 2c2.5 0 4.5 1.5 5.5 3.5S19 10 17 12s-4 3-5 7c-1-4-3-5-5-7s-1.5-6-.5-8.5S9.5 2 12 2Z"/></svg>
        </div>
        <div>
          <h1>Healthy Meal Tracker</h1>
          <div class="muted" style="font-size:12px">Log meals, ingredients, calories, and macros.</div>
        </div>
      </div>
      <div class="toolbar">
        <button class="icon-btn" id="themeToggle" title="Toggle theme"><svg class="icon"><use href="#i-moon"/></svg></button>
        <span class="pill" title="Selected date"><svg class="icon" style="width:16px;height:16px;vertical-align:-3px"><use href="#i-calendar"/></svg> <input id="datePicker" type="date"/></span>
        <button class="btn" id="yesterdayBtn" title="Previous day">‚óÄÔ∏é Yesterday</button>
        <button class="btn" id="todayBtn" title="Jump to today">Today</button>
        <button class="btn" id="tomorrowBtn" title="Next day">Tomorrow ‚ñ∂Ô∏é</button>
        <button class="btn primary" id="addMealBtn"><svg class="icon"><use href="#i-plus"/></svg> Add Meal</button>
        <button class="icon-btn" id="exportBtn" title="Export day"><svg class="icon"><use href="#i-download"/></svg></button>
        <button class="icon-btn" id="importBtn" title="Import day"><svg class="icon"><use href="#i-upload"/></svg></button>
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
      </div>
    </header>

    <main class="grid">
      <section class="card summary" aria-label="Daily summary">
        <div class="head"><strong>Daily Summary</strong><span class="muted" id="dayLabel"></span></div>
        <div class="body">
          <div class="kpi">
            <svg class="ring" viewBox="0 0 120 120" aria-label="Calories progress">
              <circle cx="60" cy="60" r="52" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="12"/>
              <circle id="calRing" cx="60" cy="60" r="52" fill="none" stroke="url(#calGrad)" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 999" transform="rotate(-90 60 60)"/>
              <defs>
                <linearGradient id="calGrad" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="var(--accent-2)"/>
                  <stop offset="100%" stop-color="var(--accent)"/>
                </linearGradient>
              </defs>
              <text id="calText" x="50%" y="46%" text-anchor="middle" fill="var(--muted)" font-size="12">Calories</text>
              <text id="calCount" x="50%" y="62%" text-anchor="middle" fill="var(--text)" font-size="22" font-weight="700">0</text>
              <text id="calGoalLabel" x="50%" y="76%" text-anchor="middle" fill="var(--muted)" font-size="11">of 0 kcal</text>
            </svg>
            <div>
              <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:6px">
                <div><b>Total Calories</b></div>
                <div class="muted" id="mealCount">0 meals</div>
              </div>
              <div class="progress" title="Calories toward goal"><i id="calBar" style="width:0%"></i></div>
              <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-top:6px">
                <span id="caloriesNow">0 kcal</span>
                <span id="caloriesGoal">Goal: 0 kcal</span>
              </div>
              <div class="macros" style="margin-top:12px">
                <div class="mchip protein"><small>Protein</small><div><b id="pNow">0 g</b> <span class="muted" id="pGoal">/ 0 g</span></div><div class="bar"><i id="pBar"></i></div></div>
                <div class="mchip carbs"><small>Carbs</small><div><b id="cNow">0 g</b> <span class="muted" id="cGoal">/ 0 g</span></div><div class="bar"><i id="cBar"></i></div></div>
                <div class="mchip fat"><small>Fat</small><div><b id="fNow">0 g</b> <span class="muted" id="fGoal">/ 0 g</span></div><div class="bar"><i id="fBar"></i></div></div>
              </div>
              <div style="display:flex; gap:8px; margin-top:12px; flex-wrap: wrap; align-items:center">
                <button class="btn" id="editGoalsBtn"><svg class="icon"><use href="#i-edit"/></svg> Set Goals</button>
                <button class="btn ghost" id="resetDayBtn" title="Clear meals for selected day"><svg class="icon"><use href="#i-trash"/></svg> Reset Day</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="card" aria-label="Meals">
        <div class="head"><strong>Meals</strong><span class="muted">Add ingredients to each meal</span></div>
        <div class="body" id="meals"></div>
      </section>
    </main>

    <div class="footer">
      <div class="links">
        <span class="badge">üçè Tip</span>
        Track whole foods first; fine‚Äëtune portions later.
      </div>
      <div class="links">
        <span class="muted">Built as a single self‚Äëcontained file ‚Ä¢ No trackers</span>
      </div>
    </div>
  </div>

  <!-- Ingredient Modal -->
  <div class="modal" id="ingredientModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="dialog">
      <div class="dhead">
        <div><b id="modalTitle">Add Ingredient</b> <span class="muted" id="modalMealName"></span></div>
        <button class="icon-btn" id="closeModalBtn" aria-label="Close"><svg class="icon"><use href="#i-close"/></svg></button>
      </div>
      <div class="dbody">
        <div class="search">
          <span class="pill"><svg class="icon" style="width:16px;height:16px;vertical-align:-3px"><use href="#i-search"/></svg></span>
          <input id="foodSearch" type="text" placeholder="Search common foods (e.g., chicken, rice, apple)" style="flex:1"/>
        </div>
        <div class="results" id="foodResults"></div>
        <div class="grid2">
          <div class="card">
            <div class="head"><strong>Details</strong><span class="muted">Adjust quantity</span></div>
            <div class="body" style="display:grid; gap:10px">
              <label>Food name <input id="ingName" type="text" placeholder="Custom name"/></label>
              <div class="chips" id="quickAmounts"></div>
              <div class="grid2">
                <label>Amount <input id="ingAmount" type="number" min="0" step="0.1" value="100"/></label>
                <label>Unit
                  <select id="ingUnit">
                    <option value="g">g</option>
                    <option value="unit">unit</option>
                  </select>
                </label>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="head"><strong>Macros</strong><span class="muted">Auto from database or edit</span></div>
            <div class="body" style="display:grid; gap:10px">
              <div class="grid2">
                <label>Calories <input id="ingCal" type="number" step="1" min="0"/></label>
                <label>Protein (g) <input id="ingP" type="number" step="0.1" min="0"/></label>
                <label>Carbs (g) <input id="ingC" type="number" step="0.1" min="0"/></label>
                <label>Fat (g) <input id="ingF" type="number" step="0.1" min="0"/></label>
              </div>
              <div class="note">If macros are provided but calories are empty, calories are estimated as 4¬∑protein + 4¬∑carbs + 9¬∑fat.</div>
            </div>
          </div>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:4px">
          <button class="btn ghost" id="deleteIngredientBtn" style="display:none"><svg class="icon"><use href="#i-trash"/></svg> Delete</button>
          <button class="btn" id="saveIngredientBtn"><svg class="icon"><use href="#i-plus"/></svg> Save Ingredient</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Goals Modal -->
  <div class="modal" id="goalsModal" role="dialog" aria-modal="true" aria-labelledby="goalsTitle">
    <div class="dialog">
      <div class="dhead">
        <div><b id="goalsTitle">Daily Goals</b> <span class="muted">Calories and macros</span></div>
        <button class="icon-btn" id="closeGoalsBtn" aria-label="Close"><svg class="icon"><use href="#i-close"/></svg></button>
      </div>
      <div class="dbody" style="display:grid; gap:10px">
        <div class="grid2">
          <label>Calories goal (kcal) <input id="goalCal" type="number" step="10" min="0"/></label>
          <label>Protein goal (g) <input id="goalP" type="number" step="1" min="0"/></label>
          <label>Carbs goal (g) <input id="goalC" type="number" step="1" min="0"/></label>
          <label>Fat goal (g) <input id="goalF" type="number" step="1" min="0"/></label>
        </div>
        <div class="note">Goals are saved per‚Äëday. You can revisit previous days and adjust.</div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn" id="saveGoalsBtn">Save Goals</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  ;(() => {
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const fmt = (n, d=0) => (isNaN(n) ? 0 : Math.round(n * 10**d) / 10**d);
    const todayStr = () => new Date().toISOString().slice(0,10);
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    const EMOJI = {
      breakfast: 'üç≥', lunch: 'ü•ó', dinner: 'üçù', snacks: 'üçé',
      default: 'üçΩÔ∏è'
    };
    const ICON_FOR = (name) => {
      const n = (name||'').toLowerCase();
      if (/(apple|banana|berry|fruit)/.test(n)) return 'üçé';
      if (/(chicken|turkey|beef|pork|meat)/.test(n)) return 'üçó';
      if (/(rice|oat|bread|pasta|noodle|grain)/.test(n)) return 'üçû';
      if (/(salad|lettuce|broccoli|spinach|veggie|vegetable)/.test(n)) return 'ü•¶';
      if (/(fish|salmon|tuna|shrimp)/.test(n)) return 'üêü';
      if (/(egg)/.test(n)) return 'ü•ö';
      if (/(yogurt|milk|cheese)/.test(n)) return 'üßÄ';
      if (/(oil|butter|fat|avocado|olive)/.test(n)) return 'ü´í';
      if (/(snack|bar|cookie|chips|nuts|almond|peanut)/.test(n)) return 'ü•ú';
      return 'üçΩÔ∏è';
    };

    const FOOD_DB = [
      // name, base: per100g or perUnit, gramsPerUnit if perUnit, macros
      { name:'Chicken breast, cooked', base:'per100g', kcal:165, p:31, c:0, f:3.6 },
      { name:'White rice, cooked', base:'per100g', kcal:130, p:2.4, c:28.0, f:0.3 },
      { name:'Brown rice, cooked', base:'per100g', kcal:123, p:2.6, c:25.6, f:1.0 },
      { name:'Pasta, cooked', base:'per100g', kcal:131, p:5.0, c:25.0, f:1.1 },
      { name:'Oats (dry)', base:'per100g', kcal:389, p:16.9, c:66.3, f:6.9 },
      { name:'Broccoli', base:'per100g', kcal:34, p:2.8, c:6.6, f:0.4 },
      { name:'Spinach', base:'per100g', kcal:23, p:2.9, c:3.6, f:0.4 },
      { name:'Olive oil', base:'perUnit', gramsPerUnit:14, unitLabel:'tbsp', kcal:119, p:0, c:0, f:13.5 },
      { name:'Egg, large', base:'perUnit', gramsPerUnit:50, unitLabel:'egg', kcal:72, p:6.3, c:0.4, f:4.8 },
      { name:'Banana', base:'perUnit', gramsPerUnit:118, unitLabel:'banana', kcal:105, p:1.3, c:27.0, f:0.4 },
      { name:'Apple', base:'perUnit', gramsPerUnit:182, unitLabel:'apple', kcal:95, p:0.5, c:25.0, f:0.3 },
      { name:'Greek yogurt, nonfat', base:'per100g', kcal:59, p:10.0, c:3.6, f:0.4 },
      { name:'Salmon, cooked', base:'per100g', kcal:206, p:22.1, c:0, f:12.4 },
      { name:'Sweet potato, baked', base:'per100g', kcal:90, p:2.0, c:21.0, f:0.1 },
      { name:'Almonds', base:'per100g', kcal:579, p:21.2, c:21.6, f:49.9 },
      { name:'Whole wheat bread', base:'perUnit', gramsPerUnit:28, unitLabel:'slice', kcal:77, p:3.6, c:13.0, f:1.0 },
      { name:'Peanut butter', base:'perUnit', gramsPerUnit:16, unitLabel:'tbsp', kcal:94, p:3.5, c:3.2, f:8.0 },
      { name:'Cheddar cheese', base:'per100g', kcal:402, p:25.0, c:1.3, f:33.1 },
      { name:'Milk 2%', base:'perUnit', gramsPerUnit:244, unitLabel:'cup', kcal:122, p:8.1, c:12.0, f:4.7 },
      { name:'Lentils, cooked', base:'per100g', kcal:116, p:9.0, c:20.1, f:0.4 }
    ];

    const defaultDay = () => ({
      meals: [
        { id: uid(), name:'Breakfast', emoji: EMOJI.breakfast, items: [] },
        { id: uid(), name:'Lunch', emoji: EMOJI.lunch, items: [] },
        { id: uid(), name:'Dinner', emoji: EMOJI.dinner, items: [] },
        { id: uid(), name:'Snacks', emoji: EMOJI.snacks, items: [] },
      ],
      goals: { cal: 2200, p: 140, c: 240, f: 70 }
    });

    function uid() { return Math.random().toString(36).slice(2,9); }

    const storeKey = 'hmt.days.v1';
    const themeKey = 'hmt.theme';
    let state = { days: loadDays() };
    let currentDate = todayStr();
    let editing = { mealId: null, itemId: null };

    // Elements
    const datePicker = $('#datePicker');
    const mealsEl = $('#meals');
    const dayLabel = $('#dayLabel');
    const mealCount = $('#mealCount');
    const calRing = $('#calRing');
    const calCount = $('#calCount');
    const calGoalLabel = $('#calGoalLabel');
    const calBar = $('#calBar');
    const caloriesNow = $('#caloriesNow');
    const caloriesGoal = $('#caloriesGoal');
    const pNow = $('#pNow'), cNow = $('#cNow'), fNow = $('#fNow');
    const pGoal = $('#pGoal'), cGoal = $('#cGoal'), fGoal = $('#fGoal');
    const pBar = $('#pBar'), cBar = $('#cBar'), fBar = $('#fBar');

    // Modal elements
    const modal = $('#ingredientModal');
    const modalTitle = $('#modalTitle');
    const modalMealName = $('#modalMealName');
    const foodSearch = $('#foodSearch');
    const foodResults = $('#foodResults');
    const ingName = $('#ingName');
    const ingAmount = $('#ingAmount');
    const ingUnit = $('#ingUnit');
    const quickAmounts = $('#quickAmounts');
    const ingCal = $('#ingCal');
    const ingP = $('#ingP');
    const ingC = $('#ingC');
    const ingF = $('#ingF');
    const saveIngredientBtn = $('#saveIngredientBtn');
    const deleteIngredientBtn = $('#deleteIngredientBtn');

    // Goals modal
    const goalsModal = $('#goalsModal');
    const goalCal = $('#goalCal');
    const goalP = $('#goalP');
    const goalC = $('#goalC');
    const goalF = $('#goalF');

    // Toolbar & actions
    $('#addMealBtn').addEventListener('click', () => addMeal());
    $('#exportBtn').addEventListener('click', onExport);
    $('#importBtn').addEventListener('click', () => $('#importFile').click());
    $('#importFile').addEventListener('change', onImportFile);
    $('#resetDayBtn').addEventListener('click', resetDay);
    $('#todayBtn').addEventListener('click', () => setDate(todayStr()));
    $('#yesterdayBtn').addEventListener('click', () => shiftDate(-1));
    $('#tomorrowBtn').addEventListener('click', () => shiftDate(1));
    $('#editGoalsBtn').addEventListener('click', openGoals);
    $('#saveGoalsBtn').addEventListener('click', saveGoals);
    $('#closeGoalsBtn').addEventListener('click', () => toggleModal(goalsModal,false));
    $('#themeToggle').addEventListener('click', toggleTheme);

    // Modal listeners
    $('#closeModalBtn').addEventListener('click', () => toggleModal(modal,false));
    foodSearch.addEventListener('input', renderFoodResults);
    [ingAmount, ingUnit].forEach(el => el.addEventListener('input', recalcFromBase));
    saveIngredientBtn.addEventListener('click', saveIngredientFromModal);
    deleteIngredientBtn.addEventListener('click', deleteIngredientFromModal);

    datePicker.addEventListener('change', (e) => setDate(e.target.value));

    // Theme init
    const savedTheme = localStorage.getItem(themeKey);
    if (savedTheme === 'light') document.body.classList.add('light');

    // Init
    setDate(todayStr());

    function toggleTheme(){
      document.body.classList.toggle('light');
      localStorage.setItem(themeKey, document.body.classList.contains('light') ? 'light' : 'dark');
      // swap icon glyph
      $('#themeToggle').innerHTML = `<svg class="icon"><use href="#${document.body.classList.contains('light')?'i-moon':'i-sun'}"/></svg>`;
    }

    function loadDays(){
      try { return JSON.parse(localStorage.getItem(storeKey)) || {}; } catch { return {}; }
    }
    function getDay(d){
      if (!state.days[d]) state.days[d] = defaultDay();
      return state.days[d];
    }
    function save(){ localStorage.setItem(storeKey, JSON.stringify(state.days)); }

    function setDate(d){
      currentDate = d;
      datePicker.value = currentDate;
      render();
    }
    function shiftDate(delta){
      const dt = new Date(currentDate);
      dt.setDate(dt.getDate()+delta);
      setDate(dt.toISOString().slice(0,10));
    }

    function render(){
      const day = getDay(currentDate);
      dayLabel.textContent = new Date(currentDate).toLocaleDateString(undefined, { weekday:'long', month:'short', day:'numeric' });
      renderMeals(day);
      renderSummary(day);
      save();
    }

    function renderMeals(day){
      mealsEl.innerHTML = '';
      day.meals.forEach(meal => {
        const totals = mealTotals(meal);
        const elem = document.createElement('div');
        elem.className = 'card meal';
        elem.innerHTML = `
          <div class="mhead">
            <div class="left">
              <span class="emoji" role="img" aria-label="Meal icon">${meal.emoji || EMOJI.default}</span>
              <input class="meal-name" value="${meal.name}" style="background:transparent;border:0;border-bottom:1px dashed rgba(255,255,255,0.2); color:var(--text); font-weight:700; width: 180px" />
              <span class="badge">${totals.kcal} kcal</span>
            </div>
            <div style="display:flex; gap:6px">
              <button class="btn ghost addIng"><svg class="icon"><use href="#i-plus"/></svg> Add Ingredient</button>
              <button class="icon-btn delMeal" title="Delete meal"><svg class="icon"><use href="#i-trash"/></svg></button>
            </div>
          </div>
          <div class="items"></div>
          <div class="totals">
            <span class="muted">Totals:</span>
            <b title="Protein">P ${totals.p} g</b>
            <b title="Carbs">C ${totals.c} g</b>
            <b title="Fat">F ${totals.f} g</b>
            <b title="Calories">${totals.kcal} kcal</b>
          </div>
        `;
        const itemsEl = $('.items', elem);
        meal.items.forEach(item => {
          const row = document.createElement('div');
          row.className = 'row';
          row.innerHTML = `
            <div class="name"><span>${ICON_FOR(item.name)}</span><div title="${item.name}" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${item.name}</div></div>
            <div class="muted">${fmt(item.amount)} ${item.unit || 'g'}</div>
            <div class="muted">P ${fmt(item.p,1)} g ‚Ä¢ C ${fmt(item.c,1)} g ‚Ä¢ F ${fmt(item.f,1)} g ‚Ä¢ <b style="color:var(--text)">${fmt(item.kcal)} kcal</b></div>
            <button class="icon-btn edit" title="Edit"><svg class="icon"><use href="#i-edit"/></svg></button>
          `;
          $('.edit', row).addEventListener('click', () => openIngredientModal(meal.id, item.id));
          itemsEl.appendChild(row);
        });
        $('.addIng', elem).addEventListener('click', () => openIngredientModal(meal.id, null));
        $('.delMeal', elem).addEventListener('click', () => deleteMeal(meal.id));
        $('.meal-name', elem).addEventListener('input', (e) => { meal.name = e.target.value; render(); });
        mealsEl.appendChild(elem);
      });
    }

    function renderSummary(day){
      const t = dayTotals(day);
      mealCount.textContent = `${day.meals.length} meal${day.meals.length!==1?'s':''}`;
      calCount.textContent = t.kcal;
      caloriesNow.textContent = `${t.kcal} kcal`;
      caloriesGoal.textContent = `Goal: ${day.goals.cal} kcal`;
      calGoalLabel.textContent = `of ${day.goals.cal} kcal`;
      const pct = t.kcal && day.goals.cal ? clamp(t.kcal/day.goals.cal, 0, 1) : 0;
      const circ = 2 * Math.PI * 52;
      calRing.setAttribute('stroke-dasharray', `${circ * pct} ${circ}`);
      calBar.style.width = `${pct*100}%`;
      pNow.textContent = `${t.p} g`; cNow.textContent = `${t.c} g`; fNow.textContent = `${t.f} g`;
      pGoal.textContent = `/ ${day.goals.p} g`; cGoal.textContent = `/ ${day.goals.c} g`; fGoal.textContent = `/ ${day.goals.f} g`;
      pBar.style.width = `${(t.p/day.goals.p||0)*100}%`;
      cBar.style.width = `${(t.c/day.goals.c||0)*100}%`;
      fBar.style.width = `${(t.f/day.goals.f||0)*100}%`;
    }

    function mealTotals(meal){
      const p = meal.items.reduce((a,b)=>a+(+b.p||0),0);
      const c = meal.items.reduce((a,b)=>a+(+b.c||0),0);
      const f = meal.items.reduce((a,b)=>a+(+b.f||0),0);
      const kcal = meal.items.reduce((a,b)=>a+(+b.kcal||0),0);
      return { p: fmt(p,1), c: fmt(c,1), f: fmt(f,1), kcal: fmt(kcal) };
    }
    function dayTotals(day){
      return day.meals.map(mealTotals).reduce((acc,t)=>({
        p: fmt(acc.p + t.p,1), c: fmt(acc.c + t.c,1), f: fmt(acc.f + t.f,1), kcal: fmt(acc.kcal + t.kcal)
      }), {p:0,c:0,f:0,kcal:0});
    }

    function addMeal(){
      const day = getDay(currentDate);
      day.meals.push({ id: uid(), name:'New meal', emoji: EMOJI.default, items: [] });
      render();
    }
    function deleteMeal(mealId){
      const day = getDay(currentDate);
      const idx = day.meals.findIndex(m=>m.id===mealId);
      if (idx>=0) day.meals.splice(idx,1);
      render();
    }

    function openIngredientModal(mealId, itemId){
      const day = getDay(currentDate);
      const meal = day.meals.find(m=>m.id===mealId);
      editing = { mealId, itemId };
      modalTitle.textContent = itemId ? 'Edit Ingredient' : 'Add Ingredient';
      modalMealName.textContent = `‚Ä¢ ${meal.name}`;
      // Reset fields
      foodSearch.value = '';
      renderFoodResults();
      quickAmounts.innerHTML = '';
      ingUnit.value = 'g';
      ingAmount.value = 100;
      [ingName, ingCal, ingP, ingC, ingF].forEach(i => i.value = '');
      deleteIngredientBtn.style.display = itemId ? 'inline-flex' : 'none';
      if (itemId){
        const it = meal.items.find(i=>i.id===itemId);
        ingName.value = it.name; ingAmount.value = it.amount; ingUnit.value = it.unit || 'g';
        ingCal.value = it.kcal; ingP.value = it.p; ingC.value = it.c; ingF.value = it.f;
      }
      toggleModal(modal, true);
      setTimeout(()=>foodSearch.focus(), 10);
    }
    function toggleModal(el, show){ el.style.display = show ? 'grid' : 'none'; }

    function renderFoodResults(){
      const q = foodSearch.value.trim().toLowerCase();
      const list = q ? FOOD_DB.filter(f=>f.name.toLowerCase().includes(q)) : FOOD_DB.slice(0,6);
      foodResults.innerHTML = '';
      list.forEach(f => {
        const div = document.createElement('div');
        div.className = 'result';
        div.innerHTML = `
          <div style="display:flex; gap:10px; align-items:center">
            <span>${ICON_FOR(f.name)}</span> <b>${f.name}</b>
          </div>
          <div class="muted" style="font-size:12px">${f.base==='per100g' ? 'per 100g' : `per ${f.unitLabel||'unit'}`} ‚Ä¢ ${f.kcal} kcal ‚Ä¢ P ${f.p} ‚Ä¢ C ${f.c} ‚Ä¢ F ${f.f}</div>
        `;
        div.addEventListener('click', () => applyFoodToForm(f));
        foodResults.appendChild(div);
      });
    }
    function applyFoodToForm(f){
      ingName.value = f.name;
      if (f.base==='per100g') {
        ingUnit.value = 'g';
        ingAmount.value = 100;
        quickAmounts.innerHTML = ['50','100','150','200','250'].map(n=>`<span class="chip" data-x="${n}">${n} g</span>`).join('');
      } else {
        ingUnit.value = 'unit';
        ingAmount.value = 1;
        const label = f.unitLabel||'unit';
        quickAmounts.innerHTML = ['0.5','1','2','3'].map(n=>`<span class="chip" data-x="${n}">${n} ${label}${n>1?'s':''}</span>`).join('');
      }
      $$('.chip', quickAmounts).forEach(ch => ch.addEventListener('click', () => { ingAmount.value = ch.getAttribute('data-x'); recalcFromBase(); }));
      // initial calculation from base per amount
      recalcFromBase(f);
    }
    function recalcFromBase(food){
      let f = food;
      if (!f){
        // try match by name
        f = FOOD_DB.find(x=>x.name.toLowerCase() === ingName.value.trim().toLowerCase());
      }
      const amount = parseFloat(ingAmount.value)||0;
      const unit = ingUnit.value;
      if (f){
        if (f.base==='per100g' && unit==='g'){
          const ratio = amount/100;
          ingCal.value = fmt(f.kcal*ratio);
          ingP.value = fmt(f.p*ratio,1);
          ingC.value = fmt(f.c*ratio,1);
          ingF.value = fmt(f.f*ratio,1);
        } else if (f.base==='perUnit' && unit==='unit'){
          const ratio = amount;
          ingCal.value = fmt(f.kcal*ratio);
          ingP.value = fmt(f.p*ratio,1);
          ingC.value = fmt(f.c*ratio,1);
          ingF.value = fmt(f.f*ratio,1);
        }
      } else {
        // No base, do nothing ‚Äì manual entry
      }
    }

    function saveIngredientFromModal(){
      const day = getDay(currentDate);
      const meal = day.meals.find(m=>m.id===editing.mealId);
      const item = {
        id: editing.itemId || uid(),
        name: ingName.value || 'Custom ingredient',
        amount: parseFloat(ingAmount.value)||0,
        unit: ingUnit.value,
        kcal: parseFloat(ingCal.value)||calcFromMacros(),
        p: parseFloat(ingP.value)||0,
        c: parseFloat(ingC.value)||0,
        f: parseFloat(ingF.value)||0,
      };
      if (editing.itemId){
        const idx = meal.items.findIndex(i=>i.id===editing.itemId);
        meal.items[idx] = item;
      } else {
        meal.items.push(item);
      }
      toggleModal(modal,false);
      render();
    }
    function deleteIngredientFromModal(){
      const day = getDay(currentDate);
      const meal = day.meals.find(m=>m.id===editing.mealId);
      const idx = meal.items.findIndex(i=>i.id===editing.itemId);
      if (idx>=0) meal.items.splice(idx,1);
      toggleModal(modal,false);
      render();
    }
    function calcFromMacros(){
      const p = parseFloat(ingP.value)||0;
      const c = parseFloat(ingC.value)||0;
      const f = parseFloat(ingF.value)||0;
      return fmt(p*4 + c*4 + f*9);
    }

    function onExport(){
      const name = `meal-tracker-${currentDate}.json`;
      const blob = new Blob([JSON.stringify(getDay(currentDate), null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }
    function onImportFile(e){
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (!data || !data.meals || !data.goals) throw new Error('Invalid format');
          state.days[currentDate] = data;
          render();
        } catch(err){
          alert('Import failed: ' + err.message);
        } finally {
          e.target.value = '';
        }
      };
      reader.readAsText(f);
    }

    function resetDay(){
      if (!confirm('Clear all meals for this day?')) return;
      state.days[currentDate] = defaultDay();
      render();
    }

    function openGoals(){
      const day = getDay(currentDate);
      goalCal.value = day.goals.cal; goalP.value = day.goals.p; goalC.value = day.goals.c; goalF.value = day.goals.f;
      toggleModal(goalsModal,true);
    }
    function saveGoals(){
      const day = getDay(currentDate);
      day.goals = { cal: +goalCal.value||0, p:+goalP.value||0, c:+goalC.value||0, f:+goalF.value||0 };
      toggleModal(goalsModal,false);
      render();
    }
  })();
  </script>
</body>
</html>
