<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Employee Skills Matrix</title>
  <meta name="description" content="Track team skills coverage with an HR-focused, interactive skills matrix. Single-file app with inline CSS and JS." />
  <style>
    :root{
      --brand-50:#eef2ff; --brand-100:#e0e7ff; --brand-200:#c7d2fe; --brand-300:#a5b4fc; --brand-400:#818cf8; --brand-500:#6366f1; --brand-600:#4f46e5; --brand-700:#4338ca;
      --ink-900:#111827; --ink-700:#374151; --ink-600:#4b5563; --ink-500:#6b7280; --ink-400:#9ca3af; --ink-300:#d1d5db; --ink-200:#e5e7eb; --ink-100:#f3f4f6; --ink-50:#f9fafb;
      --ok-50:#ecfdf5; --ok-300:#6ee7b7; --ok-500:#10b981; --ok-600:#059669;
      --warn-50:#fffbeb; --warn-300:#fcd34d; --warn-500:#f59e0b; --warn-600:#d97706;
      --err-50:#fef2f2; --err-300:#fca5a5; --err-600:#dc2626;
      --lvl-0:#e5e7eb; --lvl-1:#fde68a; --lvl-2:#fbbf24; --lvl-3:#34d399; --lvl-4:#059669;
      --focus:#22c55e;
      --radius:12px; --radius-sm:8px;
      --shadow:0 6px 20px rgba(17,24,39,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--ink-900);background:linear-gradient(180deg,var(--ink-50),#fff)}
    a{color:var(--brand-600);text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    header.top{
      background:linear-gradient(135deg,var(--brand-600),var(--ok-600));
      color:white;box-shadow:var(--shadow);
      position:sticky;top:0;z-index:50
    }
    header.top .inner{display:flex;align-items:center;gap:16px;justify-content:space-between;padding:16px 24px}
    .title{display:flex;align-items:center;gap:12px}
    .title h1{font-size:20px;letter-spacing:.2px;margin:0}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.18);backdrop-filter:saturate(1.5) blur(2px);border:1px solid rgba(255,255,255,.35)}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--ink-200);background:white;color:var(--ink-900);padding:8px 12px;border-radius:10px;cursor:pointer;display:inline-flex;gap:8px;align-items:center;font-weight:600;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .btn:hover{box-shadow:var(--shadow)}
    .btn:focus{outline:3px solid rgba(34,197,94,.35)}
    .btn.primary{background:linear-gradient(180deg,var(--brand-500),var(--brand-600));color:white;border-color:transparent}
    .btn.ghost{background:transparent;color:white;border-color:rgba(255,255,255,.35)}
    .btn.icon{padding:8px}
    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:18px 0}
    .field{display:flex;align-items:center;gap:8px;background:white;border:1px solid var(--ink-200);padding:8px 10px;border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .field input[type="text"], .field select{border:0;outline:0;background:transparent;min-width:140px}
    .toggle{display:inline-flex;gap:8px;align-items:center}
    .toggle input{appearance:none;width:36px;height:22px;border-radius:999px;background:var(--ink-300);position:relative;transition:.2s all ease;border:1px solid var(--ink-200)}
    .toggle input:before{content:"";position:absolute;width:16px;height:16px;border-radius:50%;left:3px;top:2px;background:white;box-shadow:0 1px 2px rgba(0,0,0,.2);transition:.2s all ease}
    .toggle input:checked{background:linear-gradient(180deg,var(--ok-500),var(--ok-600));border-color:transparent}
    .toggle input:checked:before{left:17px}

    /* Summary cards */
    .summary{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .card{background:white;border:1px solid var(--ink-200);border-radius:12px;padding:14px;box-shadow:var(--shadow)}
    .kpi{display:flex;justify-content:space-between;align-items:center}
    .kpi .value{font-weight:800;font-size:22px}
    .kpi .label{color:var(--ink-500);font-size:12px}
    .trend{font-size:12px;border-radius:999px;padding:3px 8px;font-weight:700}
    .trend.up{background:var(--ok-50);color:var(--ok-600)}
    .trend.down{background:var(--warn-50);color:var(--warn-600)}

    /* Matrix */
    .matrix-wrap{margin-top:16px;background:white;border:1px solid var(--ink-200);border-radius:14px;overflow:auto;box-shadow:var(--shadow)}
    .matrix{display:grid;grid-auto-rows:minmax(44px,auto);position:relative}
    .cell{border-bottom:1px solid var(--ink-200);border-right:1px solid var(--ink-200);padding:6px 8px;display:flex;align-items:center;justify-content:center;min-width:120px;background:white}
    .cell.header{background:linear-gradient(180deg,var(--brand-50),#fff);font-weight:700;color:var(--ink-700)}
    .cell.header.employee{writing-mode:vertical-rl;transform:rotate(180deg);text-align:left;gap:8px}
    .cell.header.employee .emp{display:flex;align-items:center;gap:6px}
    .cell.header.employee .role{font-size:12px;color:var(--ink-500);font-weight:600}
    .cell.header.skill{justify-content:flex-start;gap:8px}
    .sticky-top{position:sticky;top:0;z-index:10}
    .sticky-left{position:sticky;left:0;z-index:7}
    .corner{z-index:15}
    .skill-name{font-weight:700}
    .skill-meta{display:flex;gap:8px;align-items:center;margin-left:auto}
    .chip{border-radius:999px;padding:2px 8px;font-size:11px;border:1px solid var(--ink-200);background:var(--ink-50);color:var(--ink-700)}
    .chip.critical{background:linear-gradient(90deg,#fef3c7,#fee2e2);border-color:#fde68a;color:#b45309}
    .risk{font-size:11px;color:#b45309;display:flex;align-items:center;gap:4px}

    .level{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--ink-200);min-width:44px;justify-content:center;font-weight:800;letter-spacing:.3px}
    .l0{background:var(--lvl-0)}
    .l1{background:var(--lvl-1)}
    .l2{background:var(--lvl-2)}
    .l3{background:var(--lvl-3);color:white;border-color:transparent}
    .l4{background:var(--lvl-4);color:white;border-color:transparent}
    .cell.editable{cursor:pointer}
    .cell.selected{outline:3px solid rgba(34,197,94,.45);outline-offset:-3px}
    .hint{font-size:11px;color:var(--ink-500)}

    /* Footer */
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
    .legend .item{display:flex;gap:6px;align-items:center}

    /* Drawer (profile) */
    .drawer{position:fixed;right:16px;bottom:16px;max-width:340px;z-index:60;background:white;border:1px solid var(--ink-200);border-radius:14px;box-shadow:var(--shadow);padding:16px;display:none}
    .drawer.open{display:block}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:80}
    .modal.open{display:flex}
    .modal .panel{width:min(720px,92vw);max-height:88vh;overflow:auto;background:white;border-radius:14px;padding:16px;border:1px solid var(--ink-200);box-shadow:var(--shadow)}
    .modal .panel h3{margin:0 0 8px}
    .modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .modal textarea{width:100%;min-height:180px}

    /* Utilities */
    .grow{flex:1}
    .muted{color:var(--ink-500)}
    .sep{height:1px;background:var(--ink-200);margin:8px 0}

    /* Responsive */
    @media (max-width: 900px){
      .summary{grid-template-columns:1fr 1fr}
      .cell.header.employee{writing-mode:horizontal-tb;transform:none;justify-content:flex-start}
    }

    /* Print */
    @media print{
      header.top,.toolbar,.drawer,.modal{display:none !important}
      body{background:white}
      .matrix-wrap{box-shadow:none;border-color:#ddd}
    }
  </style>
</head>
<body>
  <header class="top" role="banner">
    <div class="inner container">
      <div class="title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#fff" stop-opacity=".95"/>
              <stop offset="100%" stop-color="#c7d2fe" stop-opacity=".85"/>
            </linearGradient>
          </defs>
          <path d="M5 8c0-1.657 1.343-3 3-3h8a3 3 0 0 1 3 3v8a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V8Z" fill="url(#g)"/>
          <path d="M7 9h10M7 13h10M7 17h6" stroke="#4f46e5" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
        <h1>Employee Skills Matrix</h1>
        <span class="badge" title="People-first features and language">HR‑focused</span>
      </div>
      <div class="actions">
        <button id="btnExport" class="btn ghost" title="Download current data as JSON">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v12m0 0 4-4m-4 4-4-4M4 19h16" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Export
        </button>
        <button id="btnImport" class="btn ghost" title="Import JSON from another team or system">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 21V9m0 0-4 4m4-4 4 4M4 5h16" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Import
        </button>
        <button id="btnPrint" class="btn ghost" title="Print or save as PDF">Print</button>
      </div>
    </div>
  </header>

  <main class="container" role="main">
    <section class="toolbar" aria-label="Filters and actions">
      <div class="field" title="Find a skill by name">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke="#6b7280" stroke-width="1.6"/><path d="m20 20-3.5-3.5" stroke="#6b7280" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input id="qSkill" type="text" placeholder="Search skills…" aria-label="Search skills" />
      </div>
      <div class="field" title="Find a colleague by name">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="9" cy="8" r="4" stroke="#6b7280" stroke-width="1.6"/><path d="M3 20c.5-3.5 3.5-6 8-6s7.5 2.5 8 6" stroke="#6b7280" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input id="qEmp" type="text" placeholder="Search employees…" aria-label="Search employees" />
      </div>
      <div class="field" title="Filter by team">
        <span class="muted">Team</span>
        <select id="fTeam" aria-label="Filter by team"><option value="">All</option></select>
      </div>
      <div class="field" title="Filter by role">
        <span class="muted">Role</span>
        <select id="fRole" aria-label="Filter by role"><option value="">All</option></select>
      </div>
      <label class="toggle" title="Show only critical skills">
        <input id="tCritical" type="checkbox" /><span>Critical</span>
      </label>
      <label class="toggle" title="Highlight missing coverage (level 0)">
        <input id="tGaps" type="checkbox" /><span>Highlight gaps</span>
      </label>
      <div class="grow"></div>
      <button id="btnAddEmp" class="btn" title="Add employee">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0Zm-9 12c.5-3.5 3.5-6 8-6" stroke="#4b5563" stroke-width="1.6" stroke-linecap="round"/><path d="M16 11v8m-4-4h8" stroke="#4f46e5" stroke-width="1.8" stroke-linecap="round"/></svg>
        Add Employee
      </button>
      <button id="btnAddSkill" class="btn primary" title="Add skill or competency">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
        Add Skill
      </button>
    </section>

    <section class="summary" aria-label="Key metrics">
      <article class="card">
        <div class="kpi"><div><div class="label">Employees</div><div id="kEmployees" class="value">0</div></div>
        <span class="trend up" id="trendEmp">+0 this quarter</span></div>
      </article>
      <article class="card">
        <div class="kpi"><div><div class="label">Skills</div><div id="kSkills" class="value">0</div></div>
        <span class="trend up" id="trendSkills">+0 curated</span></div>
      </article>
      <article class="card">
        <div class="kpi"><div><div class="label">Coverage Score</div><div id="kCoverage" class="value">0%</div></div>
        <span class="trend up" id="trendCoverage">steady</span></div>
      </article>
      <article class="card">
        <div class="kpi"><div><div class="label">Gaps</div><div id="kGaps" class="value">0</div></div>
        <span class="trend down" id="trendGaps">down vs. last month</span></div>
      </article>
    </section>

    <section class="matrix-wrap" aria-label="Skills matrix">
      <div id="matrix" class="matrix" role="grid" aria-readonly="false"></div>
    </section>

    <section class="legend" aria-label="Proficiency legend">
      <div class="item"><span class="level l0">0</span><span class="muted">None</span></div>
      <div class="item"><span class="level l1">1</span><span class="muted">Learning</span></div>
      <div class="item"><span class="level l2">2</span><span class="muted">Working</span></div>
      <div class="item"><span class="level l3">3</span><span class="muted">Proficient</span></div>
      <div class="item"><span class="level l4">4</span><span class="muted">Expert</span></div>
      <div class="item hint">Tip: Click a cell to change level; use 0–4 keys, arrow keys to navigate.</div>
    </section>
  </main>

  <!-- Drawer -->
  <aside id="drawer" class="drawer" role="dialog" aria-modal="false" aria-label="Employee profile">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
      <div id="drawerName" style="font-weight:800;font-size:16px">—</div>
      <div id="drawerRole" class="muted">—</div>
      <div class="grow"></div>
      <button id="closeDrawer" class="btn icon" title="Close"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="#111827" stroke-width="2" stroke-linecap="round"/></svg></button>
    </div>
    <div class="sep"></div>
    <div id="drawerSkills"></div>
  </aside>

  <!-- Modals -->
  <div id="modalImport" class="modal" role="dialog" aria-modal="true" aria-label="Import data">
    <div class="panel">
      <h3>Import Skills Matrix</h3>
      <p class="muted">Paste JSON exported from this tool or another compatible source. Your current data will be replaced.</p>
      <textarea id="importText" placeholder='{"employees":[],"skills":[],"levels":{}}'></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn" data-close="modalImport">Cancel</button>
        <button id="doImport" class="btn primary">Import</button>
      </div>
    </div>
  </div>

  <div id="modalEmployee" class="modal" role="dialog" aria-modal="true" aria-label="Add employee">
    <div class="panel">
      <h3>Add Employee</h3>
      <div class="grid">
        <div class="field"><span>Name</span><input id="empName" type="text" placeholder="Full name" /></div>
        <div class="field"><span>Role</span><input id="empRole" type="text" placeholder="e.g., Backend Engineer" /></div>
        <div class="field"><span>Team</span><input id="empTeam" type="text" placeholder="e.g., Platform" /></div>
        <div class="field"><span>Location</span><input id="empLoc" type="text" placeholder="e.g., NYC" /></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn" data-close="modalEmployee">Cancel</button>
        <button id="doAddEmp" class="btn primary">Add Employee</button>
      </div>
    </div>
  </div>

  <div id="modalSkill" class="modal" role="dialog" aria-modal="true" aria-label="Add skill">
    <div class="panel">
      <h3>Add Skill / Competency</h3>
      <div class="grid">
        <div class="field"><span>Name</span><input id="skillName" type="text" placeholder="e.g., React" /></div>
        <div class="field"><span>Category</span><input id="skillCat" type="text" placeholder="e.g., Frontend" /></div>
        <div class="field"><span>Critical</span><select id="skillCrit"><option value="false">No</option><option value="true">Yes</option></select></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn" data-close="modalSkill">Cancel</button>
        <button id="doAddSkill" class="btn primary">Add Skill</button>
      </div>
    </div>
  </div>

  <script>
  ;(()=>{
    const KEY = 'esm_v1.0';
    const $ = (q, el=document)=>el.querySelector(q);
    const $$ = (q, el=document)=>Array.from(el.querySelectorAll(q));
    const matrixEl = $('#matrix');

    const State = {
      employees: [],
      skills: [],
      levels: {}, // {skillId: {empId: 0..4}}
      filters: { qSkill:'', qEmp:'', team:'', role:'', critical:false, highlightGaps:false },
      selection: { skill:null, emp:null }
    };

    const Level = [
      {v:0, name:'None', color:'l0'},
      {v:1, name:'Learning', color:'l1'},
      {v:2, name:'Working', color:'l2'},
      {v:3, name:'Proficient', color:'l3'},
      {v:4, name:'Expert', color:'l4'},
    ];

    const uid = p=> p + Math.random().toString(36).slice(2,8);

    function seed(){
      const employees = [
        {id:'e_ava', name:'Ava Patel', role:'Backend Engineer', team:'Platform', location:'NYC'},
        {id:'e_li', name:'Li Wei', role:'Frontend Engineer', team:'Web', location:'Remote'},
        {id:'e_sam', name:'Sam Johnson', role:'Data Scientist', team:'Data', location:'Austin'},
        {id:'e_mia', name:'Mia García', role:'QA Lead', team:'Quality', location:'NYC'},
        {id:'e_omar', name:'Omar Hassan', role:'DevOps Engineer', team:'Infrastructure', location:'Remote'},
        {id:'e_zoe', name:'Zoë Müller', role:'Security Analyst', team:'Security', location:'Berlin'},
        {id:'e_ray', name:'Ray Chen', role:'Product Manager', team:'Product', location:'SF'},
        {id:'e_ana', name:'Ana Souza', role:'Engineering Manager', team:'Platform', location:'NYC'},
      ];
      const skills = [
        {id:'s_java', name:'Java', cat:'Backend', critical:true},
        {id:'s_node', name:'Node.js', cat:'Backend', critical:true},
        {id:'s_react', name:'React', cat:'Frontend', critical:true},
        {id:'s_html', name:'Semantic HTML', cat:'Frontend', critical:false},
        {id:'s_devops', name:'CI/CD', cat:'DevOps', critical:true},
        {id:'s_k8s', name:'Kubernetes', cat:'DevOps', critical:true},
        {id:'s_sql', name:'SQL', cat:'Data', critical:true},
        {id:'s_py', name:'Python', cat:'Data', critical:false},
        {id:'s_testing', name:'Test Automation', cat:'Quality', critical:true},
        {id:'s_sec', name:'AppSec', cat:'Security', critical:true},
        {id:'s_access', name:'Accessibility', cat:'Frontend', critical:false},
        {id:'s_comms', name:'Communication', cat:'Leadership', critical:false},
        {id:'s_hiring', name:'Hiring & Interviewing', cat:'People', critical:false},
        {id:'s_agile', name:'Agile Delivery', cat:'Product', critical:false},
        {id:'s_cloud', name:'Cloud (AWS)', cat:'Infra', critical:true},
      ];
      const L = {};
      for(const s of skills){ L[s.id] = {}; for(const e of employees){ L[s.id][e.id] = 0; }}
      // Curated examples (coverage & gaps)
      set(L,'s_java',{e_ava:4,e_ana:3,e_mia:2});
      set(L,'s_node',{e_ava:3,e_li:2,e_ana:2});
      set(L,'s_react',{e_li:4,e_ray:2,e_mia:2});
      set(L,'s_html',{e_li:3,e_mia:3});
      set(L,'s_devops',{e_omar:4,e_ava:2,e_mia:2});
      set(L,'s_k8s',{e_omar:3,e_ana:2});
      set(L,'s_sql',{e_sam:4,e_ana:2});
      set(L,'s_py',{e_sam:4,e_ava:2});
      set(L,'s_testing',{e_mia:4,e_li:2});
      set(L,'s_sec',{e_zoe:4,e_omar:2});
      set(L,'s_access',{e_li:3,e_mia:2});
      set(L,'s_comms',{e_ray:4,e_ana:4,e_mia:3});
      set(L,'s_hiring',{e_ana:4,e_ray:3});
      set(L,'s_agile',{e_ray:4,e_ana:3});
      set(L,'s_cloud',{e_omar:3,e_ava:2});
      State.employees = employees; State.skills = skills; State.levels = L;
    }
    function set(L, sid, m){ for(const k in m){ L[sid][k] = m[k]; } }

    function save(){ localStorage.setItem(KEY, JSON.stringify({employees:State.employees, skills:State.skills, levels:State.levels})); }
    function load(){ try{ const raw=localStorage.getItem(KEY); if(!raw) return false; const d=JSON.parse(raw); if(!d.employees||!d.skills||!d.levels) return false; State.employees=d.employees; State.skills=d.skills; State.levels=d.levels; return true;}catch(e){return false;} }

    function optDistinct(key){
      const vals = [...new Set(State.employees.map(e=>e[key]).filter(Boolean))].sort();
      return [''].concat(vals);
    }

    function populateFilters(){
      const t = $('#fTeam'); const r=$('#fRole');
      t.innerHTML = optDistinct('team').map(v=>`<option value="${v}">${v||'All'}</option>`).join('');
      r.innerHTML = optDistinct('role').map(v=>`<option value="${v}">${v||'All'}</option>`).join('');
    }

    function filteredEmployees(){
      const q = State.filters.qEmp.toLowerCase();
      return State.employees.filter(e=>
        (!State.filters.team || e.team===State.filters.team) &&
        (!State.filters.role || e.role===State.filters.role) &&
        (q==='' || e.name.toLowerCase().includes(q))
      );
    }
    function filteredSkills(){
      const q = State.filters.qSkill.toLowerCase();
      return State.skills.filter(s=>
        (!State.filters.critical || !!s.critical) &&
        (q==='' || s.name.toLowerCase().includes(q) || (s.cat||'').toLowerCase().includes(q))
      );
    }

    function riskForSkill(sid){
      const L = State.levels[sid]||{}; const prof = Object.values(L).filter(v=>v>=3).length;
      return { singlePoint: prof===1, coverageOK: prof>=2 };
    }

    function computeKPIs(){
      const skills = State.skills.length; const emps = State.employees.length; let gaps=0, covered=0;
      for(const s of State.skills){ const L = State.levels[s.id]||{}; const prof = Object.values(L).filter(v=>v>=3).length; if(prof>=2) covered++; gaps += Object.values(L).filter(v=>v===0).length; }
      const coverage = skills? Math.round((covered/skills)*100):0;
      return {skills, emps, gaps, coverage};
    }

    function renderKPIs(){
      const k = computeKPIs();
      $('#kEmployees').textContent = String(k.emps);
      $('#kSkills').textContent = String(k.skills);
      $('#kCoverage').textContent = k.coverage+"%";
      $('#kGaps').textContent = String(k.gaps);
    }

    function gridTemplate(n){ return `240px repeat(${n}, 138px)`; }

    function employeeHeaderHTML(e){
      const initials = e.name.split(/\s+/).map(p=>p[0]).slice(0,2).join('').toUpperCase();
      return `<div class="emp" title="${e.name} — ${e.role}\n${e.team} · ${e.location}">
        <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(180deg,var(--brand-300),var(--brand-600));color:white;display:flex;align-items:center;justify-content:center;font-weight:800">${initials}</div>
        <div style="display:flex;flex-direction:column;align-items:flex-start">
          <div>${e.name}</div>
          <div class="role">${e.role}</div>
        </div>
      </div>`;
    }

    function skillHeaderHTML(s){
      const r = riskForSkill(s.id);
      return `<div class="skill-name">${s.name}</div>
              <span class="chip" title="Category">${s.cat||'—'}</span>
              ${s.critical?'<span class="chip critical" title="Marked as business-critical">Critical</span>':''}
              <div class="skill-meta">${r.singlePoint?'<span class="risk" title="Only one proficient contributor—single point of failure">\u26A0\uFE0F 1-person coverage</span>':''}</div>`;
    }

    function cellHTML(sid, eid, val){
      const lvl = Level[val||0]; const title = `${lvl.name} (${lvl.v})`;
      const gap = (val===0 && State.filters.highlightGaps) ? 'style="box-shadow:inset 0 0 0 2px var(--err-600);"' : '';
      return `<div role="gridcell" class="cell editable" data-sid="${sid}" data-eid="${eid}" tabindex="0" aria-label="Set proficiency" ${gap}>
        <span class="level ${lvl.color}" title="${title}">${lvl.v}</span>
      </div>`;
    }

    function renderGrid(){
      const emps = filteredEmployees(); const skills = filteredSkills();
      matrixEl.style.gridTemplateColumns = gridTemplate(emps.length);
      const html=[];
      // Corner
      html.push(`<div class="cell header sticky-top sticky-left corner" role="columnheader" aria-label="Skills vs. Employees">Skills</div>`);
      // Employee headers
      for(const e of emps){ html.push(`<div class="cell header employee sticky-top" role="columnheader" data-eid="${e.id}">${employeeHeaderHTML(e)}</div>`); }
      // Rows
      for(const s of skills){
        html.push(`<div class="cell header skill sticky-left" role="rowheader" data-sid="${s.id}">${skillHeaderHTML(s)}</div>`);
        for(const e of emps){ const val = (State.levels[s.id]||{})[e.id]||0; html.push(cellHTML(s.id,e.id,val)); }
      }
      matrixEl.innerHTML = html.join('');
    }

    function selectCell(el){
      $$('.cell.selected', matrixEl).forEach(c=>c.classList.remove('selected'));
      if(el){ el.classList.add('selected'); el.focus(); State.selection = { skill: el.dataset.sid, emp: el.dataset.eid }; }
      else { State.selection={skill:null, emp:null}; }
    }

    function setLevel(sid, eid, val){
      val = Math.max(0, Math.min(4, val|0));
      if(!State.levels[sid]) State.levels[sid] = {};
      State.levels[sid][eid] = val;
    }

    // Event wiring
    function wire(){
      // Filters
      $('#qSkill').addEventListener('input', e=>{ State.filters.qSkill=e.target.value; render(); });
      $('#qEmp').addEventListener('input', e=>{ State.filters.qEmp=e.target.value; render(); });
      $('#fTeam').addEventListener('change', e=>{ State.filters.team=e.target.value; render(); });
      $('#fRole').addEventListener('change', e=>{ State.filters.role=e.target.value; render(); });
      $('#tCritical').addEventListener('change', e=>{ State.filters.critical=e.target.checked; render(); });
      $('#tGaps').addEventListener('change', e=>{ State.filters.highlightGaps=e.target.checked; render(); });

      // Matrix interactions (delegate)
      matrixEl.addEventListener('click', e=>{
        const cell = e.target.closest('.cell.editable');
        if(!cell) {
          const head = e.target.closest('.cell.header.employee');
          if(head){ openDrawer(head.dataset.eid); }
          return;
        }
        const sid = cell.dataset.sid; const eid = cell.dataset.eid;
        const current = (State.levels[sid]||{})[eid]||0;
        const next = e.shiftKey? (current-1+5)%5 : (current+1)%5;
        setLevel(sid, eid, next); save();
        // Update just this cell
        cell.innerHTML = `<span class="level ${Level[next].color}">${next}</span>`;
        selectCell(cell);
        renderKPIs();
      });

      matrixEl.addEventListener('focusin', e=>{
        const cell = e.target.closest('.cell.editable'); if(cell) selectCell(cell);
      });

      // Keyboard navigation + input
      document.addEventListener('keydown', e=>{
        const {skill, emp} = State.selection; if(!skill||!emp) return;
        const emps = filteredEmployees(); const skills = filteredSkills();
        const rIdx = skills.findIndex(s=>s.id===skill); const cIdx = emps.findIndex(x=>x.id===emp);
        if(rIdx<0||cIdx<0) return;
        const move = (ri, ci)=>{
          const sr = skills[Math.max(0, Math.min(skills.length-1, ri))];
          const ce = emps[Math.max(0, Math.min(emps.length-1, ci))];
          const cell = matrixEl.querySelector(`.cell.editable[data-sid="${sr.id}"][data-eid="${ce.id}"]`);
          if(cell) selectCell(cell);
        };
        if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Home','End','PageUp','PageDown','Tab'].includes(e.key)) e.preventDefault();
        if(e.key==='ArrowLeft') move(rIdx, cIdx-1);
        if(e.key==='ArrowRight' || e.key==='Tab') move(rIdx, cIdx+1);
        if(e.key==='ArrowUp') move(rIdx-1, cIdx);
        if(e.key==='ArrowDown') move(rIdx+1, cIdx);
        if(e.key>='0' && e.key<='4'){
          const val = Number(e.key); setLevel(skill, emp, val); save();
          const cell = matrixEl.querySelector(`.cell.editable[data-sid="${skill}"][data-eid="${emp}"]`);
          if(cell) cell.innerHTML = `<span class="level ${Level[val].color}">${val}</span>`; renderKPIs();
        }
      });

      // Add employee
      $('#btnAddEmp').addEventListener('click', ()=>openModal('modalEmployee'));
      $('#doAddEmp').addEventListener('click', ()=>{
        const name=$('#empName').value.trim(); const role=$('#empRole').value.trim(); const team=$('#empTeam').value.trim(); const loc=$('#empLoc').value.trim();
        if(!name) return alert('Please enter a name');
        const e={id:uid('e_'), name, role, team, location:loc}; State.employees.push(e);
        for(const s of State.skills){ if(!State.levels[s.id]) State.levels[s.id]={}; State.levels[s.id][e.id]=0; }
        save(); populateFilters(); closeModal('modalEmployee'); render();
        $('#empName').value=$('#empRole').value=$('#empTeam').value=$('#empLoc').value='';
      });

      // Add skill
      $('#btnAddSkill').addEventListener('click', ()=>openModal('modalSkill'));
      $('#doAddSkill').addEventListener('click', ()=>{
        const name=$('#skillName').value.trim(); const cat=$('#skillCat').value.trim(); const crit=$('#skillCrit').value==='true';
        if(!name) return alert('Please enter a skill name');
        const s={id:uid('s_'), name, cat, critical:crit}; State.skills.push(s); State.levels[s.id] = {};
        for(const e of State.employees){ State.levels[s.id][e.id]=0; }
        save(); closeModal('modalSkill'); render();
        $('#skillName').value=$('#skillCat').value=''; $('#skillCrit').value='false';
      });

      // Export / Import / Print
      $('#btnExport').addEventListener('click', ()=>{
        const data = JSON.stringify({employees:State.employees, skills:State.skills, levels:State.levels}, null, 2);
        const blob = new Blob([data], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        const date = new Date().toISOString().slice(0,10);
        a.download = `skills-matrix-${date}.json`; a.click(); URL.revokeObjectURL(a.href);
      });
      $('#btnImport').addEventListener('click', ()=>openModal('modalImport'));
      $('#doImport').addEventListener('click', ()=>{
        try{
          const obj = JSON.parse($('#importText').value||'');
          if(!obj.employees||!obj.skills||!obj.levels) throw new Error('Invalid format');
          State.employees=obj.employees; State.skills=obj.skills; State.levels=obj.levels; save(); closeModal('modalImport'); populateFilters(); render();
          $('#importText').value='';
        }catch(err){ alert('Could not import: '+err.message); }
      });
      $('#btnPrint').addEventListener('click', ()=>window.print());

      // Modal close buttons
      $$('[data-close]').forEach(b=>b.addEventListener('click', ()=>closeModal(b.getAttribute('data-close'))));

      // Drawer controls
      $('#closeDrawer').addEventListener('click', ()=>$('#drawer').classList.remove('open'));
    }

    function openDrawer(eid){
      const e = State.employees.find(x=>x.id===eid); if(!e) return;
      $('#drawerName').textContent = e.name; $('#drawerRole').textContent = `${e.role||'—'} · ${e.team||'—'}`;
      const items = State.skills.map(s=>{ const v = (State.levels[s.id]||{})[eid]||0; return `<div style="display:flex;align-items:center;gap:8px;justify-content:space-between;margin:6px 0">
        <div><strong>${s.name}</strong><span class="muted"> · ${s.cat||'—'}</span></div>
        <span class="level ${Level[v].color}" title="${Level[v].name}">${v}</span>
      </div>`; }).join('');
      $('#drawerSkills').innerHTML = items || '<div class="muted">No skills yet</div>';
      $('#drawer').classList.add('open');
    }

    function openModal(id){ const m = document.getElementById(id); if(m){ m.classList.add('open'); const input = m.querySelector('input,textarea'); if(input) setTimeout(()=>input.focus(),100); } }
    function closeModal(id){ const m = document.getElementById(id); if(m){ m.classList.remove('open'); }}

    function render(){ renderGrid(); renderKPIs(); }

    // Boot
    (function init(){ if(!load()) seed(); populateFilters(); wire(); render(); })();
  })();
  </script>
</body>
</html>
