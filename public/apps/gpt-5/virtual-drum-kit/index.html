<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Virtual Drum Kit</title>
  <meta name="description" content="Play a studio-themed virtual drum kit with keyboard or touch. Record and playback your beats with a built-in metronome and BPM control."/>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script defer src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <style>
    :root{
      --bg-0:#0b0c12;
      --bg-1:#131524;
      --bg-2:#1b1e33;
      --ink:#e7eaf6;
      --muted:#a6accd;
      --accent:#7c7cff;
      --accent-2:#00d4ff;
      --accent-3:#ff4d97;
      --ok:#34d399;
      --warn:#f59e0b;
      --bad:#ef4444;
      --glass: rgba(255,255,255,0.06);
      --glass-2: rgba(255,255,255,0.1);
      --shadow: 0 8px 30px rgba(0,0,0,.45);
      --glowA: 0 0 0 2px rgba(124,124,255,.35),0 0 18px rgba(124,124,255,.35);
      --glowB: 0 0 0 2px rgba(0,212,255,.35),0 0 18px rgba(0,212,255,.35);
      --glowR: 0 0 0 2px rgba(255,77,151,.35),0 0 22px rgba(255,77,151,.45);

      --c-kick:#7c7cff;
      --c-snare:#00d4ff;
      --c-hat:#ffcf4a;
      --c-ohat:#ffd0a1;
      --c-tom:#66e6c3;
      --c-tom2:#39c6a5;
      --c-clap:#ff7ab6;
      --c-rim:#fb7185;
      --c-ride:#a6b1ff;
      --c-crash:#90cdf4;
      --c-shaker:#7dd3fc;
      --c-cowbell:#fca5a5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Helvetica,Arial,sans-serif;color:var(--ink);
      background: radial-gradient(1200px 600px at 70% -20%, #1f2240, rgba(31,34,64,0) 60%),
                  radial-gradient(900px 600px at -20% 10%, #112a3f, rgba(17,42,63,0) 60%),
                  linear-gradient(180deg, var(--bg-1), var(--bg-0) 60%);
    }
    .app{min-height:100%;display:grid;grid-template-rows:auto auto 1fr auto;gap:14px;padding:18px;max-width:1200px;margin:0 auto;}

    /* Header */
    .topbar{display:flex;align-items:center;gap:16px;justify-content:space-between;padding:12px 16px;border-radius:14px;background:linear-gradient(180deg,var(--glass-2),rgba(255,255,255,0.02));backdrop-filter: blur(8px);box-shadow:var(--shadow), inset 0 1px 0 rgba(255,255,255,0.06);}
    .branding{display:flex;align-items:center;gap:14px}
    .logo{width:44px;height:44px;border-radius:10px;background:radial-gradient(100% 100% at 30% 20%, var(--accent), #3c3ccd 60%), radial-gradient(100% 100% at 60% 80%, var(--accent-2), #046a8f 60%);box-shadow:var(--glowA);position:relative}
    .logo:before,.logo:after{content:'';position:absolute;border-radius:50%;filter:blur(10px);}
    .logo:before{width:10px;height:10px;background:var(--accent-2);left:8px;top:6px;opacity:.8}
    .logo:after{width:8px;height:8px;background:var(--accent-3);right:6px;bottom:8px;opacity:.9}
    h1{margin:0;font-size:clamp(20px,2.2vw,28px);letter-spacing:.4px;font-weight:800}
    .subtitle{color:var(--muted);font-size:12px;margin-top:2px}

    /* Control panel */
    .panel{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;padding:14px;background:linear-gradient(180deg,var(--bg-2),transparent);border-radius:14px;box-shadow:var(--shadow), inset 0 1px 0 rgba(255,255,255,0.06);}
    .control{background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));padding:10px 12px;border-radius:12px;display:flex;align-items:center;gap:10px;justify-content:space-between;border:1px solid rgba(255,255,255,0.08);}
    .control.col2{grid-column:span 2}.control.col3{grid-column:span 3}.control.col4{grid-column:span 4}.control.col6{grid-column:span 6}.control.col12{grid-column:1 / -1}
    .control h3{margin:0;font-size:12px;color:var(--muted);font-weight:600;letter-spacing:.3px}
    .ctrl-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .value{font-variant-numeric:tabular-nums;font-weight:700}

    input[type=range]{-webkit-appearance:none;appearance:none;height:10px;background:rgba(255,255,255,0.08);border-radius:999px;outline:none;width:100%;}
    input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:18px;height:18px;border-radius:50%; background:linear-gradient(180deg,var(--accent),#4c4ce8); box-shadow:var(--glowA); border:0; cursor:pointer;}
    input[type=range]::-moz-range-thumb{ width:18px;height:18px;border-radius:50%; background:linear-gradient(180deg,var(--accent),#4c4ce8); border:none; box-shadow:var(--glowA); cursor:pointer;}
    select,button,.toggle{color:var(--ink);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:8px 10px;font-weight:600}
    select{cursor:pointer}
    button{cursor:pointer;transition:transform .05s ease, box-shadow .2s ease}
    button:active{transform:translateY(1px)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.10),rgba(255,255,255,0.04));border:1px solid rgba(255,255,255,0.08)}
    .btn.primary{box-shadow:var(--glowB)}
    .btn.recording{box-shadow:var(--glowR);background:linear-gradient(180deg,rgba(255,77,151,.16),rgba(255,77,151,.06));}
    .led{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.25);box-shadow:inset 0 0 8px rgba(0,0,0,.6)}
    .led.on{background:radial-gradient(circle at 30% 30%, #ff9ac6, #ff2f7a);box-shadow:0 0 16px #ff4d97}

    /* Pads */
    .pads{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:16px;padding-bottom:8px}
    @media (max-width: 860px){ .pads{grid-template-columns:repeat(3,minmax(0,1fr));} }
    @media (max-width: 620px){ .panel{grid-template-columns:repeat(6,1fr);} .control.col4{grid-column:span 6}.control.col6{grid-column:span 6}.pads{grid-template-columns:repeat(2,minmax(0,1fr));} }
    .pad{position:relative; border-radius:18px; padding:18px; aspect-ratio: 1 / 1; display:flex; flex-direction:column; justify-content:space-between; align-items:stretch; user-select:none; -webkit-tap-highlight-color: transparent; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.09); box-shadow: var(--shadow);}    
    .pad .name{font-size:clamp(14px,1.6vw,18px); font-weight:900; letter-spacing:.3px}
    .pad .kbd{align-self:flex-end; font-weight:800; font-size:12px; color:var(--muted); padding:6px 8px; border-radius:8px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.08);}
    .ring{position:absolute; inset:-2px; border-radius:20px; pointer-events:none; box-shadow: inset 0 0 0 0 rgba(255,255,255,0.0), 0 0 0 0 rgba(0,0,0,0);}
    .pad.active{ transform: translateY(-1px); }
    .pad.active .ring{ animation: glow .22s ease-out; }
    @keyframes glow{ from{ box-shadow: 0 0 0 0 rgba(255,255,255,0), 0 0 0 rgba(0,0,0,0);} to{ box-shadow: 0 0 0 2px rgba(255,255,255,.14), 0 0 26px var(--pad-color);} }

    .pad.kick .ring{--pad-color: rgba(124,124,255,.35);} 
    .pad.snare .ring{--pad-color: rgba(0,212,255,.35);} 
    .pad.hc .ring{--pad-color: rgba(255,207,74,.35);} 
    .pad.ho .ring{--pad-color: rgba(255,208,161,.35);} 
    .pad.tom1 .ring{--pad-color: rgba(102,230,195,.35);} 
    .pad.tom2 .ring{--pad-color: rgba(57,198,165,.35);} 
    .pad.clap .ring{--pad-color: rgba(255,122,182,.40);} 
    .pad.rim .ring{--pad-color: rgba(251,113,133,.38);} 
    .pad.ride .ring{--pad-color: rgba(166,177,255,.35);} 
    .pad.crash .ring{--pad-color: rgba(144,205,244,.35);} 
    .pad.shaker .ring{--pad-color: rgba(125,211,252,.35);} 
    .pad.cowbell .ring{--pad-color: rgba(252,165,165,.35);}    

    /* Footer Help */
    .footer{display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between;color:var(--muted)}
    .kbd-tip{display:flex;gap:8px;align-items:center}
    .kbd-key{padding:6px 8px;border-radius:8px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.08);font-weight:800}
    .sep{opacity:.3}
    .notice{font-size:12px;opacity:.85}

    /* Overlay to unlock audio */
    .overlay{position:fixed;inset:0;background:radial-gradient(80% 60% at 50% 0%, rgba(124,124,255,.12), rgba(0,0,0,.75) 60%), linear-gradient(180deg, rgba(0,0,0,.85), rgba(0,0,0,.9));display:flex;align-items:center;justify-content:center;z-index:30}
    .overlay.hidden{display:none}
    .overlay .card{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:22px 20px;max-width:520px;text-align:center;box-shadow:var(--shadow)}
    .overlay .card .title{font-weight:900;font-size:20px;margin-bottom:8px}
    .overlay .card p{color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="branding">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Virtual Drum Kit</h1>
          <div class="subtitle">Play with keyboard or touch. Record. Loop. Jam.</div>
        </div>
      </div>
      <div class="ctrl-row">
        <button id="helpBtn" class="btn" title="Quick help">‚ùî Help</button>
        <a class="btn" href="#" id="aboutBtn" title="About this app">‚ÑπÔ∏è About</a>
      </div>
    </div>

    <section class="panel" aria-label="Control panel">
      <div class="control col3">
        <h3>BPM</h3>
        <div class="ctrl-row" style="width:100%">
          <input id="bpm" type="range" min="60" max="180" step="1" value="100" aria-label="Tempo (BPM)"/>
          <div class="value"><span id="bpmVal">100</span> bpm</div>
        </div>
      </div>
      <div class="control col3">
        <h3>Quantize</h3>
        <div class="ctrl-row">
          <select id="quantize" aria-label="Quantization">
            <option value="16n" selected>1/16</option>
            <option value="8n">1/8</option>
            <option value="4n">1/4</option>
            <option value="off">Off</option>
          </select>
        </div>
      </div>
      <div class="control col3">
        <h3>Metronome</h3>
        <div class="ctrl-row">
          <div class="led" id="metroLed" aria-hidden="true"></div>
          <button id="metronome" class="btn" title="Toggle metronome">‚è±Ô∏è Toggle</button>
        </div>
      </div>
      <div class="control col3">
        <h3>Master</h3>
        <div class="ctrl-row" style="width:100%">
          <input id="volume" type="range" min="-36" max="0" step="1" value="0" aria-label="Master volume"/>
          <div class="value"><span id="volVal">0</span> dB</div>
        </div>
      </div>
      <div class="control col6">
        <h3>Transport</h3>
        <div class="ctrl-row">
          <button id="record" class="btn" title="Record (R)">
            <span class="led" id="recLed"></span> ‚è∫Ô∏è Record
          </button>
          <button id="play" class="btn primary" title="Play / Pause (Space)">‚ñ∂Ô∏è Play</button>
          <button id="stop" class="btn" title="Stop">‚èπÔ∏è Stop</button>
          <button id="clear" class="btn" title="Clear recording">üßπ Clear</button>
          <label class="toggle btn" title="Loop on playback"><input id="loop" type="checkbox" checked/> Loop</label>
        </div>
      </div>
      <div class="control col6">
        <h3>Recording Length</h3>
        <div class="ctrl-row">
          <select id="bars" aria-label="Number of bars to capture">
            <option value="1">1 bar</option>
            <option value="2" selected>2 bars</option>
            <option value="4">4 bars</option>
            <option value="8">8 bars</option>
          </select>
          <div class="notice">Quantized takes align to selected bars.</div>
        </div>
      </div>
    </section>

    <section class="pads" aria-label="Drum pads">
      <!-- Top row: Cymbals/FX -->
      <button class="pad crash" data-sound="crash" data-key="Q" aria-label="Crash (Q)">
        <div class="name">Crash</div><div class="kbd">Q</div><div class="ring"></div>
      </button>
      <button class="pad ride" data-sound="ride" data-key="W" aria-label="Ride (W)">
        <div class="name">Ride</div><div class="kbd">W</div><div class="ring"></div>
      </button>
      <button class="pad cowbell" data-sound="cowbell" data-key="E" aria-label="Cowbell (E)">
        <div class="name">Cowbell</div><div class="kbd">E</div><div class="ring"></div>
      </button>
      <button class="pad shaker" data-sound="shaker" data-key="R" aria-label="Shaker (R)">
        <div class="name">Shaker</div><div class="kbd">R</div><div class="ring"></div>
      </button>

      <!-- Middle row: Core drums -->
      <button class="pad kick" data-sound="kick" data-key="A" aria-label="Kick (A)">
        <div class="name">Kick</div><div class="kbd">A</div><div class="ring"></div>
      </button>
      <button class="pad snare" data-sound="snare" data-key="S" aria-label="Snare (S)">
        <div class="name">Snare</div><div class="kbd">S</div><div class="ring"></div>
      </button>
      <button class="pad hc" data-sound="hihat-closed" data-key="D" aria-label="Closed Hat (D)">
        <div class="name">Closed Hat</div><div class="kbd">D</div><div class="ring"></div>
      </button>
      <button class="pad ho" data-sound="hihat-open" data-key="F" aria-label="Open Hat (F)">
        <div class="name">Open Hat</div><div class="kbd">F</div><div class="ring"></div>
      </button>

      <!-- Bottom row: Toms/Clap/Rim -->
      <button class="pad tom1" data-sound="tom-low" data-key="Z" aria-label="Tom Low (Z)">
        <div class="name">Tom Low</div><div class="kbd">Z</div><div class="ring"></div>
      </button>
      <button class="pad tom2" data-sound="tom-high" data-key="X" aria-label="Tom High (X)">
        <div class="name">Tom High</div><div class="kbd">X</div><div class="ring"></div>
      </button>
      <button class="pad clap" data-sound="clap" data-key="C" aria-label="Clap (C)">
        <div class="name">Clap</div><div class="kbd">C</div><div class="ring"></div>
      </button>
      <button class="pad rim" data-sound="rim" data-key="V" aria-label="Rimshot (V)">
        <div class="name">Rimshot</div><div class="kbd">V</div><div class="ring"></div>
      </button>
    </section>

    <footer class="footer">
      <div class="kbd-tip">
        <span>Keyboard:</span>
        <span class="kbd-key">Q</span><span>Crash</span> <span class="sep">¬∑</span>
        <span class="kbd-key">W</span><span>Ride</span> <span class="sep">¬∑</span>
        <span class="kbd-key">E</span><span>Cowbell</span> <span class="sep">¬∑</span>
        <span class="kbd-key">R</span><span>Shaker</span> <span class="sep">¬∑</span>
        <span class="kbd-key">A</span><span>Kick</span> <span class="sep">¬∑</span>
        <span class="kbd-key">S</span><span>Snare</span> <span class="sep">¬∑</span>
        <span class="kbd-key">D</span><span>CH</span> <span class="sep">¬∑</span>
        <span class="kbd-key">F</span><span>OH</span> <span class="sep">¬∑</span>
        <span class="kbd-key">Z</span><span>Tom L</span> <span class="sep">¬∑</span>
        <span class="kbd-key">X</span><span>Tom H</span> <span class="sep">¬∑</span>
        <span class="kbd-key">C</span><span>Clap</span> <span class="sep">¬∑</span>
        <span class="kbd-key">V</span><span>Rim</span>
      </div>
      <div class="notice">Shortcuts: Space = Play/Pause ¬∑ R = Record ¬∑ M = Metronome</div>
    </footer>
  </div>

  <!-- Unlock / Help Overlay -->
  <div id="overlay" class="overlay">
    <div class="card">
      <div class="title">Tap to start the studio</div>
      <p>Browsers require a gesture to start audio. Tap anywhere or press a key to unlock. Then play the pads, record your beat, and loop it.</p>
      <div style="margin-top:14px">
        <button id="unlockBtn" class="btn primary">Start Audio</button>
      </div>
    </div>
  </div>

  <script>
  (() => {
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const state = {
      recording: false,
      playing: false,
      loop: true,
      quantize: '16n',
      bars: 2,
      bpm: 100,
      steps: [], // for quantized recording: array of {step, sound}
      events: [], // for free recording: array of {timeSec, sound}
      part: null,
      metronomeOn: false,
      unlocked: false,
    };

    // Elements
    const el = {
      overlay: $('#overlay'),
      unlockBtn: $('#unlockBtn'),
      bpm: $('#bpm'),
      bpmVal: $('#bpmVal'),
      quantize: $('#quantize'),
      bars: $('#bars'),
      volume: $('#volume'),
      volVal: $('#volVal'),
      record: $('#record'),
      recLed: $('#recLed'),
      play: $('#play'),
      stop: $('#stop'),
      clear: $('#clear'),
      loop: $('#loop'),
      pads: $$('.pad'),
      metronomeBtn: $('#metronome'),
      metroLed: $('#metroLed'),
      helpBtn: $('#helpBtn'),
      aboutBtn: $('#aboutBtn'),
    };

    // Tone.js setup
    const ToneReady = new Promise(resolve => {
      const check = () => { if (window.Tone) resolve(window.Tone); else setTimeout(check, 10); };
      check();
    });

    let DrumKit = null; // will hold our drum engine instance
    let metroLoop = null;
    let masterVol = null;
    let mainBus = null;

    function padActiveAnimation(padEl){
      padEl.classList.add('active');
      clearTimeout(padEl._t);
      padEl._t = setTimeout(() => padEl.classList.remove('active'), 160);
    }

    function computeStepsPerBar(q){
      if(q === 'off') return 0;
      const map = { '4n': 4, '8n': 8, '16n': 16 };
      return map[q] || 16;
    }

    function toTransportTimeFromSteps(stepIndex, q){
      const stepsPerBar = computeStepsPerBar(q);
      const stepsPerBeat = stepsPerBar / 4;
      const bars = Math.floor(stepIndex / stepsPerBar);
      const within = stepIndex % stepsPerBar;
      const beats = Math.floor(within / stepsPerBeat);
      const remainder = within % stepsPerBeat;
      const sixteenths = Math.round(remainder * (16 / stepsPerBar));
      return `${bars}:${beats}:${sixteenths}`;
    }

    function nearestStep(seconds, q){
      const Tone = window.Tone;
      const secPerStep = Tone.Time(q).toSeconds();
      return Math.round(seconds / secPerStep);
    }

    function lengthInBarsFromRecording(){
      // For quantized: clamp to selected bars. For free: derive from last event, snapped up to a bar.
      if(state.quantize !== 'off'){
        return state.bars;
      } else {
        const Tone = window.Tone;
        const last = state.events.length ? Math.max(...state.events.map(e => e.timeSec)) : 0;
        const oneBar = Tone.Time('1m').toSeconds();
        const bars = Math.max(1, Math.ceil(last / oneBar));
        return bars;
      }
    }

    class DrumEngine {
      constructor(){
        const Tone = window.Tone;
        mainBus = new Tone.Gain(1);
        const comp = new Tone.Compressor(-10, 3).connect(mainBus);
        const rev = new Tone.Reverb({ decay: 2.2, wet: 0.18, preDelay: 0.02 }).toDestination();
        masterVol = new Tone.Volume(0).toDestination();
        mainBus.connect(masterVol);

        // Send helper
        const send = (node, amt=0.18) => { const g = new Tone.Gain(amt).connect(rev); node.connect(g); };

        // Kick
        this.kick = new Tone.MembraneSynth({
          pitchDecay: 0.03, octaves: 10,
          oscillator: { type: 'sine' },
          envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.0 }
        });
        this.kick.connect(comp);

        // Snare: noise + body
        this.snareNoiseFilter = new Tone.Filter(1800, 'highpass');
        this.snareNoise = new Tone.NoiseSynth({
          noise: { type:'white' },
          envelope:{ attack:0.001, decay:0.18, sustain:0, release:0.02 }
        }).connect(this.snareNoiseFilter);
        this.snareTone = new Tone.MembraneSynth({
          pitchDecay: 0.01, octaves: 2, oscillator:{type:'triangle'},
          envelope:{ attack:0.001, decay:0.08, sustain:0, release:0.02 }
        });
        this.snareMixer = new Tone.Gain(0.9);
        this.snareNoiseFilter.connect(this.snareMixer);
        this.snareTone.connect(this.snareMixer);
        this.snareMixer.connect(comp);

        // Hats + Cymbals
        const metalCommon = { harmonicity:5.1, resonance:4000, modulationIndex:32, octaves:1.5 };
        this.hc = new Tone.MetalSynth({ ...metalCommon, frequency: 650, envelope:{attack:0.001, decay:0.10, release:0.01}, volume:-8 });
        this.ho = new Tone.MetalSynth({ ...metalCommon, frequency: 520, envelope:{attack:0.001, decay:0.6, release:0.1}, volume:-10 });
        this.ride = new Tone.MetalSynth({ ...metalCommon, frequency: 450, envelope:{attack:0.001, decay:2.2, release:0.4}, volume:-12 });
        this.crash = new Tone.MetalSynth({ ...metalCommon, frequency: 300, envelope:{attack:0.001, decay:3.2, release:0.6}, volume:-10 });
        [this.hc,this.ho,this.ride,this.crash].forEach(n=>{n.connect(comp); send(n, 0.22);});

        // Toms
        this.tomL = new Tone.MembraneSynth({
          pitchDecay:0.08, octaves:3.5, envelope:{attack:0.001, decay:0.5, sustain:0.0, release:0.4}
        });
        this.tomH = new Tone.MembraneSynth({
          pitchDecay:0.06, octaves:4, envelope:{attack:0.001, decay:0.42, sustain:0.0, release:0.35}
        });
        [this.tomL, this.tomH].forEach(n=>{n.connect(comp); send(n, 0.12);});

        // Clap (multi-burst noise)
        this.clap = new Tone.NoiseSynth({
          noise:{ type:'white' },
          envelope:{ attack:0.001, decay:0.25, sustain:0, release:0.02 }
        });
        this.clapFilter = new Tone.Filter(800, 'highpass').connect(comp);
        this.clap.connect(this.clapFilter); send(this.clapFilter, 0.16);

        // Rimshot
        this.rim = new Tone.MetalSynth({ ...metalCommon, frequency:1200, envelope:{attack:0.0005, decay:0.06, release:0.01}, volume:-6 });
        this.rim.connect(comp);

        // Shaker
        this.shaker = new Tone.NoiseSynth({ noise:{type:'pink'}, envelope:{attack:0.001, decay:0.08, sustain:0, release:0.02} });
        this.shakerFilter = new Tone.Filter(5000, 'highpass').connect(comp);
        this.shaker.connect(this.shakerFilter);

        // Cowbell (FM-ish)
        this.cow = new Tone.FMSynth({
          harmonicity: 5, modulationIndex: 10,
          oscillator: { type:'square' },
          envelope: { attack:0.001, decay:0.15, sustain:0, release:0.05 },
          modulation: { type:'square' },
          modulationEnvelope: { attack:0.001, decay:0.05, sustain:0, release:0.01 }
        });
        this.cow.connect(comp);

        // Metronome
        this.metro = new Tone.MembraneSynth({ pitchDecay:0.01, octaves:8, envelope:{attack:0.001, decay:0.05, sustain:0, release:0.02} }).toDestination();
      }
      trigger(sound, time){
        const T = window.Tone;
        const t = time ?? T.now();
        switch(sound){
          case 'kick': this.kick.triggerAttackRelease('C1', '8n', t); break;
          case 'snare':
            this.snareNoise.triggerAttackRelease('8n', t);
            this.snareTone.triggerAttackRelease('D3', '16n', t+0.002);
            break;
          case 'hihat-closed': this.hc.triggerAttackRelease('16n', t); break;
          case 'hihat-open': this.ho.triggerAttackRelease('8n', t); break;
          case 'tom-low': this.tomL.triggerAttackRelease('A2', '8n', t); break;
          case 'tom-high': this.tomH.triggerAttackRelease('D3', '8n', t); break;
          case 'clap':
            this.clap.triggerAttackRelease('16n', t);
            this.clap.triggerAttackRelease('16n', t+0.013);
            this.clap.triggerAttackRelease('16n', t+0.026);
            break;
          case 'rim': this.rim.triggerAttackRelease('32n', t); break;
          case 'ride': this.ride.triggerAttackRelease('2n', t); break;
          case 'crash': this.crash.triggerAttackRelease('1n', t); break;
          case 'shaker': this.shaker.triggerAttackRelease('32n', t); break;
          case 'cowbell': this.cow.triggerAttackRelease('E5', '16n', t); break;
        }
      }
      setVolume(db){ masterVol.volume.value = db; }
      tick(accent=false){ this.metro.triggerAttackRelease(accent ? 'G4' : 'E4', accent ? '16n' : '32n'); }
    }

    function updateBPM(val){
      const Tone = window.Tone;
      state.bpm = parseInt(val,10);
      Tone.Transport.bpm.rampTo(state.bpm, 0.05);
      el.bpmVal.textContent = state.bpm;
    }

    function updateVolume(db){
      state.volume = parseInt(db,10);
      if(masterVol){ masterVol.volume.value = db; }
      el.volVal.textContent = db;
    }

    function setupMetronome(){
      const Tone = window.Tone;
      if(metroLoop){ metroLoop.dispose(); metroLoop = null; }
      let beat = 0;
      metroLoop = new Tone.Loop(time => {
        const accent = (beat % 4) === 0;
        DrumKit.tick(accent);
        el.metroLed.classList.add('on');
        setTimeout(()=>el.metroLed.classList.remove('on'), 80);
        beat++;
      }, '4n');
      if(state.metronomeOn){ metroLoop.start(0); }
    }

    function buildPartFromRecording(){
      const Tone = window.Tone;
      if(state.part){ state.part.dispose(); state.part = null; }
      const events = [];
      if(state.quantize !== 'off'){
        const stepsPerBar = computeStepsPerBar(state.quantize);
        const totalSteps = state.bars * stepsPerBar;
        // collapse duplicates at same step keeping last
        const byStep = new Map();
        state.steps.forEach(ev => { byStep.set(ev.step + ':' + ev.sound, ev); });
        const uniqueSteps = Array.from(byStep.values());
        uniqueSteps.forEach(({step, sound}) => {
          const tt = toTransportTimeFromSteps(step % totalSteps, state.quantize);
          events.push({ time: tt, sound });
        });
      } else {
        // free timing: convert seconds to transport times at current bpm
        state.events.forEach(({timeSec, sound}) => {
          const tt = Tone.Time(timeSec).toBarsBeatsSixteenths();
          events.push({ time: tt, sound });
        });
      }
      state.part = new Tone.Part((time, ev) => {
        const pad = document.querySelector('.pad[data-sound="' + ev.sound + '"]');
        if(pad) padActiveAnimation(pad);
        DrumKit.trigger(ev.sound, time);
      }, events);
      state.part.loop = state.loop;
      state.part.loopEnd = state.quantize !== 'off' ? `${state.bars}:0:0` : `${lengthInBarsFromRecording()}:0:0`;
    }

    function startPlayback(){
      if(!state.part) buildPartFromRecording();
      if(!state.part) return;
      state.part.start(0);
      window.Tone.Transport.start();
      state.playing = true;
      el.play.textContent = '‚è∏Ô∏è Pause';
    }
    function pausePlayback(){
      window.Tone.Transport.pause();
      state.playing = false;
      el.play.textContent = '‚ñ∂Ô∏è Play';
    }
    function stopPlayback(){
      window.Tone.Transport.stop();
      state.playing = false;
      el.play.textContent = '‚ñ∂Ô∏è Play';
    }

    function startRecording(){
      const Tone = window.Tone;
      state.steps = [];
      state.events = [];
      state.recording = true;
      el.record.classList.add('recording');
      el.recLed.classList.add('on');
      Tone.Transport.position = '0:0:0';
      if(!Tone.Transport.state || Tone.Transport.state !== 'started'){ Tone.Transport.start(); }
      if(state.metronomeOn && metroLoop && metroLoop.state !== 'started'){ metroLoop.start(0); }
    }
    function stopRecording(){
      state.recording = false;
      el.record.classList.remove('recording');
      el.recLed.classList.remove('on');
      buildPartFromRecording();
    }

    function clearRecording(){
      state.steps = [];
      state.events = [];
      if(state.part){ state.part.dispose(); state.part = null; }
    }

    function onTrigger(sound){
      if(!state.unlocked) return;
      const Tone = window.Tone;
      const pad = document.querySelector('.pad[data-sound="' + sound + '"]');
      if(pad) padActiveAnimation(pad);
      DrumKit.trigger(sound);
      if(state.recording){
        if(state.quantize !== 'off'){
          const sec = Tone.Transport.seconds; // position since we reset to 0 on record
          const step = nearestStep(sec, state.quantize);
          const stepsPerBar = computeStepsPerBar(state.quantize);
          const maxSteps = state.bars * stepsPerBar;
          const clamped = ((step % maxSteps) + maxSteps) % maxSteps;
          state.steps.push({ step: clamped, sound });
        } else {
          state.events.push({ timeSec: Tone.Transport.seconds, sound });
        }
      }
    }

    function wireUI(){
      // Pads
      el.pads.forEach(p => p.addEventListener('pointerdown', () => onTrigger(p.dataset.sound)));
      // Keyboard
      window.addEventListener('keydown', (e) => {
        if(!state.unlocked) return;
        const tag = document.activeElement && document.activeElement.tagName; if(tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA') return;
        const k = (e.key || '').toUpperCase();
        if(k === ' '){ e.preventDefault(); state.playing ? pausePlayback() : startPlayback(); return; }
        if(k === 'R'){ e.preventDefault(); state.recording ? stopRecording() : startRecording(); return; }
        if(k === 'M'){ e.preventDefault(); toggleMetronome(); return; }
        const pad = el.pads.find(p => p.dataset.key === k);
        if(pad){ e.preventDefault(); onTrigger(pad.dataset.sound); }
      });

      // Controls
      el.bpm.addEventListener('input', e => updateBPM(e.target.value));
      el.volume.addEventListener('input', e => updateVolume(e.target.value));
      el.quantize.addEventListener('change', e => { state.quantize = e.target.value; buildPartFromRecording(); });
      el.bars.addEventListener('change', e => { state.bars = parseInt(e.target.value,10); buildPartFromRecording(); });
      el.loop.addEventListener('change', e => { state.loop = !!e.target.checked; if(state.part) state.part.loop = state.loop; });
      el.play.addEventListener('click', () => state.playing ? pausePlayback() : startPlayback());
      el.stop.addEventListener('click', stopPlayback);
      el.record.addEventListener('click', () => state.recording ? stopRecording() : startRecording());
      el.clear.addEventListener('click', () => { stopPlayback(); clearRecording(); });
      el.metronomeBtn.addEventListener('click', toggleMetronome);
      el.aboutBtn.addEventListener('click', (e)=>{e.preventDefault(); alert('Virtual Drum Kit ‚Äî browser-based studio with Tone.js.\n\nPlay with your keyboard or touch. Record quantized or free, loop playback, and tweak BPM. Built as a single self-contained HTML file.');});
      el.helpBtn.addEventListener('click', ()=>alert('Controls:\n- Tap pads or use keys shown.\n- Space: Play/Pause, R: Record, M: Metronome.\n- Adjust BPM, Quantize, Bars, and Loop in the panel.\n- Recording is time-aligned when Quantize is on.'));
    }

    function toggleMetronome(){
      const Tone = window.Tone;
      state.metronomeOn = !state.metronomeOn;
      if(state.metronomeOn){
        if(metroLoop && metroLoop.state !== 'started'){ metroLoop.start(0); }
        if(Tone.Transport.state !== 'started'){ Tone.Transport.start(); }
      } else { if(metroLoop) metroLoop.stop(0); }
    }

    function unlockAudio(){
      if(state.unlocked) return;
      Tone.start().then(() => {
        state.unlocked = true;
        el.overlay.classList.add('hidden');
      });
    }

    async function init(){
      await ToneReady;
      DrumKit = new DrumEngine();
      updateBPM(el.bpm.value);
      updateVolume(el.volume.value);
      setupMetronome();
      wireUI();

      // Overlay unlockers
      el.unlockBtn.addEventListener('click', unlockAudio);
      el.overlay.addEventListener('click', unlockAudio);
      window.addEventListener('keydown', unlockAudio, { once: true });

      // Ensure Tone.Transport reflects UI loop state
      state.loop = !!el.loop.checked;
    }

    // kick it off
    init();
  })();
  </script>
</body>
</html>
