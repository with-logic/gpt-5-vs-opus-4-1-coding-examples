<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Math Practice Drills</title>
  <meta name="description" content="Timed math quizzes with difficulty settings and score tracking." />
  <style>
    :root{
      --bg: #0b1020;
      --panel: #121a33;
      --panel-2:#0e1530;
      --fg: #eef3ff;
      --muted:#aab8e6;
      --accent:#7c9cff;
      --good:#2ecc71;
      --bad:#ff5d73;
      --warn:#ffbe3b;
      --ring:#4b67ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f5f7ff;
        --panel: #ffffff;
        --panel-2:#eef2ff;
        --fg: #0b1020;
        --muted:#5a6aa6;
        --accent:#3655ff;
        --good:#1f9d57;
        --bad:#e23c53;
        --warn:#d48a00;
        --ring:#3655ff;
        --shadow: 0 8px 20px rgba(0,0,0,.12);
      }
    }
    html, body {height:100%;}
    * { box-sizing: border-box; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 800px at 10% -10%, #20284a 0%, transparent 60%),
                  radial-gradient(1200px 800px at 120% 10%, #1a2350 0%, transparent 55%),
                  var(--bg);
      color:var(--fg);
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    .container{ max-width: 1100px; margin: 0 auto; padding: 24px; }
    h1{ margin: 0; font-size: clamp(28px, 3.6vw, 44px); letter-spacing: .5px; }
    .sub{ color: var(--muted); font-size: 14px; }

    /* Layout */
    .grid{
      display: grid; gap: 16px; margin-top: 18px;
      grid-template-columns: 1.1fr 1.2fr;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    .card{ background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
           border: 1px solid rgba(255,255,255,.06); border-radius: 14px; box-shadow: var(--shadow); }
    .card .pad{ padding: 18px 18px 16px; }

    .row{ display:flex; align-items:center; gap:12px; flex-wrap: wrap; }
    .row > * { flex: 0 0 auto; }

    /* Controls */
    label{ font-size: 13px; color: var(--muted); display:block; margin-bottom:6px; }
    select, input[type="number"], input[type="text"]{
      background: #0c1430; color: var(--fg); border:1px solid #2b3a74; border-radius: 10px; padding: 10px 12px; font-size: 16px; outline: none;
    }
    @media (prefers-color-scheme: light){
      select, input[type="number"], input[type="text"]{ background:#fff; color:var(--fg); border-color:#d5dbff; }
    }
    .control{ min-width: 150px; }
    .small{ font-size: 12px; color: var(--muted); }

    .btn{
      appearance:none; border:none; background:linear-gradient(180deg, var(--accent), #223cff); color:#fff;
      padding: 12px 16px; border-radius: 12px; font-weight: 700; letter-spacing: .2px; font-size: 16px; cursor:pointer;
      box-shadow: 0 8px 24px rgba(60,90,255,.35), inset 0 1px 0 rgba(255,255,255,.25);
      transition: transform .05s ease, filter .15s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.995); }
    .btn.secondary{ background: #0f1a40; color: #d5ddff; border:1px solid #2b3a74; box-shadow:none; }
    .btn.ghost{ background: transparent; border:1px solid #2b3a74; color:#cfe0ff; box-shadow: none; }
    .btn.block{ width:100%; }

    /* Timer ring */
    .timer{ --p: 0; position: relative; width: 210px; height: 210px; flex: 0 0 auto; }
    .ring{
      position:absolute; inset:0; border-radius:50%; background:
        conic-gradient(var(--ring) calc(var(--p) * 1%), rgba(255,255,255,.08) 0);
      display:grid; place-items:center;
      box-shadow: inset 0 0 0 8px rgba(255,255,255,.06), 0 10px 40px rgba(0,0,0,.35);
    }
    .ring::after{ content:""; width: calc(100% - 28px); height: calc(100% - 28px); border-radius:50%; background:
        radial-gradient(80px 60px at 30% 20%, rgba(255,255,255,.08), transparent),
        linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
                   border: 1px solid rgba(255,255,255,.06);
    }
    .time{ position: absolute; inset:0; display:grid; place-items:center; font-variant-numeric: tabular-nums; }
    .time .big{ font-size: 44px; font-weight: 800; letter-spacing: .4px; }
    .time .label{ color:var(--muted); font-size: 12px; margin-top: -4px; }

    .stats{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    @media (max-width: 520px){ .stats{ grid-template-columns: repeat(2, 1fr);} }
    .stat{ background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 12px; padding: 10px 12px; }
    .stat .v{ font-size: 22px; font-weight: 800; }
    .stat .k{ font-size: 12px; color: var(--muted); }

    /* Quiz panel */
    .quiz{ display:flex; gap: 18px; align-items:center; justify-content: center; min-height: 250px; }
    .problem{ font-size: clamp(38px, 6vw, 72px); font-weight: 800; letter-spacing: .6px; display:flex; align-items:center; gap: 18px; }
    .problem .op{ color:#a7b7ff; }
    .answer{ font-size: clamp(34px, 5vw, 52px); width: 240px; text-align:center; }

    .kbd{ display:inline-block; min-width:40px; padding:4px 8px; background:#0e1530; border:1px solid #2b3a74; border-bottom-width:3px; border-radius:8px; text-align:center; }

    /* Numeric keypad (mobile friendly) */
    .keypad{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-top: 8px; }
    .keypad .key{ padding: 12px 8px; border-radius: 10px; background:#0f1a40; border: 1px solid #2b3a74; color:#dbe6ff; font-weight:700; font-size:18px; }

    /* Footer / History */
    .history{ display:grid; gap:10px; }
    .rowline{ display:flex; justify-content: space-between; gap: 12px; padding: 10px 0; border-bottom:1px dashed rgba(255,255,255,.08); }
    .tag{ display:inline-block; padding:3px 8px; border-radius: 999px; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); font-size: 12px; }

    /* Result modal */
    .modal{ position: fixed; inset: 0; display:none; place-items: center; background: rgba(0,0,20,.62); backdrop-filter: blur(4px); }
    .modal.show{ display:grid; }

    /* Alerts */
    .flash{ position: fixed; inset-inline: 0; top: 10px; display:flex; justify-content:center; pointer-events:none; }
    .flash .pill{ background: rgba(20,255,160,.15); border: 1px solid rgba(20,255,160,.35); color:#d2ffeb; padding: 8px 12px; border-radius:999px; font-weight:700; text-shadow: 0 1px 0 rgba(0,0,0,.4); }
    .flash.bad .pill{ background: rgba(255,60,100,.18); border-color: rgba(255,60,100,.45); color: #ffe1e8; }

    .invis{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="Math Practice Drills">
    <header class="row" style="justify-content: space-between; align-items: flex-end; gap:8px;">
      <div>
        <h1>Math Practice Drills</h1>
        <div class="sub">Improve speed and accuracy with focused, timed drills.</div>
      </div>
      <div class="row" style="gap:8px;">
        <button id="resetStats" class="btn ghost" title="Clear saved history">Reset Stats</button>
        <button id="themeToggle" class="btn secondary" title="Toggle theme">Theme</button>
      </div>
    </header>

    <section class="grid" aria-live="polite">
      <!-- Left: Controls + Timer + Stats -->
      <div class="card">
        <div class="pad" style="display: grid; gap: 14px;">
          <div class="row" style="gap:14px; align-items:flex-end; flex-wrap: wrap;">
            <div class="control">
              <label for="op">Problem Type</label>
              <select id="op" aria-label="Problem type">
                <option value="mixed">Mixed</option>
                <option value="add">Addition</option>
                <option value="sub">Subtraction</option>
                <option value="mul">Multiplication</option>
                <option value="div">Division</option>
              </select>
            </div>
            <div class="control">
              <label for="difficulty">Difficulty</label>
              <select id="difficulty" aria-label="Difficulty">
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div class="control">
              <label for="duration">Time Limit</label>
              <select id="duration" aria-label="Time limit">
                <option value="30">30 sec</option>
                <option value="60" selected>60 sec</option>
                <option value="120">2 min</option>
                <option value="300">5 min</option>
              </select>
            </div>
            <div class="control" id="customBox" style="display:none; min-width: 300px;">
              <label>Custom Range</label>
              <div class="row" style="gap:8px; align-items: center;">
                <span class="small">A:</span>
                <input id="aMin" type="number" value="0" min="-999" max="999" style="width:88px;"/>
                <span class="small">to</span>
                <input id="aMax" type="number" value="12" min="-999" max="999" style="width:88px;"/>
                <span class="small">B:</span>
                <input id="bMin" type="number" value="0" min="-999" max="999" style="width:88px;"/>
                <span class="small">to</span>
                <input id="bMax" type="number" value="12" min="-999" max="999" style="width:88px;"/>
                <label class="small" style="margin-left:8px; display:flex; align-items:center; gap:6px;">
                  <input id="allowNegative" type="checkbox"/> allow negatives
                </label>
              </div>
            </div>
            <div class="row" style="gap:8px;">
              <button id="startBtn" class="btn" aria-label="Start quiz">Start</button>
              <button id="stopBtn" class="btn secondary" disabled>Stop</button>
            </div>
          </div>

          <div class="row" style="align-items: stretch; gap: 18px;">
            <div class="timer" aria-hidden="true">
              <div class="ring" id="ring"></div>
              <div class="time">
                <div class="big" id="clock">00:00</div>
                <div class="label">Time Left</div>
              </div>
            </div>
            <div style="flex:1; display:grid; gap: 12px;">
              <div class="stats">
                <div class="stat"><div class="v" id="sCorrect">0</div><div class="k">Correct</div></div>
                <div class="stat"><div class="v" id="sWrong">0</div><div class="k">Wrong</div></div>
                <div class="stat"><div class="v" id="sAcc">0%</div><div class="k">Accuracy</div></div>
                <div class="stat"><div class="v" id="sStreak">0</div><div class="k">Streak</div></div>
                <div class="stat"><div class="v" id="sRate">0/min</div><div class="k">Speed</div></div>
                <div class="stat"><div class="v" id="sAvg">–</div><div class="k">Avg Time</div></div>
              </div>
              <div class="small">Tip: Type answer and press <span class="kbd">Enter</span>. Use
                <span class="kbd">Tab</span> to focus input quickly.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Quiz Area -->
      <div class="card" id="quizCard" aria-live="assertive">
        <div class="pad">
          <div id="preQuiz" style="display:grid; gap:12px;">
            <div style="font-size: 18px; color: var(--muted);">Ready to sharpen your skills?</div>
            <div class="row" style="gap:10px; flex-wrap: wrap;">
              <div class="tag">Minimal UI</div>
              <div class="tag">Large, legible text</div>
              <div class="tag">Timed drills</div>
              <div class="tag">Difficulty presets</div>
              <div class="tag">Score tracker</div>
            </div>
            <button class="btn" id="quickStart">Quick Start 60s Mixed</button>
          </div>

          <div id="quiz" class="quiz" style="display:none;">
            <div class="problem">
              <div id="pA">12</div>
              <div class="op" id="pOp">×</div>
              <div id="pB">9</div>
              <div>=</div>
              <input id="answer" class="answer" type="text" inputmode="numeric" autocomplete="off" aria-label="Your answer"/>
            </div>
          </div>

          <div id="postQuiz" style="display:none;">
            <h2 style="margin:0 0 10px; font-size: 24px;">Great work!</h2>
            <div class="row" style="gap:8px; flex-wrap: wrap;">
              <div class="tag" id="sumLabel">Summary</div>
              <div class="tag" id="sumTag"></div>
            </div>
            <div class="row" style="gap: 18px; align-items:stretch; margin-top:8px;">
              <div style="flex:1;">
                <canvas id="chart" width="600" height="200" style="width:100%; height: 200px; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius: 10px;"></canvas>
                <div class="small">Answer time per question (lower is faster)</div>
              </div>
              <div style="width: 260px; display:grid; gap:8px;">
                <button class="btn block" id="retryBtn">Retry Same Settings</button>
                <button class="btn block secondary" id="changeBtn">Change Settings</button>
                <button class="btn block ghost" id="reviewBtn">Review Mistakes</button>
              </div>
            </div>
            <div id="mistakes" style="display:none; margin-top: 10px;">
              <h3 style="margin: 6px 0 6px; font-size: 18px;">Mistakes to review</h3>
              <div id="mistakesList" class="history"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top: 16px;">
      <div class="pad">
        <div class="row" style="justify-content: space-between; align-items: baseline;">
          <h2 style="margin:0; font-size: 20px;">Session History</h2>
          <div class="small">Stored locally on this device</div>
        </div>
        <div id="history" class="history" aria-live="polite"></div>
      </div>
    </section>
  </div>

  <div class="flash" id="flash" aria-live="assertive" aria-atomic="true" role="status" style="display:none;">
    <div class="pill" id="flashText">Nice!</div>
  </div>

  <div class="modal" id="modal">
    <div class="card" style="width:min(720px, 92vw);">
      <div class="pad" style="display:grid; gap:10px;">
        <h2 style="margin:0; font-size: 22px;">Results</h2>
        <div class="stats">
          <div class="stat"><div class="v" id="mCorrect">0</div><div class="k">Correct</div></div>
          <div class="stat"><div class="v" id="mWrong">0</div><div class="k">Wrong</div></div>
          <div class="stat"><div class="v" id="mAcc">0%</div><div class="k">Accuracy</div></div>
          <div class="stat"><div class="v" id="mRate">0/min</div><div class="k">Speed</div></div>
          <div class="stat"><div class="v" id="mAvg">–</div><div class="k">Avg Time</div></div>
          <div class="stat"><div class="v" id="mStreak">0</div><div class="k">Best Streak</div></div>
        </div>
        <div class="row" style="justify-content:flex-end; gap:8px;">
          <button class="btn ghost" id="closeModal">Close</button>
          <button class="btn" id="modalRetry">Retry</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (()=>{
    const $ = (id)=> document.getElementById(id);
    const els = {
      op: $('op'), difficulty: $('difficulty'), duration: $('duration'),
      aMin: $('aMin'), aMax: $('aMax'), bMin: $('bMin'), bMax: $('bMax'), allowNegative: $('allowNegative'),
      start: $('startBtn'), stop: $('stopBtn'), quickStart: $('quickStart'),
      preQuiz: $('preQuiz'), quiz: $('quiz'), postQuiz: $('postQuiz'),
      pA: $('pA'), pB: $('pB'), pOp: $('pOp'), ans: $('answer'),
      ring: $('ring'), clock: $('clock'),
      sCorrect: $('sCorrect'), sWrong: $('sWrong'), sAcc: $('sAcc'), sStreak: $('sStreak'), sRate: $('sRate'), sAvg: $('sAvg'),
      chart: $('chart'), mistakes: $('mistakes'), mistakesList: $('mistakesList'), reviewBtn: $('reviewBtn'),
      retryBtn: $('retryBtn'), changeBtn: $('changeBtn'),
      sumLabel: $('sumLabel'), sumTag: $('sumTag'),
      history: $('history'), resetStats: $('resetStats'), theme: $('themeToggle'),
      modal: $('modal'), mCorrect: $('mCorrect'), mWrong: $('mWrong'), mAcc: $('mAcc'), mRate: $('mRate'), mAvg: $('mAvg'), mStreak: $('mStreak'), closeModal: $('closeModal'), modalRetry: $('modalRetry'),
      flash: $('flash'), flashText: $('flashText'),
      quizCard: $('quizCard'), customBox: $('customBox')
    };

    const OPER = {
      add:{ sym:'+', fn:(a,b)=>a+b },
      sub:{ sym:'−', fn:(a,b)=>a-b },
      mul:{ sym:'×', fn:(a,b)=>a*b },
      div:{ sym:'÷', fn:(a,b)=>a/b },
    };

    const PRESETS = {
      easy:  { a:[0,10], b:[0,10], ops:['add','sub'], allowNeg:false },
      medium:{ a:[2,50], b:[1,12], ops:['add','sub','mul'], allowNeg:true },
      hard:  { a:[4,99], b:[2,20], ops:['add','sub','mul','div'], allowNeg:true },
    };

    const state = {
      running:false,
      startTime:0, endTime:0, duration:60, remaining:60, tickH:null,
      current:null,
      stats:{ correct:0, wrong:0, streak:0, bestStreak:0, times:[], mistakes:[] },
      settings:{ op:'mixed', difficulty:'easy', a:[0,10], b:[0,10], allowNeg:false }
    };

    // Utils
    const clamp=(x,min,max)=> Math.max(min, Math.min(max, x));
    const rnd=(min,max)=> Math.floor(Math.random()*(max-min+1))+min;
    const choice=(arr)=> arr[Math.floor(Math.random()*arr.length)];
    const fmt=(s)=>{
      s = Math.max(0, Math.round(s));
      const m = Math.floor(s/60).toString().padStart(2,'0');
      const r = (s%60).toString().padStart(2,'0');
      return `${m}:${r}`;
    };

    function setTimerProgress(){
      const p = state.duration===0 ? 0 : Math.max(0, (state.remaining/state.duration))*100;
      els.ring.style.setProperty('--p', p.toFixed(2));
      els.clock.textContent = fmt(state.remaining);
    }

    function flash(msg, good=true){
      els.flashText.textContent = msg; els.flash.classList.toggle('bad', !good);
      els.flash.style.display = 'flex';
      clearTimeout(els.flash._t);
      els.flash._t = setTimeout(()=> els.flash.style.display='none', 900);
    }

    function pickSettings(){
      const d = els.difficulty.value;
      let s = PRESETS[d] ? {...PRESETS[d]} : { a:[+els.aMin.value||0,+els.aMax.value||10], b:[+els.bMin.value||0,+els.bMax.value||10], ops:['add','sub','mul','div'], allowNeg: !!els.allowNegative.checked };
      if(d==='custom'){
        s.allowNeg = !!els.allowNegative.checked;
        s.a = [Math.min(+els.aMin.value||0, +els.aMax.value||0), Math.max(+els.aMin.value||0, +els.aMax.value||0)];
        s.b = [Math.min(+els.bMin.value||0, +els.bMax.value||0), Math.max(+els.bMin.value||0, +els.bMax.value||0)];
      }
      const op = els.op.value;
      return { op, difficulty:d, ...s };
    }

    function genProblem(){
      const s = state.settings;
      let op = s.op==='mixed' ? choice(s.ops) : s.op;
      let a = rnd(s.a[0], s.a[1]);
      let b = rnd(s.b[0], s.b[1]);

      if(op==='sub' && !s.allowNeg){
        if(a<b) [a,b] = [b,a];
      }
      if(op==='div'){
        // Generate integer division: pick factors, then derive a
        b = clamp(rnd(Math.max(1,s.b[0]), Math.max(1,s.b[1])), 1, 999);
        const q = rnd(Math.max(1,s.a[0]), Math.max(1,s.a[1]));
        a = b * q;
      }
      const answer = OPER[op].fn(a,b);
      return {a,b,op,answer};
    }

    function renderProblem(pb){
      els.pA.textContent = pb.a;
      els.pB.textContent = pb.b;
      els.pOp.textContent = OPER[pb.op].sym;
      els.ans.value = '';
      els.ans.focus();
    }

    function updateStatsUI(){
      const st = state.stats;
      const total = st.correct + st.wrong;
      const acc = total ? Math.round((st.correct/total)*100) : 0;
      const dur = (Date.now()-state.startTime)/1000;
      const perMin = dur>0 ? (st.correct/dur*60) : 0;
      const avg = st.times.length ? (st.times.reduce((a,b)=>a+b,0)/st.times.length) : 0;
      els.sCorrect.textContent = st.correct;
      els.sWrong.textContent = st.wrong;
      els.sAcc.textContent = acc + '%';
      els.sStreak.textContent = st.streak;
      els.sRate.textContent = (perMin).toFixed(1) + '/min';
      els.sAvg.textContent = st.times.length? (avg.toFixed(2)+'s') : '–';
    }

    function startQuiz(){
      if(state.running) return;
      state.settings = pickSettings();
      state.duration = +els.duration.value|0; state.remaining = state.duration;
      state.stats = { correct:0, wrong:0, streak:0, bestStreak:0, times:[], mistakes:[] };
      state.running = true; state.startTime = Date.now(); state.endTime = state.startTime + state.duration*1000;
      clearInterval(state.tickH);
      state.tickH = setInterval(tick, 200);

      els.preQuiz.style.display='none';
      els.postQuiz.style.display='none';
      els.quiz.style.display='flex';
      els.start.disabled = true; els.stop.disabled = false;
      els.quickStart.disabled = true;

      state.current = genProblem();
      renderProblem(state.current);
      setTimerProgress(); updateStatsUI();
    }

    function stopQuiz(){ endQuiz(true); }

    function tick(){
      const now = Date.now();
      state.remaining = Math.max(0, Math.round((state.endTime - now)/1000));
      setTimerProgress();
      if(now >= state.endTime){ endQuiz(false); }
    }

    function submitAnswer(){
      if(!state.running) return;
      const user = els.ans.value.trim();
      if(user==='') return;
      const correct = Number(user)===state.current.answer;
      const t = Math.min(12, Math.max(.2, (Date.now()-state.qStart)/1000));
      state.stats.times.push(t);
      if(correct){
        state.stats.correct++; state.stats.streak++; state.stats.bestStreak = Math.max(state.stats.bestStreak, state.stats.streak);
        flash(['Nice!','Great!','Correct!','Boom!','Yes!'][rnd(0,4)], true);
      }else{
        state.stats.wrong++; state.stats.streak=0;
        state.stats.mistakes.push({ ...state.current, user });
        flash('Not quite', false);
      }
      updateStatsUI();
      // Next problem
      state.current = genProblem();
      renderProblem(state.current);
      state.qStart = Date.now();
    }

    function endQuiz(manual){
      if(!state.running) return;
      state.running=false;
      clearInterval(state.tickH);
      els.start.disabled = false; els.stop.disabled = true; els.quickStart.disabled = false;
      els.quiz.style.display='none';
      els.postQuiz.style.display='block';

      const total = state.stats.correct + state.stats.wrong;
      const acc = total? Math.round(state.stats.correct/total*100):0;
      const dur = Math.max(1, (state.duration - state.remaining));
      const rate = (state.stats.correct/dur*60)||0;
      const avg = state.stats.times.length ? (state.stats.times.reduce((a,b)=>a+b,0)/state.stats.times.length) : 0;

      // Update summary area
      els.sumTag.textContent = `${state.stats.correct}✓ • ${state.stats.wrong}✗ • ${acc}% • ${(rate).toFixed(1)}/min`;

      // Modal metrics
      els.mCorrect.textContent = state.stats.correct;
      els.mWrong.textContent = state.stats.wrong;
      els.mAcc.textContent = acc + '%';
      els.mRate.textContent = rate.toFixed(1) + '/min';
      els.mAvg.textContent = state.stats.times.length? (avg.toFixed(2)+'s') : '–';
      els.mStreak.textContent = state.stats.bestStreak;

      drawChart(els.chart, state.stats.times);
      saveSession();
      renderHistory();
      if(!manual){ showModal(); }
    }

    function showModal(){ els.modal.classList.add('show'); }
    function hideModal(){ els.modal.classList.remove('show'); }

    // Chart
    function drawChart(canvas, data){
      const ctx = canvas.getContext('2d');
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);
      // Axes background
      ctx.fillStyle = 'rgba(255,255,255,0.035)'; ctx.fillRect(0,0,W,H);
      const pad = 24;
      const xmin = pad, xmax = W-pad, ymin = pad, ymax = H - pad;
      const n = data.length || 1;
      const max = Math.max(2, Math.max(...data, 1));
      // grid
      ctx.strokeStyle = 'rgba(255,255,255,.08)'; ctx.lineWidth = 1;
      for(let i=0;i<=4;i++){
        const y = ymin + (ymax-ymin)*i/4;
        ctx.beginPath(); ctx.moveTo(xmin,y); ctx.lineTo(xmax,y); ctx.stroke();
      }
      // line
      ctx.strokeStyle = 'rgba(124,156,255,1)'; ctx.lineWidth = 3; ctx.lineJoin='round'; ctx.lineCap='round';
      ctx.beginPath();
      data.forEach((v,i)=>{
        const x = xmin + (xmax-xmin) * (i/(n-1||1));
        const y = ymax - (v/max)*(ymax-ymin);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
      // average
      const avg = data.length? data.reduce((a,b)=>a+b,0)/data.length : 0;
      const yavg = ymax - (avg/max)*(ymax-ymin);
      ctx.strokeStyle = 'rgba(255,190,59,.9)'; ctx.setLineDash([6,6]);
      ctx.beginPath(); ctx.moveTo(xmin,yavg); ctx.lineTo(xmax,yavg); ctx.stroke();
      ctx.setLineDash([]);
    }

    // History
    const LS_KEY = 'math-practice-drills/v1';
    function loadHistory(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; }
    }
    function saveHistory(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(-30))); }

    function saveSession(){
      const s = state.settings, st = state.stats;
      const total = st.correct + st.wrong; const acc = total? Math.round(100*st.correct/total):0;
      const duration = state.duration - state.remaining;
      const rate = duration? +(st.correct/duration*60).toFixed(2) : 0;
      const avg = st.times.length? +(st.times.reduce((a,b)=>a+b,0)/st.times.length).toFixed(2):null;
      const entry = {
        ts: Date.now(),
        op: s.op, difficulty:s.difficulty, a:s.a, b:s.b, allowNeg:s.allowNeg,
        duration: state.duration, played: duration,
        correct: st.correct, wrong: st.wrong, acc, rate, avg, bestStreak: st.bestStreak,
        mistakes: st.mistakes
      };
      const arr = loadHistory(); arr.push(entry); saveHistory(arr);
    }

    function renderHistory(){
      const arr = loadHistory().slice().reverse();
      if(!arr.length){ els.history.innerHTML = '<div class="small">No sessions yet. Your recent results will appear here.</div>'; return; }
      els.history.innerHTML = '';
      arr.forEach((e,i)=>{
        const d = new Date(e.ts);
        const date = d.toLocaleString([], { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
        const line = document.createElement('div'); line.className='rowline';
        const left = document.createElement('div');
        left.innerHTML = `<strong>${e.correct}✓</strong> / ${e.wrong}✗ · <span class="small">${e.acc}%</span> · <span class="small">${e.rate}/min</span>`;
        const right = document.createElement('div');
        right.innerHTML = `<span class="tag">${e.op}</span> <span class="tag">${e.difficulty}</span> <span class="small">${date}</span>`;
        line.append(left, right); els.history.append(line);
      });
    }

    // Mistakes
    function renderMistakes(){
      els.mistakesList.innerHTML = '';
      if(!state.stats.mistakes.length){
        els.mistakesList.innerHTML = '<div class="small">No mistakes this round — awesome!</div>';
        return;
      }
      state.stats.mistakes.forEach(m=>{
        const item = document.createElement('div'); item.className='rowline';
        const correct = `${m.a} ${OPER[m.op].sym} ${m.b} = ${m.answer}`;
        item.innerHTML = `<div>${correct}</div><div class="small">you: <strong style="color:var(--bad)">${m.user}</strong></div>`;
        els.mistakesList.append(item);
      });
    }

    // Theme
    function toggleTheme(){
      const k='mathpd-theme';
      const cur = document.documentElement.dataset.theme||'auto';
      const next = cur==='dark'?'light':cur==='light'?'auto':'dark';
      document.documentElement.dataset.theme = next;
      if(next==='auto') localStorage.removeItem(k); else localStorage.setItem(k,next);
    }
    function applyTheme(){
      const t = localStorage.getItem('mathpd-theme');
      if(t) document.documentElement.dataset.theme = t;
      const isLight = window.matchMedia('(prefers-color-scheme: light)').matches;
      if((document.documentElement.dataset.theme||'auto')==='dark' || (!t && !isLight)){
        document.documentElement.style.setProperty('--bg', '#0b1020');
      }
    }

    // Event wiring
    els.start.addEventListener('click', startQuiz);
    els.quickStart.addEventListener('click', ()=>{ els.op.value='mixed'; els.difficulty.value='easy'; els.duration.value='60'; startQuiz(); });
    els.stop.addEventListener('click', stopQuiz);
    els.ans.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ submitAnswer(); } });
    els.retryBtn.addEventListener('click', ()=> startQuiz());
    els.modalRetry.addEventListener('click', ()=>{ hideModal(); startQuiz(); });
    els.changeBtn.addEventListener('click', ()=>{ els.postQuiz.style.display='none'; els.preQuiz.style.display='grid'; });
    els.reviewBtn.addEventListener('click', ()=>{ els.mistakes.style.display = els.mistakes.style.display==='none'?'block':'none'; if(els.mistakes.style.display==='block') renderMistakes(); });
    els.closeModal.addEventListener('click', hideModal);
    els.resetStats.addEventListener('click', ()=>{ localStorage.removeItem(LS_KEY); renderHistory(); flash('Cleared history', true); });

    els.difficulty.addEventListener('change', ()=>{
      const isCustom = els.difficulty.value==='custom';
      els.customBox.style.display = isCustom?'block':'none';
    });

    // Focus management
    ['click','touchstart'].forEach(evt=>{
      els.quizCard.addEventListener(evt, ()=>{ if(state.running) els.ans.focus(); }, {passive:true});
    });

    // Start-of-question timestamp
    const origRender = renderProblem;
    renderProblem = function(pb){ origRender(pb); state.qStart = Date.now(); }

    // Initialize
    applyTheme(); renderHistory(); setTimerProgress(); updateStatsUI();
    els.theme.addEventListener('click', toggleTheme);
  })();
  </script>
</body>
</html>
