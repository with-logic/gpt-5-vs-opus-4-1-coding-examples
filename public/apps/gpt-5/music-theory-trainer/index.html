<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Music Theory Trainer</title>
  <meta name="description" content="Interactive piano, scales, chords, and ear training exercises." />
  <!-- External libs allowed via CDN: Tone.js for audio -->
  <script defer src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <style>
    :root{
      --bg: #0b1020;
      --panel: #121933;
      --panel-2: #0f1530;
      --text: #e7ecff;
      --muted: #aab3d9;
      --accent: #8ad7ff;
      --accent-2: #a58bff;
      --good: #36d399;
      --bad: #ff6b6b;
      --warn: #ffd166;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at -10% -20%, #1b2a6a 0%, rgba(27,42,106,0) 60%),
        radial-gradient(900px 500px at 120% 10%, #6024a3 0%, rgba(96,36,163,0) 60%),
        linear-gradient(180deg, #0a0f25, #0b1020 40%);
      background-attachment: fixed;
    }
    a{color:var(--accent)}

    /* Header */
    header{
      position:sticky;top:0;z-index:30;
      background: linear-gradient(180deg, rgba(15,21,48,.85), rgba(15,21,48,.6));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .title{
      display:flex;align-items:center;gap:16px;flex-wrap:wrap;
    }
    .logo{
      width:42px;height:42px;border-radius:50%;
      background: conic-gradient(from 180deg, #7ae0ff, #c6a8ff, #7ae0ff);
      box-shadow: inset 0 0 12px rgba(255,255,255,.35), 0 0 24px rgba(138,215,255,.4);
      display:grid;place-items:center;color:#0b1020;font-weight:900;letter-spacing:.5px;
    }
    .subtitle{color:var(--muted)}

    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab-btn{
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, #1a234a, #141b3b);
      color:var(--text);padding:10px 14px;border-radius:999px;cursor:pointer;
      box-shadow: var(--shadow); font-weight:600; letter-spacing:.2px;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
    }
    .tab-btn:hover{transform: translateY(-1px)}
    .tab-btn.active{background:linear-gradient(180deg, #26306a, #1b2352);border-color:#6e7aff}

    /* Panels */
    .panels{padding:20px}
    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .grid{
      display:grid;gap:16px;
      grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }

    /* Controls */
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .chip{background:#1b2350;border:1px solid rgba(255,255,255,.1);padding:8px 12px;border-radius:10px}
    .select, .button, .toggle, .slider{display:inline-flex;align-items:center;gap:8px}
    .select select, .button button, .toggle input, .slider input{cursor:pointer}
    .button button{background:#2b3578;border:1px solid rgba(255,255,255,.14);color:var(--text);padding:8px 12px;border-radius:10px}
    .button button:active{transform:translateY(1px)}

    /* Piano */
    .piano-wrap{position:relative; user-select:none; -webkit-user-select:none;}
    .piano{position:relative;height:230px;margin-top:12px;border-radius:12px;overflow:hidden;}
    .white-keys{display:flex;height:100%}
    .white-key{
      flex:1;position:relative;background:linear-gradient(180deg,#f6f7ff,#eef2ff 45%, #dee6ff);
      border-right:1px solid #c5cfee; border-left:1px solid #dbe3ff; 
      box-shadow: inset 0 -6px 0 rgba(0,0,0,.05);
      border-bottom:4px solid #b7c3ef;
    }
    .white-key:hover{filter:brightness(1.03)}
    .white-key:active, .white-key.playing{background:linear-gradient(180deg,#e8ecff,#e2e7ff 45%, #d6e0ff);border-bottom-color:#9fb0e6}
    .white-label{position:absolute;bottom:8px;left:0;right:0;text-align:center;color:#243;
      font-weight:700; font-size:12px; opacity:.75}

    .black-keys{position:absolute;left:0;right:0;top:0;height:66%; pointer-events:none}
    .black-key{
      position:absolute;width:3.2%;height:100%;
      background:linear-gradient(180deg,#222632,#0a0d16); border:1px solid rgba(255,255,255,.08);
      border-radius:0 0 6px 6px; box-shadow: inset 0 -6px 0 rgba(0,0,0,.5), 0 8px 18px rgba(0,0,0,.4);
      pointer-events:auto;
    }
    .black-key:hover{filter:brightness(1.06)}
    .black-key:active, .black-key.playing{background:linear-gradient(180deg,#1b1f2b,#080a10)}
    .black-label{position:absolute;bottom:8px;left:0;right:0;text-align:center;color:#cde; font-weight:700;font-size:10px;opacity:.85}

    .highlight{
      outline: 3px solid var(--accent);
      outline-offset: -3px;
      animation: pulse 1.2s ease-in-out infinite;
    }
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(138,215,255,.55)}70%{box-shadow:0 0 0 12px rgba(138,215,255,0)}100%{box-shadow:0 0 0 0 rgba(138,215,255,0)}}

    /* Explorer */
    .explorer h3{margin:0 0 8px 0}
    .explorer .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
    .explorer .summary{margin-top:8px;color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#1a2148;border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px}

    /* Ear training */
    .train-grid{display:grid;grid-template-columns: .9fr 1.1fr;gap:16px}
    @media (max-width: 980px){.train-grid{grid-template-columns: 1fr}}
    .answers{display:grid;grid-template-columns: repeat(2, minmax(0,1fr));gap:10px;margin-top:10px}
    .answers button{
      padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg,#1a234a,#141b3b);color:var(--text);font-weight:700;letter-spacing:.2px
    }
    .answers button.correct{outline:2px solid var(--good)}
    .answers button.wrong{outline:2px solid var(--bad)}

    .score{display:flex;gap:10px;flex-wrap:wrap}
    .score .card{background:#131b3a;border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:10px}

    /* Toast & particles */
    .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);padding:10px 14px;border-radius:999px;background:#15214a;border:1px solid rgba(255,255,255,.1);color:var(--text);z-index:50;box-shadow:var(--shadow);display:none}
    .party{position:absolute;pointer-events:none;left:0;top:0;width:100%;height:100%;overflow:hidden}
    .note{position:absolute;font-size:22px;opacity:0;animation:float 1.3s ease forwards}
    @keyframes float{0%{transform:translateY(0) scale(1);opacity:0}15%{opacity:1}85%{opacity:1}100%{transform:translateY(-140px) scale(1.2);opacity:0}}

    /* Audio gate overlay */
    .gate{position:fixed;inset:0;display:grid;place-items:center;z-index:100;background:radial-gradient(1000px 600px at 50% 50%, rgba(22,30,70,.9), rgba(10,15,37,.85)), linear-gradient(180deg,#0e142f,#0a0f25)}
    .gate .inner{background:linear-gradient(180deg,#141b3b,#111737);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:22px 20px;box-shadow:var(--shadow);text-align:center;max-width:520px}
    .gate h2{margin:0 0 6px 0}
    .gate p{margin:0 0 14px 0;color:var(--muted)}
    .gate button{background:#2b3578;border:1px solid rgba(255,255,255,.14);color:var(--text);padding:10px 14px;border-radius:12px;font-weight:800;font-size:16px}

    /* Helper */
    .muted{color:var(--muted)}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .spacer{height:18px}
    .small{font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="title">
        <div class="logo">â™ª</div>
        <div>
          <div style="font-size:22px;font-weight:900;letter-spacing:.3px">Music Theory Trainer</div>
          <div class="subtitle">Learn notes, scales, and chords â€” and sharpen your ear.</div>
        </div>
      </div>
      <div class="tabs">
        <button class="tab-btn active" data-tab="studio">Piano Studio</button>
        <button class="tab-btn" data-tab="trainer">Ear Training</button>
        <button class="tab-btn" data-tab="about">Tips</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="panels">
      <!-- Studio: Piano + Explorer -->
      <section id="tab-studio" class="panel">
        <div class="grid">
          <div>
            <div class="controls row">
              <div class="chip select"><label class="small">Wave</label>
                <select id="wave">
                  <option value="sine">Sine</option>
                  <option value="triangle" selected>Triangle</option>
                  <option value="square">Square</option>
                  <option value="sawtooth">Saw</option>
                </select>
              </div>
              <div class="chip slider"><label class="small">Volume</label>
                <input id="vol" type="range" min="-24" max="0" step="1" value="-6"/>
              </div>
              <div class="chip toggle"><label class="small">Sustain</label>
                <input id="sustain" type="checkbox"/>
              </div>
              <div class="chip toggle"><label class="small">Labels</label>
                <input id="labels" type="checkbox" checked/>
              </div>
              <div class="chip select"><label class="small">Accidentals</label>
                <select id="accid">
                  <option value="sharp" selected>Sharps (â™¯)</option>
                  <option value="flat">Flats (â™­)</option>
                </select>
              </div>
              <div class="button"><button id="panic">Panic â€¢ All Notes Off</button></div>
            </div>
            <div class="piano-wrap">
              <div class="piano" id="piano">
                <div class="white-keys" id="whiteKeys"></div>
                <div class="black-keys" id="blackKeys"></div>
                <div class="party" id="party"></div>
              </div>
              <div class="small muted" style="margin-top:8px">Tip: Click keys or use your mouse/touch. Toggle Labels to show note names.</div>
            </div>
          </div>
          <div class="explorer">
            <h3>Scale &amp; Chord Explorer</h3>
            <div class="row">
              <div class="chip select"><label class="small">Root</label>
                <select id="root"></select>
              </div>
              <div class="chip select"><label class="small">Scale</label>
                <select id="scale"></select>
              </div>
              <div class="button"><button id="playScale">Play Scale</button></div>
            </div>
            <div class="row">
              <div class="chip select"><label class="small">Chord</label>
                <select id="chord"></select>
              </div>
              <div class="chip toggle"><label class="small">Arpeggiate</label>
                <input id="arp" type="checkbox" checked/>
              </div>
              <div class="button"><button id="playChord">Play Chord</button></div>
            </div>
            <div class="summary" id="summary"></div>
            <div class="spacer"></div>
            <div class="badge"><span>ðŸŽ¯</span> <span>Use the explorer to highlight notes on the piano and hear them.</span></div>
          </div>
        </div>
      </section>

      <!-- Ear Training -->
      <section id="tab-trainer" class="panel" style="display:none">
        <div class="train-grid">
          <div>
            <h3>Exercise</h3>
            <div class="row">
              <div class="chip select"><label class="small">Type</label>
                <select id="exType">
                  <option value="note" selected>Note (Pitch Class)</option>
                  <option value="interval">Interval</option>
                  <option value="chord">Chord Quality</option>
                </select>
              </div>
              <div class="chip toggle"><label class="small">Arpeggiate chords</label><input id="exArp" type="checkbox" checked></div>
              <div class="button"><button id="exPlay">â–¶ Play</button></div>
              <div class="button"><button id="exNext">Next</button></div>
            </div>
            <div class="answers" id="answers"></div>
          </div>
          <div>
            <h3>Score</h3>
            <div class="score">
              <div class="card">Correct: <strong id="sCorrect">0</strong></div>
              <div class="card">Total: <strong id="sTotal">0</strong></div>
              <div class="card">Streak: <strong id="sStreak">0</strong></div>
              <div class="card">Best: <strong id="sBest">0</strong></div>
            </div>
            <div class="spacer"></div>
            <div class="panel" style="background:#0f1534">
              <div style="font-weight:800;margin-bottom:6px">How it works</div>
              <ul class="small muted" style="margin:0 0 8px 18px">
                <li>Press Play to hear the prompt.</li>
                <li>Select the matching answer. Your streak grows with each correct pick.</li>
                <li>Use the piano to test options with your ear.</li>
              </ul>
              <div class="badge"><span>ðŸ’¡</span><span>For intervals: they play ascending from a random root.</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- About / Tips -->
      <section id="tab-about" class="panel" style="display:none">
        <h3>Quick Tips</h3>
        <ul class="muted">
          <li>Use Wave to change the synth flavor. Volume adjusts overall loudness.</li>
          <li>Toggle Sustain to let notes ring until you click another or hit Panic.</li>
          <li>Choose Sharps or Flats to match your reading preference.</li>
          <li>Explorer highlights notes for selected scales and chords â€” try different roots.</li>
          <li>In Ear Training, try to sing the interval before answering.</li>
        </ul>
        <div class="spacer"></div>
        <div class="badge"><span>ðŸŽµ</span><span>Practice a little every day. Your ears will thank you!</span></div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast"></div>
  <div class="gate" id="gate">
    <div class="inner">
      <h2>Enable Audio</h2>
      <p>Click below once to unlock audio in your browser.</p>
      <button id="gateBtn">Letâ€™s Play</button>
    </div>
  </div>

  <script>
  ;(function(){
    // --- Utilities ---
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const notesSharp = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const notesFlat  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
    const midiMin = 48; // C3
    const midiMax = 72; // C5

    function midiToName(m, acc="sharp"){
      const n = acc === 'flat' ? notesFlat : notesSharp;
      const pc = m % 12; const oct = Math.floor(m/12) - 1;
      return n[pc] + oct;
    }
    function midiToPitchClass(m, acc='sharp'){
      const n = acc === 'flat' ? notesFlat : notesSharp;
      return n[m % 12];
    }
    function pcName(pc, acc='sharp'){ return (acc==='flat'?notesFlat:notesSharp)[((pc%12)+12)%12] }
    function clamp(x,a,b){return Math.max(a,Math.min(b,x))}
    function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
    function shuffle(arr){return arr.sort(()=>Math.random()-0.5)}

    // --- Scales & Chords Definitions ---
    const SCALES = {
      'Major (Ionian)':        [0,2,4,5,7,9,11,12],
      'Natural Minor (Aeolian)': [0,2,3,5,7,8,10,12],
      'Harmonic Minor':        [0,2,3,5,7,8,11,12],
      'Melodic Minor (Asc.)':  [0,2,3,5,7,9,11,12],
      'Major Pentatonic':      [0,2,4,7,9,12],
      'Minor Pentatonic':      [0,3,5,7,10,12],
      'Blues':                 [0,3,5,6,7,10,12],
      'Dorian':                [0,2,3,5,7,9,10,12],
      'Phrygian':              [0,1,3,5,7,8,10,12],
      'Lydian':                [0,2,4,6,7,9,11,12],
      'Mixolydian':            [0,2,4,5,7,9,10,12],
      'Locrian':               [0,1,3,5,6,8,10,12]
    };
    const CHORDS = {
      'Major':        [0,4,7],
      'Minor':        [0,3,7],
      'Diminished':   [0,3,6],
      'Augmented':    [0,4,8],
      'Sus2':         [0,2,7],
      'Sus4':         [0,5,7],
      'Maj7':         [0,4,7,11],
      '7 (Dominant)': [0,4,7,10],
      'Min7':         [0,3,7,10],
      'Half-diminished (m7â™­5)': [0,3,6,10],
      'Dim7':         [0,3,6,9]
    };
    const INTERVALS = [
      ['m2',1],['M2',2],['m3',3],['M3',4],['P4',5],['TT',6],['P5',7],['m6',8],['M6',9],['m7',10],['M7',11],['P8',12]
    ];

    // --- Audio Engine (Tone.js or fallback) ---
    const Audio = {
      ctx: null,
      synth: null,
      poly: null,
      volume: -6,
      sustain: false,
      effects: {},
      started: false,
      useTone: false,
      async start(){
        if(this.started) return;
        try{ if(window.Tone){ await Tone.start(); } }catch(e){}
        // Decide engine
        if(window.Tone){
          this.useTone = true;
          this.effects.gain = new Tone.Volume(this.volume).toDestination();
          this.effects.reverb = new Tone.Reverb({decay:2.5,wet:0.2}).connect(this.effects.gain);
          this.effects.chorus = new Tone.Chorus(3, 2.5, 0.2).connect(this.effects.reverb).start();
          this.poly = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: $('#wave').value },
            envelope: { attack:0.01, decay:.1, sustain:.6, release:.5 }
          }).connect(this.effects.chorus);
        } else {
          // Fallback WebAudio simple poly manager
          this.ctx = new (window.AudioContext||window.webkitAudioContext)();
          this.master = this.ctx.createGain();
          this.master.gain.value = Math.pow(10, this.volume/20);
          this.master.connect(this.ctx.destination);
          this.active = new Map(); // midi -> {osc,gain}
        }
        this.started = true;
        showToast('Audio ready â€” have fun!');
      },
      setWave(type){
        if(this.useTone && this.poly){ this.poly.set({oscillator:{type}}) }
        // fallback uses sine only (kept simple)
      },
      setVolume(db){
        this.volume = db;
        if(this.useTone && this.effects.gain){ this.effects.gain.volume.value = db }
        if(!this.useTone && this.master){ this.master.gain.value = Math.pow(10, db/20) }
      },
      async triggerAttack(midi){
        if(!this.started) await this.start();
        if(this.useTone){
          const note = Tone.Frequency(midi, 'midi').toNote();
          this.poly.triggerAttack(note);
        } else {
          const now = this.ctx.currentTime;
          const osc = this.ctx.createOscillator();
          const gain = this.ctx.createGain();
          gain.gain.setValueAtTime(0, now);
          gain.gain.linearRampToValueAtTime(.8, now+.01);
          gain.gain.linearRampToValueAtTime(.6, now+.1);
          osc.frequency.value = 440 * Math.pow(2,(midi-69)/12);
          osc.type = $('#wave').value || 'sine';
          osc.connect(gain); gain.connect(this.master);
          osc.start(now);
          this.active.set(midi,{osc,gain});
        }
      },
      async triggerRelease(midi){
        if(!this.started) await this.start();
        if(this.useTone){
          const note = Tone.Frequency(midi, 'midi').toNote();
          this.poly.triggerRelease(note);
        } else if(this.active && this.active.has(midi)){
          const {osc,gain} = this.active.get(midi);
          const now = this.ctx.currentTime;
          gain.gain.cancelScheduledValues(now);
          gain.gain.setTargetAtTime(0, now, .08);
          setTimeout(()=>{try{osc.stop();osc.disconnect();gain.disconnect()}catch(e){}}, 160);
          this.active.delete(midi);
        }
      },
      async playNote(midi, dur=0.6){
        await this.triggerAttack(midi);
        if(!Audio.sustain){ setTimeout(()=>Audio.triggerRelease(midi), dur*1000) }
      },
      panic(){
        if(this.useTone && this.poly){ this.poly.releaseAll() }
        if(!this.useTone && this.active){ for(const k of Array.from(this.active.keys())) this.triggerRelease(k) }
      }
    };

    // --- Piano Construction ---
    const whiteIdxOf = (m) => [0,2,4,5,7,9,11].indexOf(m%12);
    const isBlack = (m) => [1,3,6,8,10].includes(m%12);
    const whiteSequence = [];

    function buildPiano(){
      const white = $('#whiteKeys');
      const black = $('#blackKeys');
      white.innerHTML = ''; black.innerHTML = '';

      // Build white keys first
      let whiteCount = 0; for(let m=midiMin;m<=midiMax;m++){ if(!isBlack(m)){ whiteSequence.push({m, idx:whiteCount}); whiteCount++; } }

      for(let m=midiMin;m<=midiMax;m++){
        if(!isBlack(m)){
          const el = document.createElement('button');
          el.className = 'white-key';
          el.dataset.midi = m;
          const lab = document.createElement('div'); lab.className='white-label'; lab.innerText = midiToName(m, $('#accid').value);
          el.appendChild(lab);
          white.appendChild(el);
        }
      }
      const whiteKeyCount = white.children.length;

      // Black keys with computed left percentages
      const blackOffsets = {1:.65,3:1.45,6:3.35,8:4.15,10:4.95};
      let whiteIndex = 0;
      for(let m=midiMin;m<=midiMax;m++){
        const pc = m%12;
        if(!isBlack(m)) whiteIndex++;
        if(isBlack(m)){
          const el = document.createElement('button');
          el.className='black-key'; el.dataset.midi=m;
          const lab = document.createElement('div'); lab.className='black-label'; lab.innerText=midiToName(m, $('#accid').value);
          el.appendChild(lab);
          // compute left based on preceding whites in this octave
          // find the white index before this black
          const octaveStartWhite = (()=>{
            // find last C (pc 0) at or before m
            let c = m; while(c>=midiMin && c%12!==0) c--;
            // count how many whites from midiMin to that C exclusive
            let count=0; for(let x=midiMin;x<c;x++){ if(!isBlack(x)) count++; }
            return count;
          })();
          const offsetInOct = blackOffsets[pc] || 0;
          const leftPercent = ((octaveStartWhite + offsetInOct) / whiteKeyCount) * 100;
          el.style.left = `calc(${leftPercent}% - 1.6%)`;
          black.appendChild(el);
        }
      }

      // Interaction
      const down = new Set();
      function noteOn(el){ const m = +el.dataset.midi; el.classList.add('playing'); Audio.triggerAttack(m); spawnNoteParticles(el); }
      function noteOff(el){ const m = +el.dataset.midi; el.classList.remove('playing'); if(!Audio.sustain) Audio.triggerRelease(m); }

      $$('#piano button').forEach(el=>{
        el.addEventListener('pointerdown', e=>{e.preventDefault(); noteOn(el); down.add(el)});
        el.addEventListener('pointerup',   e=>{e.preventDefault(); noteOff(el); down.delete(el)});
        el.addEventListener('pointerleave',e=>{ if(down.has(el)){ noteOff(el); down.delete(el) } });
      });
      window.addEventListener('pointerup',()=>{ down.forEach(el=>{ if(!Audio.sustain) el.classList.remove('playing') }); down.clear() });
    }

    function refreshLabels(){
      const acc = $('#accid').value;
      $$('#whiteKeys .white-key').forEach(el=>{ el.querySelector('.white-label').innerText = midiToName(+el.dataset.midi, acc) });
      $$('#blackKeys .black-key').forEach(el=>{ el.querySelector('.black-label').innerText = midiToName(+el.dataset.midi, acc) });
    }

    function setLabelsVisible(vis){
      const disp = vis? 'block':'none';
      $$('#piano .white-label, #piano .black-label').forEach(el=> el.style.display = disp );
    }

    // --- Highlighting ---
    function clearHighlights(){ $$('#piano .white-key, #piano .black-key').forEach(k=>k.classList.remove('highlight')) }
    function highlightPCs(pcs){
      clearHighlights();
      $$('#piano button').forEach(k=>{ if(pcs.includes(+k.dataset.midi % 12)) k.classList.add('highlight') })
    }

    // --- Explorer ---
    function fillSelectors(){
      const root = $('#root'), scale = $('#scale'), chord = $('#chord');
      root.innerHTML = ''; scale.innerHTML = ''; chord.innerHTML = '';
      const acc = $('#accid').value;
      for(let i=0;i<12;i++){
        const opt = document.createElement('option'); opt.value=i; opt.textContent = pcName(i, acc); root.appendChild(opt);
      }
      Object.keys(SCALES).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; scale.appendChild(o) });
      Object.keys(CHORDS).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; chord.appendChild(o) });
      // defaults
      root.value = 0; // C
      scale.value = 'Major (Ionian)';
      chord.value = 'Major';
      updateSummary();
    }

    function bestMidiForPC(pc){
      // pick the midi closest to middle C (60) within [midiMin, midiMax]
      let candidates = []; for(let m=midiMin;m<=midiMax;m++){ if(m%12===pc) candidates.push(m) }
      if(candidates.length===0) return clamp(pc+60, midiMin, midiMax);
      return candidates.reduce((a,b)=> Math.abs(a-60) < Math.abs(b-60) ? a : b);
    }

    function playScale(){
      const pc = +$('#root').value; const name=$('#scale').value; const acc=$('#accid').value;
      const ints = SCALES[name]; const start = bestMidiForPC(pc);
      const notes = ints.map(i=> start + i);
      highlightPCs(ints.map(i=> (pc+i)%12));
      updateSummary();
      // schedule
      let t=0; notes.forEach(m=>{ setTimeout(()=>Audio.playNote(m, .5), t*320); t++; });
      // descent
      for(let i=notes.length-2;i>0;i--){ setTimeout(()=>Audio.playNote(notes[i], .5), t*320); t++; }
      showToast(`${pcName(pc,acc)} ${name}`);
    }
    function playChord(){
      const pc = +$('#root').value; const name=$('#chord').value; const acc=$('#accid').value; const ints = CHORDS[name];
      const start = bestMidiForPC(pc);
      const notes = ints.map(i=> start + i);
      highlightPCs(ints.map(i=> (pc+i)%12));
      updateSummary();
      if($('#arp').checked){
        notes.forEach((m,i)=> setTimeout(()=>Audio.playNote(m,.7), i*220));
      } else {
        notes.forEach(m=> Audio.triggerAttack(m));
        setTimeout(()=>{ if(!Audio.sustain) notes.forEach(m=>Audio.triggerRelease(m)) }, 800);
      }
      showToast(`${pcName(pc,acc)} ${name}`);
    }
    function updateSummary(){
      const pc = +$('#root').value; const acc=$('#accid').value; const s=$('#scale').value; const c=$('#chord').value;
      const sNotes = SCALES[s].map(i=> pcName(pc+i, acc));
      const cNotes = CHORDS[c].map(i=> pcName(pc+i, acc));
      $('#summary').innerHTML = `<div><strong>${pcName(pc,acc)} ${s}</strong>: ${sNotes.join(' - ')}</div>`+
        `<div style=\"margin-top:6px\"><strong>${pcName(pc,acc)} ${c}</strong>: ${cNotes.join(' - ')}</div>`;
    }

    // --- Ear Training ---
    const Score = {correct:0,total:0,streak:0,best:0};
    let currentQ = null;

    function setScore(){ $('#sCorrect').textContent=Score.correct; $('#sTotal').textContent=Score.total; $('#sStreak').textContent=Score.streak; $('#sBest').textContent=Score.best; }

    function genNoteQuestion(){
      const root = randInt(midiMin, midiMax);
      const correctPC = root % 12; const acc=$('#accid').value;
      const all = [...Array(12).keys()];
      const choices = shuffle([correctPC, ...shuffle(all.filter(x=>x!==correctPC)).slice(0,3)]).map(pc=> pcName(pc, acc));
      currentQ = {type:'note', correct: pcName(correctPC, acc), midi: root, choices};
      renderAnswers(choices);
      return currentQ;
    }
    function genIntervalQuestion(){
      const rootPc = randInt(0,11);
      const root = bestMidiForPC(rootPc);
      const [name,semitones] = INTERVALS[randInt(0, INTERVALS.length-1)];
      const up = true; // ascending
      const second = root + semitones * (up?1:-1);
      const acc=$('#accid').value;
      const choices = shuffle([name, ...shuffle(INTERVALS.filter(x=>x[0]!==name)).slice(0,3).map(x=>x[0])]);
      currentQ = {type:'interval', correct:name, midi:[root,second], choices};
      renderAnswers(choices);
      return currentQ;
    }
    function genChordQuestion(){
      const pc = randInt(0,11);
      const root = bestMidiForPC(pc);
      const names = Object.keys(CHORDS);
      const correctName = names[randInt(0,names.length-1)];
      const ints = CHORDS[correctName];
      const notes = ints.map(i=> root + i);
      const choices = shuffle([correctName, ...shuffle(names.filter(n=>n!==correctName)).slice(0,3)]);
      currentQ = {type:'chord', correct:correctName, midi:notes, rootPc:pc, choices};
      renderAnswers(choices);
      return currentQ;
    }

    function playCurrent(){
      if(!currentQ) return;
      if(currentQ.type==='note'){ Audio.playNote(currentQ.midi, .8) }
      if(currentQ.type==='interval'){
        const [a,b]=currentQ.midi; Audio.playNote(a,.6); setTimeout(()=>Audio.playNote(b,.7), 380);
      }
      if(currentQ.type==='chord'){
        if($('#exArp').checked){ currentQ.midi.forEach((m,i)=> setTimeout(()=>Audio.playNote(m,.7), i*220)); }
        else { currentQ.midi.forEach(m=> Audio.triggerAttack(m)); setTimeout(()=>{ if(!Audio.sustain) currentQ.midi.forEach(m=>Audio.triggerRelease(m)) }, 800); }
      }
    }

    function renderAnswers(list){
      const wrap = $('#answers'); wrap.innerHTML='';
      list.forEach(txt=>{
        const b = document.createElement('button'); b.textContent=txt;
        b.addEventListener('click',()=> evaluate(txt,b)); wrap.appendChild(b);
      })
    }

    function evaluate(choice, btn){
      if(!currentQ) return; Score.total++;
      const correct = choice === currentQ.correct;
      if(correct){ Score.correct++; Score.streak++; Score.best = Math.max(Score.best, Score.streak); spawnBurst(); showToast('Correct! âœ…'); btn.classList.add('correct'); }
      else { Score.streak=0; showToast('Try again â€” '+currentQ.correct, 1600); btn.classList.add('wrong'); highlightCorrectButton(); }
      setScore();
    }

    function highlightCorrectButton(){
      $$('#answers button').forEach(b=>{ if(b.textContent===currentQ.correct) b.classList.add('correct') })
    }

    function newQuestion(){
      const t = $('#exType').value; if(t==='note') genNoteQuestion(); else if(t==='interval') genIntervalQuestion(); else genChordQuestion();
    }

    // --- Tabs ---
    function setTab(name){
      $$('.tab-btn').forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
      $$('#tab-studio, #tab-trainer, #tab-about').forEach(el=> el.style.display='none');
      $('#tab-'+name).style.display='block';
    }

    // --- Particles & Toast ---
    function spawnNoteParticles(fromEl){
      const party = $('#party'); const rect = fromEl.getBoundingClientRect(); const host = party.getBoundingClientRect();
      const x = rect.left + rect.width/2 - host.left; const y = rect.top + 10 - host.top;
      const g = document.createElement('div');
      g.style.position='absolute'; g.style.left=(x-12)+'px'; g.style.top=(y-6)+'px';
      const symbols = ['â™ª','â™«','â™©','â™¬'];
      for(let i=0;i<3;i++){
        const s = document.createElement('div'); s.className='note'; s.style.left = (x + randInt(-10,10))+'px'; s.style.top=(y + randInt(-6,6))+'px';
        s.style.animationDelay = (i*0.05)+'s'; s.textContent = symbols[randInt(0,symbols.length-1)];
        party.appendChild(s); setTimeout(()=> s.remove(), 1400);
      }
    }
    function spawnBurst(){
      const party = $('#party'); const host = party.getBoundingClientRect();
      for(let i=0;i<14;i++){
        const s = document.createElement('div'); s.className='note';
        s.style.left = randInt(0, host.width-10)+'px'; s.style.top = (host.height-10)+'px';
        s.style.animationDelay = (i*0.03)+'s'; s.textContent = ['â™ª','â™«','â™©','â™¬'][i%4];
        party.appendChild(s); setTimeout(()=> s.remove(), 1400);
      }
    }
    function showToast(msg, ms=900){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._h); t._h=setTimeout(()=> t.style.display='none', ms); }

    // --- Wire up ---
    function init(){
      buildPiano(); fillSelectors(); setLabelsVisible(true); setScore();

      // Controls
      $('#wave').addEventListener('change', e=> Audio.setWave(e.target.value));
      $('#vol').addEventListener('input', e=> Audio.setVolume(+e.target.value));
      $('#sustain').addEventListener('change', e=> Audio.sustain = e.target.checked);
      $('#labels').addEventListener('change', e=> setLabelsVisible(e.target.checked));
      $('#accid').addEventListener('change', ()=> { refreshLabels(); fillSelectors(); updateSummary(); });
      $('#panic').addEventListener('click', ()=> Audio.panic());

      // Explorer
      $('#playScale').addEventListener('click', playScale);
      $('#playChord').addEventListener('click', playChord);
      $('#root').addEventListener('change', ()=> { updateSummary(); highlightPCs([]) });
      $('#scale').addEventListener('change', ()=> { updateSummary(); highlightPCs([]) });
      $('#chord').addEventListener('change', ()=> { updateSummary(); highlightPCs([]) });

      // Tabs
      $$('.tab-btn').forEach(b=> b.addEventListener('click',()=> setTab(b.dataset.tab)));

      // Ear training
      $('#exPlay').addEventListener('click', playCurrent);
      $('#exNext').addEventListener('click', ()=> { newQuestion(); playCurrent(); });
      $('#exType').addEventListener('change', newQuestion);

      // Audio gate
      const unlock = async ()=>{ await Audio.start(); $('#gate').style.display='none'; };
      $('#gateBtn').addEventListener('click', unlock);
      window.addEventListener('pointerdown', ()=>{ if(!Audio.started){ unlock() } }, {once:true});

      // First question prepped
      newQuestion();
    }

    // Start
    window.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>