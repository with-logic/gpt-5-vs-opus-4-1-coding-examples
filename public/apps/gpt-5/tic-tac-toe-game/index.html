<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#b68d2d" />
  <title>SPQR Tic Tac Toe</title>
  <!-- Google Fonts (allowed) -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --gold:#c9a646;
      --gold-deep:#b68d2d;
      --crimson:#7b1e22;
      --olive:#5e6b3a;
      --ink:#1a1a1a;
      --card:rgba(255,255,255,.65);
      --card-border:rgba(0,0,0,.12);
      --text:#1a1a1a;
      --muted:#445;
      --gap:1.2vmin;
      --radius:14px;
      --shadow:0 10px 24px rgba(0,0,0,.15);
      --board-size:min(92vmin, 860px);
      --cell-bg:rgba(255,255,255,.75);
      --cell-hover:rgba(255,255,255,.95);
      --cell-ink:#0b0b0b;
      --banner-bg:rgba(255,255,255,.85);
      --marble-filter:contrast(1.05) brightness(1.04) saturate(1.02);
    }
    [data-theme="night"]{
      --text:#f3f3f3;
      --muted:#cfd3d9;
      --card:rgba(16,16,20,.55);
      --card-border:rgba(255,255,255,.08);
      --cell-bg:rgba(28,28,34,.6);
      --cell-hover:rgba(36,36,44,.9);
      --cell-ink:#f3f3f3;
      --banner-bg:rgba(22,22,26,.7);
      --marble-filter:contrast(1.05) brightness(.9) saturate(1.05);
    }
    [data-theme="legion"]{
      --text:#f6f2e7;
      --muted:#f0e9d1;
      --card:rgba(38,18,18,.65);
      --card-border:rgba(255,255,255,.08);
      --cell-bg:rgba(56,24,24,.6);
      --cell-hover:rgba(62,28,28,.9);
      --cell-ink:#f6f2e7;
      --banner-bg:rgba(40,20,20,.7);
      --marble-filter:contrast(1.15) brightness(.92) saturate(1.2);
    }

    html,body{height:100%;}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text); background:#f8f8f8; overflow-x:hidden;
      /* Marble background (SVG turbulence) + subtle Colosseum silhouette */
      background-image:
        radial-gradient(1200px 600px at 120% 120%, rgba(0,0,0,.12), transparent 50%),
        url("data:image/svg+xml;utf8,\
          <svg xmlns='http://www.w3.org/2000/svg' width='1200' height='1200'>\
            <defs>\
              <filter id='m' x='0' y='0' width='100%' height='100%'>\
                <feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' seed='7' result='n'/>\
                <feColorMatrix in='n' type='matrix' values='0 0 0 0 0.92  0 0 0 0 0.92  0 0 0 0 0.92  0 0 0 0.2 0'/>\
              </filter>\
            </defs>\
            <rect width='100%' height='100%' fill='white'/>\
            <rect width='100%' height='100%' filter='url(%23m)' opacity='0.35'/>\
          </svg>");
      background-blend-mode:overlay; background-size: cover; backdrop-filter: var(--marble-filter);
      position:relative;
    }

    /* Subtle Colosseum silhouette bottom-left */
    body:before{
      content:""; position:fixed; left:-6vmin; bottom:-1vmin; width:min(60vmin,55vh); height:min(28vmin,26vh); pointer-events:none; opacity:.12;
      background: radial-gradient(200% 120% at 0% 100%, rgba(123,30,34,.55), transparent 40%),
                  linear-gradient( to right, rgba(0,0,0,.4), rgba(0,0,0,0));
      -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 300"><path d="M0 260c10-25 40-45 100-60s110-25 170-25 120 8 170 25 90 35 100 60v40H0v-40Zm60-10h40v-50H60v50Zm70 0h40v-70h-40v70Zm70 0h40v-80h-40v80Zm70 0h40v-90h-40v90Zm70 0h40v-80h-40v80Zm70 0h40v-70h-40v70Zm70 0h40v-50h-40v50Z" fill="black"/></svg>') center/contain no-repeat;
      mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 300"><path d="M0 260c10-25 40-45 100-60s110-25 170-25 120 8 170 25 90 35 100 60v40H0v-40Zm60-10h40v-50h-40v50Zm70 0h40v-70h-40v70Zm70 0h40v-80h-40v80Zm70 0h40v-90h-40v90Zm70 0h40v-80h-40v80Zm70 0h40v-70h-40v70Zm70 0h40v-50h-40v50Z" fill="black"/></svg>') center/contain no-repeat;
    }

    header.topbar{
      position:sticky; top:0; z-index:3; backdrop-filter: blur(6px) saturate(1.1);
      background:linear-gradient(to bottom, rgba(255,255,255,.85), rgba(255,255,255,.6));
      border-bottom:1px solid var(--card-border);
      padding: clamp(8px, 1.4vmin, 18px) clamp(10px, 2vmin, 28px);
    }
    [data-theme="night"] header.topbar,
    [data-theme="legion"] header.topbar{
      background:linear-gradient(to bottom, rgba(18,18,22,.82), rgba(18,18,22,.55));
    }
    .topbar-inner{display:flex; align-items:center; gap:16px; justify-content:space-between; max-width:1200px; margin:0 auto;}

    .crest{display:flex; align-items:center; gap:12px;}
    .crest svg{width:40px; height:40px; filter: drop-shadow(0 2px 6px rgba(0,0,0,.3));}
    .title{font-family:Cinzel, serif; font-weight:800; letter-spacing:.08em; text-transform:uppercase; font-size: clamp(16px, 2.2vmin, 22px);}

    .actions{display:flex; gap:8px; flex-wrap:wrap;}
    .btn{appearance:none; border:none; color:var(--ink); background:linear-gradient(180deg, #fff, #f2eee4); color:#4b3b1a; padding:.65em 1em; border-radius:12px; box-shadow:0 2px 0 rgba(0,0,0,.06), 0 6px 14px rgba(0,0,0,.1) inset; cursor:pointer; font-weight:600; font-size: clamp(12px, 1.7vmin, 15px); border:1px solid rgba(0,0,0,.08); transition: transform .06s ease, filter .2s ease, box-shadow .2s ease;}
    .btn:hover{transform: translateY(-1px);} .btn:active{transform: translateY(1px) scale(.98);} .btn:focus-visible{outline:2px solid var(--gold); outline-offset:2px;}

    [data-theme="night"] .btn, [data-theme="legion"] .btn{background:linear-gradient(180deg, #2a2a32, #1e1e25); color:#f0e8d8; border:1px solid rgba(255,255,255,.08);} 

    .btn.gold{background:linear-gradient(180deg, #f4e6ba, #d8bf6a); color:#3b2f10; border:1px solid #c7a64a;}

    .banner-wrap{max-width:1200px; margin:0 auto;}
    .banner{min-height:40px; display:flex; align-items:center; justify-content:center; padding:8px 12px; position:relative; z-index:1;}
    .banner .flag{display:inline-flex; gap:.5em; align-items:center; background:var(--banner-bg); border:1px solid var(--card-border); padding:.5em 1em; border-radius:999px; box-shadow:var(--shadow); font-weight:700; font-family:Cinzel,serif; letter-spacing:.06em; color:var(--text);} 

    .score-wrap{max-width:1200px; margin:10px auto 0; padding:0 12px;}
    .score{
      display:flex; align-items:center; justify-content:center; gap:16px; flex-wrap:wrap; 
      background:var(--card); border:1px solid var(--card-border); padding:10px 14px; border-radius:16px; box-shadow: var(--shadow);
      font-weight:700; letter-spacing:.04em; font-family:Cinzel,serif;
    }
    .score .pill{display:inline-flex; align-items:center; gap:8px; padding:.3em .8em; border-radius:999px; border:1px solid var(--card-border); background:rgba(255,255,255,.35)}
    [data-theme="night"] .score .pill, [data-theme="legion"] .score .pill{background:rgba(255,255,255,.08)}

    main{max-width:1200px; margin:10px auto; padding:10px 12px 24px;}

    .board-shell{display:flex; align-items:center; justify-content:center;}
    #board{
      width:var(--board-size); height:var(--board-size);
      display:grid; grid-template-columns:repeat(3, 1fr); grid-template-rows:repeat(3, 1fr); gap:var(--gap);
      background:linear-gradient(180deg, rgba(255,255,255,.5), rgba(255,255,255,.2)); padding:var(--gap);
      border-radius:calc(var(--radius) + 6px); box-shadow:var(--shadow); border:1px solid var(--card-border);
      position:relative;
    }

    .cell{position:relative; border-radius:var(--radius); background:var(--cell-bg); border:1px solid rgba(0,0,0,.06); display:flex; align-items:center; justify-content:center; 
      font-size: clamp(28px, 12vmin, 120px); font-weight:800; color:var(--cell-ink); cursor:pointer; user-select:none; -webkit-tap-highlight-color: transparent; transition: background .2s ease, transform .05s ease, filter .3s ease;}
    .cell:hover{background:var(--cell-hover);} .cell:active{transform:scale(.985);} 
    .cell[aria-disabled="true"]{cursor:not-allowed;}
    .cell svg{width:68%; height:68%;}
    .cell .glyph{transform: translateZ(0);} 

    /* Grid frame (Roman inlaid gold) */
    #board::before{
      content:""; position:absolute; width:100%; height:100%; pointer-events:none; border-radius:calc(var(--radius) + 8px);
      left:0; top:0;
      box-shadow: inset 0 0 0 3px rgba(198, 166, 74, .35), inset 0 0 40px rgba(198,166,74,.25);
    }

    /* Win highlight */
    .win{position:relative;}
    .win::after{content:""; position:absolute; inset:-2px; border-radius:inherit; border:3px solid var(--gold); box-shadow:0 0 0 2px rgba(198,166,74,.25) inset, 0 0 22px rgba(198,166,74,.55); animation:shine 1.8s linear infinite;}
    @keyframes shine{0%{filter:brightness(1)}50%{filter:brightness(1.15)}100%{filter:brightness(1)}}

    /* Dialog */
    dialog{border:none; padding:0; border-radius:16px; overflow:hidden; box-shadow:0 30px 80px rgba(0,0,0,.35); background:var(--card); color:var(--text); width:min(92vw, 680px);} 
    dialog::backdrop{background: rgba(0,0,0,.4);}
    .dlg-head{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--card-border);}
    .dlg-title{font-family:Cinzel,serif; letter-spacing:.08em; font-weight:800; text-transform:uppercase;}
    .dlg-body{display:grid; grid-template-columns:1fr; gap:14px; padding:14px 18px;} 
    .opt{display:grid; gap:8px;}
    .opt label{font-weight:700; letter-spacing:.04em; font-size:.95rem;}
    .choices{display:flex; flex-wrap:wrap; gap:8px;}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:.5em .9em; border-radius:999px; border:1px solid var(--card-border); cursor:pointer; background:rgba(255,255,255,.35);}
    [data-theme="night"] .chip,[data-theme="legion"] .chip{background:rgba(255,255,255,.08)}
    .chip input{appearance:none; width:1px; height:1px; position:absolute; opacity:0;}
    .chip[data-checked="true"]{outline:2px solid var(--gold); box-shadow:0 0 0 2px rgba(198,166,74,.25);} 
    .dlg-foot{display:flex; justify-content:flex-end; gap:10px; padding:14px 18px; border-top:1px solid var(--card-border);} 

    .muted{color:var(--muted); font-size:.9rem;}
    .visually-hidden{position:absolute!important; clip:rect(1px,1px,1px,1px); clip-path:inset(50%); width:1px!important; height:1px!important; overflow:hidden!important; white-space:nowrap!important;}

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{animation:none!important; transition:none!important;}
    }

    /* Responsive tweaks */
    @media (max-width:700px){
      .actions{gap:6px}
      .score{gap:10px}
    }
  </style>
</head>
<body data-theme="day">
  <canvas id="confetti" aria-hidden="true"></canvas>
  <header class="topbar" role="banner">
    <div class="topbar-inner">
      <div class="crest" aria-hidden="true">
        <!-- SPQR crest: eagle + laurel -->
        <svg viewBox="0 0 96 96" role="img" aria-label="SPQR crest"><defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#f4e6ba"/><stop offset="100%" stop-color="#c7a64a"/></linearGradient>
        </defs>
        <circle cx="48" cy="48" r="45" fill="url(#g)" stroke="#8c6b17" stroke-width="2"/>
        <path d="M48 22c6 0 14 6 16 10-6-1-10 2-16 2s-10-3-16-2c2-4 10-10 16-10Zm-24 34c0-8 7-12 12-12 6 0 6 8 12 8s6-8 12-8c5 0 12 4 12 12-8 4-24 14-36 14S32 60 24 56Z" fill="#7b5d14"/>
        <text x="49" y="55" text-anchor="middle" font-family="Cinzel,serif" font-weight="800" font-size="18" fill="#2a2309">SPQR</text>
        </svg>
        <div class="title">Tic Tac Toe</div>
      </div>
      <div class="actions">
        <button class="btn" id="newRoundBtn" type="button">New Round</button>
        <button class="btn gold" id="customizeBtn" type="button">Customize</button>
        <button class="btn" id="resetScoresBtn" type="button">Reset Scores</button>
      </div>
    </div>
  </header>

  <div class="banner-wrap">
    <section id="banner" class="banner" aria-live="polite" role="status"></section>
  </div>

  <div class="score-wrap">
    <div id="score" class="score" role="group" aria-label="Scoreboard">
      <div class="pill" aria-live="polite">X: <span id="scoreX" aria-label="X score">0</span></div>
      <div class="pill" aria-live="polite">O: <span id="scoreO" aria-label="O score">0</span></div>
      <div class="pill" aria-live="polite">Draws: <span id="scoreD" aria-label="Draw score">0</span></div>
    </div>
  </div>

  <main>
    <div class="board-shell">
      <div id="board" role="grid" aria-label="Tic Tac Toe board" aria-rowcount="3" aria-colcount="3"></div>
      <div id="live" class="visually-hidden" aria-live="polite"></div>
    </div>
  </main>

  <dialog id="customDialog" aria-modal="true" aria-labelledby="dlgTitle">
    <div class="dlg-head">
      <div class="dlg-title" id="dlgTitle">Customize</div>
      <button class="btn" form="customForm">Save</button>
    </div>
    <form id="customForm" method="dialog">
      <div class="dlg-body">
        <div class="opt">
          <label>Theme</label>
          <div class="choices" data-group="theme">
            <label class="chip"><input type="radio" name="theme" value="day"><span>Marble Day</span></label>
            <label class="chip"><input type="radio" name="theme" value="night"><span>Night Legion</span></label>
            <label class="chip"><input type="radio" name="theme" value="legion"><span>Crimson Legion</span></label>
          </div>
          <div class="muted">Gold accents and marble textures honor Rome.</div>
        </div>
        <div class="opt">
          <label>Glyphs</label>
          <div class="choices" data-group="glyphs">
            <label class="chip"><input type="radio" name="glyphs" value="classic"><span>Standard X / O</span></label>
            <label class="chip"><input type="radio" name="glyphs" value="iconic"><span>Gladius / Laurel</span></label>
          </div>
        </div>
        <div class="opt">
          <label>Mode</label>
          <div class="choices" data-group="mode">
            <label class="chip"><input type="radio" name="mode" value="two"><span>2‑Player</span></label>
            <label class="chip"><input type="radio" name="mode" value="ai"><span>vs AI</span></label>
          </div>
        </div>
        <div class="opt">
          <label>First Move</label>
          <div class="choices" data-group="first">
            <label class="chip"><input type="radio" name="first" value="X"><span>X</span></label>
            <label class="chip"><input type="radio" name="first" value="O"><span>O</span></label>
          </div>
        </div>
        <div class="opt">
          <label>AI Discipline</label>
          <div class="choices" data-group="ai">
            <label class="chip"><input type="radio" name="ai" value="perfect"><span>Perfect</span></label>
            <label class="chip"><input type="radio" name="ai" value="pragmatic"><span>Pragmatic</span></label>
            <label class="chip"><input type="radio" name="ai" value="reckless"><span>Reckless</span></label>
          </div>
          <div class="muted">Perfect: Minimax. Pragmatic: Mostly optimal. Reckless: Opportunistic.</div>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn" value="cancel" formmethod="dialog">Cancel</button>
        <button class="btn gold" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <script>
  ;(()=>{
    const state = {
      board: Array(9).fill(null),
      current: 'X',
      scores: {X:0, O:0, D:0},
      settings: {
        theme: 'day',
        glyphs: 'classic', // classic | iconic
        mode: 'ai',        // ai | two
        first: 'X',        // X | O
        ai: 'perfect'      // perfect | pragmatic | reckless
      },
      busy:false,
      winLine:null,
    };

    const boardEl = document.getElementById('board');
    const bannerEl = document.getElementById('banner');
    const liveEl = document.getElementById('live');
    const scoreX = document.getElementById('scoreX');
    const scoreO = document.getElementById('scoreO');
    const scoreD = document.getElementById('scoreD');
    const confettiCanvas = document.getElementById('confetti');
    const customizeDialog = document.getElementById('customDialog');
    const customForm = document.getElementById('customForm');

    // Persistence
    const load = () => {
      try{
        const s = JSON.parse(localStorage.getItem('ttt.settings')); if(s) Object.assign(state.settings, s);
        const sc = JSON.parse(localStorage.getItem('ttt.scores')); if(sc) Object.assign(state.scores, sc);
      }catch(e){/* ignore */}
    };
    const save = () => {
      localStorage.setItem('ttt.settings', JSON.stringify(state.settings));
      localStorage.setItem('ttt.scores', JSON.stringify(state.scores));
    };

    load();
    document.body.setAttribute('data-theme', themeMap(state.settings.theme));

    // Build board cells
    const buildBoard = () => {
      boardEl.innerHTML = '';
      for(let i=0;i<9;i++){
        const r = Math.floor(i/3)+1; const c = i%3+1;
        const btn = document.createElement('button');
        btn.className = 'cell';
        btn.id = 'cell'+i;
        btn.setAttribute('role','gridcell');
        btn.setAttribute('aria-rowindex', String(r));
        btn.setAttribute('aria-colindex', String(c));
        btn.setAttribute('aria-label', `Cell ${r}, ${c}, empty`);
        btn.dataset.index = String(i);
        btn.addEventListener('click', onCellClick);
        btn.addEventListener('keydown', onCellKey);
        boardEl.appendChild(btn);
      }
      updateCells();
    };

    // Glyph rendering
    function glyphFor(mark){
      if(!mark) return '';
      if(state.settings.glyphs === 'classic'){
        return `<span class="glyph" aria-hidden="true" style="font-family:Cinzel,serif;">${mark}</span>`;
      } else {
        return mark === 'X' ? svgCrossSwords() : svgLaurelWreath();
      }
    }

    function svgCrossSwords(){
      return `<svg viewBox="0 0 100 100" class="glyph" aria-hidden="true">
        <defs>
          <linearGradient id="metal" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#fafafa"/>
            <stop offset="50%" stop-color="#d0d0d5"/>
            <stop offset="100%" stop-color="#b7b7bf"/>
          </linearGradient>
          <linearGradient id="hilt" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#c7a64a"/>
            <stop offset="100%" stop-color="#8c6b17"/>
          </linearGradient>
        </defs>
        <g transform="translate(50,50) rotate(45) translate(-50,-50)">
          <path d="M20 15 h12 l6 10 -6 10 h-12z" fill="url(#hilt)"/>
          <rect x="24" y="35" width="8" height="42" rx="3" fill="url(#metal)"/>
          <path d="M22 77 h12 l-6 12z" fill="#5a5a62"/>
        </g>
        <g transform="translate(50,50) rotate(-45) translate(-50,-50)">
          <path d="M68 15 h12 l6 10 -6 10 h-12z" fill="url(#hilt)"/>
          <rect x="72" y="35" width="8" height="42" rx="3" fill="url(#metal)"/>
          <path d="M70 77 h12 l-6 12z" fill="#5a5a62"/>
        </g>
      </svg>`;
    }

    function svgLaurelWreath(){
      const leaves=[]; const n=14; const R=36; const r=18;
      for(let i=0;i<n;i++){
        const a=(Math.PI*2)*(i/n);
        const x=50+Math.cos(a)*R, y=50+Math.sin(a)*R;
        const rot=a*180/Math.PI+90;
        leaves.push(`<ellipse cx="${x}" cy="${y}" rx="${8}" ry="${16}" transform="rotate(${rot} ${x} ${y})" fill="#3f5d2a" stroke="#c7a64a" stroke-width="1"/>`);
      }
      return `<svg viewBox="0 0 100 100" class="glyph" aria-hidden="true">
        <circle cx="50" cy="50" r="${r}" fill="none" stroke="#c7a64a" stroke-width="3"/>
        ${leaves.join('')}
      </svg>`;
    }

    // Helpers
    const lines = [
      [0,1,2],[3,4,5],[6,7,8],
      [0,3,6],[1,4,7],[2,5,8],
      [0,4,8],[2,4,6]
    ];
    function winner(board){
      for(const L of lines){
        const [a,b,c]=L; if(board[a] && board[a]===board[b] && board[a]===board[c]) return {mark:board[a], line:L};
      }
      if(board.every(Boolean)) return {mark:'D', line:null};
      return null;
    }
    function avail(board){ return board.reduce((a,v,i)=>{ if(!v) a.push(i); return a; }, []); }

    // Minimax
    function minimax(board, player, aiMark, depth=0){
      const res = winner(board);
      if(res){
        if(res.mark==='D') return {score:0, move:null};
        if(res.mark===aiMark) return {score:10-depth, move:null};
        return {score:depth-10, move:null};
      }
      const moves = avail(board);
      const isMax = player===aiMark;
      let best = {score: isMax? -Infinity : Infinity, move:moves[0]};
      for(const m of moves){
        board[m]=player;
        const next = minimax(board, player==='X'?'O':'X', aiMark, depth+1);
        board[m]=null;
        const sc = next.score;
        if(isMax && sc>best.score) best={score:sc, move:m};
        if(!isMax && sc<best.score) best={score:sc, move:m};
      }
      return best;
    }

    function aiMove(){
      if(state.settings.mode!=='ai') return;
      const aiMark = state.current; // AI moves on its turn
      const possible = avail(state.board);
      if(possible.length===0) return;

      let move;
      const discipline = state.settings.ai;
      if(discipline==='perfect'){
        move = minimax(state.board.slice(), aiMark, aiMark).move;
      } else if(discipline==='pragmatic'){
        // 75% optimal, else choose among good-enough or random
        if(Math.random()<0.75){ move = minimax(state.board.slice(), aiMark, aiMark).move; }
        else {
          // Prefer center, then corners, else random
          if(possible.includes(4)) move=4; else {
            const corners = possible.filter(i=>[0,2,6,8].includes(i));
            move = corners[0] ?? possible[Math.floor(Math.random()*possible.length)];
          }
        }
      } else { // reckless
        // 30% optimal, 70% heuristic/random; favors dramatic play
        if(Math.random()<0.3){ move = minimax(state.board.slice(), aiMark, aiMark).move; }
        else {
          const center = possible.includes(4)?4:null;
          const forks = [0,2,6,8].filter(i=>possible.includes(i));
          move = center ?? forks[Math.floor(Math.random()*forks.length)] ?? possible[Math.floor(Math.random()*possible.length)];
        }
      }
      place(move);
    }

    // Interaction
    function onCellClick(e){
      const i = Number(e.currentTarget.dataset.index);
      if(state.busy || state.board[i] || state.winLine) return;
      place(i);
    }

    function place(i){
      if(state.board[i]) return;
      state.board[i] = state.current;
      updateCells();
      const res = winner(state.board);
      if(res){
        endRound(res);
      } else {
        state.current = state.current==='X'?'O':'X';
        announceTurn();
        if(state.settings.mode==='ai' && state.current !== humanPlays()){
          // slight delay for natural feel
          state.busy=true; setTimeout(()=>{ state.busy=false; aiMove(); }, 160);
        }
      }
    }

    function updateCells(){
      for(let i=0;i<9;i++){
        const cell = document.getElementById('cell'+i);
        const v = state.board[i];
        cell.innerHTML = v ? glyphFor(v) : '';
        cell.setAttribute('aria-label', `Cell ${Math.floor(i/3)+1}, ${i%3+1}, ${v? (v==='X'?'X placed':'O placed'):'empty'}`);
        cell.setAttribute('aria-disabled', v? 'true':'false');
        cell.classList.remove('win');
      }
      if(state.winLine){
        for(const idx of state.winLine) document.getElementById('cell'+idx).classList.add('win');
      }
    }

    function announceTurn(){
      liveEl.textContent = `${state.current} to move`;
    }

    function endRound(res){
      state.winLine = res.line;
      if(res.line) for(const i of res.line) document.getElementById('cell'+i).classList.add('win');
      let text;
      if(res.mark==='D'){ state.scores.D++; text = 'Pax Romana — Draw'; }
      else { state.scores[res.mark]++; text = `Victoria! ${res.mark} triumphs.`; }
      updateScores(); save();
      showBanner(text, res.mark);
      fireConfetti(res.mark);
    }

    function updateScores(){ scoreX.textContent = state.scores.X; scoreO.textContent = state.scores.O; scoreD.textContent = state.scores.D; }

    function showBanner(text, mark){
      bannerEl.innerHTML = '';
      const span = document.createElement('div'); span.className='flag';
      span.innerHTML = `<span style="color:${mark==='D'? 'var(--muted)':'var(--gold)'}">◆</span> <span>${text}</span>`;
      bannerEl.appendChild(span);
    }

    function clearBanner(){ bannerEl.innerHTML=''; }

    function newRound(){
      state.board = Array(9).fill(null);
      state.winLine=null; state.busy=false; clearBanner();
      state.current = state.settings.first;
      updateCells(); announceTurn();
      if(state.settings.mode==='ai' && state.current !== humanPlays()){
        setTimeout(()=>aiMove(), 220);
      }
    }

    function resetScores(){ state.scores={X:0,O:0,D:0}; updateScores(); save(); }

    // Determine which side the human plays when vs AI: human is the opposite of AI when AI has first.
    function humanPlays(){
      // Human defaults to X; if first mover is O, AI begins as O, so human is X; if first mover is X, human is X (AI plays O)
      // This keeps UI simple while honoring "First move".
      return 'X';
    }

    // Dialog setup
    function syncDialog(){
      const map = new Map(Object.entries(state.settings));
      customForm.querySelectorAll('input[type=radio]').forEach(i=>{
        if(map.get(i.name)===i.value) i.checked = true;
        i.closest('.chip').dataset.checked = i.checked ? 'true' : 'false';
      });
    }
    function readDialog(){
      const data = new FormData(customForm);
      state.settings.theme = data.get('theme')||state.settings.theme;
      state.settings.glyphs = data.get('glyphs')||state.settings.glyphs;
      state.settings.mode = data.get('mode')||state.settings.mode;
      state.settings.first = data.get('first')||state.settings.first;
      state.settings.ai = data.get('ai')||state.settings.ai;
      save();
      document.body.setAttribute('data-theme', themeMap(state.settings.theme));
      updateCells();
      newRound();
    }

    function themeMap(v){
      if(v==='night') return 'night';
      if(v==='legion') return 'legion';
      return 'day';
    }

    customForm.addEventListener('change', (e)=>{
      const chip = e.target.closest('.chip'); if(chip){
        chip.parentElement.querySelectorAll('.chip').forEach(c=>c.dataset.checked='false');
        chip.dataset.checked = 'true';
      }
    });

    document.getElementById('customizeBtn').addEventListener('click', ()=>{ syncDialog(); customizeDialog.showModal(); });
    customForm.addEventListener('submit', (e)=>{ e.preventDefault(); readDialog(); customizeDialog.close(); });

    document.getElementById('newRoundBtn').addEventListener('click', ()=> newRound());
    document.getElementById('resetScoresBtn').addEventListener('click', ()=> resetScores());

    // Keyboard navigation within grid
    function onCellKey(e){
      const i = Number(e.currentTarget.dataset.index);
      const row = Math.floor(i/3), col = i%3;
      let n = i;
      switch(e.key){
        case 'ArrowUp': n = (row+2)%3*3 + col; break;
        case 'ArrowDown': n = (row+1)%3*3 + col; break;
        case 'ArrowLeft': n = row*3 + (col+2)%3; break;
        case 'ArrowRight': n = row*3 + (col+1)%3; break;
        case 'Enter': case ' ': e.preventDefault(); e.currentTarget.click(); return;
        default: return;
      }
      e.preventDefault(); document.getElementById('cell'+n).focus();
    }

    // Confetti
    const PRM = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let confettiRunning=false, rafId=null;
    function fireConfetti(mark){
      if(PRM) return; // respect reduced motion
      const ctx = confettiCanvas.getContext('2d');
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      confettiCanvas.width = Math.floor(innerWidth * dpr);
      confettiCanvas.height = Math.floor(innerHeight * dpr);
      confettiCanvas.style.width = innerWidth+'px';
      confettiCanvas.style.height = innerHeight+'px';
      confettiCanvas.style.position='fixed'; confettiCanvas.style.left=0; confettiCanvas.style.top=0;
      confettiCanvas.style.pointerEvents='none'; confettiCanvas.style.zIndex=2;
      const colors = mark==='D' ? ['#888','#bbb','#ddd'] : ['#c7a64a','#f4e6ba', '#7b1e22', '#5e6b3a'];
      const count = Math.min(220, Math.floor((innerWidth+innerHeight)/6));
      const particles = Array.from({length:count}, ()=>({
        x: Math.random()*confettiCanvas.width,
        y: -Math.random()*confettiCanvas.height*0.2,
        r: 3 + Math.random()*7,
        vx: (-1+Math.random()*2)*.6*dpr,
        vy: (2+Math.random()*3)*dpr,
        a: Math.random()*Math.PI*2,
        s: (0.02+Math.random()*0.06)*dpr,
        col: colors[Math.floor(Math.random()*colors.length)],
        shape: Math.random()<.5 ? 'rect':'tri'
      }));
      confettiRunning=true;
      const start = performance.now();
      (function loop(t){
        if(!confettiRunning) return; rafId=requestAnimationFrame(loop);
        const elapsed = t-start; if(elapsed>2100){ confettiRunning=false; cancelAnimationFrame(rafId); ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); return;}
        ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
        for(const p of particles){
          p.x += p.vx; p.y += p.vy; p.a += p.s; if(p.y>confettiCanvas.height) { p.y=-10; p.x=Math.random()*confettiCanvas.width; }
          ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.a);
          ctx.fillStyle = p.col; ctx.strokeStyle = 'rgba(0,0,0,.15)';
          if(p.shape==='rect'){ ctx.fillRect(-p.r, -p.r/2, p.r*2, p.r); }
          else { ctx.beginPath(); ctx.moveTo(0,-p.r); ctx.lineTo(p.r,p.r); ctx.lineTo(-p.r,p.r); ctx.closePath(); ctx.fill(); }
          ctx.restore();
        }
      })(start);
    }

    // Dynamic board sizing to avoid overlap
    function sizeBoard(){
      const header = document.querySelector('header');
      const bannerH = document.getElementById('banner').offsetHeight;
      const scoreH = document.getElementById('score').offsetHeight + 16;
      const padding = 40;
      const avail = Math.max(240, window.innerHeight - header.offsetHeight - bannerH - scoreH - padding);
      const side = Math.min(avail, window.innerWidth - 24, 860);
      document.documentElement.style.setProperty('--board-size', side+'px');
    }

    window.addEventListener('resize', sizeBoard);

    // Init
    buildBoard(); updateScores(); sizeBoard();
    state.current = state.settings.first;
    announceTurn();
    if(state.settings.mode==='ai' && state.current !== humanPlays()) setTimeout(()=>aiMove(), 260);

  })();
  </script>
</body>
</html>
