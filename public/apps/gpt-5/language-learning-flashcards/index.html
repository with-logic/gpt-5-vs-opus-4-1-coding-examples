<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Language Learning Flashcards</title>
  <meta name="description" content="Interactive travel phrase flashcards with flip animations, shuffle, and progress tracking." />
  <style>
    :root{
      --bg1:#0f172a; /* slate-900 */
      --bg2:#1e293b; /* slate-800 */
      --card:#0b1220cc; /* glass */
      --text:#e5e7eb; /* gray-200 */
      --muted:#94a3b8; /* slate-400 */
      --accent:#22d3ee; /* cyan-400 */
      --accent-2:#a78bfa; /* violet-400 */
      --ok:#34d399; /* emerald-400 */
      --warn:#f59e0b; /* amber-500 */
      --danger:#f43f5e; /* rose-500 */
      --shadow: 0 20px 60px rgba(0,0,0,.45), 0 6px 18px rgba(0,0,0,.3);
      --radius: 16px;
      --ring: 0 0 0 3px color-mix(in oklab, var(--accent) 50%, transparent);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg1:#eef2ff; --bg2:#e2e8f0; --card:#ffffffee; --text:#0b1220; --muted:#475569; --shadow: 0 14px 40px rgba(2,6,23,.20), 0 4px 12px rgba(2,6,23,.10);}
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 800px at 15% 10%, color-mix(in oklab, var(--accent) 18%, var(--bg1)), var(--bg1)),
                  radial-gradient(900px 600px at 85% 85%, color-mix(in oklab, var(--accent-2) 18%, var(--bg2)), var(--bg2));
      background-attachment: fixed;
      line-height:1.5;
    }
    .app{max-width:1100px;margin-inline:auto;padding:24px 18px 40px;}
    .topbar{display:grid;grid-template-columns:1fr auto;gap:18px;align-items:center;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:32px;height:32px;filter: drop-shadow(0 6px 12px rgba(0,0,0,.35));}
    .brand .title{font-weight:800;letter-spacing:.2px}
    .brand .subtitle{display:block;margin-top:2px;font-size:.9rem;color:var(--muted)}

    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-end}
    .field{display:flex;align-items:center;gap:8px;padding:8px 10px;background:color-mix(in oklab, var(--card) 95%, transparent);border:1px solid color-mix(in oklab, var(--muted) 18%, transparent);border-radius:12px}
    .field label{font-size:.85rem;color:var(--muted)}
    select{appearance:none;background:transparent;border:none;color:var(--text);font-weight:600;padding:4px 26px 4px 4px;border-radius:8px;outline:none}
    .select-wrap{position:relative}
    .select-wrap:after{content:"â–¾";position:absolute;right:6px;top:50%;translate:0 -50%;opacity:.6;pointer-events:none}

    .btn{--bg: color-mix(in oklab, var(--accent) 12%, var(--card));--bd: color-mix(in oklab, var(--accent) 40%, transparent);display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:var(--bg);color:var(--text);font-weight:700;cursor:pointer;box-shadow:var(--shadow);transition:transform .2s ease, box-shadow .2s ease, background .2s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.ghost{background:color-mix(in oklab, var(--card) 70%, transparent);border-color: color-mix(in oklab, var(--muted) 18%, transparent);box-shadow:none}
    .btn.accent{--bg: color-mix(in oklab, var(--ok) 12%, var(--card));--bd: color-mix(in oklab, var(--ok) 40%, transparent)}

    .status{display:flex;align-items:center;justify-content:space-between;margin:8px 2px 16px 2px;gap:12px}
    .progress{flex:1;height:10px;background:color-mix(in oklab, var(--card) 80%, transparent);border-radius:999px;position:relative;overflow:hidden;border:1px solid color-mix(in oklab, var(--muted) 15%, transparent)}
    .bar{position:absolute;inset:0;width:0%;background:linear-gradient(90deg, var(--accent), var(--accent-2));box-shadow:inset 0 0 12px color-mix(in oklab,var(--accent) 40%, transparent);border-radius:999px;transition:width .5s cubic-bezier(.22,1,.36,1)}
    .counts{min-width:220px;text-align:right;color:var(--muted);font-weight:600}

    main{display:grid;place-items:center}
    .stage{width:min(780px, 92vw);display:grid;gap:14px}

    .card{width:100%;aspect-ratio: 16/10;max-height:62vh;min-height:280px; perspective: 1400px; display:grid;place-items:center}
    .card-inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .7s cubic-bezier(.22,1,.36,1)}
    .card.is-flipped .card-inner{transform:rotateY(180deg)}
    .card-face{position:absolute;inset:0;border-radius:var(--radius);background:linear-gradient(180deg, color-mix(in oklab, var(--card) 100%, transparent), color-mix(in oklab, var(--bg2) 6%, transparent));border:1px solid color-mix(in oklab, var(--muted) 22%, transparent);box-shadow:var(--shadow);backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px); padding:22px 24px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:14px; backface-visibility:hidden}
    .card-back{transform:rotateY(180deg)}
    .lang-label{position:absolute;top:14px;left:14px;font-size:.85rem;color:var(--muted);background:color-mix(in oklab, var(--card) 75%, transparent);border:1px solid color-mix(in oklab, var(--muted) 18%, transparent);padding:6px 10px;border-radius:999px;box-shadow: 0 8px 16px rgba(0,0,0,.18)}
    .lang-label .flag{margin-right:8px}
    .phrase{font-size: clamp(22px, 4.2vw, 44px);font-weight:800;letter-spacing:.2px;text-align:center}
    .roman{font-size: clamp(12px, 1.8vw, 16px);color:var(--muted)}
    .hint{position:absolute;bottom:14px;left:50%;translate:-50% 0;color:var(--muted);font-size:.9rem;opacity:.85}

    .actions{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center;margin-top:8px}
    .actions .btn{justify-content:center}
    .actions .btn.ghost{justify-self:start}
    .actions .btn:last-child{justify-self:end}

    .toast{position:fixed;left:50%;top:16px;translate:-50% 0;background:color-mix(in oklab, var(--card) 95%, transparent);border:1px solid color-mix(in oklab, var(--muted) 22%, transparent);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .25s ease, transform .25s ease;transform:translate(-50%, -8px)}
    .toast.show{opacity:1;transform:translate(-50%, 0)}

    /* Shuffle + learned animations */
    .stage.shuffle .card-face{animation: shuffle 600ms ease both}
    @keyframes shuffle{0%{transform:translateY(0) rotate(0)} 45%{transform:translateY(-8px) rotate(-1.2deg)} 100%{transform:translateY(0) rotate(0)}}
    .flyout{animation: flyout .42s cubic-bezier(.55,.16,.34,.98) both}
    @keyframes flyout{0%{opacity:1;transform:translateX(0) rotate(0)} 100%{opacity:0;transform:translateX(80px) rotate(-4deg)}}
    .check{position:absolute;inset:auto auto 16px 16px;background:color-mix(in oklab, var(--ok) 22%, var(--card));border:1px solid color-mix(in oklab, var(--ok) 40%, transparent);color:#052e1b;padding:6px 8px;border-radius:999px;font-weight:800;display:flex;align-items:center;gap:6px;box-shadow:var(--shadow);opacity:0;transform:scale(.9);animation:pop .4s ease .1s both}
    @keyframes pop{to{opacity:1;transform:scale(1)}}

    /* Language chooser */
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg, rgba(0,0,0,.5), rgba(0,0,0,.6));backdrop-filter: blur(6px);-webkit-backdrop-filter: blur(6px);display:grid;place-items:center;padding:24px;z-index:10}
    .chooser{width:min(900px, 92vw);background:linear-gradient(180deg, color-mix(in oklab, var(--card) 100%, transparent), color-mix(in oklab, var(--bg2) 6%, transparent));border:1px solid color-mix(in oklab, var(--muted) 22%, transparent);border-radius:16px;box-shadow:var(--shadow);padding:20px}
    .chooser .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .chooser h2{margin:0 0 8px;font-size:clamp(20px, 3.2vw, 28px)}
    .chooser p{margin:0 0 14px;color:var(--muted)}
    .langs{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .lang-card{cursor:pointer;user-select:none;border:1px solid color-mix(in oklab, var(--muted) 22%, transparent);background:color-mix(in oklab, var(--card) 92%, transparent);border-radius:14px;padding:12px 10px;display:flex;flex-direction:column;align-items:center;gap:8px;text-align:center;transition:transform .18s ease, border-color .2s ease, background .2s ease}
    .lang-card:hover{transform:translateY(-2px);border-color: color-mix(in oklab, var(--accent) 40%, transparent)}
    .lang-card .flag{font-size:24px}
    .lang-card .name{font-weight:800}
    .chooser .footer{display:flex;align-items:center;justify-content:space-between;margin-top:14px}

    /* Confetti */
    .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
    .piece{position:absolute;width:8px;height:14px;opacity:0;transform:translate(-50%, -50%);animation:fall 800ms ease-out both}
    @keyframes fall{0%{opacity:1}100%{transform:translate(var(--dx), var(--dy)) rotate(var(--rot));opacity:0}}

    /* Focus states */
    :focus-visible{outline:none;box-shadow:var(--ring)}

    @media (max-width: 860px){
      .topbar{grid-template-columns:1fr}
      .counts{min-width:auto;text-align:left}
      .chooser .row{grid-template-columns:1fr}
      .langs{grid-template-columns:repeat(2,1fr)}
    }
    @media (prefers-reduced-motion: reduce){
      *{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important;scroll-behavior:auto !important}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="topbar" aria-label="App header">
      <div class="brand">
        <svg class="logo" viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" x2="1">
              <stop offset="0%" stop-color="var(--accent)"/>
              <stop offset="100%" stop-color="var(--accent-2)"/>
            </linearGradient>
          </defs>
          <path fill="url(#g)" d="M14 10h36a4 4 0 0 1 4 4v36a4 4 0 0 1-4 4H14a4 4 0 0 1-4-4V14a4 4 0 0 1 4-4zm9 10a3 3 0 0 0 0 6h18a3 3 0 0 0 0-6H23zm0 10a3 3 0 0 0 0 6h18a3 3 0 0 0 0-6H23zm0 10a3 3 0 0 0 0 6h10a3 3 0 0 0 0-6H23z"/>
        </svg>
        <div>
          <div class="title" id="title" data-i18n="appTitle">Language Learning Flashcards</div>
          <small class="subtitle" id="subtitle" data-i18n="subtitle">Travel-ready questions, fast.</small>
        </div>
      </div>
      <div class="controls" role="group" aria-label="Controls">
        <div class="field">
          <label for="baseLang" data-i18n="myLanguage">My language</label>
          <div class="select-wrap"><select id="baseLang" aria-label="Base language"></select></div>
        </div>
        <div class="field">
          <label for="targetLang" data-i18n="learning">Learning</label>
          <div class="select-wrap"><select id="targetLang" aria-label="Target language"></select></div>
        </div>
        <button class="btn" id="shuffleBtn" aria-label="Shuffle">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
          <span data-i18n="shuffle">Shuffle</span>
        </button>
        <button class="btn ghost" id="resetBtn" aria-label="Reset learned">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"></path><path d="M1 14l5.37 4.37A9 9 0 0 0 20.49 15"></path></svg>
          <span data-i18n="reset">Reset learned</span>
        </button>
      </div>
    </header>

    <section class="status" aria-live="polite">
      <div class="progress" aria-label="Progress"><div class="bar" id="bar"></div></div>
      <div class="counts"><span id="remaining"></span> Â· <span id="learned"></span></div>
    </section>

    <main>
      <div class="stage" id="stage">
        <div class="card" id="card" tabindex="0" role="button" aria-label="Flashcard">
          <div class="card-inner">
            <div class="card-face card-front">
              <div class="lang-label"><span class="flag" id="frontFlag">ðŸ‡ªðŸ‡¸</span><span id="frontLang">Spanish</span></div>
              <div class="phrase" id="frontText">Â¿DÃ³nde estÃ¡ el baÃ±o?</div>
              <div class="roman" id="frontRoma"></div>
              <div class="hint" data-i18n="frontLabel">Tap or press Space to flip</div>
            </div>
            <div class="card-face card-back">
              <div class="lang-label"><span class="flag" id="backFlag">ðŸ‡ºðŸ‡¸</span><span id="backLang">English</span></div>
              <div class="phrase" id="backText">Where is the bathroom?</div>
              <div class="roman" id="backRoma"></div>
              <div class="hint" data-i18n="backLabel">Tap or press Space to flip</div>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="btn ghost" id="prevBtn"><span aria-hidden="true">âŸµ</span> <span data-i18n="prev">Previous</span></button>
          <button class="btn" id="flipBtn" aria-label="Flip">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="16 3 21 3 21 8"></polyline><polyline points="8 21 3 21 3 16"></polyline><path d="M3.51 9A9 9 0 0 1 9 3.51"></path><path d="M14.49 20.49A9 9 0 0 0 20.49 14.49"></path></svg>
            <span data-i18n="flip">Flip</span>
          </button>
          <button class="btn accent" id="learnedBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20 6 9 17 4 12"></polyline></svg>
            <span data-i18n="markLearned">Mark as learned</span>
          </button>
          <button class="btn ghost" id="nextBtn"><span data-i18n="next">Next</span> <span aria-hidden="true">âŸ¶</span></button>
        </div>
      </div>
    </main>
  </div>

  <div class="overlay" id="overlay" hidden>
    <div class="chooser" role="dialog" aria-modal="true" aria-labelledby="chooseTitle">
      <div class="row">
        <div>
          <h2 id="chooseTitle" data-i18n="choosePrompt">Which language do you want to learn?</h2>
          <p data-i18n="subtitle">Travel-ready questions, fast.</p>
          <div class="langs" id="langCards">
            <!-- Populated by JS -->
          </div>
        </div>
        <div>
          <div class="field" style="width:100%;justify-content:space-between">
            <label for="dlgBase" data-i18n="myLanguage">My language</label>
            <div class="select-wrap"><select id="dlgBase" aria-label="My language"></select></div>
          </div>
          <div style="height:10px"></div>
          <button class="btn" id="startBtn" style="width:100%">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            <span data-i18n="start">Start</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>
  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <script>
    ;(function(){
      const LANGS = ['en','es','fr','ja'];
      const FLAGS = { en:'ðŸ‡ºðŸ‡¸', es:'ðŸ‡ªðŸ‡¸', fr:'ðŸ‡«ðŸ‡·', ja:'ðŸ‡¯ðŸ‡µ' };
      const LANGUAGE_NAME = {
        en: { en:'English', es:'Spanish', fr:'French', ja:'Japanese' },
        es: { en:'InglÃ©s', es:'EspaÃ±ol', fr:'FrancÃ©s', ja:'JaponÃ©s' },
        fr: { en:'Anglais', es:'Espagnol', fr:'FranÃ§ais', ja:'Japonais' },
        ja: { en:'è‹±èªž', es:'ã‚¹ãƒšã‚¤ãƒ³èªž', fr:'ãƒ•ãƒ©ãƒ³ã‚¹èªž', ja:'æ—¥æœ¬èªž' }
      };
      const I18N = {
        en: {
          appTitle:'Language Learning Flashcards', subtitle:'Travel-ready questions, fast.',
          choosePrompt:'Which language do you want to learn?', myLanguage:'My language', learning:'Learning',
          shuffle:'Shuffle', markLearned:'Mark as learned', reset:'Reset learned', next:'Next', prev:'Previous',
          remaining:'Remaining', learned:'Learned', flip:'Flip', frontLabel:'Tap or press Space to flip', backLabel:'Tap or press Space to flip',
          start:'Start', progress:'Progress', shuffled:'Shuffled', allLearned:'All cards learned â€” great job!',
          resetDone:'Learned cards reset', learnedOne:'Marked as learned', pronunciation:'Pronunciation'
        },
        es: {
          appTitle:'Tarjetas de Idiomas', subtitle:'Preguntas Ãºtiles para viajar.',
          choosePrompt:'Â¿QuÃ© idioma quieres aprender?', myLanguage:'Mi idioma', learning:'Aprendiendo',
          shuffle:'Barajar', markLearned:'Marcar como aprendido', reset:'Reiniciar aprendidos', next:'Siguiente', prev:'Anterior',
          remaining:'Restantes', learned:'Aprendidos', flip:'Girar', frontLabel:'Toca o pulsa Espacio para girar', backLabel:'Toca o pulsa Espacio para girar',
          start:'Empezar', progress:'Progreso', shuffled:'Barajado', allLearned:'Â¡Has aprendido todas las tarjetas!',
          resetDone:'Aprendidos reiniciados', learnedOne:'Marcado como aprendido', pronunciation:'PronunciaciÃ³n'
        },
        fr: {
          appTitle:'Cartes de Langues', subtitle:'Questions de voyage essentielles.',
          choosePrompt:'Quelle langue voulez-vous apprendre ?', myLanguage:'Ma langue', learning:'Langue Ã  apprendre',
          shuffle:'MÃ©langer', markLearned:'Marquer comme acquis', reset:'RÃ©initialiser les acquis', next:'Suivant', prev:'PrÃ©cÃ©dent',
          remaining:'Restants', learned:'Acquis', flip:'Retourner', frontLabel:'Touchez ou Espace pour retourner', backLabel:'Touchez ou Espace pour retourner',
          start:'Commencer', progress:'Progression', shuffled:'MÃ©langÃ©', allLearned:'Toutes les cartes apprises â€” bravo !',
          resetDone:'Cartes rÃ©initialisÃ©es', learnedOne:'MarquÃ©e comme acquise', pronunciation:'Prononciation'
        },
        ja: {
          appTitle:'èªžå­¦ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰', subtitle:'æ—…ã§å½¹ç«‹ã¤è³ªå•ã‚’ç´ æ—©ãã€‚',
          choosePrompt:'å­¦ã³ãŸã„è¨€èªžã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ', myLanguage:'æ¯èªž', learning:'å­¦ç¿’è¨€èªž',
          shuffle:'ã‚·ãƒ£ãƒƒãƒ•ãƒ«', markLearned:'å­¦ç¿’æ¸ˆã¿ã«ã™ã‚‹', reset:'å­¦ç¿’æ¸ˆã¿ã‚’ãƒªã‚»ãƒƒãƒˆ', next:'æ¬¡ã¸', prev:'å‰ã¸',
          remaining:'æ®‹ã‚Š', learned:'å­¦ç¿’æ¸ˆã¿', flip:'ã‚ãã‚‹', frontLabel:'ã‚¿ãƒƒãƒ—ã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹ã§ã‚ãã‚‹', backLabel:'ã‚¿ãƒƒãƒ—ã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹ã§æˆ»ã™',
          start:'ã¯ã˜ã‚ã‚‹', progress:'é€²æ—', shuffled:'ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã—ãŸ', allLearned:'ã™ã¹ã¦å­¦ç¿’æ¸ˆã¿ã§ã™ã€‚ãŠç–²ã‚Œã•ã¾ï¼',
          resetDone:'ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', learnedOne:'å­¦ç¿’æ¸ˆã¿ã«ã—ã¾ã—ãŸ', pronunciation:'èª­ã¿æ–¹'
        }
      };

      const PHRASES = [
        { key:'bathroom', en:'Where is the bathroom?', es:'Â¿DÃ³nde estÃ¡ el baÃ±o?', fr:'OÃ¹ sont les toilettes ?', ja:'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', jaR:'Toire wa doko desu ka?' },
        { key:'price', en:'How much is this?', es:'Â¿CuÃ¡nto cuesta esto?', fr:'Ã‡a coÃ»te combien ?', ja:'ã“ã‚Œã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ', jaR:'Kore wa ikura desu ka?' },
        { key:'station', en:'Where is the train station?', es:'Â¿DÃ³nde estÃ¡ la estaciÃ³n de tren?', fr:'OÃ¹ est la gare ?', ja:'é§…ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', jaR:'Eki wa doko desu ka?' },
        { key:'speakEnglish', en:'Do you speak English?', es:'Â¿Habla inglÃ©s?', fr:'Parlez-vous anglais ?', ja:'è‹±èªžã‚’è©±ã›ã¾ã™ã‹ï¼Ÿ', jaR:'Eigo o hanasemasu ka?' },
        { key:'hotel', en:'Where is the hotel?', es:'Â¿DÃ³nde estÃ¡ el hotel?', fr:"OÃ¹ est l'hÃ´tel ?", ja:'ãƒ›ãƒ†ãƒ«ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', jaR:'Hoteru wa doko desu ka?' },
        { key:'atm', en:'Where is the nearest ATM?', es:'Â¿DÃ³nde estÃ¡ el cajero automÃ¡tico mÃ¡s cercano?', fr:'OÃ¹ est le distributeur le plus proche ?', ja:'ä¸€ç•ªè¿‘ã„ATMã¯ã©ã“ã§ã™ã‹ï¼Ÿ', jaR:'Ichiban chikai ATM wa doko desu ka?' },
        { key:'openTime', en:'What time does it open?', es:'Â¿A quÃ© hora abre?', fr:'Ã‡a ouvre Ã  quelle heure ?', ja:'ä½•æ™‚ã«é–‹ãã¾ã™ã‹ï¼Ÿ', jaR:'Nanji ni hirakimasu ka?' },
        { key:'help', en:'Can you help me?', es:'Â¿Puede ayudarme?', fr:"Pouvez-vous m'aider ?", ja:'æ‰‹ä¼ã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ', jaR:'Tetsudatte moraemasu ka?' },
        { key:'taxi', en:'Where can I find a taxi?', es:'Â¿DÃ³nde puedo encontrar un taxi?', fr:'OÃ¹ puis-je trouver un taxi ?', ja:'ã‚¿ã‚¯ã‚·ãƒ¼ã¯ã©ã“ã§ä¹—ã‚Œã¾ã™ã‹ï¼Ÿ', jaR:'TakushÄ« wa doko de noremasu ka?' },
        { key:'vegetarian', en:'Do you have vegetarian options?', es:'Â¿Tiene opciones vegetarianas?', fr:'Avez-vous des options vÃ©gÃ©tariennes ?', ja:'ãƒ™ã‚¸ã‚¿ãƒªã‚¢ãƒ³ã®é¸æŠžè‚¢ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', jaR:'Bejitarian no sentakushi wa arimasu ka?' }
      ];

      // Elements
      const $ = sel => document.querySelector(sel);
      const app = $('#app');
      const bar = $('#bar');
      const remaining = $('#remaining');
      const learned = $('#learned');
      const stage = $('#stage');
      const card = $('#card');
      const inner = card.querySelector('.card-inner');
      const frontText = $('#frontText');
      const backText = $('#backText');
      const frontRoma = $('#frontRoma');
      const backRoma = $('#backRoma');
      const frontLang = $('#frontLang');
      const backLang = $('#backLang');
      const frontFlag = $('#frontFlag');
      const backFlag = $('#backFlag');
      const flipBtn = $('#flipBtn');
      const nextBtn = $('#nextBtn');
      const prevBtn = $('#prevBtn');
      const learnedBtn = $('#learnedBtn');
      const shuffleBtn = $('#shuffleBtn');
      const resetBtn = $('#resetBtn');
      const baseSelect = $('#baseLang');
      const targetSelect = $('#targetLang');
      const overlay = $('#overlay');
      const dlgBase = $('#dlgBase');
      const startBtn = $('#startBtn');
      const langCards = $('#langCards');
      const toast = $('#toast');

      // State
      let ui = detectUi();
      setHtmlLang(ui);
      // Defer applyI18n until after base/target are initialized to avoid TDZ

      // Build select options
      function renderSelectOptions(select, uiLang, selected){
        select.innerHTML = LANGS.map(code => `<option value="${code}" ${code===selected?'selected':''}>${FLAGS[code]} ${LANGUAGE_NAME[uiLang][code]}</option>`).join('');
      }

      const suggestedTarget = (ui === 'en') ? 'es' : 'en';
      renderSelectOptions(baseSelect, ui, ui);
      renderSelectOptions(targetSelect, ui, suggestedTarget);

      // Overlay setup
      renderSelectOptions(dlgBase, ui, ui);
      overlay.hidden = false;
      renderLangCards();

      // Session state
      let base = ui; // user's language by default
      let target = suggestedTarget; // language to learn
      let deck = [];
      let index = 0;
      let learnedSet = new Set(loadLearned(base, target));

      function start(){
        // Picks from selects if overlay was used
        base = (overlay.hidden ? baseSelect.value : dlgBase.value) || ui;
        target = targetSelect.value || target;
        // If user clicked a card in overlay, we preserved target via data attr
        const chosen = overlay.getAttribute('data-chosen');
        if(chosen) target = chosen;
        // Persist settings
        saveSettings({ ui, base, target });
        // Build deck
        deck = buildDeck(target, base).filter(item => !learnedSet.has(item.key));
        if(deck.length === 0){
          toastMsg(I18N[ui].allLearned);
        }
        index = 0;
        overlay.hidden = true;
        updateSelects();
        render();
      }

      startBtn.addEventListener('click', start);

      function renderLangCards(){
        langCards.innerHTML = LANGS.map(code => `
          <div class="lang-card" data-code="${code}" tabindex="0" role="button" aria-label="${LANGUAGE_NAME[ui][code]}">
            <div class="flag">${FLAGS[code]}</div>
            <div class="name">${LANGUAGE_NAME[ui][code]}</div>
          </div>`).join('');
        langCards.querySelectorAll('.lang-card').forEach(el =>{
          el.addEventListener('click', ()=>{ overlay.setAttribute('data-chosen', el.dataset.code); targetSelect.value = el.dataset.code; start();});
          el.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); el.click(); } });
        });
      }

      function updateSelects(){
        renderSelectOptions(baseSelect, ui, base);
        renderSelectOptions(targetSelect, ui, target);
      }

      // Attach control handlers
      baseSelect.addEventListener('change', ()=>{ base = baseSelect.value; learnedSet = new Set(loadLearned(base, target)); rebuildAndRender(); });
      targetSelect.addEventListener('change', ()=>{ target = targetSelect.value; learnedSet = new Set(loadLearned(base, target)); rebuildAndRender(); });
      shuffleBtn.addEventListener('click', ()=>{ shuffle(deck); index = 0; stage.classList.add('shuffle'); setTimeout(()=>stage.classList.remove('shuffle'), 620); render(); toastMsg(I18N[ui].shuffled);});
      resetBtn.addEventListener('click', ()=>{ learnedSet = new Set(); saveLearned(base, target, []); rebuildAndRender(); toastMsg(I18N[ui].resetDone);});

      flipBtn.addEventListener('click', flip);
      card.addEventListener('click', (e)=>{ if(!e.target.closest('.check')) flip(); });
      learnedBtn.addEventListener('click', markLearned);
      prevBtn.addEventListener('click', ()=>{ if(!deck.length) return; index = (index - 1 + deck.length) % deck.length; unflip(); render(); });
      nextBtn.addEventListener('click', ()=>{ if(!deck.length) return; index = (index + 1) % deck.length; unflip(); render(); });

      document.addEventListener('keydown', (e)=>{
        if(e.target.matches('input,select,textarea')) return;
        if(e.key === ' ' || e.key === 'Enter'){ e.preventDefault(); flip(); }
        else if(e.key === 'ArrowRight'){ nextBtn.click(); }
        else if(e.key === 'ArrowLeft'){ prevBtn.click(); }
        else if(e.key.toLowerCase() === 'l'){ markLearned(); }
        else if(e.key.toLowerCase() === 's'){ shuffleBtn.click(); }
      });

      // Render
      function render(){
        applyI18n(ui); // keep labels up-to-date
        if(!deck.length){
          frontText.textContent = 'ðŸŽ‰';
          frontRoma.textContent = '';
          backText.textContent = I18N[ui].allLearned;
          backRoma.textContent = '';
          frontLang.textContent = LANGUAGE_NAME[ui][target];
          backLang.textContent = LANGUAGE_NAME[ui][base];
          frontFlag.textContent = FLAGS[target];
          backFlag.textContent = FLAGS[base];
          bar.style.width = '100%';
          remaining.textContent = `${I18N[ui].remaining}: 0 / ${PHRASES.length}`;
          learned.textContent = `${I18N[ui].learned}: ${PHRASES.length}`;
          return;
        }
        const item = deck[index];
        frontText.textContent = item.front;
        backText.textContent = item.back;
        frontRoma.textContent = item.romajiFront ? `${I18N[ui].pronunciation}: ${item.romajiFront}` : '';
        backRoma.textContent = item.romajiBack ? `${I18N[ui].pronunciation}: ${item.romajiBack}` : '';
        frontLang.textContent = LANGUAGE_NAME[ui][target];
        backLang.textContent = LANGUAGE_NAME[ui][base];
        frontFlag.textContent = FLAGS[target];
        backFlag.textContent = FLAGS[base];
        const learnedCount = learnedSet.size;
        const rem = PHRASES.length - learnedCount;
        bar.style.width = `${Math.round((learnedCount / PHRASES.length) * 100)}%`;
        remaining.textContent = `${I18N[ui].remaining}: ${rem} / ${PHRASES.length}`;
        learned.textContent = `${I18N[ui].learned}: ${learnedCount}`;
      }

      function flip(){ card.classList.toggle('is-flipped'); }
      function unflip(){ card.classList.remove('is-flipped'); }

      function markLearned(){
        if(!deck.length) return;
        const item = deck[index];
        learnedSet.add(item.key);
        saveLearned(base, target, Array.from(learnedSet));
        inner.insertAdjacentHTML('beforeend', `<div class="check"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> ${I18N[ui].learnedOne}</div>`);
        card.classList.add('flyout');
        celebrate();
        setTimeout(()=>{
          // Remove the learned card from deck
          deck.splice(index,1);
          if(index >= deck.length) index = 0;
          card.classList.remove('flyout');
          inner.querySelectorAll('.check').forEach(el=>el.remove());
          unflip();
          render();
        }, 440);
      }

      function buildDeck(target, base){
        return PHRASES.map(p => ({ key:p.key, front:p[target], back:p[base], romajiFront: target==='ja' ? p.jaR : '', romajiBack: base==='ja' ? p.jaR : '' }));
      }

      function rebuildAndRender(){
        deck = buildDeck(target, base).filter(item => !learnedSet.has(item.key));
        index = 0;
        unflip();
        render();
      }

      function shuffle(array){
        for(let i=array.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [array[i], array[j]] = [array[j], array[i]]; }
        return array;
      }

      function celebrate(){
        const box = card.getBoundingClientRect();
        for(let i=0;i<18;i++){
          const d = document.createElement('div');
          d.className = 'piece';
          const colors = ['#22d3ee','#a78bfa','#34d399','#f59e0b','#f43f5e'];
          d.style.background = colors[i % colors.length];
          const x = box.left + box.width/2; const y = box.top + box.height/2;
          d.style.left = x + 'px'; d.style.top = y + 'px';
          const dx = (Math.random()*2-1)*220 + 'px';
          const dy = (Math.random()*1+0.6)*220 + 'px';
          const rot = (Math.random()*720-360) + 'deg';
          d.style.setProperty('--dx', dx); d.style.setProperty('--dy', dy); d.style.setProperty('--rot', rot);
          $('#confetti').appendChild(d);
          setTimeout(()=> d.remove(), 900);
        }
      }

      function toastMsg(msg){
        toast.textContent = msg;
        toast.classList.add('show');
        clearTimeout(toast._t);
        toast._t = setTimeout(()=>toast.classList.remove('show'), 1400);
      }

      function detectUi(){
        const saved = loadSettings();
        if(saved && saved.ui && LANGS.includes(saved.ui)) return saved.ui;
        const nav = (navigator.language || 'en').toLowerCase();
        if(nav.startsWith('es')) return 'es';
        if(nav.startsWith('fr')) return 'fr';
        if(nav.startsWith('ja')) return 'ja';
        return 'en';
      }

      function setHtmlLang(code){ document.documentElement.lang = code; }

      function applyI18n(code){
        document.querySelectorAll('[data-i18n]').forEach(el=>{
          const key = el.getAttribute('data-i18n');
          if(I18N[code][key]) el.textContent = I18N[code][key];
        });
        // Update select option labels too
        updateSelects();
      }

      function saveSettings(obj){ try{ localStorage.setItem('flash_settings', JSON.stringify(obj)); }catch(e){} }
      function loadSettings(){ try{ return JSON.parse(localStorage.getItem('flash_settings')||'null'); }catch(e){ return null; } }

      function saveLearned(base, target, arr){ try{ localStorage.setItem(keyFor(base,target), JSON.stringify(arr)); }catch(e){} }
      function loadLearned(base, target){ try{ return JSON.parse(localStorage.getItem(keyFor(base,target))||'[]'); }catch(e){ return []; } }
      function keyFor(base, target){ return `learned_v1_${base}_${target}`; }

      // If we have prior settings, restore them and skip overlay
      const prior = loadSettings();
      if(prior){ ui = prior.ui || ui; setHtmlLang(ui); applyI18n(ui); base = prior.base || base; target = prior.target || target; renderSelectOptions(dlgBase, ui, base); overlay.hidden = false; }

      // If we have prior learned set for current pair, load it
      learnedSet = new Set(loadLearned(base, target));

      // Also allow changing UI language to match base automatically
      baseSelect.addEventListener('change', ()=>{ ui = baseSelect.value; setHtmlLang(ui); applyI18n(ui); });

      // Initial render (overlay visible; card renders after start)
      // But if user had prior settings, start immediately
      if(prior){ start(); } else { render(); }

    })();
  </script>
</body>
</html>
