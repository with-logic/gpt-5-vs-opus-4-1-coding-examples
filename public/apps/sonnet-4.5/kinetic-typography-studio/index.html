<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinetic Typography Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&family=Playfair+Display:wght@400;700&family=Bebas+Neue&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #151520;
            --bg-tertiary: #1e1e2e;
            --accent: #6366f1;
            --accent-hover: #5558e3;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --border: #2a2a3a;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 60px 1fr 200px;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }

        .header {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 2px solid var(--border);
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #252535;
        }

        .left-panel {
            background: var(--bg-secondary);
            overflow-y: auto;
            padding: 20px;
        }

        .canvas-area {
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-container {
            position: relative;
            background: #000;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .safe-guides {
            position: absolute;
            border: 2px dashed rgba(99, 102, 241, 0.3);
            pointer-events: none;
        }

        .right-panel {
            background: var(--bg-secondary);
            overflow-y: auto;
            padding: 20px;
        }

        .timeline {
            background: var(--bg-secondary);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .control-group {
            margin-bottom: 16px;
        }

        .control-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Roboto Mono', monospace;
        }

        .slider-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            min-width: 45px;
            text-align: right;
            font-size: 13px;
            color: var(--text-secondary);
            font-family: 'Roboto Mono', monospace;
        }

        .color-input {
            width: 100%;
            height: 40px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .preset-btn {
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: #252535;
            border-color: var(--accent);
        }

        .preset-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .timeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .playback-controls {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .icon-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .timeline-content {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .timeline-tracks {
            min-height: 100%;
            position: relative;
        }

        .track {
            height: 48px;
            border-bottom: 1px solid var(--border);
            position: relative;
            display: flex;
            align-items: center;
        }

        .track-label {
            width: 120px;
            padding: 0 12px;
            font-size: 12px;
            font-weight: 500;
            background: var(--bg-tertiary);
            height: 100%;
            display: flex;
            align-items: center;
            border-right: 1px solid var(--border);
        }

        .track-content {
            flex: 1;
            position: relative;
            height: 100%;
        }

        .keyframe {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--accent);
            border: 2px solid var(--bg-secondary);
            border-radius: 3px;
            cursor: pointer;
            transform: translate(-50%, -50%) rotate(45deg);
            top: 50%;
            transition: all 0.2s;
        }

        .keyframe:hover {
            transform: translate(-50%, -50%) rotate(45deg) scale(1.3);
        }

        .keyframe.selected {
            background: var(--success);
            transform: translate(-50%, -50%) rotate(45deg) scale(1.2);
        }

        .timeline-ruler {
            height: 32px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            position: relative;
            margin-left: 120px;
        }

        .time-marker {
            position: absolute;
            font-size: 10px;
            color: var(--text-secondary);
            top: 8px;
            font-family: 'Roboto Mono', monospace;
        }

        .playhead {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: var(--danger);
            pointer-events: none;
            z-index: 10;
        }

        .playhead::before {
            content: '';
            position: absolute;
            top: 0;
            left: -4px;
            width: 10px;
            height: 10px;
            background: var(--danger);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid-cols-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px dashed var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .file-input-label:hover {
            border-color: var(--accent);
            background: #252535;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2a2a3a;
        }

        .aspect-btns {
            display: flex;
            gap: 6px;
        }

        .aspect-btn {
            flex: 1;
            padding: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .aspect-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .aspect-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-tertiary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        canvas {
            display: block;
        }

        .audio-visualizer {
            height: 60px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-top: 8px;
            position: relative;
            overflow: hidden;
        }

        .beat-marker {
            position: absolute;
            width: 2px;
            height: 100%;
            background: var(--success);
            opacity: 0.6;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr auto;
            }

            .left-panel, .right-panel {
                display: none;
            }

            .timeline {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 3h8v2H3zm0 4h8v2H3zm0 4h8v2H3zm12-8h6v18h-6z" opacity="0.5"/>
                    <path d="M15 5l6 7-6 7V5z"/>
                </svg>
                <span>Kinetic Typography Studio</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" id="audioBtn" aria-label="Load audio file">
                    <span>üéµ</span>
                    <span>Audio</span>
                </button>
                <button class="btn btn-primary" id="exportBtn" aria-label="Export animation">
                    <span>üì§</span>
                    <span>Export</span>
                </button>
            </div>
        </header>

        <aside class="left-panel" role="complementary" aria-label="Text and animation controls">
            <div class="panel-section">
                <h2 class="section-title">Text Content</h2>
                <div class="control-group">
                    <label class="control-label" for="textInput">Your Text</label>
                    <textarea id="textInput" placeholder="Enter your text here..." aria-label="Text content">KINETIC\nTYPOGRAPHY</textarea>
                </div>
            </div>

            <div class="panel-section">
                <h2 class="section-title">Animation Presets</h2>
                <div class="preset-grid">
                    <button class="preset-btn" data-preset="typewriter">Typewriter</button>
                    <button class="preset-btn" data-preset="bounce">Bounce</button>
                    <button class="preset-btn" data-preset="liquid">Liquid</button>
                    <button class="preset-btn" data-preset="glitch">Glitch</button>
                    <button class="preset-btn" data-preset="fadeUp">Fade Up</button>
                    <button class="preset-btn" data-preset="cascade">Cascade</button>
                </div>
            </div>

            <div class="panel-section">
                <h2 class="section-title">Animation Settings</h2>
                <div class="control-group">
                    <label class="control-label" for="durationSlider">Duration (seconds)</label>
                    <div class="slider-group">
                        <input type="range" id="durationSlider" class="slider" min="1" max="10" step="0.1" value="3" aria-label="Animation duration">
                        <span class="slider-value" id="durationValue">3.0s</span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="staggerSlider">Stagger Delay (ms)</label>
                    <div class="slider-group">
                        <input type="range" id="staggerSlider" class="slider" min="0" max="500" step="10" value="50" aria-label="Stagger delay between elements">
                        <span class="slider-value" id="staggerValue">50ms</span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="staggerMode">Stagger Mode</label>
                    <select id="staggerMode" aria-label="Stagger mode selection">
                        <option value="letter">By Letter</option>
                        <option value="word">By Word</option>
                        <option value="line">By Line</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label" for="easingPreset">Easing</label>
                    <select id="easingPreset" aria-label="Easing function selection">
                        <option value="linear">Linear</option>
                        <option value="easeIn">Ease In</option>
                        <option value="easeOut" selected>Ease Out</option>
                        <option value="easeInOut">Ease In Out</option>
                        <option value="bounce">Bounce</option>
                        <option value="elastic">Elastic</option>
                        <option value="custom">Custom B√©zier</option>
                    </select>
                </div>
                <div class="control-group" id="customBezier" style="display: none;">
                    <label class="control-label">Custom B√©zier (x1, y1, x2, y2)</label>
                    <input type="text" class="input" id="bezierInput" placeholder="0.42, 0, 0.58, 1" aria-label="Custom bezier values">
                </div>
            </div>
        </aside>

        <main class="canvas-area" role="main" aria-label="Animation preview">
            <div class="preview-container" id="previewContainer">
                <canvas id="canvas" aria-label="Animation canvas"></canvas>
                <div class="canvas-overlay">
                    <div class="safe-guides" id="safeGuides" style="display: none;"></div>
                </div>
                <div class="playhead" id="canvasPlayhead" style="display: none;"></div>
            </div>
        </main>

        <aside class="right-panel" role="complementary" aria-label="Style controls">
            <div class="tabs">
                <button class="tab active" data-tab="style">Style</button>
                <button class="tab" data-tab="layout">Layout</button>
                <button class="tab" data-tab="effects">Effects</button>
            </div>

            <div class="tab-content active" id="styleTab">
                <div class="panel-section">
                    <h2 class="section-title">Typography</h2>
                    <div class="control-group">
                        <label class="control-label" for="fontFamily">Font Family</label>
                        <select id="fontFamily" aria-label="Font family selection">
                            <option value="Inter">Inter</option>
                            <option value="Roboto Mono">Roboto Mono</option>
                            <option value="Playfair Display">Playfair Display</option>
                            <option value="Bebas Neue">Bebas Neue</option>
                            <option value="Pacifico">Pacifico</option>
                            <option value="Arial">Arial</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Courier New">Courier New</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="fontSize">Font Size</label>
                        <div class="slider-group">
                            <input type="range" id="fontSize" class="slider" min="20" max="200" value="72" aria-label="Font size">
                            <span class="slider-value" id="fontSizeValue">72px</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="fontWeight">Font Weight</label>
                        <select id="fontWeight" aria-label="Font weight selection">
                            <option value="400">Regular</option>
                            <option value="500">Medium</option>
                            <option value="600">Semi Bold</option>
                            <option value="700" selected>Bold</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="fontItalic" class="checkbox" aria-label="Italic text">
                        <label for="fontItalic" class="control-label" style="margin: 0;">Italic</label>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="letterSpacing">Letter Spacing</label>
                        <div class="slider-group">
                            <input type="range" id="letterSpacing" class="slider" min="-20" max="100" value="0" aria-label="Letter spacing">
                            <span class="slider-value" id="letterSpacingValue">0px</span>
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <h2 class="section-title">Colors</h2>
                    <div class="control-group">
                        <label class="control-label" for="fillColor">Fill Color</label>
                        <input type="color" id="fillColor" class="color-input" value="#ffffff" aria-label="Fill color picker">
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="strokeColor">Stroke Color</label>
                        <input type="color" id="strokeColor" class="color-input" value="#6366f1" aria-label="Stroke color picker">
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="strokeWidth">Stroke Width</label>
                        <div class="slider-group">
                            <input type="range" id="strokeWidth" class="slider" min="0" max="20" value="0" aria-label="Stroke width">
                            <span class="slider-value" id="strokeWidthValue">0px</span>
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="useGradient" class="checkbox" aria-label="Use gradient fill">
                        <label for="useGradient" class="control-label" style="margin: 0;">Use Gradient</label>
                    </div>
                    <div id="gradientControls" style="display: none;">
                        <div class="control-group">
                            <label class="control-label" for="gradientColor2">Gradient Color 2</label>
                            <input type="color" id="gradientColor2" class="color-input" value="#ec4899" aria-label="Gradient color 2 picker">
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="layoutTab">
                <div class="panel-section">
                    <h2 class="section-title">Aspect Ratio</h2>
                    <div class="aspect-btns">
                        <button class="aspect-btn" data-aspect="1:1">1:1</button>
                        <button class="aspect-btn active" data-aspect="16:9">16:9</button>
                        <button class="aspect-btn" data-aspect="9:16">9:16</button>
                    </div>
                </div>
                <div class="panel-section">
                    <h2 class="section-title">Canvas Size</h2>
                    <div class="grid-cols-2">
                        <div class="control-group">
                            <label class="control-label" for="canvasWidth">Width</label>
                            <input type="number" id="canvasWidth" class="input" value="1920" min="100" aria-label="Canvas width">
                        </div>
                        <div class="control-group">
                            <label class="control-label" for="canvasHeight">Height</label>
                            <input type="number" id="canvasHeight" class="input" value="1080" min="100" aria-label="Canvas height">
                        </div>
                    </div>
                </div>
                <div class="panel-section">
                    <h2 class="section-title">Alignment</h2>
                    <div class="control-group">
                        <label class="control-label" for="textAlign">Text Align</label>
                        <select id="textAlign" aria-label="Text alignment">
                            <option value="left">Left</option>
                            <option value="center" selected>Center</option>
                            <option value="right">Right</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showSafeGuides" class="checkbox" aria-label="Show safe area guides">
                        <label for="showSafeGuides" class="control-label" style="margin: 0;">Safe Area Guides</label>
                    </div>
                </div>
                <div class="panel-section">
                    <h2 class="section-title">Background</h2>
                    <div class="control-group">
                        <label class="control-label" for="bgColor">Background Color</label>
                        <input type="color" id="bgColor" class="color-input" value="#000000" aria-label="Background color picker">
                    </div>
                    <div class="file-input-wrapper">
                        <input type="file" id="bgImageInput" accept="image/*" aria-label="Upload background image">
                        <label for="bgImageInput" class="file-input-label">
                            <span>üñºÔ∏è</span>
                            <span>Upload Background Image</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="effectsTab">
                <div class="panel-section">
                    <h2 class="section-title">Text Shadow</h2>
                    <div class="control-group">
                        <label class="control-label" for="shadowBlur">Blur</label>
                        <div class="slider-group">
                            <input type="range" id="shadowBlur" class="slider" min="0" max="50" value="0" aria-label="Shadow blur">
                            <span class="slider-value" id="shadowBlurValue">0px</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="shadowColor">Shadow Color</label>
                        <input type="color" id="shadowColor" class="color-input" value="#000000" aria-label="Shadow color picker">
                    </div>
                    <div class="grid-cols-2">
                        <div class="control-group">
                            <label class="control-label" for="shadowX">Offset X</label>
                            <input type="number" id="shadowX" class="input" value="0" aria-label="Shadow X offset">
                        </div>
                        <div class="control-group">
                            <label class="control-label" for="shadowY">Offset Y</label>
                            <input type="number" id="shadowY" class="input" value="0" aria-label="Shadow Y offset">
                        </div>
                    </div>
                </div>
                <div class="panel-section">
                    <h2 class="section-title">Effects</h2>
                    <div class="checkbox-group">
                        <input type="checkbox" id="motionBlur" class="checkbox" aria-label="Enable motion blur">
                        <label for="motionBlur" class="control-label" style="margin: 0;">Motion Blur</label>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="opacity">Opacity</label>
                        <div class="slider-group">
                            <input type="range" id="opacity" class="slider" min="0" max="100" value="100" aria-label="Text opacity">
                            <span class="slider-value" id="opacityValue">100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <section class="timeline" role="region" aria-label="Animation timeline">
            <div class="timeline-header">
                <div class="playback-controls">
                    <button class="icon-btn" id="playBtn" aria-label="Play animation" title="Play (Space)">
                        <span id="playIcon">‚ñ∂</span>
                    </button>
                    <button class="icon-btn" id="stopBtn" aria-label="Stop animation" title="Stop">
                        <span>‚ñ†</span>
                    </button>
                    <button class="icon-btn" id="loopBtn" aria-label="Toggle loop" title="Loop">
                        <span>üîÅ</span>
                    </button>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 12px; color: var(--text-secondary); font-family: 'Roboto Mono', monospace;" id="timeDisplay">0.00s</span>
                    <button class="icon-btn" id="addKeyframeBtn" aria-label="Add keyframe" title="Add Keyframe (K)">
                        <span>+</span>
                    </button>
                </div>
            </div>
            <div class="timeline-ruler" id="timelineRuler">
                <div class="playhead" id="playhead" style="left: 120px;"></div>
            </div>
            <div class="timeline-content">
                <div class="timeline-tracks" id="timelineTracks">
                    <div class="track" data-property="position">
                        <div class="track-label">Position</div>
                        <div class="track-content" data-track="position"></div>
                    </div>
                    <div class="track" data-property="scale">
                        <div class="track-label">Scale</div>
                        <div class="track-content" data-track="scale"></div>
                    </div>
                    <div class="track" data-property="rotation">
                        <div class="track-label">Rotation</div>
                        <div class="track-content" data-track="rotation"></div>
                    </div>
                    <div class="track" data-property="opacity">
                        <div class="track-label">Opacity</div>
                        <div class="track-content" data-track="opacity"></div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal" role="dialog" aria-labelledby="exportModalTitle" aria-modal="true">
        <div class="modal-content">
            <h3 class="modal-header" id="exportModalTitle">Export Animation</h3>
            <div class="control-group">
                <label class="control-label" for="exportFormat">Format</label>
                <select id="exportFormat" aria-label="Export format selection">
                    <option value="webm">WebM Video</option>
                    <option value="gif">GIF</option>
                    <option value="png">PNG Sequence</option>
                </select>
            </div>
            <div class="control-group">
                <label class="control-label" for="exportFps">Frame Rate (FPS)</label>
                <select id="exportFps" aria-label="Frame rate selection">
                    <option value="24">24</option>
                    <option value="30" selected>30</option>
                    <option value="60">60</option>
                </select>
            </div>
            <div class="control-group">
                <label class="control-label" for="exportQuality">Quality</label>
                <select id="exportQuality" aria-label="Export quality selection">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div id="exportProgress" style="display: none;">
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                    Rendering: <span id="exportProgressText">0%</span>
                </p>
                <div class="progress-bar">
                    <div class="progress-fill" id="exportProgressBar" style="width: 0%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelExportBtn">Cancel</button>
                <button class="btn btn-primary" id="startExportBtn">
                    <span>üì§</span>
                    <span>Export</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Audio Modal -->
    <div class="modal" id="audioModal" role="dialog" aria-labelledby="audioModalTitle" aria-modal="true">
        <div class="modal-content">
            <h3 class="modal-header" id="audioModalTitle">Audio-Reactive Mode</h3>
            <div class="file-input-wrapper">
                <input type="file" id="audioFileInput" accept="audio/*" aria-label="Upload audio file">
                <label for="audioFileInput" class="file-input-label">
                    <span>üéµ</span>
                    <span>Upload Audio File</span>
                </label>
            </div>
            <div id="audioControls" style="display: none; margin-top: 16px;">
                <div class="audio-visualizer" id="audioVisualizer"></div>
                <div class="control-group" style="margin-top: 16px;">
                    <label class="control-label" for="bpm">BPM (Beats Per Minute)</label>
                    <input type="number" id="bpm" class="input" value="120" min="60" max="200" aria-label="Beats per minute">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="snapToBeats" class="checkbox" aria-label="Snap keyframes to beats">
                    <label for="snapToBeats" class="control-label" style="margin: 0;">Snap Keyframes to Beats</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="autoDetectBeats" class="checkbox" checked aria-label="Auto-detect beats">
                    <label for="autoDetectBeats" class="control-label" style="margin: 0;">Auto-Detect Beats</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeAudioBtn">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        const state = {
            text: 'KINETIC\nTYPOGRAPHY',
            duration: 3,
            stagger: 50,
            staggerMode: 'letter',
            isPlaying: false,
            currentTime: 0,
            loop: false,
            canvas: {
                width: 1920,
                height: 1080,
                aspectRatio: '16:9'
            },
            style: {
                fontFamily: 'Inter',
                fontSize: 72,
                fontWeight: '700',
                fontItalic: false,
                letterSpacing: 0,
                fillColor: '#ffffff',
                strokeColor: '#6366f1',
                strokeWidth: 0,
                useGradient: false,
                gradientColor2: '#ec4899',
                textAlign: 'center',
                bgColor: '#000000',
                bgImage: null,
                shadowBlur: 0,
                shadowColor: '#000000',
                shadowX: 0,
                shadowY: 0,
                opacity: 100,
                motionBlur: false
            },
            easing: 'easeOut',
            customBezier: [0.42, 0, 0.58, 1],
            keyframes: {
                position: [],
                scale: [],
                rotation: [],
                opacity: []
            },
            audio: {
                file: null,
                context: null,
                source: null,
                analyser: null,
                bpm: 120,
                beats: [],
                snapToBeats: false
            },
            safeGuides: false
        };

        // Canvas setup
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { alpha: true });
        let animationFrame = null;

        // Initialize canvas size
        function updateCanvasSize() {
            const container = document.getElementById('previewContainer');
            const maxWidth = container.clientWidth - 40;
            const maxHeight = container.clientHeight - 40;

            let width = state.canvas.width;
            let height = state.canvas.height;

            const scale = Math.min(maxWidth / width, maxHeight / height, 1);

            container.style.width = (width * scale) + 'px';
            container.style.height = (height * scale) + 'px';

            canvas.width = width;
            canvas.height = height;

            updateSafeGuides();
            render();
        }

        function updateSafeGuides() {
            const guides = document.getElementById('safeGuides');
            if (state.safeGuides) {
                const margin = 0.05; // 5% safe margin
                guides.style.top = (margin * 100) + '%';
                guides.style.left = (margin * 100) + '%';
                guides.style.right = (margin * 100) + '%';
                guides.style.bottom = (margin * 100) + '%';
                guides.style.display = 'block';
            } else {
                guides.style.display = 'none';
            }
        }

        // Easing functions
        const easingFunctions = {
            linear: t => t,
            easeIn: t => t * t,
            easeOut: t => t * (2 - t),
            easeInOut: t => t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t,
            bounce: t => {
                const n1 = 7.5625;
                const d1 = 2.75;
                if (t < 1 / d1) return n1 * t * t;
                else if (t < 2 / d1) return n1 * (t -= 1.5 / d1) * t + 0.75;
                else if (t < 2.5 / d1) return n1 * (t -= 2.25 / d1) * t + 0.9375;
                else return n1 * (t -= 2.625 / d1) * t + 0.984375;
            },
            elastic: t => {
                if (t === 0 || t === 1) return t;
                return Math.pow(2, -10 * t) * Math.sin((t - 0.1) * 5 * Math.PI) + 1;
            },
            custom: t => {
                const [x1, y1, x2, y2] = state.customBezier;
                return cubicBezier(t, x1, y1, x2, y2);
            }
        };

        function cubicBezier(t, x1, y1, x2, y2) {
            const cx = 3 * x1;
            const bx = 3 * (x2 - x1) - cx;
            const ax = 1 - cx - bx;
            const cy = 3 * y1;
            const by = 3 * (y2 - y1) - cy;
            const ay = 1 - cy - by;

            function sampleCurveX(t) {
                return ((ax * t + bx) * t + cx) * t;
            }

            function sampleCurveY(t) {
                return ((ay * t + by) * t + cy) * t;
            }

            function solveCurveX(x) {
                let t2 = x;
                for (let i = 0; i < 8; i++) {
                    const x2 = sampleCurveX(t2) - x;
                    if (Math.abs(x2) < 0.001) return t2;
                    const d2 = (3 * ax * t2 + 2 * bx) * t2 + cx;
                    if (Math.abs(d2) < 0.000001) break;
                    t2 -= x2 / d2;
                }
                return t2;
            }

            return sampleCurveY(solveCurveX(t));
        }

        // Parse text into elements based on stagger mode
        function parseTextElements() {
            const lines = state.text.split('\n');
            const elements = [];

            if (state.staggerMode === 'letter') {
                lines.forEach((line, lineIndex) => {
                    for (let i = 0; i < line.length; i++) {
                        elements.push({
                            char: line[i],
                            line: lineIndex,
                            index: i
                        });
                    }
                });
            } else if (state.staggerMode === 'word') {
                lines.forEach((line, lineIndex) => {
                    const words = line.split(/\s+/);
                    words.forEach((word, wordIndex) => {
                        if (word) {
                            elements.push({
                                char: word,
                                line: lineIndex,
                                index: wordIndex
                            });
                        }
                    });
                });
            } else if (state.staggerMode === 'line') {
                lines.forEach((line, lineIndex) => {
                    if (line.trim()) {
                        elements.push({
                            char: line,
                            line: lineIndex,
                            index: 0
                        });
                    }
                });
            }

            return elements;
        }

        // Animation presets
        const presets = {
            typewriter: (element, index, total) => {
                const delay = index * state.stagger / 1000;
                const duration = 0.3;
                return {
                    opacity: [
                        { time: delay, value: 0 },
                        { time: delay + duration, value: 1 }
                    ],
                    scale: [
                        { time: 0, value: 1 }
                    ]
                };
            },
            bounce: (element, index, total) => {
                const delay = index * state.stagger / 1000;
                return {
                    position: [
                        { time: delay, value: { x: 0, y: -50 } },
                        { time: delay + 0.3, value: { x: 0, y: 10 } },
                        { time: delay + 0.5, value: { x: 0, y: 0 } }
                    ],
                    opacity: [
                        { time: delay, value: 0 },
                        { time: delay + 0.1, value: 1 }
                    ]
                };
            },
            liquid: (element, index, total) => {
                const delay = index * state.stagger / 1000;
                const wave = Math.sin(index * 0.5) * 20;
                return {
                    position: [
                        { time: delay, value: { x: 0, y: wave } },
                        { time: delay + 0.6, value: { x: 0, y: 0 } }
                    ],
                    scale: [
                        { time: delay, value: 0.5 },
                        { time: delay + 0.4, value: 1.2 },
                        { time: delay + 0.6, value: 1 }
                    ],
                    opacity: [
                        { time: delay, value: 0 },
                        { time: delay + 0.2, value: 1 }
                    ]
                };
            },
            glitch: (element, index, total) => {
                const delay = index * state.stagger / 1000;
                const offsetX = (Math.random() - 0.5) * 30;
                return {
                    position: [
                        { time: delay, value: { x: offsetX, y: 0 } },
                        { time: delay + 0.05, value: { x: -offsetX, y: 0 } },
                        { time: delay + 0.1, value: { x: offsetX * 0.5, y: 0 } },
                        { time: delay + 0.15, value: { x: 0, y: 0 } }
                    ],
                    opacity: [
                        { time: delay, value: 0.3 },
                        { time: delay + 0.05, value: 1 },
                        { time: delay + 0.1, value: 0.5 },
                        { time: delay + 0.15, value: 1 }
                    ]
                };
            },
            fadeUp: (element, index, total) => {
                const delay = index * state.stagger / 1000;
                return {
                    position: [
                        { time: delay, value: { x: 0, y: 30 } },
                        { time: delay + 0.6, value: { x: 0, y: 0 } }
                    ],
                    opacity: [
                        { time: delay, value: 0 },
                        { time: delay + 0.6, value: 1 }
                    ]
                };
            },
            cascade: (element, index, total) => {
                const delay = index * state.stagger / 1000;
                const angle = (index % 2 === 0) ? -15 : 15;
                return {
                    position: [
                        { time: delay, value: { x: 0, y: -100 } },
                        { time: delay + 0.8, value: { x: 0, y: 0 } }
                    ],
                    rotation: [
                        { time: delay, value: angle },
                        { time: delay + 0.8, value: 0 }
                    ],
                    opacity: [
                        { time: delay, value: 0 },
                        { time: delay + 0.3, value: 1 }
                    ]
                };
            }
        };

        // Apply preset animation
        function applyPreset(presetName) {
            const preset = presets[presetName];
            if (!preset) return;

            const elements = parseTextElements();
            state.keyframes = { position: [], scale: [], rotation: [], opacity: [] };

            elements.forEach((element, index) => {
                const animation = preset(element, index, elements.length);

                Object.keys(animation).forEach(property => {
                    animation[property].forEach(keyframe => {
                        state.keyframes[property].push({
                            time: keyframe.time,
                            value: keyframe.value,
                            elementIndex: index
                        });
                    });
                });
            });

            renderTimeline();
            render();
        }

        // Interpolate value between keyframes
        function interpolateValue(property, time, elementIndex) {
            const keyframes = state.keyframes[property].filter(k =>
                elementIndex === undefined || k.elementIndex === elementIndex
            );

            if (keyframes.length === 0) {
                if (property === 'scale') return 1;
                if (property === 'opacity') return 1;
                if (property === 'rotation') return 0;
                if (property === 'position') return { x: 0, y: 0 };
            }

            keyframes.sort((a, b) => a.time - b.time);

            if (time <= keyframes[0].time) {
                return keyframes[0].value;
            }

            if (time >= keyframes[keyframes.length - 1].time) {
                return keyframes[keyframes.length - 1].value;
            }

            for (let i = 0; i < keyframes.length - 1; i++) {
                const k1 = keyframes[i];
                const k2 = keyframes[i + 1];

                if (time >= k1.time && time <= k2.time) {
                    const t = (time - k1.time) / (k2.time - k1.time);
                    const easedT = easingFunctions[state.easing](t);

                    if (typeof k1.value === 'object') {
                        return {
                            x: k1.value.x + (k2.value.x - k1.value.x) * easedT,
                            y: k1.value.y + (k2.value.y - k1.value.y) * easedT
                        };
                    } else {
                        return k1.value + (k2.value - k1.value) * easedT;
                    }
                }
            }

            return keyframes[keyframes.length - 1].value;
        }

        // Render function
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Background
            if (state.style.bgImage) {
                ctx.drawImage(state.style.bgImage, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = state.style.bgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            const elements = parseTextElements();
            const lines = state.text.split('\n');

            // Setup font
            const fontStyle = state.style.fontItalic ? 'italic ' : '';
            ctx.font = `${fontStyle}${state.style.fontWeight} ${state.style.fontSize}px "${state.style.fontFamily}"`;
            ctx.textBaseline = 'middle';

            // Calculate line positions
            const lineHeight = state.style.fontSize * 1.2;
            const totalHeight = lines.length * lineHeight;
            const startY = (canvas.height - totalHeight) / 2 + lineHeight / 2;

            elements.forEach((element, index) => {
                const line = element.line;
                const y = startY + line * lineHeight;

                // Get animated values
                const position = interpolateValue('position', state.currentTime, index) || { x: 0, y: 0 };
                const scale = interpolateValue('scale', state.currentTime, index) || 1;
                const rotation = interpolateValue('rotation', state.currentTime, index) || 0;
                const opacity = interpolateValue('opacity', state.currentTime, index) || 1;

                // Calculate x position based on alignment
                let x;
                const lineText = lines[line];
                const textWidth = ctx.measureText(lineText).width;

                if (state.style.textAlign === 'center') {
                    x = canvas.width / 2;
                    ctx.textAlign = 'center';
                } else if (state.style.textAlign === 'right') {
                    x = canvas.width - 50;
                    ctx.textAlign = 'right';
                } else {
                    x = 50;
                    ctx.textAlign = 'left';
                }

                // Calculate character position within line
                let charX = x;
                if (state.staggerMode === 'letter') {
                    const beforeText = lineText.substring(0, element.index);
                    const beforeWidth = ctx.measureText(beforeText).width;
                    const charWidth = ctx.measureText(element.char).width;

                    if (state.style.textAlign === 'center') {
                        charX = x - textWidth / 2 + beforeWidth + charWidth / 2;
                    } else if (state.style.textAlign === 'right') {
                        charX = x - textWidth + beforeWidth + charWidth / 2;
                    } else {
                        charX = x + beforeWidth + charWidth / 2;
                    }
                }

                ctx.save();

                // Apply transformations
                ctx.translate(charX + position.x, y + position.y);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.scale(scale, scale);

                // Apply opacity
                ctx.globalAlpha = (opacity * state.style.opacity / 100);

                // Apply shadow
                if (state.style.shadowBlur > 0) {
                    ctx.shadowBlur = state.style.shadowBlur;
                    ctx.shadowColor = state.style.shadowColor;
                    ctx.shadowOffsetX = state.style.shadowX;
                    ctx.shadowOffsetY = state.style.shadowY;
                }

                // Apply gradient or solid fill
                if (state.style.useGradient) {
                    const gradient = ctx.createLinearGradient(
                        -state.style.fontSize / 2, 0,
                        state.style.fontSize / 2, 0
                    );
                    gradient.addColorStop(0, state.style.fillColor);
                    gradient.addColorStop(1, state.style.gradientColor2);
                    ctx.fillStyle = gradient;
                } else {
                    ctx.fillStyle = state.style.fillColor;
                }

                // Apply letter spacing
                if (state.style.letterSpacing !== 0) {
                    ctx.letterSpacing = state.style.letterSpacing + 'px';
                }

                // Draw text
                if (state.staggerMode === 'letter' || state.staggerMode === 'word') {
                    ctx.fillText(element.char, 0, 0);

                    // Draw stroke
                    if (state.style.strokeWidth > 0) {
                        ctx.strokeStyle = state.style.strokeColor;
                        ctx.lineWidth = state.style.strokeWidth;
                        ctx.strokeText(element.char, 0, 0);
                    }
                } else {
                    // Line mode - draw entire line at once
                    if (index === 0 || elements[index - 1].line !== line) {
                        ctx.fillText(element.char, 0, 0);

                        if (state.style.strokeWidth > 0) {
                            ctx.strokeStyle = state.style.strokeColor;
                            ctx.lineWidth = state.style.strokeWidth;
                            ctx.strokeText(element.char, 0, 0);
                        }
                    }
                }

                ctx.restore();
            });
        }

        // Animation loop
        function animate() {
            if (!state.isPlaying) return;

            state.currentTime += 1/60;

            if (state.currentTime >= state.duration) {
                if (state.loop) {
                    state.currentTime = 0;
                } else {
                    stop();
                    return;
                }
            }

            updateTimeDisplay();
            updatePlayhead();
            render();

            animationFrame = requestAnimationFrame(animate);
        }

        function play() {
            state.isPlaying = true;
            document.getElementById('playIcon').textContent = '‚è∏';
            document.getElementById('playBtn').classList.add('active');
            animate();
        }

        function pause() {
            state.isPlaying = false;
            document.getElementById('playIcon').textContent = '‚ñ∂';
            document.getElementById('playBtn').classList.remove('active');
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
        }

        function stop() {
            pause();
            state.currentTime = 0;
            updateTimeDisplay();
            updatePlayhead();
            render();
        }

        function updateTimeDisplay() {
            document.getElementById('timeDisplay').textContent = state.currentTime.toFixed(2) + 's';
        }

        function updatePlayhead() {
            const progress = state.currentTime / state.duration;
            const rulerWidth = document.getElementById('timelineRuler').clientWidth - 120;
            const left = 120 + progress * rulerWidth;
            document.getElementById('playhead').style.left = left + 'px';
        }

        // Timeline rendering
        function renderTimeline() {
            const ruler = document.getElementById('timelineRuler');
            ruler.innerHTML = '<div class="playhead" id="playhead" style="left: 120px;"></div>';

            const rulerWidth = ruler.clientWidth - 120;
            const numMarkers = 10;

            for (let i = 0; i <= numMarkers; i++) {
                const time = (state.duration * i / numMarkers).toFixed(1);
                const left = 120 + (i / numMarkers) * rulerWidth;
                const marker = document.createElement('div');
                marker.className = 'time-marker';
                marker.style.left = left + 'px';
                marker.textContent = time + 's';
                ruler.appendChild(marker);
            }

            // Render keyframes
            ['position', 'scale', 'rotation', 'opacity'].forEach(property => {
                const trackContent = document.querySelector(`[data-track="${property}"]`);
                trackContent.innerHTML = '';

                state.keyframes[property].forEach((keyframe, index) => {
                    const progress = keyframe.time / state.duration;
                    const left = progress * 100;

                    const kf = document.createElement('div');
                    kf.className = 'keyframe';
                    kf.style.left = left + '%';
                    kf.dataset.property = property;
                    kf.dataset.index = index;
                    kf.setAttribute('role', 'button');
                    kf.setAttribute('aria-label', `Keyframe at ${keyframe.time.toFixed(2)}s`);

                    trackContent.appendChild(kf);
                });
            });
        }

        // Event Listeners
        document.getElementById('textInput').addEventListener('input', (e) => {
            state.text = e.target.value;
            render();
        });

        document.getElementById('durationSlider').addEventListener('input', (e) => {
            state.duration = parseFloat(e.target.value);
            document.getElementById('durationValue').textContent = state.duration.toFixed(1) + 's';
            renderTimeline();
        });

        document.getElementById('staggerSlider').addEventListener('input', (e) => {
            state.stagger = parseInt(e.target.value);
            document.getElementById('staggerValue').textContent = state.stagger + 'ms';
        });

        document.getElementById('staggerMode').addEventListener('change', (e) => {
            state.staggerMode = e.target.value;
            render();
        });

        document.getElementById('easingPreset').addEventListener('change', (e) => {
            state.easing = e.target.value;
            const customBezier = document.getElementById('customBezier');
            customBezier.style.display = e.target.value === 'custom' ? 'block' : 'none';
            render();
        });

        document.getElementById('bezierInput').addEventListener('input', (e) => {
            const values = e.target.value.split(',').map(v => parseFloat(v.trim()));
            if (values.length === 4 && values.every(v => !isNaN(v))) {
                state.customBezier = values;
                render();
            }
        });

        // Preset buttons
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                applyPreset(btn.dataset.preset);
            });
        });

        // Style controls
        document.getElementById('fontFamily').addEventListener('change', (e) => {
            state.style.fontFamily = e.target.value;
            render();
        });

        document.getElementById('fontSize').addEventListener('input', (e) => {
            state.style.fontSize = parseInt(e.target.value);
            document.getElementById('fontSizeValue').textContent = state.style.fontSize + 'px';
            render();
        });

        document.getElementById('fontWeight').addEventListener('change', (e) => {
            state.style.fontWeight = e.target.value;
            render();
        });

        document.getElementById('fontItalic').addEventListener('change', (e) => {
            state.style.fontItalic = e.target.checked;
            render();
        });

        document.getElementById('letterSpacing').addEventListener('input', (e) => {
            state.style.letterSpacing = parseInt(e.target.value);
            document.getElementById('letterSpacingValue').textContent = state.style.letterSpacing + 'px';
            render();
        });

        document.getElementById('fillColor').addEventListener('input', (e) => {
            state.style.fillColor = e.target.value;
            render();
        });

        document.getElementById('strokeColor').addEventListener('input', (e) => {
            state.style.strokeColor = e.target.value;
            render();
        });

        document.getElementById('strokeWidth').addEventListener('input', (e) => {
            state.style.strokeWidth = parseInt(e.target.value);
            document.getElementById('strokeWidthValue').textContent = state.style.strokeWidth + 'px';
            render();
        });

        document.getElementById('useGradient').addEventListener('change', (e) => {
            state.style.useGradient = e.target.checked;
            document.getElementById('gradientControls').style.display = e.target.checked ? 'block' : 'none';
            render();
        });

        document.getElementById('gradientColor2').addEventListener('input', (e) => {
            state.style.gradientColor2 = e.target.value;
            render();
        });

        document.getElementById('textAlign').addEventListener('change', (e) => {
            state.style.textAlign = e.target.value;
            render();
        });

        document.getElementById('bgColor').addEventListener('input', (e) => {
            state.style.bgColor = e.target.value;
            state.style.bgImage = null;
            render();
        });

        document.getElementById('bgImageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        state.style.bgImage = img;
                        render();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('shadowBlur').addEventListener('input', (e) => {
            state.style.shadowBlur = parseInt(e.target.value);
            document.getElementById('shadowBlurValue').textContent = state.style.shadowBlur + 'px';
            render();
        });

        document.getElementById('shadowColor').addEventListener('input', (e) => {
            state.style.shadowColor = e.target.value;
            render();
        });

        document.getElementById('shadowX').addEventListener('input', (e) => {
            state.style.shadowX = parseInt(e.target.value);
            render();
        });

        document.getElementById('shadowY').addEventListener('input', (e) => {
            state.style.shadowY = parseInt(e.target.value);
            render();
        });

        document.getElementById('opacity').addEventListener('input', (e) => {
            state.style.opacity = parseInt(e.target.value);
            document.getElementById('opacityValue').textContent = state.style.opacity + '%';
            render();
        });

        document.getElementById('motionBlur').addEventListener('change', (e) => {
            state.style.motionBlur = e.target.checked;
            render();
        });

        document.getElementById('showSafeGuides').addEventListener('change', (e) => {
            state.safeGuides = e.target.checked;
            updateSafeGuides();
        });

        // Canvas size controls
        document.getElementById('canvasWidth').addEventListener('input', (e) => {
            state.canvas.width = parseInt(e.target.value);
            updateCanvasSize();
        });

        document.getElementById('canvasHeight').addEventListener('input', (e) => {
            state.canvas.height = parseInt(e.target.value);
            updateCanvasSize();
        });

        // Aspect ratio buttons
        document.querySelectorAll('.aspect-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.aspect-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const aspect = btn.dataset.aspect;
                state.canvas.aspectRatio = aspect;

                if (aspect === '1:1') {
                    state.canvas.width = 1080;
                    state.canvas.height = 1080;
                } else if (aspect === '16:9') {
                    state.canvas.width = 1920;
                    state.canvas.height = 1080;
                } else if (aspect === '9:16') {
                    state.canvas.width = 1080;
                    state.canvas.height = 1920;
                }

                document.getElementById('canvasWidth').value = state.canvas.width;
                document.getElementById('canvasHeight').value = state.canvas.height;
                updateCanvasSize();
            });
        });

        // Playback controls
        document.getElementById('playBtn').addEventListener('click', () => {
            if (state.isPlaying) {
                pause();
            } else {
                play();
            }
        });

        document.getElementById('stopBtn').addEventListener('click', stop);

        document.getElementById('loopBtn').addEventListener('click', () => {
            state.loop = !state.loop;
            document.getElementById('loopBtn').classList.toggle('active', state.loop);
        });

        // Timeline interaction
        document.getElementById('timelineRuler').addEventListener('click', (e) => {
            if (e.target.classList.contains('time-marker')) return;

            const ruler = document.getElementById('timelineRuler');
            const rect = ruler.getBoundingClientRect();
            const x = e.clientX - rect.left - 120;
            const rulerWidth = rect.width - 120;
            const progress = Math.max(0, Math.min(1, x / rulerWidth));

            state.currentTime = progress * state.duration;
            updateTimeDisplay();
            updatePlayhead();
            render();
        });

        // Add keyframe
        document.getElementById('addKeyframeBtn').addEventListener('click', () => {
            const properties = ['position', 'scale', 'rotation', 'opacity'];
            properties.forEach(prop => {
                let value;
                if (prop === 'position') value = { x: 0, y: 0 };
                else if (prop === 'scale') value = 1;
                else if (prop === 'rotation') value = 0;
                else if (prop === 'opacity') value = 1;

                state.keyframes[prop].push({
                    time: state.currentTime,
                    value: value,
                    elementIndex: 0
                });
            });
            renderTimeline();
        });

        // Keyframe interaction
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('keyframe')) {
                document.querySelectorAll('.keyframe').forEach(kf => kf.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(targetTab + 'Tab').classList.add('active');
            });
        });

        // Export modal
        document.getElementById('exportBtn').addEventListener('click', () => {
            document.getElementById('exportModal').classList.add('active');
        });

        document.getElementById('cancelExportBtn').addEventListener('click', () => {
            document.getElementById('exportModal').classList.remove('active');
        });

        document.getElementById('startExportBtn').addEventListener('click', async () => {
            const format = document.getElementById('exportFormat').value;
            const fps = parseInt(document.getElementById('exportFps').value);
            const quality = document.getElementById('exportQuality').value;

            document.getElementById('exportProgress').style.display = 'block';
            document.getElementById('startExportBtn').disabled = true;

            await exportAnimation(format, fps, quality);

            document.getElementById('exportProgress').style.display = 'none';
            document.getElementById('startExportBtn').disabled = false;
            document.getElementById('exportModal').classList.remove('active');
        });

        // Export function
        async function exportAnimation(format, fps, quality) {
            const totalFrames = Math.ceil(state.duration * fps);
            const frames = [];

            for (let i = 0; i < totalFrames; i++) {
                state.currentTime = (i / fps);
                render();

                if (format === 'png') {
                    const dataUrl = canvas.toDataURL('image/png');
                    downloadFile(dataUrl, `frame_${String(i).padStart(4, '0')}.png`);
                } else {
                    frames.push(canvas.toDataURL('image/webp', quality === 'high' ? 0.95 : quality === 'medium' ? 0.85 : 0.7));
                }

                const progress = ((i + 1) / totalFrames) * 100;
                document.getElementById('exportProgressBar').style.width = progress + '%';
                document.getElementById('exportProgressText').textContent = Math.round(progress) + '%';

                await new Promise(resolve => setTimeout(resolve, 10));
            }

            if (format === 'gif') {
                // For GIF, we'd need a library like gif.js, so we'll just download the first frame
                downloadFile(frames[0], 'animation.webp');
            } else if (format === 'webm') {
                // For WebM, we'd need MediaRecorder API with proper setup
                downloadFile(frames[0], 'animation.webp');
            }

            state.currentTime = 0;
            render();
        }

        function downloadFile(dataUrl, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = dataUrl;
            link.click();
        }

        // Audio modal
        document.getElementById('audioBtn').addEventListener('click', () => {
            document.getElementById('audioModal').classList.add('active');
        });

        document.getElementById('closeAudioBtn').addEventListener('click', () => {
            document.getElementById('audioModal').classList.remove('active');
        });

        document.getElementById('audioFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const arrayBuffer = await file.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                state.audio.context = audioContext;
                state.audio.file = audioBuffer;

                document.getElementById('audioControls').style.display = 'block';

                // Simple beat detection visualization
                const visualizer = document.getElementById('audioVisualizer');
                visualizer.innerHTML = '';

                const duration = audioBuffer.duration;
                state.duration = duration;
                document.getElementById('durationSlider').value = duration;
                document.getElementById('durationValue').textContent = duration.toFixed(1) + 's';

                // Auto-detect beats (simplified)
                if (document.getElementById('autoDetectBeats').checked) {
                    const bpm = parseInt(document.getElementById('bpm').value);
                    const beatInterval = 60 / bpm;

                    state.audio.beats = [];
                    for (let t = 0; t < duration; t += beatInterval) {
                        state.audio.beats.push(t);

                        const marker = document.createElement('div');
                        marker.className = 'beat-marker';
                        marker.style.left = (t / duration * 100) + '%';
                        visualizer.appendChild(marker);
                    }
                }

                renderTimeline();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            if (e.code === 'Space') {
                e.preventDefault();
                if (state.isPlaying) pause();
                else play();
            } else if (e.key === 'k' || e.key === 'K') {
                e.preventDefault();
                document.getElementById('addKeyframeBtn').click();
            }
        });

        // Window resize
        window.addEventListener('resize', () => {
            updateCanvasSize();
            renderTimeline();
        });

        // Initialize
        updateCanvasSize();
        renderTimeline();
        applyPreset('fadeUp');
        render();

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>