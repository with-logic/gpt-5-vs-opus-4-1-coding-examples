<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Theory Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --accent: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-light: #f1f5f9;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .music-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .note-float {
            position: absolute;
            font-size: 2rem;
            opacity: 0.1;
            animation: floatUp 15s linear infinite;
            color: #6366f1;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.15;
            }
            90% {
                opacity: 0.15;
            }
            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .piano-container {
            perspective: 1000px;
        }

        .piano {
            display: flex;
            position: relative;
            height: 200px;
            transform: rotateX(5deg);
            transform-style: preserve-3d;
        }

        .white-key {
            width: 50px;
            height: 200px;
            background: linear-gradient(180deg, #fff 0%, #e5e5e5 100%);
            border: 1px solid #ccc;
            border-radius: 0 0 6px 6px;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), inset 0 -3px 0 #d1d5db;
            position: relative;
            z-index: 1;
        }

        .white-key:hover {
            background: linear-gradient(180deg, #f0f0ff 0%, #ddd 100%);
        }

        .white-key.active, .white-key:active {
            background: linear-gradient(180deg, #c7d2fe 0%, #a5b4fc 100%);
            transform: translateY(3px);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2), inset 0 -1px 0 #d1d5db;
        }

        .white-key.correct {
            background: linear-gradient(180deg, #86efac 0%, #4ade80 100%) !important;
            animation: pulse-green 0.5s ease;
        }

        .white-key.incorrect {
            background: linear-gradient(180deg, #fca5a5 0%, #f87171 100%) !important;
            animation: shake 0.3s ease;
        }

        .black-key {
            width: 30px;
            height: 120px;
            background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
            border-radius: 0 0 4px 4px;
            position: absolute;
            z-index: 2;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5), inset 0 -3px 0 #374151;
        }

        .black-key:hover {
            background: linear-gradient(180deg, #374151 0%, #1f2937 100%);
        }

        .black-key.active, .black-key:active {
            background: linear-gradient(180deg, #4f46e5 0%, #4338ca 100%);
            transform: translateY(3px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), inset 0 -1px 0 #374151;
        }

        .black-key.correct {
            background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%) !important;
            animation: pulse-green 0.5s ease;
        }

        .black-key.incorrect {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%) !important;
            animation: shake 0.3s ease;
        }

        @keyframes pulse-green {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .key-label {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            pointer-events: none;
        }

        .black-key .key-label {
            color: #9ca3af;
            font-size: 10px;
        }

        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(236, 72, 153, 0.6);
        }

        .tab-active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease;
        }

        .visualizer-bar {
            background: linear-gradient(180deg, #6366f1 0%, #ec4899 100%);
            animation: visualize 0.5s ease infinite alternate;
        }

        @keyframes visualize {
            0% { height: 20%; }
            100% { height: 80%; }
        }

        .chord-diagram {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
        }

        .fret {
            height: 30px;
            border-bottom: 2px solid #6b7280;
            border-right: 1px solid #9ca3af;
            position: relative;
        }

        .fret:first-child {
            border-top: 4px solid #1f2937;
        }

        .finger-dot {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 50%;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .scale-note {
            transition: all 0.3s ease;
        }

        .scale-note.root {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%) !important;
        }

        .scale-note.in-scale {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;
        }

        .waveform {
            stroke: url(#waveGradient);
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
        }

        .glow {
            filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
        }

        .streak-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            animation: glow-pulse 2s ease-in-out infinite;
        }

        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 30px rgba(245, 158, 11, 0.8); }
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .staff-line {
            stroke: #6b7280;
            stroke-width: 1;
        }

        .note-head {
            fill: #f1f5f9;
            stroke: #f1f5f9;
            stroke-width: 1;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .key-highlight {
            animation: key-glow 1s ease-in-out infinite;
        }

        @keyframes key-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
            50% { box-shadow: 0 0 25px rgba(99, 102, 241, 0.9); }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 1000;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="text-gray-100">
    <!-- Floating Music Notes Background -->
    <div class="music-bg" id="musicBg"></div>

    <!-- Main Container -->
    <div class="relative z-10 min-h-screen p-4 md:p-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex items-center justify-center gap-3 mb-2">
                <svg class="w-12 h-12 glow" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="noteGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#6366f1"/>
                            <stop offset="100%" style="stop-color:#ec4899"/>
                        </linearGradient>
                    </defs>
                    <path d="M9 18V5l12-2v13" stroke="url(#noteGrad)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="6" cy="18" r="3" fill="url(#noteGrad)"/>
                    <circle cx="18" cy="16" r="3" fill="url(#noteGrad)"/>
                </svg>
                <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                    Music Theory Trainer
                </h1>
            </div>
            <p class="text-gray-400 text-lg">Master notes, scales, and chords through interactive exercises</p>
        </header>

        <!-- Stats Bar -->
        <div class="max-w-6xl mx-auto mb-6">
            <div class="card p-4 flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-2">
                        <div class="streak-badge px-3 py-1 rounded-full text-gray-900 font-bold flex items-center gap-1">
                            <span>üî•</span>
                            <span id="streakCount">0</span>
                        </div>
                        <span class="text-gray-400 text-sm">Streak</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-2xl font-bold text-green-400" id="scoreDisplay">0</div>
                        <span class="text-gray-400 text-sm">Score</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-2xl font-bold text-purple-400" id="levelDisplay">1</div>
                        <span class="text-gray-400 text-sm">Level</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <svg class="w-16 h-16 progress-ring">
                            <circle cx="32" cy="32" r="28" stroke="#1e293b" stroke-width="4" fill="none"/>
                            <circle id="progressCircle" class="progress-ring-circle" cx="32" cy="32" r="28" stroke="url(#noteGrad)" stroke-width="4" fill="none" stroke-dasharray="175.93" stroke-dashoffset="175.93"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="progressPercent" class="text-sm font-bold">0%</span>
                        </div>
                    </div>
                    <span class="text-gray-400 text-sm">Session<br/>Progress</span>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="max-w-6xl mx-auto mb-6">
            <div class="flex flex-wrap gap-2 justify-center">
                <button onclick="switchTab('notes')" class="tab-btn tab-active px-6 py-3 rounded-xl font-semibold transition-all" data-tab="notes">
                    üéµ Notes
                </button>
                <button onclick="switchTab('scales')" class="tab-btn px-6 py-3 rounded-xl font-semibold bg-gray-700/50 hover:bg-gray-600/50 transition-all" data-tab="scales">
                    üéº Scales
                </button>
                <button onclick="switchTab('chords')" class="tab-btn px-6 py-3 rounded-xl font-semibold bg-gray-700/50 hover:bg-gray-600/50 transition-all" data-tab="chords">
                    üéπ Chords
                </button>
                <button onclick="switchTab('ear')" class="tab-btn px-6 py-3 rounded-xl font-semibold bg-gray-700/50 hover:bg-gray-600/50 transition-all" data-tab="ear">
                    üëÇ Ear Training
                </button>
                <button onclick="switchTab('reading')" class="tab-btn px-6 py-3 rounded-xl font-semibold bg-gray-700/50 hover:bg-gray-600/50 transition-all" data-tab="reading">
                    üìñ Note Reading
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="max-w-6xl mx-auto">
            <!-- Notes Tab -->
            <div id="notesTab" class="tab-content">
                <div class="card p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-3xl">üéµ</span> Learn the Notes
                    </h2>
                    <p class="text-gray-400 mb-6">Click on the piano keys to hear and learn each note. The highlighted key is your target!</p>

                    <div class="flex flex-col items-center gap-6">
                        <div class="text-center mb-4">
                            <div class="text-gray-400 mb-2">Find this note:</div>
                            <div id="targetNote" class="text-6xl font-bold bg-gradient-to-r from-indigo-400 to-pink-400 bg-clip-text text-transparent">C4</div>
                        </div>

                        <div class="piano-container overflow-x-auto w-full">
                            <div class="piano mx-auto" id="piano"></div>
                        </div>

                        <div class="flex gap-4 mt-4">
                            <button onclick="newNoteChallenge()" class="btn-primary px-6 py-3 rounded-xl font-semibold">
                                New Note
                            </button>
                            <button onclick="playTargetNote()" class="btn-secondary px-6 py-3 rounded-xl font-semibold">
                                üîä Hear Note
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4">üìö Note Reference</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-700/50 p-4 rounded-xl">
                            <div class="text-2xl font-bold text-indigo-400">C</div>
                            <div class="text-gray-400 text-sm">Do - The home base</div>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl">
                            <div class="text-2xl font-bold text-indigo-400">D</div>
                            <div class="text-gray-400 text-sm">Re - One step up</div>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl">
                            <div class="text-2xl font-bold text-indigo-400">E</div>
                            <div class="text-gray-400 text-sm">Mi - Major third</div>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl">
                            <div class="text-2xl font-bold text-indigo-400">F</div>
                            <div class="text-gray-400 text-sm">Fa - Perfect fourth</div>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl">
                            <div class="text-2xl font-bold text-indigo-400">G</div>
                            <div class="text-gray-400 text-sm">Sol - Perfect fifth</div>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl">
                            <div class="text-2xl font-bold text-indigo-400">A</div>
                            <div class="text-gray-400 text-sm">La - Major sixth</div>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl">
                            <div class="text-2xl font-bold text-indigo-400">B</div>
                            <div class="text-gray-400 text-sm">Ti - Leading tone</div>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl">
                            <div class="text-2xl font-bold text-pink-400"># / ‚ô≠</div>
                            <div class="text-gray-400 text-sm">Sharps & Flats</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scales Tab -->
            <div id="scalesTab" class="tab-content hidden">
                <div class="card p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-3xl">üéº</span> Learn Scales
                    </h2>
                    <p class="text-gray-400 mb-6">Explore different musical scales and their patterns.</p>

                    <div class="flex flex-wrap gap-4 mb-6">
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Root Note</label>
                            <select id="scaleRoot" onchange="updateScale()" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                                <option value="C">C</option>
                                <option value="C#">C# / D‚ô≠</option>
                                <option value="D">D</option>
                                <option value="D#">D# / E‚ô≠</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F#">F# / G‚ô≠</option>
                                <option value="G">G</option>
                                <option value="G#">G# / A‚ô≠</option>
                                <option value="A">A</option>
                                <option value="A#">A# / B‚ô≠</option>
                                <option value="B">B</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Scale Type</label>
                            <select id="scaleType" onchange="updateScale()" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                                <option value="major">Major (Ionian)</option>
                                <option value="minor">Natural Minor (Aeolian)</option>
                                <option value="harmonicMinor">Harmonic Minor</option>
                                <option value="melodicMinor">Melodic Minor</option>
                                <option value="dorian">Dorian</option>
                                <option value="phrygian">Phrygian</option>
                                <option value="lydian">Lydian</option>
                                <option value="mixolydian">Mixolydian</option>
                                <option value="pentatonicMajor">Pentatonic Major</option>
                                <option value="pentatonicMinor">Pentatonic Minor</option>
                                <option value="blues">Blues</option>
                            </select>
                        </div>
                    </div>

                    <div class="piano-container overflow-x-auto w-full mb-6">
                        <div class="piano mx-auto" id="scalePiano"></div>
                    </div>

                    <div class="flex gap-4 justify-center">
                        <button onclick="playScale()" class="btn-primary px-6 py-3 rounded-xl font-semibold">
                            ‚ñ∂Ô∏è Play Scale
                        </button>
                        <button onclick="practiceScale()" class="btn-secondary px-6 py-3 rounded-xl font-semibold">
                            üéØ Practice Mode
                        </button>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4">üìä Scale Information</h3>
                    <div id="scaleInfo" class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-indigo-400 mb-2">Notes in Scale</h4>
                            <div id="scaleNotes" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-indigo-400 mb-2">Interval Pattern</h4>
                            <div id="scaleIntervals" class="text-gray-400"></div>
                        </div>
                        <div class="md:col-span-2">
                            <h4 class="font-semibold text-indigo-400 mb-2">About This Scale</h4>
                            <p id="scaleDescription" class="text-gray-400"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chords Tab -->
            <div id="chordsTab" class="tab-content hidden">
                <div class="card p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-3xl">üéπ</span> Learn Chords
                    </h2>
                    <p class="text-gray-400 mb-6">Master chord construction and voicings.</p>

                    <div class="flex flex-wrap gap-4 mb-6">
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Root Note</label>
                            <select id="chordRoot" onchange="updateChord()" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                                <option value="C">C</option>
                                <option value="C#">C# / D‚ô≠</option>
                                <option value="D">D</option>
                                <option value="D#">D# / E‚ô≠</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F#">F# / G‚ô≠</option>
                                <option value="G">G</option>
                                <option value="G#">G# / A‚ô≠</option>
                                <option value="A">A</option>
                                <option value="A#">A# / B‚ô≠</option>
                                <option value="B">B</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Chord Type</label>
                            <select id="chordType" onchange="updateChord()" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                                <option value="major">Major</option>
                                <option value="minor">Minor</option>
                                <option value="diminished">Diminished</option>
                                <option value="augmented">Augmented</option>
                                <option value="major7">Major 7th</option>
                                <option value="minor7">Minor 7th</option>
                                <option value="dominant7">Dominant 7th</option>
                                <option value="diminished7">Diminished 7th</option>
                                <option value="halfDiminished7">Half-Diminished 7th</option>
                                <option value="sus2">Suspended 2nd</option>
                                <option value="sus4">Suspended 4th</option>
                                <option value="add9">Add 9</option>
                            </select>
                        </div>
                    </div>

                    <div class="piano-container overflow-x-auto w-full mb-6">
                        <div class="piano mx-auto" id="chordPiano"></div>
                    </div>

                    <div class="flex gap-4 justify-center">
                        <button onclick="playChord()" class="btn-primary px-6 py-3 rounded-xl font-semibold">
                            ‚ñ∂Ô∏è Play Chord
                        </button>
                        <button onclick="playChordArpeggiated()" class="btn-secondary px-6 py-3 rounded-xl font-semibold">
                            üéµ Arpeggiate
                        </button>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4">üìä Chord Information</h3>
                    <div id="chordInfo" class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-indigo-400 mb-2">Notes in Chord</h4>
                            <div id="chordNotes" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-indigo-400 mb-2">Intervals</h4>
                            <div id="chordIntervals" class="text-gray-400"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-indigo-400 mb-2">Formula</h4>
                            <div id="chordFormula" class="text-gray-400"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-indigo-400 mb-2">Common Uses</h4>
                            <p id="chordDescription" class="text-gray-400"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ear Training Tab -->
            <div id="earTab" class="tab-content hidden">
                <div class="card p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-3xl">üëÇ</span> Ear Training
                    </h2>
                    <p class="text-gray-400 mb-6">Train your ear to recognize intervals, chords, and melodies.</p>

                    <div class="flex flex-wrap gap-4 mb-6">
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Exercise Type</label>
                            <select id="earExerciseType" onchange="startEarExercise()" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                                <option value="interval">Intervals</option>
                                <option value="chord">Chord Quality</option>
                                <option value="melody">Melody Recall</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Difficulty</label>
                            <select id="earDifficulty" onchange="startEarExercise()" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>

                    <!-- Audio Visualizer -->
                    <div class="bg-gray-800/50 rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-center h-24 gap-1">
                            <div class="visualizer-bar w-2 rounded-full bg-gradient-to-t from-indigo-500 to-pink-500" style="animation-delay: 0s; height: 30%;"></div>
                            <div class="visualizer-bar w-2 rounded-full bg-gradient-to-t from-indigo-500 to-pink-500" style="animation-delay: 0.1s; height: 50%;"></div>
                            <div class="visualizer-bar w-2 rounded-full bg-gradient-to-t from-indigo-500 to-pink-500" style="animation-delay: 0.2s; height: 70%;"></div>
                            <div class="visualizer-bar w-2 rounded-full bg-gradient-to-t from-indigo-500 to-pink-500" style="animation-delay: 0.3s; height: 40%;"></div>
                            <div class="visualizer-bar w-2 rounded-full bg-gradient-to-t from-indigo-500 to-pink-500" style="animation-delay: 0.4s; height: 60%;"></div>
                            <div class="visualizer-bar w-2 rounded-full bg-gradient-to-t from-indigo-500 to-pink-500" style="animation-delay: 0.5s; height: 80%;"></div>
                            <div class="visualizer-bar w-2 rounded-full bg-gradient-to-t from-indigo-500 to-pink-500" style="animation-delay: 0.6s; height: 45%;"></div>
                            <div class="visualizer-bar w-2 rounded-full bg-gradient-to-t from-indigo-500 to-pink-500" style="animation-delay: 0.7s; height: 55%;"></div>
                            <div class="visualizer-bar w-2 rounded-full bg-gradient-to-t from-indigo-500 to-pink-500" style="animation-delay: 0.8s; height: 35%;"></div>
                            <div class="visualizer-bar w-2 rounded-full bg-gradient-to-t from-indigo-500 to-pink-500" style="animation-delay: 0.9s; height: 65%;"></div>
                        </div>
                    </div>

                    <div class="text-center mb-6">
                        <div id="earQuestion" class="text-xl text-gray-300 mb-4">Select an exercise type to begin!</div>
                        <button onclick="playEarExercise()" class="btn-primary px-8 py-4 rounded-xl font-semibold text-lg mb-4">
                            üîä Play Sound
                        </button>
                    </div>

                    <div id="earOptions" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                </div>

                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4">üìà Your Progress</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-gray-700/50 p-4 rounded-xl text-center">
                            <div id="earCorrect" class="text-3xl font-bold text-green-400">0</div>
                            <div class="text-gray-400 text-sm">Correct</div>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl text-center">
                            <div id="earTotal" class="text-3xl font-bold text-indigo-400">0</div>
                            <div class="text-gray-400 text-sm">Total</div>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl text-center">
                            <div id="earAccuracy" class="text-3xl font-bold text-pink-400">0%</div>
                            <div class="text-gray-400 text-sm">Accuracy</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Note Reading Tab -->
            <div id="readingTab" class="tab-content hidden">
                <div class="card p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-3xl">üìñ</span> Note Reading
                    </h2>
                    <p class="text-gray-400 mb-6">Learn to read music by identifying notes on the staff.</p>

                    <div class="flex flex-wrap gap-4 mb-6">
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Clef</label>
                            <select id="staffClef" onchange="newReadingChallenge()" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                                <option value="treble">Treble Clef</option>
                                <option value="bass">Bass Clef</option>
                                <option value="both">Both Clefs</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm block mb-2">Range</label>
                            <select id="noteRange" onchange="newReadingChallenge()" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                                <option value="lines">Lines Only</option>
                                <option value="spaces">Spaces Only</option>
                                <option value="all">All Notes</option>
                                <option value="ledger">Include Ledger Lines</option>
                            </select>
                        </div>
                    </div>

                    <!-- Staff Display -->
                    <div class="bg-gray-800/50 rounded-xl p-6 mb-6 flex justify-center">
                        <svg id="staffDisplay" width="400" height="200" viewBox="0 0 400 200">
                            <defs>
                                <linearGradient id="waveGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#6366f1"/>
                                    <stop offset="100%" style="stop-color:#ec4899"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>

                    <div class="text-center mb-6">
                        <div class="text-gray-400 mb-2">What note is this?</div>
                        <div class="flex flex-wrap justify-center gap-2" id="readingOptions">
                            <!-- Note options will be populated here -->
                        </div>
                    </div>

                    <div class="flex gap-4 justify-center">
                        <button onclick="newReadingChallenge()" class="btn-primary px-6 py-3 rounded-xl font-semibold">
                            New Note
                        </button>
                        <button onclick="playReadingNote()" class="btn-secondary px-6 py-3 rounded-xl font-semibold">
                            üîä Hear Note
                        </button>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4">üí° Reading Tips</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-gray-700/50 p-4 rounded-xl">
                            <h4 class="font-semibold text-indigo-400 mb-2">Treble Clef Lines</h4>
                            <p class="text-gray-400">E G B D F - "Every Good Boy Does Fine"</p>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl">
                            <h4 class="font-semibold text-indigo-400 mb-2">Treble Clef Spaces</h4>
                            <p class="text-gray-400">F A C E - It spells "FACE"!</p>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl">
                            <h4 class="font-semibold text-indigo-400 mb-2">Bass Clef Lines</h4>
                            <p class="text-gray-400">G B D F A - "Good Boys Do Fine Always"</p>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl">
                            <h4 class="font-semibold text-indigo-400 mb-2">Bass Clef Spaces</h4>
                            <p class="text-gray-400">A C E G - "All Cows Eat Grass"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>üéµ Music Theory Trainer - Learn music the fun way! üéµ</p>
            <p class="mt-1">Press keys A-L on your keyboard to play the piano</p>
        </footer>
    </div>

    <script>
        // Audio Context and Synthesizer
        let audioContext = null;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Note frequencies (A4 = 440Hz)
        const noteFrequencies = {
            'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81,
            'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00,
            'A#3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63,
            'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00,
            'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25,
            'F5': 698.46, 'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00,
            'A#5': 932.33, 'B5': 987.77, 'C6': 1046.50
        };

        const allNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

        // Scale patterns (in semitones from root)
        const scalePatterns = {
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            harmonicMinor: [0, 2, 3, 5, 7, 8, 11],
            melodicMinor: [0, 2, 3, 5, 7, 9, 11],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],
            pentatonicMajor: [0, 2, 4, 7, 9],
            pentatonicMinor: [0, 3, 5, 7, 10],
            blues: [0, 3, 5, 6, 7, 10]
        };

        const scaleDescriptions = {
            major: "The major scale is the foundation of Western music. It has a bright, happy sound and is used in countless songs.",
            minor: "The natural minor scale has a darker, more melancholic sound. It's the relative minor of the major scale.",
            harmonicMinor: "The harmonic minor scale has a raised 7th degree, creating a distinctive 'exotic' sound often heard in classical and metal music.",
            melodicMinor: "The melodic minor scale has both raised 6th and 7th degrees ascending, giving it a jazz flavor.",
            dorian: "The Dorian mode is a minor scale with a raised 6th. It's commonly used in jazz, blues, and rock.",
            phrygian: "The Phrygian mode has a distinctive flattened 2nd degree, giving it a Spanish or Middle Eastern flavor.",
            lydian: "The Lydian mode has a raised 4th degree, creating a dreamy, floating quality often used in film scores.",
            mixolydian: "The Mixolydian mode is like major but with a flattened 7th. It's essential for blues and rock.",
            pentatonicMajor: "The major pentatonic scale uses only 5 notes, making it easy to improvise with. Very common in folk and country music.",
            pentatonicMinor: "The minor pentatonic scale is the foundation of blues and rock improvisation. It always sounds good!",
            blues: "The blues scale adds the 'blue note' (flat 5th) to the minor pentatonic, creating that classic blues sound."
        };

        // Chord patterns (in semitones from root)
        const chordPatterns = {
            major: [0, 4, 7],
            minor: [0, 3, 7],
            diminished: [0, 3, 6],
            augmented: [0, 4, 8],
            major7: [0, 4, 7, 11],
            minor7: [0, 3, 7, 10],
            dominant7: [0, 4, 7, 10],
            diminished7: [0, 3, 6, 9],
            halfDiminished7: [0, 3, 6, 10],
            sus2: [0, 2, 7],
            sus4: [0, 5, 7],
            add9: [0, 4, 7, 14]
        };

        const chordDescriptions = {
            major: "Bright and happy sounding. The most common chord type in pop music.",
            minor: "Darker and more somber. Often used to convey sadness or tension.",
            diminished: "Tense and unstable. Often used as a passing chord or to create suspense.",
            augmented: "Mysterious and unresolved. Creates a sense of upward motion.",
            major7: "Smooth and jazzy. Adds a sophisticated color to the major chord.",
            minor7: "Mellow and contemplative. Essential in jazz and R&B.",
            dominant7: "Bluesy and wanting to resolve. The backbone of blues and jazz.",
            diminished7: "Very tense and symmetrical. Used for dramatic effect.",
            halfDiminished7: "Also called minor 7 flat 5. Important in jazz progressions.",
            sus2: "Open and modern sounding. Neither major nor minor.",
            sus4: "Creates anticipation. Wants to resolve to major or minor.",
            add9: "Bright with added color. Popular in pop and rock music."
        };

        const chordFormulas = {
            major: "1 - 3 - 5",
            minor: "1 - ‚ô≠3 - 5",
            diminished: "1 - ‚ô≠3 - ‚ô≠5",
            augmented: "1 - 3 - #5",
            major7: "1 - 3 - 5 - 7",
            minor7: "1 - ‚ô≠3 - 5 - ‚ô≠7",
            dominant7: "1 - 3 - 5 - ‚ô≠7",
            diminished7: "1 - ‚ô≠3 - ‚ô≠5 - ùÑ´7",
            halfDiminished7: "1 - ‚ô≠3 - ‚ô≠5 - ‚ô≠7",
            sus2: "1 - 2 - 5",
            sus4: "1 - 4 - 5",
            add9: "1 - 3 - 5 - 9"
        };

        // Intervals
        const intervals = [
            { name: 'Minor 2nd', semitones: 1 },
            { name: 'Major 2nd', semitones: 2 },
            { name: 'Minor 3rd', semitones: 3 },
            { name: 'Major 3rd', semitones: 4 },
            { name: 'Perfect 4th', semitones: 5 },
            { name: 'Tritone', semitones: 6 },
            { name: 'Perfect 5th', semitones: 7 },
            { name: 'Minor 6th', semitones: 8 },
            { name: 'Major 6th', semitones: 9 },
            { name: 'Minor 7th', semitones: 10 },
            { name: 'Major 7th', semitones: 11 },
            { name: 'Octave', semitones: 12 }
        ];

        // Game State
        let gameState = {
            score: 0,
            streak: 0,
            level: 1,
            questionsAnswered: 0,
            targetNote: 'C4',
            currentTab: 'notes',
            earExercise: {
                type: 'interval',
                answer: null,
                correct: 0,
                total: 0
            },
            reading: {
                currentNote: null,
                clef: 'treble'
            }
        };

        // Play a note
        function playNote(note, duration = 0.5) {
            initAudio();
            const freq = noteFrequencies[note];
            if (!freq) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            // Use a combination of waves for a piano-like sound
            oscillator.type = 'triangle';

            // Add harmonics for richer sound
            const osc2 = audioContext.createOscillator();
            osc2.type = 'sine';
            osc2.frequency.value = freq * 2;

            const osc3 = audioContext.createOscillator();
            osc3.type = 'sine';
            osc3.frequency.value = freq * 3;

            const gain2 = audioContext.createGain();
            const gain3 = audioContext.createGain();
            gain2.gain.value = 0.3;
            gain3.gain.value = 0.15;

            oscillator.frequency.value = freq;

            // Envelope
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.connect(gainNode);
            osc2.connect(gain2);
            osc3.connect(gain3);
            gain2.connect(gainNode);
            gain3.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start();
            osc2.start();
            osc3.start();
            oscillator.stop(audioContext.currentTime + duration);
            osc2.stop(audioContext.currentTime + duration);
            osc3.stop(audioContext.currentTime + duration);
        }

        // Create piano
        function createPiano(containerId, options = {}) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            const startOctave = options.startOctave || 4;
            const endOctave = options.endOctave || 5;
            const onKeyClick = options.onKeyClick || function() {};
            const highlightNotes = options.highlightNotes || [];
            const highlightRoot = options.highlightRoot || null;

            let whiteKeyIndex = 0;

            for (let octave = startOctave; octave <= endOctave; octave++) {
                for (let i = 0; i < 12; i++) {
                    const noteName = allNotes[i];
                    const fullNote = noteName + octave;
                    const isBlack = noteName.includes('#');

                    if (octave === endOctave && i > 0) break; // Only C of last octave

                    const key = document.createElement('div');
                    key.className = isBlack ? 'black-key' : 'white-key';
                    key.dataset.note = fullNote;

                    if (isBlack) {
                        const blackKeyPositions = { 'C#': 35, 'D#': 85, 'F#': 185, 'G#': 235, 'A#': 285 };
                        const basePos = (whiteKeyIndex - 1) * 50;
                        key.style.left = (basePos + blackKeyPositions[noteName] - 135) + 'px';
                    }

                    // Highlighting
                    if (highlightRoot === fullNote) {
                        key.classList.add('scale-note', 'root');
                    } else if (highlightNotes.includes(fullNote)) {
                        key.classList.add('scale-note', 'in-scale');
                    }

                    // Add label for white keys
                    if (!isBlack) {
                        const label = document.createElement('span');
                        label.className = 'key-label';
                        label.textContent = noteName + (octave === 4 ? '' : octave);
                        key.appendChild(label);
                        whiteKeyIndex++;
                    }

                    key.addEventListener('click', () => {
                        playNote(fullNote);
                        onKeyClick(fullNote, key);
                    });

                    key.addEventListener('mousedown', () => key.classList.add('active'));
                    key.addEventListener('mouseup', () => key.classList.remove('active'));
                    key.addEventListener('mouseleave', () => key.classList.remove('active'));

                    container.appendChild(key);
                }
            }
        }

        // Notes Tab
        function initNotesTab() {
            createPiano('piano', {
                onKeyClick: (note, key) => {
                    checkNoteAnswer(note, key);
                }
            });
            newNoteChallenge();
        }

        function newNoteChallenge() {
            const notes = Object.keys(noteFrequencies).filter(n => {
                const octave = parseInt(n.slice(-1));
                return octave >= 4 && octave <= 5;
            });
            gameState.targetNote = notes[Math.floor(Math.random() * notes.length)];
            document.getElementById('targetNote').textContent = gameState.targetNote;

            // Clear any previous highlights
            document.querySelectorAll('#piano .correct, #piano .incorrect, #piano .key-highlight').forEach(key => {
                key.classList.remove('correct', 'incorrect', 'key-highlight');
            });
        }

        function playTargetNote() {
            playNote(gameState.targetNote);
        }

        function checkNoteAnswer(note, key) {
            const isCorrect = note === gameState.targetNote;

            if (isCorrect) {
                key.classList.add('correct');
                updateScore(10);
                gameState.streak++;
                setTimeout(() => {
                    key.classList.remove('correct');
                    newNoteChallenge();
                }, 500);
                createConfetti();
            } else {
                key.classList.add('incorrect');
                gameState.streak = 0;
                setTimeout(() => key.classList.remove('incorrect'), 300);

                // Highlight correct key
                const correctKey = document.querySelector(`#piano [data-note="${gameState.targetNote}"]`);
                if (correctKey) {
                    correctKey.classList.add('key-highlight');
                }
            }

            updateStats();
        }

        // Scales Tab
        function initScalesTab() {
            updateScale();
        }

        function updateScale() {
            const root = document.getElementById('scaleRoot').value;
            const type = document.getElementById('scaleType').value;
            const pattern = scalePatterns[type];

            const rootIndex = allNotes.indexOf(root);
            const scaleNotes = pattern.map(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                return allNotes[noteIndex];
            });

            // Get full note names with octaves
            const highlightNotes = [];
            let octave = 4;
            pattern.forEach((interval, i) => {
                let noteOctave = octave;
                if (rootIndex + interval >= 12) noteOctave = 5;
                highlightNotes.push(allNotes[(rootIndex + interval) % 12] + noteOctave);
            });

            createPiano('scalePiano', {
                highlightNotes: highlightNotes,
                highlightRoot: root + '4',
                onKeyClick: (note) => {
                    // Just play the note
                }
            });

            // Update info panel
            document.getElementById('scaleNotes').innerHTML = scaleNotes.map((note, i) =>
                `<span class="px-3 py-1 rounded-full ${i === 0 ? 'bg-red-500' : 'bg-indigo-500'} text-white font-semibold">${note}</span>`
            ).join('');

            const intervalNames = ['R', '2', '‚ô≠3/3', '4', '‚ô≠5/5', '6', '‚ô≠7/7'];
            document.getElementById('scaleIntervals').textContent = pattern.map(p =>
                p === 0 ? 'Root' : p + ' semitones'
            ).join(' ‚Üí ');

            document.getElementById('scaleDescription').textContent = scaleDescriptions[type];
        }

        function playScale() {
            const root = document.getElementById('scaleRoot').value;
            const type = document.getElementById('scaleType').value;
            const pattern = scalePatterns[type];
            const rootIndex = allNotes.indexOf(root);

            let time = 0;
            pattern.forEach((interval, i) => {
                setTimeout(() => {
                    let octave = 4;
                    if (rootIndex + interval >= 12) octave = 5;
                    playNote(allNotes[(rootIndex + interval) % 12] + octave, 0.4);

                    // Highlight key
                    const noteKey = document.querySelector(`#scalePiano [data-note="${allNotes[(rootIndex + interval) % 12] + octave}"]`);
                    if (noteKey) {
                        noteKey.classList.add('active');
                        setTimeout(() => noteKey.classList.remove('active'), 350);
                    }
                }, time);
                time += 400;
            });

            // Play root again at the end
            setTimeout(() => {
                playNote(root + '5', 0.6);
            }, time);
        }

        let scalePracticeMode = false;
        let scalePracticeNotes = [];
        let scalePracticeIndex = 0;

        function practiceScale() {
            const root = document.getElementById('scaleRoot').value;
            const type = document.getElementById('scaleType').value;
            const pattern = scalePatterns[type];
            const rootIndex = allNotes.indexOf(root);

            scalePracticeNotes = [];
            pattern.forEach(interval => {
                let octave = 4;
                if (rootIndex + interval >= 12) octave = 5;
                scalePracticeNotes.push(allNotes[(rootIndex + interval) % 12] + octave);
            });
            scalePracticeNotes.push(root + '5'); // Add octave at end

            scalePracticeIndex = 0;
            scalePracticeMode = true;

            // Highlight first note
            highlightPracticeNote();

            alert(`Practice the ${root} ${type} scale! Play the highlighted notes in order.`);
        }

        function highlightPracticeNote() {
            document.querySelectorAll('#scalePiano .key-highlight').forEach(k => k.classList.remove('key-highlight'));
            if (scalePracticeIndex < scalePracticeNotes.length) {
                const noteKey = document.querySelector(`#scalePiano [data-note="${scalePracticeNotes[scalePracticeIndex]}"]`);
                if (noteKey) noteKey.classList.add('key-highlight');
            }
        }

        // Chords Tab
        function initChordsTab() {
            updateChord();
        }

        function updateChord() {
            const root = document.getElementById('chordRoot').value;
            const type = document.getElementById('chordType').value;
            const pattern = chordPatterns[type];

            const rootIndex = allNotes.indexOf(root);
            const chordNotes = pattern.map(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                return allNotes[noteIndex];
            });

            // Get full note names with octaves
            const highlightNotes = pattern.map(interval => {
                let octave = 4;
                if (rootIndex + interval >= 12) octave = 5;
                return allNotes[(rootIndex + interval) % 12] + octave;
            });

            createPiano('chordPiano', {
                highlightNotes: highlightNotes,
                highlightRoot: root + '4',
                onKeyClick: (note) => {
                    // Just play
                }
            });

            // Update info panel
            document.getElementById('chordNotes').innerHTML = chordNotes.map((note, i) =>
                `<span class="px-3 py-1 rounded-full ${i === 0 ? 'bg-red-500' : 'bg-indigo-500'} text-white font-semibold">${note}</span>`
            ).join('');

            const intervalLabels = ['Root', 'Third', 'Fifth', 'Seventh', 'Ninth'];
            document.getElementById('chordIntervals').textContent = pattern.map((p, i) =>
                `${intervalLabels[i] || 'Extension'}: ${p} semitones`
            ).join(', ');

            document.getElementById('chordFormula').textContent = chordFormulas[type];
            document.getElementById('chordDescription').textContent = chordDescriptions[type];
        }

        function playChord() {
            const root = document.getElementById('chordRoot').value;
            const type = document.getElementById('chordType').value;
            const pattern = chordPatterns[type];
            const rootIndex = allNotes.indexOf(root);

            pattern.forEach(interval => {
                let octave = 4;
                if (rootIndex + interval >= 12) octave = 5;
                const note = allNotes[(rootIndex + interval) % 12] + octave;
                playNote(note, 1);

                const noteKey = document.querySelector(`#chordPiano [data-note="${note}"]`);
                if (noteKey) {
                    noteKey.classList.add('active');
                    setTimeout(() => noteKey.classList.remove('active'), 800);
                }
            });
        }

        function playChordArpeggiated() {
            const root = document.getElementById('chordRoot').value;
            const type = document.getElementById('chordType').value;
            const pattern = chordPatterns[type];
            const rootIndex = allNotes.indexOf(root);

            let time = 0;
            pattern.forEach(interval => {
                setTimeout(() => {
                    let octave = 4;
                    if (rootIndex + interval >= 12) octave = 5;
                    const note = allNotes[(rootIndex + interval) % 12] + octave;
                    playNote(note, 0.6);

                    const noteKey = document.querySelector(`#chordPiano [data-note="${note}"]`);
                    if (noteKey) {
                        noteKey.classList.add('active');
                        setTimeout(() => noteKey.classList.remove('active'), 500);
                    }
                }, time);
                time += 300;
            });
        }

        // Ear Training Tab
        function initEarTab() {
            startEarExercise();
        }

        function startEarExercise() {
            const type = document.getElementById('earExerciseType').value;
            const difficulty = document.getElementById('earDifficulty').value;

            gameState.earExercise.type = type;

            let options = [];
            let answer = null;

            if (type === 'interval') {
                const difficultyIntervals = {
                    easy: intervals.filter(i => [3, 4, 5, 7, 12].includes(i.semitones)),
                    medium: intervals.filter(i => [2, 3, 4, 5, 7, 9, 12].includes(i.semitones)),
                    hard: intervals
                };
                options = difficultyIntervals[difficulty];
                answer = options[Math.floor(Math.random() * options.length)];
                gameState.earExercise.answer = answer;

                document.getElementById('earQuestion').textContent = 'What interval do you hear?';
                document.getElementById('earOptions').innerHTML = options.map(opt =>
                    `<button onclick="checkEarAnswer('${opt.name}')" class="bg-gray-700 hover:bg-indigo-600 px-4 py-3 rounded-xl font-semibold transition-all">${opt.name}</button>`
                ).join('');
            } else if (type === 'chord') {
                const difficultyChords = {
                    easy: ['major', 'minor'],
                    medium: ['major', 'minor', 'diminished', 'augmented'],
                    hard: ['major', 'minor', 'diminished', 'augmented', 'major7', 'minor7', 'dominant7']
                };
                options = difficultyChords[difficulty];
                answer = options[Math.floor(Math.random() * options.length)];
                gameState.earExercise.answer = answer;

                document.getElementById('earQuestion').textContent = 'What type of chord do you hear?';
                document.getElementById('earOptions').innerHTML = options.map(opt =>
                    `<button onclick="checkEarAnswer('${opt}')" class="bg-gray-700 hover:bg-indigo-600 px-4 py-3 rounded-xl font-semibold transition-all capitalize">${opt}</button>`
                ).join('');
            } else if (type === 'melody') {
                const noteCounts = { easy: 3, medium: 4, hard: 5 };
                const count = noteCounts[difficulty];
                const melodyNotes = [];
                for (let i = 0; i < count; i++) {
                    const note = whiteNotes[Math.floor(Math.random() * whiteNotes.length)] + '4';
                    melodyNotes.push(note);
                }
                gameState.earExercise.answer = melodyNotes;

                document.getElementById('earQuestion').textContent = `Listen and repeat the ${count}-note melody on the piano!`;
                document.getElementById('earOptions').innerHTML = `
                    <div class="col-span-4">
                        <div class="piano-container overflow-x-auto w-full">
                            <div class="piano mx-auto" id="earPiano"></div>
                        </div>
                    </div>
                `;

                createPiano('earPiano', {
                    onKeyClick: (note) => checkMelodyNote(note)
                });

                gameState.earExercise.melodyIndex = 0;
            }
        }

        let melodyUserInput = [];

        function checkMelodyNote(note) {
            const answer = gameState.earExercise.answer;
            melodyUserInput.push(note);

            if (melodyUserInput.length === answer.length) {
                const correct = melodyUserInput.every((n, i) => n === answer[i]);
                if (correct) {
                    gameState.earExercise.correct++;
                    updateScore(20);
                    gameState.streak++;
                    createConfetti();
                    document.getElementById('earQuestion').textContent = '‚úÖ Correct! Great ear!';
                } else {
                    gameState.streak = 0;
                    document.getElementById('earQuestion').textContent = `‚ùå The melody was: ${answer.map(n => n.replace('4', '')).join(' - ')}`;
                }
                gameState.earExercise.total++;
                updateEarStats();
                melodyUserInput = [];
                setTimeout(startEarExercise, 2000);
            }
        }

        function playEarExercise() {
            const type = gameState.earExercise.type;
            const answer = gameState.earExercise.answer;

            if (type === 'interval') {
                const rootNote = 'C4';
                const rootIndex = allNotes.indexOf('C');
                let secondOctave = 4;
                if (rootIndex + answer.semitones >= 12) secondOctave = 5;
                const secondNote = allNotes[(rootIndex + answer.semitones) % 12] + secondOctave;

                playNote(rootNote, 0.5);
                setTimeout(() => playNote(secondNote, 0.5), 600);
            } else if (type === 'chord') {
                const pattern = chordPatterns[answer];
                const rootIndex = allNotes.indexOf('C');

                pattern.forEach(interval => {
                    let octave = 4;
                    if (rootIndex + interval >= 12) octave = 5;
                    playNote(allNotes[(rootIndex + interval) % 12] + octave, 1);
                });
            } else if (type === 'melody') {
                let time = 0;
                answer.forEach(note => {
                    setTimeout(() => playNote(note, 0.4), time);
                    time += 500;
                });
            }
        }

        function checkEarAnswer(answer) {
            const correct = answer === gameState.earExercise.answer.name || answer === gameState.earExercise.answer;

            if (correct) {
                gameState.earExercise.correct++;
                updateScore(15);
                gameState.streak++;
                createConfetti();
                document.getElementById('earQuestion').textContent = '‚úÖ Correct!';
            } else {
                gameState.streak = 0;
                const correctAnswer = gameState.earExercise.answer.name || gameState.earExercise.answer;
                document.getElementById('earQuestion').textContent = `‚ùå It was: ${correctAnswer}`;
            }

            gameState.earExercise.total++;
            updateEarStats();

            setTimeout(startEarExercise, 1500);
        }

        function updateEarStats() {
            document.getElementById('earCorrect').textContent = gameState.earExercise.correct;
            document.getElementById('earTotal').textContent = gameState.earExercise.total;
            const accuracy = gameState.earExercise.total > 0
                ? Math.round((gameState.earExercise.correct / gameState.earExercise.total) * 100)
                : 0;
            document.getElementById('earAccuracy').textContent = accuracy + '%';
        }

        // Note Reading Tab
        function initReadingTab() {
            newReadingChallenge();
        }

        function newReadingChallenge() {
            const clefSelect = document.getElementById('staffClef').value;
            const range = document.getElementById('noteRange').value;

            const clef = clefSelect === 'both'
                ? (Math.random() > 0.5 ? 'treble' : 'bass')
                : clefSelect;

            gameState.reading.clef = clef;

            // Define note positions (treble clef: middle C is 0)
            let notes = [];

            if (clef === 'treble') {
                // Treble clef notes: E4 (line) to F5 (space)
                if (range === 'lines') {
                    notes = [{name: 'E4', pos: 0}, {name: 'G4', pos: 1}, {name: 'B4', pos: 2}, {name: 'D5', pos: 3}, {name: 'F5', pos: 4}];
                } else if (range === 'spaces') {
                    notes = [{name: 'F4', pos: 0.5}, {name: 'A4', pos: 1.5}, {name: 'C5', pos: 2.5}, {name: 'E5', pos: 3.5}];
                } else if (range === 'all') {
                    notes = [
                        {name: 'E4', pos: 0}, {name: 'F4', pos: 0.5}, {name: 'G4', pos: 1}, {name: 'A4', pos: 1.5},
                        {name: 'B4', pos: 2}, {name: 'C5', pos: 2.5}, {name: 'D5', pos: 3}, {name: 'E5', pos: 3.5}, {name: 'F5', pos: 4}
                    ];
                } else {
                    notes = [
                        {name: 'C4', pos: -1}, {name: 'D4', pos: -0.5},
                        {name: 'E4', pos: 0}, {name: 'F4', pos: 0.5}, {name: 'G4', pos: 1}, {name: 'A4', pos: 1.5},
                        {name: 'B4', pos: 2}, {name: 'C5', pos: 2.5}, {name: 'D5', pos: 3}, {name: 'E5', pos: 3.5},
                        {name: 'F5', pos: 4}, {name: 'G5', pos: 4.5}, {name: 'A5', pos: 5}
                    ];
                }
            } else {
                // Bass clef notes
                if (range === 'lines') {
                    notes = [{name: 'G2', pos: 0}, {name: 'B2', pos: 1}, {name: 'D3', pos: 2}, {name: 'F3', pos: 3}, {name: 'A3', pos: 4}];
                } else if (range === 'spaces') {
                    notes = [{name: 'A2', pos: 0.5}, {name: 'C3', pos: 1.5}, {name: 'E3', pos: 2.5}, {name: 'G3', pos: 3.5}];
                } else if (range === 'all') {
                    notes = [
                        {name: 'G2', pos: 0}, {name: 'A2', pos: 0.5}, {name: 'B2', pos: 1}, {name: 'C3', pos: 1.5},
                        {name: 'D3', pos: 2}, {name: 'E3', pos: 2.5}, {name: 'F3', pos: 3}, {name: 'G3', pos: 3.5}, {name: 'A3', pos: 4}
                    ];
                } else {
                    notes = [
                        {name: 'E2', pos: -1}, {name: 'F2', pos: -0.5},
                        {name: 'G2', pos: 0}, {name: 'A2', pos: 0.5}, {name: 'B2', pos: 1}, {name: 'C3', pos: 1.5},
                        {name: 'D3', pos: 2}, {name: 'E3', pos: 2.5}, {name: 'F3', pos: 3}, {name: 'G3', pos: 3.5},
                        {name: 'A3', pos: 4}, {name: 'B3', pos: 4.5}, {name: 'C4', pos: 5}
                    ];
                }
            }

            const selectedNote = notes[Math.floor(Math.random() * notes.length)];
            gameState.reading.currentNote = selectedNote;

            drawStaff(clef, selectedNote);

            // Create answer buttons
            const noteNames = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            document.getElementById('readingOptions').innerHTML = noteNames.map(note =>
                `<button onclick="checkReadingAnswer('${note}')" class="bg-gray-700 hover:bg-indigo-600 px-6 py-3 rounded-xl font-semibold text-xl transition-all">${note}</button>`
            ).join('');
        }

        function drawStaff(clef, note) {
            const svg = document.getElementById('staffDisplay');
            svg.innerHTML = `
                <defs>
                    <linearGradient id="waveGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#6366f1"/>
                        <stop offset="100%" style="stop-color:#ec4899"/>
                    </linearGradient>
                </defs>
            `;

            const startY = 60;
            const lineSpacing = 20;

            // Draw staff lines
            for (let i = 0; i < 5; i++) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', '50');
                line.setAttribute('y1', startY + i * lineSpacing);
                line.setAttribute('x2', '350');
                line.setAttribute('y2', startY + i * lineSpacing);
                line.setAttribute('class', 'staff-line');
                svg.appendChild(line);
            }

            // Draw clef
            const clefText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            clefText.setAttribute('x', '60');
            clefText.setAttribute('y', clef === 'treble' ? '115' : '105');
            clefText.setAttribute('font-size', clef === 'treble' ? '80' : '60');
            clefText.setAttribute('fill', '#9ca3af');
            clefText.textContent = clef === 'treble' ? 'ùÑû' : 'ùÑ¢';
            svg.appendChild(clefText);

            // Calculate note position
            const noteY = startY + (4 - note.pos) * (lineSpacing / 2);

            // Draw ledger lines if needed
            if (note.pos < 0) {
                for (let i = -1; note.pos <= i; i--) {
                    const ledger = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    ledger.setAttribute('x1', '180');
                    ledger.setAttribute('y1', startY + (4 - i) * (lineSpacing / 2));
                    ledger.setAttribute('x2', '220');
                    ledger.setAttribute('y2', startY + (4 - i) * (lineSpacing / 2));
                    ledger.setAttribute('class', 'staff-line');
                    svg.appendChild(ledger);
                }
            } else if (note.pos > 4) {
                for (let i = 5; note.pos >= i; i++) {
                    const ledger = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    ledger.setAttribute('x1', '180');
                    ledger.setAttribute('y1', startY + (4 - i) * (lineSpacing / 2));
                    ledger.setAttribute('x2', '220');
                    ledger.setAttribute('y2', startY + (4 - i) * (lineSpacing / 2));
                    ledger.setAttribute('class', 'staff-line');
                    svg.appendChild(ledger);
                }
            }

            // Draw note
            const noteHead = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
            noteHead.setAttribute('cx', '200');
            noteHead.setAttribute('cy', noteY);
            noteHead.setAttribute('rx', '12');
            noteHead.setAttribute('ry', '9');
            noteHead.setAttribute('fill', 'url(#waveGradient)');
            noteHead.setAttribute('transform', `rotate(-20, 200, ${noteY})`);
            svg.appendChild(noteHead);

            // Draw stem
            const stem = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            stem.setAttribute('x1', note.pos < 2 ? '188' : '212');
            stem.setAttribute('y1', noteY);
            stem.setAttribute('x2', note.pos < 2 ? '188' : '212');
            stem.setAttribute('y2', note.pos < 2 ? noteY + 50 : noteY - 50);
            stem.setAttribute('stroke', '#f1f5f9');
            stem.setAttribute('stroke-width', '2');
            svg.appendChild(stem);
        }

        function checkReadingAnswer(answer) {
            const correctNoteName = gameState.reading.currentNote.name[0];

            if (answer === correctNoteName) {
                updateScore(10);
                gameState.streak++;
                createConfetti();

                // Flash correct
                document.querySelectorAll('#readingOptions button').forEach(btn => {
                    if (btn.textContent === answer) {
                        btn.classList.add('bg-green-500');
                    }
                });

                setTimeout(newReadingChallenge, 500);
            } else {
                gameState.streak = 0;

                // Highlight wrong and show correct
                document.querySelectorAll('#readingOptions button').forEach(btn => {
                    if (btn.textContent === answer) {
                        btn.classList.add('bg-red-500');
                    }
                    if (btn.textContent === correctNoteName) {
                        btn.classList.add('bg-green-500');
                    }
                });

                setTimeout(newReadingChallenge, 1500);
            }

            updateStats();
        }

        function playReadingNote() {
            if (gameState.reading.currentNote) {
                playNote(gameState.reading.currentNote.name);
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('bg-gray-700/50');
            });

            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('bg-gray-700/50');

            gameState.currentTab = tabName;

            // Initialize tab content
            if (tabName === 'notes') initNotesTab();
            else if (tabName === 'scales') initScalesTab();
            else if (tabName === 'chords') initChordsTab();
            else if (tabName === 'ear') initEarTab();
            else if (tabName === 'reading') initReadingTab();
        }

        // Update score and stats
        function updateScore(points) {
            gameState.score += points;
            gameState.questionsAnswered++;
            updateStats();
        }

        function updateStats() {
            document.getElementById('scoreDisplay').textContent = gameState.score;
            document.getElementById('streakCount').textContent = gameState.streak;

            // Level up every 100 points
            gameState.level = Math.floor(gameState.score / 100) + 1;
            document.getElementById('levelDisplay').textContent = gameState.level;

            // Update progress (resets every 10 questions)
            const progress = (gameState.questionsAnswered % 10) * 10;
            const progressCircle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 28;
            const offset = circumference - (progress / 100) * circumference;
            progressCircle.style.strokeDashoffset = offset;
            document.getElementById('progressPercent').textContent = progress + '%';
        }

        // Confetti effect
        function createConfetti() {
            const colors = ['#6366f1', '#ec4899', '#f59e0b', '#22c55e', '#3b82f6'];
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                document.body.appendChild(confetti);

                setTimeout(() => confetti.remove(), 3000);
            }
        }

        // Floating music notes background
        function createFloatingNotes() {
            const musicBg = document.getElementById('musicBg');
            const symbols = ['‚ô™', '‚ô´', '‚ô¨', '‚ô©', 'ùÑû', 'ùÑ¢'];

            for (let i = 0; i < 15; i++) {
                const note = document.createElement('div');
                note.className = 'note-float';
                note.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                note.style.left = Math.random() * 100 + '%';
                note.style.animationDelay = Math.random() * 15 + 's';
                note.style.fontSize = (Math.random() * 2 + 1) + 'rem';
                musicBg.appendChild(note);
            }
        }

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            initAudio();

            const keyMap = {
                'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4', 'd': 'E4',
                'f': 'F4', 't': 'F#4', 'g': 'G4', 'y': 'G#4', 'h': 'A4',
                'u': 'A#4', 'j': 'B4', 'k': 'C5', 'o': 'C#5', 'l': 'D5'
            };

            const note = keyMap[e.key.toLowerCase()];
            if (note) {
                playNote(note);

                // Find and activate the key visually
                const pianoId = gameState.currentTab === 'notes' ? 'piano' :
                               gameState.currentTab === 'scales' ? 'scalePiano' :
                               gameState.currentTab === 'chords' ? 'chordPiano' : null;

                if (pianoId) {
                    const key = document.querySelector(`#${pianoId} [data-note="${note}"]`);
                    if (key) {
                        key.classList.add('active');
                        setTimeout(() => key.classList.remove('active'), 200);

                        if (gameState.currentTab === 'notes') {
                            checkNoteAnswer(note, key);
                        }
                    }
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createFloatingNotes();
            initNotesTab();
        });

        // Also initialize on first click for audio context
        document.addEventListener('click', initAudio, { once: true });
    </script>
</body>
</html>
