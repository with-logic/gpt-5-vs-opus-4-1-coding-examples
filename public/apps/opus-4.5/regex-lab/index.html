<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regex Lab</title>
    <style>
        :root {
            --bg-primary: #1a1b26;
            --bg-secondary: #24283b;
            --bg-tertiary: #414868;
            --text-primary: #c0caf5;
            --text-secondary: #a9b1d6;
            --text-muted: #565f89;
            --accent: #7aa2f7;
            --accent-hover: #89b4fa;
            --success: #9ece6a;
            --warning: #e0af68;
            --error: #f7768e;
            --border: #3b4261;
            --match-1: #bb9af7;
            --match-2: #7dcfff;
            --match-3: #73daca;
            --match-4: #ff9e64;
            --match-5: #f7768e;
            --group-1: rgba(187, 154, 247, 0.3);
            --group-2: rgba(125, 207, 255, 0.3);
            --group-3: rgba(115, 218, 202, 0.3);
            --group-4: rgba(255, 158, 100, 0.3);
            --group-5: rgba(247, 118, 142, 0.3);
        }

        .light-mode {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8e8;
            --text-primary: #1a1b26;
            --text-secondary: #414868;
            --text-muted: #9aa5ce;
            --accent: #2e7de9;
            --accent-hover: #1a6dd8;
            --border: #d0d0d0;
            --group-1: rgba(150, 100, 220, 0.25);
            --group-2: rgba(40, 150, 200, 0.25);
            --group-3: rgba(50, 180, 160, 0.25);
            --group-4: rgba(220, 120, 50, 0.25);
            --group-5: rgba(220, 80, 100, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--match-1));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), var(--match-1));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .terminal-window {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .terminal-header {
            background: var(--bg-tertiary);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .terminal-dot.red { background: #ff5f56; }
        .terminal-dot.yellow { background: #ffbd2e; }
        .terminal-dot.green { background: #27c93f; }

        .terminal-title {
            margin-left: 10px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .terminal-body {
            padding: 20px;
        }

        .input-section {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pattern-row {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .pattern-input-wrapper {
            flex: 1;
            position: relative;
        }

        .pattern-input {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .pattern-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .pattern-input.error {
            border-color: var(--error);
        }

        .flags-container {
            display: flex;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .flag-btn {
            padding: 12px 14px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
            position: relative;
        }

        .flag-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .flag-btn.active {
            color: var(--accent);
            background: rgba(122, 162, 247, 0.1);
        }

        .flag-btn::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.7rem;
            font-weight: normal;
            white-space: nowrap;
            border-radius: 4px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .flag-btn:hover::after {
            opacity: 1;
        }

        .error-message {
            margin-top: 8px;
            padding: 10px 12px;
            background: rgba(247, 118, 142, 0.1);
            border: 1px solid var(--error);
            border-radius: 6px;
            color: var(--error);
            font-size: 0.85rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .error-caret {
            font-family: inherit;
            white-space: pre;
            color: var(--error);
        }

        .test-text {
            width: 100%;
            min-height: 120px;
            padding: 12px 15px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .test-text:focus {
            outline: none;
            border-color: var(--accent);
        }

        .quick-inserts {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 15px;
        }

        .quick-insert-btn {
            padding: 6px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .quick-insert-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
            color: var(--accent);
        }

        .output-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .output-grid {
                grid-template-columns: 1fr;
            }
        }

        .output-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .panel-header {
            background: var(--bg-tertiary);
            padding: 10px 15px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-count {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .panel-body {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .highlighted-text {
            font-size: 0.95rem;
            line-height: 1.8;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .match {
            padding: 2px 0;
            border-radius: 3px;
            position: relative;
        }

        .match-0 { background: var(--group-1); border-bottom: 2px solid var(--match-1); }
        .match-1 { background: var(--group-2); border-bottom: 2px solid var(--match-2); }
        .match-2 { background: var(--group-3); border-bottom: 2px solid var(--match-3); }
        .match-3 { background: var(--group-4); border-bottom: 2px solid var(--match-4); }
        .match-4 { background: var(--group-5); border-bottom: 2px solid var(--match-5); }

        .matches-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .matches-table th,
        .matches-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .matches-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
        }

        .matches-table tr:hover td {
            background: var(--bg-primary);
        }

        .match-index {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .match-value {
            font-family: inherit;
            color: var(--accent);
        }

        .group-tag {
            display: inline-block;
            padding: 2px 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            font-size: 0.75rem;
            margin-right: 4px;
        }

        .explanation-list {
            list-style: none;
        }

        .explanation-item {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .explanation-item:last-child {
            border-bottom: none;
        }

        .token {
            font-family: inherit;
            background: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 4px;
            color: var(--accent);
            font-weight: 600;
            min-width: 60px;
            text-align: center;
            flex-shrink: 0;
        }

        .token-desc {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .no-matches {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
        }

        .no-matches-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: var(--success);
            color: white;
            border-radius: 8px;
            font-size: 0.85rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 10px 15px;
            background: var(--bg-primary);
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.8rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-label {
            color: var(--text-muted);
        }

        .stat-value {
            color: var(--accent);
            font-weight: 600;
        }

        .group-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-color-0 { background: var(--match-1); }
        .legend-color-1 { background: var(--match-2); }
        .legend-color-2 { background: var(--match-3); }
        .legend-color-3 { background: var(--match-4); }
        .legend-color-4 { background: var(--match-5); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">.*</div>
                <h1>Regex Lab</h1>
            </div>
            <div class="header-actions">
                <button class="btn" id="clearBtn" title="Clear all inputs">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                    Clear
                </button>
                <button class="btn" id="shareBtn" title="Copy permalink to clipboard">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13"/>
                    </svg>
                    Share
                </button>
                <button class="btn" id="themeBtn" title="Toggle light/dark mode">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
                        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                    </svg>
                </button>
            </div>
        </header>

        <div class="terminal-window">
            <div class="terminal-header">
                <span class="terminal-dot red"></span>
                <span class="terminal-dot yellow"></span>
                <span class="terminal-dot green"></span>
                <span class="terminal-title">regex-lab ‚Äî pattern editor</span>
            </div>
            <div class="terminal-body">
                <div class="input-section">
                    <label class="input-label">Regular Expression</label>
                    <div class="pattern-row">
                        <div class="pattern-input-wrapper">
                            <input type="text" class="pattern-input" id="patternInput" placeholder="Enter your regex pattern..." spellcheck="false" autocomplete="off">
                        </div>
                        <div class="flags-container">
                            <button class="flag-btn active" data-flag="g" title="Global - Find all matches">g</button>
                            <button class="flag-btn" data-flag="i" title="Case Insensitive">i</button>
                            <button class="flag-btn" data-flag="m" title="Multiline - ^ and $ match line boundaries">m</button>
                            <button class="flag-btn" data-flag="s" title="Dotall - . matches newlines">s</button>
                            <button class="flag-btn" data-flag="u" title="Unicode - Enable unicode support">u</button>
                            <button class="flag-btn" data-flag="y" title="Sticky - Match from lastIndex only">y</button>
                        </div>
                    </div>
                    <div class="error-message" id="errorMessage"></div>
                </div>

                <div class="input-section">
                    <label class="input-label">Test String</label>
                    <textarea class="test-text" id="testText" placeholder="Enter text to test against your pattern...">The quick brown fox jumps over the lazy dog.
Email: john.doe@example.com, jane_smith@company.org
Phone: (555) 123-4567, 555-987-6543
Date: 2024-01-15, 03/22/2024
IP: 192.168.1.1, 10.0.0.255
URL: https://www.example.com/path?query=value</textarea>
                </div>

                <div class="quick-inserts">
                    <span class="input-label" style="width: 100%;">Quick Insert</span>
                    <button class="quick-insert-btn" data-insert="\d" title="Digit [0-9]">\d</button>
                    <button class="quick-insert-btn" data-insert="\D" title="Non-digit">\D</button>
                    <button class="quick-insert-btn" data-insert="\w" title="Word char [a-zA-Z0-9_]">\w</button>
                    <button class="quick-insert-btn" data-insert="\W" title="Non-word char">\W</button>
                    <button class="quick-insert-btn" data-insert="\s" title="Whitespace">\s</button>
                    <button class="quick-insert-btn" data-insert="\S" title="Non-whitespace">\S</button>
                    <button class="quick-insert-btn" data-insert="\b" title="Word boundary">\b</button>
                    <button class="quick-insert-btn" data-insert="." title="Any character">.</button>
                    <button class="quick-insert-btn" data-insert="^" title="Start of string/line">^</button>
                    <button class="quick-insert-btn" data-insert="$" title="End of string/line">$</button>
                    <button class="quick-insert-btn" data-insert="[A-Z]" title="Uppercase letter">[A-Z]</button>
                    <button class="quick-insert-btn" data-insert="[a-z]" title="Lowercase letter">[a-z]</button>
                    <button class="quick-insert-btn" data-insert="[0-9]" title="Digit">[0-9]</button>
                    <button class="quick-insert-btn" data-insert="+" title="One or more">+</button>
                    <button class="quick-insert-btn" data-insert="*" title="Zero or more">*</button>
                    <button class="quick-insert-btn" data-insert="?" title="Zero or one">?</button>
                    <button class="quick-insert-btn" data-insert="{n,m}" title="Between n and m">{n,m}</button>
                    <button class="quick-insert-btn" data-insert="()" title="Capture group">()</button>
                    <button class="quick-insert-btn" data-insert="(?:)" title="Non-capture group">(?:)</button>
                    <button class="quick-insert-btn" data-insert="(?=)" title="Positive lookahead">(?=)</button>
                    <button class="quick-insert-btn" data-insert="(?!)" title="Negative lookahead">(?!)</button>
                    <button class="quick-insert-btn" data-insert="(?<=)" title="Positive lookbehind">(?&lt;=)</button>
                    <button class="quick-insert-btn" data-insert="(?<!)" title="Negative lookbehind">(?&lt;!)</button>
                    <button class="quick-insert-btn" data-insert="|" title="Alternation (OR)">|</button>
                </div>
            </div>
        </div>

        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <span class="stat-label">Matches:</span>
                <span class="stat-value" id="matchCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Groups:</span>
                <span class="stat-value" id="groupCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Execution:</span>
                <span class="stat-value" id="execTime">0ms</span>
            </div>
        </div>

        <div class="output-grid">
            <div class="output-panel">
                <div class="panel-header">
                    <span>Highlighted Matches</span>
                    <span class="match-count" id="highlightCount">0</span>
                </div>
                <div class="panel-body">
                    <div class="highlighted-text" id="highlightedText">
                        <div class="no-matches">
                            <div class="no-matches-icon">üîç</div>
                            <div>Enter a pattern to see highlighted matches</div>
                        </div>
                    </div>
                    <div class="group-legend" id="groupLegend"></div>
                </div>
            </div>

            <div class="output-panel">
                <div class="panel-header">
                    <span>Match Details</span>
                </div>
                <div class="panel-body">
                    <table class="matches-table" id="matchesTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Match</th>
                                <th>Index</th>
                                <th>Groups</th>
                            </tr>
                        </thead>
                        <tbody id="matchesBody">
                        </tbody>
                    </table>
                    <div class="no-matches" id="noMatchesDetail">
                        <div class="no-matches-icon">üìã</div>
                        <div>No matches found</div>
                    </div>
                </div>
            </div>

            <div class="output-panel full-width">
                <div class="panel-header">
                    <span>Pattern Explanation</span>
                </div>
                <div class="panel-body">
                    <ul class="explanation-list" id="explanationList">
                        <div class="no-matches">
                            <div class="no-matches-icon">üìñ</div>
                            <div>Enter a pattern to see its explanation</div>
                        </div>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Link copied to clipboard!</div>

    <script>
        // Token explanations for regex patterns
        const tokenExplanations = {
            '.': 'Matches any single character (except newline by default)',
            '\\d': 'Matches any digit [0-9]',
            '\\D': 'Matches any non-digit character',
            '\\w': 'Matches any word character [a-zA-Z0-9_]',
            '\\W': 'Matches any non-word character',
            '\\s': 'Matches any whitespace character (space, tab, newline)',
            '\\S': 'Matches any non-whitespace character',
            '\\b': 'Matches a word boundary position',
            '\\B': 'Matches a non-word boundary position',
            '\\n': 'Matches a newline character',
            '\\r': 'Matches a carriage return',
            '\\t': 'Matches a tab character',
            '\\0': 'Matches a null character',
            '^': 'Matches the start of the string (or line in multiline mode)',
            '$': 'Matches the end of the string (or line in multiline mode)',
            '*': 'Matches the preceding element zero or more times (greedy)',
            '+': 'Matches the preceding element one or more times (greedy)',
            '?': 'Matches the preceding element zero or one time, or makes quantifier lazy',
            '*?': 'Matches zero or more times (lazy/non-greedy)',
            '+?': 'Matches one or more times (lazy/non-greedy)',
            '??': 'Matches zero or one time (lazy/non-greedy)',
            '|': 'Alternation - matches either the expression before or after',
            '\\': 'Escapes the next character (makes it literal)',
        };

        // DOM Elements
        const patternInput = document.getElementById('patternInput');
        const testText = document.getElementById('testText');
        const errorMessage = document.getElementById('errorMessage');
        const highlightedText = document.getElementById('highlightedText');
        const matchesBody = document.getElementById('matchesBody');
        const explanationList = document.getElementById('explanationList');
        const matchCount = document.getElementById('matchCount');
        const groupCount = document.getElementById('groupCount');
        const execTime = document.getElementById('execTime');
        const highlightCount = document.getElementById('highlightCount');
        const noMatchesDetail = document.getElementById('noMatchesDetail');
        const matchesTable = document.getElementById('matchesTable');
        const groupLegend = document.getElementById('groupLegend');
        const toast = document.getElementById('toast');
        const themeBtn = document.getElementById('themeBtn');
        const shareBtn = document.getElementById('shareBtn');
        const clearBtn = document.getElementById('clearBtn');

        // State
        let currentFlags = 'g';
        let isDarkMode = true;

        // Initialize from URL hash
        function loadFromHash() {
            const hash = window.location.hash.slice(1);
            if (hash) {
                try {
                    const decoded = decodeURIComponent(hash);
                    const data = JSON.parse(atob(decoded));
                    if (data.pattern) patternInput.value = data.pattern;
                    if (data.flags) {
                        currentFlags = data.flags;
                        updateFlagButtons();
                    }
                    if (data.text) testText.value = data.text;
                    if (data.theme === 'light') {
                        isDarkMode = false;
                        document.body.classList.add('light-mode');
                        updateThemeIcon();
                    }
                } catch (e) {
                    console.log('Could not parse URL hash');
                }
            }
        }

        // Update flag button states
        function updateFlagButtons() {
            document.querySelectorAll('.flag-btn').forEach(btn => {
                btn.classList.toggle('active', currentFlags.includes(btn.dataset.flag));
            });
        }

        // Flag button click handlers
        document.querySelectorAll('.flag-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const flag = btn.dataset.flag;
                if (currentFlags.includes(flag)) {
                    currentFlags = currentFlags.replace(flag, '');
                } else {
                    currentFlags += flag;
                }
                btn.classList.toggle('active');
                updateOutput();
            });
        });

        // Quick insert button handlers
        document.querySelectorAll('.quick-insert-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const insert = btn.dataset.insert;
                const start = patternInput.selectionStart;
                const end = patternInput.selectionEnd;
                const value = patternInput.value;
                patternInput.value = value.slice(0, start) + insert + value.slice(end);
                patternInput.focus();
                const newPos = start + insert.length;
                patternInput.setSelectionRange(newPos, newPos);
                updateOutput();
            });
        });

        // Theme toggle
        function updateThemeIcon() {
            const themeIcon = document.getElementById('themeIcon');
            if (isDarkMode) {
                themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
            } else {
                themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
            }
        }

        themeBtn.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('light-mode', !isDarkMode);
            updateThemeIcon();
        });

        // Share button
        shareBtn.addEventListener('click', () => {
            const data = {
                pattern: patternInput.value,
                flags: currentFlags,
                text: testText.value,
                theme: isDarkMode ? 'dark' : 'light'
            };
            const encoded = btoa(JSON.stringify(data));
            const url = window.location.origin + window.location.pathname + '#' + encodeURIComponent(encoded);
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard!');
            }).catch(() => {
                showToast('Failed to copy link');
            });
        });

        // Clear button
        clearBtn.addEventListener('click', () => {
            patternInput.value = '';
            testText.value = '';
            currentFlags = 'g';
            updateFlagButtons();
            updateOutput();
            window.location.hash = '';
        });

        // Toast notification
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Parse and explain regex pattern
        function explainPattern(pattern) {
            if (!pattern) return [];

            const explanations = [];
            let i = 0;

            while (i < pattern.length) {
                let token = '';
                let explanation = '';

                // Check for escape sequences
                if (pattern[i] === '\\' && i + 1 < pattern.length) {
                    token = pattern.slice(i, i + 2);

                    if (tokenExplanations[token]) {
                        explanation = tokenExplanations[token];
                    } else if (/^\\\d$/.test(token)) {
                        explanation = `Backreference to group ${token[1]}`;
                    } else if (token === '\\x' && i + 3 < pattern.length) {
                        token = pattern.slice(i, i + 4);
                        explanation = `Matches hex character ${token.slice(2)}`;
                        i += 2;
                    } else if (token === '\\u' && i + 5 < pattern.length) {
                        token = pattern.slice(i, i + 6);
                        explanation = `Matches unicode character U+${token.slice(2)}`;
                        i += 4;
                    } else {
                        explanation = `Literal character "${token[1]}"`;
                    }
                    i += 2;
                }
                // Character class
                else if (pattern[i] === '[') {
                    let end = i + 1;
                    if (pattern[end] === '^') end++;
                    if (pattern[end] === ']') end++;
                    while (end < pattern.length && pattern[end] !== ']') {
                        if (pattern[end] === '\\') end++;
                        end++;
                    }
                    token = pattern.slice(i, end + 1);
                    const negated = token[1] === '^';
                    explanation = negated
                        ? `Matches any character NOT in: ${token.slice(2, -1)}`
                        : `Matches any character in: ${token.slice(1, -1)}`;
                    i = end + 1;
                }
                // Grouping constructs
                else if (pattern[i] === '(') {
                    if (pattern.slice(i, i + 3) === '(?:') {
                        token = '(?:)';
                        explanation = 'Non-capturing group';
                        i += 3;
                    } else if (pattern.slice(i, i + 3) === '(?=') {
                        token = '(?=)';
                        explanation = 'Positive lookahead - asserts what follows matches';
                        i += 3;
                    } else if (pattern.slice(i, i + 3) === '(?!') {
                        token = '(?!)';
                        explanation = 'Negative lookahead - asserts what follows does not match';
                        i += 3;
                    } else if (pattern.slice(i, i + 4) === '(?<=') {
                        token = '(?<=)';
                        explanation = 'Positive lookbehind - asserts what precedes matches';
                        i += 4;
                    } else if (pattern.slice(i, i + 4) === '(?<!') {
                        token = '(?<!)';
                        explanation = 'Negative lookbehind - asserts what precedes does not match';
                        i += 4;
                    } else if (pattern.slice(i, i + 3).match(/\(\?<[a-zA-Z]/)) {
                        const nameEnd = pattern.indexOf('>', i + 3);
                        if (nameEnd > -1) {
                            const name = pattern.slice(i + 3, nameEnd);
                            token = `(?<${name}>)`;
                            explanation = `Named capturing group "${name}"`;
                            i = nameEnd + 1;
                        } else {
                            token = '(';
                            explanation = 'Start of capturing group';
                            i++;
                        }
                    } else {
                        token = '()';
                        explanation = 'Capturing group - captures matched text for later use';
                        i++;
                    }
                }
                // Quantifiers
                else if (pattern[i] === '{') {
                    let end = pattern.indexOf('}', i);
                    if (end > -1) {
                        token = pattern.slice(i, end + 1);
                        const inner = token.slice(1, -1);
                        if (inner.includes(',')) {
                            const [min, max] = inner.split(',');
                            if (max === '') {
                                explanation = `Matches ${min} or more times`;
                            } else {
                                explanation = `Matches between ${min} and ${max} times`;
                            }
                        } else {
                            explanation = `Matches exactly ${inner} times`;
                        }
                        i = end + 1;
                    } else {
                        token = '{';
                        explanation = 'Literal "{"';
                        i++;
                    }
                }
                // Simple tokens
                else if (tokenExplanations[pattern[i]]) {
                    token = pattern[i];
                    explanation = tokenExplanations[token];
                    i++;
                }
                // Lazy quantifiers
                else if (pattern[i] === '?' && i > 0 && /[*+?}]/.test(pattern[i-1])) {
                    // Already handled with previous quantifier
                    i++;
                    continue;
                }
                // Closing paren
                else if (pattern[i] === ')') {
                    token = ')';
                    explanation = 'End of group';
                    i++;
                }
                // Literal characters
                else {
                    token = pattern[i];
                    explanation = `Literal character "${token}"`;
                    i++;
                }

                // Check for lazy modifier
                if (i < pattern.length && pattern[i] === '?' && /[*+?}]/.test(token[token.length - 1])) {
                    token += '?';
                    explanation = explanation.replace('(greedy)', '(lazy/non-greedy)');
                    if (!explanation.includes('lazy')) {
                        explanation += ' (lazy/non-greedy)';
                    }
                    i++;
                }

                if (token && explanation) {
                    explanations.push({ token, explanation });
                }
            }

            return explanations;
        }

        // Main update function
        function updateOutput() {
            const pattern = patternInput.value;
            const text = testText.value;

            // Clear error state
            errorMessage.classList.remove('show');
            patternInput.classList.remove('error');

            if (!pattern) {
                highlightedText.innerHTML = `<div class="no-matches"><div class="no-matches-icon">üîç</div><div>Enter a pattern to see highlighted matches</div></div>`;
                matchesBody.innerHTML = '';
                explanationList.innerHTML = `<div class="no-matches"><div class="no-matches-icon">üìñ</div><div>Enter a pattern to see its explanation</div></div>`;
                matchCount.textContent = '0';
                groupCount.textContent = '0';
                execTime.textContent = '0ms';
                highlightCount.textContent = '0';
                noMatchesDetail.style.display = 'block';
                matchesTable.style.display = 'none';
                groupLegend.innerHTML = '';
                return;
            }

            // Try to create regex
            let regex;
            try {
                regex = new RegExp(pattern, currentFlags);
            } catch (e) {
                patternInput.classList.add('error');
                errorMessage.classList.add('show');

                // Parse error message for position
                const message = e.message;
                let errorHtml = escapeHtml(message);

                // Try to extract position from error
                const posMatch = message.match(/position (\d+)/);
                if (posMatch) {
                    const pos = parseInt(posMatch[1]);
                    const caret = ' '.repeat(pos) + '^';
                    errorHtml = `${escapeHtml(message)}<br><span class="error-caret">/${pattern}/\n${caret}</span>`;
                }

                errorMessage.innerHTML = errorHtml;
                highlightedText.innerHTML = escapeHtml(text) || `<div class="no-matches"><div class="no-matches-icon">‚ö†Ô∏è</div><div>Invalid pattern</div></div>`;
                matchesBody.innerHTML = '';
                noMatchesDetail.style.display = 'block';
                matchesTable.style.display = 'none';
                groupLegend.innerHTML = '';

                // Still show explanation for valid parts
                const explanations = explainPattern(pattern);
                renderExplanations(explanations);

                return;
            }

            // Execute regex and measure time
            const startTime = performance.now();
            const matches = [];
            let match;

            if (currentFlags.includes('g')) {
                while ((match = regex.exec(text)) !== null) {
                    matches.push({
                        value: match[0],
                        index: match.index,
                        groups: match.slice(1),
                        namedGroups: match.groups || {}
                    });
                    if (match[0].length === 0) regex.lastIndex++;
                    if (matches.length > 1000) break; // Safety limit
                }
            } else {
                match = regex.exec(text);
                if (match) {
                    matches.push({
                        value: match[0],
                        index: match.index,
                        groups: match.slice(1),
                        namedGroups: match.groups || {}
                    });
                }
            }

            const endTime = performance.now();

            // Update stats
            matchCount.textContent = matches.length;
            highlightCount.textContent = matches.length;
            execTime.textContent = `${(endTime - startTime).toFixed(2)}ms`;

            // Count capture groups
            const groupCountNum = (pattern.match(/\((?!\?[=!:])/g) || []).length;
            groupCount.textContent = groupCountNum;

            // Render highlighted text
            if (matches.length > 0) {
                let highlighted = '';
                let lastIndex = 0;

                matches.forEach((m, idx) => {
                    highlighted += escapeHtml(text.slice(lastIndex, m.index));
                    highlighted += `<span class="match match-${idx % 5}" title="Match ${idx + 1}: ${escapeHtml(m.value)}">${escapeHtml(m.value)}</span>`;
                    lastIndex = m.index + m.value.length;
                });

                highlighted += escapeHtml(text.slice(lastIndex));
                highlightedText.innerHTML = highlighted || '(empty string)';

                // Update legend
                if (matches.length > 1) {
                    const legendHtml = Array.from({length: Math.min(matches.length, 5)}, (_, i) =>
                        `<span class="legend-item"><span class="legend-color legend-color-${i}"></span>Match ${i + 1}${i === 4 && matches.length > 5 ? '+' : ''}</span>`
                    ).join('');
                    groupLegend.innerHTML = legendHtml;
                } else {
                    groupLegend.innerHTML = '';
                }
            } else {
                highlightedText.innerHTML = escapeHtml(text) || `<div class="no-matches"><div class="no-matches-icon">üîç</div><div>No matches found</div></div>`;
                groupLegend.innerHTML = '';
            }

            // Render matches table
            if (matches.length > 0) {
                noMatchesDetail.style.display = 'none';
                matchesTable.style.display = 'table';

                matchesBody.innerHTML = matches.slice(0, 100).map((m, idx) => {
                    const groupsHtml = m.groups.length > 0
                        ? m.groups.map((g, i) => `<span class="group-tag">$${i + 1}: ${escapeHtml(g || '(empty)')}</span>`).join('')
                        : '<span class="group-tag">No groups</span>';

                    return `
                        <tr>
                            <td class="match-index">${idx + 1}</td>
                            <td class="match-value">${escapeHtml(m.value) || '(empty)'}</td>
                            <td class="match-index">${m.index}-${m.index + m.value.length}</td>
                            <td>${groupsHtml}</td>
                        </tr>
                    `;
                }).join('');

                if (matches.length > 100) {
                    matchesBody.innerHTML += `<tr><td colspan="4" style="text-align:center;color:var(--text-muted)">... and ${matches.length - 100} more matches</td></tr>`;
                }
            } else {
                noMatchesDetail.style.display = 'block';
                matchesTable.style.display = 'none';
                matchesBody.innerHTML = '';
            }

            // Render explanations
            const explanations = explainPattern(pattern);
            renderExplanations(explanations);
        }

        function renderExplanations(explanations) {
            if (explanations.length > 0) {
                explanationList.innerHTML = explanations.map(e => `
                    <li class="explanation-item">
                        <span class="token">${escapeHtml(e.token)}</span>
                        <span class="token-desc">${escapeHtml(e.explanation)}</span>
                    </li>
                `).join('');
            } else {
                explanationList.innerHTML = `<div class="no-matches"><div class="no-matches-icon">üìñ</div><div>Enter a pattern to see its explanation</div></div>`;
            }
        }

        // Event listeners for live updates
        patternInput.addEventListener('input', updateOutput);
        testText.addEventListener('input', updateOutput);

        // Initialize
        loadFromHash();
        updateOutput();

        // Handle hash changes
        window.addEventListener('hashchange', loadFromHash);
    </script>
</body>
</html>
