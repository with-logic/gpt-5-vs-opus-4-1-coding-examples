<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tic Tac Toe - Roman Empire Edition</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Spectral:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --gold: #d4af37;
      --gold-light: #f4d160;
      --gold-dark: #b8962e;
      --marble-light: #f5f5f0;
      --marble-mid: #e8e4dc;
      --marble-dark: #d4cfc4;
      --text-dark: #2c2416;
      --text-light: #f5f5f0;
      --shadow: rgba(44, 36, 22, 0.3);
      --bg-primary: linear-gradient(135deg, #f5f5f0 0%, #e8e4dc 50%, #d4cfc4 100%);
      --bg-secondary: #ffffff;
      --cell-bg: rgba(255, 255, 255, 0.7);
      --cell-hover: rgba(212, 175, 55, 0.15);
      --border-color: var(--gold);
      --text-color: var(--text-dark);
      --glyph-x: #8b0000;
      --glyph-o: #1a4d2e;
    }

    [data-theme="night"] {
      --marble-light: #1a1a2e;
      --marble-mid: #16213e;
      --marble-dark: #0f0f1a;
      --text-dark: #f5f5f0;
      --text-light: #f5f5f0;
      --shadow: rgba(0, 0, 0, 0.5);
      --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f1a 100%);
      --bg-secondary: #252540;
      --cell-bg: rgba(37, 37, 64, 0.8);
      --cell-hover: rgba(212, 175, 55, 0.2);
      --text-color: var(--text-light);
      --glyph-x: #ff6b6b;
      --glyph-o: #4ecdc4;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Spectral', Georgia, serif;
      background: var(--bg-primary);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      min-height: 100dvh;
      transition: background 0.4s ease, color 0.4s ease;
    }

    /* Marble texture overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: 0;
    }

    .app-container {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
      max-width: 100vw;
      overflow: hidden;
    }

    /* Header */
    header {
      flex-shrink: 0;
      background: var(--bg-secondary);
      border-bottom: 3px solid var(--gold);
      box-shadow: 0 4px 20px var(--shadow);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      position: relative;
      z-index: 10;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .spqr-crest {
      width: clamp(32px, 8vmin, 48px);
      height: clamp(32px, 8vmin, 48px);
      fill: var(--gold);
      filter: drop-shadow(0 2px 4px var(--shadow));
    }

    .title {
      font-family: 'Cinzel', serif;
      font-size: clamp(1rem, 3vmin, 1.5rem);
      font-weight: 700;
      color: var(--gold);
      text-shadow: 1px 1px 2px var(--shadow);
      letter-spacing: 0.05em;
    }

    .header-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      font-family: 'Cinzel', serif;
      font-size: clamp(0.65rem, 2vmin, 0.85rem);
      font-weight: 600;
      padding: 0.5rem 0.75rem;
      border: 2px solid var(--gold);
      border-radius: 8px;
      background: linear-gradient(180deg, var(--gold-light) 0%, var(--gold) 100%);
      color: var(--text-dark);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px var(--shadow);
      white-space: nowrap;
    }

    .btn:hover, .btn:focus {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
      background: linear-gradient(180deg, var(--gold) 0%, var(--gold-dark) 100%);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px var(--shadow);
    }

    .btn:focus-visible {
      outline: 3px solid var(--gold-light);
      outline-offset: 2px;
    }

    /* Victory Banner */
    .victory-banner {
      flex-shrink: 0;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
      padding: 0.75rem 1rem;
      text-align: center;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.4s ease;
    }

    .victory-banner.show {
      opacity: 1;
      max-height: 60px;
    }

    .victory-banner p {
      font-family: 'Cinzel', serif;
      font-size: clamp(1rem, 3vmin, 1.4rem);
      font-weight: 700;
      color: var(--text-dark);
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
      margin: 0;
    }

    /* Main Content */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      gap: 1rem;
      min-height: 0;
      overflow: hidden;
    }

    /* Status */
    .status {
      font-family: 'Cinzel', serif;
      font-size: clamp(1rem, 3.5vmin, 1.5rem);
      font-weight: 600;
      color: var(--gold);
      text-align: center;
      min-height: 2em;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Game Board */
    .board-container {
      position: relative;
      width: min(80vmin, 400px);
      height: min(80vmin, 400px);
      flex-shrink: 0;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: clamp(6px, 1.5vmin, 12px);
      width: 100%;
      height: 100%;
      padding: clamp(8px, 2vmin, 16px);
      background: linear-gradient(145deg, var(--gold-dark), var(--gold));
      border-radius: 16px;
      box-shadow:
        0 8px 32px var(--shadow),
        inset 0 2px 4px rgba(255, 255, 255, 0.3);
    }

    .cell {
      background: var(--cell-bg);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(2rem, 12vmin, 5rem);
      transition: all 0.2s ease;
      box-shadow:
        inset 0 2px 4px rgba(255, 255, 255, 0.5),
        0 2px 8px var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .cell:hover:not(.taken):not(.game-over) {
      background: var(--cell-hover);
      transform: scale(1.02);
    }

    .cell:focus-visible {
      outline: 3px solid var(--gold-light);
      outline-offset: 2px;
    }

    .cell.taken {
      cursor: default;
    }

    .cell.winning {
      animation: winPulse 0.6s ease-in-out infinite alternate;
      box-shadow:
        0 0 20px var(--gold),
        0 0 40px var(--gold-light),
        inset 0 2px 4px rgba(255, 255, 255, 0.5);
    }

    @keyframes winPulse {
      from { background: rgba(212, 175, 55, 0.3); }
      to { background: rgba(212, 175, 55, 0.5); }
    }

    .cell .glyph {
      display: flex;
      align-items: center;
      justify-content: center;
      animation: glyphAppear 0.3s ease-out;
    }

    @keyframes glyphAppear {
      from {
        transform: scale(0) rotate(-180deg);
        opacity: 0;
      }
      to {
        transform: scale(1) rotate(0);
        opacity: 1;
      }
    }

    .glyph-x {
      color: var(--glyph-x);
      font-weight: 700;
    }

    .glyph-o {
      color: var(--glyph-o);
      font-weight: 700;
    }

    .glyph svg {
      width: clamp(1.5rem, 10vmin, 4rem);
      height: clamp(1.5rem, 10vmin, 4rem);
    }

    /* Scoreboard */
    .scoreboard {
      display: flex;
      gap: clamp(1rem, 4vmin, 2rem);
      justify-content: center;
      flex-wrap: wrap;
    }

    .score-item {
      text-align: center;
      padding: 0.5rem 1rem;
      background: var(--cell-bg);
      border-radius: 12px;
      border: 2px solid var(--gold);
      box-shadow: 0 2px 8px var(--shadow);
      min-width: 70px;
    }

    .score-label {
      font-family: 'Cinzel', serif;
      font-size: clamp(0.75rem, 2vmin, 1rem);
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 0.25rem;
    }

    .score-value {
      font-family: 'Cinzel', serif;
      font-size: clamp(1.25rem, 4vmin, 2rem);
      font-weight: 700;
      color: var(--text-color);
    }

    /* Dialog */
    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      padding: 1rem;
    }

    .dialog-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .dialog {
      background: var(--bg-secondary);
      border: 3px solid var(--gold);
      border-radius: 16px;
      padding: 1.5rem;
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.3s ease;
      box-shadow: 0 8px 32px var(--shadow);
    }

    .dialog-overlay.open .dialog {
      transform: scale(1);
    }

    .dialog h2 {
      font-family: 'Cinzel', serif;
      font-size: clamp(1.25rem, 4vmin, 1.75rem);
      color: var(--gold);
      text-align: center;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--gold);
      padding-bottom: 0.75rem;
    }

    .option-group {
      margin-bottom: 1.25rem;
    }

    .option-group label {
      display: block;
      font-family: 'Cinzel', serif;
      font-size: clamp(0.85rem, 2.5vmin, 1rem);
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.5rem;
    }

    .option-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .option-btn {
      flex: 1;
      min-width: 80px;
      padding: 0.5rem 0.75rem;
      font-family: 'Spectral', serif;
      font-size: clamp(0.75rem, 2vmin, 0.9rem);
      border: 2px solid var(--gold);
      border-radius: 8px;
      background: transparent;
      color: var(--text-color);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .option-btn:hover {
      background: var(--cell-hover);
    }

    .option-btn.selected {
      background: linear-gradient(180deg, var(--gold-light) 0%, var(--gold) 100%);
      color: var(--text-dark);
    }

    .option-btn:focus-visible {
      outline: 3px solid var(--gold-light);
      outline-offset: 2px;
    }

    .dialog-close {
      display: block;
      width: 100%;
      margin-top: 1.5rem;
    }

    /* Canvas for confetti */
    #confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 50;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Mobile adjustments */
    @media (max-width: 480px) {
      header {
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
      }

      .logo {
        width: 100%;
        justify-content: center;
      }

      .header-buttons {
        width: 100%;
        justify-content: center;
      }

      .board-container {
        width: min(85vmin, 350px);
        height: min(85vmin, 350px);
      }
    }

    /* Landscape mobile */
    @media (max-height: 500px) and (orientation: landscape) {
      main {
        flex-direction: row;
        gap: 2rem;
      }

      .board-container {
        width: min(60vmin, 300px);
        height: min(60vmin, 300px);
      }

      .game-info {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
    }

    /* Visually hidden for screen readers */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="logo">
        <svg class="spqr-crest" viewBox="0 0 100 100" aria-hidden="true">
          <defs>
            <linearGradient id="goldGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#f4d160"/>
              <stop offset="100%" stop-color="#b8962e"/>
            </linearGradient>
          </defs>
          <!-- Shield shape -->
          <path d="M50 5 L90 20 L90 50 Q90 85 50 95 Q10 85 10 50 L10 20 Z" fill="url(#goldGrad)" stroke="#8b7355" stroke-width="2"/>
          <!-- Eagle wings -->
          <path d="M50 25 L35 40 L25 35 L35 50 L20 55 L40 60 L50 50 L60 60 L80 55 L65 50 L75 35 L65 40 Z" fill="#2c2416"/>
          <!-- Eagle body -->
          <ellipse cx="50" cy="55" rx="8" ry="12" fill="#2c2416"/>
          <!-- Eagle head -->
          <circle cx="50" cy="40" r="6" fill="#2c2416"/>
          <path d="M50 38 L56 40 L50 42 Z" fill="#d4af37"/>
          <!-- SPQR text -->
          <text x="50" y="82" text-anchor="middle" font-family="Cinzel, serif" font-size="10" font-weight="700" fill="#2c2416">SPQR</text>
        </svg>
        <h1 class="title">ROMAN TIC TAC TOE</h1>
      </div>
      <div class="header-buttons">
        <button class="btn" id="new-round-btn" aria-label="Start new round">New Round</button>
        <button class="btn" id="customize-btn" aria-label="Open customization options">Customize</button>
        <button class="btn" id="reset-scores-btn" aria-label="Reset all scores">Reset Scores</button>
      </div>
    </header>

    <div class="victory-banner" id="victory-banner" role="alert" aria-live="polite">
      <p id="victory-text"></p>
    </div>

    <main>
      <div class="game-info">
        <div class="status" id="status" aria-live="polite" aria-atomic="true">
          Player X's Turn
        </div>
        <div class="scoreboard">
          <div class="score-item">
            <div class="score-label">X Wins</div>
            <div class="score-value" id="score-x">0</div>
          </div>
          <div class="score-item">
            <div class="score-label">Draws</div>
            <div class="score-value" id="score-draw">0</div>
          </div>
          <div class="score-item">
            <div class="score-label">O Wins</div>
            <div class="score-value" id="score-o">0</div>
          </div>
        </div>
      </div>

      <div class="board-container">
        <div class="board" role="grid" aria-label="Tic Tac Toe game board" id="board">
          <!-- Cells will be generated by JS -->
        </div>
      </div>
    </main>

    <canvas id="confetti-canvas" aria-hidden="true"></canvas>

    <!-- Customize Dialog -->
    <div class="dialog-overlay" id="dialog-overlay" role="dialog" aria-modal="true" aria-labelledby="dialog-title">
      <div class="dialog">
        <h2 id="dialog-title">Customize Game</h2>

        <div class="option-group">
          <label>Theme</label>
          <div class="option-buttons" role="radiogroup" aria-label="Theme selection">
            <button class="option-btn selected" data-option="theme" data-value="day" role="radio" aria-checked="true">Marble Day</button>
            <button class="option-btn" data-option="theme" data-value="night" role="radio" aria-checked="false">Night Legion</button>
          </div>
        </div>

        <div class="option-group">
          <label>Glyphs</label>
          <div class="option-buttons" role="radiogroup" aria-label="Glyph style selection">
            <button class="option-btn selected" data-option="glyphs" data-value="standard" role="radio" aria-checked="true">Standard X/O</button>
            <button class="option-btn" data-option="glyphs" data-value="roman" role="radio" aria-checked="false">Gladius/Laurel</button>
          </div>
        </div>

        <div class="option-group">
          <label>Game Mode</label>
          <div class="option-buttons" role="radiogroup" aria-label="Game mode selection">
            <button class="option-btn selected" data-option="mode" data-value="2player" role="radio" aria-checked="true">2 Player</button>
            <button class="option-btn" data-option="mode" data-value="ai" role="radio" aria-checked="false">vs AI</button>
          </div>
        </div>

        <div class="option-group">
          <label>First Move</label>
          <div class="option-buttons" role="radiogroup" aria-label="First move selection">
            <button class="option-btn selected" data-option="first" data-value="X" role="radio" aria-checked="true">X Goes First</button>
            <button class="option-btn" data-option="first" data-value="O" role="radio" aria-checked="false">O Goes First</button>
          </div>
        </div>

        <div class="option-group" id="ai-difficulty-group">
          <label>AI Discipline</label>
          <div class="option-buttons" role="radiogroup" aria-label="AI difficulty selection">
            <button class="option-btn" data-option="difficulty" data-value="perfect" role="radio" aria-checked="false">Perfect</button>
            <button class="option-btn selected" data-option="difficulty" data-value="pragmatic" role="radio" aria-checked="true">Pragmatic</button>
            <button class="option-btn" data-option="difficulty" data-value="reckless" role="radio" aria-checked="false">Reckless</button>
          </div>
        </div>

        <button class="btn dialog-close" id="dialog-close">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Game State
    const state = {
      board: Array(9).fill(null),
      currentPlayer: 'X',
      gameOver: false,
      winningCells: [],
      scores: { X: 0, O: 0, draw: 0 },
      settings: {
        theme: 'day',
        glyphs: 'standard',
        mode: '2player',
        first: 'X',
        difficulty: 'pragmatic'
      }
    };

    // DOM Elements
    const boardEl = document.getElementById('board');
    const statusEl = document.getElementById('status');
    const victoryBanner = document.getElementById('victory-banner');
    const victoryText = document.getElementById('victory-text');
    const scoreX = document.getElementById('score-x');
    const scoreO = document.getElementById('score-o');
    const scoreDraw = document.getElementById('score-draw');
    const dialogOverlay = document.getElementById('dialog-overlay');
    const confettiCanvas = document.getElementById('confetti-canvas');
    const ctx = confettiCanvas.getContext('2d');

    // Win patterns
    const WIN_PATTERNS = [
      [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
      [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
      [0, 4, 8], [2, 4, 6]              // Diagonals
    ];

    // Glyph SVGs
    const GLYPHS = {
      standard: {
        X: '<span class="glyph glyph-x">X</span>',
        O: '<span class="glyph glyph-o">O</span>'
      },
      roman: {
        X: `<span class="glyph glyph-x"><svg viewBox="0 0 100 100"><path d="M50 10 L55 40 L85 25 L60 50 L85 75 L55 60 L50 90 L45 60 L15 75 L40 50 L15 25 L45 40 Z" fill="currentColor"/></svg></span>`,
        O: `<span class="glyph glyph-o"><svg viewBox="0 0 100 100"><path d="M50 15 Q65 15 72 25 Q80 35 75 50 Q85 45 90 50 Q85 55 75 50 Q80 65 72 75 Q65 85 50 85 Q35 85 28 75 Q20 65 25 50 Q15 55 10 50 Q15 45 25 50 Q20 35 28 25 Q35 15 50 15 Z M50 30 Q40 30 35 40 Q30 50 35 60 Q40 70 50 70 Q60 70 65 60 Q70 50 65 40 Q60 30 50 30 Z" fill="currentColor"/></svg></span>`
      }
    };

    // Initialize
    function init() {
      loadSettings();
      createBoard();
      updateScoreDisplay();
      applyTheme();
      setupEventListeners();
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
    }

    function loadSettings() {
      const saved = localStorage.getItem('romanTTTSettings');
      if (saved) {
        try {
          Object.assign(state.settings, JSON.parse(saved));
        } catch (e) {}
      }
      const savedScores = localStorage.getItem('romanTTTScores');
      if (savedScores) {
        try {
          Object.assign(state.scores, JSON.parse(savedScores));
        } catch (e) {}
      }
      updateDialogButtons();
    }

    function saveSettings() {
      localStorage.setItem('romanTTTSettings', JSON.stringify(state.settings));
    }

    function saveScores() {
      localStorage.setItem('romanTTTScores', JSON.stringify(state.scores));
    }

    function createBoard() {
      boardEl.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement('button');
        cell.className = 'cell';
        cell.dataset.index = i;
        cell.setAttribute('role', 'gridcell');
        cell.setAttribute('aria-label', `Cell ${Math.floor(i/3) + 1}, ${(i%3) + 1}, empty`);
        cell.tabIndex = 0;
        boardEl.appendChild(cell);
      }
    }

    function setupEventListeners() {
      // Board clicks
      boardEl.addEventListener('click', handleCellClick);
      boardEl.addEventListener('keydown', handleKeydown);

      // Header buttons
      document.getElementById('new-round-btn').addEventListener('click', newRound);
      document.getElementById('customize-btn').addEventListener('click', openDialog);
      document.getElementById('reset-scores-btn').addEventListener('click', resetScores);

      // Dialog
      document.getElementById('dialog-close').addEventListener('click', closeDialog);
      dialogOverlay.addEventListener('click', (e) => {
        if (e.target === dialogOverlay) closeDialog();
      });

      // Option buttons
      document.querySelectorAll('.option-btn').forEach(btn => {
        btn.addEventListener('click', handleOptionClick);
      });

      // Escape key closes dialog
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && dialogOverlay.classList.contains('open')) {
          closeDialog();
        }
      });
    }

    function handleCellClick(e) {
      const cell = e.target.closest('.cell');
      if (!cell || state.gameOver || cell.classList.contains('taken')) return;

      const index = parseInt(cell.dataset.index);
      makeMove(index);
    }

    function handleKeydown(e) {
      const cell = e.target.closest('.cell');
      if (!cell) return;

      const index = parseInt(cell.dataset.index);
      const cells = Array.from(boardEl.querySelectorAll('.cell'));

      let newIndex = index;
      switch (e.key) {
        case 'ArrowUp': newIndex = index - 3; break;
        case 'ArrowDown': newIndex = index + 3; break;
        case 'ArrowLeft': newIndex = index - 1; break;
        case 'ArrowRight': newIndex = index + 1; break;
        case 'Enter':
        case ' ':
          e.preventDefault();
          if (!state.gameOver && !cell.classList.contains('taken')) {
            makeMove(index);
          }
          return;
        default: return;
      }

      if (newIndex >= 0 && newIndex < 9) {
        e.preventDefault();
        cells[newIndex].focus();
      }
    }

    function makeMove(index) {
      if (state.board[index] !== null || state.gameOver) return;

      state.board[index] = state.currentPlayer;
      updateCell(index);

      const winner = checkWinner();
      if (winner) {
        endGame(winner);
        return;
      }

      if (state.board.every(cell => cell !== null)) {
        endGame('draw');
        return;
      }

      state.currentPlayer = state.currentPlayer === 'X' ? 'O' : 'X';
      updateStatus();

      // AI move
      if (state.settings.mode === 'ai' && state.currentPlayer === 'O' && !state.gameOver) {
        setTimeout(makeAIMove, 400);
      }
    }

    function updateCell(index) {
      const cells = boardEl.querySelectorAll('.cell');
      const cell = cells[index];
      const player = state.board[index];

      cell.innerHTML = GLYPHS[state.settings.glyphs][player];
      cell.classList.add('taken');
      cell.setAttribute('aria-label', `Cell ${Math.floor(index/3) + 1}, ${(index%3) + 1}, ${player}`);
    }

    function checkWinner() {
      for (const pattern of WIN_PATTERNS) {
        const [a, b, c] = pattern;
        if (state.board[a] && state.board[a] === state.board[b] && state.board[a] === state.board[c]) {
          state.winningCells = pattern;
          return state.board[a];
        }
      }
      return null;
    }

    function endGame(result) {
      state.gameOver = true;

      const cells = boardEl.querySelectorAll('.cell');
      cells.forEach(cell => cell.classList.add('game-over'));

      if (result === 'draw') {
        state.scores.draw++;
        victoryText.textContent = 'A Stalemate! The Battle Continues...';
        statusEl.textContent = "It's a Draw!";
      } else {
        state.scores[result]++;
        state.winningCells.forEach(i => cells[i].classList.add('winning'));

        const winnerName = state.settings.mode === 'ai' && result === 'O' ? 'The Legion' : `Player ${result}`;
        victoryText.textContent = `${winnerName} Claims Victory!`;
        statusEl.textContent = `${winnerName} Wins!`;

        // Confetti
        if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          launchConfetti();
        }
      }

      victoryBanner.classList.add('show');
      saveScores();
      updateScoreDisplay();
    }

    function updateStatus() {
      const playerName = state.settings.mode === 'ai' && state.currentPlayer === 'O' ? 'Legion' : `Player ${state.currentPlayer}`;
      statusEl.textContent = `${playerName}'s Turn`;
    }

    function updateScoreDisplay() {
      scoreX.textContent = state.scores.X;
      scoreO.textContent = state.scores.O;
      scoreDraw.textContent = state.scores.draw;
    }

    function newRound() {
      state.board = Array(9).fill(null);
      state.currentPlayer = state.settings.first;
      state.gameOver = false;
      state.winningCells = [];

      victoryBanner.classList.remove('show');

      const cells = boardEl.querySelectorAll('.cell');
      cells.forEach((cell, i) => {
        cell.innerHTML = '';
        cell.classList.remove('taken', 'winning', 'game-over');
        cell.setAttribute('aria-label', `Cell ${Math.floor(i/3) + 1}, ${(i%3) + 1}, empty`);
      });

      updateStatus();

      // AI moves first if O starts and vs AI mode
      if (state.settings.mode === 'ai' && state.currentPlayer === 'O') {
        setTimeout(makeAIMove, 400);
      }
    }

    function resetScores() {
      state.scores = { X: 0, O: 0, draw: 0 };
      saveScores();
      updateScoreDisplay();
      newRound();
    }

    // AI Logic
    function makeAIMove() {
      if (state.gameOver) return;

      let move;
      const difficulty = state.settings.difficulty;

      if (difficulty === 'reckless' && Math.random() < 0.6) {
        move = getRandomMove();
      } else if (difficulty === 'pragmatic' && Math.random() < 0.25) {
        move = getRandomMove();
      } else {
        move = getBestMove();
      }

      if (move !== null) {
        makeMove(move);
      }
    }

    function getRandomMove() {
      const available = state.board.map((cell, i) => cell === null ? i : null).filter(i => i !== null);
      return available[Math.floor(Math.random() * available.length)];
    }

    function getBestMove() {
      let bestScore = -Infinity;
      let bestMove = null;

      for (let i = 0; i < 9; i++) {
        if (state.board[i] === null) {
          state.board[i] = 'O';
          const score = minimax(state.board, 0, false, -Infinity, Infinity);
          state.board[i] = null;

          if (score > bestScore) {
            bestScore = score;
            bestMove = i;
          }
        }
      }

      return bestMove;
    }

    function minimax(board, depth, isMaximizing, alpha, beta) {
      const winner = checkWinnerForBoard(board);
      if (winner === 'O') return 10 - depth;
      if (winner === 'X') return depth - 10;
      if (board.every(cell => cell !== null)) return 0;

      if (isMaximizing) {
        let maxScore = -Infinity;
        for (let i = 0; i < 9; i++) {
          if (board[i] === null) {
            board[i] = 'O';
            const score = minimax(board, depth + 1, false, alpha, beta);
            board[i] = null;
            maxScore = Math.max(score, maxScore);
            alpha = Math.max(alpha, score);
            if (beta <= alpha) break;
          }
        }
        return maxScore;
      } else {
        let minScore = Infinity;
        for (let i = 0; i < 9; i++) {
          if (board[i] === null) {
            board[i] = 'X';
            const score = minimax(board, depth + 1, true, alpha, beta);
            board[i] = null;
            minScore = Math.min(score, minScore);
            beta = Math.min(beta, score);
            if (beta <= alpha) break;
          }
        }
        return minScore;
      }
    }

    function checkWinnerForBoard(board) {
      for (const pattern of WIN_PATTERNS) {
        const [a, b, c] = pattern;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          return board[a];
        }
      }
      return null;
    }

    // Dialog
    function openDialog() {
      dialogOverlay.classList.add('open');
      document.getElementById('dialog-close').focus();
    }

    function closeDialog() {
      dialogOverlay.classList.remove('open');
      document.getElementById('customize-btn').focus();
    }

    function handleOptionClick(e) {
      const btn = e.target;
      const option = btn.dataset.option;
      const value = btn.dataset.value;

      // Update UI
      const group = btn.parentElement;
      group.querySelectorAll('.option-btn').forEach(b => {
        b.classList.remove('selected');
        b.setAttribute('aria-checked', 'false');
      });
      btn.classList.add('selected');
      btn.setAttribute('aria-checked', 'true');

      // Update state
      state.settings[option] = value;
      saveSettings();

      // Apply changes
      if (option === 'theme') {
        applyTheme();
      } else if (option === 'glyphs') {
        updateAllGlyphs();
      } else if (option === 'mode' || option === 'first') {
        newRound();
      }
    }

    function updateDialogButtons() {
      document.querySelectorAll('.option-btn').forEach(btn => {
        const option = btn.dataset.option;
        const value = btn.dataset.value;
        const isSelected = state.settings[option] === value;
        btn.classList.toggle('selected', isSelected);
        btn.setAttribute('aria-checked', isSelected ? 'true' : 'false');
      });
    }

    function applyTheme() {
      document.body.dataset.theme = state.settings.theme === 'night' ? 'night' : '';
    }

    function updateAllGlyphs() {
      const cells = boardEl.querySelectorAll('.cell');
      state.board.forEach((player, i) => {
        if (player) {
          cells[i].innerHTML = GLYPHS[state.settings.glyphs][player];
        }
      });
    }

    // Confetti
    let confettiParticles = [];
    let confettiAnimationId = null;

    function resizeCanvas() {
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    }

    function launchConfetti() {
      confettiParticles = [];
      const colors = ['#d4af37', '#f4d160', '#b8962e', '#8b0000', '#1a4d2e', '#ffffff'];

      for (let i = 0; i < 150; i++) {
        confettiParticles.push({
          x: Math.random() * confettiCanvas.width,
          y: Math.random() * confettiCanvas.height - confettiCanvas.height,
          size: Math.random() * 8 + 4,
          color: colors[Math.floor(Math.random() * colors.length)],
          speedX: Math.random() * 4 - 2,
          speedY: Math.random() * 3 + 2,
          rotation: Math.random() * 360,
          rotationSpeed: Math.random() * 10 - 5,
          opacity: 1
        });
      }

      if (confettiAnimationId) {
        cancelAnimationFrame(confettiAnimationId);
      }
      animateConfetti();
    }

    function animateConfetti() {
      ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

      let activeParticles = 0;

      confettiParticles.forEach(p => {
        if (p.opacity <= 0) return;
        activeParticles++;

        p.x += p.speedX;
        p.y += p.speedY;
        p.rotation += p.rotationSpeed;
        p.speedY += 0.1; // gravity

        if (p.y > confettiCanvas.height) {
          p.opacity -= 0.02;
        }

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rotation * Math.PI / 180);
        ctx.globalAlpha = p.opacity;
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.size / 2, -p.size / 4, p.size, p.size / 2);
        ctx.restore();
      });

      if (activeParticles > 0) {
        confettiAnimationId = requestAnimationFrame(animateConfetti);
      } else {
        ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
        confettiAnimationId = null;
      }
    }

    // Start the game
    init();
  </script>
</body>
</html>
