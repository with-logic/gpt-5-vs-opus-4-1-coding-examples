<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéÑ Holiday Card for Kids! üéÖ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Baloo+2:wght@400;600;800&family=Mountains+of+Christmas:wght@400;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    overflow: hidden;
    width: 100vw;
    height: 100vh;
    font-family: 'Baloo 2', cursive;
    user-select: none;
    -webkit-user-select: none;
    background: #0a1628;
  }

  /* Sky gradient background */
  #scene {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: linear-gradient(180deg,
      #0a1628 0%,
      #1a2a4a 20%,
      #2a4a7a 40%,
      #3a6aaa 60%,
      #5a8acc 75%,
      #8ab4e8 90%,
      #c8e0ff 100%
    );
    overflow: hidden;
  }

  /* Ground / Snow */
  #ground {
    position: absolute;
    bottom: 0; left: 0;
    width: 100%; height: 22%;
    background: linear-gradient(180deg, #e8f4ff 0%, #ffffff 30%, #f0f8ff 100%);
    border-radius: 60% 60% 0 0 / 30px 30px 0 0;
    z-index: 5;
    box-shadow: 0 -8px 30px rgba(200, 220, 255, 0.5);
  }

  #ground::before {
    content: '';
    position: absolute;
    top: -15px; left: 5%;
    width: 90%; height: 30px;
    background: radial-gradient(ellipse, rgba(200, 220, 255, 0.8) 0%, transparent 70%);
    border-radius: 50%;
  }

  /* Snow hills */
  .snow-hill {
    position: absolute;
    bottom: 0;
    border-radius: 50% 50% 0 0;
    background: linear-gradient(180deg, #e0eeff, #ffffff);
    z-index: 4;
  }
  .snow-hill:nth-child(1) { left: -5%; width: 40%; height: 28%; }
  .snow-hill:nth-child(2) { left: 25%; width: 50%; height: 25%; }
  .snow-hill:nth-child(3) { left: 60%; width: 45%; height: 30%; }

  /* Stars */
  .star {
    position: absolute;
    background: #fff;
    border-radius: 50%;
    animation: twinkle var(--dur) ease-in-out infinite alternate;
  }

  @keyframes twinkle {
    0% { opacity: 0.3; transform: scale(0.8); }
    100% { opacity: 1; transform: scale(1.2); }
  }

  /* Moon */
  #moon {
    position: absolute;
    top: 6%; right: 12%;
    width: 90px; height: 90px;
    background: radial-gradient(circle at 35% 35%, #fff8e0, #ffe066);
    border-radius: 50%;
    box-shadow: 0 0 40px rgba(255, 224, 100, 0.6), 0 0 80px rgba(255, 224, 100, 0.3);
    z-index: 2;
    animation: moonGlow 4s ease-in-out infinite alternate;
  }

  @keyframes moonGlow {
    0% { box-shadow: 0 0 40px rgba(255, 224, 100, 0.4), 0 0 80px rgba(255, 224, 100, 0.2); }
    100% { box-shadow: 0 0 60px rgba(255, 224, 100, 0.7), 0 0 120px rgba(255, 224, 100, 0.4); }
  }

  /* Northern lights */
  .aurora {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 50%;
    z-index: 1;
    opacity: 0.15;
    pointer-events: none;
  }

  .aurora-band {
    position: absolute;
    width: 200%;
    height: 120px;
    border-radius: 50%;
    filter: blur(40px);
    animation: auroraMove 12s ease-in-out infinite alternate;
  }

  .aurora-band:nth-child(1) {
    top: 10%; left: -30%;
    background: linear-gradient(90deg, transparent, #00ff88, #00ccff, transparent);
    animation-duration: 15s;
  }
  .aurora-band:nth-child(2) {
    top: 18%; left: -50%;
    background: linear-gradient(90deg, transparent, #ff66cc, #6644ff, transparent);
    animation-duration: 18s;
    animation-delay: -5s;
  }
  .aurora-band:nth-child(3) {
    top: 5%; left: -20%;
    background: linear-gradient(90deg, transparent, #44ffaa, #4488ff, transparent);
    animation-duration: 20s;
    animation-delay: -8s;
  }

  @keyframes auroraMove {
    0% { transform: translateX(0) scaleY(1); }
    100% { transform: translateX(15%) scaleY(1.3); }
  }

  /* Snowflakes */
  .snowflake {
    position: fixed;
    color: #fff;
    font-size: var(--size, 14px);
    opacity: var(--opacity, 0.8);
    z-index: 100;
    pointer-events: none;
    animation: snowfall var(--fall-dur) linear infinite;
    animation-delay: var(--delay);
    text-shadow: 0 0 4px rgba(200, 220, 255, 0.8);
    filter: blur(var(--blur, 0px));
  }

  @keyframes snowfall {
    0% {
      transform: translateX(0) translateY(-20px) rotate(0deg);
      opacity: var(--opacity, 0.8);
    }
    25% { transform: translateX(var(--sway, 30px)) translateY(25vh) rotate(90deg); }
    50% { transform: translateX(calc(var(--sway, 30px) * -0.5)) translateY(50vh) rotate(180deg); }
    75% { transform: translateX(var(--sway, 30px)) translateY(75vh) rotate(270deg); }
    100% {
      transform: translateX(0) translateY(105vh) rotate(360deg);
      opacity: 0.2;
    }
  }

  /* Card area */
  #card-area {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: min(85vw, 750px);
    height: min(75vh, 580px);
    background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.05));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 24px;
    z-index: 10;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
    overflow: hidden;
  }

  /* Card header */
  #card-header {
    text-align: center;
    padding: 18px 20px 8px;
    position: relative;
    z-index: 20;
  }

  #card-header h1 {
    font-family: 'Mountains of Christmas', cursive;
    font-size: clamp(28px, 5vw, 52px);
    color: #fff;
    text-shadow: 0 2px 10px rgba(255,100,100,0.5), 0 0 30px rgba(255,200,100,0.3);
    letter-spacing: 2px;
    animation: titleBounce 3s ease-in-out infinite;
    line-height: 1.1;
  }

  @keyframes titleBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }

  #card-header p {
    font-family: 'Baloo 2', cursive;
    font-size: clamp(13px, 2vw, 18px);
    color: rgba(255,255,255,0.8);
    margin-top: 4px;
  }

  /* Drop zone */
  #drop-zone {
    position: relative;
    width: 100%;
    height: calc(100% - 100px);
    z-index: 15;
  }

  /* Draggable items on the card */
  .placed-item {
    position: absolute;
    cursor: grab;
    font-size: 40px;
    transition: transform 0.15s ease, filter 0.15s ease;
    z-index: 20;
    filter: drop-shadow(0 3px 6px rgba(0,0,0,0.3));
    animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  .placed-item:hover {
    transform: scale(1.2) rotate(-5deg);
    filter: drop-shadow(0 5px 15px rgba(255,200,100,0.5));
  }

  .placed-item.dragging {
    cursor: grabbing;
    transform: scale(1.3);
    z-index: 999;
    filter: drop-shadow(0 8px 20px rgba(255,200,100,0.6));
    transition: none;
  }

  @keyframes popIn {
    0% { transform: scale(0) rotate(-180deg); opacity: 0; }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
  }

  /* Toolbar / palette */
  #toolbar {
    position: fixed;
    bottom: 0; left: 0;
    width: 100%;
    z-index: 50;
    background: linear-gradient(180deg, transparent, rgba(0,0,0,0.4) 30%, rgba(10,22,40,0.95));
    padding: 8px 10px 12px;
  }

  #toolbar-label {
    text-align: center;
    font-family: 'Fredoka One', cursive;
    font-size: 14px;
    color: rgba(255,255,255,0.7);
    margin-bottom: 6px;
    letter-spacing: 1px;
  }

  #palette {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 6px;
    max-width: 800px;
    margin: 0 auto;
  }

  .palette-item {
    width: 48px; height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.15);
    border-radius: 12px;
    cursor: grab;
    transition: all 0.2s ease;
    position: relative;
  }

  .palette-item:hover {
    background: rgba(255,255,255,0.2);
    border-color: rgba(255,200,100,0.5);
    transform: scale(1.15) translateY(-4px);
    box-shadow: 0 6px 20px rgba(255,200,100,0.3);
  }

  .palette-item:active {
    cursor: grabbing;
    transform: scale(1.05);
  }

  .palette-item .tooltip {
    position: absolute;
    bottom: 110%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.85);
    color: #fff;
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 6px;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    font-family: 'Baloo 2', cursive;
  }

  .palette-item:hover .tooltip { opacity: 1; }

  /* Action buttons */
  #actions {
    position: fixed;
    top: 12px; right: 12px;
    display: flex;
    gap: 8px;
    z-index: 60;
  }

  .action-btn {
    width: 42px; height: 42px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(8px);
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .action-btn:hover {
    background: rgba(255,255,255,0.25);
    transform: scale(1.1);
    border-color: rgba(255,200,100,0.5);
  }

  .action-btn.active {
    background: rgba(255, 100, 100, 0.3);
    border-color: rgba(255, 100, 100, 0.6);
  }

  /* Sparkle effect on click */
  .sparkle {
    position: fixed;
    pointer-events: none;
    z-index: 1000;
    animation: sparkleFade 0.7s ease-out forwards;
  }

  @keyframes sparkleFade {
    0% { transform: scale(0) rotate(0deg); opacity: 1; }
    50% { transform: scale(1.2) rotate(180deg); opacity: 0.8; }
    100% { transform: scale(0) rotate(360deg); opacity: 0; }
  }

  /* Burst particles */
  .burst-particle {
    position: fixed;
    pointer-events: none;
    z-index: 1000;
    font-size: 16px;
    animation: burstOut 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }

  @keyframes burstOut {
    0% { transform: translate(0, 0) scale(1); opacity: 1; }
    100% { transform: translate(var(--bx), var(--by)) scale(0); opacity: 0; }
  }

  /* Christmas tree special */
  .tree-lights {
    animation: treeLights 1.5s ease-in-out infinite alternate;
  }

  @keyframes treeLights {
    0% { filter: drop-shadow(0 0 5px #ff0) drop-shadow(0 0 10px #f00); }
    33% { filter: drop-shadow(0 0 5px #0f0) drop-shadow(0 0 10px #00f); }
    66% { filter: drop-shadow(0 0 5px #f0f) drop-shadow(0 0 10px #ff0); }
    100% { filter: drop-shadow(0 0 5px #0ff) drop-shadow(0 0 10px #f00); }
  }

  /* Wiggle animation for fun */
  .wiggle {
    animation: wiggle 0.5s ease-in-out;
  }

  @keyframes wiggle {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-15deg); }
    75% { transform: rotate(15deg); }
  }

  /* Bounce animation */
  .bounce-in {
    animation: bounceIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes bounceIn {
    0% { transform: scale(0); }
    60% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  /* Floating animation for placed items */
  .float-gentle {
    animation: floatGentle 3s ease-in-out infinite alternate;
  }

  @keyframes floatGentle {
    0% { transform: translateY(0px); }
    100% { transform: translateY(-6px); }
  }

  /* Jingle bells shake */
  .jingle {
    animation: jingle 0.3s ease-in-out 3;
  }

  @keyframes jingle {
    0%, 100% { transform: rotate(0deg) scale(1.1); }
    25% { transform: rotate(-20deg) scale(1.15); }
    75% { transform: rotate(20deg) scale(1.15); }
  }

  /* Magic wand trail */
  .magic-trail {
    position: fixed;
    pointer-events: none;
    z-index: 999;
    font-size: 12px;
    animation: magicFade 0.6s ease-out forwards;
  }

  @keyframes magicFade {
    0% { opacity: 1; transform: scale(1) translateY(0); }
    100% { opacity: 0; transform: scale(0.3) translateY(-20px); }
  }

  /* Cute Santa sleigh flying across */
  #santa-sleigh {
    position: fixed;
    top: 8%;
    font-size: 32px;
    z-index: 8;
    animation: santaFly 25s linear infinite;
    pointer-events: none;
    filter: drop-shadow(0 2px 8px rgba(255,200,100,0.5));
  }

  @keyframes santaFly {
    0% { left: -200px; top: 8%; }
    30% { top: 5%; }
    50% { top: 10%; }
    70% { top: 6%; }
    100% { left: calc(100% + 200px); top: 8%; }
  }

  /* Sound toggle */
  #sound-toggle {
    position: fixed;
    top: 12px; left: 12px;
    z-index: 60;
  }

  /* Clear button glow */
  .action-btn.clear-btn:hover {
    background: rgba(255, 80, 80, 0.3);
    border-color: rgba(255, 80, 80, 0.6);
  }

  /* Shake entire card for fun */
  .card-shake {
    animation: cardShake 0.5s ease-in-out;
  }

  @keyframes cardShake {
    0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
    20% { transform: translate(-50%, -50%) rotate(-2deg); }
    40% { transform: translate(-50%, -50%) rotate(2deg); }
    60% { transform: translate(-50%, -50%) rotate(-1deg); }
    80% { transform: translate(-50%, -50%) rotate(1deg); }
  }

  /* Ribbon corners */
  .ribbon-corner {
    position: absolute;
    width: 80px; height: 80px;
    overflow: hidden;
    z-index: 25;
    pointer-events: none;
  }

  .ribbon-corner.top-left { top: 0; left: 0; }
  .ribbon-corner.top-right { top: 0; right: 0; transform: scaleX(-1); }
  .ribbon-corner.bottom-left { bottom: 0; left: 0; transform: scaleY(-1); }
  .ribbon-corner.bottom-right { bottom: 0; right: 0; transform: scale(-1); }

  .ribbon-corner::after {
    content: '';
    position: absolute;
    top: 8px; left: -20px;
    width: 100px; height: 18px;
    background: linear-gradient(90deg, #cc2233, #ff4455, #cc2233);
    transform: rotate(-45deg);
    box-shadow: 0 2px 8px rgba(200, 0, 50, 0.4);
  }

  /* Message overlay */
  #message-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 200;
    justify-content: center;
    align-items: center;
  }

  #message-overlay.show { display: flex; }

  #message-card {
    background: linear-gradient(135deg, #1a3a5c, #2a5a8c);
    border: 3px solid rgba(255,200,100,0.4);
    border-radius: 24px;
    padding: 30px 40px;
    text-align: center;
    max-width: 420px;
    animation: messageIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }

  @keyframes messageIn {
    0% { transform: scale(0) rotate(-10deg); opacity: 0; }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
  }

  #message-card h2 {
    font-family: 'Mountains of Christmas', cursive;
    color: #ffe066;
    font-size: 32px;
    margin-bottom: 12px;
    text-shadow: 0 2px 8px rgba(255,200,100,0.4);
  }

  #message-card p {
    color: rgba(255,255,255,0.9);
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 20px;
  }

  #message-card button {
    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
    border: none;
    color: #fff;
    font-family: 'Fredoka One', cursive;
    font-size: 16px;
    padding: 10px 28px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 15px rgba(238, 90, 36, 0.4);
  }

  #message-card button:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(238, 90, 36, 0.6);
  }

  /* Fun counter */
  #item-counter {
    position: fixed;
    top: 12px; left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 20px;
    padding: 5px 16px;
    color: #fff;
    font-family: 'Fredoka One', cursive;
    font-size: 13px;
    z-index: 60;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* Ghost drag preview */
  .drag-ghost {
    position: fixed;
    pointer-events: none;
    z-index: 10000;
    font-size: 48px;
    opacity: 0.85;
    filter: drop-shadow(0 4px 12px rgba(255,200,100,0.5));
    transition: none;
  }

  /* Responsive */
  @media (max-width: 600px) {
    .palette-item { width: 40px; height: 40px; font-size: 22px; }
    #card-area { width: 92vw; height: 70vh; border-radius: 16px; }
    #card-header h1 { font-size: 24px; }
    .placed-item { font-size: 32px; }
    #moon { width: 60px; height: 60px; top: 4%; right: 8%; }
    .action-btn { width: 36px; height: 36px; font-size: 15px; }
  }

  /* Double-click delete hint */
  .delete-hint {
    position: absolute;
    bottom: -22px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: rgba(255,255,255,0.5);
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s;
    font-family: 'Baloo 2', cursive;
    pointer-events: none;
  }

  .placed-item:hover .delete-hint { opacity: 1; }

  /* Candy cane border animation */
  #card-area::before {
    content: '';
    position: absolute;
    top: -2px; left: -2px;
    right: -2px; bottom: -2px;
    border-radius: 26px;
    background: repeating-linear-gradient(
      45deg,
      rgba(255,50,50,0.3),
      rgba(255,50,50,0.3) 10px,
      rgba(255,255,255,0.15) 10px,
      rgba(255,255,255,0.15) 20px
    );
    z-index: -1;
    animation: candyStripe 2s linear infinite;
  }

  @keyframes candyStripe {
    0% { background-position: 0 0; }
    100% { background-position: 28px 0; }
  }

  /* Chimney smoke */
  .smoke {
    position: absolute;
    width: 12px; height: 12px;
    background: rgba(200, 200, 200, 0.4);
    border-radius: 50%;
    z-index: 3;
    animation: smokeRise 4s ease-out infinite;
    pointer-events: none;
  }

  @keyframes smokeRise {
    0% { transform: translateY(0) scale(1); opacity: 0.4; }
    50% { transform: translateY(-40px) scale(2); opacity: 0.2; }
    100% { transform: translateY(-80px) scale(3); opacity: 0; }
  }

  /* House glow windows */
  .window-glow {
    position: absolute;
    width: 8px; height: 8px;
    background: #ffe066;
    border-radius: 2px;
    box-shadow: 0 0 8px rgba(255, 224, 100, 0.8);
    animation: windowFlicker 5s ease-in-out infinite alternate;
    z-index: 4;
    pointer-events: none;
  }

  @keyframes windowFlicker {
    0%, 80% { opacity: 1; }
    85% { opacity: 0.6; }
    90% { opacity: 1; }
    95% { opacity: 0.7; }
    100% { opacity: 1; }
  }
</style>
</head>
<body>

<div id="scene">
  <!-- Aurora / Northern Lights -->
  <div class="aurora">
    <div class="aurora-band"></div>
    <div class="aurora-band"></div>
    <div class="aurora-band"></div>
  </div>

  <!-- Moon -->
  <div id="moon"></div>

  <!-- Santa sleigh -->
  <div id="santa-sleigh">ü¶åü¶åüõ∑üéÖ</div>

  <!-- Snow hills -->
  <div class="snow-hill" style="left:-5%;width:40%;height:28%"></div>
  <div class="snow-hill" style="left:25%;width:50%;height:25%"></div>
  <div class="snow-hill" style="left:60%;width:45%;height:30%"></div>

  <!-- Ground -->
  <div id="ground"></div>

  <!-- Card area -->
  <div id="card-area">
    <div class="ribbon-corner top-left"></div>
    <div class="ribbon-corner top-right"></div>
    <div class="ribbon-corner bottom-left"></div>
    <div class="ribbon-corner bottom-right"></div>

    <div id="card-header">
      <h1>‚ú® Happy Holidays! ‚ú®</h1>
      <p>Drag fun items onto the card to decorate!</p>
    </div>

    <div id="drop-zone"></div>
  </div>
</div>

<!-- Item counter -->
<div id="item-counter">
  <span>üéÅ</span>
  <span>Items: <span id="count-num">0</span></span>
</div>

<!-- Sound toggle -->
<div id="sound-toggle">
  <button class="action-btn active" id="sound-btn" title="Toggle Sound">üîî</button>
</div>

<!-- Action buttons -->
<div id="actions">
  <button class="action-btn" id="shake-btn" title="Shake!">üéâ</button>
  <button class="action-btn" id="snow-btn" title="More Snow!">‚ùÑÔ∏è</button>
  <button class="action-btn" id="surprise-btn" title="Surprise!">üéÅ</button>
  <button class="action-btn clear-btn" id="clear-btn" title="Clear All">üóëÔ∏è</button>
</div>

<!-- Toolbar / Palette -->
<div id="toolbar">
  <div id="toolbar-label">‚ú® DRAG ITEMS TO THE CARD! ‚ú®</div>
  <div id="palette"></div>
</div>

<!-- Message overlay -->
<div id="message-overlay">
  <div id="message-card">
    <h2>üéÑ Merry Christmas! üéÑ</h2>
    <p>Wishing you a magical holiday season filled with joy, laughter, and lots of presents! üéÅüåü</p>
    <button onclick="closeMessage()">Let's Decorate! üé®</button>
  </div>
</div>

<script>
// ==================== AUDIO ENGINE ====================
class SoundEngine {
  constructor() {
    this.ctx = null;
    this.enabled = true;
    this.initialized = false;
  }

  init() {
    if (this.initialized) return;
    try {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      this.initialized = true;
    } catch(e) {
      console.log('Web Audio not supported');
    }
  }

  play(type) {
    if (!this.enabled || !this.ctx) return;
    if (this.ctx.state === 'suspended') this.ctx.resume();

    switch(type) {
      case 'place': this.playPlace(); break;
      case 'pickup': this.playPickup(); break;
      case 'jingle': this.playJingle(); break;
      case 'pop': this.playPop(); break;
      case 'whoosh': this.playWhoosh(); break;
      case 'sparkle': this.playSparkle(); break;
      case 'chime': this.playChime(); break;
      case 'boing': this.playBoing(); break;
      case 'delete': this.playDelete(); break;
      case 'shake': this.playShakeSound(); break;
      case 'surprise': this.playSurprise(); break;
    }
  }

  createOsc(freq, type, dur, vol = 0.15) {
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
    gain.gain.setValueAtTime(vol, this.ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
    osc.connect(gain);
    gain.connect(this.ctx.destination);
    osc.start();
    osc.stop(this.ctx.currentTime + dur);
  }

  playPlace() {
    this.createOsc(523, 'sine', 0.15, 0.12);
    setTimeout(() => this.createOsc(659, 'sine', 0.15, 0.1), 60);
    setTimeout(() => this.createOsc(784, 'sine', 0.2, 0.08), 120);
  }

  playPickup() {
    this.createOsc(400, 'sine', 0.1, 0.08);
    setTimeout(() => this.createOsc(500, 'sine', 0.1, 0.06), 50);
  }

  playJingle() {
    const notes = [659, 659, 659, 659, 659, 659, 659, 784, 523, 587, 659];
    notes.forEach((n, i) => {
      setTimeout(() => this.createOsc(n, 'sine', 0.15, 0.08), i * 100);
    });
  }

  playPop() {
    this.createOsc(800, 'sine', 0.08, 0.12);
    setTimeout(() => this.createOsc(1200, 'sine', 0.06, 0.08), 30);
  }

  playWhoosh() {
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(200, this.ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(800, this.ctx.currentTime + 0.15);
    osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.3);
    gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.3);
    osc.connect(gain);
    gain.connect(this.ctx.destination);
    osc.start();
    osc.stop(this.ctx.currentTime + 0.3);
  }

  playSparkle() {
    for (let i = 0; i < 5; i++) {
      setTimeout(() => {
        this.createOsc(1200 + Math.random() * 800, 'sine', 0.1, 0.04);
      }, i * 60);
    }
  }

  playChime() {
    const notes = [784, 880, 988, 1047];
    notes.forEach((n, i) => {
      setTimeout(() => this.createOsc(n, 'sine', 0.3, 0.06), i * 120);
    });
  }

  playBoing() {
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(300, this.ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(600, this.ctx.currentTime + 0.05);
    osc.frequency.exponentialRampToValueAtTime(200, this.ctx.currentTime + 0.2);
    gain.gain.setValueAtTime(0.12, this.ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.3);
    osc.connect(gain);
    gain.connect(this.ctx.destination);
    osc.start();
    osc.stop(this.ctx.currentTime + 0.3);
  }

  playDelete() {
    this.createOsc(500, 'square', 0.08, 0.06);
    setTimeout(() => this.createOsc(350, 'square', 0.08, 0.05), 60);
    setTimeout(() => this.createOsc(200, 'square', 0.15, 0.04), 120);
  }

  playShakeSound() {
    for (let i = 0; i < 8; i++) {
      setTimeout(() => {
        this.createOsc(800 + Math.random() * 600, 'sine', 0.05, 0.06);
      }, i * 40);
    }
  }

  playSurprise() {
    const notes = [523, 587, 659, 698, 784, 880, 988, 1047];
    notes.forEach((n, i) => {
      setTimeout(() => this.createOsc(n, 'sine', 0.15, 0.08), i * 80);
    });
  }
}

const sound = new SoundEngine();

// ==================== PALETTE ITEMS ====================
const paletteItems = [
  { emoji: 'üéÑ', name: 'Christmas Tree', sound: 'chime', special: 'tree' },
  { emoji: '‚≠ê', name: 'Star', sound: 'sparkle', special: 'glow' },
  { emoji: 'üéÖ', name: 'Santa', sound: 'jingle', special: 'wiggle' },
  { emoji: 'ü§∂', name: 'Mrs. Claus', sound: 'chime' },
  { emoji: 'ü¶å', name: 'Reindeer', sound: 'boing' },
  { emoji: '‚õÑ', name: 'Snowman', sound: 'pop', special: 'wiggle' },
  { emoji: 'üéÅ', name: 'Present', sound: 'surprise', special: 'bounce' },
  { emoji: 'üîî', name: 'Bell', sound: 'jingle', special: 'jingle' },
  { emoji: 'üïØÔ∏è', name: 'Candle', sound: 'sparkle', special: 'glow' },
  { emoji: '‚ùÑÔ∏è', name: 'Snowflake', sound: 'sparkle', special: 'float' },
  { emoji: 'üß¶', name: 'Stocking', sound: 'pop' },
  { emoji: 'üç™', name: 'Cookie', sound: 'pop' },
  { emoji: 'ü•õ', name: 'Milk', sound: 'pop' },
  { emoji: 'üç¨', name: 'Candy', sound: 'pop', special: 'bounce' },
  { emoji: 'üéÄ', name: 'Ribbon', sound: 'whoosh' },
  { emoji: 'üß∏', name: 'Teddy Bear', sound: 'boing', special: 'wiggle' },
  { emoji: 'üêß', name: 'Penguin', sound: 'boing', special: 'wiggle' },
  { emoji: 'ü¶ä', name: 'Fox', sound: 'boing' },
  { emoji: 'üêª‚Äç‚ùÑÔ∏è', name: 'Polar Bear', sound: 'boing', special: 'wiggle' },
  { emoji: 'üé∂', name: 'Music', sound: 'jingle', special: 'float' },
  { emoji: 'üíù', name: 'Heart Gift', sound: 'sparkle', special: 'glow' },
  { emoji: 'üåü', name: 'Glowing Star', sound: 'sparkle', special: 'glow' },
  { emoji: 'üéø', name: 'Skis', sound: 'whoosh' },
  { emoji: 'üè†', name: 'House', sound: 'chime' },
  { emoji: 'üß§', name: 'Gloves', sound: 'pop' },
  { emoji: 'üé©', name: 'Top Hat', sound: 'pop' },
  { emoji: 'üç≠', name: 'Lollipop', sound: 'pop', special: 'bounce' },
  { emoji: '‚òÉÔ∏è', name: 'Snowman 2', sound: 'pop', special: 'wiggle' },
  { emoji: 'üé∫', name: 'Trumpet', sound: 'jingle' },
  { emoji: 'ü™Ñ', name: 'Magic Wand', sound: 'sparkle', special: 'glow' },
];

// ==================== STATE ====================
let placedItems = [];
let itemIdCounter = 0;
let dragItem = null;
let dragOffset = { x: 0, y: 0 };
let isDraggingFromPalette = false;
let ghostEl = null;
let currentPaletteItem = null;

// ==================== INIT ====================
function init() {
  createStars();
  createSnowflakes();
  buildPalette();
  placeDefaultItems();
  setupEventListeners();
  updateCounter();

  // Show welcome message after a beat
  setTimeout(() => {
    document.getElementById('message-overlay').classList.add('show');
    sound.init();
    sound.play('chime');
  }, 800);
}

// ==================== STARS ====================
function createStars() {
  const scene = document.getElementById('scene');
  for (let i = 0; i < 80; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    const size = Math.random() * 3 + 1;
    star.style.cssText = `
      width: ${size}px; height: ${size}px;
      left: ${Math.random() * 100}%;
      top: ${Math.random() * 45}%;
      --dur: ${2 + Math.random() * 3}s;
      animation-delay: ${Math.random() * 3}s;
    `;
    scene.appendChild(star);
  }
}

// ==================== SNOWFLAKES ====================
function createSnowflakes(count = 50) {
  const flakes = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '‚Ä¢', '¬∑'];
  for (let i = 0; i < count; i++) {
    const sf = document.createElement('div');
    sf.className = 'snowflake';
    const size = 8 + Math.random() * 18;
    const opacity = 0.3 + Math.random() * 0.6;
    const blur = Math.random() > 0.7 ? (1 + Math.random() * 2) : 0;
    sf.textContent = flakes[Math.floor(Math.random() * flakes.length)];
    sf.style.cssText = `
      left: ${Math.random() * 100}%;
      --size: ${size}px;
      --opacity: ${opacity};
      --fall-dur: ${6 + Math.random() * 10}s;
      --delay: ${-Math.random() * 15}s;
      --sway: ${15 + Math.random() * 40}px;
      --blur: ${blur}px;
      font-size: ${size}px;
    `;
    document.body.appendChild(sf);
  }
}

// ==================== BUILD PALETTE ====================
function buildPalette() {
  const palette = document.getElementById('palette');
  paletteItems.forEach((item, idx) => {
    const el = document.createElement('div');
    el.className = 'palette-item';
    el.innerHTML = `${item.emoji}<span class="tooltip">${item.name}</span>`;
    el.dataset.index = idx;

    // Mouse events
    el.addEventListener('mousedown', (e) => startPaletteDrag(e, idx));

    // Touch events
    el.addEventListener('touchstart', (e) => startPaletteDragTouch(e, idx), { passive: false });

    palette.appendChild(el);
  });
}

// ==================== DEFAULT ITEMS ====================
function placeDefaultItems() {
  const defaults = [
    { idx: 0, x: 45, y: 55 },   // Christmas tree center-bottom
    { idx: 2, x: 20, y: 35 },   // Santa top-left
    { idx: 5, x: 72, y: 60 },   // Snowman right
    { idx: 4, x: 65, y: 25 },   // Reindeer top-right
    { idx: 7, x: 35, y: 30 },   // Bell
    { idx: 1, x: 48, y: 18 },   // Star top-center
    { idx: 6, x: 25, y: 65 },   // Present bottom-left
    { idx: 14, x: 75, y: 40 },  // Ribbon
    { idx: 9, x: 15, y: 20 },   // Snowflake
    { idx: 12, x: 55, y: 70 },  // Milk
    { idx: 11, x: 60, y: 68 },  // Cookie
  ];

  defaults.forEach((d, i) => {
    setTimeout(() => {
      addItemToCard(d.idx, d.x, d.y);
    }, i * 150);
  });
}

// ==================== ADD ITEM TO CARD ====================
function addItemToCard(paletteIdx, xPercent, yPercent) {
  const item = paletteItems[paletteIdx];
  const el = document.createElement('div');
  const id = itemIdCounter++;

  el.className = 'placed-item';
  el.textContent = item.emoji;
  el.dataset.id = id;
  el.dataset.paletteIdx = paletteIdx;
  el.style.left = xPercent + '%';
  el.style.top = yPercent + '%';

  // Add special effects
  if (item.special === 'tree') el.classList.add('tree-lights');
  if (item.special === 'float') el.classList.add('float-gentle');
  if (item.special === 'glow') {
    el.style.filter = 'drop-shadow(0 0 8px rgba(255,255,100,0.6))';
  }

  // Delete hint
  const hint = document.createElement('div');
  hint.className = 'delete-hint';
  hint.textContent = 'double-tap to remove';
  el.appendChild(hint);

  // Mouse events for dragging placed items
  el.addEventListener('mousedown', (e) => startItemDrag(e, el));
  el.addEventListener('touchstart', (e) => startItemDragTouch(e, el), { passive: false });

  // Double-click to delete
  el.addEventListener('dblclick', () => removeItem(el, id));

  // Click for fun interaction
  el.addEventListener('click', (e) => {
    if (!el._wasDragged) {
      interactWithItem(el, item, e);
    }
    el._wasDragged = false;
  });

  document.getElementById('drop-zone').appendChild(el);

  placedItems.push({ id, paletteIdx, xPercent, yPercent, el });
  updateCounter();

  return el;
}

// ==================== ITEM INTERACTIONS ====================
function interactWithItem(el, item, e) {
  sound.init();
  sound.play(item.sound || 'pop');

  // Wiggle or bounce
  if (item.special === 'wiggle' || item.special === 'jingle') {
    el.classList.remove('wiggle', 'jingle');
    void el.offsetWidth;
    el.classList.add(item.special === 'jingle' ? 'jingle' : 'wiggle');
  } else if (item.special === 'bounce') {
    el.classList.remove('bounce-in');
    void el.offsetWidth;
    el.classList.add('bounce-in');
  }

  // Create burst particles
  createBurst(e.clientX, e.clientY, item.emoji);
}

// ==================== REMOVE ITEM ====================
function removeItem(el, id) {
  sound.init();
  sound.play('delete');

  el.style.transition = 'transform 0.3s, opacity 0.3s';
  el.style.transform = 'scale(0) rotate(180deg)';
  el.style.opacity = '0';

  setTimeout(() => {
    el.remove();
    placedItems = placedItems.filter(p => p.id !== id);
    updateCounter();
  }, 300);
}

// ==================== DRAGGING FROM PALETTE ====================
function startPaletteDrag(e, idx) {
  e.preventDefault();
  sound.init();
  sound.play('pickup');

  isDraggingFromPalette = true;
  currentPaletteItem = idx;

  // Create ghost
  ghostEl = document.createElement('div');
  ghostEl.className = 'drag-ghost';
  ghostEl.textContent = paletteItems[idx].emoji;
  ghostEl.style.left = (e.clientX - 24) + 'px';
  ghostEl.style.top = (e.clientY - 24) + 'px';
  document.body.appendChild(ghostEl);

  document.addEventListener('mousemove', onPaletteDrag);
  document.addEventListener('mouseup', onPaletteDrop);
}

function onPaletteDrag(e) {
  if (!ghostEl) return;
  ghostEl.style.left = (e.clientX - 24) + 'px';
  ghostEl.style.top = (e.clientY - 24) + 'px';

  // Magic trail
  if (Math.random() > 0.6) {
    createMagicTrail(e.clientX, e.clientY);
  }
}

function onPaletteDrop(e) {
  document.removeEventListener('mousemove', onPaletteDrag);
  document.removeEventListener('mouseup', onPaletteDrop);

  if (ghostEl) {
    ghostEl.remove();
    ghostEl = null;
  }

  // Check if dropped on card
  const cardArea = document.getElementById('card-area');
  const dropZone = document.getElementById('drop-zone');
  const rect = dropZone.getBoundingClientRect();

  if (e.clientX >= rect.left && e.clientX <= rect.right &&
      e.clientY >= rect.top && e.clientY <= rect.bottom) {
    const xPercent = ((e.clientX - rect.left) / rect.width) * 100;
    const yPercent = ((e.clientY - rect.top) / rect.height) * 100;

    const el = addItemToCard(currentPaletteItem, xPercent, yPercent);
    sound.play('place');
    createSparkles(e.clientX, e.clientY);
  }

  isDraggingFromPalette = false;
  currentPaletteItem = null;
}

// Touch versions
function startPaletteDragTouch(e, idx) {
  e.preventDefault();
  sound.init();
  sound.play('pickup');

  isDraggingFromPalette = true;
  currentPaletteItem = idx;

  const touch = e.touches[0];
  ghostEl = document.createElement('div');
  ghostEl.className = 'drag-ghost';
  ghostEl.textContent = paletteItems[idx].emoji;
  ghostEl.style.left = (touch.clientX - 24) + 'px';
  ghostEl.style.top = (touch.clientY - 24) + 'px';
  document.body.appendChild(ghostEl);

  document.addEventListener('touchmove', onPaletteDragTouch, { passive: false });
  document.addEventListener('touchend', onPaletteDropTouch);
}

function onPaletteDragTouch(e) {
  e.preventDefault();
  if (!ghostEl) return;
  const touch = e.touches[0];
  ghostEl.style.left = (touch.clientX - 24) + 'px';
  ghostEl.style.top = (touch.clientY - 24) + 'px';
}

function onPaletteDropTouch(e) {
  document.removeEventListener('touchmove', onPaletteDragTouch);
  document.removeEventListener('touchend', onPaletteDropTouch);

  const touch = e.changedTouches[0];

  if (ghostEl) {
    ghostEl.remove();
    ghostEl = null;
  }

  const dropZone = document.getElementById('drop-zone');
  const rect = dropZone.getBoundingClientRect();

  if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
      touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
    const xPercent = ((touch.clientX - rect.left) / rect.width) * 100;
    const yPercent = ((touch.clientY - rect.top) / rect.height) * 100;
    addItemToCard(currentPaletteItem, xPercent, yPercent);
    sound.play('place');
    createSparkles(touch.clientX, touch.clientY);
  }

  isDraggingFromPalette = false;
  currentPaletteItem = null;
}

// ==================== DRAGGING PLACED ITEMS ====================
function startItemDrag(e, el) {
  e.preventDefault();
  e.stopPropagation();

  el._wasDragged = false;
  el._startX = e.clientX;
  el._startY = e.clientY;

  const rect = el.getBoundingClientRect();
  dragOffset.x = e.clientX - rect.left;
  dragOffset.y = e.clientY - rect.top;
  dragItem = el;
  el.classList.add('dragging');

  sound.init();
  sound.play('pickup');

  document.addEventListener('mousemove', onItemDrag);
  document.addEventListener('mouseup', onItemDrop);
}

function onItemDrag(e) {
  if (!dragItem) return;

  const dx = Math.abs(e.clientX - dragItem._startX);
  const dy = Math.abs(e.clientY - dragItem._startY);
  if (dx > 3 || dy > 3) dragItem._wasDragged = true;

  const dropZone = document.getElementById('drop-zone');
  const rect = dropZone.getBoundingClientRect();

  const x = e.clientX - rect.left - dragOffset.x;
  const y = e.clientY - rect.top - dragOffset.y;

  const xPercent = (x / rect.width) * 100;
  const yPercent = (y / rect.height) * 100;

  dragItem.style.left = Math.max(0, Math.min(95, xPercent)) + '%';
  dragItem.style.top = Math.max(0, Math.min(90, yPercent)) + '%';
}

function onItemDrop(e) {
  document.removeEventListener('mousemove', onItemDrag);
  document.removeEventListener('mouseup', onItemDrop);

  if (dragItem) {
    dragItem.classList.remove('dragging');
    if (dragItem._wasDragged) {
      sound.play('place');
      createSparkles(e.clientX, e.clientY);
    }
    dragItem = null;
  }
}

// Touch drag for placed items
function startItemDragTouch(e, el) {
  e.preventDefault();
  e.stopPropagation();

  el._wasDragged = false;
  const touch = e.touches[0];
  el._startX = touch.clientX;
  el._startY = touch.clientY;

  const rect = el.getBoundingClientRect();
  dragOffset.x = touch.clientX - rect.left;
  dragOffset.y = touch.clientY - rect.top;
  dragItem = el;
  el.classList.add('dragging');

  sound.init();
  sound.play('pickup');

  document.addEventListener('touchmove', onItemDragTouch, { passive: false });
  document.addEventListener('touchend', onItemDropTouch);
}

function onItemDragTouch(e) {
  e.preventDefault();
  if (!dragItem) return;

  const touch = e.touches[0];
  const dx = Math.abs(touch.clientX - dragItem._startX);
  const dy = Math.abs(touch.clientY - dragItem._startY);
  if (dx > 3 || dy > 3) dragItem._wasDragged = true;

  const dropZone = document.getElementById('drop-zone');
  const rect = dropZone.getBoundingClientRect();

  const x = touch.clientX - rect.left - dragOffset.x;
  const y = touch.clientY - rect.top - dragOffset.y;

  const xPercent = (x / rect.width) * 100;
  const yPercent = (y / rect.height) * 100;

  dragItem.style.left = Math.max(0, Math.min(95, xPercent)) + '%';
  dragItem.style.top = Math.max(0, Math.min(90, yPercent)) + '%';
}

function onItemDropTouch(e) {
  document.removeEventListener('touchmove', onItemDragTouch);
  document.removeEventListener('touchend', onItemDropTouch);

  if (dragItem) {
    dragItem.classList.remove('dragging');
    if (dragItem._wasDragged) {
      sound.play('place');
      const touch = e.changedTouches[0];
      createSparkles(touch.clientX, touch.clientY);
    }
    dragItem = null;
  }
}

// ==================== VISUAL EFFECTS ====================
function createSparkles(x, y) {
  const sparkles = ['‚ú®', '‚≠ê', 'üåü', 'üí´', '‚úß', '‚òÖ'];
  for (let i = 0; i < 6; i++) {
    const sp = document.createElement('div');
    sp.className = 'sparkle';
    sp.textContent = sparkles[Math.floor(Math.random() * sparkles.length)];
    sp.style.left = (x + (Math.random() - 0.5) * 60) + 'px';
    sp.style.top = (y + (Math.random() - 0.5) * 60) + 'px';
    sp.style.fontSize = (12 + Math.random() * 16) + 'px';
    document.body.appendChild(sp);
    setTimeout(() => sp.remove(), 700);
  }
}

function createBurst(x, y, emoji) {
  for (let i = 0; i < 8; i++) {
    const p = document.createElement('div');
    p.className = 'burst-particle';
    p.textContent = emoji;
    const angle = (i / 8) * Math.PI * 2;
    const dist = 40 + Math.random() * 40;
    p.style.left = x + 'px';
    p.style.top = y + 'px';
    p.style.setProperty('--bx', Math.cos(angle) * dist + 'px');
    p.style.setProperty('--by', Math.sin(angle) * dist + 'px');
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 800);
  }
}

function createMagicTrail(x, y) {
  const trails = ['‚ú®', '‚≠ê', '¬∑', '‚úß'];
  const t = document.createElement('div');
  t.className = 'magic-trail';
  t.textContent = trails[Math.floor(Math.random() * trails.length)];
  t.style.left = (x + (Math.random() - 0.5) * 20) + 'px';
  t.style.top = (y + (Math.random() - 0.5) * 20) + 'px';
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 600);
}

// ==================== BUTTON ACTIONS ====================
function setupEventListeners() {
  // Sound toggle
  document.getElementById('sound-btn').addEventListener('click', () => {
    sound.init();
    sound.enabled = !sound.enabled;
    const btn = document.getElementById('sound-btn');
    btn.textContent = sound.enabled ? 'üîî' : 'üîï';
    btn.classList.toggle('active', sound.enabled);
    if (sound.enabled) sound.play('jingle');
  });

  // Shake button
  document.getElementById('shake-btn').addEventListener('click', () => {
    sound.init();
    sound.play('shake');
    const card = document.getElementById('card-area');
    card.classList.remove('card-shake');
    void card.offsetWidth;
    card.classList.add('card-shake');

    // Make all items wiggle
    document.querySelectorAll('.placed-item').forEach(item => {
      item.classList.remove('wiggle');
      void item.offsetWidth;
      item.classList.add('wiggle');
    });

    // Extra sparkles everywhere
    for (let i = 0; i < 20; i++) {
      setTimeout(() => {
        createSparkles(
          Math.random() * window.innerWidth,
          Math.random() * window.innerHeight
        );
      }, i * 50);
    }
  });

  // More snow button
  document.getElementById('snow-btn').addEventListener('click', () => {
    sound.init();
    sound.play('whoosh');
    createSnowflakes(30);
  });

  // Surprise button
  document.getElementById('surprise-btn').addEventListener('click', () => {
    sound.init();
    sound.play('surprise');

    // Add random items in fun positions
    const dropZone = document.getElementById('drop-zone');
    for (let i = 0; i < 5; i++) {
      setTimeout(() => {
        const idx = Math.floor(Math.random() * paletteItems.length);
        const x = 10 + Math.random() * 80;
        const y = 10 + Math.random() * 75;
        addItemToCard(idx, x, y);
        const rect = dropZone.getBoundingClientRect();
        createSparkles(
          rect.left + (x / 100) * rect.width,
          rect.top + (y / 100) * rect.height
        );
      }, i * 200);
    }
  });

  // Clear button
  document.getElementById('clear-btn').addEventListener('click', () => {
    sound.init();

    const items = document.querySelectorAll('.placed-item');
    items.forEach((item, i) => {
      setTimeout(() => {
        sound.play('pop');
        item.style.transition = 'transform 0.3s, opacity 0.3s';
        item.style.transform = 'scale(0) rotate(360deg)';
        item.style.opacity = '0';
        setTimeout(() => item.remove(), 300);
      }, i * 50);
    });

    setTimeout(() => {
      placedItems = [];
      updateCounter();
    }, items.length * 50 + 300);
  });

  // Click anywhere on scene for sparkles
  document.getElementById('scene').addEventListener('click', (e) => {
    if (e.target === document.getElementById('scene') ||
        e.target === document.getElementById('ground') ||
        e.target.classList.contains('snow-hill')) {
      sound.init();
      sound.play('sparkle');
      createSparkles(e.clientX, e.clientY);
    }
  });

  // Moon click
  document.getElementById('moon').addEventListener('click', (e) => {
    sound.init();
    sound.play('chime');
    createBurst(e.clientX, e.clientY, 'üåü');
    // Toggle title
    const h1 = document.querySelector('#card-header h1');
    const messages = [
      '‚ú® Happy Holidays! ‚ú®',
      'üéÑ Merry Christmas! üéÑ',
      '‚≠ê Season\'s Greetings! ‚≠ê',
      '‚ùÑÔ∏è Winter Wonderland! ‚ùÑÔ∏è',
      'üéÖ Ho Ho Ho! üéÖ',
      'üíù Spread the Joy! üíù',
      'üåü Make a Wish! üåü',
    ];
    h1.textContent = messages[Math.floor(Math.random() * messages.length)];
  });

  // Santa click
  document.getElementById('santa-sleigh').addEventListener('click', (e) => {
    sound.init();
    sound.play('jingle');
    createBurst(e.clientX, e.clientY, 'üéÅ');
  });
  document.getElementById('santa-sleigh').style.pointerEvents = 'auto';
  document.getElementById('santa-sleigh').style.cursor = 'pointer';
}

function updateCounter() {
  document.getElementById('count-num').textContent = placedItems.length;
}

function closeMessage() {
  document.getElementById('message-overlay').classList.remove('show');
  sound.init();
  sound.play('sparkle');

  // Celebratory sparkles
  for (let i = 0; i < 15; i++) {
    setTimeout(() => {
      createSparkles(
        window.innerWidth * 0.3 + Math.random() * window.innerWidth * 0.4,
        window.innerHeight * 0.3 + Math.random() * window.innerHeight * 0.4
      );
    }, i * 80);
  }
}

// ==================== SMOKE FROM HOUSES (decorative) ====================
function addDecoElements() {
  // Add a few decorative houses on the ground
  const scene = document.getElementById('scene');

  // Small house left
  const h1 = document.createElement('div');
  h1.style.cssText = 'position:absolute; bottom:18%; left:8%; font-size:40px; z-index:6; filter:drop-shadow(0 2px 8px rgba(0,0,0,0.3)); pointer-events:none;';
  h1.textContent = 'üè†';
  scene.appendChild(h1);

  // Small house right
  const h2 = document.createElement('div');
  h2.style.cssText = 'position:absolute; bottom:20%; right:10%; font-size:35px; z-index:6; filter:drop-shadow(0 2px 8px rgba(0,0,0,0.3)); pointer-events:none;';
  h2.textContent = 'üè°';
  scene.appendChild(h2);

  // Pine trees in background
  const trees = [
    { left: '3%', bottom: '22%', size: '30px', z: 3 },
    { left: '15%', bottom: '20%', size: '35px', z: 3 },
    { right: '3%', bottom: '24%', size: '28px', z: 3 },
    { right: '18%', bottom: '21%', size: '32px', z: 3 },
    { left: '40%', bottom: '22%', size: '25px', z: 3 },
    { right: '35%', bottom: '23%', size: '30px', z: 3 },
  ];

  trees.forEach(t => {
    const tree = document.createElement('div');
    tree.textContent = 'üå≤';
    let css = `position:absolute; font-size:${t.size}; z-index:${t.z}; bottom:${t.bottom}; pointer-events:none; filter: brightness(0.7) drop-shadow(0 2px 4px rgba(0,0,0,0.2));`;
    if (t.left) css += `left:${t.left};`;
    if (t.right) css += `right:${t.right};`;
    tree.style.cssText = css;
    scene.appendChild(tree);
  });

  // Add some window glows on the scene houses
  [
    { left: 'calc(8% + 8px)', bottom: 'calc(18% + 18px)' },
    { left: 'calc(8% + 20px)', bottom: 'calc(18% + 18px)' },
  ].forEach(pos => {
    const w = document.createElement('div');
    w.className = 'window-glow';
    w.style.left = pos.left;
    w.style.bottom = pos.bottom;
    scene.appendChild(w);
  });

  // Smoke from house chimney
  function addSmoke() {
    const smoke = document.createElement('div');
    smoke.className = 'smoke';
    smoke.style.left = 'calc(8% + 25px)';
    smoke.style.bottom = 'calc(18% + 38px)';
    smoke.style.animationDelay = (Math.random() * 2) + 's';
    scene.appendChild(smoke);
    setTimeout(() => smoke.remove(), 4000);
  }

  setInterval(addSmoke, 1500);

  // Little snow mounds
  for (let i = 0; i < 8; i++) {
    const mound = document.createElement('div');
    mound.style.cssText = `
      position: absolute;
      bottom: ${17 + Math.random() * 4}%;
      left: ${Math.random() * 90}%;
      width: ${20 + Math.random() * 30}px;
      height: ${8 + Math.random() * 10}px;
      background: rgba(255,255,255,0.6);
      border-radius: 50% 50% 0 0;
      z-index: 5;
      pointer-events: none;
    `;
    scene.appendChild(mound);
  }
}

// ==================== KEYBOARD SHORTCUTS ====================
document.addEventListener('keydown', (e) => {
  if (e.key === 's' || e.key === 'S') {
    document.getElementById('sound-btn').click();
  }
  if (e.key === ' ') {
    e.preventDefault();
    document.getElementById('surprise-btn').click();
  }
});

// ==================== INITIALIZE ====================
window.addEventListener('DOMContentLoaded', () => {
  init();
  addDecoElements();
});
</script>
</body>
</html>
