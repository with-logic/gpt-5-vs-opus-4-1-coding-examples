<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiny Kanban</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f172a;
    --surface: #1e293b;
    --surface-hover: #334155;
    --border: #334155;
    --border-light: #475569;
    --text: #f1f5f9;
    --text-muted: #94a3b8;
    --text-dim: #64748b;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --todo-accent: #6366f1;
    --doing-accent: #f59e0b;
    --done-accent: #10b981;
    --priority-critical: #ef4444;
    --priority-high: #f97316;
    --priority-medium: #eab308;
    --priority-low: #22c55e;
    --priority-none: #64748b;
    --card-bg: #1e293b;
    --card-hover: #263348;
    --danger: #ef4444;
    --danger-hover: #dc2626;
    --shadow: 0 4px 24px rgba(0,0,0,0.3);
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
    --radius: 12px;
    --radius-sm: 8px;
    --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  html { font-size: 18px; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Header */
  .header {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-bottom: 1px solid var(--border);
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(12px);
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo {
    font-size: 1.6rem;
    font-weight: 800;
    background: linear-gradient(135deg, #6366f1, #3b82f6, #06b6d4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
  }

  .logo-icon {
    font-size: 1.4rem;
    filter: none;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  /* Search */
  .search-box {
    position: relative;
  }

  .search-box svg {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    color: var(--text-dim);
    pointer-events: none;
  }

  .search-input {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 40px;
    color: var(--text);
    padding: 10px 16px 10px 42px;
    font-size: 0.9rem;
    width: 260px;
    transition: var(--transition);
    outline: none;
  }

  .search-input::placeholder { color: var(--text-dim); }
  .search-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border: none;
    border-radius: 40px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #6366f1);
    color: white;
    box-shadow: 0 2px 12px rgba(59, 130, 246, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
  }

  .btn-ghost {
    background: transparent;
    color: var(--text-muted);
    padding: 8px 12px;
  }

  .btn-ghost:hover {
    background: var(--surface-hover);
    color: var(--text);
  }

  .btn-danger {
    background: var(--danger);
    color: white;
  }

  .btn-danger:hover { background: var(--danger-hover); }

  .btn svg { width: 18px; height: 18px; }

  /* Board */
  .board {
    display: flex;
    gap: 24px;
    padding: 28px 32px;
    min-height: calc(100vh - 80px);
    overflow-x: auto;
  }

  /* Columns */
  .column {
    flex: 1;
    min-width: 340px;
    max-width: 460px;
    display: flex;
    flex-direction: column;
    border-radius: var(--radius);
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid var(--border);
    overflow: hidden;
    transition: var(--transition);
  }

  .column.drag-over {
    border-color: var(--accent);
    background: rgba(59, 130, 246, 0.05);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
  }

  .column-header {
    padding: 20px 20px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    user-select: none;
  }

  .column-title-group {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .column-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .column-title {
    font-size: 1.05rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    text-transform: uppercase;
  }

  .column-count {
    font-size: 0.8rem;
    font-weight: 700;
    background: var(--surface-hover);
    padding: 3px 10px;
    border-radius: 20px;
    color: var(--text-muted);
    min-width: 30px;
    text-align: center;
  }

  .wip-warning {
    background: rgba(239, 68, 68, 0.15) !important;
    color: var(--priority-critical) !important;
    animation: pulse-warn 2s ease-in-out infinite;
  }

  @keyframes pulse-warn {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .wip-limit-badge {
    font-size: 0.7rem;
    color: var(--text-dim);
    background: var(--surface);
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 4px;
  }

  .card-list {
    flex: 1;
    padding: 12px;
    overflow-y: auto;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .card-list::-webkit-scrollbar { width: 6px; }
  .card-list::-webkit-scrollbar-track { background: transparent; }
  .card-list::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
  }

  /* Cards */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px;
    cursor: grab;
    transition: all 0.2s ease;
    position: relative;
    border-left: 4px solid transparent;
  }

  .card:hover {
    background: var(--card-hover);
    border-color: var(--border-light);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
  }

  .card:active { cursor: grabbing; }

  .card.dragging {
    opacity: 0.4;
    transform: scale(0.98) rotate(2deg);
  }

  .card.drag-ghost {
    opacity: 0;
    height: 0;
    padding: 0;
    margin: 0;
    border: none;
    overflow: hidden;
  }

  .card-priority-critical { border-left-color: var(--priority-critical); }
  .card-priority-high { border-left-color: var(--priority-high); }
  .card-priority-medium { border-left-color: var(--priority-medium); }
  .card-priority-low { border-left-color: var(--priority-low); }
  .card-priority-none { border-left-color: var(--priority-none); }

  .card-top-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 8px;
  }

  .card-title {
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.4;
    flex: 1;
    word-break: break-word;
  }

  .card-actions {
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: var(--transition);
    flex-shrink: 0;
  }

  .card:hover .card-actions { opacity: 1; }

  .card-action-btn {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    padding: 4px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
  }

  .card-action-btn:hover {
    background: var(--surface-hover);
    color: var(--text);
  }

  .card-action-btn.delete:hover {
    background: rgba(239, 68, 68, 0.15);
    color: var(--danger);
  }

  .card-action-btn svg { width: 16px; height: 16px; }

  .card-description {
    font-size: 0.82rem;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 10px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-top: 4px;
  }

  .card-tags {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .priority-tag {
    font-size: 0.7rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .priority-tag-critical { background: rgba(239, 68, 68, 0.15); color: var(--priority-critical); }
  .priority-tag-high { background: rgba(249, 115, 22, 0.15); color: var(--priority-high); }
  .priority-tag-medium { background: rgba(234, 179, 8, 0.15); color: var(--priority-medium); }
  .priority-tag-low { background: rgba(34, 197, 94, 0.15); color: var(--priority-low); }
  .priority-tag-none { background: rgba(100, 116, 139, 0.15); color: var(--priority-none); }

  .assignee-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.78rem;
    color: var(--text-muted);
  }

  .avatar {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
    text-transform: uppercase;
  }

  .card-id {
    font-size: 0.7rem;
    color: var(--text-dim);
    font-weight: 500;
    font-family: 'SF Mono', 'Fira Code', monospace;
  }

  /* Drop indicator */
  .drop-indicator {
    height: 3px;
    background: var(--accent);
    border-radius: 3px;
    margin: -2px 0;
    transition: opacity 0.15s;
    box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
  }

  /* Empty state */
  .empty-column {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    color: var(--text-dim);
    text-align: center;
    font-size: 0.85rem;
    min-height: 120px;
  }

  .empty-column svg {
    width: 36px;
    height: 36px;
    margin-bottom: 10px;
    opacity: 0.4;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    animation: fadeIn 0.2s ease;
    padding: 20px;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    width: 100%;
    max-width: 520px;
    box-shadow: var(--shadow);
    animation: slideUp 0.25s ease;
    max-height: 90vh;
    overflow-y: auto;
  }

  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .modal-header {
    padding: 24px 24px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-title {
    font-size: 1.2rem;
    font-weight: 700;
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    padding: 6px;
    border-radius: 8px;
    display: flex;
    transition: var(--transition);
  }

  .modal-close:hover {
    background: var(--surface-hover);
    color: var(--text);
  }

  .modal-close svg { width: 20px; height: 20px; }

  .modal-body { padding: 20px 24px; }

  .form-group { margin-bottom: 18px; }

  .form-label {
    display: block;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .form-input, .form-textarea, .form-select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    padding: 12px 14px;
    font-size: 0.95rem;
    font-family: inherit;
    transition: var(--transition);
    outline: none;
  }

  .form-input:focus, .form-textarea:focus, .form-select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  }

  .form-input::placeholder, .form-textarea::placeholder { color: var(--text-dim); }

  .form-textarea { resize: vertical; min-height: 80px; }

  .form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px;
    cursor: pointer;
  }

  .form-select option { background: var(--surface); }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }

  .modal-footer {
    padding: 0 24px 24px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  .btn-cancel {
    background: var(--surface-hover);
    color: var(--text-muted);
  }

  .btn-cancel:hover {
    background: var(--border);
    color: var(--text);
  }

  /* Delete confirmation */
  .delete-confirm {
    text-align: center;
    padding: 12px 0;
  }

  .delete-confirm p {
    margin-bottom: 8px;
    color: var(--text-muted);
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .delete-confirm .card-title-preview {
    font-weight: 700;
    color: var(--text);
    font-size: 1.05rem;
    margin-bottom: 4px;
  }

  /* Filter badges */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 32px 0;
  }

  .filter-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.78rem;
    background: rgba(59, 130, 246, 0.1);
    color: var(--accent);
    padding: 5px 12px;
    border-radius: 20px;
    border: 1px solid rgba(59, 130, 246, 0.2);
  }

  .filter-badge button {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    display: flex;
    padding: 0;
    margin-left: 2px;
  }

  .filter-badge button svg { width: 14px; height: 14px; }

  /* Standup-friendly: larger text for readability */
  @media (min-width: 1400px) {
    html { font-size: 19px; }
    .column { min-width: 360px; }
  }

  @media (max-width: 900px) {
    html { font-size: 16px; }
    .board { padding: 16px; gap: 16px; }
    .header { padding: 12px 16px; }
    .column { min-width: 300px; }
  }

  /* Toast */
  .toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .toast {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 20px;
    font-size: 0.85rem;
    color: var(--text);
    box-shadow: var(--shadow);
    animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.5s forwards;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  @keyframes fadeOut {
    to { opacity: 0; transform: translateX(40px); }
  }

  /* Keyboard hint */
  .kbd {
    font-size: 0.65rem;
    background: var(--surface-hover);
    padding: 2px 6px;
    border-radius: 4px;
    color: var(--text-dim);
    font-family: monospace;
  }

  /* Highlight matched text */
  mark {
    background: rgba(234, 179, 8, 0.3);
    color: inherit;
    border-radius: 2px;
    padding: 0 1px;
  }

  /* Settings gear */
  .settings-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-dim);
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    display: flex;
    transition: var(--transition);
  }
  .settings-btn:hover {
    background: var(--surface-hover);
    color: var(--text);
    border-color: var(--border-light);
  }
  .settings-btn svg { width: 20px; height: 20px; }

  /* WIP settings modal */
  .wip-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
  }

  .wip-input-group label {
    flex: 1;
    font-size: 0.9rem;
    font-weight: 600;
  }

  .wip-input {
    width: 70px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    padding: 8px 10px;
    font-size: 0.9rem;
    text-align: center;
    outline: none;
  }

  .wip-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
  }

  .wip-hint {
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-top: -6px;
    margin-bottom: 14px;
  }
</style>
</head>
<body>

<div id="app"></div>
<div class="toast-container" id="toasts"></div>

<script>
(function() {
  'use strict';

  // â”€â”€ Constants â”€â”€
  const COLUMNS = [
    { id: 'todo', title: 'To Do', color: '#6366f1', defaultWip: 0 },
    { id: 'doing', title: 'Doing', color: '#f59e0b', defaultWip: 5 },
    { id: 'done', title: 'Done', color: '#10b981', defaultWip: 0 }
  ];

  const PRIORITIES = [
    { id: 'critical', label: 'Critical', color: '#ef4444' },
    { id: 'high', label: 'High', color: '#f97316' },
    { id: 'medium', label: 'Medium', color: '#eab308' },
    { id: 'low', label: 'Low', color: '#22c55e' },
    { id: 'none', label: 'None', color: '#64748b' }
  ];

  const AVATAR_COLORS = [
    '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e',
    '#f97316', '#eab308', '#22c55e', '#14b8a6',
    '#06b6d4', '#3b82f6', '#a855f7', '#e11d48'
  ];

  const PEOPLE = ['Alice', 'Bob', 'Carol', 'Dan', 'Eve', 'Frank'];

  // â”€â”€ State â”€â”€
  let state = loadState();
  let searchQuery = '';
  let dragState = null;
  let modal = null; // { type: 'add'|'edit'|'delete'|'settings', data: ... }

  function defaultState() {
    return {
      nextId: 8,
      wipLimits: { todo: 0, doing: 5, done: 0 },
      cards: [
        { id: 1, title: 'Design authentication flow', description: 'Create wireframes for login, signup, and password reset screens', column: 'todo', priority: 'high', assignee: 'Alice', createdAt: Date.now() - 86400000 * 3 },
        { id: 2, title: 'Set up CI/CD pipeline', description: 'Configure GitHub Actions for automated testing and deployment', column: 'todo', priority: 'medium', assignee: 'Bob', createdAt: Date.now() - 86400000 * 2 },
        { id: 3, title: 'API rate limiting', description: 'Implement rate limiting middleware for all public endpoints', column: 'doing', priority: 'critical', assignee: 'Carol', createdAt: Date.now() - 86400000 * 4 },
        { id: 4, title: 'Fix mobile nav bug', description: 'Hamburger menu not closing after route change on iOS Safari', column: 'doing', priority: 'high', assignee: 'Dan', createdAt: Date.now() - 86400000 },
        { id: 5, title: 'Database migration script', description: 'Write migration for adding user preferences table', column: 'todo', priority: 'low', assignee: 'Eve', createdAt: Date.now() - 86400000 * 5 },
        { id: 6, title: 'Update dependencies', description: 'Bump all npm packages to latest compatible versions', column: 'done', priority: 'low', assignee: 'Frank', createdAt: Date.now() - 86400000 * 6 },
        { id: 7, title: 'Write unit tests for auth', description: 'Cover login, token refresh, and permission checks', column: 'done', priority: 'medium', assignee: 'Alice', createdAt: Date.now() - 86400000 * 7 }
      ]
    };
  }

  function loadState() {
    try {
      const saved = localStorage.getItem('tiny-kanban');
      if (saved) return JSON.parse(saved);
    } catch(e) {}
    return defaultState();
  }

  function saveState() {
    try { localStorage.setItem('tiny-kanban', JSON.stringify(state)); } catch(e) {}
  }

  // â”€â”€ Helpers â”€â”€
  function getInitials(name) {
    if (!name) return '?';
    return name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
  }

  function getAvatarColor(name) {
    if (!name) return AVATAR_COLORS[0];
    let hash = 0;
    for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    return AVATAR_COLORS[Math.abs(hash) % AVATAR_COLORS.length];
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function highlightText(text, query) {
    if (!query) return escapeHtml(text);
    const escaped = escapeHtml(text);
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return escaped.replace(regex, '<mark>$1</mark>');
  }

  function cardsInColumn(colId) {
    return state.cards.filter(c => c.column === colId);
  }

  function filteredCards(colId) {
    let cards = cardsInColumn(colId);
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      cards = cards.filter(c =>
        c.title.toLowerCase().includes(q) ||
        (c.description && c.description.toLowerCase().includes(q)) ||
        (c.assignee && c.assignee.toLowerCase().includes(q)) ||
        c.priority.toLowerCase().includes(q)
      );
    }
    return cards;
  }

  function toast(message, icon = 'âœ“') {
    const container = document.getElementById('toasts');
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = `<span>${icon}</span> ${escapeHtml(message)}`;
    container.appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }

  // â”€â”€ Render â”€â”€
  function render() {
    const app = document.getElementById('app');
    app.innerHTML = renderHeader() + renderBoard() + (modal ? renderModal() : '');
    attachEvents();
  }

  function renderHeader() {
    return `
      <div class="header">
        <div class="header-left">
          <span class="logo-icon">ðŸ“‹</span>
          <span class="logo">Tiny Kanban</span>
        </div>
        <div class="header-right">
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            <input type="text" class="search-input" placeholder="Search cards..." value="${escapeHtml(searchQuery)}" id="searchInput" />
          </div>
          <button class="settings-btn" id="settingsBtn" title="WIP Limits">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          </button>
          <button class="btn btn-primary" id="addCardBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
            New Card
          </button>
        </div>
      </div>
      ${searchQuery ? `<div class="filter-bar" style="padding-top:12px;">
        <div class="filter-badge">
          Searching: "${escapeHtml(searchQuery)}"
          <button id="clearSearch"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
        </div>
      </div>` : ''}
    `;
  }

  function renderBoard() {
    return `<div class="board">${COLUMNS.map(col => renderColumn(col)).join('')}</div>`;
  }

  function renderColumn(col) {
    const cards = filteredCards(col.id);
    const totalCards = cardsInColumn(col.id).length;
    const wipLimit = state.wipLimits[col.id] || 0;
    const isOverWip = wipLimit > 0 && totalCards > wipLimit;
    const isAtWip = wipLimit > 0 && totalCards === wipLimit;

    return `
      <div class="column" data-column="${col.id}" id="col-${col.id}">
        <div class="column-header">
          <div class="column-title-group">
            <div class="column-dot" style="background:${col.color}"></div>
            <span class="column-title">${col.title}</span>
            <span class="column-count ${isOverWip ? 'wip-warning' : ''}">${totalCards}${wipLimit > 0 ? ' / ' + wipLimit : ''}</span>
          </div>
        </div>
        <div class="card-list" data-column="${col.id}" id="list-${col.id}">
          ${cards.length === 0 ? renderEmptyColumn(col) : cards.map(card => renderCard(card)).join('')}
        </div>
      </div>
    `;
  }

  function renderEmptyColumn(col) {
    return `
      <div class="empty-column">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M12 8v8M8 12h8"/></svg>
        <span>${searchQuery ? 'No matching cards' : 'Drop cards here'}</span>
      </div>
    `;
  }

  function renderCard(card) {
    const pri = PRIORITIES.find(p => p.id === card.priority) || PRIORITIES[4];
    return `
      <div class="card card-priority-${card.priority}" draggable="true" data-card-id="${card.id}">
        <div class="card-top-row">
          <span class="card-title">${highlightText(card.title, searchQuery)}</span>
          <div class="card-actions">
            <button class="card-action-btn edit-btn" data-card-id="${card.id}" title="Edit">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
            </button>
            <button class="card-action-btn delete" data-card-id="${card.id}" title="Delete">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
            </button>
          </div>
        </div>
        ${card.description ? `<div class="card-description">${highlightText(card.description, searchQuery)}</div>` : ''}
        <div class="card-footer">
          <div class="card-tags">
            <span class="priority-tag priority-tag-${card.priority}">${pri.label}</span>
            <span class="card-id">#${card.id}</span>
          </div>
          ${card.assignee ? `
            <div class="assignee-badge">
              <div class="avatar" style="background:${getAvatarColor(card.assignee)}">${getInitials(card.assignee)}</div>
              <span>${highlightText(card.assignee, searchQuery)}</span>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  function renderModal() {
    if (!modal) return '';
    if (modal.type === 'add' || modal.type === 'edit') return renderCardModal();
    if (modal.type === 'delete') return renderDeleteModal();
    if (modal.type === 'settings') return renderSettingsModal();
    return '';
  }

  function renderCardModal() {
    const isEdit = modal.type === 'edit';
    const card = isEdit ? modal.data : { title: '', description: '', column: 'todo', priority: 'medium', assignee: '' };

    return `
      <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
          <div class="modal-header">
            <span class="modal-title">${isEdit ? 'Edit Card' : 'New Card'}</span>
            <button class="modal-close" id="modalClose">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label" for="cardTitle">Title *</label>
              <input type="text" class="form-input" id="cardTitle" placeholder="What needs to be done?" value="${escapeHtml(card.title)}" autofocus />
            </div>
            <div class="form-group">
              <label class="form-label" for="cardDesc">Description</label>
              <textarea class="form-textarea" id="cardDesc" placeholder="Add more details...">${escapeHtml(card.description || '')}</textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="cardPriority">Priority</label>
                <select class="form-select" id="cardPriority">
                  ${PRIORITIES.map(p => `<option value="${p.id}" ${card.priority === p.id ? 'selected' : ''}>${p.label}</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="cardColumn">Column</label>
                <select class="form-select" id="cardColumn">
                  ${COLUMNS.map(c => `<option value="${c.id}" ${card.column === c.id ? 'selected' : ''}>${c.title}</option>`).join('')}
                </select>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="cardAssignee">Assignee</label>
              <select class="form-select" id="cardAssignee">
                <option value="">Unassigned</option>
                ${PEOPLE.map(p => `<option value="${p}" ${card.assignee === p ? 'selected' : ''}>${p}</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-cancel" id="modalCancel">Cancel</button>
            <button class="btn btn-primary" id="modalSave">${isEdit ? 'Save Changes' : 'Create Card'}</button>
          </div>
        </div>
      </div>
    `;
  }

  function renderDeleteModal() {
    const card = modal.data;
    return `
      <div class="modal-overlay" id="modalOverlay">
        <div class="modal" style="max-width:420px;">
          <div class="modal-header">
            <span class="modal-title">Delete Card</span>
            <button class="modal-close" id="modalClose">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="delete-confirm">
              <p class="card-title-preview">${escapeHtml(card.title)}</p>
              <p>Are you sure you want to delete this card? This action cannot be undone.</p>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-cancel" id="modalCancel">Cancel</button>
            <button class="btn btn-danger" id="confirmDelete">Delete</button>
          </div>
        </div>
      </div>
    `;
  }

  function renderSettingsModal() {
    return `
      <div class="modal-overlay" id="modalOverlay">
        <div class="modal" style="max-width:420px;">
          <div class="modal-header">
            <span class="modal-title">WIP Limits</span>
            <button class="modal-close" id="modalClose">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="modal-body">
            <p class="wip-hint">Set to 0 for unlimited. Exceeding the limit will show a warning.</p>
            ${COLUMNS.map(col => `
              <div class="wip-input-group">
                <label><span class="column-dot" style="background:${col.color};display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle;"></span>${col.title}</label>
                <input type="number" class="wip-input" min="0" max="50" value="${state.wipLimits[col.id] || 0}" data-wip-col="${col.id}" />
              </div>
            `).join('')}
          </div>
          <div class="modal-footer">
            <button class="btn btn-cancel" id="modalCancel">Cancel</button>
            <button class="btn btn-primary" id="saveSettings">Save</button>
          </div>
        </div>
      </div>
    `;
  }

  // â”€â”€ Events â”€â”€
  function attachEvents() {
    // Search
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('input', e => {
        searchQuery = e.target.value;
        render();
        // Re-focus and position cursor
        const si = document.getElementById('searchInput');
        if (si) { si.focus(); si.selectionStart = si.selectionEnd = si.value.length; }
      });
    }

    const clearSearch = document.getElementById('clearSearch');
    if (clearSearch) clearSearch.addEventListener('click', () => { searchQuery = ''; render(); });

    // Add card
    const addBtn = document.getElementById('addCardBtn');
    if (addBtn) addBtn.addEventListener('click', () => { modal = { type: 'add' }; render(); focusModalTitle(); });

    // Settings
    const settingsBtn = document.getElementById('settingsBtn');
    if (settingsBtn) settingsBtn.addEventListener('click', () => { modal = { type: 'settings' }; render(); });

    // Card actions
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const id = parseInt(btn.dataset.cardId);
        const card = state.cards.find(c => c.id === id);
        if (card) { modal = { type: 'edit', data: { ...card } }; render(); focusModalTitle(); }
      });
    });

    document.querySelectorAll('.card-action-btn.delete').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const id = parseInt(btn.dataset.cardId);
        const card = state.cards.find(c => c.id === id);
        if (card) { modal = { type: 'delete', data: card }; render(); }
      });
    });

    // Modal events
    attachModalEvents();

    // Drag & Drop
    attachDragEvents();

    // Keyboard shortcut
    document.addEventListener('keydown', handleKeydown);
  }

  function focusModalTitle() {
    requestAnimationFrame(() => {
      const titleInput = document.getElementById('cardTitle');
      if (titleInput) titleInput.focus();
    });
  }

  function attachModalEvents() {
    const overlay = document.getElementById('modalOverlay');
    const closeBtn = document.getElementById('modalClose');
    const cancelBtn = document.getElementById('modalCancel');
    const saveBtn = document.getElementById('modalSave');
    const deleteBtn = document.getElementById('confirmDelete');
    const settingsBtn = document.getElementById('saveSettings');

    const closeModal = () => { modal = null; render(); };

    if (overlay) overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeModal);

    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        const title = document.getElementById('cardTitle').value.trim();
        if (!title) { document.getElementById('cardTitle').focus(); return; }

        const cardData = {
          title,
          description: document.getElementById('cardDesc').value.trim(),
          priority: document.getElementById('cardPriority').value,
          column: document.getElementById('cardColumn').value,
          assignee: document.getElementById('cardAssignee').value
        };

        if (modal.type === 'edit') {
          const idx = state.cards.findIndex(c => c.id === modal.data.id);
          if (idx !== -1) {
            state.cards[idx] = { ...state.cards[idx], ...cardData };
            toast('Card updated');
          }
        } else {
          // Check WIP
          const wipLimit = state.wipLimits[cardData.column] || 0;
          const count = cardsInColumn(cardData.column).length;
          if (wipLimit > 0 && count >= wipLimit) {
            toast(`WIP limit reached for ${COLUMNS.find(c => c.id === cardData.column).title}!`, 'âš ï¸');
          }
          state.cards.push({ id: state.nextId++, ...cardData, createdAt: Date.now() });
          toast('Card created');
        }

        saveState();
        modal = null;
        render();
      });
    }

    if (deleteBtn) {
      deleteBtn.addEventListener('click', () => {
        state.cards = state.cards.filter(c => c.id !== modal.data.id);
        saveState();
        toast('Card deleted', 'ðŸ—‘');
        modal = null;
        render();
      });
    }

    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        document.querySelectorAll('.wip-input').forEach(input => {
          const col = input.dataset.wipCol;
          state.wipLimits[col] = Math.max(0, parseInt(input.value) || 0);
        });
        saveState();
        toast('WIP limits updated');
        modal = null;
        render();
      });
    }

    // Enter key in title field saves
    const titleInput = document.getElementById('cardTitle');
    if (titleInput) {
      titleInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (saveBtn) saveBtn.click();
        }
      });
    }
  }

  function handleKeydown(e) {
    if (e.key === 'Escape' && modal) { modal = null; render(); return; }
    // 'n' key to add new card (when not in input)
    if (e.key === 'n' && !modal && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'SELECT') {
      e.preventDefault();
      modal = { type: 'add' };
      render();
      focusModalTitle();
    }
    // '/' to focus search
    if (e.key === '/' && !modal && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
      e.preventDefault();
      const si = document.getElementById('searchInput');
      if (si) si.focus();
    }
  }

  // â”€â”€ Drag & Drop â”€â”€
  function attachDragEvents() {
    const cards = document.querySelectorAll('.card[draggable]');
    const lists = document.querySelectorAll('.card-list');

    cards.forEach(card => {
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragend', handleDragEnd);
    });

    lists.forEach(list => {
      list.addEventListener('dragover', handleDragOver);
      list.addEventListener('dragleave', handleDragLeave);
      list.addEventListener('drop', handleDrop);
    });
  }

  function handleDragStart(e) {
    const cardId = parseInt(e.currentTarget.dataset.cardId);
    dragState = { cardId };
    e.currentTarget.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', cardId);
  }

  function handleDragEnd(e) {
    e.currentTarget.classList.remove('dragging');
    document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over'));
    document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
    dragState = null;
  }

  function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';

    const list = e.currentTarget;
    const column = list.closest('.column');
    column.classList.add('drag-over');

    // Remove existing indicators
    document.querySelectorAll('.drop-indicator').forEach(el => el.remove());

    // Find the card we're hovering over
    const afterElement = getDragAfterElement(list, e.clientY);
    const indicator = document.createElement('div');
    indicator.className = 'drop-indicator';

    if (afterElement) {
      list.insertBefore(indicator, afterElement);
    } else {
      list.appendChild(indicator);
    }
  }

  function handleDragLeave(e) {
    const list = e.currentTarget;
    if (!list.contains(e.relatedTarget)) {
      list.closest('.column').classList.remove('drag-over');
      list.querySelectorAll('.drop-indicator').forEach(el => el.remove());
    }
  }

  function handleDrop(e) {
    e.preventDefault();
    if (!dragState) return;

    const list = e.currentTarget;
    const targetColumn = list.dataset.column;
    const cardId = dragState.cardId;
    const card = state.cards.find(c => c.id === cardId);
    if (!card) return;

    const fromColumn = card.column;

    // WIP limit check
    if (fromColumn !== targetColumn) {
      const wipLimit = state.wipLimits[targetColumn] || 0;
      const count = cardsInColumn(targetColumn).length;
      if (wipLimit > 0 && count >= wipLimit) {
        toast(`WIP limit reached for ${COLUMNS.find(c => c.id === targetColumn).title}!`, 'âš ï¸');
        // Still allow but warn
      }
    }

    // Determine position
    const afterElement = getDragAfterElement(list, e.clientY);
    let afterCardId = afterElement ? parseInt(afterElement.dataset.cardId) : null;

    // Remove card from current position
    state.cards = state.cards.filter(c => c.id !== cardId);

    // Update column
    card.column = targetColumn;

    // Insert at position
    if (afterCardId) {
      const idx = state.cards.findIndex(c => c.id === afterCardId);
      state.cards.splice(idx, 0, card);
    } else {
      state.cards.push(card);
    }

    saveState();

    // Clean up
    document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over'));
    document.querySelectorAll('.drop-indicator').forEach(el => el.remove());

    if (fromColumn !== targetColumn) {
      toast(`Moved to ${COLUMNS.find(c => c.id === targetColumn).title}`);
    }

    render();
  }

  function getDragAfterElement(list, y) {
    const cards = [...list.querySelectorAll('.card:not(.dragging)')];
    return cards.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        return { offset, element: child };
      }
      return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  // â”€â”€ Touch Drag Support â”€â”€
  let touchDrag = null;
  let touchClone = null;

  document.addEventListener('touchstart', e => {
    const card = e.target.closest('.card[draggable]');
    if (!card || e.target.closest('.card-action-btn')) return;

    const cardId = parseInt(card.dataset.cardId);
    const rect = card.getBoundingClientRect();
    const touch = e.touches[0];

    touchDrag = {
      cardId,
      startX: touch.clientX,
      startY: touch.clientY,
      offsetX: touch.clientX - rect.left,
      offsetY: touch.clientY - rect.top,
      started: false
    };
  }, { passive: true });

  document.addEventListener('touchmove', e => {
    if (!touchDrag) return;
    const touch = e.touches[0];

    if (!touchDrag.started) {
      const dx = Math.abs(touch.clientX - touchDrag.startX);
      const dy = Math.abs(touch.clientY - touchDrag.startY);
      if (dx < 10 && dy < 10) return;
      touchDrag.started = true;

      const origCard = document.querySelector(`.card[data-card-id="${touchDrag.cardId}"]`);
      if (origCard) {
        origCard.classList.add('dragging');
        touchClone = origCard.cloneNode(true);
        touchClone.classList.remove('dragging');
        touchClone.style.position = 'fixed';
        touchClone.style.width = origCard.offsetWidth + 'px';
        touchClone.style.zIndex = '9999';
        touchClone.style.pointerEvents = 'none';
        touchClone.style.opacity = '0.9';
        touchClone.style.transform = 'rotate(3deg) scale(1.05)';
        touchClone.style.boxShadow = '0 8px 32px rgba(0,0,0,0.4)';
        document.body.appendChild(touchClone);
      }
    }

    e.preventDefault();

    if (touchClone) {
      touchClone.style.left = (touch.clientX - touchDrag.offsetX) + 'px';
      touchClone.style.top = (touch.clientY - touchDrag.offsetY) + 'px';
    }

    // Highlight column under touch
    document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over'));
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    if (el) {
      const col = el.closest('.column');
      if (col) col.classList.add('drag-over');
    }
  }, { passive: false });

  document.addEventListener('touchend', e => {
    if (!touchDrag || !touchDrag.started) { touchDrag = null; return; }

    if (touchClone) {
      touchClone.remove();
      touchClone = null;
    }

    document.querySelectorAll('.card.dragging').forEach(c => c.classList.remove('dragging'));
    document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over'));

    const touch = e.changedTouches[0];
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    if (el) {
      const list = el.closest('.card-list');
      if (list) {
        const targetColumn = list.dataset.column;
        const card = state.cards.find(c => c.id === touchDrag.cardId);
        if (card && card.column !== targetColumn) {
          const wipLimit = state.wipLimits[targetColumn] || 0;
          const count = cardsInColumn(targetColumn).length;
          if (wipLimit > 0 && count >= wipLimit) {
            toast(`WIP limit reached for ${COLUMNS.find(c => c.id === targetColumn).title}!`, 'âš ï¸');
          }
          card.column = targetColumn;
          saveState();
          toast(`Moved to ${COLUMNS.find(c => c.id === targetColumn).title}`);
          render();
        }
      }
    }

    touchDrag = null;
  }, { passive: true });

  // â”€â”€ Init â”€â”€
  render();
})();
</script>
</body>
</html>