<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kinetic Typography Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&family=Dancing+Script:wght@400;700&family=Oswald:wght@300;400;500;600;700&family=Raleway:wght@100;200;300;400;500;600;700;800;900&family=Montserrat:wght@100;300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg-primary:#0c0c14;--bg-secondary:#13131d;--bg-tertiary:#1b1b28;--bg-panel:#151520;
--text-primary:#e4e4f0;--text-secondary:#8888a8;--text-muted:#555570;
--accent:#7c6cf0;--accent-hover:#8d7ff8;--accent-dim:rgba(124,108,240,0.12);--accent-glow:rgba(124,108,240,0.25);
--success:#22d3a8;--warning:#f0c060;--danger:#f06060;--info:#60a0f0;
--border:#252538;--border-light:#303048;
--radius:5px;--radius-lg:8px;
--shadow:0 8px 32px rgba(0,0,0,0.4);
--font-ui:'Inter',system-ui,-apple-system,sans-serif;
--timeline-h:240px;
}
@media(prefers-reduced-motion:reduce){
*{animation-duration:0.01ms!important;transition-duration:0.01ms!important}
.text-element .char,.text-element .word{transform:none!important;opacity:1!important}
}
html,body{height:100%;overflow:hidden;font-family:var(--font-ui);background:var(--bg-primary);color:var(--text-primary);font-size:13px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
button,input,select,textarea{font-family:inherit;font-size:inherit;color:inherit;background:none;border:none;outline:none}
button{cursor:pointer}
input[type="range"]{-webkit-appearance:none;appearance:none;height:3px;background:var(--border);border-radius:2px;cursor:pointer;flex:1}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;background:var(--accent);border:2px solid var(--bg-primary);cursor:pointer;box-shadow:0 0 4px rgba(124,108,240,0.3)}
input[type="range"]::-webkit-slider-thumb:hover{background:var(--accent-hover);box-shadow:0 0 8px rgba(124,108,240,0.5)}
select{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius);padding:4px 8px;cursor:pointer}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--border-light)}
::selection{background:var(--accent-dim);color:var(--accent)}

#app{display:grid;grid-template-rows:42px 1fr var(--timeline-h);grid-template-columns:250px 1fr 270px;height:100vh;width:100vw}
#toolbar{grid-column:1/-1;display:flex;align-items:center;padding:0 10px;background:var(--bg-secondary);border-bottom:1px solid var(--border);gap:6px;z-index:100}
#left-panel{grid-row:2;display:flex;flex-direction:column;background:var(--bg-panel);border-right:1px solid var(--border);overflow-y:auto;overflow-x:hidden}
#canvas-area{grid-row:2;position:relative;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at center,#12121e 0%,#0a0a12 100%);overflow:hidden}
#right-panel{grid-row:2;display:flex;flex-direction:column;background:var(--bg-panel);border-left:1px solid var(--border);overflow-y:auto;overflow-x:hidden}
#timeline{grid-column:1/-1;grid-row:3;background:var(--bg-secondary);border-top:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}

.toolbar-group{display:flex;align-items:center;gap:3px}
.toolbar-sep{width:1px;height:22px;background:var(--border);margin:0 5px}
.toolbar-btn{display:flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:var(--radius);transition:all .15s}
.toolbar-btn:hover{background:var(--bg-tertiary)}
.toolbar-btn.active{background:var(--accent-dim);color:var(--accent)}
.toolbar-btn svg{width:16px;height:16px}
.logo{font-weight:800;font-size:13px;letter-spacing:-0.3px;margin-right:10px;background:linear-gradient(135deg,var(--accent),var(--success));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap;user-select:none}

.panel-section{padding:12px;border-bottom:1px solid var(--border)}
.panel-section-title{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between}
.panel-row{display:flex;align-items:center;gap:6px;margin-bottom:7px}
.panel-row:last-child{margin-bottom:0}
.panel-row label{font-size:11px;color:var(--text-secondary);min-width:56px;flex-shrink:0}
.panel-row input[type="text"],.panel-row input[type="number"]{width:100%;padding:4px 7px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius);font-size:11px;transition:border-color .15s}
.panel-row input[type="text"]:focus,.panel-row input[type="number"]:focus{border-color:var(--accent)}
.panel-row input[type="number"]{width:56px}
.panel-row select{width:100%;font-size:11px}
.panel-row input[type="color"]{width:28px;height:24px;border:1px solid var(--border);border-radius:var(--radius);padding:1px;cursor:pointer;flex-shrink:0}
.panel-val{font-size:10px;color:var(--text-muted);min-width:32px;text-align:right;font-family:'Space Mono',monospace}

.btn{padding:5px 12px;border-radius:var(--radius);font-size:11px;font-weight:500;transition:all .15s;white-space:nowrap;display:inline-flex;align-items:center;gap:4px}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent-hover);box-shadow:0 2px 12px var(--accent-glow)}
.btn-secondary{background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary)}
.btn-secondary:hover{border-color:var(--border-light);background:var(--border)}
.btn-sm{padding:3px 8px;font-size:10px}
.btn-icon{width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;border-radius:var(--radius);transition:all .15s;flex-shrink:0}
.btn-icon:hover{background:var(--bg-tertiary)}

#canvas-wrapper{position:relative;background:#000;overflow:hidden;box-shadow:0 0 0 1px var(--border),var(--shadow);border-radius:2px}
#canvas-stage{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.safe-area-guide{position:absolute;border:1px dashed rgba(124,108,240,0.25);pointer-events:none;z-index:5}
.grid-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:4;opacity:0.12}
.aspect-label{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.7);color:var(--text-muted);font-size:9px;padding:2px 6px;border-radius:3px;z-index:6;font-family:'Space Mono',monospace;letter-spacing:0.5px}

.text-element{position:absolute;cursor:move;user-select:none;white-space:pre-wrap;word-break:break-word;pointer-events:auto}
.text-element.selected{outline:1.5px solid var(--accent);outline-offset:6px}
.text-element .char,.text-element .word{display:inline-block;will-change:transform,opacity}

#timeline-controls{display:flex;align-items:center;padding:5px 10px;gap:6px;border-bottom:1px solid var(--border);flex-shrink:0;background:rgba(0,0,0,0.15)}
#timeline-controls .time-display{font-family:'Space Mono',monospace;font-size:11px;color:var(--text-secondary);min-width:140px;letter-spacing:-0.3px}
#timeline-body{display:flex;flex:1;overflow:hidden}
#timeline-labels{width:150px;flex-shrink:0;border-right:1px solid var(--border);overflow-y:auto;background:rgba(0,0,0,0.1)}
#timeline-tracks{flex:1;position:relative;overflow:auto}
.timeline-label{height:28px;display:flex;align-items:center;padding:0 8px;font-size:10px;border-bottom:1px solid rgba(37,37,56,0.6);gap:4px}
.timeline-label.header{font-weight:600;font-size:11px;background:rgba(124,108,240,0.04);color:var(--text-primary)}
.timeline-label .prop-name{color:var(--text-muted)}
.timeline-track{height:28px;position:relative;border-bottom:1px solid rgba(37,37,56,0.6)}
.timeline-track.header{background:rgba(124,108,240,0.03)}
.keyframe-diamond{position:absolute;width:9px;height:9px;background:var(--accent);transform:rotate(45deg) translateY(-50%);top:50%;cursor:pointer;z-index:2;border-radius:1px;transition:all .12s}
.keyframe-diamond:hover{background:var(--warning);box-shadow:0 0 10px rgba(240,192,96,0.4);transform:rotate(45deg) translateY(-50%) scale(1.3)}
#playhead{position:absolute;top:0;bottom:0;width:1.5px;background:var(--danger);z-index:10;pointer-events:none}
#playhead::before{content:'';position:absolute;top:-1px;left:-5px;width:11px;height:6px;background:var(--danger);clip-path:polygon(0 0,100% 0,50% 100%);pointer-events:auto;cursor:col-resize}
#timeline-ruler{height:22px;position:relative;background:var(--bg-tertiary);border-bottom:1px solid var(--border);flex-shrink:0;cursor:pointer;overflow:hidden}
.ruler-mark{position:absolute;bottom:0;width:1px;background:var(--border)}
.ruler-label{position:absolute;bottom:8px;font-size:8px;color:var(--text-muted);transform:translateX(-50%);font-family:'Space Mono',monospace}
.beat-marker{position:absolute;top:0;bottom:0;width:1px;background:rgba(34,211,168,0.25);z-index:1;pointer-events:none}
.anim-region{position:absolute;top:2px;bottom:2px;background:linear-gradient(90deg,rgba(124,108,240,0.08),rgba(124,108,240,0.15),rgba(124,108,240,0.08));border:1px solid rgba(124,108,240,0.2);border-radius:3px;pointer-events:auto;cursor:ew-resize}

.preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.preset-card{padding:7px 4px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;text-align:center;font-size:10px;transition:all .15s;font-weight:500}
.preset-card:hover{border-color:var(--accent);background:var(--accent-dim);transform:translateY(-1px)}
.preset-card.active{border-color:var(--accent);background:var(--accent-dim);box-shadow:0 0 12px var(--accent-glow)}

.easing-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px}
.easing-btn{padding:3px 2px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:8px;text-align:center;transition:all .15s;color:var(--text-muted)}
.easing-btn:hover,.easing-btn.active{border-color:var(--accent);color:var(--accent)}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.65);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(6px)}
.modal{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;min-width:380px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,0.6)}
.modal h2{font-size:15px;margin-bottom:16px;font-weight:600}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px}

.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);padding:8px 18px;border-radius:var(--radius-lg);font-size:11px;z-index:2000;animation:toastIn .3s cubic-bezier(0.16,1,0.3,1);box-shadow:0 8px 24px rgba(0,0,0,0.3);font-weight:500}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(12px) scale(0.95)}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}

.tab-bar{display:flex;border-bottom:1px solid var(--border);background:rgba(0,0,0,0.15)}
.tab-btn{padding:7px 12px;font-size:10px;font-weight:500;color:var(--text-muted);border-bottom:2px solid transparent;transition:all .15s;text-transform:uppercase;letter-spacing:0.5px}
.tab-btn:hover{color:var(--text-secondary)}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-content{display:none}
.tab-content.active{display:block}

#waveform-canvas{width:100%;height:50px;cursor:pointer;border-radius:var(--radius)}

.el-item{padding:6px 8px;margin-bottom:3px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:space-between;transition:all .12s;gap:6px}
.el-item:hover{border-color:var(--border-light)}
.el-item.active{border-color:var(--accent);background:var(--accent-dim)}
.el-item .el-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.el-item .el-visibility{opacity:0.4;cursor:pointer;font-size:14px}
.el-item .el-visibility:hover{opacity:1}

.shortcut-hint{font-size:9px;color:var(--text-muted);background:var(--bg-tertiary);padding:1px 4px;border-radius:2px;border:1px solid var(--border);font-family:'Space Mono',monospace}

@media(max-width:1100px){#app{grid-template-columns:220px 1fr 240px}}
@media(max-width:860px){
#app{grid-template-columns:1fr;grid-template-rows:42px 1fr var(--timeline-h)}
#left-panel,#right-panel{display:none}
#left-panel.mobile-open,#right-panel.mobile-open{display:flex;position:fixed;top:42px;bottom:0;width:280px;z-index:50;box-shadow:4px 0 20px rgba(0,0,0,0.4)}
#left-panel.mobile-open{left:0}
#right-panel.mobile-open{right:0}
}
:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}

.kf-btn-row{display:flex;flex-wrap:wrap;gap:3px}
.kf-btn-row .btn{flex:1;min-width:50px;justify-content:center}
</style>
</head>
<body>
<div id="app">
<div id="toolbar" role="toolbar" aria-label="Main toolbar">
<div class="logo">KINETIC STUDIO</div>
<div class="toolbar-group">
<button class="toolbar-btn" id="btn-add-text" title="Add Text (T)" aria-label="Add text element"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg></button>
<button class="toolbar-btn" id="btn-duplicate" title="Duplicate (Ctrl+D)" aria-label="Duplicate selected"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="8" y="8" width="12" height="12" rx="2"/><path d="M16 8V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2"/></svg></button>
<button class="toolbar-btn" id="btn-delete" title="Delete (Del)" aria-label="Delete selected"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg></button>
</div>
<div class="toolbar-sep"></div>
<div class="toolbar-group">
<select id="aspect-select" aria-label="Aspect ratio"><option value="16:9">16:9</option><option value="9:16">9:16</option><option value="1:1">1:1</option><option value="4:3">4:3</option></select>
<select id="resolution-select" aria-label="Resolution"><option value="1920x1080">1920×1080</option><option value="1080x1920">1080×1920</option><option value="1080x1080">1080×1080</option><option value="3840x2160">4K UHD</option><option value="1280x720">720p</option></select>
</div>
<div class="toolbar-sep"></div>
<div class="toolbar-group">
<button class="toolbar-btn" id="btn-grid" title="Toggle Grid (G)" aria-label="Toggle grid"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18"/></svg></button>
<button class="toolbar-btn" id="btn-safe" title="Safe Areas (S)" aria-label="Toggle safe area guides"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><rect x="5" y="5" width="14" height="14" rx="1" stroke-dasharray="3 2"/></svg></button>
</div>
<div style="flex:1"></div>
<div class="toolbar-group" style="gap:8px">
<button class="toolbar-btn" id="btn-audio" title="Load Audio" aria-label="Load audio file"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></button>
<button class="toolbar-btn" id="btn-undo" title="Undo (Ctrl+Z)" aria-label="Undo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"/><path d="M3 13A9 9 0 0 1 15.36 5.36L21 8"/></svg></button>
<div class="toolbar-sep"></div>
<button class="btn btn-primary" id="btn-export" aria-label="Export animation"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Export</button>
</div>
</div>

<div id="left-panel" role="complementary" aria-label="Elements and presets">
<div class="tab-bar">
<button class="tab-btn active" data-tab="elements-tab" aria-selected="true" role="tab">Elements</button>
<button class="tab-btn" data-tab="presets-tab" aria-selected="false" role="tab">Presets</button>
<button class="tab-btn" data-tab="audio-tab" aria-selected="false" role="tab">Audio</button>
</div>
<div id="elements-tab" class="tab-content active" role="tabpanel">
<div class="panel-section">
<div class="panel-section-title">Layers <button class="btn-icon" id="btn-add-text-2" aria-label="Add text" style="font-size:16px;color:var(--accent)">+</button></div>
<div id="elements-list"></div>
<div id="elements-empty" style="color:var(--text-muted);font-size:11px;text-align:center;padding:16px 0">Press <span class="shortcut-hint">T</span> to add text</div>
</div>
</div>
<div id="presets-tab" class="tab-content" role="tabpanel">
<div class="panel-section">
<div class="panel-section-title">Animation Presets</div>
<div class="preset-grid" id="preset-grid"></div>
</div>
<div class="panel-section">
<div class="panel-section-title">Stagger Controls</div>
<div class="panel-row"><label>Mode</label><select id="stagger-mode"><option value="letter">By Letter</option><option value="word">By Word</option><option value="line">By Line</option></select></div>
<div class="panel-row"><label>Delay</label><input type="range" id="stagger-delay" min="0" max="300" value="50"><span class="panel-val" id="stagger-delay-val">50ms</span></div>
<div class="panel-row"><label>Direction</label><select id="stagger-dir"><option value="forward">Forward</option><option value="backward">Backward</option><option value="center">From Center</option><option value="random">Random</option></select></div>
</div>
<div class="panel-section">
<div class="panel-section-title">Easing Curve</div>
<div class="easing-grid" id="easing-grid"></div>
<div style="margin-top:10px;display:flex;align-items:flex-start;gap:10px">
<canvas id="bezier-canvas" width="140" height="140" style="border:1px solid var(--border);border-radius:var(--radius);cursor:crosshair;flex-shrink:0" aria-label="Custom bezier curve editor"></canvas>
<div style="font-size:10px;color:var(--text-muted);line-height:1.5">Drag the control points to create a custom easing curve.<br><br><span style="color:#22d3a8">●</span> Start handle<br><span style="color:#f0c060">●</span> End handle</div>
</div>
</div>
</div>
<div id="audio-tab" class="tab-content" role="tabpanel">
<div class="panel-section">
<div class="panel-section-title">Audio Reactive</div>
<div class="panel-row"><button class="btn btn-secondary" id="btn-load-audio" style="width:100%"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg> Load Audio File</button></div>
<input type="file" id="audio-file-input" accept="audio/*" style="display:none">
<div id="audio-info" style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;display:none;padding:4px 8px;background:var(--bg-tertiary);border-radius:var(--radius)"></div>
<canvas id="waveform-canvas" style="display:none" aria-label="Audio waveform"></canvas>
<div class="panel-row" style="margin-top:8px"><label>Sensitivity</label><input type="range" id="beat-sensitivity" min="10" max="100" value="60"><span class="panel-val" id="beat-sens-val">60</span></div>
<div class="panel-row"><button class="btn btn-primary btn-sm" id="btn-snap-beats" disabled style="width:100%">Snap Keyframes to Beats</button></div>
<div id="beats-info" style="font-size:10px;color:var(--text-muted);margin-top:4px"></div>
</div>
</div>
</div>

<div id="canvas-area">
<div id="canvas-wrapper">
<div id="canvas-stage"></div>
<div id="grid-overlay" class="grid-overlay" style="display:none"></div>
<div id="safe-area-action" class="safe-area-guide" style="display:none"></div>
<div id="safe-area-title" class="safe-area-guide" style="display:none"></div>
<div class="aspect-label" id="aspect-label">16:9</div>
</div>
</div>

<div id="right-panel" role="complementary" aria-label="Properties">
<div class="tab-bar">
<button class="tab-btn active" data-tab="style-tab" aria-selected="true" role="tab">Style</button>
<button class="tab-btn" data-tab="transform-tab" aria-selected="false" role="tab">Transform</button>
<button class="tab-btn" data-tab="layout-tab" aria-selected="false" role="tab">Layout</button>
</div>
<div id="no-selection" style="padding:24px 16px;text-align:center;color:var(--text-muted);font-size:11px;line-height:1.6">Select a text element to edit its properties.<br><br><span class="shortcut-hint">T</span> Add text &nbsp; <span class="shortcut-hint">Space</span> Play</div>
<div id="style-tab" class="tab-content active" role="tabpanel">
<div class="panel-section">
<div class="panel-section-title">Typography</div>
<div class="panel-row"><label>Text</label><input type="text" id="prop-text" value="" placeholder="Enter text..." style="flex:1"></div>
<div class="panel-row"><label>Font</label><select id="prop-font" style="flex:1"><option value="Inter">Inter</option><option value="Montserrat">Montserrat</option><option value="Poppins">Poppins</option><option value="Playfair Display">Playfair Display</option><option value="Space Mono">Space Mono</option><option value="Bebas Neue">Bebas Neue</option><option value="Dancing Script">Dancing Script</option><option value="Oswald">Oswald</option><option value="Raleway">Raleway</option><option value="Georgia">Georgia</option><option value="Arial">Arial</option><option value="Courier New">Courier New</option><option value="system-ui">System UI</option></select></div>
<div class="panel-row"><label>Size</label><input type="number" id="prop-size" value="72" min="8" max="500" step="1"><span class="panel-val">px</span></div>
<div class="panel-row"><label>Weight</label><select id="prop-weight"><option value="100">Thin</option><option value="200">ExtraLight</option><option value="300">Light</option><option value="400">Regular</option><option value="500">Medium</option><option value="600">SemiBold</option><option value="700" selected>Bold</option><option value="800">ExtraBold</option><option value="900">Black</option></select></div>
<div class="panel-row"><label>Italic</label><input type="checkbox" id="prop-italic"><span style="font-size:10px;color:var(--text-muted);margin-left:auto">Tracking</span><input type="number" id="prop-tracking-num" value="0" min="-20" max="100" style="width:44px"></div>
<div class="panel-row"><label>Leading</label><input type="range" id="prop-leading" min="0.5" max="3" value="1.2" step="0.05"><span class="panel-val" id="prop-leading-val">1.20</span></div>
<div class="panel-row"><label>Align</label>
<div style="display:flex;gap:2px">
<button class="btn-icon align-btn" data-align="left" aria-label="Align left"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg></button>
<button class="btn-icon align-btn active" data-align="center" aria-label="Align center"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg></button>
<button class="btn-icon align-btn" data-align="right" aria-label="Align right"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg></button>
</div>
</div>
</div>
<div class="panel-section">
<div class="panel-section-title">Color & Effects</div>
<div class="panel-row"><label>Fill</label><input type="color" id="prop-fill" value="#ffffff"><input type="text" id="prop-fill-hex" value="#ffffff" style="width:70px;font-size:10px;font-family:'Space Mono',monospace"></div>
<div class="panel-row"><label>Stroke</label><input type="color" id="prop-stroke" value="#000000"><input type="number" id="prop-stroke-w" value="0" min="0" max="20" step="0.5" style="width:44px"><span class="panel-val">px</span></div>
<div class="panel-row"><label>Shadow</label><input type="color" id="prop-shadow-color" value="#000000"><input type="number" id="prop-shadow-x" value="0" min="-50" max="50" style="width:36px" placeholder="X"><input type="number" id="prop-shadow-y" value="4" min="-50" max="50" style="width:36px" placeholder="Y"><input type="number" id="prop-shadow-blur" value="8" min="0" max="100" style="width:36px" placeholder="Blur"></div>
<div class="panel-row"><label>Gradient</label><input type="checkbox" id="prop-gradient"><input type="color" id="prop-grad-start" value="#7c6cf0"><input type="color" id="prop-grad-end" value="#22d3a8"><select id="prop-grad-dir" style="width:60px"><option value="135">↘</option><option value="0">→</option><option value="90">↓</option><option value="180">←</option><option value="270">↑</option><option value="45">↗</option></select></div>
<div class="panel-row"><label>Blur</label><input type="checkbox" id="prop-motion-blur"><span style="font-size:10px;color:var(--text-muted)">Motion blur (playback only)</span></div>
</div>
<div class="panel-section">
<div class="panel-section-title">Background</div>
<div class="panel-row"><label>Color</label><input type="color" id="bg-color" value="#000000"><input type="text" id="bg-color-hex" value="#000000" style="width:70px;font-size:10px;font-family:'Space Mono',monospace"></div>
<div class="panel-row"><label>Image</label><button class="btn btn-secondary btn-sm" id="btn-bg-image">Browse...</button><button class="btn-icon" id="btn-bg-clear" title="Clear" aria-label="Clear background image" style="font-size:12px">✕</button><span id="bg-image-name" style="font-size:10px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1"></span></div>
<input type="file" id="bg-image-input" accept="image/*" style="display:none">
</div>
</div>
<div id="transform-tab" class="tab-content" role="tabpanel">
<div class="panel-section">
<div class="panel-section-title">Position & Transform</div>
<div class="panel-row"><label>X</label><input type="number" id="prop-x" value="0" step="1" style="flex:1"><label style="min-width:20px;text-align:center">Y</label><input type="number" id="prop-y" value="0" step="1" style="flex:1"></div>
<div class="panel-row"><label>Scale</label><input type="range" id="prop-scale" min="0.05" max="5" value="1" step="0.01"><span class="panel-val" id="prop-scale-val">1.00</span></div>
<div class="panel-row"><label>Rotation</label><input type="range" id="prop-rotation" min="-360" max="360" value="0" step="0.5"><span class="panel-val" id="prop-rotation-val">0°</span></div>
<div class="panel-row"><label>Opacity</label><input type="range" id="prop-opacity" min="0" max="1" value="1" step="0.01"><span class="panel-val" id="prop-opacity-val">1.00</span></div>
</div>
<div class="panel-section">
<div class="panel-section-title">Add Keyframes <span class="shortcut-hint" style="font-weight:400">K</span></div>
<div class="kf-btn-row">
<button class="btn btn-secondary btn-sm kf-btn" data-prop="x">X</button>
<button class="btn btn-secondary btn-sm kf-btn" data-prop="y">Y</button>
<button class="btn btn-secondary btn-sm kf-btn" data-prop="scale">Scale</button>
<button class="btn btn-secondary btn-sm kf-btn" data-prop="rotation">Rot</button>
<button class="btn btn-secondary btn-sm kf-btn" data-prop="opacity">Alpha</button>
<button class="btn btn-secondary btn-sm kf-btn" data-prop="tracking">Track</button>
</div>
<button class="btn btn-primary" id="btn-kf-all" style="width:100%;margin-top:6px;justify-content:center">Add All Keyframes at Playhead</button>
</div>
<div class="panel-section">
<div class="panel-section-title">Animation Timing</div>
<div class="panel-row"><label>Start</label><input type="number" id="prop-anim-start" value="0" min="0" step="0.1" style="flex:1"><span class="panel-val">s</span></div>
<div class="panel-row"><label>Duration</label><input type="number" id="prop-anim-dur" value="1.5" min="0.1" step="0.1" style="flex:1"><span class="panel-val">s</span></div>
</div>
</div>
<div id="layout-tab" class="tab-content" role="tabpanel">
<div class="panel-section">
<div class="panel-section-title">Canvas Settings</div>
<div class="panel-row"><label>Width</label><input type="number" id="layout-w" value="1920" min="100" max="7680" step="2"><label style="min-width:20px;text-align:center">×</label><input type="number" id="layout-h" value="1080" min="100" max="4320" step="2"></div>
</div>
<div class="panel-section">
<div class="panel-section-title">Guides & Grid</div>
<div class="panel-row"><label>Grid</label><input type="checkbox" id="layout-grid"><select id="layout-grid-size" style="width:70px"><option value="3">3×3</option><option value="4">4×4</option><option value="6">6×6</option><option value="8" selected>8×8</option><option value="12">12×12</option></select></div>
<div class="panel-row"><label>Safe Areas</label><input type="checkbox" id="layout-safe"></div>
<div class="panel-row"><label>Margins</label><input type="range" id="layout-margins" min="0" max="20" value="5"><span class="panel-val" id="layout-margins-val">5%</span></div>
</div>
<div class="panel-section">
<div class="panel-section-title">Playback</div>
<div class="panel-row"><label>FPS</label><select id="layout-fps"><option value="24">24 fps</option><option value="30" selected>30 fps</option><option value="60">60 fps</option></select></div>
<div class="panel-row"><label>Duration</label><input type="number" id="layout-duration" value="5" min="0.5" max="120" step="0.5"><span class="panel-val">sec</span></div>
</div>
<div class="panel-section">
<div class="panel-section-title">Keyboard Shortcuts</div>
<div style="font-size:10px;color:var(--text-muted);line-height:2">
<span class="shortcut-hint">Space</span> Play/Pause &nbsp;
<span class="shortcut-hint">T</span> Add Text<br>
<span class="shortcut-hint">K</span> Add Keyframes &nbsp;
<span class="shortcut-hint">G</span> Grid<br>
<span class="shortcut-hint">Del</span> Delete &nbsp;
<span class="shortcut-hint">←→</span> Step Frame<br>
<span class="shortcut-hint">Home</span> Go to Start &nbsp;
<span class="shortcut-hint">End</span> Go to End<br>
<span class="shortcut-hint">Ctrl+D</span> Duplicate &nbsp;
<span class="shortcut-hint">Ctrl+Z</span> Undo
</div>
</div>
</div>
</div>

<div id="timeline" role="region" aria-label="Timeline editor">
<div id="timeline-controls">
<button class="btn-icon" id="btn-to-start" title="Go to Start (Home)" aria-label="Go to start"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 20L9 12l10-8"/><path d="M5 19V5"/></svg></button>
<button class="btn-icon" id="btn-prev-frame" title="Previous Frame (←)" aria-label="Previous frame"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
<button class="btn-icon" id="btn-play" title="Play/Pause (Space)" aria-label="Play or pause" style="width:32px;height:32px;background:var(--accent-dim);border-radius:50%">
<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" id="play-icon"><polygon points="6,3 20,12 6,21"/></svg>
<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" id="pause-icon" style="display:none"><rect x="5" y="3" width="5" height="18" rx="1"/><rect x="14" y="3" width="5" height="18" rx="1"/></svg>
</button>
<button class="btn-icon" id="btn-next-frame" title="Next Frame (→)" aria-label="Next frame"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
<button class="btn-icon" id="btn-to-end" title="Go to End (End)" aria-label="Go to end"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 4l10 8-10 8"/><path d="M19 5v14"/></svg></button>
<span class="time-display" id="time-display" aria-live="polite">0:00.00 / 0:05.00</span>
<div style="flex:1"></div>
<label style="font-size:10px;color:var(--text-secondary);display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="btn-loop" style="cursor:pointer"> Loop</label>
<div class="toolbar-sep" style="height:18px"></div>
<button class="btn-icon" id="btn-zoom-out" title="Zoom Out" aria-label="Zoom out timeline"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
<span id="zoom-level" style="font-size:9px;color:var(--text-muted);min-width:28px;text-align:center;font-family:'Space Mono',monospace">100</span>
<button class="btn-icon" id="btn-zoom-in" title="Zoom In" aria-label="Zoom in timeline"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
</div>
<div id="timeline-body">
<div id="timeline-labels"></div>
<div id="timeline-tracks-wrapper" style="flex:1;display:flex;flex-direction:column;overflow:hidden">
<div id="timeline-ruler" aria-label="Timeline ruler"></div>
<div id="timeline-tracks" style="flex:1;position:relative;overflow:auto"></div>
</div>
</div>
</div>
</div>

<div id="export-modal" class="modal-overlay" style="display:none" role="dialog" aria-label="Export settings" aria-modal="true">
<div class="modal">
<h2>Export Animation</h2>
<div class="panel-row"><label>Format</label><select id="export-format"><option value="webm">WebM Video</option><option value="gif">GIF (frames)</option><option value="png">PNG Sequence</option></select></div>
<div class="panel-row"><label>Scale</label><select id="export-res"><option value="0.5">0.5× (Half)</option><option value="1" selected>1× (Original)</option><option value="2">2× (Double)</option></select></div>
<div class="panel-row"><label>FPS</label><select id="export-fps"><option value="24">24 fps</option><option value="30" selected>30 fps</option><option value="60">60 fps</option></select></div>
<div id="export-progress" style="display:none;margin-top:12px">
<div style="height:3px;background:var(--border);border-radius:2px;overflow:hidden"><div id="export-bar" style="height:100%;background:linear-gradient(90deg,var(--accent),var(--success));width:0%;transition:width .15s"></div></div>
<div id="export-status" style="font-size:10px;color:var(--text-secondary);margin-top:6px">Preparing...</div>
</div>
<div class="modal-actions">
<button class="btn btn-secondary" id="export-cancel">Cancel</button>
<button class="btn btn-primary" id="export-start">Start Export</button>
</div>
</div>
</div>

<script>
// ===================== STATE =====================
const S = {
  elements: [], selectedId: null, currentTime: 0, duration: 5, fps: 30,
  playing: false, loop: false, canvasW: 1920, canvasH: 1080,
  bgColor: '#000000', bgImage: null, bgImageEl: null,
  showGrid: false, gridSize: 8, showSafeAreas: false, margins: 5,
  zoom: 120, audioCtx: null, audioBuffer: null, audioSource: null, beats: [],
  reducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches,
  history: [], historyIdx: -1
};
let nextId = 1, animFrame = null, lastPlayTime = 0;
let glitchSeed = 0;

// ===================== EASINGS =====================
const E = {
  'linear': t=>t,
  'ease-in': t=>t*t*t,
  'ease-out': t=>1-Math.pow(1-t,3),
  'ease-io': t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2,
  'in-quad': t=>t*t,
  'out-quad': t=>t*(2-t),
  'in-quart': t=>t*t*t*t,
  'out-quart': t=>1-(--t)*t*t*t,
  'out-back': t=>{const c=1.70158,c3=c+1;return 1+c3*Math.pow(t-1,3)+c*Math.pow(t-1,2);},
  'out-elastic': t=>{if(t===0||t===1)return t;return Math.pow(2,-10*t)*Math.sin((t-.075)*2*Math.PI/.3)+1;},
  'out-bounce': t=>{const n=7.5625,d=2.75;if(t<1/d)return n*t*t;if(t<2/d)return n*(t-=1.5/d)*t+.75;if(t<2.5/d)return n*(t-=2.25/d)*t+.9375;return n*(t-=2.625/d)*t+.984375;},
  'custom': null
};
let customBez = [.42,0,.58,1];
function cubicBez(x1,y1,x2,y2){
  return t=>{
    if(t<=0)return 0;if(t>=1)return 1;
    let lo=0,hi=1;
    for(let i=0;i<24;i++){const m=(lo+hi)/2;const x=3*(1-m)*(1-m)*m*x1+3*(1-m)*m*m*x2+m*m*m;if(x<t)lo=m;else hi=m;}
    const tt=(lo+hi)/2;return 3*(1-tt)*(1-tt)*tt*y1+3*(1-tt)*tt*tt*y2+tt*tt*tt;
  };
}
function getEase(name){if(name==='custom')return cubicBez(...customBez);return E[name]||E['ease-out'];}

// ===================== PRESETS =====================
const Presets = {
  'typewriter':{name:'Typewriter',stagger:'letter',delay:60,dir:'forward',
    fn:t=>({opacity:t<.01?0:1}),easing:'linear'},
  'fade-up':{name:'Fade Up',stagger:'word',delay:80,dir:'forward',
    fn:t=>({opacity:Math.min(1,t*1.5),y:40*(1-E['out-quad'](t))}),easing:'ease-out'},
  'bounce':{name:'Bounce',stagger:'letter',delay:50,dir:'forward',
    fn:t=>({opacity:Math.min(1,t*3),y:-60*(1-E['out-bounce'](t)),scaleX:1,scaleY:.5+.5*E['out-bounce'](t)}),easing:'linear'},
  'cascade':{name:'Cascade',stagger:'letter',delay:35,dir:'forward',
    fn:t=>({opacity:E['out-quad'](t),y:25*(1-E['out-quad'](t)),rotation:-12*(1-E['out-quad'](t))}),easing:'ease-out'},
  'glitch':{name:'Glitch',stagger:'letter',delay:25,dir:'random',
    fn:(t,seed)=>{const r=Math.sin(seed*9301+49297)*.5+.5;return{opacity:t<.1?(r>.5?1:0):(t<.25?(r>.3?1:0):1),x:t<.25?(r-.5)*30:0,y:t<.25?(r-.5)*15:0};},easing:'linear'},
  'liquid':{name:'Liquid',stagger:'letter',delay:55,dir:'center',
    fn:t=>({opacity:E['out-quad'](t),scaleX:t<.5?.4+1.2*t:1,scaleY:t<.5?.4+1.2*t:1,y:t<.5?18*(1-2*t):0,rotation:t<.5?6*Math.sin(t*Math.PI*4):0}),easing:'ease-io'},
  'scale-up':{name:'Scale Up',stagger:'word',delay:100,dir:'forward',
    fn:t=>({opacity:E['out-quad'](t),scaleX:.2+.8*E['out-back'](t),scaleY:.2+.8*E['out-back'](t)}),easing:'ease-out'},
  'rotate-in':{name:'Rotate In',stagger:'letter',delay:35,dir:'forward',
    fn:t=>({opacity:E['out-quad'](t),rotation:120*(1-E['out-quart'](t)),scaleX:.3+.7*t,scaleY:.3+.7*t}),easing:'ease-out'},
  'elastic':{name:'Elastic',stagger:'word',delay:90,dir:'forward',
    fn:t=>({opacity:Math.min(1,t*2.5),scaleX:E['out-elastic'](t),scaleY:E['out-elastic'](t)}),easing:'linear'},
  'wave':{name:'Wave',stagger:'letter',delay:45,dir:'forward',
    fn:t=>({opacity:1,y:-22*Math.sin(t*Math.PI*2.5)*(1-t)}),easing:'linear'},
  'fade-scale':{name:'Fade Scale',stagger:'letter',delay:30,dir:'center',
    fn:t=>({opacity:E['out-quad'](t),scaleX:.6+.4*E['out-quad'](t),scaleY:.6+.4*E['out-quad'](t)}),easing:'ease-out'},
};

// ===================== ELEMENT =====================
function mkEl(text='Hello World',x,y){
  const id=nextId++;
  const el={id,text,font:'Inter',size:72,weight:'700',italic:false,
    fill:'#ffffff',strokeColor:'#000000',strokeWidth:0,
    shadowColor:'#000000',shadowX:0,shadowY:4,shadowBlur:8,
    gradient:false,gradStart:'#7c6cf0',gradEnd:'#22d3a8',gradDir:135,
    motionBlur:false,align:'center',tracking:0,leading:1.2,
    x:x??S.canvasW/2,y:y??S.canvasH/2,scale:1,rotation:0,opacity:1,
    preset:null,easing:'ease-out',staggerMode:'letter',staggerDelay:50,staggerDir:'forward',
    keyframes:{x:[],y:[],scale:[],rotation:[],opacity:[],tracking:[]},
    animStart:0,animDuration:1.5,visible:true};
  S.elements.push(el);S.selectedId=id;return el;
}
function sel(){return S.elements.find(e=>e.id===S.selectedId);}

// ===================== INTERPOLATION =====================
function lerp(kfs,t,def){
  if(!kfs||!kfs.length)return def;
  const s=[...kfs].sort((a,b)=>a.time-b.time);
  if(t<=s[0].time)return s[0].value;
  if(t>=s[s.length-1].time)return s[s.length-1].value;
  for(let i=0;i<s.length-1;i++){
    if(t>=s[i].time&&t<=s[i+1].time){
      const p=(t-s[i].time)/(s[i+1].time-s[i].time);
      return s[i].value+(s[i+1].value-s[i].value)*getEase(s[i+1].easing||'ease-out')(p);
    }
  }
  return def;
}

// ===================== RENDERING =====================
const $wrap=document.getElementById('canvas-wrapper');
const $stage=document.getElementById('canvas-stage');
const $grid=document.getElementById('grid-overlay');
const $safeA=document.getElementById('safe-area-action');
const $safeT=document.getElementById('safe-area-title');

function resizeCanvas(){
  const area=document.getElementById('canvas-area');
  const aw=area.clientWidth-32,ah=area.clientHeight-32;
  const asp=S.canvasW/S.canvasH;
  let w,h;
  if(aw/ah>asp){h=ah;w=h*asp;}else{w=aw;h=w/asp;}
  $wrap.style.width=w+'px';$wrap.style.height=h+'px';
  $wrap.dataset.sx=w/S.canvasW;$wrap.dataset.sy=h/S.canvasH;
}

function updGrid(){
  if(!S.showGrid){$grid.style.display='none';return;}
  $grid.style.display='block';
  const n=S.gridSize;
  let s=`<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">`;
  for(let i=1;i<n;i++){
    const p=(i/n*100)+'%';
    s+=`<line x1="${p}" y1="0" x2="${p}" y2="100%" stroke="#999" stroke-width="0.5"/>`;
    s+=`<line x1="0" y1="${p}" x2="100%" y2="${p}" stroke="#999" stroke-width="0.5"/>`;
  }
  $grid.innerHTML=s+`</svg>`;
}

function updSafe(){
  if(!S.showSafeAreas){$safeA.style.display='none';$safeT.style.display='none';return;}
  $safeA.style.display='block';$safeT.style.display='block';
  $safeA.style.left=$safeA.style.top='5%';$safeA.style.right=$safeA.style.bottom='5%';
  $safeT.style.left=$safeT.style.top='10%';$safeT.style.right=$safeT.style.bottom='10%';
}

function render(forExport=false){
  const sx=+($wrap.dataset.sx||1),sy=+($wrap.dataset.sy||1);
  $wrap.style.backgroundColor=S.bgColor;
  $wrap.style.backgroundImage=S.bgImage?`url(${S.bgImage})`:'';
  $wrap.style.backgroundSize='cover';$wrap.style.backgroundPosition='center';
  $stage.querySelectorAll('.text-element').forEach(e=>e.remove());
  glitchSeed=Math.floor(S.currentTime*30);

  S.elements.forEach(el=>{
    if(!el.visible&&!forExport)return;
    const t=S.currentTime;
    const ix=lerp(el.keyframes.x,t,el.x);
    const iy=lerp(el.keyframes.y,t,el.y);
    const isc=lerp(el.keyframes.scale,t,el.scale);
    const irot=lerp(el.keyframes.rotation,t,el.rotation);
    const iop=lerp(el.keyframes.opacity,t,el.opacity);
    const itr=lerp(el.keyframes.tracking,t,el.tracking);

    const div=document.createElement('div');
    div.className='text-element'+(el.id===S.selectedId&&!forExport?' selected':'');
    div.dataset.id=el.id;

    const preset=el.preset&&Presets[el.preset]?Presets[el.preset]:null;
    const useStagger=!!preset;
    const sMode=el.staggerMode||(preset?preset.stagger:'letter');
    const sDelay=el.staggerDelay??(preset?preset.delay:50);
    const sDir=el.staggerDir||(preset?preset.dir:'forward');

    if(useStagger){
      const parts=splitText(el.text,sMode);
      const indices=staggerIdx(parts.length,sDir);
      let html='';
      parts.forEach((part,pi)=>{
        const si=indices[pi];
        const ds=si*sDelay/1000;
        const lt=Math.max(0,t-el.animStart-ds);
        const prog=el.animDuration>0?Math.min(1,lt/el.animDuration):1;
        const pv=preset.fn(prog,glitchSeed+pi);
        const op=pv.opacity??1;
        const px=pv.x||0,py=pv.y||0;
        const psx=pv.scaleX??1,psy=pv.scaleY??1;
        const pr=pv.rotation||0;
        const cls=sMode==='letter'?'char':'word';
        if(part===' ')html+=`<span class="${cls}">&nbsp;</span>`;
        else{
          const tf=`translate(${px}px,${py}px) scale(${psx},${psy}) rotate(${pr}deg)`;
          html+=`<span class="${cls}" style="display:inline-block;opacity:${op};transform:${tf}">${esc(part)}</span>`;
        }
      });
      div.innerHTML=html;
    }else{div.textContent=el.text;}

    div.style.fontFamily=`'${el.font}',sans-serif`;
    div.style.fontSize=(el.size*sx)+'px';
    div.style.fontWeight=el.weight;
    div.style.fontStyle=el.italic?'italic':'normal';
    div.style.letterSpacing=(itr*sx)+'px';
    div.style.lineHeight=el.leading;
    div.style.textAlign=el.align;
    div.style.color=el.fill;

    if(el.gradient){
      div.style.background=`linear-gradient(${el.gradDir}deg,${el.gradStart},${el.gradEnd})`;
      div.style.webkitBackgroundClip='text';div.style.webkitTextFillColor='transparent';
      div.style.backgroundClip='text';
    }
    if(el.strokeWidth>0)div.style.webkitTextStroke=`${el.strokeWidth*sx}px ${el.strokeColor}`;
    if(el.shadowBlur>0||el.shadowX||el.shadowY)
      div.style.textShadow=`${el.shadowX*sx}px ${el.shadowY*sy}px ${el.shadowBlur*sx}px ${el.shadowColor}`;
    if(el.motionBlur&&S.playing)div.style.filter=`blur(${1.5*sx}px)`;

    div.style.left=(ix*sx)+'px';div.style.top=(iy*sy)+'px';
    div.style.transform=`translate(-50%,-50%) scale(${isc}) rotate(${irot}deg)`;
    div.style.opacity=iop;div.style.transformOrigin='center center';
    $stage.appendChild(div);
    if(!forExport)makeDrag(div,el);
  });
}

function esc(s){const d=document.createElement('span');d.textContent=s;return d.innerHTML;}
function splitText(t,m){return m==='letter'?t.split(''):m==='word'?t.split(/(\s+)/):m==='line'?t.split('\n'):[t];}
function staggerIdx(n,d){
  const a=[];
  if(d==='forward')for(let i=0;i<n;i++)a.push(i);
  else if(d==='backward')for(let i=0;i<n;i++)a.push(n-1-i);
  else if(d==='center'){const m=(n-1)/2;for(let i=0;i<n;i++)a.push(Math.abs(i-m));}
  else{const sh=Array.from({length:n},(_,i)=>i);for(let i=n-1;i>0;i--){const j=Math.floor(Math.random()*i);[sh[i],sh[j]]=[sh[j],sh[i]];}for(let i=0;i<n;i++)a.push(sh[i]);}
  return a;
}

// ===================== DRAGGING =====================
function makeDrag(div,el){
  let dragging=false,sx,sy,ex,ey;
  const down=e=>{
    e.preventDefault();S.selectedId=el.id;updUI();dragging=true;
    const p=ptr(e);sx=p.x;sy=p.y;ex=el.x;ey=el.y;
    document.addEventListener('mousemove',move);document.addEventListener('mouseup',up);
    document.addEventListener('touchmove',move,{passive:false});document.addEventListener('touchend',up);
  };
  const move=e=>{
    if(!dragging)return;e.preventDefault();
    const p=ptr(e);const scx=+($wrap.dataset.sx||1),scy=+($wrap.dataset.sy||1);
    el.x=ex+(p.x-sx)/scx;el.y=ey+(p.y-sy)/scy;
    render();updTransform();
  };
  const up=()=>{dragging=false;
    document.removeEventListener('mousemove',move);document.removeEventListener('mouseup',up);
    document.removeEventListener('touchmove',move);document.removeEventListener('touchend',up);
  };
  div.addEventListener('mousedown',down);div.addEventListener('touchstart',down,{passive:false});
}
function ptr(e){return e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY};}

// ===================== TIMELINE =====================
const $ruler=document.getElementById('timeline-ruler');
const $tracks=document.getElementById('timeline-tracks');
const $labels=document.getElementById('timeline-labels');
const $playhead=document.createElement('div');$playhead.id='playhead';

const PROPS=['x','y','scale','rotation','opacity','tracking'];
const PLABELS={x:'X Position',y:'Y Position',scale:'Scale',rotation:'Rotation',opacity:'Opacity',tracking:'Tracking'};

function renderTL(){
  $labels.innerHTML='';$tracks.innerHTML='';$tracks.appendChild($playhead);
  const el=sel();
  if(!el){
    $labels.innerHTML='<div style="padding:16px;color:var(--text-muted);font-size:10px;text-align:center">Select an element to view its timeline</div>';
    renderRuler();return;
  }
  // Header
  const hdr=document.createElement('div');hdr.className='timeline-label header';
  hdr.innerHTML=`<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(el.text.substring(0,24))}</span>`;
  $labels.appendChild(hdr);
  const hdrT=document.createElement('div');hdrT.className='timeline-track header';$tracks.appendChild(hdrT);

  // Anim region
  const rL=t2x(el.animStart),rW=t2x(el.animStart+el.animDuration)-rL;
  const reg=document.createElement('div');reg.className='anim-region';
  reg.style.left=rL+'px';reg.style.width=Math.max(4,rW)+'px';
  // Drag anim region
  let regDrag=false,regStartX,regOrigStart;
  reg.addEventListener('mousedown',e=>{
    e.stopPropagation();regDrag=true;regStartX=e.clientX;regOrigStart=el.animStart;
    const mv=e2=>{if(!regDrag)return;const dx=e2.clientX-regStartX;
      el.animStart=Math.max(0,regOrigStart+dx/S.zoom);
      reg.style.left=t2x(el.animStart)+'px';
      document.getElementById('prop-anim-start').value=el.animStart.toFixed(1);
    };
    const u=()=>{regDrag=false;document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',u);render();};
    document.addEventListener('mousemove',mv);document.addEventListener('mouseup',u);
  });
  hdrT.appendChild(reg);

  PROPS.forEach(prop=>{
    const lbl=document.createElement('div');lbl.className='timeline-label';
    lbl.innerHTML=`<span class="prop-name">${PLABELS[prop]}</span>`;
    $labels.appendChild(lbl);
    const track=document.createElement('div');track.className='timeline-track';track.dataset.prop=prop;
    $tracks.appendChild(track);
    track.addEventListener('dblclick',e=>{
      const rect=track.getBoundingClientRect();
      const x=e.clientX-rect.left+$tracks.scrollLeft;
      addKF(el,prop,x2t(x));renderTL();render();
    });
    (el.keyframes[prop]||[]).forEach((kf,ki)=>{
      const d=document.createElement('div');d.className='keyframe-diamond';
      d.style.left=(t2x(kf.time)-4.5)+'px';
      d.title=`${PLABELS[prop]}: ${kf.value.toFixed(2)} @ ${kf.time.toFixed(2)}s`;
      let dk=false,dkx;
      d.addEventListener('mousedown',e=>{
        e.stopPropagation();dk=true;dkx=e.clientX;
        const mv2=e2=>{if(!dk)return;const dx=e2.clientX-dkx;dkx=e2.clientX;
          kf.time=Math.max(0,Math.min(S.duration,kf.time+dx/S.zoom));
          d.style.left=(t2x(kf.time)-4.5)+'px';
        };
        const u2=()=>{dk=false;document.removeEventListener('mousemove',mv2);document.removeEventListener('mouseup',u2);render();};
        document.addEventListener('mousemove',mv2);document.addEventListener('mouseup',u2);
      });
      d.addEventListener('contextmenu',e=>{e.preventDefault();el.keyframes[prop].splice(ki,1);renderTL();render();});
      track.appendChild(d);
    });
  });

  // Beat markers
  S.beats.forEach(bt=>{
    if(bt>S.duration)return;
    const m=document.createElement('div');m.className='beat-marker';m.style.left=t2x(bt)+'px';
    $tracks.appendChild(m);
  });

  updPlayhead();renderRuler();
}
function t2x(t){return t*S.zoom;}
function x2t(x){return x/S.zoom;}
function renderRuler(){
  $ruler.innerHTML='';
  const tw=S.duration*S.zoom;
  $ruler.style.width=tw+'px';$tracks.style.minWidth=tw+'px';
  const step=S.zoom>=200?.1:S.zoom>=80?.25:S.zoom>=40?.5:1;
  for(let t=0;t<=S.duration;t+=step){
    const x=t2x(t);const mk=document.createElement('div');mk.className='ruler-mark';
    mk.style.left=x+'px';const major=Math.abs(t-Math.round(t))<.01;
    mk.style.height=major?'14px':'7px';mk.style.background=major?'var(--text-muted)':'var(--border)';
    $ruler.appendChild(mk);
    if(major){const l=document.createElement('div');l.className='ruler-label';l.style.left=x+'px';l.textContent=t.toFixed(0)+'s';$ruler.appendChild(l);}
  }
}
function updPlayhead(){$playhead.style.left=t2x(S.currentTime)+'px';}
function addKF(el,prop,time,val){
  if(!el.keyframes[prop])el.keyframes[prop]=[];
  if(val===undefined)val={x:el.x,y:el.y,scale:el.scale,rotation:el.rotation,opacity:el.opacity,tracking:el.tracking}[prop];
  const ex=el.keyframes[prop].find(k=>Math.abs(k.time-time)<.02);
  if(ex)ex.value=val;else el.keyframes[prop].push({time,value:val,easing:el.easing||'ease-out'});
  el.keyframes[prop].sort((a,b)=>a.time-b.time);
}

// Timeline seek
$ruler.addEventListener('mousedown',e=>{
  const seek=e2=>{const r=$ruler.getBoundingClientRect();
    S.currentTime=Math.max(0,Math.min(S.duration,x2t(e2.clientX-r.left+($ruler.parentElement.scrollLeft||0))));
    updPlayhead();updTime();render();
  };seek(e);
  const mv=e2=>seek(e2);const u=()=>{document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',u);};
  document.addEventListener('mousemove',mv);document.addEventListener('mouseup',u);
});

// Sync scroll between labels and tracks
$tracks.addEventListener('scroll',()=>{$labels.scrollTop=$tracks.scrollTop;});

// ===================== PLAYBACK =====================
function play(){
  if(S.playing)return;S.playing=true;lastPlayTime=performance.now();
  if(S.currentTime>=S.duration)S.currentTime=0;
  document.getElementById('play-icon').style.display='none';
  document.getElementById('pause-icon').style.display='block';
  if(S.audioBuffer&&S.audioCtx){
    try{if(S.audioSource){try{S.audioSource.stop();}catch(e){}}
    S.audioSource=S.audioCtx.createBufferSource();S.audioSource.buffer=S.audioBuffer;
    S.audioSource.connect(S.audioCtx.destination);S.audioSource.start(0,S.currentTime);}catch(e){}
  }
  tick();
}
function pause(){
  S.playing=false;document.getElementById('play-icon').style.display='block';
  document.getElementById('pause-icon').style.display='none';
  if(animFrame)cancelAnimationFrame(animFrame);
  if(S.audioSource){try{S.audioSource.stop();}catch(e){}}
}
function tick(){
  if(!S.playing)return;
  const now=performance.now();S.currentTime+=(now-lastPlayTime)/1000;lastPlayTime=now;
  if(S.currentTime>=S.duration){
    if(S.loop){S.currentTime=0;
      if(S.audioBuffer&&S.audioCtx){try{if(S.audioSource)S.audioSource.stop();
        S.audioSource=S.audioCtx.createBufferSource();S.audioSource.buffer=S.audioBuffer;
        S.audioSource.connect(S.audioCtx.destination);S.audioSource.start(0,0);}catch(e){}}
    }else{S.currentTime=S.duration;pause();}
  }
  updPlayhead();updTime();render();animFrame=requestAnimationFrame(tick);
}
function updTime(){
  const f=t=>{const m=Math.floor(t/60);const s=(t%60).toFixed(2);return`${m}:${s.padStart(5,'0')}`;};
  document.getElementById('time-display').textContent=`${f(S.currentTime)} / ${f(S.duration)}`;
}

// ===================== UI =====================
function updUI(){updList();updStyle();updTransform();renderTL();render();updTime();
  const noSel=document.getElementById('no-selection');
  if(noSel)noSel.style.display=sel()?'none':'block';
}
function updList(){
  const list=document.getElementById('elements-list');
  const empty=document.getElementById('elements-empty');
  list.innerHTML='';empty.style.display=S.elements.length?'none':'block';
  S.elements.forEach(el=>{
    const item=document.createElement('div');item.className='el-item'+(el.id===S.selectedId?' active':'');
    item.innerHTML=`<span class="el-name">${esc(el.text)}</span><span class="el-visibility" title="Toggle visibility">${el.visible?'👁':'👁‍🗨'}</span>`;
    item.querySelector('.el-name').addEventListener('click',()=>{S.selectedId=el.id;updUI();});
    item.querySelector('.el-visibility').addEventListener('click',(e)=>{e.stopPropagation();el.visible=!el.visible;render();updList();});
    list.appendChild(item);
  });
}
function updStyle(){
  const el=sel();if(!el)return;
  document.getElementById('prop-text').value=el.text;
  document.getElementById('prop-font').value=el.font;
  document.getElementById('prop-size').value=el.size;
  document.getElementById('prop-weight').value=el.weight;
  document.getElementById('prop-italic').checked=el.italic;
  document.getElementById('prop-tracking-num').value=el.tracking;
  document.getElementById('prop-leading').value=el.leading;
  document.getElementById('prop-leading-val').textContent=el.leading.toFixed(2);
  document.getElementById('prop-fill').value=el.fill;
  document.getElementById('prop-fill-hex').value=el.fill;
  document.getElementById('prop-stroke').value=el.strokeColor;
  document.getElementById('prop-stroke-w').value=el.strokeWidth;
  document.getElementById('prop-shadow-color').value=el.shadowColor;
  document.getElementById('prop-shadow-x').value=el.shadowX;
  document.getElementById('prop-shadow-y').value=el.shadowY;
  document.getElementById('prop-shadow-blur').value=el.shadowBlur;
  document.getElementById('prop-gradient').checked=el.gradient;
  document.getElementById('prop-grad-start').value=el.gradStart;
  document.getElementById('prop-grad-end').value=el.gradEnd;
  document.getElementById('prop-grad-dir').value=el.gradDir;
  document.getElementById('prop-motion-blur').checked=el.motionBlur;
  document.querySelectorAll('.align-btn').forEach(b=>b.classList.toggle('active',b.dataset.align===el.align));
  document.getElementById('prop-anim-start').value=el.animStart.toFixed(1);
  document.getElementById('prop-anim-dur').value=el.animDuration.toFixed(1);
}
function updTransform(){
  const el=sel();if(!el)return;
  document.getElementById('prop-x').value=Math.round(el.x);
  document.getElementById('prop-y').value=Math.round(el.y);
  document.getElementById('prop-scale').value=el.scale;
  document.getElementById('prop-scale-val').textContent=el.scale.toFixed(2);
  document.getElementById('prop-rotation').value=el.rotation;
  document.getElementById('prop-rotation-val').textContent=el.rotation.toFixed(0)+'°';
  document.getElementById('prop-opacity').value=el.opacity;
  document.getElementById('prop-opacity-val').textContent=el.opacity.toFixed(2);
}

// ===================== BINDINGS =====================
// Tabs
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const tid=btn.dataset.tab;const parent=btn.closest('#left-panel,#right-panel');
    parent.querySelectorAll('.tab-btn').forEach(b=>{b.classList.remove('active');b.setAttribute('aria-selected','false');});
    parent.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');btn.setAttribute('aria-selected','true');
    document.getElementById(tid).classList.add('active');
  });
});

// Add text
const addText=()=>{mkEl('Hello World');updUI();};
document.getElementById('btn-add-text').addEventListener('click',addText);
document.getElementById('btn-add-text-2').addEventListener('click',addText);

// Delete
document.getElementById('btn-delete').addEventListener('click',()=>{
  if(!S.selectedId)return;
  S.elements=S.elements.filter(e=>e.id!==S.selectedId);
  S.selectedId=S.elements.length?S.elements[S.elements.length-1].id:null;updUI();
});

// Duplicate
document.getElementById('btn-duplicate').addEventListener('click',()=>{
  const el=sel();if(!el)return;
  const ne=mkEl(el.text,el.x+40,el.y+40);
  Object.assign(ne,{...el,id:ne.id,x:el.x+40,y:el.y+40,keyframes:JSON.parse(JSON.stringify(el.keyframes))});
  updUI();
});

// Text input
document.getElementById('prop-text').addEventListener('input',(e)=>{const el=sel();if(el){el.text=e.target.value;render();updList();renderTL();}});

// Style bindings
function bind(id,prop,parse){
  const inp=document.getElementById(id);if(!inp)return;
  const ev=inp.type==='range'||inp.type==='checkbox'||inp.type==='color'?'input':'change';
  inp.addEventListener(ev,()=>{
    const el=sel();if(!el)return;
    el[prop]=inp.type==='checkbox'?inp.checked:parse?parse(inp.value):inp.value;
    render();
    const vs=document.getElementById(id+'-val');
    if(vs){if(prop==='rotation')vs.textContent=el[prop]+'°';
      else if(prop==='scale'||prop==='opacity')vs.textContent=parseFloat(el[prop]).toFixed(2);
      else if(prop==='leading')vs.textContent=parseFloat(el[prop]).toFixed(2);
      else vs.textContent=el[prop];}
  });
}
bind('prop-font','font');bind('prop-size','size',Number);bind('prop-weight','weight');
bind('prop-italic','italic');bind('prop-tracking-num','tracking',Number);
bind('prop-leading','leading',Number);
bind('prop-fill','fill');bind('prop-fill-hex','fill');
bind('prop-stroke','strokeColor');bind('prop-stroke-w','strokeWidth',Number);
bind('prop-shadow-color','shadowColor');bind('prop-shadow-x','shadowX',Number);
bind('prop-shadow-y','shadowY',Number);bind('prop-shadow-blur','shadowBlur',Number);
bind('prop-gradient','gradient');bind('prop-grad-start','gradStart');
bind('prop-grad-end','gradEnd');bind('prop-grad-dir','gradDir',Number);
bind('prop-motion-blur','motionBlur');
bind('prop-x','x',Number);bind('prop-y','y',Number);
bind('prop-scale','scale',Number);bind('prop-rotation','rotation',Number);
bind('prop-opacity','opacity',Number);
bind('prop-anim-start','animStart',Number);bind('prop-anim-dur','animDuration',Number);

// Sync colors
document.getElementById('prop-fill').addEventListener('input',e=>document.getElementById('prop-fill-hex').value=e.target.value);
document.getElementById('prop-fill-hex').addEventListener('change',e=>{document.getElementById('prop-fill').value=e.target.value;const el=sel();if(el){el.fill=e.target.value;render();}});
document.getElementById('bg-color').addEventListener('input',e=>{S.bgColor=e.target.value;document.getElementById('bg-color-hex').value=e.target.value;render();});
document.getElementById('bg-color-hex').addEventListener('change',e=>{S.bgColor=e.target.value;document.getElementById('bg-color').value=e.target.value;render();});

// Align
document.querySelectorAll('.align-btn').forEach(b=>{
  b.addEventListener('click',()=>{const el=sel();if(!el)return;el.align=b.dataset.align;
    document.querySelectorAll('.align-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');render();});
});

// Background
document.getElementById('btn-bg-image').addEventListener('click',()=>document.getElementById('bg-image-input').click());
document.getElementById('bg-image-input').addEventListener('change',e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{S.bgImage=ev.target.result;
    document.getElementById('bg-image-name').textContent=f.name;render();};r.readAsDataURL(f);
});
document.getElementById('btn-bg-clear').addEventListener('click',()=>{S.bgImage=null;document.getElementById('bg-image-name').textContent='';render();});

// Aspect & Resolution
document.getElementById('aspect-select').addEventListener('change',e=>{
  const v=e.target.value;document.getElementById('aspect-label').textContent=v;
  const map={'16:9':[1920,1080],'9:16':[1080,1920],'1:1':[1080,1080],'4:3':[1440,1080]};
  if(map[v]){[S.canvasW,S.canvasH]=map[v];document.getElementById('resolution-select').value=S.canvasW+'x'+S.canvasH;
    document.getElementById('layout-w').value=S.canvasW;document.getElementById('layout-h').value=S.canvasH;}
  resizeCanvas();updGrid();updSafe();render();
});
document.getElementById('resolution-select').addEventListener('change',e=>{
  const[w,h]=e.target.value.split('x').map(Number);S.canvasW=w;S.canvasH=h;
  document.getElementById('layout-w').value=w;document.getElementById('layout-h').value=h;
  resizeCanvas();updGrid();updSafe();render();
});

// Layout
document.getElementById('layout-w').addEventListener('change',e=>{S.canvasW=Number(e.target.value);resizeCanvas();render();});
document.getElementById('layout-h').addEventListener('change',e=>{S.canvasH=Number(e.target.value);resizeCanvas();render();});
document.getElementById('layout-grid').addEventListener('change',e=>{S.showGrid=e.target.checked;updGrid();});
document.getElementById('layout-grid-size').addEventListener('change',e=>{S.gridSize=Number(e.target.value);updGrid();});
document.getElementById('layout-safe').addEventListener('change',e=>{S.showSafeAreas=e.target.checked;updSafe();});
document.getElementById('layout-margins').addEventListener('input',e=>{S.margins=Number(e.target.value);document.getElementById('layout-margins-val').textContent=S.margins+'%';});
document.getElementById('layout-fps').addEventListener('change',e=>{S.fps=Number(e.target.value);});
document.getElementById('layout-duration').addEventListener('change',e=>{S.duration=Number(e.target.value);renderTL();updTime();});
document.getElementById('btn-grid').addEventListener('click',()=>{S.showGrid=!S.showGrid;
  document.getElementById('btn-grid').classList.toggle('active',S.showGrid);document.getElementById('layout-grid').checked=S.showGrid;updGrid();});
document.getElementById('btn-safe').addEventListener('click',()=>{S.showSafeAreas=!S.showSafeAreas;
  document.getElementById('btn-safe').classList.toggle('active',S.showSafeAreas);document.getElementById('layout-safe').checked=S.showSafeAreas;updSafe();});

// Playback
document.getElementById('btn-play').addEventListener('click',()=>{if(S.playing)pause();else play();});
document.getElementById('btn-to-start').addEventListener('click',()=>{S.currentTime=0;if(S.playing)pause();updPlayhead();updTime();render();});
document.getElementById('btn-to-end').addEventListener('click',()=>{S.currentTime=S.duration;if(S.playing)pause();updPlayhead();updTime();render();});
document.getElementById('btn-prev-frame').addEventListener('click',()=>{S.currentTime=Math.max(0,S.currentTime-1/S.fps);updPlayhead();updTime();render();});
document.getElementById('btn-next-frame').addEventListener('click',()=>{S.currentTime=Math.min(S.duration,S.currentTime+1/S.fps);updPlayhead();updTime();render();});
document.getElementById('btn-loop').addEventListener('change',e=>{S.loop=e.target.checked;});
document.getElementById('btn-zoom-in').addEventListener('click',()=>{S.zoom=Math.min(500,S.zoom*1.35);
  document.getElementById('zoom-level').textContent=Math.round(S.zoom);renderTL();});
document.getElementById('btn-zoom-out').addEventListener('click',()=>{S.zoom=Math.max(15,S.zoom/1.35);
  document.getElementById('zoom-level').textContent=Math.round(S.zoom);renderTL();});

// Keyframe buttons
document.querySelectorAll('.kf-btn').forEach(b=>{
  b.addEventListener('click',()=>{const el=sel();if(!el)return;addKF(el,b.dataset.prop,S.currentTime);renderTL();toast(`Keyframe: ${PLABELS[b.dataset.prop]}`);});
});
document.getElementById('btn-kf-all').addEventListener('click',()=>{const el=sel();if(!el)return;PROPS.forEach(p=>addKF(el,p,S.currentTime));renderTL();toast('All keyframes added');});

// ===================== PRESETS =====================
const $presets=document.getElementById('preset-grid');
Object.entries(Presets).forEach(([key,p])=>{
  const card=document.createElement('div');card.className='preset-card';card.textContent=p.name;card.dataset.preset=key;
  card.addEventListener('click',()=>{
    const el=sel();if(!el)return;
    el.preset=key;el.staggerMode=p.stagger;el.staggerDelay=p.delay;el.staggerDir=p.dir;el.easing=p.easing;
    document.getElementById('stagger-mode').value=el.staggerMode;
    document.getElementById('stagger-delay').value=el.staggerDelay;
    document.getElementById('stagger-delay-val').textContent=el.staggerDelay+'ms';
    document.getElementById('stagger-dir').value=el.staggerDir;
    $presets.querySelectorAll('.preset-card').forEach(c=>c.classList.remove('active'));card.classList.add('active');
    render();toast(`Preset: ${p.name}`);
  });
  $presets.appendChild(card);
});
document.getElementById('stagger-mode').addEventListener('change',e=>{const el=sel();if(el)el.staggerMode=e.target.value;render();});
document.getElementById('stagger-delay').addEventListener('input',e=>{const el=sel();if(el)el.staggerDelay=Number(e.target.value);
  document.getElementById('stagger-delay-val').textContent=e.target.value+'ms';render();});
document.getElementById('stagger-dir').addEventListener('change',e=>{const el=sel();if(el)el.staggerDir=e.target.value;render();});

// ===================== EASING =====================
const $easing=document.getElementById('easing-grid');
Object.keys(E).forEach(name=>{
  if(name==='custom')return;
  const b=document.createElement('button');b.className='easing-btn';
  b.textContent=name.replace('ease-','').replace('-',' ');b.dataset.easing=name;
  b.addEventListener('click',()=>{const el=sel();if(el)el.easing=name;
    $easing.querySelectorAll('.easing-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');});
  $easing.appendChild(b);
});

// ===================== BEZIER EDITOR =====================
const $bez=document.getElementById('bezier-canvas');
const bezCtx=$bez.getContext('2d');
let dragBP=null;
function drawBez(){
  const w=$bez.width,h=$bez.height,p=12;bezCtx.clearRect(0,0,w,h);
  bezCtx.fillStyle='#151520';bezCtx.fillRect(0,0,w,h);
  // Grid
  bezCtx.strokeStyle='#222238';bezCtx.lineWidth=.5;
  for(let i=0;i<=4;i++){const x=p+(w-2*p)*i/4,y=p+(h-2*p)*i/4;
    bezCtx.beginPath();bezCtx.moveTo(x,p);bezCtx.lineTo(x,h-p);bezCtx.stroke();
    bezCtx.beginPath();bezCtx.moveTo(p,y);bezCtx.lineTo(w-p,y);bezCtx.stroke();}
  // Diagonal
  bezCtx.strokeStyle='#333350';bezCtx.lineWidth=1;bezCtx.setLineDash([3,3]);
  bezCtx.beginPath();bezCtx.moveTo(p,h-p);bezCtx.lineTo(w-p,p);bezCtx.stroke();bezCtx.setLineDash([]);
  const tx=v=>p+v*(w-2*p),ty=v=>h-p-v*(h-2*p);
  // Curve
  bezCtx.strokeStyle='#7c6cf0';bezCtx.lineWidth=2.5;bezCtx.beginPath();bezCtx.moveTo(tx(0),ty(0));
  for(let t=0;t<=1;t+=.015){const x=3*(1-t)*(1-t)*t*customBez[0]+3*(1-t)*t*t*customBez[2]+t*t*t;
    const y=3*(1-t)*(1-t)*t*customBez[1]+3*(1-t)*t*t*customBez[3]+t*t*t;bezCtx.lineTo(tx(x),ty(y));}
  bezCtx.stroke();
  // Control lines
  bezCtx.strokeStyle='rgba(124,108,240,.3)';bezCtx.lineWidth=1;
  bezCtx.beginPath();bezCtx.moveTo(tx(0),ty(0));bezCtx.lineTo(tx(customBez[0]),ty(customBez[1]));bezCtx.stroke();
  bezCtx.beginPath();bezCtx.moveTo(tx(1),ty(1));bezCtx.lineTo(tx(customBez[2]),ty(customBez[3]));bezCtx.stroke();
  // Points
  [[customBez[0],customBez[1],'#22d3a8'],[customBez[2],customBez[3],'#f0c060']].forEach(([cx,cy,col])=>{
    bezCtx.fillStyle=col;bezCtx.beginPath();bezCtx.arc(tx(cx),ty(cy),5,0,Math.PI*2);bezCtx.fill();
    bezCtx.strokeStyle=col;bezCtx.lineWidth=1;bezCtx.beginPath();bezCtx.arc(tx(cx),ty(cy),7,0,Math.PI*2);bezCtx.stroke();
  });
}
$bez.addEventListener('mousedown',e=>{
  const r=$bez.getBoundingClientRect();const mx=(e.clientX-r.left)/r.width,my=1-(e.clientY-r.top)/r.height;
  if(Math.hypot(mx-customBez[0],my-customBez[1])<.12)dragBP=0;
  else if(Math.hypot(mx-customBez[2],my-customBez[3])<.12)dragBP=1;else dragBP=null;
});
$bez.addEventListener('mousemove',e=>{
  if(dragBP===null)return;const r=$bez.getBoundingClientRect();
  const mx=Math.max(0,Math.min(1,(e.clientX-r.left)/r.width));
  const my=Math.max(-.5,Math.min(1.5,1-(e.clientY-r.top)/r.height));
  if(dragBP===0){customBez[0]=mx;customBez[1]=my;}else{customBez[2]=mx;customBez[3]=my;}
  drawBez();const el=sel();if(el)el.easing='custom';
});
document.addEventListener('mouseup',()=>{dragBP=null;});
drawBez();

// ===================== AUDIO =====================
document.getElementById('btn-load-audio').addEventListener('click',()=>document.getElementById('audio-file-input').click());
document.getElementById('btn-audio').addEventListener('click',()=>document.getElementById('audio-file-input').click());
document.getElementById('audio-file-input').addEventListener('change',async e=>{
  const f=e.target.files[0];if(!f)return;
  if(!S.audioCtx)S.audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  S.audioBuffer=await S.audioCtx.decodeAudioData(await f.arrayBuffer());
  document.getElementById('audio-info').style.display='block';
  document.getElementById('audio-info').textContent=`♪ ${f.name} (${S.audioBuffer.duration.toFixed(1)}s)`;
  const wc=document.getElementById('waveform-canvas');wc.style.display='block';
  drawWave(wc,S.audioBuffer);detectBeats(S.audioBuffer);
  document.getElementById('btn-snap-beats').disabled=false;toast('Audio loaded');
});
function drawWave(canvas,buf){
  const ctx=canvas.getContext('2d');const w=canvas.width=canvas.offsetWidth*2,h=canvas.height=100;
  ctx.clearRect(0,0,w,h);const data=buf.getChannelData(0);const step=Math.ceil(data.length/w);
  ctx.fillStyle='#151520';ctx.fillRect(0,0,w,h);
  // Gradient fill
  const grad=ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,'rgba(124,108,240,0.6)');grad.addColorStop(0.5,'rgba(124,108,240,0.2)');grad.addColorStop(1,'rgba(124,108,240,0.6)');
  ctx.fillStyle=grad;
  for(let i=0;i<w;i++){let min=1,max=-1;
    for(let j=0;j<step;j++){const v=data[i*step+j]||0;if(v<min)min=v;if(v>max)max=v;}
    ctx.fillRect(i,(1+min)*h/2,1,(max-min)*h/2);
  }
  if(S.beats.length){ctx.strokeStyle='rgba(34,211,168,0.5)';ctx.lineWidth=1;
    S.beats.forEach(b=>{const x=(b/buf.duration)*w;ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();});}
}
function detectBeats(buf){
  const data=buf.getChannelData(0);const sr=buf.sampleRate;
  const sens=Number(document.getElementById('beat-sensitivity').value)/100;
  const fs=Math.floor(sr*.02),hs=Math.floor(fs/2);const energies=[];
  for(let i=0;i<data.length-fs;i+=hs){let e=0;for(let j=0;j<fs;j++)e+=data[i+j]*data[i+j];energies.push(e/fs);}
  const ws=43;S.beats=[];let last=-1;
  for(let i=ws;i<energies.length-ws;i++){
    let lm=0;for(let j=i-ws;j<=i+ws;j++)lm+=energies[j];lm/=(ws*2+1);
    const th=lm*(1+(1-sens)*2.5);const t=(i*hs)/sr;
    if(energies[i]>th&&energies[i]>energies[i-1]&&energies[i]>energies[i+1]&&t-last>.18){S.beats.push(t);last=t;}
  }
  document.getElementById('beats-info').textContent=`${S.beats.length} beats detected`;
  const wc=document.getElementById('waveform-canvas');if(wc.style.display!=='none')drawWave(wc,buf);renderTL();
}
document.getElementById('beat-sensitivity').addEventListener('input',e=>{
  document.getElementById('beat-sens-val').textContent=e.target.value;
  if(S.audioBuffer)detectBeats(S.audioBuffer);
});
document.getElementById('btn-snap-beats').addEventListener('click',()=>{
  const el=sel();if(!el||!S.beats.length)return;
  PROPS.forEach(p=>el.keyframes[p]=[]);
  S.beats.forEach(b=>{if(b>S.duration)return;
    addKF(el,'scale',b,.8+Math.random()*.4);addKF(el,'opacity',b,1);
    addKF(el,'rotation',b,(Math.random()-.5)*8);
    const s=Math.min(b+.12,S.duration);addKF(el,'scale',s,1);addKF(el,'rotation',s,0);
  });renderTL();render();toast(`${S.beats.length} beats → keyframes`);
});

// ===================== EXPORT =====================
document.getElementById('btn-export').addEventListener('click',()=>{
  document.getElementById('export-modal').style.display='flex';
  document.getElementById('export-fps').value=S.fps;
  document.getElementById('export-progress').style.display='none';
  document.getElementById('export-start').disabled=false;
});
document.getElementById('export-cancel').addEventListener('click',()=>{document.getElementById('export-modal').style.display='none';});
document.getElementById('export-modal').addEventListener('click',e=>{if(e.target===document.getElementById('export-modal'))document.getElementById('export-modal').style.display='none';});

document.getElementById('export-start').addEventListener('click',async()=>{
  const fmt=document.getElementById('export-format').value;
  const sc=Number(document.getElementById('export-res').value);
  const fps=Number(document.getElementById('export-fps').value);
  const prog=document.getElementById('export-progress');
  const bar=document.getElementById('export-bar');
  const stat=document.getElementById('export-status');
  prog.style.display='block';document.getElementById('export-start').disabled=true;

  const w=Math.round(S.canvasW*sc),h=Math.round(S.canvasH*sc);
  const total=Math.ceil(S.duration*fps);
  const oc=document.createElement('canvas');oc.width=w;oc.height=h;const ctx=oc.getContext('2d');

  if(fmt==='webm'){
    const stream=oc.captureStream(fps);
    let mimeType='video/webm;codecs=vp9';
    if(!MediaRecorder.isTypeSupported(mimeType))mimeType='video/webm;codecs=vp8';
    if(!MediaRecorder.isTypeSupported(mimeType))mimeType='video/webm';
    const rec=new MediaRecorder(stream,{mimeType,videoBitsPerSecond:8000000});
    const chunks=[];rec.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data);};
    rec.onstop=()=>{
      const blob=new Blob(chunks,{type:'video/webm'});dlBlob(blob,'kinetic-typography.webm');
      prog.style.display='none';document.getElementById('export-start').disabled=false;
      document.getElementById('export-modal').style.display='none';toast('Export complete!');
    };
    rec.start();
    for(let f=0;f<=total;f++){
      S.currentTime=f/fps;if(S.currentTime>S.duration)S.currentTime=S.duration;
      await renderFrame(ctx,w,h);bar.style.width=((f/total)*100)+'%';
      stat.textContent=`Rendering ${f+1}/${total}`;await new Promise(r=>setTimeout(r,1000/fps));
    }
    rec.stop();
  }else if(fmt==='png'){
    for(let f=0;f<=total;f++){
      S.currentTime=f/fps;if(S.currentTime>S.duration)S.currentTime=S.duration;
      await renderFrame(ctx,w,h);bar.style.width=((f/total)*100)+'%';
      stat.textContent=`Frame ${f+1}/${total}`;
      const a=document.createElement('a');a.download=`frame-${String(f).padStart(5,'0')}.png`;
      a.href=oc.toDataURL('image/png');a.click();await new Promise(r=>setTimeout(r,80));
    }
    prog.style.display='none';document.getElementById('export-start').disabled=false;toast('PNG sequence exported!');
  }else{
    // GIF fallback: just export key frames as images
    stat.textContent='Exporting frames...';
    const step=Math.max(1,Math.floor(total/50));
    for(let f=0;f<=total;f+=step){
      S.currentTime=f/fps;await renderFrame(ctx,w,h);
      const a=document.createElement('a');a.download=`frame-${String(f).padStart(5,'0')}.png`;
      a.href=oc.toDataURL('image/png');a.click();
      bar.style.width=((f/total)*100)+'%';await new Promise(r=>setTimeout(r,60));
    }
    prog.style.display='none';document.getElementById('export-start').disabled=false;toast('Frames exported! Use an online tool to convert to GIF.');
  }
  S.currentTime=0;updPlayhead();updTime();render();
});

async function renderFrame(ctx,w,h){
  ctx.clearRect(0,0,w,h);ctx.fillStyle=S.bgColor;ctx.fillRect(0,0,w,h);
  if(S.bgImage&&S.bgImageEl){
    const img=S.bgImageEl;const sc=Math.max(w/img.width,h/img.height);
    ctx.drawImage(img,(w-img.width*sc)/2,(h-img.height*sc)/2,img.width*sc,img.height*sc);
  }
  const sx=w/S.canvasW,sy=h/S.canvasH;
  for(const el of S.elements){
    if(!el.visible)continue;
    const t=S.currentTime;
    const ix=lerp(el.keyframes.x,t,el.x),iy=lerp(el.keyframes.y,t,el.y);
    const isc=lerp(el.keyframes.scale,t,el.scale),irot=lerp(el.keyframes.rotation,t,el.rotation);
    const iop=lerp(el.keyframes.opacity,t,el.opacity),itr=lerp(el.keyframes.tracking,t,el.tracking);

    ctx.save();ctx.globalAlpha=iop;ctx.translate(ix*sx,iy*sy);
    ctx.rotate(irot*Math.PI/180);ctx.scale(isc,isc);
    const fsize=el.size*sx;
    ctx.font=`${el.italic?'italic ':''}${el.weight} ${fsize}px '${el.font}',sans-serif`;
    ctx.textAlign=el.align==='left'?'left':el.align==='right'?'right':'center';
    ctx.textBaseline='middle';

    if(el.shadowBlur||el.shadowX||el.shadowY){
      ctx.shadowColor=el.shadowColor;ctx.shadowBlur=el.shadowBlur*sx;
      ctx.shadowOffsetX=el.shadowX*sx;ctx.shadowOffsetY=el.shadowY*sy;
    }

    const preset=el.preset&&Presets[el.preset]?Presets[el.preset]:null;
    if(preset){
      const parts=splitText(el.text,el.staggerMode);
      const indices=staggerIdx(parts.length,el.staggerDir);
      const metrics=parts.map(p=>ctx.measureText(p).width);
      const totalW=metrics.reduce((a,b)=>a+b,0)+(parts.length-1)*itr*sx;
      let xOff=el.align==='left'?0:el.align==='right'?-totalW:-totalW/2;

      parts.forEach((part,pi)=>{
        const ds=(indices[pi]*el.staggerDelay)/1000;
        const lt=Math.max(0,t-el.animStart-ds);
        const prog=el.animDuration>0?Math.min(1,lt/el.animDuration):1;
        const pv=preset.fn(prog,glitchSeed+pi);
        ctx.save();
        ctx.globalAlpha=(pv.opacity??1)*iop;
        const pw=metrics[pi];
        ctx.translate(xOff+pw/2+(pv.x||0)*sx,(pv.y||0)*sy);
        const psx=pv.scaleX??1,psy=pv.scaleY??1;
        ctx.scale(psx,psy);
        if(pv.rotation)ctx.rotate(pv.rotation*Math.PI/180);
        if(el.gradient){
          const g=ctx.createLinearGradient(-pw/2,-fsize/2,pw/2,fsize/2);
          g.addColorStop(0,el.gradStart);g.addColorStop(1,el.gradEnd);ctx.fillStyle=g;
        }else ctx.fillStyle=el.fill;
        if(el.strokeWidth>0){ctx.strokeStyle=el.strokeColor;ctx.lineWidth=el.strokeWidth*sx;ctx.strokeText(part,-pw/2,0);}
        ctx.fillText(part,-pw/2,0);ctx.restore();
        xOff+=pw+itr*sx;
      });
    }else{
      if(el.gradient){const tw=ctx.measureText(el.text).width;
        const g=ctx.createLinearGradient(-tw/2,0,tw/2,0);g.addColorStop(0,el.gradStart);g.addColorStop(1,el.gradEnd);ctx.fillStyle=g;
      }else ctx.fillStyle=el.fill;
      if(el.strokeWidth>0){ctx.strokeStyle=el.strokeColor;ctx.lineWidth=el.strokeWidth*sx;ctx.strokeText(el.text,0,0);}
      ctx.fillText(el.text,0,0);
    }
    ctx.restore();
  }
}
function dlBlob(b,n){const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=n;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);}

// ===================== KEYBOARD =====================
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT')return;
  if(e.code==='Space'){e.preventDefault();S.playing?pause():play();}
  else if(e.code==='KeyT'){e.preventDefault();addText();}
  else if(e.code==='KeyG'){e.preventDefault();document.getElementById('btn-grid').click();}
  else if(e.code==='KeyS'&&!e.ctrlKey&&!e.metaKey){e.preventDefault();document.getElementById('btn-safe').click();}
  else if(e.code==='Delete'||e.code==='Backspace'){document.getElementById('btn-delete').click();}
  else if(e.code==='Home'){document.getElementById('btn-to-start').click();}
  else if(e.code==='End'){document.getElementById('btn-to-end').click();}
  else if(e.code==='ArrowLeft'){S.currentTime=Math.max(0,S.currentTime-1/S.fps);updPlayhead();updTime();render();}
  else if(e.code==='ArrowRight'){S.currentTime=Math.min(S.duration,S.currentTime+1/S.fps);updPlayhead();updTime();render();}
  else if(e.code==='KeyD'&&(e.ctrlKey||e.metaKey)){e.preventDefault();document.getElementById('btn-duplicate').click();}
  else if(e.code==='KeyK'){e.preventDefault();const el=sel();if(el){PROPS.forEach(p=>addKF(el,p,S.currentTime));renderTL();toast('Keyframes added');}}
  else if(e.code==='KeyZ'&&(e.ctrlKey||e.metaKey)){e.preventDefault();/* undo placeholder */}
});

// ===================== CANVAS EVENTS =====================
$stage.addEventListener('dblclick',e=>{
  const te=e.target.closest('.text-element');if(!te)return;
  const el=S.elements.find(x=>x.id===Number(te.dataset.id));if(!el)return;
  const nt=prompt('Edit text:',el.text);
  if(nt!==null&&nt!==''){el.text=nt;updUI();}
});

// ===================== TOAST =====================
function toast(msg){
  const ex=document.querySelector('.toast');if(ex)ex.remove();
  const t=document.createElement('div');t.className='toast';t.textContent=msg;
  t.setAttribute('role','status');t.setAttribute('aria-live','polite');
  document.body.appendChild(t);setTimeout(()=>t.remove(),2200);
}

// ===================== INIT =====================
function init(){
  resizeCanvas();

  // Create demo elements
  const e1=mkEl('KINETIC',S.canvasW/2,S.canvasH/2-50);
  e1.size=110;e1.font='Bebas Neue';e1.weight='400';e1.tracking=14;
  e1.gradient=true;e1.gradStart='#7c6cf0';e1.gradEnd='#22d3a8';e1.gradDir=135;
  e1.preset='bounce';e1.staggerMode='letter';e1.staggerDelay=60;e1.staggerDir='forward';
  e1.easing='out-bounce';e1.animStart=0.3;e1.animDuration=0.8;

  const e2=mkEl('TYPOGRAPHY',S.canvasW/2,S.canvasH/2+55);
  e2.size=40;e2.font='Raleway';e2.weight='200';e2.tracking=18;
  e2.fill='#8888a8';
  e2.preset='fade-up';e2.staggerMode='letter';e2.staggerDelay=35;e2.staggerDir='forward';
  e2.animStart=0.9;e2.animDuration=1.0;

  const e3=mkEl('STUDIO',S.canvasW/2,S.canvasH/2+110);
  e3.size=20;e3.font='Space Mono';e3.weight='400';e3.tracking=24;
  e3.fill='#555570';
  e3.preset='typewriter';e3.staggerMode='letter';e3.staggerDelay=80;e3.staggerDir='forward';
  e3.animStart=1.8;e3.animDuration=0.5;

  S.selectedId=e1.id;updUI();updGrid();updSafe();

  window.addEventListener('resize',()=>{resizeCanvas();render();});
  if(S.reducedMotion)toast('Reduced motion: effects minimized');
}
init();
</script>
</body>
</html>
