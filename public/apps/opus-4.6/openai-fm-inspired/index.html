<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenAI.fm â€” Text to Speech</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-primary: #090909;
  --bg-secondary: #111111;
  --bg-tertiary: #191919;
  --bg-elevated: #1e1e1e;
  --bg-hover: #1c1c1c;
  --bg-active: #252525;
  --border-subtle: #1e1e1e;
  --border-default: #2a2a2a;
  --border-emphasis: #3a3a3a;
  --text-primary: #ececec;
  --text-secondary: #999999;
  --text-tertiary: #666666;
  --text-muted: #444444;
  --accent: #10b981;
  --accent-dim: rgba(16, 185, 129, 0.12);
  --accent-hover: #0d9668;
  --danger: #ef4444;
  --purple: #a78bfa;
  --radius-xs: 6px;
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-pill: 100px;
  --ease: cubic-bezier(0.4, 0, 0.2, 1);
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
}

html { font-size: 16px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.5;
}

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-emphasis); }

/* ===== HEADER ===== */
.header {
  position: sticky; top: 0; z-index: 100;
  display: flex; align-items: center; justify-content: space-between;
  height: 56px; padding: 0 24px;
  background: rgba(9, 9, 9, 0.8);
  backdrop-filter: blur(16px) saturate(180%);
  -webkit-backdrop-filter: blur(16px) saturate(180%);
  border-bottom: 1px solid var(--border-subtle);
}

.logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--text-primary); }
.logo-mark {
  width: 28px; height: 28px;
  background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
  border-radius: 7px;
  display: grid; place-items: center;
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
}
.logo-mark svg { width: 16px; height: 16px; }
.logo-wordmark { font-size: 16px; font-weight: 600; letter-spacing: -0.3px; }
.logo-wordmark span { color: var(--text-tertiary); font-weight: 400; }

.nav-btns { display: flex; gap: 6px; }
.nav-btn {
  display: flex; align-items: center; gap: 6px;
  height: 32px; padding: 0 12px;
  background: transparent; border: 1px solid var(--border-default);
  border-radius: var(--radius-xs); color: var(--text-secondary);
  font: 500 12.5px/1 'Inter', sans-serif;
  cursor: pointer; transition: all 150ms var(--ease);
  white-space: nowrap;
}
.nav-btn:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-emphasis); }
.nav-btn svg { width: 14px; height: 14px; flex-shrink: 0; }

/* ===== LAYOUT ===== */
.app {
  max-width: 1440px; margin: 0 auto;
  padding: 28px 24px 40px;
  display: grid;
  grid-template-columns: 264px 1fr;
  gap: 28px;
  min-height: calc(100vh - 56px);
}

/* ===== SIDEBAR ===== */
.sidebar { display: flex; flex-direction: column; gap: 28px; }

.section-title {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 12px;
}
.section-title h3 {
  font-size: 11px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 1px; color: var(--text-tertiary);
}

/* Voice List */
.voice-list { display: flex; flex-direction: column; gap: 2px; }

.voice-item {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 10px; border-radius: var(--radius-sm);
  cursor: pointer; transition: all 120ms var(--ease);
  border: 1px solid transparent;
  position: relative;
}
.voice-item:hover { background: var(--bg-hover); }
.voice-item.selected {
  background: var(--bg-tertiary);
  border-color: var(--border-default);
}
.voice-item.selected::before {
  content: ''; position: absolute; left: -1px; top: 50%; transform: translateY(-50%);
  width: 3px; height: 20px; background: var(--accent);
  border-radius: 0 2px 2px 0;
}

.voice-avatar {
  width: 30px; height: 30px; border-radius: 50%;
  display: grid; place-items: center;
  font-size: 12px; font-weight: 600; flex-shrink: 0;
  transition: transform 120ms var(--ease-spring);
}
.voice-item:hover .voice-avatar { transform: scale(1.08); }

.voice-meta { flex: 1; min-width: 0; }
.voice-name {
  font-size: 13px; font-weight: 500; color: var(--text-primary);
  display: flex; align-items: center; gap: 5px;
}
.voice-badge { font-size: 11px; color: var(--purple); }
.voice-desc { font-size: 11px; color: var(--text-tertiary); margin-top: 1px; }

.shuffle-btn {
  display: flex; align-items: center; justify-content: center; gap: 7px;
  width: 100%; height: 36px; margin-top: 8px;
  background: transparent; border: 1px dashed var(--border-default);
  border-radius: var(--radius-sm); color: var(--text-tertiary);
  font: 500 12px/1 'Inter', sans-serif;
  cursor: pointer; transition: all 150ms var(--ease);
}
.shuffle-btn:hover { background: var(--bg-hover); color: var(--text-secondary); border-color: var(--border-emphasis); }
.shuffle-btn svg { width: 14px; height: 14px; }

/* Vibes */
.vibe-section { flex: 1; min-height: 0; display: flex; flex-direction: column; }
.vibe-grid {
  flex: 1; overflow-y: auto;
  display: flex; flex-wrap: wrap; gap: 5px;
  align-content: flex-start; padding-right: 2px;
}

.vibe-chip {
  display: inline-flex; align-items: center; gap: 4px;
  height: 30px; padding: 0 11px;
  background: transparent; border: 1px solid var(--border-default);
  border-radius: var(--radius-pill); color: var(--text-secondary);
  font: 400 11.5px/1 'Inter', sans-serif;
  cursor: pointer; transition: all 120ms var(--ease);
  white-space: nowrap;
}
.vibe-chip:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-emphasis); }
.vibe-chip.selected { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); font-weight: 500; }
.vibe-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); display: none; }
.vibe-chip.selected .vibe-dot { display: block; }

/* ===== CONTENT ===== */
.content { display: flex; flex-direction: column; gap: 16px; }

/* Info bar */
.info-bar {
  display: flex; align-items: center; justify-content: space-between;
}
.info-bar-left { display: flex; align-items: center; gap: 10px; }
.info-label { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
.info-voice-tag {
  display: inline-flex; align-items: center; gap: 5px;
  height: 24px; padding: 0 10px;
  background: var(--bg-tertiary); border-radius: var(--radius-pill);
  font-size: 11.5px; color: var(--text-secondary); font-weight: 500;
}
.info-voice-tag .circle { width: 7px; height: 7px; border-radius: 50%; }
.char-counter {
  font: 400 11.5px/1 'JetBrains Mono', monospace;
  color: var(--text-muted);
}

/* Text Area */
.editor-wrap {
  flex: 1; min-height: 260px;
  display: flex; flex-direction: column;
  background: var(--bg-secondary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  transition: border-color 200ms var(--ease);
  overflow: hidden;
}
.editor-wrap:focus-within { border-color: var(--border-emphasis); }

.editor-main {
  flex: 1; width: 100%; padding: 20px 22px;
  background: transparent; border: none;
  color: var(--text-primary); font: 400 14.5px/1.75 'Inter', sans-serif;
  resize: none; outline: none;
}
.editor-main::placeholder { color: var(--text-muted); }

/* System Prompt Accordion */
.sys-toggle {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 22px; border-top: 1px solid var(--border-subtle);
  cursor: pointer; user-select: none;
}
.sys-toggle-label { font-size: 12px; font-weight: 500; color: var(--text-tertiary); }
.sys-toggle-icon {
  width: 16px; height: 16px; display: grid; place-items: center;
  color: var(--text-muted); transition: transform 200ms var(--ease);
}
.sys-toggle-icon.open { transform: rotate(180deg); }
.sys-prompt-badge {
  font-size: 10px; font-weight: 500; color: var(--accent);
  background: var(--accent-dim); padding: 2px 7px;
  border-radius: var(--radius-pill); display: none;
}
.sys-prompt-badge.visible { display: inline-block; }

.sys-body { display: none; padding: 0 22px 16px; }
.sys-body.open { display: block; }
.sys-textarea {
  width: 100%; min-height: 72px; padding: 12px 14px;
  background: var(--bg-primary); border: 1px solid var(--border-default);
  border-radius: var(--radius-sm);
  color: var(--text-secondary);
  font: 400 12px/1.6 'JetBrains Mono', monospace;
  resize: vertical; outline: none;
  transition: border-color 200ms var(--ease);
}
.sys-textarea:focus { border-color: var(--border-emphasis); }
.sys-textarea::placeholder { color: var(--text-muted); }

/* ===== CONTROLS BAR ===== */
.controls {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
}

.generate-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  height: 42px; padding: 0 24px;
  background: var(--text-primary); color: var(--bg-primary);
  border: none; border-radius: var(--radius-sm);
  font: 600 13.5px/1 'Inter', sans-serif;
  cursor: pointer; transition: all 150ms var(--ease);
  flex-shrink: 0;
}
.generate-btn:hover { opacity: 0.92; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255,255,255,0.1); }
.generate-btn:active { transform: translateY(0); }
.generate-btn.loading { background: var(--accent); color: #fff; }
.generate-btn.playing { background: var(--accent); color: #fff; }
.generate-btn svg { width: 15px; height: 15px; flex-shrink: 0; }

/* Waveform */
.waveform { flex: 1; height: 42px; display: flex; align-items: center; justify-content: center; gap: 2px; overflow: hidden; position: relative; }
.wave-bar {
  width: 2.5px; min-height: 3px; border-radius: 1.5px;
  background: var(--border-default);
  transition: height 60ms linear, background 100ms var(--ease);
}
.wave-bar.lit { background: var(--accent); }

/* Progress bar overlay */
.wave-progress {
  position: absolute; left: 0; top: 0; bottom: 0;
  background: transparent; pointer-events: none;
}

.time-label {
  font: 400 11.5px/1 'JetBrains Mono', monospace;
  color: var(--text-muted); flex-shrink: 0; min-width: 68px; text-align: right;
}

.ctrl-btns { display: flex; gap: 4px; flex-shrink: 0; }
.ctrl-btn {
  display: grid; place-items: center;
  width: 36px; height: 36px;
  background: transparent; border: 1px solid var(--border-default);
  border-radius: var(--radius-xs); color: var(--text-tertiary);
  cursor: pointer; transition: all 120ms var(--ease);
}
.ctrl-btn:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-emphasis); }
.ctrl-btn svg { width: 15px; height: 15px; }
.ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; }

/* ===== CODE PANEL ===== */
.code-panel {
  display: none;
  background: var(--bg-secondary); border: 1px solid var(--border-default);
  border-radius: var(--radius-md); overflow: hidden;
  animation: slideDown 200ms var(--ease);
}
.code-panel.visible { display: block; }

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-8px); }
  to { opacity: 1; transform: translateY(0); }
}

.code-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 16px; border-bottom: 1px solid var(--border-subtle);
}
.code-tabs { display: flex; gap: 1px; background: var(--bg-primary); border-radius: var(--radius-xs); padding: 2px; }
.code-tab {
  padding: 5px 12px; border-radius: 5px;
  background: transparent; border: none;
  font: 500 11.5px/1 'JetBrains Mono', monospace;
  color: var(--text-tertiary); cursor: pointer;
  transition: all 120ms var(--ease);
}
.code-tab:hover { color: var(--text-secondary); }
.code-tab.active { background: var(--bg-tertiary); color: var(--text-primary); }

.code-copy {
  display: flex; align-items: center; gap: 5px;
  height: 28px; padding: 0 10px;
  background: transparent; border: 1px solid var(--border-default);
  border-radius: var(--radius-xs); color: var(--text-tertiary);
  font: 500 11px/1 'Inter', sans-serif;
  cursor: pointer; transition: all 120ms var(--ease);
}
.code-copy:hover { background: var(--bg-hover); color: var(--text-primary); }
.code-copy svg { width: 12px; height: 12px; }

.code-body { padding: 16px; overflow-x: auto; }
.code-body pre {
  font: 400 12.5px/1.7 'JetBrains Mono', monospace;
  color: var(--text-secondary); white-space: pre; tab-size: 2;
}
.code-body .kw { color: #c084fc; }
.code-body .str { color: #34d399; }
.code-body .fn { color: #60a5fa; }
.code-body .prop { color: #7dd3fc; }
.code-body .cm { color: #3a3a3a; }

/* ===== TOAST ===== */
.toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(80px);
  padding: 10px 20px; display: flex; align-items: center; gap: 8px;
  background: var(--bg-elevated); border: 1px solid var(--border-emphasis);
  border-radius: var(--radius-sm); box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  color: var(--text-primary); font-size: 13px; font-weight: 500;
  z-index: 9999; pointer-events: none; opacity: 0;
  transition: all 300ms var(--ease);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast-icon { color: var(--accent); display: flex; }

/* ===== KEYBOARD HINT ===== */
.kbd-hint {
  position: fixed; bottom: 12px; right: 16px;
  font-size: 11px; color: var(--text-muted);
  display: flex; align-items: center; gap: 5px;
}
.kbd {
  display: inline-flex; align-items: center; justify-content: center;
  height: 20px; min-width: 20px; padding: 0 5px;
  background: var(--bg-tertiary); border: 1px solid var(--border-default);
  border-radius: 4px; font-size: 10px; font-family: inherit;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 960px) {
  .app { grid-template-columns: 1fr; padding: 16px; gap: 20px; }
  .sidebar {
    flex-direction: row; gap: 16px;
    overflow-x: auto; -webkit-overflow-scrolling: touch;
    padding-bottom: 4px;
  }
  .voice-section { min-width: 240px; flex-shrink: 0; }
  .vibe-section { min-width: 280px; flex-shrink: 0; }
  .vibe-grid { max-height: 160px; }
  .header { padding: 0 16px; }
  .kbd-hint { display: none; }
  .controls { flex-wrap: wrap; }
  .waveform { order: 10; flex: none; width: 100%; }
}

@media (max-width: 640px) {
  .nav-btn span { display: none; }
  .nav-btn { padding: 0 8px; }
  .info-bar { flex-wrap: wrap; gap: 6px; }
}

/* ===== LOADING ANIMATION ===== */
@keyframes spin { to { transform: rotate(360deg); } }
.spinner {
  width: 15px; height: 15px; border: 2px solid rgba(0,0,0,0.2);
  border-top-color: currentColor; border-radius: 50%;
  animation: spin 600ms linear infinite;
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}
.shimmer-text {
  background: linear-gradient(90deg, currentColor 30%, var(--accent) 50%, currentColor 70%);
  background-size: 200% 100%;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: shimmer 1.5s ease infinite;
}
</style>
</head>
<body>

<!-- Header -->
<header class="header">
  <a class="logo" href="#">
    <div class="logo-mark">
      <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
        <line x1="12" x2="12" y1="19" y2="22"/>
      </svg>
    </div>
    <div class="logo-wordmark">OpenAI<span>.fm</span></div>
  </a>
  <div class="nav-btns">
    <button class="nav-btn" id="codeToggle" title="View API code">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
      <span>Code</span>
    </button>
    <button class="nav-btn" id="shareBtn" title="Share">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>
      <span>Share</span>
    </button>
  </div>
</header>

<!-- App -->
<main class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="voice-section">
      <div class="section-title"><h3>Voice</h3></div>
      <div class="voice-list" id="voiceList"></div>
      <button class="shuffle-btn" id="shuffleBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 14 4 4-4 4"/><path d="m18 2 4 4-4 4"/><path d="M2 18h1.973a4 4 0 0 0 3.3-1.7l5.454-8.6A4 4 0 0 1 16.026 6H22"/><path d="M2 6h1.972a4 4 0 0 1 3.6 2.2"/><path d="M22 18h-5.973a4 4 0 0 1-3.3-1.7L11.2 14"/></svg>
        Surprise me
      </button>
    </div>
    <div class="vibe-section">
      <div class="section-title"><h3>Vibe</h3></div>
      <div class="vibe-grid" id="vibeGrid"></div>
    </div>
  </aside>

  <!-- Content -->
  <div class="content">
    <!-- Info Bar -->
    <div class="info-bar">
      <div class="info-bar-left">
        <span class="info-label">Input Text</span>
        <span class="info-voice-tag" id="voiceTag"><span class="circle" id="voiceTagCircle"></span><span id="voiceTagName">Coral</span></span>
      </div>
      <span class="char-counter" id="charCount">0 / 4,096</span>
    </div>

    <!-- Editor -->
    <div class="editor-wrap">
      <textarea class="editor-main" id="inputText" placeholder="Type or paste the text you want to hear spoken aloud..." maxlength="4096" spellcheck="true"></textarea>
      <div class="sys-toggle" id="sysToggle">
        <svg class="sys-toggle-icon" id="sysChevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        <span class="sys-toggle-label">System prompt</span>
        <span class="sys-prompt-badge" id="sysBadge">Active</span>
      </div>
      <div class="sys-body" id="sysBody">
        <textarea class="sys-textarea" id="sysPrompt" placeholder="Instructions for how the voice should speak..."></textarea>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button class="generate-btn" id="genBtn">
        <svg id="genIcon" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="6,3 20,12 6,21"/></svg>
        <span id="genLabel">Generate</span>
      </button>

      <div class="waveform" id="waveform"></div>

      <span class="time-label" id="timeLabel">0:00</span>

      <div class="ctrl-btns">
        <button class="ctrl-btn" id="dlBtn" title="Download audio" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
        </button>
        <button class="ctrl-btn" id="stopBtn" title="Stop" disabled>
          <svg viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
        </button>
      </div>
    </div>

    <!-- Code Panel -->
    <div class="code-panel" id="codePanel">
      <div class="code-header">
        <div class="code-tabs" id="codeTabs">
          <button class="code-tab active" data-lang="python">Python</button>
          <button class="code-tab" data-lang="javascript">JavaScript</button>
          <button class="code-tab" data-lang="curl">cURL</button>
        </div>
        <button class="code-copy" id="codeCopy">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
          Copy
        </button>
      </div>
      <div class="code-body"><pre id="codeBlock"></pre></div>
    </div>
  </div>
</main>

<!-- Toast -->
<div class="toast" id="toast">
  <span class="toast-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></span>
  <span id="toastMsg"></span>
</div>

<!-- Keyboard Hint -->
<div class="kbd-hint">
  Press <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> to generate
</div>

<script>
// ===== DATA =====
const VOICES = [
  { id:'alloy',   name:'Alloy',   desc:'Neutral & balanced',   color:'#6366f1', premium:false },
  { id:'ash',     name:'Ash',     desc:'Clear & precise',      color:'#8b5cf6', premium:true },
  { id:'ballad',  name:'Ballad',  desc:'Melodic & smooth',     color:'#a78bfa', premium:true },
  { id:'coral',   name:'Coral',   desc:'Warm & friendly',      color:'#f472b6', premium:false },
  { id:'echo',    name:'Echo',    desc:'Resonant & deep',      color:'#38bdf8', premium:false },
  { id:'fable',   name:'Fable',   desc:'Expressive & bright',  color:'#fb923c', premium:false },
  { id:'onyx',    name:'Onyx',    desc:'Rich & authoritative', color:'#94a3b8', premium:false },
  { id:'nova',    name:'Nova',    desc:'Energetic & vibrant',  color:'#f43f5e', premium:false },
  { id:'sage',    name:'Sage',    desc:'Calm & thoughtful',    color:'#10b981', premium:true },
  { id:'shimmer', name:'Shimmer', desc:'Bright & sparkling',   color:'#eab308', premium:false },
  { id:'verse',   name:'Verse',   desc:'Versatile & dynamic',  color:'#06b6d4', premium:true },
];

const VIBES = [
  { id:'calm', name:'Calm', emoji:'\u{1F9D8}' },
  { id:'dramatic', name:'Dramatic', emoji:'\u{1F3AD}' },
  { id:'cheerleader', name:'Cheerleader', emoji:'\u{1F4E3}' },
  { id:'auctioneer', name:'Auctioneer', emoji:'\u{1F528}' },
  { id:'medieval_knight', name:'Medieval Knight', emoji:'\u{2694}\u{FE0F}' },
  { id:'smooth_jazz_dj', name:'Smooth Jazz DJ', emoji:'\u{1F3B7}' },
  { id:'fitness_instructor', name:'Fitness Coach', emoji:'\u{1F4AA}' },
  { id:'storyteller', name:'Storyteller', emoji:'\u{1F4D6}' },
  { id:'movie_trailer', name:'Movie Trailer', emoji:'\u{1F3AC}' },
  { id:'news_anchor', name:'News Anchor', emoji:'\u{1F4FA}' },
  { id:'sports_commentator', name:'Sports Caster', emoji:'\u{26BD}' },
  { id:'detective', name:'Detective', emoji:'\u{1F50D}' },
  { id:'sincere', name:'Sincere', emoji:'\u{1F49D}' },
  { id:'stand_up_comic', name:'Stand-Up Comic', emoji:'\u{1F3A4}' },
  { id:'wise_elder', name:'Wise Elder', emoji:'\u{1F989}' },
  { id:'surfer', name:'Surfer', emoji:'\u{1F3C4}' },
  { id:'radio_host', name:'Radio Host', emoji:'\u{1F4FB}' },
  { id:'poetry_reader', name:'Poetry Reader', emoji:'\u{2728}' },
  { id:'doctor', name:'Doctor', emoji:'\u{1FA7A}' },
  { id:'game_show_host', name:'Game Show Host', emoji:'\u{1F3B0}' },
  { id:'food_critic', name:'Food Critic', emoji:'\u{1F377}' },
  { id:'tour_guide', name:'Tour Guide', emoji:'\u{1F5FA}\u{FE0F}' },
  { id:'librarian', name:'Librarian', emoji:'\u{1F4DA}' },
  { id:'life_coach', name:'Life Coach', emoji:'\u{1F31F}' },
  { id:'angry', name:'Angry', emoji:'\u{1F624}' },
  { id:'romantic', name:'Romantic', emoji:'\u{1F495}' },
  { id:'energetic', name:'Energetic', emoji:'\u{26A1}' },
  { id:'contemplative', name:'Contemplative', emoji:'\u{1F914}' },
  { id:'playful', name:'Playful', emoji:'\u{1F388}' },
  { id:'nostalgic', name:'Nostalgic', emoji:'\u{1F305}' },
];

const VIBE_PROMPTS = {
  calm:"Voice: Calm, composed, reassuring. Tone: Sincere, empathetic, gently authoritative. Pacing: Steady, moderate, unhurried. Emotion: Genuine empathy and warmth. Emphasis: Highlight reassurances like 'smoothly,' 'quickly,' 'promptly.'",
  dramatic:"Voice: Low, hushed, suspenseful. Tone: Deeply serious, mysterious. Pacing: Slow, deliberate, pausing for tension. Emotion: Restrained yet intense. Pronunciation: Elongated vowels, softened consonants for haunting effect.",
  cheerleader:"Voice: High, bubbly, enthusiastic. Tone: Playful, encouraging, everything exciting. Pacing: Fast, energetic, short quick sentences. Emotion: Bright and lively. Emphasis: 'go,' 'team,' 'win.'",
  auctioneer:"Voice: Staccato, fast-paced, energetic, rhythmic. Tone: Exciting, high-energy, persuasive. Pacing: Rapid-fire yet clear, dynamic inflections. Emphasis: 'bid,' 'buy,' 'sold.'",
  medieval_knight:"Voice: Deep, commanding, dramatic, archaic, reverent. Tone: Noble, heroic, formal, Olde English charm. Pacing: Deliberate pauses after 'Lo!' or 'Hark!' Pronunciation: Slow emphasis on 'hast,' 'thou,' 'doth.'",
  smooth_jazz_dj:"Voice: Smooth, melodic, soulful, sophisticated. Tone: Warm, inviting, relaxed atmosphere. Pacing: Moderate with smooth pauses. Emotion: Relaxed and soothing.",
  fitness_instructor:"Voice: High-energy, upbeat, encouraging. Tone: Positive, energetic, empowering. Pacing: Fast-paced, dynamic, rising intonation. Emphasis: Key motivational words.",
  storyteller:"Voice: Engaging, expressive, narrative-focused. Tone: Captivating, emotive, drawing listeners in. Pacing: Varied, adapting to story rhythm. Pauses: Dramatic pauses for effect.",
  movie_trailer:"Voice: Epic, intense, dramatic. Tone: Powerful, commanding, grand scale. Pacing: Dynamic, building from intrigue to excitement. Pauses: Dramatic for suspense.",
  news_anchor:"Voice: Authoritative, clear, professional. Tone: Neutral, objective, formal. Pacing: Measured, steady. Emotion: Unbiased, composed.",
  sports_commentator:"Voice: Dynamic, excited, detailed. Tone: Enthusiastic, informative, live action. Pacing: Rapid, detailed. Emotion: Excited, passionate.",
  detective:"Voice: Analytical, mysterious, focused. Tone: Serious, observant. Pacing: Measured, deliberate. Emotion: Intrigued, focused.",
  sincere:"Voice: Calm, composed, reassuring. Tone: Sincere, empathetic, genuine concern. Pacing: Slower for empathy, faster for solutions. Emotion: Reassurance, empathy, gratitude.",
  stand_up_comic:"Voice: Humorous, timing-focused, engaging. Tone: Playful, comedic. Pacing: Rhythmic, essential for timing. Pauses: Comedic pauses for reaction.",
  wise_elder:"Voice: Thoughtful, experienced, sage-like. Tone: Reflective, gentle, peaceful wisdom. Pacing: Slow, deliberate. Pauses: Reflective, for pondering.",
  surfer:"Voice: Laid-back, casual, friendly. Tone: Relaxed, approachable, chill. Pacing: Slow, easygoing. Emotion: Carefree, positive.",
  radio_host:"Voice: Engaging, conversational, dynamic. Tone: Friendly, approachable, lively. Pacing: Varied, energetic. Emotion: Enthusiastic, expressive.",
  poetry_reader:"Voice: Rhythmic, emotive, artistic. Tone: Expressive, lyrical, resonant. Pacing: Rhythmic, flowing. Pauses: Poetic pauses for impact.",
  doctor:"Voice: Compassionate, knowledgeable, reassuring. Tone: Caring, professional, trustworthy. Pacing: Calm, steady. Emotion: Empathetic, understanding.",
  game_show_host:"Voice: Energetic, charismatic, entertaining. Tone: Enthusiastic, engaging, competitive. Pacing: Fast-paced, dynamic. Pauses: Brief for dramatic effect.",
  food_critic:"Voice: Descriptive, sophisticated, expressive. Tone: Refined, articulate. Pacing: Moderate, descriptive. Emphasis: Sensory details, flavor profiles.",
  tour_guide:"Voice: Informative, enthusiastic, descriptive. Tone: Upbeat, engaging. Pacing: Moderate. Emotion: Passionate about the subject.",
  librarian:"Voice: Quiet, helpful, knowledgeable. Tone: Gentle, informative, peaceful. Pacing: Slow, clear. Emotion: Calm, patient.",
  life_coach:"Voice: Motivational, empowering, encouraging. Tone: Uplifting, supportive. Pacing: Energetic. Emphasis: Action-oriented phrases.",
  angry:"Voice: Intense, passionate, projecting fury. Tone: Irritated, hostile, strong displeasure. Pacing: Rapid, forceful. Pronunciation: Sharp, clipped consonants.",
  romantic:"Voice: Warm, gentle, projecting romance. Tone: Affectionate, tender. Pacing: Gentle, flowing. Pauses: Soft, tender.",
  energetic:"Voice: Dynamic, lively, high energy. Tone: Enthusiastic, vibrant. Pacing: Fast, dynamic. Pauses: Minimal, continuous energy.",
  contemplative:"Voice: Pensive, calm, thoughtful. Tone: Reflective, introspective. Pacing: Slow, measured. Pauses: Extended for reflection.",
  playful:"Voice: Lively, bright, joyful. Tone: Lighthearted, cheerful. Pacing: Lively, varied. Pauses: Short, cheerful.",
  nostalgic:"Voice: Warm, gentle, sentimental. Tone: Sentimental, warm, fond memories. Pacing: Slow, reflective. Pauses: Gentle, for reminiscing.",
};

const SAMPLE_TEXTS = {
  calm:"Take a deep breath in... and slowly let it out. Feel the tension melting away from your shoulders. You're exactly where you need to be right now. Let's take this one step at a time, together.",
  dramatic:"The footsteps echoed through the empty corridor. She paused, her heart hammering against her ribs. Behind her, only shadows melting into darkness. Ahead, a single door \u2014 slightly ajar \u2014 with a faint, golden light spilling through the crack.",
  cheerleader:"Oh my gosh, you are going to absolutely CRUSH it today! Let's go! Every step you take is a step closer to being the best version of yourself. You've got the energy, you've got the talent \u2014 now let's GOOOO!",
  auctioneer:"And we've got a beautiful vintage 1962 cherry red convertible, folks! Starting the bid at ten thousand \u2014 do I hear ten? Ten thousand! Fifteen! Twenty! We're at twenty thousand, ladies and gentlemen \u2014 going once, going twice \u2014 SOLD!",
  medieval_knight:"Hark! Brave adventurer, thou hast ventured into the realm of the Forgotten King. Lo, before thee lies a path most treacherous. Steel thy resolve, for the quest ahead shall test thy courage and thy honor, noble knight!",
  smooth_jazz_dj:"Hey there, night owls... you're listening to Midnight Velvet on 98.7 FM. Coming up next, we've got a silky smooth number by Miles Davis that'll carry you right through to the moonlight. Sit back, relax, and let the music take you somewhere beautiful.",
  fitness_instructor:"Alright team, let's pick up the pace! Come on, you've got this! Thirty more seconds \u2014 push through it! I can see you getting stronger with every rep. Don't you dare stop now! Let's GO!",
  storyteller:"Once upon a time, in a village nestled between two ancient mountains, there lived a girl who could hear the whispers of the wind. They told her stories of faraway lands, of hidden treasures, and of a destiny that was uniquely hers.",
  movie_trailer:"In a world where nothing is as it seems... one hero must rise against impossible odds. This summer, the stakes have never been higher. The fate of humanity rests in the hands of an unlikely champion. Are you ready?",
  news_anchor:"Good evening. Tonight's top story: Scientists at the International Research Center have announced a groundbreaking discovery that could revolutionize renewable energy. The findings, published today in the journal Nature, suggest a new approach to solar cell efficiency.",
  sports_commentator:"And he's breaking through the defense! He's past the thirty, the twenty \u2014 look at that speed! He's at the ten, the five \u2014 TOUCHDOWN! What an incredible play! The crowd is going absolutely wild here tonight, folks!",
  detective:"The rain hadn't stopped for three days. I studied the crime scene one more time \u2014 something didn't add up. The window was locked from the inside, yet there were muddy footprints leading to the balcony. Someone wanted us to think this was impossible.",
  sincere:"I want you to know that I truly appreciate everything you've done. It hasn't gone unnoticed. Your dedication and kindness have made a real difference, and I'm grateful to have you in my life. Thank you, from the bottom of my heart.",
  stand_up_comic:"So I tried to order a coffee today, right? And the barista asks me, 'Do you want it for here or to go?' I said, 'Both. I want to drink it here, but I also want it to leave \u2014 kind of like my ex.'",
  wise_elder:"My child, wisdom does not come from having all the answers. It comes from learning to sit comfortably with the questions. The river does not rush to reach the sea \u2014 it flows, and in flowing, it shapes the world around it.",
  surfer:"Dude, you should've seen the waves this morning. Like, totally perfect barrels rolling in, one after another. I caught this one ride that just... whoa. It was like time stopped, you know? Just me and the ocean, vibing.",
  radio_host:"Good morning, beautiful people! You're tuned in to the Morning Buzz with yours truly. We've got an absolutely stacked show for you today \u2014 new music, hot takes, and we're giving away concert tickets in the next hour!",
  poetry_reader:"Do not go gentle into that good night. Old age should burn and rave at close of day. Rage, rage against the dying of the light. Though wise men at their end know dark is right, because their words had forked no lightning, they do not go gentle into that good night.",
  doctor:"I understand your concerns, and I want you to know we're going to take very good care of you. The test results look promising. Let me walk you through everything step by step, so you know exactly what to expect.",
  game_show_host:"Welcome back to the show, everybody! Our contestant has made it all the way to the final round! For one million dollars \u2014 are you ready? Here's your question... and remember, you still have one lifeline left!",
  food_critic:"The amuse-bouche was a revelation \u2014 a delicate sphere of yuzu gel resting on a bed of micro-shiso, with just a whisper of white soy. It was the kind of bite that stops conversation and demands your complete attention.",
  tour_guide:"And if you look to your left, you'll see the magnificent Cathedral of Notre-Dame, dating back to the 12th century. Notice the stunning rose window \u2014 it's over 13 meters in diameter and contains 84 panes of glass!",
  librarian:"Oh, you're interested in mythology? Let me show you our collection. We have a wonderful section on Greek myths right this way. And if you'd like something more contemporary, Neil Gaiman's Norse Mythology is a beautiful retelling.",
  life_coach:"Listen, I believe in you \u2014 and more importantly, you need to believe in yourself. Every successful person started exactly where you are now. The only difference? They took that first step. What's your first step today?",
  angry:"Are you kidding me right now?! I specifically asked for this to be handled LAST WEEK. No excuses! I don't want to hear 'we'll get to it.' We needed it done YESTERDAY. This is completely unacceptable!",
  romantic:"When I look at you, the rest of the world fades away. Every moment with you feels like a gift I never expected. Your laugh is my favorite sound, your smile my favorite sight. I didn't know my heart could feel this full.",
  energetic:"Let's GO! This is going to be the most AMAZING day ever! I've got so many incredible things planned \u2014 we're going to make every single second count! Who's with me? Come on, bring that energy! YES!",
  contemplative:"I've been thinking a lot about the nature of time lately. How it seems to stretch endlessly in childhood, then compress as we age. Perhaps it's not time that changes, but our relationship with the present moment.",
  playful:"Okay okay okay, so here's my totally serious question: if you could have any superpower, but it had to be completely useless \u2014 like always knowing what flavor of ice cream someone last ate \u2014 what would you pick?",
  nostalgic:"Remember those summer evenings when we were kids? Running through the sprinklers until the streetlights came on. The smell of fresh-cut grass and barbecue smoke drifting through the neighborhood. Everything felt infinite back then.",
};

// ===== STATE =====
const S = {
  voice: 'coral', vibe: 'storyteller',
  playing: false, generating: false,
  audioCtx: null, analyser: null, source: null, audioBuffer: null,
  raf: null, startT: 0, dur: 0,
  codeLang: 'python', codeOpen: false, sysOpen: false,
  utterance: null, synthPlaying: false,
};

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  renderVoices();
  renderVibes();
  initWaveform();
  setVibeContent();
  updateVoiceTag();
  updateCode();

  const ta = $('inputText');
  ta.addEventListener('input', updateCharCount);
  updateCharCount();

  $('genBtn').addEventListener('click', handleGenerate);
  $('stopBtn').addEventListener('click', stopAll);
  $('dlBtn').addEventListener('click', handleDownload);
  $('shuffleBtn').addEventListener('click', handleShuffle);
  $('codeToggle').addEventListener('click', toggleCode);
  $('shareBtn').addEventListener('click', handleShare);
  $('codeCopy').addEventListener('click', handleCopyCode);
  $('sysToggle').addEventListener('click', toggleSys);

  document.querySelectorAll('.code-tab').forEach(t => {
    t.addEventListener('click', () => {
      document.querySelectorAll('.code-tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      S.codeLang = t.dataset.lang;
      updateCode();
    });
  });

  // Keyboard shortcut
  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      handleGenerate();
    }
  });
});

function $(id) { return document.getElementById(id); }

// ===== RENDER =====
function renderVoices() {
  $('voiceList').innerHTML = VOICES.map(v => `
    <div class="voice-item ${v.id === S.voice ? 'selected' : ''}" onclick="pickVoice('${v.id}')">
      <div class="voice-avatar" style="background:${v.color}18;color:${v.color}">${v.name[0]}</div>
      <div class="voice-meta">
        <div class="voice-name">${v.name}${v.premium ? ' <span class="voice-badge">\u2726</span>' : ''}</div>
        <div class="voice-desc">${v.desc}</div>
      </div>
    </div>
  `).join('');
}

function renderVibes() {
  $('vibeGrid').innerHTML = VIBES.map(v => `
    <button class="vibe-chip ${v.id === S.vibe ? 'selected' : ''}" onclick="pickVibe('${v.id}')">
      <span class="vibe-dot"></span>${v.emoji} ${v.name}
    </button>
  `).join('');
}

// ===== SELECTIONS =====
function pickVoice(id) {
  S.voice = id;
  renderVoices();
  updateVoiceTag();
  updateCode();
}

function pickVibe(id) {
  S.vibe = id;
  renderVibes();
  setVibeContent();
  updateCode();
}

function setVibeContent() {
  const ta = $('inputText');
  if (!ta.value || Object.values(SAMPLE_TEXTS).includes(ta.value)) {
    ta.value = SAMPLE_TEXTS[S.vibe] || SAMPLE_TEXTS.calm;
    updateCharCount();
  }
  $('sysPrompt').value = VIBE_PROMPTS[S.vibe] || '';
  $('sysBadge').classList.toggle('visible', !!VIBE_PROMPTS[S.vibe]);
}

function updateVoiceTag() {
  const v = VOICES.find(x => x.id === S.voice);
  if (!v) return;
  $('voiceTagName').textContent = v.name;
  $('voiceTagCircle').style.background = v.color;
}

// ===== WAVEFORM =====
const NUM_BARS = 80;
function initWaveform() {
  const w = $('waveform');
  w.innerHTML = '';
  for (let i = 0; i < NUM_BARS; i++) {
    const b = document.createElement('div');
    b.className = 'wave-bar';
    b.style.height = '3px';
    w.appendChild(b);
  }
}

function animateWaveform() {
  if (!S.playing) return;
  const bars = document.querySelectorAll('.wave-bar');

  if (S.analyser) {
    const data = new Uint8Array(S.analyser.frequencyBinCount);
    S.analyser.getByteFrequencyData(data);
    const step = Math.floor(data.length / NUM_BARS);
    for (let i = 0; i < NUM_BARS; i++) {
      const val = data[i * step] || 0;
      const h = Math.max(3, (val / 255) * 38);
      bars[i].style.height = h + 'px';
      bars[i].classList.toggle('lit', val > 25);
    }
  } else if (S.synthPlaying) {
    // Simulated waveform for Web Speech API
    for (let i = 0; i < NUM_BARS; i++) {
      const t = performance.now() / 1000;
      const val = Math.sin(t * 3 + i * 0.3) * 0.3 + Math.sin(t * 7 + i * 0.15) * 0.2 + 0.5;
      const h = Math.max(3, val * 32);
      bars[i].style.height = h + 'px';
      bars[i].classList.toggle('lit', val > 0.4);
    }
  }

  if (S.audioCtx && S.startT) {
    const elapsed = S.audioCtx.currentTime - S.startT;
    $('timeLabel').textContent = fmtTime(elapsed) + ' / ' + fmtTime(S.dur);
  } else if (S.synthPlaying && S.startT) {
    const elapsed = (performance.now() - S.startT) / 1000;
    $('timeLabel').textContent = fmtTime(elapsed);
  }

  S.raf = requestAnimationFrame(animateWaveform);
}

function resetWaveform() {
  document.querySelectorAll('.wave-bar').forEach(b => {
    b.style.height = '3px';
    b.classList.remove('lit');
  });
}

function fmtTime(s) { return Math.floor(s/60) + ':' + String(Math.floor(s%60)).padStart(2,'0'); }

// ===== AUDIO GENERATION =====
function synthAudio(text, voice, vibe) {
  return new Promise(resolve => {
    const sr = 44100;
    const words = text.trim().split(/\s+/).length;
    const baseDur = Math.max(2, (words / 140) * 60);
    const speedMod = { calm:1.3, dramatic:1.4, cheerleader:0.7, auctioneer:0.5, medieval_knight:1.3,
      smooth_jazz_dj:1.2, fitness_instructor:0.7, storyteller:1.1, movie_trailer:1.3, news_anchor:1.0,
      sports_commentator:0.6, detective:1.2, sincere:1.1, stand_up_comic:0.9, wise_elder:1.4, surfer:1.1,
      radio_host:0.8, poetry_reader:1.3, doctor:1.1, game_show_host:0.8, food_critic:1.1, tour_guide:1.0,
      librarian:1.2, life_coach:0.9, angry:0.7, romantic:1.3, energetic:0.6, contemplative:1.4, playful:0.8, nostalgic:1.3 };
    const dur = baseDur * (speedMod[vibe] || 1);
    const vp = {
      alloy:{f0:180,f1:800,f2:1200,r:0.6,br:0.3}, ash:{f0:145,f1:700,f2:1100,r:0.7,br:0.2},
      ballad:{f0:200,f1:850,f2:1300,r:0.8,br:0.4}, coral:{f0:220,f1:900,f2:1400,r:0.7,br:0.35},
      echo:{f0:120,f1:650,f2:1000,r:0.9,br:0.15}, fable:{f0:240,f1:950,f2:1500,r:0.65,br:0.4},
      onyx:{f0:100,f1:600,f2:950,r:0.95,br:0.1}, nova:{f0:260,f1:1000,f2:1600,r:0.6,br:0.45},
      sage:{f0:160,f1:750,f2:1150,r:0.75,br:0.25}, shimmer:{f0:280,f1:1050,f2:1700,r:0.55,br:0.5},
      verse:{f0:170,f1:780,f2:1200,r:0.8,br:0.3}
    }[voice] || {f0:180,f1:800,f2:1200,r:0.6,br:0.3};

    const len = Math.floor(sr * dur);
    const ctx = new OfflineAudioContext(1, len, sr);
    const buf = ctx.createBuffer(1, len, sr);
    const d = buf.getChannelData(0);

    // Seed a simple PRNG for deterministic noise
    let seed = 12345;
    function rng() { seed = (seed * 16807) % 2147483647; return (seed - 1) / 2147483646; }

    for (let i = 0; i < len; i++) {
      const t = i / sr;
      // Prosody contour
      const sentP = (t % 3.2) / 3.2;
      const pitch = 1 + 0.07 * Math.sin(sentP * Math.PI) - 0.03 * sentP;
      // Word stress
      const wP = (t % 0.35) / 0.35;
      const wS = 0.8 + 0.2 * Math.sin(wP * Math.PI);
      // F0 with jitter
      const f0 = vp.f0 * pitch * (1 + 0.012 * Math.sin(t * 6.3));
      // Glottal pulse (LF model approx)
      const ph = (t * f0) % 1;
      let gl = 0;
      if (ph < 0.4) gl = 3 * ph * (1 - ph / 0.4);
      else if (ph < 0.55) gl = (0.55 - ph) / 0.15;
      // Formant modulation
      const fm = Math.sin(2*Math.PI*t*vp.f1/sr*180)*0.25 + Math.sin(2*Math.PI*t*vp.f2/sr*260)*0.12;
      // Aspiration
      const n = (rng()*2-1) * vp.br;
      // Syllable envelope
      const sP = (t/0.14) % 1;
      const sE = Math.sin(sP * Math.PI) * 0.65 + 0.35;
      // Pause pattern
      const pp = Math.sin(t * 0.7) * 0.45 + 0.55;
      const bp = (t % 2.6) < 0.12 ? 0 : 1;
      // Combine
      let s = (gl * vp.r + n) * sE * wS * bp + fm * gl * 0.18;
      // Fade
      const fi = Math.min(1, t/0.04);
      const fo = Math.min(1, (dur - t)/0.08);
      d[i] = s * fi * fo * 0.28 * pp;
    }
    // Low pass
    for (let i = 2; i < len; i++) d[i] = d[i]*0.25 + d[i-1]*0.5 + d[i-2]*0.25;
    // Normalize
    let mx = 0;
    for (let i = 0; i < len; i++) mx = Math.max(mx, Math.abs(d[i]));
    if (mx > 0) { const sc = 0.65/mx; for (let i = 0; i < len; i++) d[i] *= sc; }

    resolve({ buffer: buf, duration: dur });
  });
}

// ===== PLAYBACK =====
async function handleGenerate() {
  const text = $('inputText').value.trim();
  if (!text) return toast('Enter some text first');
  if (S.playing || S.generating) { stopAll(); return; }

  const btn = $('genBtn'), lbl = $('genLabel'), icon = $('genIcon');
  S.generating = true;
  btn.classList.add('loading');
  lbl.innerHTML = '<span class="shimmer-text">Generating\u2026</span>';
  icon.innerHTML = '<div class="spinner"></div>';
  $('stopBtn').disabled = false;

  // Add a small delay for effect
  await new Promise(r => setTimeout(r, 400));

  // Try browser speech synthesis first for real voice, with Web Audio as waveform backing
  const hasSpeech = 'speechSynthesis' in window;

  if (hasSpeech) {
    try {
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);

      // Map voice id to speech settings
      const voiceRateMap = {
        calm:0.85, dramatic:0.75, cheerleader:1.2, auctioneer:1.5, medieval_knight:0.8,
        smooth_jazz_dj:0.85, fitness_instructor:1.3, storyteller:0.9, movie_trailer:0.8,
        news_anchor:0.95, sports_commentator:1.3, detective:0.85, sincere:0.9, stand_up_comic:1.05,
        wise_elder:0.75, surfer:0.9, radio_host:1.1, poetry_reader:0.8, doctor:0.9,
        game_show_host:1.15, food_critic:0.9, tour_guide:0.95, librarian:0.85, life_coach:1.05,
        angry:1.2, romantic:0.8, energetic:1.3, contemplative:0.7, playful:1.1, nostalgic:0.8
      };
      const voicePitchMap = {
        alloy:1, ash:0.85, ballad:1.1, coral:1.15, echo:0.7, fable:1.2,
        onyx:0.6, nova:1.3, sage:0.9, shimmer:1.4, verse:1
      };

      utter.rate = voiceRateMap[S.vibe] || 1;
      utter.pitch = voicePitchMap[S.voice] || 1;
      utter.volume = 1;

      // Try to find a good voice
      const voices = window.speechSynthesis.getVoices();
      if (voices.length > 0) {
        const preferred = voices.find(v => v.lang.startsWith('en') && v.localService) ||
                         voices.find(v => v.lang.startsWith('en')) ||
                         voices[0];
        if (preferred) utter.voice = preferred;
      }

      S.utterance = utter;
      S.synthPlaying = true;
      S.playing = true;
      S.startT = performance.now();

      utter.onend = () => { stopAll(); };
      utter.onerror = () => { stopAll(); };

      window.speechSynthesis.speak(utter);

      // Update UI
      S.generating = false;
      btn.classList.remove('loading');
      btn.classList.add('playing');
      lbl.textContent = 'Playing';
      lbl.classList.remove('shimmer-text');
      icon.innerHTML = '<rect x="6" y="5" width="4" height="14" rx="1" fill="currentColor"/><rect x="14" y="5" width="4" height="14" rx="1" fill="currentColor"/>';
      $('dlBtn').disabled = true; // Can't download speech synth
      animateWaveform();
      return;

    } catch(e) {
      // Fall through to Web Audio synth
    }
  }

  // Fallback: synthesize audio buffer
  try {
    const { buffer, duration } = await synthAudio(text, S.voice, S.vibe);
    if (!S.audioCtx || S.audioCtx.state === 'closed') {
      S.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    const live = S.audioCtx.createBuffer(1, buffer.getChannelData(0).length, buffer.sampleRate);
    live.getChannelData(0).set(buffer.getChannelData(0));
    S.audioBuffer = live;
    S.dur = duration;

    S.analyser = S.audioCtx.createAnalyser();
    S.analyser.fftSize = 256;
    S.analyser.smoothingTimeConstant = 0.65;

    S.source = S.audioCtx.createBufferSource();
    S.source.buffer = live;
    S.source.connect(S.analyser);
    S.analyser.connect(S.audioCtx.destination);
    S.source.onended = () => { if (S.playing) stopAll(); };

    S.startT = S.audioCtx.currentTime;
    S.source.start(0);
    S.playing = true;
    S.generating = false;

    btn.classList.remove('loading');
    btn.classList.add('playing');
    lbl.textContent = 'Playing';
    lbl.classList.remove('shimmer-text');
    icon.innerHTML = '<rect x="6" y="5" width="4" height="14" rx="1" fill="currentColor"/><rect x="14" y="5" width="4" height="14" rx="1" fill="currentColor"/>';
    $('dlBtn').disabled = false;
    animateWaveform();

  } catch(e) {
    console.error(e);
    S.generating = false;
    resetGenBtn();
    toast('Generation failed');
  }
}

function stopAll() {
  // Stop speech synth
  if (S.utterance) { window.speechSynthesis.cancel(); S.utterance = null; }
  S.synthPlaying = false;

  // Stop Web Audio
  if (S.source) { try { S.source.stop(); } catch(e) {} S.source = null; }
  if (S.raf) { cancelAnimationFrame(S.raf); S.raf = null; }

  S.playing = false;
  S.generating = false;
  S.startT = 0;

  resetGenBtn();
  $('timeLabel').textContent = '0:00';
  $('stopBtn').disabled = true;
  resetWaveform();
}

function resetGenBtn() {
  const btn = $('genBtn'), lbl = $('genLabel'), icon = $('genIcon');
  btn.classList.remove('loading','playing');
  lbl.textContent = 'Generate';
  lbl.classList.remove('shimmer-text');
  icon.innerHTML = '<polygon points="6,3 20,12 6,21"/>';
}

// ===== DOWNLOAD =====
function handleDownload() {
  if (!S.audioBuffer) return toast('Generate audio first');
  const d = S.audioBuffer.getChannelData(0);
  const sr = S.audioBuffer.sampleRate;
  const wav = encodeWAV(d, sr);
  const blob = new Blob([wav], { type:'audio/wav' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `openai-fm-${S.voice}-${S.vibe}.wav`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Audio downloaded');
}

function encodeWAV(samples, sr) {
  const buf = new ArrayBuffer(44 + samples.length * 2);
  const v = new DataView(buf);
  const ws = (o, s) => { for (let i = 0; i < s.length; i++) v.setUint8(o+i, s.charCodeAt(i)); };
  ws(0,'RIFF'); v.setUint32(4, 36+samples.length*2, true);
  ws(8,'WAVE'); ws(12,'fmt ');
  v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,1,true);
  v.setUint32(24,sr,true); v.setUint32(28,sr*2,true); v.setUint16(32,2,true); v.setUint16(34,16,true);
  ws(36,'data'); v.setUint32(40,samples.length*2,true);
  let o = 44;
  for (let i = 0; i < samples.length; i++) {
    const s = Math.max(-1, Math.min(1, samples[i]));
    v.setInt16(o, s<0 ? s*0x8000 : s*0x7FFF, true); o += 2;
  }
  return buf;
}

// ===== SHUFFLE =====
function handleShuffle() {
  const rv = VOICES[Math.floor(Math.random()*VOICES.length)];
  const rb = VIBES[Math.floor(Math.random()*VIBES.length)];
  pickVoice(rv.id);
  pickVibe(rb.id);
  toast(rv.name + ' \u00D7 ' + rb.name);
}

// ===== CODE PANEL =====
function toggleCode() {
  S.codeOpen = !S.codeOpen;
  $('codePanel').classList.toggle('visible', S.codeOpen);
  updateCode();
}

function updateCode() {
  const v = S.voice, p = (VIBE_PROMPTS[S.vibe]||'').substring(0,80);
  const snip = {
    python: `<span class="kw">from</span> openai <span class="kw">import</span> OpenAI

client = OpenAI()

response = client.audio.speech.<span class="fn">create</span>(
    model=<span class="str">"gpt-4o-mini-tts"</span>,
    voice=<span class="str">"${v}"</span>,
    input=<span class="str">"Your text here..."</span>,
    instructions=<span class="str">"${p}..."</span>
)

response.<span class="fn">stream_to_file</span>(<span class="str">"output.mp3"</span>)`,
    javascript: `<span class="kw">import</span> OpenAI <span class="kw">from</span> <span class="str">"openai"</span>;
<span class="kw">import</span> fs <span class="kw">from</span> <span class="str">"fs"</span>;

<span class="kw">const</span> client = <span class="kw">new</span> <span class="fn">OpenAI</span>();

<span class="kw">const</span> response = <span class="kw">await</span> client.audio.speech.<span class="fn">create</span>({
  <span class="prop">model</span>: <span class="str">"gpt-4o-mini-tts"</span>,
  <span class="prop">voice</span>: <span class="str">"${v}"</span>,
  <span class="prop">input</span>: <span class="str">"Your text here..."</span>,
  <span class="prop">instructions</span>: <span class="str">"${p}..."</span>
});

<span class="kw">const</span> buf = Buffer.<span class="fn">from</span>(<span class="kw">await</span> response.<span class="fn">arrayBuffer</span>());
fs.<span class="fn">writeFileSync</span>(<span class="str">"output.mp3"</span>, buf);`,
    curl: `<span class="fn">curl</span> https://api.openai.com/v1/audio/speech \\
  -H <span class="str">"Authorization: Bearer $OPENAI_API_KEY"</span> \\
  -H <span class="str">"Content-Type: application/json"</span> \\
  -d <span class="str">'{
    "model": "gpt-4o-mini-tts",
    "voice": "${v}",
    "input": "Your text here...",
    "instructions": "${p.substring(0,60)}..."
  }'</span> \\
  --output <span class="str">output.mp3</span>`,
  };
  $('codeBlock').innerHTML = snip[S.codeLang] || snip.python;
}

function handleCopyCode() {
  const t = $('codeBlock').textContent;
  navigator.clipboard.writeText(t).then(() => toast('Code copied')).catch(() => toast('Copy failed'));
}

// ===== SYSTEM PROMPT =====
function toggleSys() {
  S.sysOpen = !S.sysOpen;
  $('sysBody').classList.toggle('open', S.sysOpen);
  $('sysChevron').classList.toggle('open', S.sysOpen);
}

// ===== SHARE =====
function handleShare() {
  const cfg = { v: S.voice, b: S.vibe, t: $('inputText').value.substring(0,200) };
  const url = location.origin + location.pathname + '?s=' + btoa(JSON.stringify(cfg));
  navigator.clipboard.writeText(url).then(() => toast('Share link copied')).catch(() => toast('Copy failed'));
}

// ===== UTILS =====
function updateCharCount() {
  $('charCount').textContent = $('inputText').value.length.toLocaleString() + ' / 4,096';
}

function toast(msg) {
  const t = $('toast');
  $('toastMsg').textContent = msg;
  t.classList.add('show');
  clearTimeout(t._t);
  t._t = setTimeout(() => t.classList.remove('show'), 2200);
}

// Load shared state
(function() {
  const p = new URLSearchParams(location.search).get('s');
  if (!p) return;
  try {
    const c = JSON.parse(atob(p));
    if (c.v) S.voice = c.v;
    if (c.b) S.vibe = c.b;
    if (c.t) document.addEventListener('DOMContentLoaded', () => { $('inputText').value = c.t; updateCharCount(); });
  } catch(e) {}
})();

// Pre-load speech synthesis voices
if ('speechSynthesis' in window) {
  window.speechSynthesis.getVoices();
  window.speechSynthesis.addEventListener('voiceschanged', () => {});
}
</script>
</body>
</html>
