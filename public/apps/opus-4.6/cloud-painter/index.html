<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Cloud Painter - Paint the Sky!</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bubblegum+Sans&family=Nunito:wght@400;600;700;800&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --toolbar-bg: rgba(255, 255, 255, 0.88);
    --btn-hover: rgba(135, 206, 235, 0.3);
    --accent: #FF9FB2;
    --accent2: #A2D2FF;
    --accent3: #FFC8A2;
    --shadow: 0 4px 20px rgba(0,0,0,0.08);
  }

  body {
    overflow: hidden;
    font-family: 'Nunito', sans-serif;
    cursor: none;
    user-select: none;
    -webkit-user-select: none;
    -webkit-tap-highlight-color: transparent;
    touch-action: none;
  }

  canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
  }

  #skyCanvas { z-index: 0; }
  #drawCanvas { z-index: 1; }
  #animCanvas { z-index: 2; pointer-events: none; }
  #uiCanvas { z-index: 3; }

  /* Toolbar */
  .toolbar {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 16px;
    background: var(--toolbar-bg);
    backdrop-filter: blur(16px) saturate(1.5);
    -webkit-backdrop-filter: blur(16px) saturate(1.5);
    border-radius: 22px;
    box-shadow: var(--shadow), 0 0 0 1px rgba(255,255,255,0.6) inset, 0 1px 0 rgba(255,255,255,0.9) inset;
    cursor: default;
    animation: toolbarSlideIn 0.8s cubic-bezier(0.34,1.56,0.64,1) 0.3s both;
  }

  @keyframes toolbarSlideIn {
    from { transform: translateX(-50%) translateY(80px); opacity: 0; }
    to { transform: translateX(-50%) translateY(0); opacity: 1; }
  }

  .toolbar-group {
    display: flex;
    align-items: center;
    gap: 3px;
  }

  .toolbar-divider {
    width: 1px;
    height: 30px;
    background: linear-gradient(180deg, transparent, rgba(0,0,0,0.1), transparent);
    margin: 0 5px;
  }

  .tool-btn {
    width: 42px;
    height: 42px;
    border-radius: 13px;
    border: 2.5px solid transparent;
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 0.2s cubic-bezier(0.34,1.56,0.64,1);
    position: relative;
    -webkit-tap-highlight-color: transparent;
  }

  .tool-btn:hover {
    background: var(--btn-hover);
    transform: scale(1.12);
  }

  .tool-btn:active {
    transform: scale(0.95);
  }

  .tool-btn.active {
    border-color: var(--accent);
    background: rgba(255, 159, 178, 0.18);
    box-shadow: 0 0 14px rgba(255, 159, 178, 0.35);
  }

  .tool-btn .tooltip {
    position: absolute;
    bottom: 50px;
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    background: rgba(40,40,40,0.92);
    color: white;
    padding: 5px 11px;
    border-radius: 9px;
    font-size: 11px;
    font-family: 'Nunito', sans-serif;
    font-weight: 600;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s cubic-bezier(0.34,1.56,0.64,1);
    backdrop-filter: blur(4px);
  }

  .tool-btn .tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: rgba(40,40,40,0.92);
  }

  .tool-btn:hover .tooltip {
    opacity: 1;
    transform: translateX(-50%) scale(1);
  }

  /* Size slider */
  .size-slider-container {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 0 2px;
  }

  .size-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 75px;
    height: 5px;
    border-radius: 3px;
    background: linear-gradient(to right, var(--accent2), var(--accent));
    outline: none;
    cursor: pointer;
  }

  .size-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: white;
    border: 2.5px solid var(--accent);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: transform 0.15s cubic-bezier(0.34,1.56,0.64,1);
  }

  .size-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
  }

  .size-slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: white;
    border: 2.5px solid var(--accent);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    cursor: pointer;
  }

  .size-label {
    font-size: 10px;
    color: #888;
    min-width: 18px;
    text-align: center;
    font-weight: 700;
  }

  /* Title */
  .app-title {
    position: fixed;
    top: 14px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    font-family: 'Bubblegum Sans', cursive;
    font-size: 30px;
    color: white;
    text-shadow: 0 2px 10px rgba(0,0,0,0.12), 0 0 40px rgba(255,255,255,0.25);
    pointer-events: none;
    opacity: 0;
    letter-spacing: 1.5px;
    animation: titleFadeIn 1s ease 1s forwards;
  }

  @keyframes titleFadeIn {
    to { opacity: 0.85; }
  }

  .app-title span {
    display: inline-block;
    animation: titleWave 4s ease-in-out infinite;
  }

  @keyframes titleWave {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-3px) rotate(-1deg); }
    75% { transform: translateY(2px) rotate(1deg); }
  }

  /* Color palette */
  .color-btn {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: 2.5px solid rgba(255,255,255,0.9);
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.34,1.56,0.64,1);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  .color-btn:hover {
    transform: scale(1.2);
  }

  .color-btn.active {
    border-color: #555;
    box-shadow: 0 0 0 2px white, 0 0 0 4px #555;
    transform: scale(1.1);
  }

  /* Notification */
  .notification {
    position: fixed;
    top: 65px;
    left: 50%;
    transform: translateX(-50%) translateY(-15px);
    z-index: 100;
    background: rgba(255,255,255,0.93);
    backdrop-filter: blur(12px);
    padding: 10px 22px;
    border-radius: 14px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08), 0 0 0 1px rgba(255,255,255,0.5) inset;
    font-family: 'Bubblegum Sans', cursive;
    font-size: 17px;
    color: #666;
    opacity: 0;
    transition: all 0.35s cubic-bezier(0.34,1.56,0.64,1);
    pointer-events: none;
  }

  .notification.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* Welcome overlay */
  .welcome-overlay {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    transition: opacity 1s ease;
    overflow: hidden;
  }

  .welcome-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .welcome-bg {
    position: absolute;
    inset: 0;
    z-index: 0;
  }

  .welcome-card {
    text-align: center;
    z-index: 2;
    animation: welcomeFloat 3s ease-in-out infinite alternate;
  }

  @keyframes welcomeFloat {
    from { transform: translateY(0); }
    to { transform: translateY(-12px); }
  }

  .welcome-card h1 {
    font-family: 'Bubblegum Sans', cursive;
    font-size: clamp(40px, 8vw, 64px);
    color: white;
    text-shadow: 0 3px 15px rgba(0,0,0,0.1), 0 0 60px rgba(255,255,255,0.2);
    margin-bottom: 8px;
    line-height: 1.1;
  }

  .welcome-card .cloud-icon {
    font-size: clamp(50px, 10vw, 80px);
    display: block;
    margin-bottom: 12px;
    filter: drop-shadow(0 4px 10px rgba(0,0,0,0.05));
    animation: cloudBob 2s ease-in-out infinite alternate;
  }

  @keyframes cloudBob {
    from { transform: scale(1) translateY(0); }
    to { transform: scale(1.05) translateY(-5px); }
  }

  .welcome-card p {
    font-family: 'Nunito', sans-serif;
    font-size: clamp(16px, 3vw, 21px);
    color: rgba(255,255,255,0.85);
    margin-bottom: 28px;
    font-weight: 600;
  }

  .welcome-btn {
    font-family: 'Bubblegum Sans', cursive;
    font-size: clamp(20px, 3.5vw, 26px);
    padding: 14px 52px;
    border: none;
    border-radius: 30px;
    background: linear-gradient(135deg, #FF9FB2 0%, #FFB7A5 50%, #FFC8A2 100%);
    color: white;
    cursor: pointer;
    box-shadow: 0 6px 25px rgba(255,159,178,0.4), 0 0 0 0 rgba(255,159,178,0);
    transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
    letter-spacing: 1px;
    text-shadow: 0 1px 3px rgba(0,0,0,0.1);
    animation: btnPulse 2s ease-in-out infinite;
  }

  @keyframes btnPulse {
    0%, 100% { box-shadow: 0 6px 25px rgba(255,159,178,0.4), 0 0 0 0 rgba(255,159,178,0.3); }
    50% { box-shadow: 0 6px 25px rgba(255,159,178,0.4), 0 0 0 8px rgba(255,159,178,0); }
  }

  .welcome-btn:hover {
    transform: scale(1.08);
    box-shadow: 0 8px 30px rgba(255,159,178,0.5);
  }

  .welcome-btn:active {
    transform: scale(0.98);
  }

  .welcome-hints {
    margin-top: 24px;
    color: rgba(255,255,255,0.6);
    font-size: 13px;
    font-weight: 600;
    z-index: 2;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .toolbar {
      bottom: 12px;
      padding: 6px 10px;
      gap: 3px;
      border-radius: 18px;
    }
    .tool-btn {
      width: 36px;
      height: 36px;
      font-size: 17px;
      border-radius: 10px;
    }
    .color-btn {
      width: 22px;
      height: 22px;
    }
    .size-slider { width: 55px; }
    .toolbar-divider { margin: 0 3px; height: 24px; }
    .app-title { font-size: 22px; top: 10px; }
  }

  @media (max-width: 480px) {
    .toolbar {
      flex-wrap: wrap;
      max-width: 95vw;
      justify-content: center;
      border-radius: 16px;
      gap: 2px;
      padding: 6px 8px;
    }
    .toolbar-divider { display: none; }
  }
</style>
</head>
<body>

<!-- Welcome Screen -->
<div class="welcome-overlay" id="welcomeOverlay">
  <canvas class="welcome-bg" id="welcomeCanvas"></canvas>
  <div class="welcome-card">
    <span class="cloud-icon">&#9729;</span>
    <h1>Cloud Painter</h1>
    <p>Draw fluffy clouds across the sky!</p>
    <button class="welcome-btn" id="startBtn">Let's Paint!</button>
  </div>
  <div class="welcome-hints">Tip: Use number keys 1-5 for brushes, [ ] for size</div>
</div>

<!-- Title -->
<div class="app-title" id="appTitle">
  <span style="animation-delay:0s">C</span><span style="animation-delay:0.12s">l</span><span style="animation-delay:0.24s">o</span><span style="animation-delay:0.36s">u</span><span style="animation-delay:0.48s">d</span><span style="animation-delay:0.6s">&nbsp;</span><span style="animation-delay:0.72s">P</span><span style="animation-delay:0.84s">a</span><span style="animation-delay:0.96s">i</span><span style="animation-delay:1.08s">n</span><span style="animation-delay:1.20s">t</span><span style="animation-delay:1.32s">e</span><span style="animation-delay:1.44s">r</span>
</div>

<!-- Canvases -->
<canvas id="skyCanvas"></canvas>
<canvas id="drawCanvas"></canvas>
<canvas id="animCanvas"></canvas>
<canvas id="uiCanvas"></canvas>

<!-- Notification -->
<div class="notification" id="notification"></div>

<!-- Toolbar -->
<div class="toolbar" id="toolbar">
  <div class="toolbar-group">
    <button class="tool-btn active" data-brush="fluffy">
      <span>&#9729;</span>
      <span class="tooltip">Fluffy Cloud</span>
    </button>
    <button class="tool-btn" data-brush="wispy">
      <span>&#127748;</span>
      <span class="tooltip">Wispy Cloud</span>
    </button>
    <button class="tool-btn" data-brush="puffy">
      <span>&#128168;</span>
      <span class="tooltip">Cotton Puff</span>
    </button>
    <button class="tool-btn" data-brush="storm">
      <span>&#9928;</span>
      <span class="tooltip">Storm Cloud</span>
    </button>
    <button class="tool-btn" data-brush="rainbow">
      <span>&#127752;</span>
      <span class="tooltip">Rainbow Cloud</span>
    </button>
  </div>

  <div class="toolbar-divider"></div>

  <div class="toolbar-group">
    <button class="color-btn active" data-color="white" style="background: radial-gradient(circle at 30% 30%, #fff, #eee);" title="White"></button>
    <button class="color-btn" data-color="soft-pink" style="background: radial-gradient(circle at 30% 30%, #FFE8EC, #FFD6E0);" title="Pink"></button>
    <button class="color-btn" data-color="soft-blue" style="background: radial-gradient(circle at 30% 30%, #D8F0FF, #C5E8FF);" title="Blue"></button>
    <button class="color-btn" data-color="sunset" style="background: radial-gradient(circle at 30% 30%, #FFECC8, #FFE0B2);" title="Sunset"></button>
    <button class="color-btn" data-color="lavender" style="background: radial-gradient(circle at 30% 30%, #F0E5F8, #E0CDF0);" title="Lavender"></button>
    <button class="color-btn" data-color="gray" style="background: radial-gradient(circle at 30% 30%, #C8D4DA, #A0B0B8);" title="Gray"></button>
  </div>

  <div class="toolbar-divider"></div>

  <div class="size-slider-container">
    <span class="size-label" id="sizeLabel">40</span>
    <input type="range" class="size-slider" id="sizeSlider" min="10" max="120" value="40">
  </div>

  <div class="toolbar-divider"></div>

  <div class="toolbar-group">
    <button class="tool-btn" id="eraserBtn">
      <span>&#128716;</span>
      <span class="tooltip">Eraser</span>
    </button>
    <button class="tool-btn" id="undoBtn">
      <span>&#8617;</span>
      <span class="tooltip">Undo (Ctrl+Z)</span>
    </button>
    <button class="tool-btn" id="clearBtn">
      <span>&#10060;</span>
      <span class="tooltip">Clear Sky</span>
    </button>
    <button class="tool-btn" id="planeBtn">
      <span>&#9992;</span>
      <span class="tooltip">Add Airplane</span>
    </button>
    <button class="tool-btn" id="birdBtn">
      <span>&#128038;</span>
      <span class="tooltip">Add Birds</span>
    </button>
    <button class="tool-btn" id="saveBtn">
      <span>&#128190;</span>
      <span class="tooltip">Save Picture</span>
    </button>
  </div>
</div>

<script>
// ==================== CANVAS SETUP ====================
const skyCanvas = document.getElementById('skyCanvas');
const drawCanvas = document.getElementById('drawCanvas');
const animCanvas = document.getElementById('animCanvas');
const uiCanvas = document.getElementById('uiCanvas');
const welcomeCanvas = document.getElementById('welcomeCanvas');

const skyCtx = skyCanvas.getContext('2d');
const drawCtx = drawCanvas.getContext('2d');
const animCtx = animCanvas.getContext('2d');
const uiCtx = uiCanvas.getContext('2d');
const welcomeCtx = welcomeCanvas.getContext('2d');

let W, H, dpr;

function resizeCanvases() {
  dpr = Math.min(window.devicePixelRatio || 1, 2);
  W = window.innerWidth;
  H = window.innerHeight;
  [skyCanvas, drawCanvas, animCanvas, uiCanvas, welcomeCanvas].forEach(c => {
    c.width = W * dpr;
    c.height = H * dpr;
    c.style.width = W + 'px';
    c.style.height = H + 'px';
    c.getContext('2d').setTransform(dpr, 0, 0, dpr, 0, 0);
  });
  drawSky();
}

window.addEventListener('resize', () => {
  // Save current drawing
  const imgData = drawCtx.getImageData(0, 0, drawCanvas.width, drawCanvas.height);
  resizeCanvases();
  // Attempt to restore (may not be pixel-perfect on resize but prevents losing work)
  try { drawCtx.putImageData(imgData, 0, 0); } catch(e) {}
});

// ==================== STATE ====================
let currentBrush = 'fluffy';
let currentColor = { r: 255, g: 255, b: 255 };
let brushSize = 40;
let isErasing = false;
let isDrawing = false;
let lastX = 0, lastY = 0;
let mouseX = -100, mouseY = -100;
let mouseOnCanvas = false;
let appStarted = false;

const colorMap = {
  'white':     { r: 255, g: 255, b: 255 },
  'soft-pink': { r: 255, g: 214, b: 224 },
  'soft-blue': { r: 197, g: 232, b: 255 },
  'sunset':    { r: 255, g: 224, b: 178 },
  'lavender':  { r: 232, g: 213, b: 245 },
  'gray':      { r: 170, g: 185, b: 195 },
};

// History for undo
let drawHistory = [];
const maxHistory = 25;

// Animated objects
let airplanes = [];
let birds = [];
let ambientClouds = [];
let particles = [];

// Seeded random for consistent background elements
function mulberry32(a) {
  return function() {
    a |= 0; a = a + 0x6D2B79F5 | 0;
    let t = Math.imul(a ^ a >>> 15, 1 | a);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}

// ==================== SKY ====================
function drawSky() {
  const grad = skyCtx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, '#4A9BD9');
  grad.addColorStop(0.15, '#6BB5E8');
  grad.addColorStop(0.35, '#87CEEB');
  grad.addColorStop(0.55, '#A8DEFF');
  grad.addColorStop(0.75, '#CCE9FF');
  grad.addColorStop(0.9, '#E8F4FF');
  grad.addColorStop(1, '#FFF5E6');
  skyCtx.fillStyle = grad;
  skyCtx.fillRect(0, 0, W, H);

  drawSun();
  drawHills();
}

function drawSun() {
  const sunX = W * 0.85;
  const sunY = H * 0.12;

  // Outer glow
  for (let i = 3; i >= 0; i--) {
    const r = 45 + i * 30;
    const grad = skyCtx.createRadialGradient(sunX, sunY, 0, sunX, sunY, r);
    const a = 0.06 - i * 0.012;
    grad.addColorStop(0, `rgba(255, 240, 150, ${a + 0.1})`);
    grad.addColorStop(1, `rgba(255, 220, 100, 0)`);
    skyCtx.fillStyle = grad;
    skyCtx.beginPath();
    skyCtx.arc(sunX, sunY, r, 0, Math.PI * 2);
    skyCtx.fill();
  }

  // Sun body
  const bodyGrad = skyCtx.createRadialGradient(sunX - 5, sunY - 5, 0, sunX, sunY, 30);
  bodyGrad.addColorStop(0, '#FFFDE0');
  bodyGrad.addColorStop(0.6, '#FFF4B0');
  bodyGrad.addColorStop(1, '#FFE680');
  skyCtx.beginPath();
  skyCtx.arc(sunX, sunY, 30, 0, Math.PI * 2);
  skyCtx.fillStyle = bodyGrad;
  skyCtx.fill();

  // Sun rays
  skyCtx.save();
  skyCtx.globalAlpha = 0.12;
  for (let i = 0; i < 16; i++) {
    const angle = (i / 16) * Math.PI * 2;
    const inner = 34;
    const outer = 55 + (i % 2) * 20;
    skyCtx.beginPath();
    skyCtx.moveTo(sunX + Math.cos(angle) * inner, sunY + Math.sin(angle) * inner);
    skyCtx.lineTo(sunX + Math.cos(angle) * outer, sunY + Math.sin(angle) * outer);
    skyCtx.strokeStyle = '#FFE082';
    skyCtx.lineWidth = 2 + (i % 2);
    skyCtx.lineCap = 'round';
    skyCtx.stroke();
  }
  skyCtx.restore();
}

function drawHills() {
  const rand = mulberry32(42);

  // Distant mountains
  skyCtx.save();
  skyCtx.globalAlpha = 0.3;
  skyCtx.beginPath();
  skyCtx.moveTo(-20, H);
  for (let x = -20; x <= W + 20; x += 3) {
    const y = H - 100 + Math.sin(x * 0.002) * 50 + Math.sin(x * 0.005 + 1) * 25 + Math.cos(x * 0.001) * 20;
    skyCtx.lineTo(x, y);
  }
  skyCtx.lineTo(W + 20, H);
  skyCtx.closePath();
  skyCtx.fillStyle = '#8EBAA8';
  skyCtx.fill();
  skyCtx.restore();

  // Far hill
  skyCtx.beginPath();
  skyCtx.moveTo(-20, H);
  for (let x = -20; x <= W + 20; x += 3) {
    const y = H - 55 + Math.sin(x * 0.004) * 28 + Math.sin(x * 0.009 + 1) * 14;
    skyCtx.lineTo(x, y);
  }
  skyCtx.lineTo(W + 20, H);
  skyCtx.closePath();
  const hg1 = skyCtx.createLinearGradient(0, H - 85, 0, H);
  hg1.addColorStop(0, '#8FCC8A');
  hg1.addColorStop(1, '#6BBF65');
  skyCtx.fillStyle = hg1;
  skyCtx.fill();

  // Near hill
  skyCtx.beginPath();
  skyCtx.moveTo(-20, H);
  for (let x = -20; x <= W + 20; x += 3) {
    const y = H - 28 + Math.sin(x * 0.006 + 2) * 18 + Math.sin(x * 0.014 + 3) * 8;
    skyCtx.lineTo(x, y);
  }
  skyCtx.lineTo(W + 20, H);
  skyCtx.closePath();
  const hg2 = skyCtx.createLinearGradient(0, H - 46, 0, H);
  hg2.addColorStop(0, '#7EC87A');
  hg2.addColorStop(1, '#5DAF58');
  skyCtx.fillStyle = hg2;
  skyCtx.fill();

  // Trees on far hill
  for (let i = 0; i < 20; i++) {
    const tx = rand() * W;
    const ty = H - 55 + Math.sin(tx * 0.004) * 28 + Math.sin(tx * 0.009 + 1) * 14 - 2;
    const tSize = 8 + rand() * 10;
    skyCtx.save();
    skyCtx.globalAlpha = 0.5;
    // Trunk
    skyCtx.fillStyle = '#7B6B4F';
    skyCtx.fillRect(tx - 1.5, ty, 3, tSize * 0.5);
    // Canopy
    skyCtx.beginPath();
    skyCtx.arc(tx, ty - tSize * 0.15, tSize * 0.45, 0, Math.PI * 2);
    skyCtx.fillStyle = '#5AA355';
    skyCtx.fill();
    skyCtx.restore();
  }

  // Flowers
  const flowerColors = ['#FF9FB2', '#FFE082', '#E8D5F5', '#FFFFFF', '#FFC8A2', '#A2D2FF'];
  for (let i = 0; i < 45; i++) {
    const fx = rand() * W;
    const fy = H - 8 + Math.sin(fx * 0.006 + 2) * 18 + Math.sin(fx * 0.014 + 3) * 8 - rand() * 16 - 2;
    const fc = flowerColors[Math.floor(rand() * flowerColors.length)];
    const fs = 1.5 + rand() * 2.5;

    // Stem
    skyCtx.beginPath();
    skyCtx.moveTo(fx, fy);
    skyCtx.lineTo(fx, fy + fs * 2);
    skyCtx.strokeStyle = '#6AAA5F';
    skyCtx.lineWidth = 1;
    skyCtx.stroke();

    // Flower head
    skyCtx.beginPath();
    skyCtx.arc(fx, fy, fs, 0, Math.PI * 2);
    skyCtx.fillStyle = fc;
    skyCtx.fill();

    // Center
    if (fs > 2) {
      skyCtx.beginPath();
      skyCtx.arc(fx, fy, fs * 0.35, 0, Math.PI * 2);
      skyCtx.fillStyle = '#FFE082';
      skyCtx.fill();
    }
  }
}

// ==================== CLOUD BRUSH DRAWING ====================
function saveState() {
  const imgData = drawCtx.getImageData(0, 0, drawCanvas.width, drawCanvas.height);
  drawHistory.push(imgData);
  if (drawHistory.length > maxHistory) drawHistory.shift();
}

function undo() {
  if (drawHistory.length > 1) {
    drawHistory.pop();
    const prev = drawHistory[drawHistory.length - 1];
    drawCtx.putImageData(prev, 0, 0);
    showNotification('Undone!');
  } else if (drawHistory.length === 1) {
    drawHistory.pop();
    drawCtx.clearRect(0, 0, W * dpr, H * dpr);
    drawCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
    showNotification('All clear!');
  }
}

function clearDrawing() {
  saveState();
  drawCtx.clearRect(0, 0, W * dpr, H * dpr);
  drawCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
  showNotification('Sky cleared!');
}

function drawCloudBlob(ctx, x, y, size, color, alpha) {
  ctx.save();
  ctx.globalAlpha = alpha;

  switch (currentBrush) {
    case 'fluffy':  drawFluffyCloud(ctx, x, y, size, color); break;
    case 'wispy':   drawWispyCloud(ctx, x, y, size, color); break;
    case 'puffy':   drawPuffyCloud(ctx, x, y, size, color); break;
    case 'storm':   drawStormCloud(ctx, x, y, size, color); break;
    case 'rainbow': drawRainbowCloud(ctx, x, y, size, color); break;
  }

  ctx.restore();
}

function drawFluffyCloud(ctx, x, y, size, color) {
  const n = 6 + Math.floor(size / 12);
  for (let i = 0; i < n; i++) {
    const ang = Math.random() * Math.PI * 2;
    const dist = Math.random() * size * 0.45;
    const bx = x + Math.cos(ang) * dist;
    const by = y + Math.sin(ang) * dist * 0.55;
    const bs = size * (0.35 + Math.random() * 0.35);

    const g = ctx.createRadialGradient(bx - bs * 0.15, by - bs * 0.15, 0, bx, by, bs);
    g.addColorStop(0, `rgba(${Math.min(255,color.r+15)}, ${Math.min(255,color.g+15)}, ${Math.min(255,color.b+15)}, 0.85)`);
    g.addColorStop(0.4, `rgba(${color.r}, ${color.g}, ${color.b}, 0.5)`);
    g.addColorStop(0.7, `rgba(${color.r}, ${color.g}, ${color.b}, 0.2)`);
    g.addColorStop(1, `rgba(${color.r}, ${color.g}, ${color.b}, 0)`);

    ctx.beginPath();
    ctx.arc(bx, by, bs, 0, Math.PI * 2);
    ctx.fillStyle = g;
    ctx.fill();
  }
}

function drawWispyCloud(ctx, x, y, size, color) {
  const n = 4 + Math.floor(size / 18);
  for (let i = 0; i < n; i++) {
    const sx = x + (Math.random() - 0.5) * size * 0.8;
    const sy = y + (Math.random() - 0.5) * size * 0.25;
    const len = size * (0.5 + Math.random() * 0.7);
    const curveAmt = (Math.random() - 0.5) * size * 0.35;

    ctx.beginPath();
    ctx.moveTo(sx, sy);
    ctx.quadraticCurveTo(sx + len * 0.5, sy + curveAmt, sx + len, sy + (Math.random()-0.5) * size * 0.15);
    ctx.lineWidth = size * (0.06 + Math.random() * 0.1);
    ctx.strokeStyle = `rgba(${color.r}, ${color.g}, ${color.b}, 0.35)`;
    ctx.lineCap = 'round';
    ctx.stroke();
  }

  // Soft glow center
  const g = ctx.createRadialGradient(x, y, 0, x, y, size * 0.6);
  g.addColorStop(0, `rgba(${color.r}, ${color.g}, ${color.b}, 0.3)`);
  g.addColorStop(1, `rgba(${color.r}, ${color.g}, ${color.b}, 0)`);
  ctx.beginPath();
  ctx.arc(x, y, size * 0.6, 0, Math.PI * 2);
  ctx.fillStyle = g;
  ctx.fill();
}

function drawPuffyCloud(ctx, x, y, size, color) {
  // Layered puff ball
  for (let r = 3; r >= 0; r--) {
    const rs = size * (0.4 + r * 0.18);
    const a = 0.12 + (3 - r) * 0.12;
    const g = ctx.createRadialGradient(x, y - size * 0.08, rs * 0.1, x, y, rs);
    g.addColorStop(0, `rgba(${Math.min(255,color.r+25)}, ${Math.min(255,color.g+25)}, ${Math.min(255,color.b+25)}, ${a})`);
    g.addColorStop(0.6, `rgba(${color.r}, ${color.g}, ${color.b}, ${a * 0.4})`);
    g.addColorStop(1, `rgba(${color.r}, ${color.g}, ${color.b}, 0)`);
    ctx.beginPath();
    ctx.arc(x, y, rs, 0, Math.PI * 2);
    ctx.fillStyle = g;
    ctx.fill();
  }

  // Highlight sparkle
  for (let i = 0; i < 3; i++) {
    const px = x + (Math.random()-0.5) * size * 0.4;
    const py = y + (Math.random()-0.5) * size * 0.3 - size * 0.08;
    const ps = size * 0.1 + Math.random() * size * 0.08;
    const g = ctx.createRadialGradient(px, py, 0, px, py, ps);
    g.addColorStop(0, 'rgba(255,255,255,0.6)');
    g.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.beginPath();
    ctx.arc(px, py, ps, 0, Math.PI * 2);
    ctx.fillStyle = g;
    ctx.fill();
  }
}

function drawStormCloud(ctx, x, y, size, color) {
  const n = 8 + Math.floor(size / 10);
  for (let i = 0; i < n; i++) {
    const ang = Math.random() * Math.PI * 2;
    const dist = Math.random() * size * 0.55;
    const bx = x + Math.cos(ang) * dist;
    const by = y + Math.sin(ang) * dist * 0.45;
    const bs = size * (0.22 + Math.random() * 0.3);

    const dr = Math.max(0, color.r - 90 + Math.random() * 40);
    const dg = Math.max(0, color.g - 90 + Math.random() * 40);
    const db = Math.max(0, color.b - 70 + Math.random() * 40);

    const g = ctx.createRadialGradient(bx, by - bs * 0.15, 0, bx, by, bs);
    g.addColorStop(0, `rgba(${dr+50}, ${dg+50}, ${db+60}, 0.7)`);
    g.addColorStop(0.5, `rgba(${dr+20}, ${dg+20}, ${db+30}, 0.4)`);
    g.addColorStop(1, `rgba(${dr}, ${dg}, ${db}, 0)`);

    ctx.beginPath();
    ctx.arc(bx, by, bs, 0, Math.PI * 2);
    ctx.fillStyle = g;
    ctx.fill();
  }

  if (Math.random() < 0.12) {
    addParticle(x + (Math.random()-0.5)*size*0.4, y + size*0.35, 'lightning');
  }
}

function drawRainbowCloud(ctx, x, y, size, color) {
  const rc = [
    {r:255,g:180,b:180}, {r:255,g:210,b:150}, {r:255,g:255,b:180},
    {r:180,g:255,b:180}, {r:180,g:220,b:255}, {r:220,g:180,b:255}
  ];

  const n = 7 + Math.floor(size / 10);
  for (let i = 0; i < n; i++) {
    const c = rc[Math.floor(Math.random() * rc.length)];
    const ang = Math.random() * Math.PI * 2;
    const dist = Math.random() * size * 0.45;
    const bx = x + Math.cos(ang) * dist;
    const by = y + Math.sin(ang) * dist * 0.55;
    const bs = size * (0.25 + Math.random() * 0.3);

    const g = ctx.createRadialGradient(bx, by, 0, bx, by, bs);
    g.addColorStop(0, `rgba(${c.r}, ${c.g}, ${c.b}, 0.65)`);
    g.addColorStop(0.5, `rgba(${c.r}, ${c.g}, ${c.b}, 0.3)`);
    g.addColorStop(1, `rgba(${c.r}, ${c.g}, ${c.b}, 0)`);

    ctx.beginPath();
    ctx.arc(bx, by, bs, 0, Math.PI * 2);
    ctx.fillStyle = g;
    ctx.fill();
  }

  if (Math.random() < 0.25) {
    addParticle(x + (Math.random()-0.5)*size, y + (Math.random()-0.5)*size*0.5, 'sparkle');
  }
}

function eraseAt(x, y, size) {
  drawCtx.save();
  drawCtx.globalCompositeOperation = 'destination-out';
  const g = drawCtx.createRadialGradient(x, y, 0, x, y, size);
  g.addColorStop(0, 'rgba(0,0,0,1)');
  g.addColorStop(0.6, 'rgba(0,0,0,0.6)');
  g.addColorStop(1, 'rgba(0,0,0,0)');
  drawCtx.fillStyle = g;
  drawCtx.beginPath();
  drawCtx.arc(x, y, size, 0, Math.PI * 2);
  drawCtx.fill();
  drawCtx.restore();
}

function drawLine(x1, y1, x2, y2) {
  const dist = Math.hypot(x2 - x1, y2 - y1);
  const steps = Math.max(1, Math.floor(dist / (brushSize * 0.25)));

  for (let i = 0; i <= steps; i++) {
    const t = i / steps;
    const x = x1 + (x2 - x1) * t;
    const y = y1 + (y2 - y1) * t;

    if (isErasing) {
      eraseAt(x, y, brushSize);
    } else {
      drawCloudBlob(drawCtx, x, y, brushSize, currentColor, 0.12 + Math.random() * 0.06);
    }
  }
}

// ==================== AIRPLANES ====================
function addAirplane() {
  const fromLeft = Math.random() > 0.5;
  const y = 40 + Math.random() * (H * 0.45);
  const speed = 0.7 + Math.random() * 1.0;
  const size = 0.55 + Math.random() * 0.55;
  const colors = ['#E8E8E8', '#FFD6E0', '#C5E8FF', '#FFE0B2', '#E8D5F5'];

  airplanes.push({
    x: fromLeft ? -100 : W + 100,
    y, speed: fromLeft ? speed : -speed,
    size, wobble: Math.random() * Math.PI * 2,
    wobbleSpeed: 0.015 + Math.random() * 0.015,
    trailPoints: [],
    bodyColor: colors[Math.floor(Math.random() * colors.length)],
    tilt: (Math.random() - 0.5) * 0.1,
    bannerText: Math.random() < 0.3 ? ['HELLO!', 'FUN!', 'WHEEE!', 'YAY!'][Math.floor(Math.random()*4)] : null
  });
  showNotification('Airplane incoming!');
}

function drawAirplane(ctx, plane) {
  const { x, y, size, speed, bodyColor, tilt, bannerText } = plane;
  const dir = speed > 0 ? 1 : -1;

  // Contrail
  if (plane.trailPoints.length > 2) {
    ctx.save();
    for (let t = 0; t < 2; t++) {
      const offsetY = t === 0 ? -4 * size : 4 * size;
      ctx.beginPath();
      for (let i = 0; i < plane.trailPoints.length; i++) {
        const p = plane.trailPoints[i];
        const age = i / plane.trailPoints.length;
        if (i === 0) ctx.moveTo(p.x, p.y + offsetY);
        else ctx.lineTo(p.x, p.y + offsetY);
      }
      ctx.strokeStyle = 'rgba(255,255,255,0.35)';
      ctx.lineWidth = 3 * size;
      ctx.lineCap = 'round';
      ctx.stroke();

      // Wider, fainter trail
      ctx.strokeStyle = 'rgba(255,255,255,0.1)';
      ctx.lineWidth = 8 * size;
      ctx.stroke();
    }
    ctx.restore();
  }

  // Banner
  if (bannerText && plane.trailPoints.length > 20) {
    ctx.save();
    const bp = plane.trailPoints[Math.max(0, plane.trailPoints.length - 30)];
    ctx.globalAlpha = 0.8;
    ctx.fillStyle = '#FF9FB2';
    const bw = bannerText.length * 12 * size + 16 * size;
    const bh = 20 * size;
    const bx = bp.x - bw/2;
    const by = bp.y + 12 * size;
    roundRect(ctx, bx, by, bw, bh, 4*size);
    ctx.fill();
    ctx.fillStyle = 'white';
    ctx.font = `bold ${14*size}px 'Bubblegum Sans', cursive`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(bannerText, bp.x, by + bh/2);
    ctx.restore();
  }

  ctx.save();
  ctx.translate(x, y);
  ctx.rotate(tilt * dir);
  ctx.scale(dir * size, size);

  // Shadow
  ctx.save();
  ctx.globalAlpha = 0.1;
  ctx.fillStyle = '#333';
  ctx.beginPath();
  ctx.ellipse(2, 5, 26, 5, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  // Body
  ctx.fillStyle = bodyColor;
  ctx.beginPath();
  ctx.ellipse(0, 0, 26, 5.5, 0, 0, Math.PI * 2);
  ctx.fill();

  // Body highlight
  ctx.save();
  ctx.globalAlpha = 0.5;
  ctx.fillStyle = 'white';
  ctx.beginPath();
  ctx.ellipse(2, -2.5, 20, 2.5, 0, 0, Math.PI, true);
  ctx.fill();
  ctx.restore();

  // Nose
  ctx.fillStyle = bodyColor;
  ctx.beginPath();
  ctx.moveTo(24, 0);
  ctx.quadraticCurveTo(30, -1, 29, 0);
  ctx.quadraticCurveTo(30, 1, 24, 0);
  ctx.fill();

  // Cockpit
  const cockpitGrad = ctx.createLinearGradient(20, -4, 20, 2);
  cockpitGrad.addColorStop(0, '#B8E0FF');
  cockpitGrad.addColorStop(1, '#87CEEB');
  ctx.fillStyle = cockpitGrad;
  ctx.beginPath();
  ctx.ellipse(20, -0.5, 5, 3.5, 0, 0, Math.PI * 2);
  ctx.fill();

  // Window glare
  ctx.save();
  ctx.globalAlpha = 0.4;
  ctx.fillStyle = 'white';
  ctx.beginPath();
  ctx.ellipse(21, -1.5, 2, 1.5, -0.3, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  // Wings
  ctx.fillStyle = bodyColor;
  // Top wing
  ctx.beginPath();
  ctx.moveTo(0, -2);
  ctx.lineTo(-8, -18);
  ctx.quadraticCurveTo(-4, -19, 4, -17);
  ctx.lineTo(6, -2);
  ctx.closePath();
  ctx.fill();
  // Bottom wing
  ctx.beginPath();
  ctx.moveTo(0, 2);
  ctx.lineTo(-8, 18);
  ctx.quadraticCurveTo(-4, 19, 4, 17);
  ctx.lineTo(6, 2);
  ctx.closePath();
  ctx.fill();

  // Wing stripe
  ctx.save();
  ctx.globalAlpha = 0.25;
  ctx.strokeStyle = '#FF9FB2';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(-2, -12); ctx.lineTo(4, -11);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(-2, 12); ctx.lineTo(4, 11);
  ctx.stroke();
  ctx.restore();

  // Tail fin
  ctx.fillStyle = bodyColor;
  ctx.beginPath();
  ctx.moveTo(-22, 0);
  ctx.lineTo(-30, -11);
  ctx.quadraticCurveTo(-26, -12, -20, -10);
  ctx.lineTo(-18, 0);
  ctx.closePath();
  ctx.fill();

  // Tail horizontal
  ctx.beginPath();
  ctx.moveTo(-20, 0);
  ctx.lineTo(-26, 6);
  ctx.lineTo(-26, -6);
  ctx.closePath();
  ctx.fill();

  // Tail stripe
  ctx.save();
  ctx.globalAlpha = 0.3;
  ctx.fillStyle = '#FF9FB2';
  ctx.beginPath();
  ctx.moveTo(-26, -11); ctx.lineTo(-24, -10); ctx.lineTo(-28, -8); ctx.lineTo(-30, -9);
  ctx.closePath();
  ctx.fill();
  ctx.restore();

  // Engine glow
  ctx.save();
  ctx.globalAlpha = 0.15;
  const eg = ctx.createRadialGradient(-28, 0, 0, -28, 0, 8);
  eg.addColorStop(0, 'rgba(255,200,100,0.8)');
  eg.addColorStop(1, 'rgba(255,200,100,0)');
  ctx.fillStyle = eg;
  ctx.beginPath();
  ctx.arc(-28, 0, 8, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  ctx.restore();
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

function updateAirplanes(dt) {
  for (let i = airplanes.length - 1; i >= 0; i--) {
    const p = airplanes[i];
    p.x += p.speed * dt * 60;
    p.wobble += p.wobbleSpeed * dt * 60;
    p.y += Math.sin(p.wobble) * 0.25;

    p.trailPoints.push({ x: p.x - p.speed * 22, y: p.y });
    if (p.trailPoints.length > 100) p.trailPoints.shift();

    if ((p.speed > 0 && p.x > W + 250) || (p.speed < 0 && p.x < -250)) {
      airplanes.splice(i, 1);
    }
  }
}

// ==================== BIRDS ====================
function addBirdFlock() {
  const fromLeft = Math.random() > 0.5;
  const baseY = 30 + Math.random() * H * 0.4;
  const speed = 1.0 + Math.random() * 1.5;
  const count = 3 + Math.floor(Math.random() * 5);

  for (let i = 0; i < count; i++) {
    const offsetX = i * (15 + Math.random() * 20) * (Math.random() < 0.5 ? 1 : -1);
    const offsetY = i * (8 + Math.random() * 12) * (Math.random() < 0.5 ? 1 : -1);
    birds.push({
      x: fromLeft ? -50 - Math.abs(offsetX) : W + 50 + Math.abs(offsetX),
      y: baseY + offsetY,
      speed: fromLeft ? speed : -speed,
      wingPhase: Math.random() * Math.PI * 2,
      wingSpeed: 4 + Math.random() * 2,
      size: 0.8 + Math.random() * 0.4,
    });
  }
  showNotification('Birds are flying!');
}

function drawBird(ctx, bird, time) {
  const { x, y, size, wingPhase, wingSpeed } = bird;
  const wingAngle = Math.sin(time * wingSpeed + wingPhase) * 0.6;
  const dir = bird.speed > 0 ? 1 : -1;

  ctx.save();
  ctx.translate(x, y);
  ctx.scale(dir * size, size);

  // Body
  ctx.fillStyle = '#2C2C2C';
  ctx.beginPath();
  ctx.ellipse(0, 0, 6, 2.5, 0, 0, Math.PI * 2);
  ctx.fill();

  // Head
  ctx.beginPath();
  ctx.arc(5, -1, 2, 0, Math.PI * 2);
  ctx.fill();

  // Beak
  ctx.fillStyle = '#FFB347';
  ctx.beginPath();
  ctx.moveTo(7, -1);
  ctx.lineTo(10, -0.5);
  ctx.lineTo(7, 0);
  ctx.closePath();
  ctx.fill();

  // Wings
  ctx.fillStyle = '#3A3A3A';
  ctx.save();
  ctx.translate(0, -2);
  ctx.rotate(-wingAngle);
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.quadraticCurveTo(-3, -10, -8, -12);
  ctx.quadraticCurveTo(-4, -6, 0, 0);
  ctx.fill();
  ctx.restore();

  ctx.save();
  ctx.translate(0, 2);
  ctx.rotate(wingAngle);
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.quadraticCurveTo(-3, 10, -8, 12);
  ctx.quadraticCurveTo(-4, 6, 0, 0);
  ctx.fill();
  ctx.restore();

  // Tail
  ctx.fillStyle = '#2C2C2C';
  ctx.beginPath();
  ctx.moveTo(-6, 0);
  ctx.lineTo(-10, -2);
  ctx.lineTo(-10, 2);
  ctx.closePath();
  ctx.fill();

  ctx.restore();
}

function updateBirds(dt) {
  for (let i = birds.length - 1; i >= 0; i--) {
    const b = birds[i];
    b.x += b.speed * dt * 60;
    b.y += Math.sin(b.wingPhase + b.x * 0.01) * 0.15;
    if ((b.speed > 0 && b.x > W + 80) || (b.speed < 0 && b.x < -80)) {
      birds.splice(i, 1);
    }
  }
}

// ==================== AMBIENT CLOUDS ====================
function initAmbientClouds() {
  for (let i = 0; i < 6; i++) {
    ambientClouds.push(createAmbientCloud(Math.random() * W));
  }
}

function createAmbientCloud(startX) {
  const blobs = [];
  const n = 5 + Math.floor(Math.random() * 6);
  for (let i = 0; i < n; i++) {
    blobs.push({
      ox: (Math.random() - 0.5) * 1.3,
      oy: (Math.random() - 0.5) * 0.5,
      size: 0.3 + Math.random() * 0.5,
      phase: Math.random() * Math.PI * 2
    });
  }
  return {
    x: startX,
    y: 25 + Math.random() * H * 0.35,
    size: 50 + Math.random() * 110,
    speed: 0.08 + Math.random() * 0.12,
    alpha: 0.06 + Math.random() * 0.1,
    blobs
  };
}

function drawAmbientCloud(ctx, cloud, time) {
  ctx.save();
  ctx.globalAlpha = cloud.alpha;

  cloud.blobs.forEach(b => {
    const bx = cloud.x + b.ox * cloud.size + Math.sin(time * 0.4 + b.phase) * 3;
    const by = cloud.y + b.oy * cloud.size + Math.cos(time * 0.25 + b.phase) * 2;
    const bs = b.size * cloud.size;

    const g = ctx.createRadialGradient(bx, by - bs * 0.1, 0, bx, by, bs);
    g.addColorStop(0, 'rgba(255,255,255,0.9)');
    g.addColorStop(0.4, 'rgba(255,255,255,0.45)');
    g.addColorStop(1, 'rgba(255,255,255,0)');

    ctx.beginPath();
    ctx.arc(bx, by, bs, 0, Math.PI * 2);
    ctx.fillStyle = g;
    ctx.fill();
  });

  ctx.restore();
}

function updateAmbientClouds(dt) {
  ambientClouds.forEach(c => {
    c.x += c.speed * dt * 60;
    if (c.x > W + c.size * 2) {
      Object.assign(c, createAmbientCloud(-c.size * 2));
    }
  });
}

// ==================== PARTICLES ====================
function addParticle(x, y, type) {
  if (type === 'sparkle') {
    const colors = ['#FFD700','#FF69B4','#87CEEB','#98FB98','#DDA0DD','#FFB347'];
    particles.push({
      x, y, type,
      vx: (Math.random() - 0.5) * 2.5,
      vy: -Math.random() * 2.5 - 0.5,
      life: 1, decay: 0.012 + Math.random() * 0.008,
      size: 2.5 + Math.random() * 3,
      color: colors[Math.floor(Math.random() * colors.length)],
      rotation: Math.random() * Math.PI * 2
    });
  } else if (type === 'lightning') {
    const segs = [];
    let cx = x;
    const steps = 4 + Math.floor(Math.random() * 5);
    for (let i = 0; i <= steps; i++) {
      segs.push({ x: cx + (Math.random()-0.5)*14, y: y + (i/steps) * (25 + Math.random()*35) });
      cx += (Math.random()-0.5)*10;
    }
    particles.push({ x, y, type, life: 1, decay: 0.04, segments: segs });
  }
}

function updateParticles(dt) {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.life -= p.decay * dt * 60;
    if (p.type === 'sparkle') {
      p.x += p.vx * dt * 60;
      p.y += p.vy * dt * 60;
      p.vy += 0.04 * dt * 60;
      p.rotation += 0.05 * dt * 60;
    }
    if (p.life <= 0) particles.splice(i, 1);
  }
}

function drawParticles(ctx) {
  particles.forEach(p => {
    ctx.save();
    ctx.globalAlpha = Math.max(0, p.life);

    if (p.type === 'sparkle') {
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rotation);
      ctx.fillStyle = p.color;
      drawStar(ctx, 0, 0, p.size, p.size * 0.4, 4);
    } else if (p.type === 'lightning') {
      ctx.strokeStyle = `rgba(255,255,210,${p.life})`;
      ctx.lineWidth = 2;
      ctx.shadowColor = 'rgba(255,255,150,0.8)';
      ctx.shadowBlur = 12;
      ctx.beginPath();
      p.segments.forEach((s, idx) => {
        if (idx === 0) ctx.moveTo(s.x, s.y);
        else ctx.lineTo(s.x, s.y);
      });
      ctx.stroke();

      // Branch
      if (p.segments.length > 3) {
        const bi = Math.floor(p.segments.length * 0.6);
        const bs = p.segments[bi];
        ctx.beginPath();
        ctx.moveTo(bs.x, bs.y);
        ctx.lineTo(bs.x + 8, bs.y + 12);
        ctx.lineWidth = 1;
        ctx.stroke();
      }
    }

    ctx.restore();
  });
}

function drawStar(ctx, cx, cy, or, ir, pts) {
  ctx.beginPath();
  for (let i = 0; i < pts * 2; i++) {
    const r = i % 2 === 0 ? or : ir;
    const a = (i * Math.PI / pts) - Math.PI / 2;
    if (i === 0) ctx.moveTo(cx + r * Math.cos(a), cy + r * Math.sin(a));
    else ctx.lineTo(cx + r * Math.cos(a), cy + r * Math.sin(a));
  }
  ctx.closePath();
  ctx.fill();
}

// ==================== CURSOR ====================
function drawBrushCursor(ctx) {
  if (!mouseOnCanvas) return;

  ctx.save();

  // Outer ring
  ctx.setLineDash([5, 5]);
  ctx.strokeStyle = isErasing ? 'rgba(255,120,120,0.45)' : 'rgba(255,255,255,0.5)';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.arc(mouseX, mouseY, brushSize, 0, Math.PI * 2);
  ctx.stroke();

  if (!isErasing) {
    // Preview fill
    const g = ctx.createRadialGradient(mouseX, mouseY, 0, mouseX, mouseY, brushSize * 0.65);
    g.addColorStop(0, `rgba(${currentColor.r},${currentColor.g},${currentColor.b},0.2)`);
    g.addColorStop(1, `rgba(${currentColor.r},${currentColor.g},${currentColor.b},0)`);
    ctx.fillStyle = g;
    ctx.setLineDash([]);
    ctx.beginPath();
    ctx.arc(mouseX, mouseY, brushSize * 0.65, 0, Math.PI * 2);
    ctx.fill();

    // Center dot
    ctx.fillStyle = 'rgba(255,255,255,0.6)';
    ctx.beginPath();
    ctx.arc(mouseX, mouseY, 2, 0, Math.PI * 2);
    ctx.fill();
  } else {
    // X for eraser
    ctx.setLineDash([]);
    ctx.strokeStyle = 'rgba(255,120,120,0.5)';
    ctx.lineWidth = 2;
    const s = brushSize * 0.25;
    ctx.beginPath();
    ctx.moveTo(mouseX - s, mouseY - s); ctx.lineTo(mouseX + s, mouseY + s);
    ctx.moveTo(mouseX + s, mouseY - s); ctx.lineTo(mouseX - s, mouseY + s);
    ctx.stroke();
  }

  ctx.restore();
}

// ==================== INPUT ====================
function getPos(e) {
  if (e.touches && e.touches.length > 0) {
    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
  }
  return { x: e.clientX, y: e.clientY };
}

function isOverToolbar(x, y) {
  const el = document.getElementById('toolbar');
  const r = el.getBoundingClientRect();
  return x >= r.left - 8 && x <= r.right + 8 && y >= r.top - 8 && y <= r.bottom + 8;
}

// Mouse
uiCanvas.addEventListener('mousedown', e => {
  if (!appStarted) return;
  if (isOverToolbar(e.clientX, e.clientY)) return;
  const p = getPos(e);
  isDrawing = true;
  lastX = p.x; lastY = p.y;
  saveState();
  if (isErasing) eraseAt(p.x, p.y, brushSize);
  else drawCloudBlob(drawCtx, p.x, p.y, brushSize, currentColor, 0.18);
});

uiCanvas.addEventListener('mousemove', e => {
  const p = getPos(e);
  mouseX = p.x; mouseY = p.y;
  mouseOnCanvas = !isOverToolbar(p.x, p.y);
  if (isDrawing) {
    drawLine(lastX, lastY, p.x, p.y);
    lastX = p.x; lastY = p.y;
  }
});

uiCanvas.addEventListener('mouseup', () => { isDrawing = false; });
uiCanvas.addEventListener('mouseleave', () => { isDrawing = false; mouseOnCanvas = false; });

// Touch
uiCanvas.addEventListener('touchstart', e => {
  if (!appStarted) return;
  e.preventDefault();
  const p = getPos(e);
  if (isOverToolbar(p.x, p.y)) return;
  isDrawing = true;
  lastX = p.x; lastY = p.y;
  mouseX = p.x; mouseY = p.y;
  mouseOnCanvas = true;
  saveState();
  if (isErasing) eraseAt(p.x, p.y, brushSize);
  else drawCloudBlob(drawCtx, p.x, p.y, brushSize, currentColor, 0.18);
}, { passive: false });

uiCanvas.addEventListener('touchmove', e => {
  e.preventDefault();
  if (!isDrawing) return;
  const p = getPos(e);
  mouseX = p.x; mouseY = p.y;
  drawLine(lastX, lastY, p.x, p.y);
  lastX = p.x; lastY = p.y;
}, { passive: false });

uiCanvas.addEventListener('touchend', () => { isDrawing = false; });
uiCanvas.addEventListener('touchcancel', () => { isDrawing = false; });

// ==================== TOOLBAR ====================
document.querySelectorAll('[data-brush]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-brush]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentBrush = btn.dataset.brush;
    isErasing = false;
    document.getElementById('eraserBtn').classList.remove('active');
    showNotification(`${btn.querySelector('.tooltip').textContent} brush!`);
  });
});

document.querySelectorAll('[data-color]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-color]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentColor = colorMap[btn.dataset.color];
  });
});

const sizeSlider = document.getElementById('sizeSlider');
const sizeLabel = document.getElementById('sizeLabel');
sizeSlider.addEventListener('input', () => {
  brushSize = parseInt(sizeSlider.value);
  sizeLabel.textContent = brushSize;
});

document.getElementById('eraserBtn').addEventListener('click', () => {
  isErasing = !isErasing;
  document.getElementById('eraserBtn').classList.toggle('active', isErasing);
  if (isErasing) {
    document.querySelectorAll('[data-brush]').forEach(b => b.classList.remove('active'));
    showNotification('Eraser on!');
  } else {
    document.querySelector(`[data-brush="${currentBrush}"]`).classList.add('active');
    showNotification('Brush on!');
  }
});

document.getElementById('undoBtn').addEventListener('click', undo);
document.getElementById('clearBtn').addEventListener('click', clearDrawing);
document.getElementById('planeBtn').addEventListener('click', addAirplane);
document.getElementById('birdBtn').addEventListener('click', addBirdFlock);
document.getElementById('saveBtn').addEventListener('click', saveImage);

// Keyboard
document.addEventListener('keydown', e => {
  if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
  if (e.key === 'e' && !e.ctrlKey) document.getElementById('eraserBtn').click();
  if (e.key === 'p' && !e.ctrlKey) addAirplane();
  if (e.key === 'b' && !e.ctrlKey) addBirdFlock();
  if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveImage(); }

  const brushMap = { '1':'fluffy', '2':'wispy', '3':'puffy', '4':'storm', '5':'rainbow' };
  if (brushMap[e.key] && !e.ctrlKey) {
    document.querySelector(`[data-brush="${brushMap[e.key]}"]`).click();
  }
  if (e.key === '[') {
    brushSize = Math.max(10, brushSize - 5);
    sizeSlider.value = brushSize;
    sizeLabel.textContent = brushSize;
  }
  if (e.key === ']') {
    brushSize = Math.min(120, brushSize + 5);
    sizeSlider.value = brushSize;
    sizeLabel.textContent = brushSize;
  }
});

// ==================== SAVE ====================
function saveImage() {
  const c = document.createElement('canvas');
  c.width = W * dpr;
  c.height = H * dpr;
  const cx = c.getContext('2d');
  cx.setTransform(dpr, 0, 0, dpr, 0, 0);

  // Composite: sky + ambient + draw layers
  cx.drawImage(skyCanvas, 0, 0, W, H);
  cx.drawImage(animCanvas, 0, 0, W, H);
  cx.drawImage(drawCanvas, 0, 0, W, H);

  // Watermark
  cx.save();
  cx.globalAlpha = 0.3;
  cx.font = "14px 'Bubblegum Sans', cursive";
  cx.fillStyle = 'white';
  cx.textAlign = 'right';
  cx.fillText('Made with Cloud Painter', W - 15, H - 15);
  cx.restore();

  const link = document.createElement('a');
  link.download = 'my-cloud-painting.png';
  link.href = c.toDataURL('image/png');
  link.click();
  showNotification('Picture saved!');
}

// ==================== NOTIFICATION ====================
let notifTimeout;
function showNotification(text) {
  const el = document.getElementById('notification');
  el.textContent = text;
  el.classList.add('show');
  clearTimeout(notifTimeout);
  notifTimeout = setTimeout(() => el.classList.remove('show'), 1800);
}

// ==================== WELCOME ====================
function initWelcome() {
  // Draw animated welcome sky
  let welcomeTime = 0;
  const welcomeAmbient = [];
  for (let i = 0; i < 8; i++) {
    const blobs = [];
    for (let j = 0; j < 4 + Math.floor(Math.random()*4); j++) {
      blobs.push({
        ox: (Math.random()-0.5)*1.2, oy: (Math.random()-0.5)*0.5,
        size: 0.3 + Math.random()*0.5, phase: Math.random()*Math.PI*2
      });
    }
    welcomeAmbient.push({
      x: Math.random() * W, y: 20 + Math.random() * H * 0.6,
      size: 60 + Math.random()*120, speed: 0.15 + Math.random()*0.2,
      alpha: 0.15 + Math.random()*0.2, blobs
    });
  }

  function drawWelcomeFrame() {
    if (appStarted) return;
    welcomeTime += 0.016;

    // Sky gradient
    const g = welcomeCtx.createLinearGradient(0, 0, 0, H);
    g.addColorStop(0, '#4A9BD9');
    g.addColorStop(0.5, '#87CEEB');
    g.addColorStop(1, '#E8F4FF');
    welcomeCtx.fillStyle = g;
    welcomeCtx.fillRect(0, 0, W, H);

    // Clouds
    welcomeAmbient.forEach(c => {
      c.x += c.speed;
      if (c.x > W + c.size * 2) { c.x = -c.size * 2; c.y = 20 + Math.random()*H*0.6; }

      welcomeCtx.save();
      welcomeCtx.globalAlpha = c.alpha;
      c.blobs.forEach(b => {
        const bx = c.x + b.ox*c.size + Math.sin(welcomeTime*0.5+b.phase)*4;
        const by = c.y + b.oy*c.size + Math.cos(welcomeTime*0.3+b.phase)*3;
        const bs = b.size * c.size;
        const gg = welcomeCtx.createRadialGradient(bx, by, 0, bx, by, bs);
        gg.addColorStop(0, 'rgba(255,255,255,0.9)');
        gg.addColorStop(0.5, 'rgba(255,255,255,0.4)');
        gg.addColorStop(1, 'rgba(255,255,255,0)');
        welcomeCtx.fillStyle = gg;
        welcomeCtx.beginPath();
        welcomeCtx.arc(bx, by, bs, 0, Math.PI*2);
        welcomeCtx.fill();
      });
      welcomeCtx.restore();
    });

    requestAnimationFrame(drawWelcomeFrame);
  }

  drawWelcomeFrame();

  document.getElementById('startBtn').addEventListener('click', () => {
    appStarted = true;
    const overlay = document.getElementById('welcomeOverlay');
    overlay.classList.add('hidden');
    setTimeout(() => { overlay.style.display = 'none'; }, 1000);

    // Auto-add an airplane after a bit
    setTimeout(addAirplane, 2500);
    setTimeout(addBirdFlock, 5000);
  });
}

// ==================== MAIN LOOP ====================
let lastTime = 0;
let gameTime = 0;

function animate(timestamp) {
  const dt = lastTime ? Math.min((timestamp - lastTime) / 1000, 0.05) : 0.016;
  lastTime = timestamp;
  gameTime += dt;

  // Clear animated layers
  animCtx.clearRect(0, 0, W, H);
  uiCtx.clearRect(0, 0, W, H);

  // Ambient clouds
  updateAmbientClouds(dt);
  ambientClouds.forEach(c => drawAmbientCloud(animCtx, c, gameTime));

  // Airplanes
  updateAirplanes(dt);
  airplanes.forEach(p => drawAirplane(animCtx, p));

  // Birds
  updateBirds(dt);
  birds.forEach(b => drawBird(animCtx, b, gameTime));

  // Particles
  updateParticles(dt);
  drawParticles(animCtx);

  // Cursor
  if (appStarted) drawBrushCursor(uiCtx);

  requestAnimationFrame(animate);
}

// ==================== INIT ====================
function init() {
  resizeCanvases();
  initWelcome();
  initAmbientClouds();
  requestAnimationFrame(animate);
}

init();
</script>
</body>
</html>
