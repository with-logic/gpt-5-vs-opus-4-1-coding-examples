<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Micro Habit Tracker</title>
<style>
  :root {
    --bg: #0f0f1a;
    --bg2: #1a1a2e;
    --bg3: #25253e;
    --surface: #2a2a4a;
    --surface-hover: #33335a;
    --text: #e8e8f0;
    --text-dim: #8888aa;
    --accent: #7c5cfc;
    --accent-light: #9b7eff;
    --accent-glow: rgba(124, 92, 252, 0.3);
    --green: #4ade80;
    --green-dim: rgba(74, 222, 128, 0.15);
    --green-glow: rgba(74, 222, 128, 0.4);
    --orange: #fb923c;
    --orange-dim: rgba(251, 146, 60, 0.15);
    --red: #f87171;
    --red-dim: rgba(248, 113, 113, 0.15);
    --skip: #60a5fa;
    --skip-dim: rgba(96, 165, 250, 0.15);
    --border: rgba(255,255,255,0.06);
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 4px 24px rgba(0,0,0,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background animated gradient */
  body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(124, 92, 252, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(74, 222, 128, 0.05) 0%, transparent 50%);
    animation: bgShift 20s ease-in-out infinite alternate;
    z-index: -1;
    pointer-events: none;
  }

  @keyframes bgShift {
    0% { transform: translate(0, 0); }
    100% { transform: translate(-5%, -3%); }
  }

  .app {
    max-width: 720px;
    margin: 0 auto;
    padding: 20px 16px 100px;
  }

  /* Header */
  header {
    text-align: center;
    padding: 28px 0 20px;
  }

  header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent-light), var(--green));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
  }

  header .subtitle {
    color: var(--text-dim);
    font-size: 0.85rem;
    margin-top: 4px;
  }

  .motivational-quote {
    text-align: center;
    color: var(--text-dim);
    font-style: italic;
    font-size: 0.8rem;
    padding: 8px 20px 16px;
    opacity: 0.8;
  }

  /* Date Navigation */
  .date-nav {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 20px;
  }

  .date-nav button {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 1rem;
  }

  .date-nav button:hover { background: var(--surface-hover); }
  .date-nav button:disabled { opacity: 0.3; cursor: not-allowed; }

  .date-nav .date-display {
    font-size: 1rem;
    font-weight: 600;
    min-width: 180px;
    text-align: center;
  }

  .date-nav .today-badge {
    background: var(--accent);
    color: white;
    font-size: 0.65rem;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 6px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  /* Stats bar */
  .stats-bar {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
    text-align: center;
  }

  .stat-card .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
  }

  .stat-card .stat-label {
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 2px;
  }

  .stat-card.streak .stat-value { color: var(--orange); }
  .stat-card.completed .stat-value { color: var(--green); }
  .stat-card.rate .stat-value { color: var(--accent-light); }

  /* Toolbar */
  .toolbar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
    white-space: nowrap;
  }

  .btn:hover { background: var(--surface-hover); border-color: rgba(255,255,255,0.12); }
  .btn.primary { background: var(--accent); border-color: var(--accent); color: white; }
  .btn.primary:hover { background: var(--accent-light); }
  .btn.danger { color: var(--red); }
  .btn.danger:hover { background: var(--red-dim); }

  .toolbar .spacer { flex: 1; }

  /* Habit list */
  .habit-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .habit-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.25s;
    position: relative;
    overflow: hidden;
  }

  .habit-card::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    border-radius: 0 2px 2px 0;
    transition: background 0.3s;
  }

  .habit-card.done::before { background: var(--green); box-shadow: 0 0 8px var(--green-glow); }
  .habit-card.skipped::before { background: var(--skip); }
  .habit-card.missed::before { background: var(--red); opacity: 0.5; }

  .habit-card:hover { border-color: rgba(255,255,255,0.1); }

  .habit-check {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid var(--text-dim);
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    flex-shrink: 0;
    color: transparent;
    font-size: 1rem;
    position: relative;
  }

  .habit-check:hover { border-color: var(--green); background: var(--green-dim); }

  .habit-card.done .habit-check {
    background: var(--green);
    border-color: var(--green);
    color: white;
    box-shadow: 0 0 12px var(--green-glow);
    animation: checkPop 0.3s ease-out;
  }

  .habit-card.skipped .habit-check {
    background: var(--skip-dim);
    border-color: var(--skip);
    color: var(--skip);
    font-size: 0.75rem;
  }

  @keyframes checkPop {
    0% { transform: scale(0.8); }
    50% { transform: scale(1.15); }
    100% { transform: scale(1); }
  }

  .habit-info {
    flex: 1;
    min-width: 0;
  }

  .habit-info .habit-name {
    font-size: 0.95rem;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .habit-info .habit-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 3px;
    font-size: 0.75rem;
    color: var(--text-dim);
  }

  .habit-emoji {
    font-size: 1.3rem;
    flex-shrink: 0;
    width: 28px;
    text-align: center;
  }

  .streak-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    color: var(--orange);
    font-weight: 600;
  }

  .streak-badge.long { color: var(--red); }

  .habit-actions {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
  }

  .habit-actions button {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 6px;
    font-size: 0.85rem;
    transition: all 0.2s;
  }

  .habit-actions button:hover { background: var(--surface); color: var(--text); }
  .habit-actions button.skip-btn:hover { color: var(--skip); }
  .habit-actions button.delete-btn:hover { color: var(--red); }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--text-dim);
  }

  .empty-state .empty-icon {
    font-size: 3rem;
    margin-bottom: 12px;
    opacity: 0.5;
  }

  .empty-state p { font-size: 0.9rem; margin-bottom: 16px; }

  /* Weekly chart */
  .chart-section {
    margin-top: 28px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
  }

  .chart-section h3 {
    font-size: 0.85rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 16px;
  }

  .chart-grid {
    display: flex;
    gap: 6px;
    align-items: end;
    height: 120px;
  }

  .chart-bar-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    gap: 6px;
  }

  .chart-bar-track {
    flex: 1;
    width: 100%;
    display: flex;
    align-items: end;
    justify-content: center;
  }

  .chart-bar {
    width: 80%;
    max-width: 40px;
    border-radius: 6px 6px 3px 3px;
    background: linear-gradient(to top, var(--accent), var(--accent-light));
    transition: height 0.5s ease-out;
    position: relative;
    min-height: 2px;
  }

  .chart-bar.today { background: linear-gradient(to top, var(--green), #6ee7a0); }
  .chart-bar.future { background: var(--bg3); opacity: 0.4; }

  .chart-bar-label {
    font-size: 0.65rem;
    color: var(--text-dim);
    text-align: center;
    font-weight: 500;
  }

  .chart-bar-label.today { color: var(--green); font-weight: 700; }

  .chart-bar-value {
    font-size: 0.6rem;
    color: var(--text-dim);
    text-align: center;
  }

  /* Heatmap */
  .heatmap-section {
    margin-top: 16px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
  }

  .heatmap-section h3 {
    font-size: 0.85rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
  }

  .heatmap-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }

  .heatmap-day-label {
    font-size: 0.6rem;
    color: var(--text-dim);
    text-align: center;
    padding-bottom: 4px;
  }

  .heatmap-cell {
    aspect-ratio: 1;
    border-radius: 4px;
    background: var(--bg3);
    position: relative;
    transition: all 0.2s;
  }

  .heatmap-cell.level-1 { background: rgba(124, 92, 252, 0.2); }
  .heatmap-cell.level-2 { background: rgba(124, 92, 252, 0.4); }
  .heatmap-cell.level-3 { background: rgba(124, 92, 252, 0.6); }
  .heatmap-cell.level-4 { background: rgba(74, 222, 128, 0.5); }
  .heatmap-cell.level-5 { background: rgba(74, 222, 128, 0.75); }
  .heatmap-cell.future { background: var(--bg3); opacity: 0.3; }
  .heatmap-cell.today { outline: 2px solid var(--accent-light); outline-offset: 1px; }

  .heatmap-cell[title] { cursor: default; }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transition: all 0.25s;
    padding: 16px;
  }

  .modal-overlay.open { opacity: 1; visibility: visible; }

  .modal {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    width: 100%;
    max-width: 400px;
    box-shadow: var(--shadow);
    transform: translateY(20px) scale(0.95);
    transition: transform 0.25s;
  }

  .modal-overlay.open .modal { transform: translateY(0) scale(1); }

  .modal h2 {
    font-size: 1.1rem;
    margin-bottom: 16px;
  }

  .form-group {
    margin-bottom: 14px;
  }

  .form-group label {
    display: block;
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-bottom: 6px;
  }

  .form-group input, .form-group select {
    width: 100%;
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-size: 0.9rem;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
  }

  .form-group input:focus, .form-group select:focus {
    border-color: var(--accent);
  }

  .emoji-picker {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
  }

  .emoji-picker button {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg);
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .emoji-picker button:hover { background: var(--surface); border-color: rgba(255,255,255,0.15); }
  .emoji-picker button.selected { border-color: var(--accent); background: var(--accent-glow); }

  .modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 20px;
    border-radius: var(--radius);
    font-size: 0.85rem;
    z-index: 200;
    transition: transform 0.3s ease;
    box-shadow: var(--shadow);
    white-space: nowrap;
  }

  .toast.show { transform: translateX(-50%) translateY(0); }

  /* Confetti canvas */
  #confetti-canvas {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 300;
  }

  /* Limit badge */
  .limit-note {
    color: var(--text-dim);
    font-size: 0.75rem;
    text-align: center;
    margin-top: 8px;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .app { padding: 12px 10px 100px; }
    header h1 { font-size: 1.4rem; }
    .stats-bar { gap: 6px; }
    .stat-card { padding: 10px 8px; }
    .stat-card .stat-value { font-size: 1.2rem; }
    .habit-card { padding: 12px; gap: 10px; }
    .habit-actions button { padding: 4px; }
    .chart-grid { height: 90px; }
    .toolbar { gap: 6px; }
    .btn { padding: 7px 10px; font-size: 0.75rem; }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--surface); border-radius: 3px; }

  /* File input hidden */
  #import-input { display: none; }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .habit-card { animation: fadeIn 0.3s ease-out; }

  /* Completion celebration */
  .all-done-banner {
    background: linear-gradient(135deg, rgba(74, 222, 128, 0.12), rgba(124, 92, 252, 0.12));
    border: 1px solid rgba(74, 222, 128, 0.2);
    border-radius: var(--radius);
    padding: 14px 20px;
    text-align: center;
    margin-bottom: 16px;
    font-size: 0.9rem;
    color: var(--green);
    font-weight: 600;
    animation: fadeIn 0.5s ease;
  }
</style>
</head>
<body>
<canvas id="confetti-canvas"></canvas>
<div class="app" id="app">
  <header>
    <h1>Micro Habit Tracker</h1>
    <div class="subtitle">Small steps, big changes</div>
  </header>
  <div class="motivational-quote" id="quote"></div>

  <!-- Date Navigation -->
  <div class="date-nav">
    <button id="prev-day" title="Previous day">&#8249;</button>
    <div class="date-display" id="date-display"></div>
    <button id="next-day" title="Next day">&#8250;</button>
  </div>

  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat-card streak">
      <div class="stat-value" id="stat-best-streak">0</div>
      <div class="stat-label">Best Streak</div>
    </div>
    <div class="stat-card completed">
      <div class="stat-value" id="stat-today-done">0/0</div>
      <div class="stat-label">Today</div>
    </div>
    <div class="stat-card rate">
      <div class="stat-value" id="stat-week-rate">0%</div>
      <div class="stat-label">This Week</div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <button class="btn primary" id="add-habit-btn">+ Add Habit</button>
    <div class="spacer"></div>
    <button class="btn" id="export-btn">Export</button>
    <button class="btn" id="import-btn">Import</button>
    <input type="file" id="import-input" accept=".json">
  </div>

  <!-- All done banner -->
  <div id="all-done-banner" class="all-done-banner" style="display:none;"></div>

  <!-- Habit list -->
  <div class="habit-list" id="habit-list"></div>

  <!-- Limit note -->
  <div class="limit-note" id="limit-note" style="display:none;">Maximum 7 habits reached</div>

  <!-- Weekly chart -->
  <div class="chart-section">
    <h3>Last 7 Days</h3>
    <div class="chart-grid" id="weekly-chart"></div>
  </div>

  <!-- 28-day Heatmap -->
  <div class="heatmap-section">
    <h3>28-Day Overview</h3>
    <div id="heatmap-labels" class="heatmap-grid" style="margin-bottom:2px;"></div>
    <div class="heatmap-grid" id="heatmap" style="grid-template-columns: repeat(7, 1fr);"></div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <h2 id="modal-title">Add Habit</h2>
    <div class="form-group">
      <label for="habit-name-input">Habit Name</label>
      <input type="text" id="habit-name-input" placeholder="e.g., Drink water" maxlength="40" autocomplete="off">
    </div>
    <div class="form-group">
      <label>Icon</label>
      <div class="emoji-picker" id="emoji-picker"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="modal-cancel">Cancel</button>
      <button class="btn primary" id="modal-save">Save</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
(function() {
  'use strict';

  // â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const STORAGE_KEY = 'microHabitTracker_v2';
  const MAX_HABITS = 7;
  const EMOJIS = ['ðŸ’§','ðŸƒ','ðŸ“–','ðŸ§˜','ðŸ’ª','ðŸ¥—','ðŸ˜´','âœï¸','ðŸŽ¯','ðŸ§ ','ðŸ’Š','ðŸŒ±','â˜€ï¸','ðŸŽ¨','ðŸ“','ðŸŽµ','ðŸ«','â¤ï¸','ðŸŽ','ðŸ§¹'];
  const QUOTES = [
    "Consistency is the mother of mastery.",
    "A small daily improvement leads to stunning results.",
    "You don't have to be extreme â€” just consistent.",
    "Success is the sum of small efforts repeated daily.",
    "The secret of getting ahead is getting started.",
    "What you do every day matters more than what you do once in a while.",
    "Discipline is choosing between what you want now and what you want most.",
    "Progress, not perfection.",
    "One day or day one. You decide.",
    "Your habits shape your identity.",
    "Small hinges swing big doors.",
    "Don't break the chain!"
  ];

  // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function dateStr(d) {
    const dd = d instanceof Date ? d : new Date(d);
    return dd.getFullYear() + '-' +
      String(dd.getMonth()+1).padStart(2,'0') + '-' +
      String(dd.getDate()).padStart(2,'0');
  }

  function todayStr() { return dateStr(new Date()); }

  function addDays(ds, n) {
    const d = new Date(ds + 'T12:00:00');
    d.setDate(d.getDate() + n);
    return dateStr(d);
  }

  function dayName(ds) {
    const d = new Date(ds + 'T12:00:00');
    return d.toLocaleDateString('en-US', { weekday: 'short' });
  }

  function formatDate(ds) {
    const d = new Date(ds + 'T12:00:00');
    const today = todayStr();
    const yesterday = addDays(today, -1);
    if (ds === today) return 'Today';
    if (ds === yesterday) return 'Yesterday';
    return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  }

  function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 7); }

  // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let state = {
    habits: [],
    log: {} // { "2025-02-01": { "habitId": "done"|"skip" } }
  };

  let currentDate = todayStr();
  let editingHabitId = null;

  // â”€â”€â”€ Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function saveState() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {}
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed && Array.isArray(parsed.habits)) {
          state = parsed;
          return true;
        }
      }
    } catch(e) {}
    return false;
  }

  // â”€â”€â”€ Demo Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function generateDemoData() {
    const today = todayStr();
    const habits = [
      { id: uid(), name: 'Drink 8 glasses of water', emoji: 'ðŸ’§', createdAt: addDays(today, -14) },
      { id: uid(), name: 'Morning run', emoji: 'ðŸƒ', createdAt: addDays(today, -10) },
      { id: uid(), name: 'Read 20 pages', emoji: 'ðŸ“–', createdAt: addDays(today, -14) },
      { id: uid(), name: 'Meditate 10 min', emoji: 'ðŸ§˜', createdAt: addDays(today, -7) },
      { id: uid(), name: 'No junk food', emoji: 'ðŸ¥—', createdAt: addDays(today, -14) },
    ];

    const log = {};
    // Create realistic past data
    for (let i = 13; i >= 1; i--) {
      const day = addDays(today, -i);
      log[day] = {};
      habits.forEach(h => {
        if (day < h.createdAt) return;
        const rand = Math.random();
        if (rand < 0.65) log[day][h.id] = 'done';
        else if (rand < 0.78) log[day][h.id] = 'skip';
        // else: missed
      });
    }

    // Make recent days more consistent (building habits)
    for (let i = 3; i >= 1; i--) {
      const day = addDays(today, -i);
      if (!log[day]) log[day] = {};
      habits.forEach(h => {
        const rand = Math.random();
        if (rand < 0.82) log[day][h.id] = 'done';
        else if (rand < 0.92) log[day][h.id] = 'skip';
      });
    }

    // Ensure some streaks exist - water and read have consistent recent data
    for (let i = 5; i >= 1; i--) {
      const day = addDays(today, -i);
      if (!log[day]) log[day] = {};
      log[day][habits[0].id] = 'done'; // water streak
      log[day][habits[2].id] = 'done'; // reading streak
    }

    state = { habits, log };
    saveState();
  }

  // â”€â”€â”€ Streak Calculation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getStreak(habitId) {
    let streak = 0;
    let day = todayStr();

    // Check if today is done
    const todayStatus = state.log[day]?.[habitId];
    if (todayStatus === 'done') {
      streak = 1;
      day = addDays(day, -1);
    } else {
      // Start from yesterday if today not done yet
      day = addDays(day, -1);
    }

    while (true) {
      const status = state.log[day]?.[habitId];
      if (status === 'done') {
        streak++;
        day = addDays(day, -1);
      } else if (status === 'skip') {
        day = addDays(day, -1); // skip doesn't break streak
      } else {
        break;
      }
    }
    return streak;
  }

  function getBestStreak() {
    let best = 0;
    state.habits.forEach(h => {
      const s = getStreak(h.id);
      if (s > best) best = s;
    });
    return best;
  }

  // â”€â”€â”€ Status for a habit on a given day â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getHabitStatus(habitId, day) {
    return state.log[day]?.[habitId] || null;
  }

  function setHabitStatus(habitId, day, status) {
    if (!state.log[day]) state.log[day] = {};
    if (status === null) {
      delete state.log[day][habitId];
    } else {
      state.log[day][habitId] = status;
    }
    saveState();
  }

  // â”€â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function render() {
    renderDate();
    renderStats();
    renderHabits();
    renderChart();
    renderHeatmap();
    renderLimitNote();
    renderAllDoneBanner();
  }

  function renderDate() {
    const el = document.getElementById('date-display');
    const label = formatDate(currentDate);
    const isToday = currentDate === todayStr();
    el.innerHTML = label + (isToday ? '<span class="today-badge">today</span>' : '');

    document.getElementById('next-day').disabled = currentDate >= todayStr();
  }

  function renderStats() {
    const today = todayStr();
    const total = state.habits.length;
    let doneToday = 0;
    state.habits.forEach(h => {
      if (getHabitStatus(h.id, today) === 'done') doneToday++;
    });

    document.getElementById('stat-best-streak').textContent = getBestStreak();
    document.getElementById('stat-today-done').textContent = `${doneToday}/${total}`;

    // Week rate
    let weekDone = 0, weekTotal = 0;
    for (let i = 0; i < 7; i++) {
      const day = addDays(today, -i);
      state.habits.forEach(h => {
        if (day >= h.createdAt) {
          weekTotal++;
          const s = getHabitStatus(h.id, day);
          if (s === 'done' || s === 'skip') weekDone++;
        }
      });
    }
    const rate = weekTotal > 0 ? Math.round((weekDone / weekTotal) * 100) : 0;
    document.getElementById('stat-week-rate').textContent = rate + '%';
  }

  function renderHabits() {
    const list = document.getElementById('habit-list');

    if (state.habits.length === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">ðŸŽ¯</div>
          <p>No habits yet. Start building your routine!</p>
          <button class="btn primary" onclick="document.getElementById('add-habit-btn').click()">+ Add Your First Habit</button>
        </div>`;
      return;
    }

    list.innerHTML = state.habits.map(h => {
      const status = getHabitStatus(h.id, currentDate);
      const streak = getStreak(h.id);
      const cls = status === 'done' ? 'done' : status === 'skip' ? 'skipped' : '';
      const checkContent = status === 'done' ? 'âœ“' : status === 'skip' ? 'âŸ³' : '';
      const streakClass = streak >= 7 ? 'long' : '';

      return `
        <div class="habit-card ${cls}" data-id="${h.id}">
          <button class="habit-check" onclick="app.toggleHabit('${h.id}')" title="Mark done">${checkContent}</button>
          <span class="habit-emoji">${h.emoji}</span>
          <div class="habit-info">
            <div class="habit-name">${escHtml(h.name)}</div>
            <div class="habit-meta">
              ${streak > 0 ? `<span class="streak-badge ${streakClass}">ðŸ”¥ ${streak} day${streak !== 1 ? 's' : ''}</span>` : ''}
              ${status === 'skip' ? '<span style="color:var(--skip)">Skipped</span>' : ''}
            </div>
          </div>
          <div class="habit-actions">
            <button class="skip-btn" onclick="app.skipHabit('${h.id}')" title="Skip day">âŠ˜</button>
            <button onclick="app.editHabit('${h.id}')" title="Edit">âœŽ</button>
            <button class="delete-btn" onclick="app.deleteHabit('${h.id}')" title="Delete">âœ•</button>
          </div>
        </div>`;
    }).join('');
  }

  function renderChart() {
    const container = document.getElementById('weekly-chart');
    const today = todayStr();
    const total = state.habits.length || 1;

    let html = '';
    for (let i = 6; i >= 0; i--) {
      const day = addDays(today, -i);
      let done = 0;
      state.habits.forEach(h => {
        if (getHabitStatus(h.id, day) === 'done') done++;
      });
      const pct = Math.round((done / total) * 100);
      const height = Math.max(2, pct);
      const isToday = i === 0;
      const isFuture = day > today;

      html += `
        <div class="chart-bar-wrapper">
          <div class="chart-bar-value">${done}/${state.habits.length}</div>
          <div class="chart-bar-track">
            <div class="chart-bar ${isToday ? 'today' : ''} ${isFuture ? 'future' : ''}" style="height:${height}%;" title="${day}: ${done}/${state.habits.length} completed"></div>
          </div>
          <div class="chart-bar-label ${isToday ? 'today' : ''}">${dayName(day)}</div>
        </div>`;
    }
    container.innerHTML = html;
  }

  function renderHeatmap() {
    const container = document.getElementById('heatmap');
    const labelsContainer = document.getElementById('heatmap-labels');
    const today = todayStr();
    const total = state.habits.length || 1;

    // Day labels
    const dayLabels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    labelsContainer.innerHTML = dayLabels.map(d => `<div class="heatmap-day-label">${d}</div>`).join('');

    // Figure out 4 weeks grid (28 days)
    // End on today's week's sunday, or start from 4 weeks ago Monday
    const todayDate = new Date(today + 'T12:00:00');
    const todayDow = todayDate.getDay(); // 0=Sun
    // Get the Monday of 4 weeks ago
    const mondayOffset = todayDow === 0 ? 6 : todayDow - 1; // days since Monday
    const startDate = addDays(today, -(27 + mondayOffset - (6 - mondayOffset)));

    // Actually let's just do last 28 days aligned to weeks
    // Find the Monday on or before 27 days ago
    const refDate = new Date(addDays(today, -27) + 'T12:00:00');
    const refDow = refDate.getDay();
    const daysToMon = refDow === 0 ? 6 : refDow - 1;
    const gridStart = addDays(addDays(today, -27), -daysToMon);

    // We need enough cells to cover from gridStart through today's week Sunday
    const endDate = new Date(today + 'T12:00:00');
    const endDow = endDate.getDay();
    const daysToSun = endDow === 0 ? 0 : 7 - endDow;
    const gridEnd = addDays(today, daysToSun);

    let html = '';
    let d = gridStart;
    while (d <= gridEnd) {
      const isFuture = d > today;
      const isToday = d === today;
      let level = 0;
      let title = '';

      if (!isFuture) {
        let done = 0;
        state.habits.forEach(h => {
          if (getHabitStatus(h.id, d) === 'done') done++;
        });
        const pct = total > 0 ? done / total : 0;
        if (pct > 0 && pct <= 0.2) level = 1;
        else if (pct <= 0.4) level = pct > 0 ? 2 : 0;
        else if (pct <= 0.6) level = 3;
        else if (pct <= 0.8) level = 4;
        else if (pct > 0.8) level = 5;
        title = `${formatDateShort(d)}: ${done}/${state.habits.length}`;
      }

      html += `<div class="heatmap-cell ${isFuture ? 'future' : 'level-'+level} ${isToday ? 'today' : ''}" title="${title}"></div>`;
      d = addDays(d, 1);
    }
    container.innerHTML = html;
  }

  function formatDateShort(ds) {
    const d = new Date(ds + 'T12:00:00');
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function renderLimitNote() {
    document.getElementById('limit-note').style.display =
      state.habits.length >= MAX_HABITS ? 'block' : 'none';
  }

  function renderAllDoneBanner() {
    const banner = document.getElementById('all-done-banner');
    if (state.habits.length === 0) { banner.style.display = 'none'; return; }

    const allDone = state.habits.every(h =>
      getHabitStatus(h.id, currentDate) === 'done' || getHabitStatus(h.id, currentDate) === 'skip'
    );
    const allCompleted = state.habits.every(h => getHabitStatus(h.id, currentDate) === 'done');

    if (allDone && currentDate === todayStr()) {
      if (allCompleted) {
        banner.textContent = 'ðŸŽ‰ All habits completed today! You\'re unstoppable!';
      } else {
        banner.textContent = 'âœ… All habits accounted for today!';
      }
      banner.style.display = 'block';
    } else {
      banner.style.display = 'none';
    }
  }

  function escHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  // â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleHabit(id) {
    const current = getHabitStatus(id, currentDate);
    if (current === 'done') {
      setHabitStatus(id, currentDate, null);
    } else {
      setHabitStatus(id, currentDate, 'done');
      // Check if all done
      const allDone = state.habits.every(h => getHabitStatus(h.id, currentDate) === 'done');
      if (allDone && state.habits.length > 0 && currentDate === todayStr()) {
        setTimeout(launchConfetti, 150);
      }
    }
    render();
  }

  function skipHabit(id) {
    const current = getHabitStatus(id, currentDate);
    if (current === 'skip') {
      setHabitStatus(id, currentDate, null);
    } else {
      setHabitStatus(id, currentDate, 'skip');
    }
    render();
  }

  function deleteHabit(id) {
    const habit = state.habits.find(h => h.id === id);
    if (!habit) return;
    if (!confirm(`Delete "${habit.name}"? This will remove all history for this habit.`)) return;

    state.habits = state.habits.filter(h => h.id !== id);
    // Clean log
    Object.keys(state.log).forEach(day => {
      delete state.log[day][id];
    });
    saveState();
    render();
    showToast('Habit deleted');
  }

  function editHabit(id) {
    const habit = state.habits.find(h => h.id === id);
    if (!habit) return;
    editingHabitId = id;
    openModal('Edit Habit', habit.name, habit.emoji);
  }

  // â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openModal(title, name = '', emoji = 'ðŸŽ¯') {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('habit-name-input').value = name;
    selectedEmoji = emoji;
    renderEmojiPicker();
    document.getElementById('modal-overlay').classList.add('open');
    setTimeout(() => document.getElementById('habit-name-input').focus(), 100);
  }

  function closeModal() {
    document.getElementById('modal-overlay').classList.remove('open');
    editingHabitId = null;
  }

  let selectedEmoji = 'ðŸŽ¯';

  function renderEmojiPicker() {
    const container = document.getElementById('emoji-picker');
    container.innerHTML = EMOJIS.map(e =>
      `<button type="button" class="${e === selectedEmoji ? 'selected' : ''}" onclick="app.selectEmoji('${e}')">${e}</button>`
    ).join('');
  }

  function selectEmoji(e) {
    selectedEmoji = e;
    renderEmojiPicker();
  }

  function saveModal() {
    const name = document.getElementById('habit-name-input').value.trim();
    if (!name) {
      document.getElementById('habit-name-input').focus();
      return;
    }

    if (editingHabitId) {
      const habit = state.habits.find(h => h.id === editingHabitId);
      if (habit) {
        habit.name = name;
        habit.emoji = selectedEmoji;
      }
    } else {
      if (state.habits.length >= MAX_HABITS) {
        showToast('Maximum 7 habits reached');
        closeModal();
        return;
      }
      state.habits.push({
        id: uid(),
        name,
        emoji: selectedEmoji,
        createdAt: todayStr()
      });
    }

    saveState();
    closeModal();
    render();
    showToast(editingHabitId ? 'Habit updated' : 'Habit added!');
  }

  // â”€â”€â”€ Export / Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function exportData() {
    const json = JSON.stringify(state, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `habit-tracker-${todayStr()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Data exported');
  }

  function importData() {
    document.getElementById('import-input').click();
  }

  function handleImport(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = JSON.parse(ev.target.result);
        if (!data.habits || !Array.isArray(data.habits)) throw new Error('Invalid format');
        state = data;
        saveState();
        render();
        showToast('Data imported successfully');
      } catch(err) {
        showToast('Import failed: invalid file');
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  }

  // â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let toastTimer = null;
  function showToast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
  }

  // â”€â”€â”€ Confetti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function launchConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const particles = [];
    const colors = ['#7c5cfc','#4ade80','#fb923c','#f87171','#60a5fa','#fbbf24','#e879f9'];

    for (let i = 0; i < 80; i++) {
      particles.push({
        x: canvas.width * 0.5 + (Math.random() - 0.5) * 200,
        y: canvas.height * 0.4,
        vx: (Math.random() - 0.5) * 12,
        vy: Math.random() * -14 - 4,
        size: Math.random() * 6 + 3,
        color: colors[Math.floor(Math.random() * colors.length)],
        rotation: Math.random() * 360,
        rotSpeed: (Math.random() - 0.5) * 10,
        life: 1
      });
    }

    let frame;
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let alive = false;

      particles.forEach(p => {
        if (p.life <= 0) return;
        alive = true;
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.35;
        p.vx *= 0.99;
        p.rotation += p.rotSpeed;
        p.life -= 0.012;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rotation * Math.PI / 180);
        ctx.globalAlpha = Math.max(0, p.life);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
        ctx.restore();
      });

      if (alive) {
        frame = requestAnimationFrame(animate);
      } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }
    animate();
  }

  // â”€â”€â”€ Quote â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setQuote() {
    // Deterministic based on date so it changes daily
    const day = new Date();
    const idx = (day.getFullYear() * 366 + day.getMonth() * 31 + day.getDate()) % QUOTES.length;
    document.getElementById('quote').textContent = `"${QUOTES[idx]}"`;
  }

  // â”€â”€â”€ Date Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function prevDay() {
    currentDate = addDays(currentDate, -1);
    render();
  }

  function nextDay() {
    if (currentDate < todayStr()) {
      currentDate = addDays(currentDate, 1);
      render();
    }
  }

  // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function init() {
    if (!loadState()) {
      generateDemoData();
    }

    setQuote();
    render();

    // Event listeners
    document.getElementById('add-habit-btn').addEventListener('click', () => {
      if (state.habits.length >= MAX_HABITS) {
        showToast('Maximum 7 habits reached');
        return;
      }
      editingHabitId = null;
      openModal('Add Habit');
    });

    document.getElementById('modal-cancel').addEventListener('click', closeModal);
    document.getElementById('modal-save').addEventListener('click', saveModal);
    document.getElementById('modal-overlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });

    document.getElementById('habit-name-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') saveModal();
      if (e.key === 'Escape') closeModal();
    });

    document.getElementById('prev-day').addEventListener('click', prevDay);
    document.getElementById('next-day').addEventListener('click', nextDay);
    document.getElementById('export-btn').addEventListener('click', exportData);
    document.getElementById('import-btn').addEventListener('click', importData);
    document.getElementById('import-input').addEventListener('change', handleImport);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (document.getElementById('modal-overlay').classList.contains('open')) return;
      if (e.key === 'ArrowLeft') prevDay();
      if (e.key === 'ArrowRight') nextDay();
    });

    // Touch swipe for date navigation
    let touchStartX = 0;
    let touchStartY = 0;
    document.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }, { passive: true });

    document.addEventListener('touchend', (e) => {
      const dx = e.changedTouches[0].clientX - touchStartX;
      const dy = e.changedTouches[0].clientY - touchStartY;
      if (Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy) * 1.5) {
        if (dx > 0) prevDay();
        else nextDay();
      }
    }, { passive: true });
  }

  // Expose public API
  window.app = {
    toggleHabit,
    skipHabit,
    deleteHabit,
    editHabit,
    selectEmoji
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>
