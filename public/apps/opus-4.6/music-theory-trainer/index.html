<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Music Theory Trainer</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');

  :root {
    --bg-primary: #0a0a1a;
    --bg-secondary: #12122a;
    --bg-card: #1a1a3e;
    --bg-card-hover: #222255;
    --accent-primary: #7c3aed;
    --accent-secondary: #a78bfa;
    --accent-pink: #ec4899;
    --accent-cyan: #06b6d4;
    --accent-green: #10b981;
    --accent-orange: #f59e0b;
    --accent-red: #ef4444;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --border-color: #2d2d5e;
    --glow-purple: rgba(124, 58, 237, 0.3);
    --glow-pink: rgba(236, 72, 153, 0.3);
    --glow-cyan: rgba(6, 182, 212, 0.3);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background animation */
  .bg-particles {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
  }

  .bg-particles .note {
    position: absolute;
    font-size: 20px;
    opacity: 0.06;
    animation: floatNote linear infinite;
    color: var(--accent-secondary);
  }

  @keyframes floatNote {
    0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
    10% { opacity: 0.08; }
    90% { opacity: 0.08; }
    100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
  }

  /* Header */
  .app-header {
    position: relative;
    z-index: 10;
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
    border-bottom: 1px solid var(--border-color);
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 4px 30px rgba(0,0,0,0.3);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-pink));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    box-shadow: 0 4px 15px var(--glow-purple);
  }

  .logo-text {
    font-size: 22px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent-secondary), var(--accent-pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .logo-sub {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 400;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .stats-bar {
    display: flex;
    gap: 24px;
    align-items: center;
  }

  .stat-item {
    text-align: center;
  }

  .stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--accent-secondary);
  }

  .stat-label {
    font-size: 10px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* Navigation */
  .nav-tabs {
    position: relative;
    z-index: 10;
    display: flex;
    justify-content: center;
    gap: 4px;
    padding: 16px 32px 0;
    background: var(--bg-primary);
  }

  .nav-tab {
    padding: 12px 24px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border-radius: 12px 12px 0 0;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
  }

  .nav-tab:hover {
    color: var(--text-secondary);
    background: var(--bg-secondary);
  }

  .nav-tab.active {
    color: var(--text-primary);
    background: var(--bg-secondary);
  }

  .nav-tab.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    height: 3px;
    background: linear-gradient(90deg, var(--accent-primary), var(--accent-pink));
    border-radius: 3px 3px 0 0;
  }

  .nav-tab .tab-icon {
    font-size: 18px;
  }

  /* Main content */
  .main-content {
    position: relative;
    z-index: 10;
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px 32px 48px;
  }

  .section {
    display: none;
    animation: fadeIn 0.4s ease;
  }

  .section.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Cards */
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
  }

  .card:hover {
    border-color: var(--accent-primary);
    box-shadow: 0 4px 20px var(--glow-purple);
  }

  .card-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card-title .icon {
    font-size: 22px;
  }

  /* Piano Keyboard */
  .piano-container {
    position: relative;
    margin: 20px auto;
    user-select: none;
    overflow-x: auto;
    padding-bottom: 10px;
  }

  .piano-keyboard {
    display: flex;
    position: relative;
    height: 180px;
    margin: 0 auto;
    width: fit-content;
  }

  .piano-key {
    position: relative;
    cursor: pointer;
    transition: all 0.08s ease;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 12px;
    font-size: 11px;
    font-weight: 500;
    font-family: 'Poppins', sans-serif;
  }

  .piano-key.white {
    width: 48px;
    height: 180px;
    background: linear-gradient(180deg, #f8f8f8 0%, #ffffff 20%, #e8e8e8 100%);
    border: 1px solid #c0c0c0;
    border-radius: 0 0 8px 8px;
    z-index: 1;
    color: #999;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), inset 0 -2px 4px rgba(0,0,0,0.05);
  }

  .piano-key.white:hover {
    background: linear-gradient(180deg, #f0f0ff 0%, #e8e8ff 20%, #d8d8f0 100%);
  }

  .piano-key.white.pressed {
    background: linear-gradient(180deg, #d0d0ff 0%, #c8c8ff 20%, #b8b8f0 100%);
    box-shadow: 0 2px 3px rgba(0,0,0,0.2), inset 0 -1px 2px rgba(0,0,0,0.05);
    transform: translateY(2px);
  }

  .piano-key.white.highlighted {
    background: linear-gradient(180deg, #c4b5fd 0%, #a78bfa 40%, #8b5cf6 100%);
    color: white;
    border-color: #7c3aed;
    box-shadow: 0 4px 15px var(--glow-purple);
  }

  .piano-key.white.correct {
    background: linear-gradient(180deg, #6ee7b7 0%, #34d399 40%, #10b981 100%);
    color: white;
    border-color: #059669;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
  }

  .piano-key.white.wrong {
    background: linear-gradient(180deg, #fca5a5 0%, #f87171 40%, #ef4444 100%);
    color: white;
    border-color: #dc2626;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
  }

  .piano-key.black {
    width: 30px;
    height: 115px;
    background: linear-gradient(180deg, #333 0%, #1a1a1a 60%, #111 100%);
    border: 1px solid #000;
    border-radius: 0 0 6px 6px;
    margin-left: -15px;
    margin-right: -15px;
    z-index: 2;
    color: #777;
    font-size: 9px;
    padding-bottom: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.5), inset 0 -2px 4px rgba(255,255,255,0.05);
  }

  .piano-key.black:hover {
    background: linear-gradient(180deg, #444 0%, #2a2a2a 60%, #222 100%);
  }

  .piano-key.black.pressed {
    background: linear-gradient(180deg, #555 0%, #333 60%, #222 100%);
    height: 112px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }

  .piano-key.black.highlighted {
    background: linear-gradient(180deg, #7c3aed 0%, #6d28d9 60%, #5b21b6 100%);
    color: white;
    box-shadow: 0 4px 15px var(--glow-purple);
  }

  .piano-key.black.correct {
    background: linear-gradient(180deg, #10b981 0%, #059669 60%, #047857 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(16,185,129,0.4);
  }

  .piano-key.black.wrong {
    background: linear-gradient(180deg, #ef4444 0%, #dc2626 60%, #b91c1c 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(239,68,68,0.4);
  }

  .key-label {
    pointer-events: none;
  }

  /* Controls */
  .controls-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 16px;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    font-family: 'Poppins', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent-primary), #6d28d9);
    color: white;
    box-shadow: 0 4px 15px var(--glow-purple);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--glow-purple);
  }

  .btn-primary:active {
    transform: translateY(0);
  }

  .btn-secondary {
    background: var(--bg-card);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
  }

  .btn-secondary:hover {
    border-color: var(--accent-primary);
    color: var(--text-primary);
  }

  .btn-secondary.active {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
  }

  .btn-success {
    background: linear-gradient(135deg, var(--accent-green), #059669);
    color: white;
  }

  .btn-pink {
    background: linear-gradient(135deg, var(--accent-pink), #db2777);
    color: white;
    box-shadow: 0 4px 15px var(--glow-pink);
  }

  .btn-cyan {
    background: linear-gradient(135deg, var(--accent-cyan), #0891b2);
    color: white;
    box-shadow: 0 4px 15px var(--glow-cyan);
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }

  select, input[type="number"] {
    padding: 10px 16px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    background: var(--bg-card);
    color: var(--text-primary);
    font-family: 'Poppins', sans-serif;
    font-size: 13px;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
  }

  select:focus, input[type="number"]:focus {
    border-color: var(--accent-primary);
  }

  /* Feedback messages */
  .feedback {
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    margin: 12px 0;
    display: none;
    align-items: center;
    gap: 8px;
    animation: slideIn 0.3s ease;
  }

  .feedback.show {
    display: flex;
  }

  .feedback.correct {
    background: rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #6ee7b7;
  }

  .feedback.wrong {
    background: rgba(239, 68, 68, 0.15);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #fca5a5;
  }

  .feedback.info {
    background: rgba(6, 182, 212, 0.15);
    border: 1px solid rgba(6, 182, 212, 0.3);
    color: #67e8f9;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-10px); }
    to { opacity: 1; transform: translateX(0); }
  }

  /* Scale/Chord info display */
  .info-display {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin: 16px 0;
  }

  .info-tag {
    padding: 6px 14px;
    background: rgba(124, 58, 237, 0.15);
    border: 1px solid rgba(124, 58, 237, 0.3);
    border-radius: 20px;
    font-size: 13px;
    color: var(--accent-secondary);
    font-weight: 500;
  }

  .info-tag.root {
    background: rgba(236, 72, 153, 0.15);
    border-color: rgba(236, 72, 153, 0.3);
    color: var(--accent-pink);
  }

  /* Interval buttons grid */
  .interval-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 8px;
    margin: 16px 0;
  }

  .interval-btn {
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    background: var(--bg-card);
    color: var(--text-primary);
    font-family: 'Poppins', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .interval-btn:hover {
    border-color: var(--accent-primary);
    background: var(--bg-card-hover);
    transform: translateY(-1px);
  }

  .interval-btn.correct-answer {
    background: rgba(16, 185, 129, 0.2);
    border-color: var(--accent-green);
    color: #6ee7b7;
    animation: pulse 0.5s ease;
  }

  .interval-btn.wrong-answer {
    background: rgba(239, 68, 68, 0.2);
    border-color: var(--accent-red);
    color: #fca5a5;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  /* Progress bar */
  .progress-bar-container {
    width: 100%;
    height: 6px;
    background: var(--bg-primary);
    border-radius: 3px;
    overflow: hidden;
    margin: 12px 0;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-primary), var(--accent-pink));
    border-radius: 3px;
    transition: width 0.5s ease;
  }

  /* Score display */
  .score-display {
    display: flex;
    gap: 24px;
    padding: 16px 20px;
    background: var(--bg-primary);
    border-radius: 12px;
    margin: 12px 0;
  }

  .score-item {
    text-align: center;
    flex: 1;
  }

  .score-value {
    font-size: 28px;
    font-weight: 700;
  }

  .score-value.green { color: var(--accent-green); }
  .score-value.red { color: var(--accent-red); }
  .score-value.blue { color: var(--accent-cyan); }

  .score-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* Grid layouts */
  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .three-col {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
  }

  /* Note reference table */
  .note-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 6px;
    margin: 16px 0;
  }

  .note-cell {
    padding: 10px 4px;
    text-align: center;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .note-cell.natural {
    background: rgba(255,255,255,0.08);
    color: var(--text-primary);
  }

  .note-cell.sharp {
    background: rgba(124, 58, 237, 0.15);
    color: var(--accent-secondary);
  }

  .note-cell:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }

  /* Quiz mode choice buttons */
  .choice-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin: 16px 0;
  }

  .choice-btn {
    padding: 16px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    background: var(--bg-card);
    color: var(--text-primary);
    font-family: 'Poppins', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .choice-btn:hover {
    border-color: var(--accent-primary);
    background: var(--bg-card-hover);
    transform: translateY(-2px);
  }

  .choice-btn.correct-answer {
    border-color: var(--accent-green);
    background: rgba(16, 185, 129, 0.15);
    color: #6ee7b7;
  }

  .choice-btn.wrong-answer {
    border-color: var(--accent-red);
    background: rgba(239, 68, 68, 0.15);
    color: #fca5a5;
  }

  /* Streak fire animation */
  .streak-display {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    background: rgba(245, 158, 11, 0.15);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    color: var(--accent-orange);
  }

  .streak-display.hot {
    animation: fireGlow 0.5s ease infinite alternate;
  }

  @keyframes fireGlow {
    from { box-shadow: 0 0 5px rgba(245, 158, 11, 0.3); }
    to { box-shadow: 0 0 15px rgba(245, 158, 11, 0.5); }
  }

  /* Volume control */
  .volume-control {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  input[type="range"] {
    -webkit-appearance: none;
    width: 100px;
    height: 4px;
    background: var(--border-color);
    border-radius: 2px;
    outline: none;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--accent-primary);
    border-radius: 50%;
    cursor: pointer;
  }

  /* Staff notation display */
  .staff-display {
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 20px;
    margin: 16px 0;
    position: relative;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .staff-canvas {
    width: 100%;
    height: 120px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .app-header {
      padding: 12px 16px;
      flex-direction: column;
      gap: 12px;
    }

    .main-content {
      padding: 16px;
    }

    .two-col, .three-col {
      grid-template-columns: 1fr;
    }

    .nav-tabs {
      padding: 12px 16px 0;
      overflow-x: auto;
    }

    .nav-tab {
      padding: 10px 16px;
      font-size: 12px;
      white-space: nowrap;
    }

    .piano-key.white {
      width: 36px;
      height: 150px;
    }

    .piano-key.black {
      width: 24px;
      height: 95px;
      margin-left: -12px;
      margin-right: -12px;
    }

    .choice-grid {
      grid-template-columns: 1fr;
    }

    .interval-grid {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
  }

  /* Confetti */
  .confetti-piece {
    position: fixed;
    z-index: 9999;
    pointer-events: none;
    animation: confettiFall linear forwards;
  }

  @keyframes confettiFall {
    0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
  }

  /* Tooltip */
  .tooltip {
    position: relative;
  }

  .tooltip::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-card);
    color: var(--text-primary);
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    border: 1px solid var(--border-color);
  }

  .tooltip:hover::after {
    opacity: 1;
  }

  /* Circle of fifths */
  .circle-of-fifths {
    width: 320px;
    height: 320px;
    margin: 20px auto;
    position: relative;
  }

  .cof-note {
    position: absolute;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid var(--border-color);
    background: var(--bg-card);
  }

  .cof-note:hover {
    transform: scale(1.15);
    border-color: var(--accent-primary);
    box-shadow: 0 0 15px var(--glow-purple);
  }

  .cof-note.active {
    background: var(--accent-primary);
    border-color: var(--accent-secondary);
    color: white;
    box-shadow: 0 0 20px var(--glow-purple);
  }

  /* Section header */
  .section-header {
    margin-bottom: 24px;
  }

  .section-header h2 {
    font-size: 26px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .section-header p {
    color: var(--text-muted);
    font-size: 14px;
  }

  /* Key signature display */
  .key-sig-display {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: var(--bg-primary);
    border-radius: 12px;
    margin: 12px 0;
  }

  .key-sig-name {
    font-size: 32px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent-secondary), var(--accent-pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .key-sig-details {
    flex: 1;
  }

  .formula-display {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-top: 8px;
  }

  .formula-step {
    padding: 4px 10px;
    background: rgba(124, 58, 237, 0.1);
    border-radius: 6px;
    font-size: 12px;
    color: var(--accent-secondary);
    font-weight: 500;
  }

  /* Waveform visualization */
  .waveform-container {
    height: 60px;
    background: var(--bg-primary);
    border-radius: 10px;
    overflow: hidden;
    margin: 12px 0;
  }

  .waveform-canvas {
    width: 100%;
    height: 100%;
  }
</style>
</head>
<body>

<!-- Floating music notes background -->
<div class="bg-particles" id="bgParticles"></div>

<!-- Header -->
<header class="app-header">
  <div class="logo">
    <div class="logo-icon">üéπ</div>
    <div>
      <div class="logo-text">Music Theory Trainer</div>
      <div class="logo-sub">Master the language of music</div>
    </div>
  </div>
  <div class="stats-bar">
    <div class="volume-control">
      <span style="font-size: 16px;">üîä</span>
      <input type="range" id="volumeSlider" min="0" max="100" value="60" title="Volume">
    </div>
    <div class="stat-item">
      <div class="stat-value" id="totalScore">0</div>
      <div class="stat-label">Score</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="streakCount">0</div>
      <div class="stat-label">Streak</div>
    </div>
  </div>
</header>

<!-- Navigation Tabs -->
<nav class="nav-tabs">
  <button class="nav-tab active" data-section="piano" onclick="switchSection('piano')">
    <span class="tab-icon">üéπ</span> Piano
  </button>
  <button class="nav-tab" data-section="scales" onclick="switchSection('scales')">
    <span class="tab-icon">üéµ</span> Scales
  </button>
  <button class="nav-tab" data-section="chords" onclick="switchSection('chords')">
    <span class="tab-icon">üé∂</span> Chords
  </button>
  <button class="nav-tab" data-section="ear" onclick="switchSection('ear')">
    <span class="tab-icon">üëÇ</span> Ear Training
  </button>
  <button class="nav-tab" data-section="reference" onclick="switchSection('reference')">
    <span class="tab-icon">üìö</span> Reference
  </button>
</nav>

<!-- Main Content -->
<main class="main-content">

  <!-- ====== PIANO SECTION ====== -->
  <div class="section active" id="section-piano">
    <div class="section-header">
      <h2>Interactive Piano</h2>
      <p>Click the keys or use your keyboard to play. Toggle labels and explore notes freely.</p>
    </div>

    <div class="card">
      <div class="controls-row">
        <button class="btn btn-secondary" id="toggleLabels" onclick="togglePianoLabels()">
          üè∑Ô∏è Labels: ON
        </button>
        <button class="btn btn-secondary" id="toggleSustain" onclick="toggleSustain()">
          üîó Sustain: OFF
        </button>
        <select id="octaveSelect" onchange="rebuildPiano()">
          <option value="2">2 Octaves</option>
          <option value="3" selected>3 Octaves</option>
          <option value="4">4 Octaves</option>
        </select>
        <select id="startOctave" onchange="rebuildPiano()">
          <option value="2">Start: C2</option>
          <option value="3">Start: C3</option>
          <option value="4" selected>Start: C4</option>
          <option value="5">Start: C5</option>
        </select>
        <select id="soundType" onchange="updateSoundType()">
          <option value="piano">Piano</option>
          <option value="organ">Organ</option>
          <option value="synth">Synth</option>
          <option value="strings">Strings</option>
        </select>
      </div>

      <div class="waveform-container">
        <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
      </div>

      <div class="piano-container" id="pianoContainer">
        <div class="piano-keyboard" id="pianoKeyboard"></div>
      </div>

      <div class="feedback info show" id="pianoFeedback">
        <span>üéµ</span> Play a note to see its name, frequency, and MIDI number
      </div>

      <div style="margin-top:12px; font-size:12px; color: var(--text-muted);">
        <strong>Keyboard mapping:</strong> A-; for white keys (from C), W-P for black keys. Z/X to shift octave down/up.
      </div>
    </div>
  </div>

  <!-- ====== SCALES SECTION ====== -->
  <div class="section" id="section-scales">
    <div class="section-header">
      <h2>Scales Explorer</h2>
      <p>Learn and practice major, minor, and modal scales. See them on the piano and hear them played.</p>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">üéº</span> Scale Browser</div>
      <div class="controls-row">
        <select id="scaleRoot" onchange="updateScale()">
          <option value="0">C</option><option value="1">C#/Db</option>
          <option value="2">D</option><option value="3">D#/Eb</option>
          <option value="4">E</option><option value="5">F</option>
          <option value="6">F#/Gb</option><option value="7">G</option>
          <option value="8">G#/Ab</option><option value="9">A</option>
          <option value="10">A#/Bb</option><option value="11">B</option>
        </select>
        <select id="scaleType" onchange="updateScale()">
          <option value="major">Major (Ionian)</option>
          <option value="natural_minor">Natural Minor (Aeolian)</option>
          <option value="harmonic_minor">Harmonic Minor</option>
          <option value="melodic_minor">Melodic Minor</option>
          <option value="dorian">Dorian</option>
          <option value="phrygian">Phrygian</option>
          <option value="lydian">Lydian</option>
          <option value="mixolydian">Mixolydian</option>
          <option value="locrian">Locrian</option>
          <option value="pentatonic_major">Pentatonic Major</option>
          <option value="pentatonic_minor">Pentatonic Minor</option>
          <option value="blues">Blues</option>
          <option value="whole_tone">Whole Tone</option>
          <option value="chromatic">Chromatic</option>
        </select>
        <button class="btn btn-primary" onclick="playScale()">‚ñ∂ Play Scale</button>
        <button class="btn btn-pink" onclick="playScaleDesc()">‚ñ∂ Descending</button>
      </div>

      <div class="key-sig-display" id="scaleInfo">
        <div class="key-sig-name" id="scaleNameDisplay">C Major</div>
        <div class="key-sig-details">
          <div style="color: var(--text-secondary); font-size: 13px;" id="scaleNotes">C D E F G A B</div>
          <div class="formula-display" id="scaleFormula"></div>
        </div>
      </div>

      <div class="piano-container">
        <div class="piano-keyboard" id="scalePiano"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">üß†</span> Scale Quiz</div>
      <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">
        Identify scale degrees by clicking the correct key on the piano.
      </p>
      <div class="controls-row">
        <button class="btn btn-primary" onclick="startScaleQuiz()">Start Quiz</button>
        <span id="scaleQuizPrompt" style="color: var(--text-secondary); font-size: 14px;"></span>
      </div>
      <div class="score-display">
        <div class="score-item">
          <div class="score-value green" id="scaleQuizCorrect">0</div>
          <div class="score-label">Correct</div>
        </div>
        <div class="score-item">
          <div class="score-value red" id="scaleQuizWrong">0</div>
          <div class="score-label">Wrong</div>
        </div>
        <div class="score-item">
          <div class="score-value blue" id="scaleQuizTotal">0</div>
          <div class="score-label">Total</div>
        </div>
      </div>
      <div class="feedback" id="scaleQuizFeedback"></div>
    </div>
  </div>

  <!-- ====== CHORDS SECTION ====== -->
  <div class="section" id="section-chords">
    <div class="section-header">
      <h2>Chords Workshop</h2>
      <p>Explore chord types, inversions, and voicings. Hear how chords sound and learn their construction.</p>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">üé∏</span> Chord Browser</div>
      <div class="controls-row">
        <select id="chordRoot" onchange="updateChord()">
          <option value="0">C</option><option value="1">C#/Db</option>
          <option value="2">D</option><option value="3">D#/Eb</option>
          <option value="4">E</option><option value="5">F</option>
          <option value="6">F#/Gb</option><option value="7">G</option>
          <option value="8">G#/Ab</option><option value="9">A</option>
          <option value="10">A#/Bb</option><option value="11">B</option>
        </select>
        <select id="chordType" onchange="updateChord()">
          <option value="major">Major</option>
          <option value="minor">Minor</option>
          <option value="diminished">Diminished</option>
          <option value="augmented">Augmented</option>
          <option value="sus2">Sus2</option>
          <option value="sus4">Sus4</option>
          <option value="dom7">Dominant 7th</option>
          <option value="maj7">Major 7th</option>
          <option value="min7">Minor 7th</option>
          <option value="dim7">Diminished 7th</option>
          <option value="m7b5">Half-Diminished</option>
          <option value="aug7">Augmented 7th</option>
          <option value="add9">Add 9</option>
          <option value="6">Major 6th</option>
          <option value="m6">Minor 6th</option>
          <option value="9">Dominant 9th</option>
        </select>
        <select id="chordInversion" onchange="updateChord()">
          <option value="0">Root Position</option>
          <option value="1">1st Inversion</option>
          <option value="2">2nd Inversion</option>
        </select>
        <button class="btn btn-primary" onclick="playChord()">‚ñ∂ Play Chord</button>
        <button class="btn btn-pink" onclick="playChordArpeggio()">üé∂ Arpeggio</button>
      </div>

      <div class="key-sig-display" id="chordInfo">
        <div class="key-sig-name" id="chordNameDisplay">C Major</div>
        <div class="key-sig-details">
          <div style="color: var(--text-secondary); font-size: 13px;" id="chordNotes">C E G</div>
          <div class="formula-display" id="chordFormula"></div>
        </div>
      </div>

      <div class="piano-container">
        <div class="piano-keyboard" id="chordPiano"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">üéØ</span> Chord Identification Quiz</div>
      <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">
        Listen to a chord and identify its type. Sharpen your harmonic recognition!
      </p>
      <div class="controls-row">
        <button class="btn btn-primary" id="chordQuizStart" onclick="startChordQuiz()">New Question</button>
        <button class="btn btn-cyan" id="chordQuizReplay" onclick="replayChordQuiz()" disabled>üîÑ Replay</button>
        <div class="streak-display" id="chordStreak">üî• 0</div>
      </div>

      <div class="choice-grid" id="chordQuizChoices"></div>

      <div class="score-display">
        <div class="score-item">
          <div class="score-value green" id="chordQuizCorrect">0</div>
          <div class="score-label">Correct</div>
        </div>
        <div class="score-item">
          <div class="score-value red" id="chordQuizWrong">0</div>
          <div class="score-label">Wrong</div>
        </div>
        <div class="score-item">
          <div class="score-value blue" id="chordQuizAccuracy">-%</div>
          <div class="score-label">Accuracy</div>
        </div>
      </div>
      <div class="feedback" id="chordQuizFeedback"></div>
    </div>
  </div>

  <!-- ====== EAR TRAINING SECTION ====== -->
  <div class="section" id="section-ear">
    <div class="section-header">
      <h2>Ear Training</h2>
      <p>Train your ear to recognize intervals, notes, and melodic patterns.</p>
    </div>

    <div class="two-col">
      <div class="card">
        <div class="card-title"><span class="icon">üéØ</span> Interval Recognition</div>
        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">
          Listen to two notes and identify the interval between them.
        </p>
        <div class="controls-row">
          <button class="btn btn-primary" onclick="startIntervalQuiz()">New Interval</button>
          <button class="btn btn-cyan" id="intervalReplay" onclick="replayInterval()" disabled>üîÑ Replay</button>
          <select id="intervalDirection">
            <option value="ascending">Ascending</option>
            <option value="descending">Descending</option>
            <option value="harmonic">Harmonic</option>
            <option value="random">Random</option>
          </select>
        </div>
        <div class="interval-grid" id="intervalChoices"></div>
        <div class="score-display">
          <div class="score-item">
            <div class="score-value green" id="intervalCorrect">0</div>
            <div class="score-label">Correct</div>
          </div>
          <div class="score-item">
            <div class="score-value red" id="intervalWrong">0</div>
            <div class="score-label">Wrong</div>
          </div>
          <div class="score-item">
            <div class="score-value blue" id="intervalAccuracy">-%</div>
            <div class="score-label">Accuracy</div>
          </div>
        </div>
        <div class="feedback" id="intervalFeedback"></div>
      </div>

      <div class="card">
        <div class="card-title"><span class="icon">üéµ</span> Note Identification</div>
        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">
          Listen to a note and identify its name. Great for developing absolute pitch awareness.
        </p>
        <div class="controls-row">
          <button class="btn btn-primary" onclick="startNoteQuiz()">New Note</button>
          <button class="btn btn-cyan" id="noteReplay" onclick="replayNoteQuiz()" disabled>üîÑ Replay</button>
        </div>
        <div class="choice-grid" id="noteQuizChoices"></div>
        <div class="score-display">
          <div class="score-item">
            <div class="score-value green" id="noteCorrect">0</div>
            <div class="score-label">Correct</div>
          </div>
          <div class="score-item">
            <div class="score-value red" id="noteWrong">0</div>
            <div class="score-label">Wrong</div>
          </div>
          <div class="score-item">
            <div class="score-value blue" id="noteAccuracy">-%</div>
            <div class="score-label">Accuracy</div>
          </div>
        </div>
        <div class="feedback" id="noteFeedback"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">üéº</span> Melodic Dictation</div>
      <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">
        Listen to a short melody and replay it on the piano. Tests your musical memory!
      </p>
      <div class="controls-row">
        <select id="melodyLength">
          <option value="3">3 Notes</option>
          <option value="4" selected>4 Notes</option>
          <option value="5">5 Notes</option>
          <option value="6">6 Notes</option>
          <option value="8">8 Notes</option>
        </select>
        <button class="btn btn-primary" onclick="startMelodyDictation()">New Melody</button>
        <button class="btn btn-cyan" id="melodyReplay" onclick="replayMelody()" disabled>üîÑ Replay</button>
        <button class="btn btn-secondary" id="melodySubmit" onclick="submitMelody()" disabled>‚úì Check</button>
        <button class="btn btn-secondary" id="melodyClear" onclick="clearMelodyInput()" disabled>‚úï Clear</button>
        <span id="melodyProgress" style="color: var(--text-secondary); font-size: 13px;"></span>
      </div>
      <div class="piano-container">
        <div class="piano-keyboard" id="melodyPiano"></div>
      </div>
      <div class="feedback" id="melodyFeedback"></div>
    </div>
  </div>

  <!-- ====== REFERENCE SECTION ====== -->
  <div class="section" id="section-reference">
    <div class="section-header">
      <h2>Music Theory Reference</h2>
      <p>Quick reference for notes, intervals, scales, and the Circle of Fifths.</p>
    </div>

    <div class="two-col">
      <div class="card">
        <div class="card-title"><span class="icon">üéµ</span> All 12 Notes</div>
        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">
          Click any note to hear it. The chromatic scale contains all 12 notes in Western music.
        </p>
        <div class="note-grid" id="noteGrid"></div>
      </div>

      <div class="card">
        <div class="card-title"><span class="icon">üìè</span> Intervals Reference</div>
        <div style="max-height: 300px; overflow-y: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="border-bottom: 1px solid var(--border-color);">
                <th style="text-align: left; padding: 8px; color: var(--text-muted);">Interval</th>
                <th style="text-align: center; padding: 8px; color: var(--text-muted);">Semitones</th>
                <th style="text-align: left; padding: 8px; color: var(--text-muted);">Example</th>
              </tr>
            </thead>
            <tbody id="intervalTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">‚≠ï</span> Circle of Fifths</div>
      <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">
        Click a note to hear the major scale and see related keys.
      </p>
      <div class="circle-of-fifths" id="circleOfFifths"></div>
      <div id="cofInfo" style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-top: 12px;"></div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">üìñ</span> Common Chord Progressions</div>
      <div class="three-col" id="progressionsGrid"></div>
    </div>
  </div>

</main>

<script>
// ===== AUDIO ENGINE =====
const AudioEngine = (() => {
  let ctx = null;
  let masterGain = null;
  let analyser = null;
  let soundType = 'piano';

  function getCtx() {
    if (!ctx) {
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = ctx.createGain();
      masterGain.gain.value = 0.6;
      analyser = ctx.createAnalyser();
      analyser.fftSize = 2048;
      masterGain.connect(analyser);
      analyser.connect(ctx.destination);
    }
    if (ctx.state === 'suspended') ctx.resume();
    return ctx;
  }

  function getAnalyser() {
    getCtx();
    return analyser;
  }

  function setVolume(v) {
    getCtx();
    masterGain.gain.value = v;
  }

  function setSoundType(type) {
    soundType = type;
  }

  function midiToFreq(midi) {
    return 440 * Math.pow(2, (midi - 69) / 12);
  }

  function playNote(midi, duration = 1.2, startTime = 0, velocity = 0.7) {
    const c = getCtx();
    const freq = midiToFreq(midi);
    const t = c.currentTime + startTime;

    const gainNode = c.createGain();
    gainNode.connect(masterGain);

    if (soundType === 'piano') {
      // Piano-like: multiple oscillators with different harmonics
      const partials = [1, 2, 3, 4, 5, 6];
      const amps = [1, 0.5, 0.25, 0.15, 0.08, 0.04];
      const oscs = [];

      partials.forEach((p, i) => {
        const osc = c.createOscillator();
        const partialGain = c.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq * p, t);
        // Slight detuning for richness
        if (i > 0) osc.detune.setValueAtTime(Math.random() * 4 - 2, t);
        partialGain.gain.setValueAtTime(amps[i] * velocity * 0.3, t);
        // Fast attack, medium decay
        partialGain.gain.exponentialRampToValueAtTime(amps[i] * velocity * 0.15, t + 0.01);
        partialGain.gain.exponentialRampToValueAtTime(amps[i] * velocity * 0.08, t + 0.1);
        partialGain.gain.exponentialRampToValueAtTime(0.001, t + duration);
        osc.connect(partialGain);
        partialGain.connect(gainNode);
        osc.start(t);
        osc.stop(t + duration + 0.05);
        oscs.push(osc);
      });

      gainNode.gain.setValueAtTime(1, t);
      gainNode.gain.exponentialRampToValueAtTime(0.001, t + duration);
    } else if (soundType === 'organ') {
      const partials = [1, 2, 3, 4, 5, 6, 8];
      const amps = [1, 0.8, 0.6, 0.4, 0.3, 0.2, 0.1];
      partials.forEach((p, i) => {
        const osc = c.createOscillator();
        const pg = c.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq * p, t);
        pg.gain.setValueAtTime(amps[i] * velocity * 0.12, t);
        osc.connect(pg);
        pg.connect(gainNode);
        osc.start(t);
        osc.stop(t + duration + 0.05);
      });
      gainNode.gain.setValueAtTime(1, t);
      gainNode.gain.setValueAtTime(1, t + duration - 0.05);
      gainNode.gain.exponentialRampToValueAtTime(0.001, t + duration);
    } else if (soundType === 'synth') {
      const osc1 = c.createOscillator();
      const osc2 = c.createOscillator();
      osc1.type = 'sawtooth';
      osc2.type = 'square';
      osc1.frequency.setValueAtTime(freq, t);
      osc2.frequency.setValueAtTime(freq * 1.002, t);
      const filter = c.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.setValueAtTime(freq * 6, t);
      filter.frequency.exponentialRampToValueAtTime(freq * 1.5, t + duration * 0.7);
      filter.Q.value = 2;
      const g1 = c.createGain(); g1.gain.value = velocity * 0.15;
      const g2 = c.createGain(); g2.gain.value = velocity * 0.08;
      osc1.connect(g1); osc2.connect(g2);
      g1.connect(filter); g2.connect(filter);
      filter.connect(gainNode);
      gainNode.gain.setValueAtTime(1, t);
      gainNode.gain.exponentialRampToValueAtTime(0.001, t + duration);
      osc1.start(t); osc2.start(t);
      osc1.stop(t + duration + 0.05); osc2.stop(t + duration + 0.05);
    } else if (soundType === 'strings') {
      const partials = [1, 2, 3, 4, 5];
      const amps = [1, 0.7, 0.3, 0.15, 0.07];
      partials.forEach((p, i) => {
        const osc = c.createOscillator();
        const pg = c.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(freq * p, t);
        osc.detune.setValueAtTime(Math.random() * 8 - 4, t);
        // LFO vibrato
        const lfo = c.createOscillator();
        const lfoGain = c.createGain();
        lfo.frequency.value = 5 + Math.random();
        lfoGain.gain.value = 3;
        lfo.connect(lfoGain);
        lfoGain.connect(osc.frequency);
        lfo.start(t);
        lfo.stop(t + duration + 0.1);
        pg.gain.setValueAtTime(0.001, t);
        pg.gain.linearRampToValueAtTime(amps[i] * velocity * 0.08, t + 0.15);
        pg.gain.linearRampToValueAtTime(amps[i] * velocity * 0.06, t + duration * 0.5);
        pg.gain.exponentialRampToValueAtTime(0.001, t + duration);
        osc.connect(pg);
        pg.connect(gainNode);
        osc.start(t);
        osc.stop(t + duration + 0.1);
      });
      const filter = c.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.value = freq * 4;
      filter.Q.value = 0.5;
      gainNode.disconnect();
      gainNode.connect(filter);
      filter.connect(masterGain);
      gainNode.gain.setValueAtTime(1, t);
    }

    return gainNode;
  }

  function playChordSound(midiNotes, duration = 1.5) {
    midiNotes.forEach(n => playNote(n, duration, 0, 0.5));
  }

  function playArpeggio(midiNotes, noteGap = 0.2, noteDuration = 0.8) {
    midiNotes.forEach((n, i) => playNote(n, noteDuration, i * noteGap, 0.6));
  }

  function playSequence(midiNotes, noteGap = 0.4, noteDuration = 0.5) {
    midiNotes.forEach((n, i) => playNote(n, noteDuration, i * noteGap, 0.65));
    return midiNotes.length * noteGap;
  }

  return { getCtx, getAnalyser, setVolume, setSoundType, midiToFreq, playNote, playChordSound, playArpeggio, playSequence };
})();

// ===== MUSIC DATA =====
const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
const NOTE_NAMES_FLAT = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
const NOTE_DISPLAY = ['C', 'C#/Db', 'D', 'D#/Eb', 'E', 'F', 'F#/Gb', 'G', 'G#/Ab', 'A', 'A#/Bb', 'B'];

const SCALES = {
  major: { name: 'Major', intervals: [0,2,4,5,7,9,11], formula: ['W','W','H','W','W','W','H'] },
  natural_minor: { name: 'Natural Minor', intervals: [0,2,3,5,7,8,10], formula: ['W','H','W','W','H','W','W'] },
  harmonic_minor: { name: 'Harmonic Minor', intervals: [0,2,3,5,7,8,11], formula: ['W','H','W','W','H','WH','H'] },
  melodic_minor: { name: 'Melodic Minor', intervals: [0,2,3,5,7,9,11], formula: ['W','H','W','W','W','W','H'] },
  dorian: { name: 'Dorian', intervals: [0,2,3,5,7,9,10], formula: ['W','H','W','W','W','H','W'] },
  phrygian: { name: 'Phrygian', intervals: [0,1,3,5,7,8,10], formula: ['H','W','W','W','H','W','W'] },
  lydian: { name: 'Lydian', intervals: [0,2,4,6,7,9,11], formula: ['W','W','W','H','W','W','H'] },
  mixolydian: { name: 'Mixolydian', intervals: [0,2,4,5,7,9,10], formula: ['W','W','H','W','W','H','W'] },
  locrian: { name: 'Locrian', intervals: [0,1,3,5,6,8,10], formula: ['H','W','W','H','W','W','W'] },
  pentatonic_major: { name: 'Pentatonic Major', intervals: [0,2,4,7,9], formula: ['W','W','WH','W','WH'] },
  pentatonic_minor: { name: 'Pentatonic Minor', intervals: [0,3,5,7,10], formula: ['WH','W','W','WH','W'] },
  blues: { name: 'Blues', intervals: [0,3,5,6,7,10], formula: ['WH','W','H','H','WH','W'] },
  whole_tone: { name: 'Whole Tone', intervals: [0,2,4,6,8,10], formula: ['W','W','W','W','W','W'] },
  chromatic: { name: 'Chromatic', intervals: [0,1,2,3,4,5,6,7,8,9,10,11], formula: ['H','H','H','H','H','H','H','H','H','H','H','H'] },
};

const CHORDS = {
  major: { name: 'Major', intervals: [0,4,7], symbol: '' },
  minor: { name: 'Minor', intervals: [0,3,7], symbol: 'm' },
  diminished: { name: 'Diminished', intervals: [0,3,6], symbol: 'dim' },
  augmented: { name: 'Augmented', intervals: [0,4,8], symbol: 'aug' },
  sus2: { name: 'Sus2', intervals: [0,2,7], symbol: 'sus2' },
  sus4: { name: 'Sus4', intervals: [0,5,7], symbol: 'sus4' },
  dom7: { name: 'Dominant 7th', intervals: [0,4,7,10], symbol: '7' },
  maj7: { name: 'Major 7th', intervals: [0,4,7,11], symbol: 'maj7' },
  min7: { name: 'Minor 7th', intervals: [0,3,7,10], symbol: 'm7' },
  dim7: { name: 'Diminished 7th', intervals: [0,3,6,9], symbol: 'dim7' },
  m7b5: { name: 'Half-Diminished', intervals: [0,3,6,10], symbol: 'm7b5' },
  aug7: { name: 'Augmented 7th', intervals: [0,4,8,10], symbol: 'aug7' },
  add9: { name: 'Add 9', intervals: [0,4,7,14], symbol: 'add9' },
  '6': { name: 'Major 6th', intervals: [0,4,7,9], symbol: '6' },
  m6: { name: 'Minor 6th', intervals: [0,3,7,9], symbol: 'm6' },
  '9': { name: 'Dominant 9th', intervals: [0,4,7,10,14], symbol: '9' },
};

const INTERVALS = [
  { name: 'Unison', short: 'P1', semitones: 0 },
  { name: 'Minor 2nd', short: 'm2', semitones: 1 },
  { name: 'Major 2nd', short: 'M2', semitones: 2 },
  { name: 'Minor 3rd', short: 'm3', semitones: 3 },
  { name: 'Major 3rd', short: 'M3', semitones: 4 },
  { name: 'Perfect 4th', short: 'P4', semitones: 5 },
  { name: 'Tritone', short: 'TT', semitones: 6 },
  { name: 'Perfect 5th', short: 'P5', semitones: 7 },
  { name: 'Minor 6th', short: 'm6', semitones: 8 },
  { name: 'Major 6th', short: 'M6', semitones: 9 },
  { name: 'Minor 7th', short: 'm7', semitones: 10 },
  { name: 'Major 7th', short: 'M7', semitones: 11 },
  { name: 'Octave', short: 'P8', semitones: 12 },
];

const COF_NOTES = ['C','G','D','A','E','B','F#/Gb','Db','Ab','Eb','Bb','F'];
const COF_MIDI = [0, 7, 2, 9, 4, 11, 6, 1, 8, 3, 10, 5];

// ===== STATE =====
let showLabels = true;
let sustainMode = false;
let currentSection = 'piano';

// Stats
let totalScore = 0;
let streak = 0;

// Quiz states
let scaleQuizState = { active: false, targetMidi: null, correct: 0, wrong: 0, total: 0 };
let chordQuizState = { active: false, answer: null, correct: 0, wrong: 0, answered: false, streak: 0 };
let intervalQuizState = { active: false, answer: null, notes: null, correct: 0, wrong: 0, answered: false };
let noteQuizState = { active: false, answer: null, midi: null, correct: 0, wrong: 0, answered: false };
let melodyState = { active: false, melody: [], input: [], playing: false };

// Keyboard mapping
const WHITE_KEY_MAP = {'a':0,'s':1,'d':2,'f':3,'g':4,'h':5,'j':6,'k':7,'l':8,';':9};
const BLACK_KEY_MAP = {'w':0,'e':1,'t':2,'y':3,'u':4,'o':5,'p':6};
let keyboardOctaveOffset = 0;

// ===== UTILITY =====
function noteNameFromMidi(midi) {
  return NOTE_NAMES[midi % 12] + Math.floor(midi / 12 - 1);
}

function midiFromNoteName(noteIdx, octave) {
  return (octave + 1) * 12 + noteIdx;
}

function getNoteName(noteIdx, preferFlat = false) {
  return preferFlat ? NOTE_NAMES_FLAT[noteIdx % 12] : NOTE_NAMES[noteIdx % 12];
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function randomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function updateStats() {
  document.getElementById('totalScore').textContent = totalScore;
  document.getElementById('streakCount').textContent = streak;
}

function showConfetti() {
  const colors = ['#7c3aed','#ec4899','#06b6d4','#10b981','#f59e0b','#ef4444'];
  for (let i = 0; i < 30; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.left = Math.random() * 100 + 'vw';
    el.style.top = '-10px';
    el.style.width = (Math.random() * 8 + 4) + 'px';
    el.style.height = (Math.random() * 8 + 4) + 'px';
    el.style.background = colors[Math.floor(Math.random() * colors.length)];
    el.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
    el.style.animationDuration = (Math.random() * 2 + 1.5) + 's';
    el.style.animationDelay = (Math.random() * 0.5) + 's';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }
}

// ===== SECTION SWITCHING =====
function switchSection(name) {
  currentSection = name;
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('section-' + name).classList.add('active');
  document.querySelector(`.nav-tab[data-section="${name}"]`).classList.add('active');
}

// ===== PIANO BUILDING =====
function buildPiano(containerId, numOctaves, startOctave, options = {}) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';

  const { onClick, highlightNotes, showLabelsOverride } = options;
  const sl = showLabelsOverride !== undefined ? showLabelsOverride : showLabels;

  const whitePattern = [0,2,4,5,7,9,11]; // C D E F G A B
  const blackPattern = [1,3,null,6,8,10,null]; // C# D# _ F# G# A# _

  for (let oct = startOctave; oct < startOctave + numOctaves; oct++) {
    // White keys
    for (let i = 0; i < 7; i++) {
      const noteIdx = whitePattern[i];
      const midi = (oct + 1) * 12 + noteIdx;
      const key = document.createElement('div');
      key.className = 'piano-key white';
      key.dataset.midi = midi;
      key.dataset.note = noteIdx;

      if (highlightNotes && highlightNotes.includes(midi)) {
        key.classList.add('highlighted');
      }

      const label = document.createElement('span');
      label.className = 'key-label';
      label.textContent = sl ? NOTE_NAMES[noteIdx] + (oct) : '';
      key.appendChild(label);

      key.addEventListener('mousedown', (e) => {
        e.preventDefault();
        pressKey(key, midi, onClick);
      });
      key.addEventListener('mouseup', () => releaseKey(key));
      key.addEventListener('mouseleave', () => releaseKey(key));
      key.addEventListener('touchstart', (e) => {
        e.preventDefault();
        pressKey(key, midi, onClick);
      }, { passive: false });
      key.addEventListener('touchend', (e) => {
        e.preventDefault();
        releaseKey(key);
      });

      container.appendChild(key);
    }

    // Black keys
    for (let i = 0; i < 7; i++) {
      const noteIdx = blackPattern[i];
      if (noteIdx === null) continue;
      const midi = (oct + 1) * 12 + noteIdx;
      const key = document.createElement('div');
      key.className = 'piano-key black';
      key.dataset.midi = midi;
      key.dataset.note = noteIdx;

      if (highlightNotes && highlightNotes.includes(midi)) {
        key.classList.add('highlighted');
      }

      const label = document.createElement('span');
      label.className = 'key-label';
      label.textContent = sl ? NOTE_NAMES[noteIdx] : '';
      key.appendChild(label);

      // Position black keys
      // White key width is 48px. Each octave has 7 white keys = 336px total.
      const octOffset = (oct - startOctave) * 7 * 48;
      const blackPositions = { 1: 33, 3: 81, 6: 177, 8: 225, 10: 273 };
      key.style.position = 'absolute';
      key.style.left = (octOffset + blackPositions[noteIdx]) + 'px';

      key.addEventListener('mousedown', (e) => {
        e.preventDefault();
        pressKey(key, midi, onClick);
      });
      key.addEventListener('mouseup', () => releaseKey(key));
      key.addEventListener('mouseleave', () => releaseKey(key));
      key.addEventListener('touchstart', (e) => {
        e.preventDefault();
        pressKey(key, midi, onClick);
      }, { passive: false });
      key.addEventListener('touchend', (e) => {
        e.preventDefault();
        releaseKey(key);
      });

      container.appendChild(key);
    }
  }

  const totalWidth = numOctaves * 7 * 48;
  container.style.width = totalWidth + 'px';
}

function pressKey(keyEl, midi, callback) {
  keyEl.classList.add('pressed');
  AudioEngine.playNote(midi, 1.5, 0, 0.7);
  if (callback) callback(midi, keyEl);

  // Update piano feedback if on piano section
  if (currentSection === 'piano') {
    const freq = AudioEngine.midiToFreq(midi);
    const fb = document.getElementById('pianoFeedback');
    fb.className = 'feedback info show';
    fb.innerHTML = `<span>üéµ</span> <strong>${noteNameFromMidi(midi)}</strong> &mdash; ${freq.toFixed(1)} Hz &mdash; MIDI ${midi}`;
  }
}

function releaseKey(keyEl) {
  if (!sustainMode) {
    keyEl.classList.remove('pressed');
  }
}

function rebuildPiano() {
  const numOct = parseInt(document.getElementById('octaveSelect').value);
  const startOct = parseInt(document.getElementById('startOctave').value);
  buildPiano('pianoKeyboard', numOct, startOct);
}

function togglePianoLabels() {
  showLabels = !showLabels;
  const btn = document.getElementById('toggleLabels');
  btn.textContent = 'üè∑Ô∏è Labels: ' + (showLabels ? 'ON' : 'OFF');
  rebuildPiano();
  // Also rebuild other pianos
  updateScale();
  updateChord();
}

function toggleSustain() {
  sustainMode = !sustainMode;
  const btn = document.getElementById('toggleSustain');
  btn.textContent = 'üîó Sustain: ' + (sustainMode ? 'ON' : 'OFF');
  if (sustainMode) btn.classList.add('active');
  else btn.classList.remove('active');
}

function updateSoundType() {
  AudioEngine.setSoundType(document.getElementById('soundType').value);
}

// ===== KEYBOARD INPUT =====
document.addEventListener('keydown', (e) => {
  if (e.repeat) return;
  if (currentSection !== 'piano') return;

  const key = e.key.toLowerCase();

  if (key === 'z') { keyboardOctaveOffset = Math.max(keyboardOctaveOffset - 1, -2); return; }
  if (key === 'x') { keyboardOctaveOffset = Math.min(keyboardOctaveOffset + 1, 2); return; }

  const startOct = parseInt(document.getElementById('startOctave').value) + keyboardOctaveOffset;

  // White keys
  if (WHITE_KEY_MAP[key] !== undefined) {
    const whitePattern = [0,2,4,5,7,9,11];
    const idx = WHITE_KEY_MAP[key];
    const octave = startOct + Math.floor(idx / 7);
    const noteIdx = whitePattern[idx % 7];
    const midi = (octave + 1) * 12 + noteIdx;
    const keyEl = document.querySelector(`#pianoKeyboard .piano-key[data-midi="${midi}"]`);
    if (keyEl && !keyEl.classList.contains('pressed')) {
      pressKey(keyEl, midi);
    }
  }

  // Black keys
  if (BLACK_KEY_MAP[key] !== undefined) {
    const blackNotes = [1, 3, 6, 8, 10]; // C# D# F# G# A#
    const idx = BLACK_KEY_MAP[key];
    if (idx < blackNotes.length) {
      const midi = (startOct + 1) * 12 + blackNotes[idx];
      const keyEl = document.querySelector(`#pianoKeyboard .piano-key[data-midi="${midi}"]`);
      if (keyEl && !keyEl.classList.contains('pressed')) {
        pressKey(keyEl, midi);
      }
    }
  }
});

document.addEventListener('keyup', (e) => {
  const key = e.key.toLowerCase();
  const startOct = parseInt(document.getElementById('startOctave').value) + keyboardOctaveOffset;

  if (WHITE_KEY_MAP[key] !== undefined) {
    const whitePattern = [0,2,4,5,7,9,11];
    const idx = WHITE_KEY_MAP[key];
    const octave = startOct + Math.floor(idx / 7);
    const noteIdx = whitePattern[idx % 7];
    const midi = (octave + 1) * 12 + noteIdx;
    const keyEl = document.querySelector(`#pianoKeyboard .piano-key[data-midi="${midi}"]`);
    if (keyEl) releaseKey(keyEl);
  }

  if (BLACK_KEY_MAP[key] !== undefined) {
    const blackNotes = [1, 3, 6, 8, 10];
    const idx = BLACK_KEY_MAP[key];
    if (idx < blackNotes.length) {
      const midi = (startOct + 1) * 12 + blackNotes[idx];
      const keyEl = document.querySelector(`#pianoKeyboard .piano-key[data-midi="${midi}"]`);
      if (keyEl) releaseKey(keyEl);
    }
  }
});

// ===== SCALES =====
function getScaleNotes(rootIdx, scaleType, octave = 4) {
  const scale = SCALES[scaleType];
  return scale.intervals.map(i => midiFromNoteName((rootIdx + i) % 12, octave + Math.floor((rootIdx + i) / 12)));
}

function updateScale() {
  const root = parseInt(document.getElementById('scaleRoot').value);
  const type = document.getElementById('scaleType').value;
  const scale = SCALES[type];

  const noteNames = scale.intervals.map(i => NOTE_DISPLAY[(root + i) % 12]);
  const midiNotes = getScaleNotes(root, type);

  document.getElementById('scaleNameDisplay').textContent = NOTE_NAMES[root] + ' ' + scale.name;
  document.getElementById('scaleNotes').textContent = noteNames.join(' ‚Äî ');

  const formulaEl = document.getElementById('scaleFormula');
  formulaEl.innerHTML = '';
  scale.formula.forEach(step => {
    const el = document.createElement('span');
    el.className = 'formula-step';
    el.textContent = step;
    formulaEl.appendChild(el);
  });

  buildPiano('scalePiano', 2, 4, { highlightNotes: midiNotes });
}

function playScale() {
  const root = parseInt(document.getElementById('scaleRoot').value);
  const type = document.getElementById('scaleType').value;
  const notes = getScaleNotes(root, type);
  // Add octave note at end
  notes.push(notes[0] + 12);
  AudioEngine.playSequence(notes, 0.3, 0.5);
}

function playScaleDesc() {
  const root = parseInt(document.getElementById('scaleRoot').value);
  const type = document.getElementById('scaleType').value;
  const notes = getScaleNotes(root, type);
  notes.push(notes[0] + 12);
  AudioEngine.playSequence(notes.reverse(), 0.3, 0.5);
}

// Scale Quiz
function startScaleQuiz() {
  scaleQuizState.active = true;
  const roots = [0,2,4,5,7,9]; // C D E F G A
  const root = roots[randomInt(0, roots.length - 1)];
  const scaleTypes = ['major', 'natural_minor'];
  const type = scaleTypes[randomInt(0, scaleTypes.length - 1)];
  const scale = SCALES[type];
  const degreeIdx = randomInt(0, scale.intervals.length - 1);
  const degree = degreeIdx + 1;
  const targetNote = (root + scale.intervals[degreeIdx]) % 12;
  const targetMidi = midiFromNoteName(targetNote, 4);

  scaleQuizState.targetMidi = targetMidi;

  document.getElementById('scaleQuizPrompt').innerHTML =
    `Find the <strong style="color:var(--accent-pink)">${ordinal(degree)} degree</strong> of <strong style="color:var(--accent-secondary)">${NOTE_NAMES[root]} ${scale.name}</strong> (${NOTE_DISPLAY[targetNote]})`;

  // Rebuild scale piano with click handler
  buildPiano('scalePiano', 2, 4, {
    onClick: (midi) => {
      if (!scaleQuizState.active) return;
      const fb = document.getElementById('scaleQuizFeedback');
      scaleQuizState.total++;

      if (midi % 12 === targetMidi % 12) {
        scaleQuizState.correct++;
        streak++;
        totalScore += 10;
        fb.className = 'feedback correct show';
        fb.innerHTML = `<span>‚úÖ</span> Correct! That's ${NOTE_DISPLAY[targetNote]}`;
        // Highlight correct
        document.querySelectorAll(`#scalePiano .piano-key[data-note="${targetNote}"]`).forEach(k => k.classList.add('correct'));
        setTimeout(() => startScaleQuiz(), 1500);
      } else {
        scaleQuizState.wrong++;
        streak = 0;
        fb.className = 'feedback wrong show';
        fb.innerHTML = `<span>‚ùå</span> That was ${NOTE_DISPLAY[midi % 12]}. The answer is ${NOTE_DISPLAY[targetNote]}`;
        document.querySelectorAll(`#scalePiano .piano-key[data-note="${targetNote}"]`).forEach(k => k.classList.add('correct'));
        const clickedKey = document.querySelector(`#scalePiano .piano-key[data-midi="${midi}"]`);
        if (clickedKey) clickedKey.classList.add('wrong');
        setTimeout(() => startScaleQuiz(), 2000);
      }

      updateStats();
      document.getElementById('scaleQuizCorrect').textContent = scaleQuizState.correct;
      document.getElementById('scaleQuizWrong').textContent = scaleQuizState.wrong;
      document.getElementById('scaleQuizTotal').textContent = scaleQuizState.total;
    }
  });
}

function ordinal(n) {
  const s = ['th','st','nd','rd'];
  const v = n % 100;
  return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

// ===== CHORDS =====
function getChordNotes(rootIdx, chordType, octave = 4, inversion = 0) {
  const chord = CHORDS[chordType];
  let notes = chord.intervals.map(i => midiFromNoteName((rootIdx + i) % 12, octave + Math.floor((rootIdx + i) / 12)));

  // Apply inversion
  for (let i = 0; i < inversion && i < notes.length - 1; i++) {
    notes[i] += 12;
  }
  notes.sort((a, b) => a - b);

  return notes;
}

function updateChord() {
  const root = parseInt(document.getElementById('chordRoot').value);
  const type = document.getElementById('chordType').value;
  const inv = parseInt(document.getElementById('chordInversion').value);
  const chord = CHORDS[type];

  const noteNames = chord.intervals.map(i => NOTE_DISPLAY[(root + i) % 12]);
  const midiNotes = getChordNotes(root, type, 4, inv);

  const invNames = ['Root Position', '1st Inversion', '2nd Inversion', '3rd Inversion'];
  document.getElementById('chordNameDisplay').textContent = NOTE_NAMES[root] + chord.symbol;
  document.getElementById('chordNotes').textContent = noteNames.join(' ‚Äî ') + (inv > 0 ? ` (${invNames[inv]})` : '');

  const formulaEl = document.getElementById('chordFormula');
  formulaEl.innerHTML = '';
  const intervalNames = { 0: 'R', 1: 'b2', 2: '2', 3: 'b3', 4: '3', 5: '4', 6: 'b5', 7: '5', 8: '#5', 9: '6', 10: 'b7', 11: '7', 12: '8', 14: '9' };
  chord.intervals.forEach(i => {
    const el = document.createElement('span');
    el.className = 'formula-step';
    el.textContent = intervalNames[i] || i;
    formulaEl.appendChild(el);
  });

  buildPiano('chordPiano', 2, 4, { highlightNotes: midiNotes });
}

function playChord() {
  const root = parseInt(document.getElementById('chordRoot').value);
  const type = document.getElementById('chordType').value;
  const inv = parseInt(document.getElementById('chordInversion').value);
  const notes = getChordNotes(root, type, 4, inv);
  AudioEngine.playChordSound(notes);
}

function playChordArpeggio() {
  const root = parseInt(document.getElementById('chordRoot').value);
  const type = document.getElementById('chordType').value;
  const inv = parseInt(document.getElementById('chordInversion').value);
  const notes = getChordNotes(root, type, 4, inv);
  AudioEngine.playArpeggio(notes, 0.25, 1.0);
}

// Chord Quiz
function startChordQuiz() {
  const quizTypes = ['major', 'minor', 'diminished', 'augmented', 'dom7', 'maj7', 'min7'];
  const root = randomInt(0, 11);
  const correctType = quizTypes[randomInt(0, quizTypes.length - 1)];
  const notes = getChordNotes(root, correctType, 4, 0);

  chordQuizState.active = true;
  chordQuizState.answer = correctType;
  chordQuizState.answered = false;
  chordQuizState.notes = notes;

  // Play the chord
  AudioEngine.playChordSound(notes);

  document.getElementById('chordQuizReplay').disabled = false;

  // Generate choices (4 options including correct)
  let choices = [correctType];
  const others = quizTypes.filter(t => t !== correctType);
  while (choices.length < 4) {
    const pick = others[randomInt(0, others.length - 1)];
    if (!choices.includes(pick)) choices.push(pick);
  }
  choices = shuffle(choices);

  const grid = document.getElementById('chordQuizChoices');
  grid.innerHTML = '';
  choices.forEach(type => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = NOTE_NAMES[root] + CHORDS[type].symbol + ' (' + CHORDS[type].name + ')';
    btn.onclick = () => answerChordQuiz(type, btn);
    grid.appendChild(btn);
  });

  document.getElementById('chordQuizFeedback').className = 'feedback';
}

function answerChordQuiz(answer, btnEl) {
  if (!chordQuizState.active || chordQuizState.answered) return;
  chordQuizState.answered = true;

  const fb = document.getElementById('chordQuizFeedback');
  const correct = answer === chordQuizState.answer;

  if (correct) {
    chordQuizState.correct++;
    chordQuizState.streak++;
    streak++;
    totalScore += 15;
    btnEl.classList.add('correct-answer');
    fb.className = 'feedback correct show';
    fb.innerHTML = `<span>‚úÖ</span> Correct! It was ${CHORDS[chordQuizState.answer].name}`;
    if (chordQuizState.streak >= 5) showConfetti();
  } else {
    chordQuizState.wrong++;
    chordQuizState.streak = 0;
    streak = 0;
    btnEl.classList.add('wrong-answer');
    fb.className = 'feedback wrong show';
    fb.innerHTML = `<span>‚ùå</span> Incorrect. It was ${CHORDS[chordQuizState.answer].name}`;
    // Highlight correct answer
    document.querySelectorAll('.choice-btn').forEach(b => {
      if (b.textContent.includes(CHORDS[chordQuizState.answer].name)) {
        b.classList.add('correct-answer');
      }
    });
  }

  const total = chordQuizState.correct + chordQuizState.wrong;
  document.getElementById('chordQuizCorrect').textContent = chordQuizState.correct;
  document.getElementById('chordQuizWrong').textContent = chordQuizState.wrong;
  document.getElementById('chordQuizAccuracy').textContent = total > 0 ? Math.round(chordQuizState.correct / total * 100) + '%' : '-%';

  const streakEl = document.getElementById('chordStreak');
  streakEl.innerHTML = `üî• ${chordQuizState.streak}`;
  streakEl.classList.toggle('hot', chordQuizState.streak >= 3);

  updateStats();
}

function replayChordQuiz() {
  if (chordQuizState.notes) {
    AudioEngine.playChordSound(chordQuizState.notes);
  }
}

// ===== EAR TRAINING =====

// Interval Recognition
function startIntervalQuiz() {
  const direction = document.getElementById('intervalDirection').value;
  const baseNote = randomInt(48, 72);
  const intervalIdx = randomInt(1, 12); // Skip unison
  const interval = INTERVALS[intervalIdx];

  let note1 = baseNote, note2 = baseNote + interval.semitones;
  let dir = direction;
  if (dir === 'random') dir = ['ascending', 'descending', 'harmonic'][randomInt(0, 2)];

  if (dir === 'descending') {
    note2 = baseNote - interval.semitones;
  }

  intervalQuizState.active = true;
  intervalQuizState.answer = intervalIdx;
  intervalQuizState.notes = [note1, note2];
  intervalQuizState.answered = false;

  // Play
  if (dir === 'harmonic') {
    AudioEngine.playChordSound([note1, note2], 1.5);
  } else {
    AudioEngine.playSequence([note1, note2], 0.6, 0.8);
  }

  document.getElementById('intervalReplay').disabled = false;

  // Build choices
  const grid = document.getElementById('intervalChoices');
  grid.innerHTML = '';
  INTERVALS.slice(1).forEach((intv, idx) => {
    const btn = document.createElement('button');
    btn.className = 'interval-btn';
    btn.textContent = intv.name;
    btn.onclick = () => answerIntervalQuiz(idx + 1, btn);
    grid.appendChild(btn);
  });

  document.getElementById('intervalFeedback').className = 'feedback';
}

function answerIntervalQuiz(answer, btnEl) {
  if (!intervalQuizState.active || intervalQuizState.answered) return;
  intervalQuizState.answered = true;

  const fb = document.getElementById('intervalFeedback');
  const correct = answer === intervalQuizState.answer;

  if (correct) {
    intervalQuizState.correct++;
    streak++;
    totalScore += 20;
    btnEl.classList.add('correct-answer');
    fb.className = 'feedback correct show';
    fb.innerHTML = `<span>‚úÖ</span> Correct! ${INTERVALS[intervalQuizState.answer].name}`;
  } else {
    intervalQuizState.wrong++;
    streak = 0;
    btnEl.classList.add('wrong-answer');
    fb.className = 'feedback wrong show';
    fb.innerHTML = `<span>‚ùå</span> It was ${INTERVALS[intervalQuizState.answer].name}, not ${INTERVALS[answer].name}`;
    // Highlight correct
    document.querySelectorAll('#intervalChoices .interval-btn').forEach(b => {
      if (b.textContent === INTERVALS[intervalQuizState.answer].name) {
        b.classList.add('correct-answer');
      }
    });
  }

  const total = intervalQuizState.correct + intervalQuizState.wrong;
  document.getElementById('intervalCorrect').textContent = intervalQuizState.correct;
  document.getElementById('intervalWrong').textContent = intervalQuizState.wrong;
  document.getElementById('intervalAccuracy').textContent = total > 0 ? Math.round(intervalQuizState.correct / total * 100) + '%' : '-%';

  updateStats();
}

function replayInterval() {
  if (intervalQuizState.notes) {
    const dir = document.getElementById('intervalDirection').value;
    if (dir === 'harmonic') {
      AudioEngine.playChordSound(intervalQuizState.notes, 1.5);
    } else {
      AudioEngine.playSequence(intervalQuizState.notes, 0.6, 0.8);
    }
  }
}

// Note Identification
function startNoteQuiz() {
  const midi = randomInt(60, 83); // C4 to B5
  const noteIdx = midi % 12;

  noteQuizState.active = true;
  noteQuizState.answer = noteIdx;
  noteQuizState.midi = midi;
  noteQuizState.answered = false;

  AudioEngine.playNote(midi, 1.5, 0, 0.7);

  document.getElementById('noteReplay').disabled = false;

  const grid = document.getElementById('noteQuizChoices');
  grid.innerHTML = '';
  NOTE_DISPLAY.forEach((name, idx) => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = name;
    btn.onclick = () => answerNoteQuiz(idx, btn);
    grid.appendChild(btn);
  });
  // Rearrange to 4x3 grid
  grid.style.gridTemplateColumns = 'repeat(4, 1fr)';

  document.getElementById('noteFeedback').className = 'feedback';
}

function answerNoteQuiz(answer, btnEl) {
  if (!noteQuizState.active || noteQuizState.answered) return;
  noteQuizState.answered = true;

  const fb = document.getElementById('noteFeedback');
  const correct = answer === noteQuizState.answer;

  if (correct) {
    noteQuizState.correct++;
    streak++;
    totalScore += 15;
    btnEl.classList.add('correct-answer');
    fb.className = 'feedback correct show';
    fb.innerHTML = `<span>‚úÖ</span> Correct! ${noteNameFromMidi(noteQuizState.midi)}`;
  } else {
    noteQuizState.wrong++;
    streak = 0;
    btnEl.classList.add('wrong-answer');
    fb.className = 'feedback wrong show';
    fb.innerHTML = `<span>‚ùå</span> It was ${noteNameFromMidi(noteQuizState.midi)}, not ${NOTE_DISPLAY[answer]}`;
    document.querySelectorAll('#noteQuizChoices .choice-btn').forEach(b => {
      if (b.textContent === NOTE_DISPLAY[noteQuizState.answer]) b.classList.add('correct-answer');
    });
  }

  const total = noteQuizState.correct + noteQuizState.wrong;
  document.getElementById('noteCorrect').textContent = noteQuizState.correct;
  document.getElementById('noteWrong').textContent = noteQuizState.wrong;
  document.getElementById('noteAccuracy').textContent = total > 0 ? Math.round(noteQuizState.correct / total * 100) + '%' : '-%';

  updateStats();
}

function replayNoteQuiz() {
  if (noteQuizState.midi) {
    AudioEngine.playNote(noteQuizState.midi, 1.5, 0, 0.7);
  }
}

// Melodic Dictation
function startMelodyDictation() {
  const len = parseInt(document.getElementById('melodyLength').value);
  const melody = [];
  let prev = randomInt(60, 72);
  melody.push(prev);

  for (let i = 1; i < len; i++) {
    // Generate notes within a reasonable range (mostly stepwise motion)
    const jump = randomInt(-5, 5);
    let next = prev + jump;
    next = Math.max(55, Math.min(79, next));
    melody.push(next);
    prev = next;
  }

  melodyState.active = true;
  melodyState.melody = melody;
  melodyState.input = [];
  melodyState.playing = false;

  // Play melody
  AudioEngine.playSequence(melody, 0.5, 0.6);

  document.getElementById('melodyReplay').disabled = false;
  document.getElementById('melodySubmit').disabled = false;
  document.getElementById('melodyClear').disabled = false;
  document.getElementById('melodyProgress').textContent = `0 / ${len} notes entered`;

  // Build piano for input
  buildPiano('melodyPiano', 2, 4, {
    onClick: (midi) => {
      if (!melodyState.active) return;
      if (melodyState.input.length >= melodyState.melody.length) return;
      melodyState.input.push(midi);
      document.getElementById('melodyProgress').textContent =
        `${melodyState.input.length} / ${melodyState.melody.length} notes entered`;

      if (melodyState.input.length >= melodyState.melody.length) {
        document.getElementById('melodyProgress').textContent += ' ‚Äî Click Check!';
      }
    }
  });

  document.getElementById('melodyFeedback').className = 'feedback';
}

function replayMelody() {
  if (melodyState.melody.length > 0) {
    AudioEngine.playSequence(melodyState.melody, 0.5, 0.6);
  }
}

function clearMelodyInput() {
  melodyState.input = [];
  document.getElementById('melodyProgress').textContent =
    `0 / ${melodyState.melody.length} notes entered`;
}

function submitMelody() {
  if (!melodyState.active) return;
  const fb = document.getElementById('melodyFeedback');

  if (melodyState.input.length !== melodyState.melody.length) {
    fb.className = 'feedback info show';
    fb.innerHTML = `<span>‚ÑπÔ∏è</span> Enter ${melodyState.melody.length} notes before checking.`;
    return;
  }

  let correctCount = 0;
  melodyState.melody.forEach((note, i) => {
    if (melodyState.input[i] % 12 === note % 12) correctCount++;
  });

  const pct = Math.round(correctCount / melodyState.melody.length * 100);

  if (pct === 100) {
    totalScore += 30;
    streak++;
    fb.className = 'feedback correct show';
    fb.innerHTML = `<span>üéâ</span> Perfect! All ${melodyState.melody.length} notes correct!`;
    showConfetti();
  } else if (pct >= 50) {
    totalScore += Math.round(pct / 10);
    fb.className = 'feedback info show';
    fb.innerHTML = `<span>üëç</span> ${correctCount}/${melodyState.melody.length} correct (${pct}%). Good effort!`;
    streak = 0;
  } else {
    streak = 0;
    fb.className = 'feedback wrong show';
    fb.innerHTML = `<span>üòÖ</span> ${correctCount}/${melodyState.melody.length} correct (${pct}%). Keep practicing!`;
  }

  // Show the correct melody
  const correctNotes = melodyState.melody.map(m => noteNameFromMidi(m)).join(' ‚Üí ');
  const yourNotes = melodyState.input.map(m => noteNameFromMidi(m)).join(' ‚Üí ');
  fb.innerHTML += `<br><small style="opacity:0.8">Correct: ${correctNotes}<br>Yours: ${yourNotes}</small>`;

  melodyState.active = false;
  updateStats();
}

// ===== REFERENCE SECTION =====
function buildNoteGrid() {
  const grid = document.getElementById('noteGrid');
  grid.innerHTML = '';
  NOTE_DISPLAY.forEach((name, idx) => {
    const cell = document.createElement('div');
    cell.className = 'note-cell ' + ([1,3,6,8,10].includes(idx) ? 'sharp' : 'natural');
    cell.textContent = name;
    cell.onclick = () => AudioEngine.playNote(60 + idx, 1.2, 0, 0.7);
    grid.appendChild(cell);
  });
}

function buildIntervalTable() {
  const tbody = document.getElementById('intervalTable');
  tbody.innerHTML = '';
  INTERVALS.forEach(intv => {
    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid var(--border-color)';
    tr.style.cursor = 'pointer';
    tr.onmouseenter = () => tr.style.background = 'var(--bg-card-hover)';
    tr.onmouseleave = () => tr.style.background = 'transparent';
    tr.onclick = () => {
      AudioEngine.playSequence([60, 60 + intv.semitones], 0.5, 0.8);
    };
    tr.innerHTML = `
      <td style="padding:8px; color: var(--text-primary);"><strong>${intv.name}</strong> <span style="color:var(--text-muted)">(${intv.short})</span></td>
      <td style="padding:8px; text-align:center; color: var(--accent-secondary);">${intv.semitones}</td>
      <td style="padding:8px; color: var(--text-secondary);">C ‚Üí ${NOTE_DISPLAY[(intv.semitones) % 12]}</td>
    `;
    tbody.appendChild(tr);
  });
}

function buildCircleOfFifths() {
  const container = document.getElementById('circleOfFifths');
  container.innerHTML = '';
  const cx = 160, cy = 160, r = 130;

  COF_NOTES.forEach((note, i) => {
    const angle = (i * 30 - 90) * Math.PI / 180;
    const x = cx + r * Math.cos(angle) - 22;
    const y = cy + r * Math.sin(angle) - 22;

    const el = document.createElement('div');
    el.className = 'cof-note';
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.textContent = note.split('/')[0];
    el.onclick = () => {
      document.querySelectorAll('.cof-note').forEach(n => n.classList.remove('active'));
      el.classList.add('active');

      const rootMidi = COF_MIDI[i];
      const scaleNotes = getScaleNotes(rootMidi, 'major');
      scaleNotes.push(scaleNotes[0] + 12);
      AudioEngine.playSequence(scaleNotes, 0.25, 0.4);

      // Show info
      const relMinor = NOTE_DISPLAY[(rootMidi + 9) % 12];
      document.getElementById('cofInfo').innerHTML =
        `<strong>${note} Major</strong> ‚Äî Relative minor: <strong>${relMinor} minor</strong> ‚Äî Notes: ${SCALES.major.intervals.map(intv => NOTE_DISPLAY[(rootMidi + intv) % 12]).join(', ')}`;
    };

    container.appendChild(el);
  });

  // Center text
  const center = document.createElement('div');
  center.style.cssText = `position:absolute;left:${cx-35}px;top:${cy-20}px;width:70px;text-align:center;font-size:12px;color:var(--text-muted);`;
  center.innerHTML = 'Circle<br>of 5ths';
  container.appendChild(center);
}

function buildProgressions() {
  const grid = document.getElementById('progressionsGrid');
  const progressions = [
    { name: 'Pop/Rock', numerals: 'I ‚Äì V ‚Äì vi ‚Äì IV', chords: 'C ‚Äì G ‚Äì Am ‚Äì F', midiChords: [[60,64,67],[67,71,74],[69,72,76],[65,69,72]] },
    { name: '12-Bar Blues', numerals: 'I ‚Äì I ‚Äì I ‚Äì I ‚Äì IV ‚Äì IV ‚Äì I ‚Äì I ‚Äì V ‚Äì IV ‚Äì I ‚Äì V', chords: 'C7 ‚Äì F7 ‚Äì C7 ‚Äì G7', midiChords: [[60,64,67,70],[65,69,72,75],[60,64,67,70],[67,71,74,77]] },
    { name: 'Jazz ii-V-I', numerals: 'ii7 ‚Äì V7 ‚Äì Imaj7', chords: 'Dm7 ‚Äì G7 ‚Äì Cmaj7', midiChords: [[62,65,69,72],[67,71,74,77],[60,64,67,71]] },
    { name: 'Canon', numerals: 'I ‚Äì V ‚Äì vi ‚Äì iii ‚Äì IV ‚Äì I ‚Äì IV ‚Äì V', chords: 'C ‚Äì G ‚Äì Am ‚Äì Em ‚Äì F ‚Äì C ‚Äì F ‚Äì G', midiChords: [[60,64,67],[67,71,74],[69,72,76],[64,67,71],[65,69,72],[60,64,67],[65,69,72],[67,71,74]] },
    { name: 'Andalusian', numerals: 'i ‚Äì VII ‚Äì VI ‚Äì V', chords: 'Am ‚Äì G ‚Äì F ‚Äì E', midiChords: [[69,72,76],[67,71,74],[65,69,72],[64,68,71]] },
    { name: '50s Doo-Wop', numerals: 'I ‚Äì vi ‚Äì IV ‚Äì V', chords: 'C ‚Äì Am ‚Äì F ‚Äì G', midiChords: [[60,64,67],[69,72,76],[65,69,72],[67,71,74]] },
  ];

  grid.innerHTML = '';
  progressions.forEach(p => {
    const card = document.createElement('div');
    card.style.cssText = 'background:var(--bg-primary);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;border:1px solid var(--border-color);';
    card.onmouseenter = () => { card.style.borderColor = 'var(--accent-primary)'; card.style.transform = 'translateY(-2px)'; };
    card.onmouseleave = () => { card.style.borderColor = 'var(--border-color)'; card.style.transform = 'translateY(0)'; };
    card.innerHTML = `
      <div style="font-weight:600;font-size:14px;margin-bottom:6px;color:var(--accent-secondary);">${p.name}</div>
      <div style="font-size:13px;color:var(--text-primary);margin-bottom:4px;">${p.numerals}</div>
      <div style="font-size:12px;color:var(--text-muted);">${p.chords}</div>
      <div style="margin-top:8px;font-size:11px;color:var(--accent-pink);">‚ñ∂ Click to play</div>
    `;
    card.onclick = () => {
      p.midiChords.forEach((ch, i) => {
        setTimeout(() => AudioEngine.playChordSound(ch, 0.8), i * 600);
      });
    };
    grid.appendChild(card);
  });
}

// ===== WAVEFORM VISUALIZATION =====
function startWaveformVisualization() {
  const canvas = document.getElementById('waveformCanvas');
  const canvasCtx = canvas.getContext('2d');

  function draw() {
    requestAnimationFrame(draw);

    const analyser = AudioEngine.getAnalyser();
    if (!analyser) return;

    canvas.width = canvas.offsetWidth * 2;
    canvas.height = canvas.offsetHeight * 2;
    canvasCtx.scale(2, 2);

    const w = canvas.offsetWidth;
    const h = canvas.offsetHeight;

    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    analyser.getByteTimeDomainData(dataArray);

    canvasCtx.clearRect(0, 0, w, h);

    // Draw waveform
    const gradient = canvasCtx.createLinearGradient(0, 0, w, 0);
    gradient.addColorStop(0, '#7c3aed');
    gradient.addColorStop(0.5, '#ec4899');
    gradient.addColorStop(1, '#06b6d4');

    canvasCtx.lineWidth = 2;
    canvasCtx.strokeStyle = gradient;
    canvasCtx.beginPath();

    const sliceWidth = w / bufferLength;
    let x = 0;

    for (let i = 0; i < bufferLength; i++) {
      const v = dataArray[i] / 128.0;
      const y = v * h / 2;

      if (i === 0) canvasCtx.moveTo(x, y);
      else canvasCtx.lineTo(x, y);

      x += sliceWidth;
    }

    canvasCtx.lineTo(w, h / 2);
    canvasCtx.stroke();

    // Draw center line
    canvasCtx.strokeStyle = 'rgba(255,255,255,0.05)';
    canvasCtx.lineWidth = 1;
    canvasCtx.beginPath();
    canvasCtx.moveTo(0, h / 2);
    canvasCtx.lineTo(w, h / 2);
    canvasCtx.stroke();
  }

  draw();
}

// ===== BACKGROUND PARTICLES =====
function createBackgroundNotes() {
  const container = document.getElementById('bgParticles');
  const symbols = ['‚ô©', '‚ô™', '‚ô´', '‚ô¨', 'ùÑû', 'ùÑ¢', '‚ô≠', '‚ôØ', 'ùÑ™'];

  for (let i = 0; i < 25; i++) {
    const note = document.createElement('div');
    note.className = 'note';
    note.textContent = symbols[Math.floor(Math.random() * symbols.length)];
    note.style.left = Math.random() * 100 + '%';
    note.style.fontSize = (Math.random() * 24 + 14) + 'px';
    note.style.animationDuration = (Math.random() * 15 + 10) + 's';
    note.style.animationDelay = (Math.random() * 15) + 's';
    container.appendChild(note);
  }
}

// ===== VOLUME CONTROL =====
document.getElementById('volumeSlider').addEventListener('input', (e) => {
  AudioEngine.setVolume(e.target.value / 100);
});

// ===== INIT =====
function init() {
  createBackgroundNotes();
  rebuildPiano();
  updateScale();
  updateChord();
  buildNoteGrid();
  buildIntervalTable();
  buildCircleOfFifths();
  buildProgressions();
  startWaveformVisualization();

  // Build melody piano
  buildPiano('melodyPiano', 2, 4);
}

init();
</script>
</body>
</html>
