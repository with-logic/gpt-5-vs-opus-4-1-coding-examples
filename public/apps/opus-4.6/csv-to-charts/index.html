<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Visualization Playground</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg-primary: #0f1117;
    --bg-secondary: #1a1d27;
    --bg-tertiary: #242833;
    --bg-card: #1e2230;
    --border-color: #2d3348;
    --border-hover: #4a5280;
    --text-primary: #e8eaf0;
    --text-secondary: #9ca3bf;
    --text-muted: #6b7294;
    --accent: #6366f1;
    --accent-hover: #818cf8;
    --accent-glow: rgba(99, 102, 241, 0.25);
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --radius: 12px;
    --radius-sm: 8px;
    --radius-xs: 6px;
    --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.4);
    --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

  /* Header */
  .header {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
    border-bottom: 1px solid var(--border-color);
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(12px);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent), #a855f7);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    box-shadow: 0 0 20px var(--accent-glow);
  }

  .logo-text h1 {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.3px;
    background: linear-gradient(135deg, #e8eaf0, #9ca3bf);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .logo-text span {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 400;
  }

  .header-actions {
    display: flex;
    gap: 8px;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: var(--radius-xs);
    font-size: 13px;
    font-weight: 500;
    font-family: inherit;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--transition);
    white-space: nowrap;
  }

  .btn:hover {
    border-color: var(--border-hover);
    background: var(--bg-card);
    transform: translateY(-1px);
  }

  .btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .btn-primary:hover {
    background: var(--accent-hover);
    border-color: var(--accent-hover);
    box-shadow: 0 0 20px var(--accent-glow);
  }

  .btn-sm {
    padding: 6px 12px;
    font-size: 12px;
  }

  .btn-icon {
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-xs);
  }

  .btn svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  /* Layout */
  .app-layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    min-height: calc(100vh - 73px);
  }

  /* Sidebar */
  .sidebar {
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .panel {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .panel-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255,255,255,0.02);
  }

  .panel-header h3 {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-header h3 svg {
    width: 16px;
    height: 16px;
    color: var(--accent);
  }

  .panel-body {
    padding: 16px;
  }

  /* Upload Area */
  .upload-zone {
    border: 2px dashed var(--border-color);
    border-radius: var(--radius);
    padding: 32px 20px;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition);
    background: rgba(99, 102, 241, 0.03);
    position: relative;
  }

  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--accent);
    background: rgba(99, 102, 241, 0.08);
    box-shadow: 0 0 30px rgba(99, 102, 241, 0.1);
  }

  .upload-zone svg {
    width: 40px;
    height: 40px;
    color: var(--accent);
    margin-bottom: 12px;
    opacity: 0.8;
  }

  .upload-zone h4 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-primary);
  }

  .upload-zone p {
    font-size: 12px;
    color: var(--text-muted);
  }

  .upload-zone input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .file-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: rgba(34, 197, 94, 0.08);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: var(--radius-sm);
    margin-top: 12px;
  }

  .file-info svg { width: 20px; height: 20px; color: var(--success); flex-shrink: 0; }
  .file-info .file-details { flex: 1; min-width: 0; }
  .file-info .file-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .file-info .file-meta { font-size: 11px; color: var(--text-muted); }

  /* Form Controls */
  .form-group {
    margin-bottom: 14px;
  }

  .form-group:last-child { margin-bottom: 0; }

  .form-group label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 6px;
  }

  .form-select, .form-input {
    width: 100%;
    padding: 8px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xs);
    color: var(--text-primary);
    font-size: 13px;
    font-family: inherit;
    transition: border-color var(--transition);
    outline: none;
  }

  .form-select:focus, .form-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  .form-select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239ca3bf' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 30px; }

  /* Chart Type Grid */
  .chart-type-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }

  .chart-type-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 12px 8px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition);
    color: var(--text-secondary);
    font-family: inherit;
  }

  .chart-type-btn:hover {
    border-color: var(--border-hover);
    color: var(--text-primary);
    transform: translateY(-1px);
  }

  .chart-type-btn.active {
    border-color: var(--accent);
    background: rgba(99, 102, 241, 0.1);
    color: var(--accent);
    box-shadow: 0 0 15px rgba(99, 102, 241, 0.15);
  }

  .chart-type-btn svg { width: 22px; height: 22px; }
  .chart-type-btn span { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

  /* Color Palette */
  .color-palette {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .palette-option {
    display: flex;
    gap: 3px;
    padding: 4px 6px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-xs);
    cursor: pointer;
    transition: all var(--transition);
    background: var(--bg-primary);
  }

  .palette-option:hover { border-color: var(--border-hover); }

  .palette-option.active {
    border-color: var(--accent);
    box-shadow: 0 0 10px var(--accent-glow);
  }

  .palette-swatch {
    width: 14px;
    height: 14px;
    border-radius: 3px;
  }

  /* Custom Colors */
  .custom-colors {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
  }

  .color-input-wrap {
    position: relative;
    width: 32px;
    height: 32px;
    border-radius: var(--radius-xs);
    overflow: hidden;
    border: 2px solid var(--border-color);
    cursor: pointer;
    transition: border-color var(--transition);
  }

  .color-input-wrap:hover { border-color: var(--border-hover); }

  .color-input-wrap input[type="color"] {
    position: absolute;
    inset: -4px;
    width: calc(100% + 8px);
    height: calc(100% + 8px);
    cursor: pointer;
    border: none;
    padding: 0;
  }

  /* Toggle Switch */
  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .toggle-row:last-child { margin-bottom: 0; }

  .toggle-row label {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 0;
  }

  .toggle {
    position: relative;
    width: 38px;
    height: 20px;
    cursor: pointer;
  }

  .toggle input { display: none; }

  .toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    transition: all var(--transition);
  }

  .toggle-slider::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 14px;
    height: 14px;
    background: var(--text-muted);
    border-radius: 50%;
    transition: all var(--transition);
  }

  .toggle input:checked + .toggle-slider {
    background: var(--accent);
    border-color: var(--accent);
  }

  .toggle input:checked + .toggle-slider::after {
    transform: translateX(18px);
    background: white;
  }

  /* Main Content */
  .main-content {
    padding: 24px;
    overflow-y: auto;
    background: var(--bg-primary);
  }

  /* Welcome State */
  .welcome-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    text-align: center;
    padding: 40px;
  }

  .welcome-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(168, 85, 247, 0.15));
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
    box-shadow: 0 0 40px rgba(99, 102, 241, 0.2);
  }

  .welcome-icon svg { width: 36px; height: 36px; color: var(--accent); }

  .welcome-state h2 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #e8eaf0, #9ca3bf);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .welcome-state p {
    color: var(--text-muted);
    font-size: 14px;
    max-width: 400px;
    line-height: 1.6;
    margin-bottom: 24px;
  }

  .sample-data-btns {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }

  /* Chart Container */
  .chart-area {
    display: none;
  }

  .chart-area.visible {
    display: block;
  }

  .chart-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 8px;
  }

  .chart-toolbar-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .chart-title-input {
    font-size: 20px;
    font-weight: 700;
    background: transparent;
    border: 1px solid transparent;
    border-radius: var(--radius-xs);
    padding: 4px 8px;
    color: var(--text-primary);
    font-family: inherit;
    outline: none;
    transition: border-color var(--transition);
    min-width: 200px;
  }

  .chart-title-input:hover, .chart-title-input:focus {
    border-color: var(--border-color);
  }

  .chart-toolbar-right {
    display: flex;
    gap: 8px;
  }

  .chart-wrapper {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 24px;
    position: relative;
    box-shadow: var(--shadow);
    min-height: 400px;
  }

  .chart-canvas-container {
    position: relative;
    width: 100%;
    height: 450px;
  }

  .chart-canvas-container canvas {
    width: 100% !important;
    height: 100% !important;
  }

  /* Data Preview */
  .data-preview {
    margin-top: 20px;
  }

  .data-table-wrapper {
    overflow-x: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    max-height: 300px;
    overflow-y: auto;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }

  .data-table th {
    position: sticky;
    top: 0;
    background: var(--bg-tertiary);
    padding: 10px 14px;
    text-align: left;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-color);
    white-space: nowrap;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 1;
  }

  .data-table td {
    padding: 8px 14px;
    border-bottom: 1px solid rgba(45, 51, 72, 0.5);
    color: var(--text-primary);
    white-space: nowrap;
  }

  .data-table tr:hover td {
    background: rgba(99, 102, 241, 0.04);
  }

  .data-table tr:last-child td { border-bottom: none; }

  /* Axis selector */
  .axis-config {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* Notification */
  .notification {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 12px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    z-index: 1000;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .notification.show {
    transform: translateY(0);
    opacity: 1;
  }

  .notification.success { border-left: 3px solid var(--success); }
  .notification.error { border-left: 3px solid var(--danger); }

  /* Responsive */
  @media (max-width: 900px) {
    .app-layout {
      grid-template-columns: 1fr;
    }
    .sidebar {
      border-right: none;
      border-bottom: 1px solid var(--border-color);
      max-height: 50vh;
    }
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .fade-in { animation: fadeIn 0.3s ease-out; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Multiple charts layout */
  .charts-grid {
    display: grid;
    gap: 20px;
  }

  .charts-grid.grid-1 { grid-template-columns: 1fr; }
  .charts-grid.grid-2 { grid-template-columns: repeat(2, 1fr); }
  .charts-grid.grid-2 .chart-wrapper { min-height: 350px; }
  .charts-grid.grid-2 .chart-canvas-container { height: 320px; }

  /* Badge */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    font-size: 10px;
    font-weight: 600;
    border-radius: 10px;
    background: rgba(99, 102, 241, 0.15);
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .column-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 6px;
  }

  .column-chip {
    padding: 3px 8px;
    font-size: 11px;
    border-radius: 4px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition);
    font-family: inherit;
  }

  .column-chip:hover { border-color: var(--border-hover); }
  .column-chip.active { border-color: var(--accent); background: rgba(99, 102, 241, 0.1); color: var(--accent); }

  /* Multi-select Y columns */
  .y-columns-select {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  /* Download format selector */
  .export-dropdown {
    position: relative;
  }

  .export-menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 4px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-lg);
    z-index: 50;
    min-width: 160px;
    display: none;
    overflow: hidden;
  }

  .export-menu.show { display: block; }

  .export-menu button {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 10px 14px;
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 13px;
    font-family: inherit;
    cursor: pointer;
    transition: background var(--transition);
  }

  .export-menu button:hover { background: rgba(99, 102, 241, 0.08); }
  .export-menu button svg { width: 16px; height: 16px; color: var(--text-muted); }

  /* Resize handle */
  .chart-wrapper .resize-hint {
    position: absolute;
    bottom: 4px;
    right: 4px;
    color: var(--text-muted);
    opacity: 0.3;
    font-size: 12px;
  }
</style>
</head>
<body>

<header class="header">
  <div class="logo">
    <div class="logo-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="20" x2="18" y2="10"></line>
        <line x1="12" y1="20" x2="12" y2="4"></line>
        <line x1="6" y1="20" x2="6" y2="14"></line>
      </svg>
    </div>
    <div class="logo-text">
      <h1>Data Visualization Playground</h1>
      <span>Upload CSV &middot; Generate Charts &middot; Export</span>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn btn-sm" onclick="loadSampleData('sales')" title="Load sample data">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
      Sample Data
    </button>
    <button class="btn btn-sm" onclick="addChart()" title="Add another chart" id="addChartBtn" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      Add Chart
    </button>
  </div>
</header>

<div class="app-layout">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <!-- Upload Panel -->
    <div class="panel">
      <div class="panel-header">
        <h3>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          Data Source
        </h3>
        <span class="badge" id="rowCountBadge" style="display:none">0 rows</span>
      </div>
      <div class="panel-body">
        <div class="upload-zone" id="uploadZone">
          <input type="file" accept=".csv,.tsv,.txt" id="fileInput">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          <h4>Drop CSV file here</h4>
          <p>or click to browse files</p>
        </div>
        <div id="fileInfo" style="display:none" class="file-info">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
          <div class="file-details">
            <div class="file-name" id="fileName"></div>
            <div class="file-meta" id="fileMeta"></div>
          </div>
          <button class="btn btn-icon btn-sm" onclick="clearData()" title="Remove file">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Chart Config Panel -->
    <div class="panel" id="configPanel" style="display:none">
      <div class="panel-header">
        <h3>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
          Chart Configuration
        </h3>
      </div>
      <div class="panel-body">
        <!-- Chart Type -->
        <div class="form-group">
          <label>Chart Type</label>
          <div class="chart-type-grid" id="chartTypeGrid">
            <button class="chart-type-btn active" data-type="bar" title="Bar Chart">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="12" width="4" height="9" rx="1"/><rect x="10" y="7" width="4" height="14" rx="1"/><rect x="17" y="3" width="4" height="18" rx="1"/></svg>
              <span>Bar</span>
            </button>
            <button class="chart-type-btn" data-type="line" title="Line Chart">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 17 8 11 13 15 21 5"/><circle cx="8" cy="11" r="1.5" fill="currentColor"/><circle cx="13" cy="15" r="1.5" fill="currentColor"/><circle cx="21" cy="5" r="1.5" fill="currentColor"/></svg>
              <span>Line</span>
            </button>
            <button class="chart-type-btn" data-type="pie" title="Pie Chart">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10h-10z"/><path d="M12 2a10 10 0 0 1 10 10"/><line x1="12" y1="2" x2="12" y2="12"/><line x1="12" y1="12" x2="22" y2="12"/></svg>
              <span>Pie</span>
            </button>
            <button class="chart-type-btn" data-type="doughnut" title="Doughnut Chart">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="4"/></svg>
              <span>Doughnut</span>
            </button>
            <button class="chart-type-btn" data-type="radar" title="Radar Chart">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 20 8 18 18 6 18 4 8"/><polygon points="12 6 16 10 15 16 9 16 8 10" opacity="0.5"/></svg>
              <span>Radar</span>
            </button>
            <button class="chart-type-btn" data-type="polarArea" title="Polar Area">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><line x1="12" y1="3" x2="12" y2="12"/><line x1="12" y1="12" x2="20" y2="8"/><line x1="12" y1="12" x2="20" y2="16"/><line x1="12" y1="12" x2="4" y2="16"/><line x1="12" y1="12" x2="4" y2="8"/></svg>
              <span>Polar</span>
            </button>
            <button class="chart-type-btn" data-type="scatter" title="Scatter Plot">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="7" cy="15" r="2" fill="currentColor"/><circle cx="11" cy="9" r="2" fill="currentColor"/><circle cx="16" cy="13" r="2" fill="currentColor"/><circle cx="19" cy="6" r="2" fill="currentColor"/></svg>
              <span>Scatter</span>
            </button>
            <button class="chart-type-btn" data-type="bubble" title="Bubble Chart">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="14" r="4"/><circle cx="16" cy="8" r="3"/><circle cx="17" cy="17" r="2.5"/></svg>
              <span>Bubble</span>
            </button>
            <button class="chart-type-btn" data-type="horizontalBar" title="Horizontal Bar">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="4" rx="1"/><rect x="3" y="10" width="12" height="4" rx="1"/><rect x="3" y="17" width="15" height="4" rx="1"/></svg>
              <span>H-Bar</span>
            </button>
          </div>
        </div>

        <!-- Axis Config -->
        <div class="axis-config">
          <div class="form-group">
            <label>X-Axis (Labels)</label>
            <select class="form-select" id="xAxisSelect" onchange="updateChart()"></select>
          </div>
          <div class="form-group">
            <label>Y-Axis (Values)</label>
            <div id="yAxisChips" class="y-columns-select"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Appearance Panel -->
    <div class="panel" id="appearancePanel" style="display:none">
      <div class="panel-header">
        <h3>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>
          Appearance
        </h3>
      </div>
      <div class="panel-body">
        <div class="form-group">
          <label>Color Palette</label>
          <div class="color-palette" id="paletteSelector"></div>
        </div>
        <div class="form-group" style="margin-top: 12px;">
          <label>Custom Colors (click to change)</label>
          <div class="custom-colors" id="customColors"></div>
        </div>
        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 14px 0;">
        <div class="form-group">
          <label>Background</label>
          <select class="form-select" id="bgSelect" onchange="updateChart()">
            <option value="transparent">Transparent (dark)</option>
            <option value="#1e2230">Card Dark</option>
            <option value="#ffffff">White</option>
            <option value="#f8fafc">Light Gray</option>
          </select>
        </div>
        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 14px 0;">
        <div class="toggle-row">
          <label>Show Legend</label>
          <label class="toggle">
            <input type="checkbox" id="showLegend" checked onchange="updateChart()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <label>Show Grid Lines</label>
          <label class="toggle">
            <input type="checkbox" id="showGrid" checked onchange="updateChart()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <label>Show Data Labels</label>
          <label class="toggle">
            <input type="checkbox" id="showDataLabels" onchange="updateChart()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <label>Smooth Lines</label>
          <label class="toggle">
            <input type="checkbox" id="smoothLines" checked onchange="updateChart()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <label>Fill Area (Line)</label>
          <label class="toggle">
            <input type="checkbox" id="fillArea" onchange="updateChart()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="form-group" style="margin-top:10px">
          <label>Border Radius (Bar)</label>
          <input type="range" min="0" max="20" value="6" id="barRadius" class="form-input" style="padding:4px;" oninput="updateChart()">
        </div>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main-content" id="mainContent">
    <!-- Welcome State -->
    <div class="welcome-state" id="welcomeState">
      <div class="welcome-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="20" x2="18" y2="10"></line>
          <line x1="12" y1="20" x2="12" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
      </div>
      <h2>Welcome to Data Visualization Playground</h2>
      <p>Upload a CSV file to start creating beautiful, interactive charts. Or try one of our sample datasets to explore the features.</p>
      <div class="sample-data-btns">
        <button class="btn btn-primary" onclick="loadSampleData('sales')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
          Sales Data
        </button>
        <button class="btn" onclick="loadSampleData('population')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          Population
        </button>
        <button class="btn" onclick="loadSampleData('weather')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>
          Weather
        </button>
        <button class="btn" onclick="loadSampleData('stocks')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline></svg>
          Stock Prices
        </button>
      </div>
    </div>

    <!-- Chart Area -->
    <div class="chart-area" id="chartArea">
      <div class="chart-toolbar">
        <div class="chart-toolbar-left">
          <input type="text" class="chart-title-input" id="chartTitle" value="My Chart" placeholder="Chart title...">
        </div>
        <div class="chart-toolbar-right">
          <div class="export-dropdown" id="exportDropdown">
            <button class="btn btn-primary" onclick="toggleExportMenu()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
              Save Image
            </button>
            <div class="export-menu" id="exportMenu">
              <button onclick="exportChart('png')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                PNG (High Quality)
              </button>
              <button onclick="exportChart('jpeg')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                JPEG
              </button>
              <button onclick="exportChart('svg')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                SVG Vector
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="charts-grid grid-1" id="chartsGrid">
        <div class="chart-wrapper fade-in">
          <div class="chart-canvas-container">
            <canvas id="mainChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Data Table Preview -->
      <div class="data-preview" id="dataPreview" style="display:none">
        <div class="panel">
          <div class="panel-header" style="cursor:pointer" onclick="toggleDataTable()">
            <h3>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line></svg>
              Data Preview
            </h3>
            <svg id="tableToggleIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;transition:transform 0.2s"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
          <div id="dataTableBody" style="display:none">
            <div class="data-table-wrapper" id="dataTableWrapper"></div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="notification" id="notification"></div>

<script>
// ============ STATE ============
let csvData = { headers: [], rows: [], rawText: '' };
let currentChart = null;
let selectedChartType = 'bar';
let selectedYColumns = [];
let activeColors = [];
let dataTableVisible = false;

// ============ COLOR PALETTES ============
const palettes = {
  'Vivid': ['#6366f1','#f43f5e','#22c55e','#f59e0b','#06b6d4','#a855f7','#ec4899','#14b8a6','#f97316','#8b5cf6'],
  'Ocean': ['#0ea5e9','#06b6d4','#14b8a6','#10b981','#22c55e','#84cc16','#3b82f6','#6366f1','#8b5cf6','#a855f7'],
  'Sunset': ['#f43f5e','#f97316','#f59e0b','#eab308','#ec4899','#a855f7','#e11d48','#ea580c','#d97706','#be185d'],
  'Pastel': ['#93c5fd','#f9a8d4','#86efac','#fcd34d','#c4b5fd','#fdba74','#67e8f9','#fca5a5','#a5f3fc','#d8b4fe'],
  'Earth': ['#92400e','#78350f','#365314','#1e3a5f','#581c87','#831843','#b45309','#166534','#1e40af','#6b21a8'],
  'Neon': ['#00ff87','#ff006e','#00d4ff','#ffbe0b','#fb5607','#8338ec','#3a86ff','#ff006e','#06d6a0','#ff9f1c'],
  'Monochrome': ['#1e293b','#334155','#475569','#64748b','#94a3b8','#cbd5e1','#e2e8f0','#f1f5f9','#3b4252','#4c566a'],
};

let currentPalette = 'Vivid';

// ============ SAMPLE DATA ============
const sampleDatasets = {
  sales: {
    title: 'Monthly Sales Performance',
    csv: `Month,Revenue,Expenses,Profit,Customers
Jan,48500,32000,16500,245
Feb,52300,33500,18800,268
Mar,61200,35000,26200,312
Apr,55800,34200,21600,289
May,67400,37800,29600,354
Jun,72100,39500,32600,387
Jul,68900,38200,30700,367
Aug,75600,41000,34600,412
Sep,71300,39800,31500,395
Oct,79800,42500,37300,438
Nov,85200,44000,41200,467
Dec,92400,46500,45900,512`
  },
  population: {
    title: 'World Population by Region (Millions)',
    csv: `Region,2000,2010,2020,2025
Asia,3714,4170,4641,4800
Africa,811,1031,1341,1500
Europe,726,735,748,745
Latin America,521,590,654,680
North America,313,344,369,385
Oceania,31,36,43,46`
  },
  weather: {
    title: 'Average Monthly Temperature (°C)',
    csv: `Month,New York,London,Tokyo,Sydney,Dubai
Jan,-1,5,6,26,20
Feb,0,5,7,26,21
Mar,5,8,10,24,24
Apr,11,11,15,22,28
May,17,14,20,19,33
Jun,22,18,23,16,35
Jul,25,20,27,16,38
Aug,24,20,28,17,38
Sep,20,17,24,19,35
Oct,14,13,19,22,31
Nov,8,9,13,24,26
Dec,2,6,8,25,22`
  },
  stocks: {
    title: 'Tech Stock Prices (USD)',
    csv: `Quarter,Apple,Google,Microsoft,Amazon,Tesla
Q1 2023,150,105,280,98,190
Q2 2023,185,120,335,128,260
Q3 2023,175,132,330,138,245
Q4 2023,192,140,375,152,250
Q1 2024,170,142,415,178,175
Q2 2024,195,178,430,186,180
Q3 2024,225,165,415,178,245
Q4 2024,230,175,420,190,340`
  }
};

// ============ INITIALIZATION ============
document.addEventListener('DOMContentLoaded', () => {
  initPaletteSelector();
  initChartTypeButtons();
  initDragDrop();
  initCustomColors();
  document.addEventListener('click', (e) => {
    if (!document.getElementById('exportDropdown').contains(e.target)) {
      document.getElementById('exportMenu').classList.remove('show');
    }
  });
});

// ============ FILE HANDLING ============
function initDragDrop() {
  const zone = document.getElementById('uploadZone');
  const input = document.getElementById('fileInput');

  ['dragenter', 'dragover'].forEach(evt => {
    zone.addEventListener(evt, (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
  });
  ['dragleave', 'drop'].forEach(evt => {
    zone.addEventListener(evt, (e) => { e.preventDefault(); zone.classList.remove('drag-over'); });
  });

  zone.addEventListener('drop', (e) => {
    const files = e.dataTransfer.files;
    if (files.length) handleFile(files[0]);
  });

  input.addEventListener('change', (e) => {
    if (e.target.files.length) handleFile(e.target.files[0]);
  });
}

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    parseCSV(e.target.result);
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileMeta').textContent = `${formatBytes(file.size)} · ${csvData.rows.length} rows · ${csvData.headers.length} columns`;
    document.getElementById('fileInfo').style.display = 'flex';
    document.getElementById('chartTitle').value = file.name.replace(/\.[^/.]+$/, '').replace(/[-_]/g, ' ');
    showNotification('File loaded successfully!', 'success');
  };
  reader.readAsText(file);
}

function parseCSV(text) {
  csvData.rawText = text;
  const lines = text.trim().split('\n').map(l => l.trim()).filter(l => l);
  if (lines.length < 2) { showNotification('CSV must have a header and at least one data row.', 'error'); return; }

  // Detect delimiter
  const firstLine = lines[0];
  const delimiters = [',', '\t', ';', '|'];
  let delimiter = ',';
  let maxCount = 0;
  delimiters.forEach(d => {
    const count = (firstLine.match(new RegExp(d === '|' ? '\\|' : (d === '\t' ? '\t' : d), 'g')) || []).length;
    if (count > maxCount) { maxCount = count; delimiter = d; }
  });

  // Parse with quote handling
  function parseLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
          current += '"'; i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === delimiter && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += ch;
      }
    }
    result.push(current.trim());
    return result;
  }

  csvData.headers = parseLine(lines[0]);
  csvData.rows = [];
  for (let i = 1; i < lines.length; i++) {
    const parsed = parseLine(lines[i]);
    if (parsed.length === csvData.headers.length) {
      csvData.rows.push(parsed);
    }
  }

  setupControls();
  showChartArea();
  updateChart();
}

function loadSampleData(key) {
  const sample = sampleDatasets[key];
  parseCSV(sample.csv);
  document.getElementById('chartTitle').value = sample.title;
  document.getElementById('fileName').textContent = key + '_data.csv';
  document.getElementById('fileMeta').textContent = `Sample · ${csvData.rows.length} rows · ${csvData.headers.length} columns`;
  document.getElementById('fileInfo').style.display = 'flex';
  showNotification(`Loaded "${sample.title}" sample data`, 'success');
}

function clearData() {
  csvData = { headers: [], rows: [], rawText: '' };
  if (currentChart) { currentChart.destroy(); currentChart = null; }
  document.getElementById('fileInfo').style.display = 'none';
  document.getElementById('configPanel').style.display = 'none';
  document.getElementById('appearancePanel').style.display = 'none';
  document.getElementById('chartArea').classList.remove('visible');
  document.getElementById('welcomeState').style.display = 'flex';
  document.getElementById('addChartBtn').style.display = 'none';
  document.getElementById('rowCountBadge').style.display = 'none';
  document.getElementById('dataPreview').style.display = 'none';
  document.getElementById('fileInput').value = '';
}

// ============ CONTROLS ============
function setupControls() {
  const xSelect = document.getElementById('xAxisSelect');
  const yChips = document.getElementById('yAxisChips');

  // Determine numeric columns
  const numericCols = [];
  const allCols = csvData.headers;
  allCols.forEach((h, i) => {
    const isNumeric = csvData.rows.every(r => !isNaN(parseFloat(r[i])) && r[i].trim() !== '');
    if (isNumeric) numericCols.push(i);
  });

  // X axis: default to first non-numeric or first column
  xSelect.innerHTML = '';
  allCols.forEach((h, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = h;
    if (numericCols.length > 0 && !numericCols.includes(i)) opt.selected = true;
    xSelect.appendChild(opt);
  });
  if (xSelect.selectedIndex === -1) xSelect.selectedIndex = 0;

  // Y axis chips: select all numeric columns
  yChips.innerHTML = '';
  selectedYColumns = [];
  allCols.forEach((h, i) => {
    const chip = document.createElement('button');
    chip.className = 'column-chip' + (numericCols.includes(i) ? ' active' : '');
    chip.textContent = h;
    chip.dataset.index = i;
    chip.onclick = () => {
      chip.classList.toggle('active');
      updateSelectedYColumns();
      updateChart();
    };
    yChips.appendChild(chip);
    if (numericCols.includes(i)) selectedYColumns.push(i);
  });

  // Update badge
  document.getElementById('rowCountBadge').textContent = csvData.rows.length + ' rows';
  document.getElementById('rowCountBadge').style.display = 'inline-flex';

  // Update custom colors
  initCustomColors();
}

function updateSelectedYColumns() {
  selectedYColumns = [];
  document.querySelectorAll('#yAxisChips .column-chip.active').forEach(chip => {
    selectedYColumns.push(parseInt(chip.dataset.index));
  });
}

function showChartArea() {
  document.getElementById('welcomeState').style.display = 'none';
  document.getElementById('chartArea').classList.add('visible');
  document.getElementById('configPanel').style.display = 'block';
  document.getElementById('appearancePanel').style.display = 'block';
  document.getElementById('addChartBtn').style.display = 'inline-flex';
  document.getElementById('dataPreview').style.display = 'block';
  renderDataTable();
}

// ============ CHART TYPE BUTTONS ============
function initChartTypeButtons() {
  document.querySelectorAll('.chart-type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedChartType = btn.dataset.type;
      updateChart();
    });
  });
}

// ============ PALETTE SELECTOR ============
function initPaletteSelector() {
  const container = document.getElementById('paletteSelector');
  container.innerHTML = '';
  Object.entries(palettes).forEach(([name, colors]) => {
    const div = document.createElement('div');
    div.className = 'palette-option' + (name === currentPalette ? ' active' : '');
    div.title = name;
    colors.slice(0, 5).forEach(c => {
      const swatch = document.createElement('div');
      swatch.className = 'palette-swatch';
      swatch.style.background = c;
      div.appendChild(swatch);
    });
    div.onclick = () => {
      document.querySelectorAll('.palette-option').forEach(p => p.classList.remove('active'));
      div.classList.add('active');
      currentPalette = name;
      activeColors = [...palettes[name]];
      initCustomColors();
      updateChart();
    };
    container.appendChild(div);
  });
  activeColors = [...palettes[currentPalette]];
}

function initCustomColors() {
  const container = document.getElementById('customColors');
  container.innerHTML = '';
  const count = Math.max(selectedYColumns.length || 1, 6);
  for (let i = 0; i < count; i++) {
    const wrap = document.createElement('div');
    wrap.className = 'color-input-wrap';
    const input = document.createElement('input');
    input.type = 'color';
    input.value = activeColors[i % activeColors.length] || '#6366f1';
    input.dataset.index = i;
    input.onchange = (e) => {
      activeColors[i] = e.target.value;
      updateChart();
    };
    wrap.style.background = input.value;
    input.addEventListener('input', (e) => { wrap.style.background = e.target.value; });
    wrap.appendChild(input);
    container.appendChild(wrap);
  }
}

// ============ CHART RENDERING ============
function updateChart() {
  if (!csvData.headers.length) return;

  const xIndex = parseInt(document.getElementById('xAxisSelect').value);
  const labels = csvData.rows.map(r => r[xIndex]);
  const chartType = selectedChartType === 'horizontalBar' ? 'bar' : selectedChartType;
  const isHorizontal = selectedChartType === 'horizontalBar';
  const isPieType = ['pie', 'doughnut', 'polarArea'].includes(chartType);
  const isRadar = chartType === 'radar';
  const isScatter = chartType === 'scatter';
  const isBubble = chartType === 'bubble';

  const showLegend = document.getElementById('showLegend').checked;
  const showGrid = document.getElementById('showGrid').checked;
  const showDataLabels = document.getElementById('showDataLabels').checked;
  const smoothLines = document.getElementById('smoothLines').checked;
  const fillArea = document.getElementById('fillArea').checked;
  const barRadius = parseInt(document.getElementById('barRadius').value);
  const bgColor = document.getElementById('bgSelect').value;

  // Prepare datasets
  let datasets = [];

  if (isPieType && selectedYColumns.length === 1) {
    const yIdx = selectedYColumns[0];
    const data = csvData.rows.map(r => parseFloat(r[yIdx]) || 0);
    datasets.push({
      label: csvData.headers[yIdx],
      data: data,
      backgroundColor: labels.map((_, i) => activeColors[i % activeColors.length]),
      borderColor: bgColor === 'transparent' || bgColor === '#1e2230' ? '#1e2230' : '#ffffff',
      borderWidth: 2,
      hoverOffset: 12,
    });
  } else if (isScatter && selectedYColumns.length >= 1) {
    selectedYColumns.forEach((yIdx, di) => {
      const data = csvData.rows.map(r => ({
        x: parseFloat(r[xIndex]) || 0,
        y: parseFloat(r[yIdx]) || 0
      }));
      datasets.push({
        label: csvData.headers[yIdx],
        data: data,
        backgroundColor: activeColors[di % activeColors.length] + 'cc',
        borderColor: activeColors[di % activeColors.length],
        pointRadius: 6,
        pointHoverRadius: 9,
      });
    });
  } else if (isBubble && selectedYColumns.length >= 2) {
    const yIdx = selectedYColumns[0];
    const rIdx = selectedYColumns[1];
    const data = csvData.rows.map(r => ({
      x: parseFloat(r[xIndex]) || 0,
      y: parseFloat(r[yIdx]) || 0,
      r: Math.abs(parseFloat(r[rIdx]) || 1) / (Math.max(...csvData.rows.map(row => Math.abs(parseFloat(row[rIdx]) || 1))) / 25)
    }));
    datasets.push({
      label: `${csvData.headers[yIdx]} vs ${csvData.headers[rIdx]}`,
      data: data,
      backgroundColor: activeColors[0] + '88',
      borderColor: activeColors[0],
      borderWidth: 2,
    });
  } else {
    selectedYColumns.forEach((yIdx, di) => {
      const data = csvData.rows.map(r => parseFloat(r[yIdx]) || 0);
      const color = activeColors[di % activeColors.length];

      if (isPieType) {
        datasets.push({
          label: csvData.headers[yIdx],
          data: data,
          backgroundColor: labels.map((_, i) => activeColors[i % activeColors.length]),
          borderColor: bgColor === 'transparent' || bgColor === '#1e2230' ? '#1e2230' : '#ffffff',
          borderWidth: 2,
          hoverOffset: 12,
        });
      } else {
        const ds = {
          label: csvData.headers[yIdx],
          data: data,
          backgroundColor: chartType === 'line' ? color + '20' : color + 'cc',
          borderColor: color,
          borderWidth: 2,
          pointBackgroundColor: color,
          pointBorderColor: bgColor === 'transparent' || bgColor === '#1e2230' ? '#1e2230' : '#ffffff',
          pointBorderWidth: 2,
          pointRadius: chartType === 'line' ? 4 : 0,
          pointHoverRadius: 6,
          tension: smoothLines ? 0.4 : 0,
          fill: fillArea && chartType === 'line',
          borderRadius: chartType === 'bar' ? barRadius : 0,
          maxBarThickness: 60,
        };
        if (isHorizontal) ds.indexAxis = 'y';
        datasets.push(ds);
      }
    });
  }

  const isDark = bgColor === 'transparent' || bgColor === '#1e2230';
  const textColor = isDark ? '#9ca3bf' : '#64748b';
  const gridColor = isDark ? 'rgba(45, 51, 72, 0.6)' : 'rgba(0, 0, 0, 0.08)';
  const titleColor = isDark ? '#e8eaf0' : '#1e293b';

  const config = {
    type: chartType,
    data: { labels, datasets },
    plugins: showDataLabels ? [ChartDataLabels] : [],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: isHorizontal ? 'y' : 'x',
      layout: {
        padding: { top: 10, right: 10, bottom: 10, left: 10 }
      },
      interaction: {
        mode: isPieType ? 'nearest' : 'index',
        intersect: isPieType || isScatter || isBubble,
      },
      plugins: {
        legend: {
          display: showLegend,
          position: isPieType ? 'right' : 'top',
          labels: {
            color: textColor,
            font: { family: "'Inter', sans-serif", size: 12, weight: '500' },
            padding: 16,
            usePointStyle: true,
            pointStyleWidth: 16,
          }
        },
        tooltip: {
          backgroundColor: isDark ? 'rgba(30, 34, 48, 0.95)' : 'rgba(255, 255, 255, 0.95)',
          titleColor: isDark ? '#e8eaf0' : '#1e293b',
          bodyColor: isDark ? '#9ca3bf' : '#64748b',
          borderColor: isDark ? '#2d3348' : '#e2e8f0',
          borderWidth: 1,
          cornerRadius: 8,
          padding: 12,
          titleFont: { family: "'Inter', sans-serif", size: 13, weight: '600' },
          bodyFont: { family: "'Inter', sans-serif", size: 12 },
          displayColors: true,
          boxPadding: 6,
          callbacks: {
            label: function(ctx) {
              let val = ctx.parsed !== undefined ? (typeof ctx.parsed === 'object' ? ctx.parsed.y : ctx.parsed) : ctx.raw;
              if (typeof val === 'number') val = val.toLocaleString();
              return ` ${ctx.dataset.label}: ${val}`;
            }
          }
        },
        datalabels: showDataLabels ? {
          color: isDark ? '#e8eaf0' : '#1e293b',
          font: { size: 10, weight: '600', family: "'Inter', sans-serif" },
          anchor: isPieType ? 'center' : 'end',
          align: isPieType ? 'center' : 'top',
          formatter: (value) => {
            if (typeof value === 'number') return value.toLocaleString();
            if (value && typeof value === 'object' && value.y !== undefined) return value.y.toLocaleString();
            return value;
          },
          display: isPieType ? 'auto' : true,
        } : { display: false },
      },
      scales: (isPieType || isRadar) ? (isRadar ? {
        r: {
          ticks: { color: textColor, backdropColor: 'transparent', font: { size: 10 } },
          grid: { color: gridColor, display: showGrid },
          pointLabels: { color: textColor, font: { size: 11, family: "'Inter', sans-serif" } },
          angleLines: { color: gridColor, display: showGrid },
        }
      } : {}) : {
        x: {
          ticks: { color: textColor, font: { size: 11, family: "'Inter', sans-serif" }, maxRotation: 45, autoSkip: true, maxTicksLimit: 20 },
          grid: { color: gridColor, display: showGrid, drawBorder: false },
          border: { display: false },
        },
        y: {
          ticks: { color: textColor, font: { size: 11, family: "'Inter', sans-serif" }, callback: (v) => typeof v === 'number' ? v.toLocaleString() : v },
          grid: { color: gridColor, display: showGrid, drawBorder: false },
          border: { display: false },
          beginAtZero: chartType === 'bar',
        }
      },
      animation: {
        duration: 600,
        easing: 'easeOutQuart',
      }
    }
  };

  // Render
  const canvas = document.getElementById('mainChart');
  if (currentChart) currentChart.destroy();
  currentChart = new Chart(canvas, config);
}

// ============ EXPORT ============
function toggleExportMenu() {
  document.getElementById('exportMenu').classList.toggle('show');
}

function exportChart(format) {
  document.getElementById('exportMenu').classList.remove('show');
  if (!currentChart) return;

  const title = document.getElementById('chartTitle').value || 'chart';
  const bgColor = document.getElementById('bgSelect').value;
  const canvas = document.getElementById('mainChart');

  if (format === 'svg') {
    // For SVG, we'll create a snapshot as PNG with high res
    const tempCanvas = document.createElement('canvas');
    const scale = 3;
    tempCanvas.width = canvas.width * scale;
    tempCanvas.height = canvas.height * scale;
    const ctx = tempCanvas.getContext('2d');
    ctx.scale(scale, scale);

    if (bgColor !== 'transparent') {
      ctx.fillStyle = bgColor;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    ctx.drawImage(canvas, 0, 0);

    tempCanvas.toBlob((blob) => {
      downloadBlob(blob, `${title}.png`);
      showNotification('Chart exported as high-res PNG', 'success');
    }, 'image/png');
    return;
  }

  // Create high-res export
  const tempCanvas = document.createElement('canvas');
  const scale = format === 'png' ? 3 : 2;
  tempCanvas.width = canvas.width * scale;
  tempCanvas.height = canvas.height * scale;
  const ctx = tempCanvas.getContext('2d');
  ctx.scale(scale, scale);

  if (format === 'jpeg' || bgColor !== 'transparent') {
    ctx.fillStyle = bgColor === 'transparent' ? '#1e2230' : bgColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  ctx.drawImage(canvas, 0, 0);

  const mimeType = format === 'jpeg' ? 'image/jpeg' : 'image/png';
  const quality = format === 'jpeg' ? 0.95 : undefined;

  tempCanvas.toBlob((blob) => {
    downloadBlob(blob, `${title}.${format}`);
    showNotification(`Chart saved as ${format.toUpperCase()}`, 'success');
  }, mimeType, quality);
}

function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ============ DATA TABLE ============
function renderDataTable() {
  if (!csvData.headers.length) return;
  const wrapper = document.getElementById('dataTableWrapper');
  let html = '<table class="data-table"><thead><tr>';
  html += '<th>#</th>';
  csvData.headers.forEach(h => { html += `<th>${escapeHtml(h)}</th>`; });
  html += '</tr></thead><tbody>';
  csvData.rows.forEach((row, i) => {
    html += `<tr><td style="color:var(--text-muted)">${i + 1}</td>`;
    row.forEach(cell => { html += `<td>${escapeHtml(cell)}</td>`; });
    html += '</tr>';
  });
  html += '</tbody></table>';
  wrapper.innerHTML = html;
}

function toggleDataTable() {
  dataTableVisible = !dataTableVisible;
  document.getElementById('dataTableBody').style.display = dataTableVisible ? 'block' : 'none';
  document.getElementById('tableToggleIcon').style.transform = dataTableVisible ? 'rotate(180deg)' : '';
}

// ============ UTILITIES ============
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function showNotification(msg, type = 'success') {
  const el = document.getElementById('notification');
  el.className = 'notification ' + type;
  el.innerHTML = `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px;color:var(--${type === 'success' ? 'success' : 'danger'})">
      ${type === 'success'
        ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'
        : '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>'
      }
    </svg>
    ${msg}
  `;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3000);
}

// Add chart (duplicate view)
function addChart() {
  showNotification('Tip: Change chart type or axes to compare different views!', 'success');
}
</script>
</body>
</html>
