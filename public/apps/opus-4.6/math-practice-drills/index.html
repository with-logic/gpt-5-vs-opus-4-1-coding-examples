<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Math Practice Drills</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f172a;
    --surface: #1e293b;
    --surface-hover: #334155;
    --border: #334155;
    --text: #f1f5f9;
    --text-muted: #94a3b8;
    --primary: #6366f1;
    --primary-glow: #818cf8;
    --success: #22c55e;
    --success-bg: rgba(34, 197, 94, 0.15);
    --danger: #ef4444;
    --danger-bg: rgba(239, 68, 68, 0.15);
    --warning: #f59e0b;
    --warning-bg: rgba(245, 158, 11, 0.15);
    --accent-cyan: #22d3ee;
    --accent-purple: #a78bfa;
    --radius: 16px;
    --radius-sm: 10px;
    --shadow: 0 4px 24px rgba(0,0,0,0.3);
    --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }

  body {
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
    line-height: 1.5;
  }

  /* Animated background */
  body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(99,102,241,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(34,211,238,0.06) 0%, transparent 50%);
    animation: bgShift 20s ease-in-out infinite alternate;
    z-index: -1;
    pointer-events: none;
  }

  @keyframes bgShift {
    0% { transform: translate(0, 0); }
    100% { transform: translate(-5%, -5%); }
  }

  .app-container {
    width: 100%;
    max-width: 640px;
    padding: 24px 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 28px;
  }

  .header h1 {
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: -0.03em;
    background: linear-gradient(135deg, var(--primary-glow), var(--accent-cyan));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 4px;
  }

  .header p {
    color: var(--text-muted);
    font-size: 0.95rem;
  }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    transition: var(--transition);
  }

  .card-title {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 16px;
  }

  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px 12px;
    text-align: center;
    box-shadow: var(--shadow);
  }

  .stat-value {
    font-size: 1.8rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    line-height: 1.1;
  }

  .stat-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .stat-streak .stat-value { color: var(--warning); }
  .stat-correct .stat-value { color: var(--success); }
  .stat-accuracy .stat-value { color: var(--accent-cyan); }

  /* Difficulty Selector */
  .difficulty-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }

  .diff-btn {
    background: transparent;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-muted);
    font-size: 0.85rem;
    font-weight: 700;
    padding: 12px 8px;
    cursor: pointer;
    transition: var(--transition);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .diff-btn:hover {
    border-color: var(--primary);
    color: var(--text);
    background: rgba(99,102,241,0.08);
  }

  .diff-btn.active {
    border-color: var(--primary);
    background: rgba(99,102,241,0.15);
    color: var(--primary-glow);
    box-shadow: 0 0 20px rgba(99,102,241,0.15);
  }

  .diff-btn .diff-icon {
    font-size: 1.3rem;
    display: block;
    margin-bottom: 4px;
  }

  /* Operation Selector */
  .operation-selector {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 0;
  }

  .op-btn {
    background: transparent;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-muted);
    font-size: 1.2rem;
    font-weight: 700;
    padding: 10px 8px;
    cursor: pointer;
    transition: var(--transition);
  }

  .op-btn:hover {
    border-color: var(--accent-purple);
    color: var(--text);
  }

  .op-btn.active {
    border-color: var(--accent-purple);
    background: rgba(167,139,250,0.15);
    color: var(--accent-purple);
  }

  .op-btn .op-label {
    font-size: 0.65rem;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 2px;
  }

  /* Timer Settings */
  .timer-settings {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  .timer-settings label {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    white-space: nowrap;
  }

  .timer-pills {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .timer-pill {
    background: transparent;
    border: 2px solid var(--border);
    border-radius: 20px;
    color: var(--text-muted);
    font-size: 0.8rem;
    font-weight: 700;
    padding: 6px 14px;
    cursor: pointer;
    transition: var(--transition);
  }

  .timer-pill:hover {
    border-color: var(--accent-cyan);
    color: var(--text);
  }

  .timer-pill.active {
    border-color: var(--accent-cyan);
    background: rgba(34,211,238,0.12);
    color: var(--accent-cyan);
  }

  /* Start Button */
  .start-btn {
    width: 100%;
    padding: 18px;
    border: none;
    border-radius: var(--radius);
    background: linear-gradient(135deg, var(--primary), #7c3aed);
    color: white;
    font-size: 1.15rem;
    font-weight: 800;
    letter-spacing: 0.02em;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(99,102,241,0.3);
  }

  .start-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(99,102,241,0.4);
  }

  .start-btn:active {
    transform: translateY(0);
  }

  .start-btn::after {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: 0.5s;
  }

  .start-btn:hover::after {
    left: 100%;
  }

  /* Quiz Screen */
  .quiz-screen { display: none; flex-direction: column; flex: 1; }
  .quiz-screen.active { display: flex; }
  .setup-screen { display: flex; flex-direction: column; }
  .setup-screen.hidden { display: none; }
  .results-screen { display: none; flex-direction: column; }
  .results-screen.active { display: flex; }

  /* Timer Bar */
  .timer-bar-container {
    width: 100%;
    height: 6px;
    background: var(--surface);
    border-radius: 3px;
    margin-bottom: 24px;
    overflow: hidden;
  }

  .timer-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--success), var(--accent-cyan));
    border-radius: 3px;
    transition: width 0.1s linear;
    will-change: width;
  }

  .timer-bar.warning {
    background: linear-gradient(90deg, var(--warning), var(--danger));
  }

  .quiz-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .quiz-timer {
    font-size: 1.8rem;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    color: var(--accent-cyan);
    min-width: 70px;
    text-align: right;
  }

  .quiz-timer.warning { color: var(--warning); }
  .quiz-timer.danger { color: var(--danger); animation: pulse 0.5s ease-in-out infinite; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .quiz-progress {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-weight: 600;
  }

  .quiz-score-live {
    font-size: 0.85rem;
    color: var(--success);
    font-weight: 700;
  }

  /* Problem Display */
  .problem-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 40px 28px;
    text-align: center;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
    min-height: 160px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .problem-text {
    font-size: 3rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    line-height: 1.2;
    font-variant-numeric: tabular-nums;
  }

  .problem-text .operator {
    color: var(--primary-glow);
    margin: 0 12px;
  }

  .problem-equals {
    font-size: 3rem;
    font-weight: 800;
    color: var(--text-muted);
    margin: 0 8px;
  }

  /* Answer Input */
  .answer-section {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
  }

  .answer-input {
    flex: 1;
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-size: 2rem;
    font-weight: 700;
    padding: 16px 20px;
    text-align: center;
    outline: none;
    transition: var(--transition);
    font-variant-numeric: tabular-nums;
    -moz-appearance: textfield;
  }

  .answer-input::-webkit-outer-spin-button,
  .answer-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .answer-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(99,102,241,0.15);
  }

  .answer-input.correct {
    border-color: var(--success);
    background: var(--success-bg);
    box-shadow: 0 0 0 4px rgba(34,197,94,0.15);
  }

  .answer-input.incorrect {
    border-color: var(--danger);
    background: var(--danger-bg);
    box-shadow: 0 0 0 4px rgba(239,68,68,0.15);
    animation: shake 0.4s ease-in-out;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-5px); }
    80% { transform: translateX(5px); }
  }

  .submit-btn {
    background: var(--primary);
    border: none;
    border-radius: var(--radius-sm);
    color: white;
    font-size: 1.1rem;
    font-weight: 800;
    padding: 16px 28px;
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
  }

  .submit-btn:hover {
    background: var(--primary-glow);
  }

  .submit-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Feedback */
  .feedback {
    text-align: center;
    font-size: 1.1rem;
    font-weight: 700;
    min-height: 32px;
    margin-bottom: 16px;
    transition: var(--transition);
  }

  .feedback.correct { color: var(--success); }
  .feedback.incorrect { color: var(--danger); }

  /* Skip button */
  .skip-btn {
    background: transparent;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-muted);
    font-size: 0.85rem;
    font-weight: 700;
    padding: 10px 20px;
    cursor: pointer;
    transition: var(--transition);
    align-self: center;
  }

  .skip-btn:hover {
    border-color: var(--danger);
    color: var(--danger);
  }

  /* Results Screen */
  .results-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 36px 28px;
    text-align: center;
    box-shadow: var(--shadow);
    margin-bottom: 20px;
  }

  .results-grade {
    font-size: 4.5rem;
    font-weight: 900;
    line-height: 1;
    margin-bottom: 8px;
  }

  .results-grade.grade-a { color: var(--success); }
  .results-grade.grade-b { color: var(--accent-cyan); }
  .results-grade.grade-c { color: var(--warning); }
  .results-grade.grade-f { color: var(--danger); }

  .results-subtitle {
    font-size: 1.1rem;
    color: var(--text-muted);
    font-weight: 600;
    margin-bottom: 28px;
  }

  .results-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  .result-stat {
    background: rgba(255,255,255,0.03);
    border-radius: var(--radius-sm);
    padding: 16px;
  }

  .result-stat-value {
    font-size: 1.6rem;
    font-weight: 800;
    color: var(--text);
  }

  .result-stat-label {
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-top: 2px;
  }

  /* Problem History */
  .history-section {
    margin-top: 8px;
  }

  .history-title {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 12px;
    text-align: left;
  }

  .history-list {
    max-height: 300px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 14px;
    border-radius: var(--radius-sm);
    margin-bottom: 6px;
    font-size: 0.95rem;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  .history-item.correct {
    background: var(--success-bg);
    border-left: 3px solid var(--success);
  }

  .history-item.incorrect {
    background: var(--danger-bg);
    border-left: 3px solid var(--danger);
  }

  .history-item.skipped {
    background: var(--warning-bg);
    border-left: 3px solid var(--warning);
  }

  .history-problem { color: var(--text); }
  .history-answer { color: var(--text-muted); font-size: 0.85rem; }

  .history-time {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-left: 12px;
    white-space: nowrap;
  }

  .btn-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 8px;
  }

  .btn-secondary {
    padding: 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: transparent;
    color: var(--text);
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: var(--transition);
  }

  .btn-secondary:hover {
    border-color: var(--primary);
    background: rgba(99,102,241,0.08);
  }

  .btn-primary-action {
    padding: 16px;
    border: none;
    border-radius: var(--radius);
    background: linear-gradient(135deg, var(--primary), #7c3aed);
    color: white;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: 0 4px 20px rgba(99,102,241,0.3);
  }

  .btn-primary-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(99,102,241,0.4);
  }

  /* Keyboard hint */
  .keyboard-hint {
    text-align: center;
    color: var(--text-muted);
    font-size: 0.75rem;
    margin-top: 8px;
    opacity: 0.6;
  }

  .keyboard-hint kbd {
    background: var(--surface-hover);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1px 6px;
    font-family: inherit;
    font-size: 0.72rem;
  }

  /* Confetti canvas */
  #confetti-canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 999;
  }

  /* Transition animations */
  .fade-in {
    animation: fadeIn 0.35s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .pop-in {
    animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes popIn {
    from { opacity: 0; transform: scale(0.85); }
    to { opacity: 1; transform: scale(1); }
  }

  /* Streak fire */
  .streak-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: var(--warning-bg);
    border: 1px solid rgba(245,158,11,0.3);
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--warning);
    margin-left: 8px;
    animation: popIn 0.3s ease-out;
  }

  /* Best score display */
  .best-score-section {
    text-align: center;
    margin-bottom: 20px;
  }

  .best-score-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(167,139,250,0.1);
    border: 1px solid rgba(167,139,250,0.25);
    border-radius: 20px;
    padding: 6px 16px;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--accent-purple);
  }

  /* Number pad for mobile */
  .numpad {
    display: none;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 12px;
  }

  @media (max-width: 600px) {
    .numpad { display: grid; }
    .keyboard-hint { display: none; }
    .problem-text { font-size: 2.2rem; }
    .answer-input { font-size: 1.6rem; padding: 12px 16px; }
  }

  .numpad-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-size: 1.4rem;
    font-weight: 700;
    padding: 14px;
    cursor: pointer;
    transition: var(--transition);
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
  }

  .numpad-btn:hover, .numpad-btn:active {
    background: var(--surface-hover);
    border-color: var(--primary);
  }

  .numpad-btn.action {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }

  .numpad-btn.danger {
    color: var(--danger);
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="app-container">
  <div class="header fade-in">
    <h1>Math Practice Drills</h1>
    <p>Sharpen your mental math skills</p>
  </div>

  <!-- Setup Screen -->
  <div id="setup-screen" class="setup-screen">
    <!-- Stats -->
    <div class="stats-row fade-in">
      <div class="stat-card stat-streak">
        <div class="stat-value" id="stat-streak">0</div>
        <div class="stat-label">Best Streak</div>
      </div>
      <div class="stat-card stat-correct">
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-label">Problems</div>
      </div>
      <div class="stat-card stat-accuracy">
        <div class="stat-value" id="stat-accuracy">0%</div>
        <div class="stat-label">Accuracy</div>
      </div>
    </div>

    <div id="best-score-section" class="best-score-section" style="display:none;">
      <span class="best-score-badge">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        Best: <span id="best-score-value">0</span>%
      </span>
    </div>

    <!-- Settings -->
    <div class="card fade-in">
      <div class="card-title">Difficulty</div>
      <div class="difficulty-selector">
        <button class="diff-btn active" data-diff="easy">
          <span class="diff-icon">ðŸŒ±</span>
          Easy
        </button>
        <button class="diff-btn" data-diff="medium">
          <span class="diff-icon">ðŸ”¥</span>
          Medium
        </button>
        <button class="diff-btn" data-diff="hard">
          <span class="diff-icon">âš¡</span>
          Hard
        </button>
      </div>

      <div class="card-title" style="margin-top:20px;">Operations</div>
      <div class="operation-selector">
        <button class="op-btn active" data-op="add">
          +
          <span class="op-label">Add</span>
        </button>
        <button class="op-btn active" data-op="sub">
          âˆ’
          <span class="op-label">Sub</span>
        </button>
        <button class="op-btn" data-op="mul">
          Ã—
          <span class="op-label">Mul</span>
        </button>
        <button class="op-btn" data-op="div">
          Ã·
          <span class="op-label">Div</span>
        </button>
      </div>

      <div class="timer-settings">
        <label>Timer</label>
        <div class="timer-pills">
          <button class="timer-pill" data-time="30">30s</button>
          <button class="timer-pill active" data-time="60">60s</button>
          <button class="timer-pill" data-time="120">2m</button>
          <button class="timer-pill" data-time="300">5m</button>
        </div>
      </div>
    </div>

    <button class="start-btn" id="start-btn">Start Drill</button>
    <div class="keyboard-hint">Press <kbd>Enter</kbd> to start</div>
  </div>

  <!-- Quiz Screen -->
  <div id="quiz-screen" class="quiz-screen">
    <div class="timer-bar-container">
      <div class="timer-bar" id="timer-bar"></div>
    </div>

    <div class="quiz-header">
      <div>
        <span class="quiz-progress" id="quiz-progress">Problem 1</span>
        <span class="streak-badge" id="streak-badge" style="display:none;">
          ðŸ”¥ <span id="streak-count">0</span>
        </span>
      </div>
      <div class="quiz-score-live" id="quiz-score-live">0 correct</div>
      <div class="quiz-timer" id="quiz-timer">60</div>
    </div>

    <div class="problem-card" id="problem-card">
      <div class="problem-text" id="problem-text"></div>
    </div>

    <div class="feedback" id="feedback">&nbsp;</div>

    <div class="answer-section">
      <input type="number" class="answer-input" id="answer-input" placeholder="?" autocomplete="off" inputmode="numeric">
      <button class="submit-btn" id="submit-btn">Go</button>
    </div>

    <div class="numpad" id="numpad">
      <button class="numpad-btn" data-key="7">7</button>
      <button class="numpad-btn" data-key="8">8</button>
      <button class="numpad-btn" data-key="9">9</button>
      <button class="numpad-btn" data-key="4">4</button>
      <button class="numpad-btn" data-key="5">5</button>
      <button class="numpad-btn" data-key="6">6</button>
      <button class="numpad-btn" data-key="1">1</button>
      <button class="numpad-btn" data-key="2">2</button>
      <button class="numpad-btn" data-key="3">3</button>
      <button class="numpad-btn danger" data-key="clear">C</button>
      <button class="numpad-btn" data-key="0">0</button>
      <button class="numpad-btn action" data-key="enter">â†µ</button>
    </div>

    <div class="keyboard-hint" style="margin-top:12px;">
      Press <kbd>Enter</kbd> to submit &middot; <kbd>Esc</kbd> to quit
    </div>

    <button class="skip-btn" id="skip-btn" style="margin-top: 12px;">Skip â†’</button>
  </div>

  <!-- Results Screen -->
  <div id="results-screen" class="results-screen">
    <div class="results-card fade-in">
      <div class="results-grade" id="results-grade">A+</div>
      <div class="results-subtitle" id="results-subtitle">Outstanding!</div>

      <div class="results-stats">
        <div class="result-stat">
          <div class="result-stat-value" id="res-correct">0</div>
          <div class="result-stat-label">Correct</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value" id="res-total">0</div>
          <div class="result-stat-label">Attempted</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value" id="res-accuracy">0%</div>
          <div class="result-stat-label">Accuracy</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value" id="res-avg-time">0s</div>
          <div class="result-stat-label">Avg Time</div>
        </div>
      </div>

      <div class="history-section" id="history-section">
        <div class="history-title">Problem History</div>
        <div class="history-list" id="history-list"></div>
      </div>
    </div>

    <div class="btn-row fade-in">
      <button class="btn-secondary" id="btn-home">Settings</button>
      <button class="btn-primary-action" id="btn-retry">Play Again</button>
    </div>
    <div class="keyboard-hint" style="margin-top:8px;">Press <kbd>Enter</kbd> to play again</div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // ---- State ----
  const state = {
    difficulty: 'easy',
    operations: new Set(['add', 'sub']),
    timeLimit: 60,
    // Session
    problems: [],
    currentProblem: null,
    correct: 0,
    attempted: 0,
    streak: 0,
    maxStreak: 0,
    problemStartTime: 0,
    timerRemaining: 0,
    timerInterval: null,
    quizActive: false,
    // Lifetime stats (persisted)
    lifetime: { totalProblems: 0, totalCorrect: 0, bestStreak: 0, bestAccuracy: 0 }
  };

  // ---- Persistence ----
  function loadStats() {
    try {
      const d = JSON.parse(localStorage.getItem('mathDrills_stats'));
      if (d) Object.assign(state.lifetime, d);
    } catch(e) {}
    updateLifetimeUI();
  }

  function saveStats() {
    localStorage.setItem('mathDrills_stats', JSON.stringify(state.lifetime));
  }

  function updateLifetimeUI() {
    const lt = state.lifetime;
    document.getElementById('stat-streak').textContent = lt.bestStreak;
    document.getElementById('stat-total').textContent = lt.totalProblems;
    const acc = lt.totalProblems > 0 ? Math.round((lt.totalCorrect / lt.totalProblems) * 100) : 0;
    document.getElementById('stat-accuracy').textContent = acc + '%';
    if (lt.bestAccuracy > 0) {
      document.getElementById('best-score-section').style.display = '';
      document.getElementById('best-score-value').textContent = lt.bestAccuracy;
    }
  }

  // ---- Problem Generation ----
  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function generateProblem() {
    const ops = Array.from(state.operations);
    if (ops.length === 0) ops.push('add');
    const op = ops[randInt(0, ops.length - 1)];
    let a, b, answer, symbol;

    const ranges = {
      easy:   { add: [1, 20],  sub: [1, 20],  mul: [1, 10],  div: [1, 10] },
      medium: { add: [10, 100], sub: [10, 100], mul: [2, 15],  div: [2, 12] },
      hard:   { add: [50, 999], sub: [50, 999], mul: [5, 30],  div: [3, 20] }
    };

    const r = ranges[state.difficulty][op];

    switch(op) {
      case 'add':
        a = randInt(r[0], r[1]);
        b = randInt(r[0], r[1]);
        answer = a + b;
        symbol = '+';
        break;
      case 'sub':
        a = randInt(r[0], r[1]);
        b = randInt(r[0], r[1]);
        if (b > a) [a, b] = [b, a];
        answer = a - b;
        symbol = 'âˆ’';
        break;
      case 'mul':
        a = randInt(r[0], r[1]);
        b = randInt(r[0], r[1]);
        answer = a * b;
        symbol = 'Ã—';
        break;
      case 'div':
        b = randInt(r[0], r[1]);
        answer = randInt(r[0], r[1]);
        a = b * answer;
        symbol = 'Ã·';
        break;
    }

    return { a, b, answer, symbol, op };
  }

  // ---- UI Helpers ----
  const $ = id => document.getElementById(id);

  function showScreen(name) {
    ['setup-screen', 'quiz-screen', 'results-screen'].forEach(s => {
      const el = $(s);
      if (s === name + '-screen') {
        el.classList.add('active');
        if (s === 'setup-screen') el.classList.remove('hidden');
      } else {
        el.classList.remove('active');
        if (s === 'setup-screen') el.classList.add('hidden');
      }
    });
  }

  function displayProblem(p) {
    const pt = $('problem-text');
    pt.innerHTML = `${p.a} <span class="operator">${p.symbol}</span> ${p.b} <span class="problem-equals">=</span> <span style="color:var(--text-muted)">?</span>`;
    pt.parentElement.classList.add('pop-in');
    setTimeout(() => pt.parentElement.classList.remove('pop-in'), 300);
  }

  // ---- Quiz Logic ----
  function startQuiz() {
    state.problems = [];
    state.correct = 0;
    state.attempted = 0;
    state.streak = 0;
    state.maxStreak = 0;
    state.timerRemaining = state.timeLimit;
    state.quizActive = true;

    showScreen('quiz');
    updateTimerDisplay();
    updateQuizUI();
    nextProblem();
    startTimer();
    $('answer-input').focus();
  }

  function nextProblem() {
    const p = generateProblem();
    state.currentProblem = p;
    state.problemStartTime = performance.now();
    displayProblem(p);
    const input = $('answer-input');
    input.value = '';
    input.className = 'answer-input';
    $('feedback').innerHTML = '&nbsp;';
    $('feedback').className = 'feedback';
    input.disabled = false;
    input.focus();
  }

  function submitAnswer() {
    if (!state.quizActive) return;
    const input = $('answer-input');
    const val = input.value.trim();
    if (val === '') return;

    const userAnswer = parseInt(val, 10);
    if (isNaN(userAnswer)) return;

    const p = state.currentProblem;
    const elapsed = ((performance.now() - state.problemStartTime) / 1000).toFixed(1);
    const isCorrect = userAnswer === p.answer;

    state.attempted++;

    const record = {
      text: `${p.a} ${p.symbol} ${p.b}`,
      correctAnswer: p.answer,
      userAnswer,
      isCorrect,
      skipped: false,
      time: parseFloat(elapsed)
    };

    if (isCorrect) {
      state.correct++;
      state.streak++;
      if (state.streak > state.maxStreak) state.maxStreak = state.streak;
      input.className = 'answer-input correct';
      $('feedback').textContent = getCorrectMessage();
      $('feedback').className = 'feedback correct';
    } else {
      state.streak = 0;
      input.className = 'answer-input incorrect';
      $('feedback').textContent = `${p.answer} was the answer`;
      $('feedback').className = 'feedback incorrect';
    }

    state.problems.push(record);
    updateQuizUI();

    input.disabled = true;
    setTimeout(() => {
      if (state.quizActive) nextProblem();
    }, isCorrect ? 400 : 900);
  }

  function skipProblem() {
    if (!state.quizActive) return;
    const p = state.currentProblem;
    const elapsed = ((performance.now() - state.problemStartTime) / 1000).toFixed(1);
    state.streak = 0;
    state.attempted++;
    state.problems.push({
      text: `${p.a} ${p.symbol} ${p.b}`,
      correctAnswer: p.answer,
      userAnswer: null,
      isCorrect: false,
      skipped: true,
      time: parseFloat(elapsed)
    });
    updateQuizUI();
    nextProblem();
  }

  function getCorrectMessage() {
    const msgs = ['Correct!', 'Nice!', 'Right!', 'Yes!', 'Great!', 'Perfect!'];
    if (state.streak >= 5) return 'ðŸ”¥ On fire!';
    if (state.streak >= 3) return 'ðŸ’ª Keep going!';
    return msgs[randInt(0, msgs.length - 1)];
  }

  function updateQuizUI() {
    $('quiz-progress').textContent = `Problem ${state.attempted + 1}`;
    $('quiz-score-live').textContent = `${state.correct} correct`;

    if (state.streak >= 3) {
      $('streak-badge').style.display = '';
      $('streak-count').textContent = state.streak;
    } else {
      $('streak-badge').style.display = 'none';
    }
  }

  // ---- Timer ----
  function startTimer() {
    const totalTime = state.timeLimit;
    const startTime = performance.now();

    state.timerInterval = setInterval(() => {
      const elapsed = (performance.now() - startTime) / 1000;
      state.timerRemaining = Math.max(0, totalTime - elapsed);

      updateTimerDisplay();

      const pct = (state.timerRemaining / totalTime) * 100;
      const bar = $('timer-bar');
      bar.style.width = pct + '%';
      if (pct < 20) bar.classList.add('warning');
      else bar.classList.remove('warning');

      if (state.timerRemaining <= 0) {
        endQuiz();
      }
    }, 50);
  }

  function updateTimerDisplay() {
    const t = Math.ceil(state.timerRemaining);
    const timer = $('quiz-timer');
    if (t >= 60) {
      const m = Math.floor(t / 60);
      const s = t % 60;
      timer.textContent = `${m}:${String(s).padStart(2, '0')}`;
    } else {
      timer.textContent = t;
    }

    timer.className = 'quiz-timer';
    if (t <= 5) timer.classList.add('danger');
    else if (t <= 15) timer.classList.add('warning');
  }

  function endQuiz() {
    clearInterval(state.timerInterval);
    state.quizActive = false;
    showResults();
  }

  // ---- Results ----
  function showResults() {
    showScreen('results');

    const accuracy = state.attempted > 0 ? Math.round((state.correct / state.attempted) * 100) : 0;
    const totalTime = state.problems.reduce((sum, p) => sum + p.time, 0);
    const avgTime = state.attempted > 0 ? (totalTime / state.attempted).toFixed(1) : 0;

    // Grade
    let grade, subtitle, gradeClass;
    if (accuracy >= 95) { grade = 'A+'; subtitle = 'Outstanding!'; gradeClass = 'grade-a'; }
    else if (accuracy >= 90) { grade = 'A'; subtitle = 'Excellent work!'; gradeClass = 'grade-a'; }
    else if (accuracy >= 80) { grade = 'B'; subtitle = 'Great job!'; gradeClass = 'grade-b'; }
    else if (accuracy >= 70) { grade = 'C'; subtitle = 'Good effort!'; gradeClass = 'grade-c'; }
    else if (accuracy >= 60) { grade = 'D'; subtitle = 'Keep practicing!'; gradeClass = 'grade-c'; }
    else { grade = 'F'; subtitle = 'Room to improve!'; gradeClass = 'grade-f'; }

    if (state.attempted === 0) { grade = 'â€”'; subtitle = 'No problems attempted'; gradeClass = 'grade-c'; }

    const rg = $('results-grade');
    rg.textContent = grade;
    rg.className = 'results-grade ' + gradeClass;
    $('results-subtitle').textContent = subtitle;

    $('res-correct').textContent = state.correct;
    $('res-total').textContent = state.attempted;
    $('res-accuracy').textContent = accuracy + '%';
    $('res-avg-time').textContent = avgTime + 's';

    // History
    const histList = $('history-list');
    histList.innerHTML = '';
    state.problems.forEach(p => {
      const div = document.createElement('div');
      div.className = 'history-item ' + (p.skipped ? 'skipped' : (p.isCorrect ? 'correct' : 'incorrect'));
      let answerText;
      if (p.skipped) {
        answerText = `Skipped (answer: ${p.correctAnswer})`;
      } else if (p.isCorrect) {
        answerText = `= ${p.userAnswer} âœ“`;
      } else {
        answerText = `${p.userAnswer} â†’ ${p.correctAnswer}`;
      }
      div.innerHTML = `
        <span class="history-problem">${p.text}</span>
        <span>
          <span class="history-answer">${answerText}</span>
          <span class="history-time">${p.time}s</span>
        </span>`;
      histList.appendChild(div);
    });

    // Update lifetime stats
    const lt = state.lifetime;
    lt.totalProblems += state.attempted;
    lt.totalCorrect += state.correct;
    if (state.maxStreak > lt.bestStreak) lt.bestStreak = state.maxStreak;
    if (accuracy > lt.bestAccuracy && state.attempted >= 3) lt.bestAccuracy = accuracy;
    saveStats();
    updateLifetimeUI();

    // Confetti for good scores
    if (accuracy >= 80 && state.attempted >= 3) {
      launchConfetti();
    }
  }

  // ---- Confetti ----
  function launchConfetti() {
    const canvas = $('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const particles = [];
    const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#22d3ee', '#a78bfa', '#f472b6'];

    for (let i = 0; i < 120; i++) {
      particles.push({
        x: canvas.width * Math.random(),
        y: canvas.height * Math.random() * 0.3 - canvas.height * 0.1,
        vx: (Math.random() - 0.5) * 8,
        vy: Math.random() * 3 + 2,
        size: Math.random() * 8 + 4,
        color: colors[Math.floor(Math.random() * colors.length)],
        rotation: Math.random() * 360,
        rotSpeed: (Math.random() - 0.5) * 10,
        opacity: 1,
        shape: Math.random() > 0.5 ? 'rect' : 'circle'
      });
    }

    let frame = 0;
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let alive = false;

      particles.forEach(p => {
        if (p.opacity <= 0) return;
        alive = true;
        p.x += p.vx;
        p.vy += 0.12;
        p.y += p.vy;
        p.rotation += p.rotSpeed;
        if (frame > 40) p.opacity -= 0.012;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate((p.rotation * Math.PI) / 180);
        ctx.globalAlpha = Math.max(0, p.opacity);
        ctx.fillStyle = p.color;

        if (p.shape === 'rect') {
          ctx.fillRect(-p.size / 2, -p.size / 4, p.size, p.size / 2);
        } else {
          ctx.beginPath();
          ctx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.restore();
      });

      frame++;
      if (alive && frame < 200) requestAnimationFrame(animate);
      else ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    animate();
  }

  // ---- Event Listeners ----
  // Difficulty buttons
  document.querySelectorAll('.diff-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.difficulty = btn.dataset.diff;
    });
  });

  // Operation buttons
  document.querySelectorAll('.op-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const op = btn.dataset.op;
      if (btn.classList.contains('active')) {
        // Don't allow deselecting all
        if (state.operations.size > 1) {
          state.operations.delete(op);
          btn.classList.remove('active');
        }
      } else {
        state.operations.add(op);
        btn.classList.add('active');
      }
    });
  });

  // Timer pills
  document.querySelectorAll('.timer-pill').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.timer-pill').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.timeLimit = parseInt(btn.dataset.time);
    });
  });

  // Start
  $('start-btn').addEventListener('click', startQuiz);

  // Submit
  $('submit-btn').addEventListener('click', submitAnswer);
  $('answer-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      submitAnswer();
    }
  });

  // Skip
  $('skip-btn').addEventListener('click', skipProblem);

  // Results buttons
  $('btn-home').addEventListener('click', () => {
    showScreen('setup');
    updateLifetimeUI();
  });

  $('btn-retry').addEventListener('click', startQuiz);

  // Numpad
  document.querySelectorAll('.numpad-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const key = btn.dataset.key;
      const input = $('answer-input');
      if (input.disabled) return;
      if (key === 'clear') {
        input.value = '';
      } else if (key === 'enter') {
        submitAnswer();
      } else {
        input.value += key;
      }
      input.focus();
    });
  });

  // Negative number support via minus key on numpad (add to front)
  document.addEventListener('keydown', e => {
    if (!state.quizActive && e.key === 'Enter') {
      const setup = $('setup-screen');
      const results = $('results-screen');
      if (!setup.classList.contains('hidden')) {
        startQuiz();
      } else if (results.classList.contains('active')) {
        startQuiz();
      }
      return;
    }

    if (state.quizActive && e.key === 'Escape') {
      endQuiz();
    }

    // Allow typing minus for negative answers
    if (state.quizActive && e.key === '-') {
      const input = $('answer-input');
      if (input.value === '') {
        // Allow it to go through naturally
      }
    }
  });

  // Resize confetti canvas
  window.addEventListener('resize', () => {
    const canvas = $('confetti-canvas');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  });

  // ---- Init ----
  loadStats();
  showScreen('setup');
})();
</script>
</body>
</html>
