<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer Journey Flow</title>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#0f1117;--surface:#1a1d27;--surface2:#252836;--surface3:#2f3344;
    --border:#3a3f55;--text:#e4e6f0;--text2:#9ca0b8;--text3:#6b7094;
    --accent:#6c5ce7;--accent2:#a29bfe;--accent-glow:rgba(108,92,231,.25);
    --green:#00cec9;--green-glow:rgba(0,206,201,.2);
    --orange:#fdcb6e;--orange-glow:rgba(253,203,110,.2);
    --pink:#fd79a8;--pink-glow:rgba(253,121,168,.2);
    --blue:#74b9ff;--blue-glow:rgba(116,185,255,.2);
    --red:#ff7675;--red-glow:rgba(255,118,117,.2);
    --cyan:#81ecec;--cyan-glow:rgba(129,236,236,.2);
    --radius:12px;--radius-sm:8px;
    --shadow:0 4px 24px rgba(0,0,0,.3),0 1px 4px rgba(0,0,0,.2);
    --transition:all .25s cubic-bezier(.4,0,.2,1);
  }
  html,body{height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}

  /* Header */
  .header{position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:12px 24px;background:rgba(15,17,23,.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
  .header h1{font-size:18px;font-weight:700;background:linear-gradient(135deg,var(--accent2),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.3px}
  .header-actions{display:flex;gap:8px;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface2);color:var(--text);font-size:13px;font-weight:500;cursor:pointer;transition:var(--transition);white-space:nowrap}
  .btn:hover{background:var(--surface3);border-color:var(--accent);box-shadow:0 0 12px var(--accent-glow)}
  .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn-primary:hover{background:#7c6cf7;box-shadow:0 0 20px var(--accent-glow)}
  .btn svg{width:15px;height:15px}
  .btn-icon{padding:8px;border-radius:var(--radius-sm)}
  .badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;background:var(--surface3);color:var(--text2);border:1px solid var(--border)}

  /* Toolbar */
  .toolbar{position:fixed;top:57px;left:0;right:0;z-index:90;display:flex;align-items:center;gap:12px;padding:8px 24px;background:rgba(26,29,39,.8);backdrop-filter:blur(12px);border-bottom:1px solid rgba(58,63,85,.5)}
  .toolbar-group{display:flex;align-items:center;gap:6px}
  .toolbar-divider{width:1px;height:24px;background:var(--border);margin:0 6px}
  .zoom-display{font-size:12px;color:var(--text2);min-width:40px;text-align:center;font-variant-numeric:tabular-nums}

  /* Canvas */
  .canvas-wrapper{position:fixed;top:101px;left:0;right:0;bottom:0;overflow:hidden;cursor:grab}
  .canvas-wrapper.panning{cursor:grabbing}
  .canvas-wrapper.connecting{cursor:crosshair}
  #canvas{position:absolute;top:0;left:0;width:100%;height:100%;transform-origin:0 0}
  #svg-layer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1}
  #svg-layer path{pointer-events:stroke}
  .grid-bg{position:absolute;top:0;left:0;width:100%;height:100%;background-image:radial-gradient(circle,rgba(58,63,85,.3) 1px,transparent 1px);background-size:24px 24px}

  /* Stage Node */
  .stage-node{position:absolute;width:260px;min-height:120px;border-radius:var(--radius);background:var(--surface);border:1.5px solid var(--border);box-shadow:var(--shadow);cursor:move;transition:box-shadow .2s,border-color .2s;z-index:10;user-select:none}
  .stage-node:hover{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent),0 8px 32px rgba(0,0,0,.4)}
  .stage-node.selected{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent),0 0 30px var(--accent-glow)}
  .stage-node.dragging{z-index:999;opacity:.92;box-shadow:0 16px 48px rgba(0,0,0,.5)}
  .stage-node.drop-target{border-color:var(--green);box-shadow:0 0 0 2px var(--green),0 0 30px var(--green-glow)}

  .stage-header{display:flex;align-items:center;gap:10px;padding:14px 16px 10px;border-bottom:1px solid rgba(58,63,85,.4)}
  .stage-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
  .stage-title-area{flex:1;min-width:0}
  .stage-title{font-size:14px;font-weight:600;color:var(--text);outline:none;border:none;background:transparent;width:100%;padding:2px 4px;border-radius:4px;transition:background .2s}
  .stage-title:hover{background:var(--surface2)}
  .stage-title:focus{background:var(--surface3);box-shadow:0 0 0 2px var(--accent-glow)}
  .stage-type{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;margin-top:2px}
  .stage-actions{display:flex;gap:2px;opacity:0;transition:opacity .2s}
  .stage-node:hover .stage-actions{opacity:1}
  .stage-action-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;color:var(--text3);cursor:pointer;border-radius:6px;transition:var(--transition)}
  .stage-action-btn:hover{background:var(--surface3);color:var(--text)}
  .stage-action-btn.delete:hover{background:rgba(255,118,117,.15);color:var(--red)}

  .stage-body{padding:10px 16px 14px}
  .stage-desc{font-size:12px;color:var(--text2);line-height:1.5;outline:none;border:none;background:transparent;width:100%;resize:none;padding:4px;border-radius:4px;font-family:inherit;transition:background .2s;min-height:32px}
  .stage-desc:hover{background:var(--surface2)}
  .stage-desc:focus{background:var(--surface3);box-shadow:0 0 0 2px var(--accent-glow)}
  .stage-meta{display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap}
  .stage-metric{display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--text3);padding:3px 8px;background:var(--surface2);border-radius:6px}
  .stage-metric svg{width:12px;height:12px}

  /* Connection ports */
  .port{position:absolute;width:14px;height:14px;border-radius:50%;background:var(--surface3);border:2px solid var(--border);cursor:crosshair;z-index:20;transition:var(--transition)}
  .port:hover,.port.active{background:var(--accent);border-color:var(--accent);box-shadow:0 0 12px var(--accent-glow);transform:scale(1.3)}
  .port-out{right:-7px;top:50%;margin-top:-7px}
  .port-in{left:-7px;top:50%;margin-top:-7px}

  /* Connections */
  .connection{fill:none;stroke:var(--border);stroke-width:2;transition:stroke .2s}
  .connection:hover{stroke:var(--accent);stroke-width:2.5;cursor:pointer}
  .connection.active{stroke:var(--accent);stroke-width:2.5}
  .connection-ghost{fill:none;stroke:var(--accent);stroke-width:2;stroke-dasharray:8 4;opacity:.6}
  .connection-arrow{fill:var(--border);transition:fill .2s}
  .connection:hover+.connection-arrow,.connection.active+.connection-arrow{fill:var(--accent)}
  .connection-label{font-size:11px;fill:var(--text3);text-anchor:middle;pointer-events:all;cursor:pointer}
  .connection-label:hover{fill:var(--text)}
  .connection-delete{display:none;cursor:pointer}
  .connection-group:hover .connection-delete{display:block}

  /* Minimap */
  .minimap{position:fixed;bottom:16px;right:16px;width:200px;height:140px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;z-index:50;box-shadow:var(--shadow)}
  .minimap-viewport{position:absolute;border:1.5px solid var(--accent);border-radius:2px;background:rgba(108,92,231,.08);pointer-events:none}
  .minimap-node{position:absolute;border-radius:3px;opacity:.6}

  /* Context Menu */
  .context-menu{position:fixed;z-index:1000;min-width:180px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:0 8px 32px rgba(0,0,0,.5);padding:6px;display:none}
  .context-menu.visible{display:block}
  .context-item{display:flex;align-items:center;gap:10px;padding:8px 12px;font-size:13px;color:var(--text);border-radius:6px;cursor:pointer;transition:background .15s}
  .context-item:hover{background:var(--surface3)}
  .context-item.danger{color:var(--red)}
  .context-item.danger:hover{background:rgba(255,118,117,.1)}
  .context-sep{height:1px;background:var(--border);margin:4px 8px}
  .context-item svg{width:16px;height:16px;flex-shrink:0}

  /* Modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:500;display:none;align-items:center;justify-content:center}
  .modal-overlay.visible{display:flex}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:420px;max-width:90vw;box-shadow:0 24px 64px rgba(0,0,0,.5);overflow:hidden}
  .modal-header{padding:20px 24px 16px;border-bottom:1px solid var(--border)}
  .modal-header h3{font-size:16px;font-weight:600}
  .modal-body{padding:20px 24px}
  .modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
  .form-group{margin-bottom:16px}
  .form-label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
  .form-input,.form-select,.form-textarea{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px;font-family:inherit;transition:var(--transition)}
  .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
  .form-textarea{min-height:80px;resize:vertical}
  .form-select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239ca0b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
  .color-options{display:flex;gap:8px;flex-wrap:wrap}
  .color-option{width:32px;height:32px;border-radius:8px;border:2px solid transparent;cursor:pointer;transition:var(--transition);display:flex;align-items:center;justify-content:center}
  .color-option:hover{transform:scale(1.15)}
  .color-option.selected{border-color:#fff;box-shadow:0 0 12px rgba(255,255,255,.2)}
  .color-option svg{width:16px;height:16px;color:#fff;display:none}
  .color-option.selected svg{display:block}

  /* Toasts */
  .toast-container{position:fixed;top:110px;right:16px;z-index:200;display:flex;flex-direction:column;gap:8px}
  .toast{padding:12px 20px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:var(--shadow);font-size:13px;color:var(--text);animation:slideIn .3s ease;display:flex;align-items:center;gap:8px}
  .toast.success{border-left:3px solid var(--green)}
  .toast.info{border-left:3px solid var(--blue)}
  @keyframes slideIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
  @keyframes slideOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(30px)}}

  /* Help hint */
  .help-hint{position:fixed;bottom:16px;left:16px;z-index:50;display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;color:var(--text3)}
  .help-hint kbd{padding:2px 6px;background:var(--surface3);border:1px solid var(--border);border-radius:4px;font-size:11px;font-family:inherit;color:var(--text2)}

  /* Selection Marquee */
  .selection-marquee{position:absolute;border:1.5px dashed var(--accent);background:rgba(108,92,231,.06);border-radius:4px;pointer-events:none;z-index:999}

  /* Animations */
  @keyframes nodeAppear{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}
  .stage-node.appearing{animation:nodeAppear .35s cubic-bezier(.4,0,.2,1)}

  /* Scrollbar */
  ::-webkit-scrollbar{width:6px;height:6px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:3px}
  ::-webkit-scrollbar-thumb:hover{background:var(--border)}
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;align-items:center;gap:16px">
    <h1>Customer Journey Flow</h1>
    <span class="badge" id="nodeCount">5 stages</span>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="exportJSON()" title="Export as JSON">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export
    </button>
    <button class="btn" onclick="resetView()" title="Reset view">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 11.6 3M3 3v5h5"/></svg>
      Reset
    </button>
    <button class="btn btn-primary" onclick="openAddModal()" title="Add new stage">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Stage
    </button>
  </div>
</div>

<div class="toolbar">
  <div class="toolbar-group">
    <button class="btn btn-icon" onclick="zoomIn()" title="Zoom in">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
    </button>
    <span class="zoom-display" id="zoomDisplay">100%</span>
    <button class="btn btn-icon" onclick="zoomOut()" title="Zoom out">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
    </button>
    <button class="btn btn-icon" onclick="fitToScreen()" title="Fit to screen">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/></svg>
    </button>
  </div>
  <div class="toolbar-divider"></div>
  <div class="toolbar-group">
    <button class="btn btn-icon" id="selectModeBtn" onclick="setMode('select')" title="Select mode" style="background:var(--surface3);border-color:var(--accent)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg>
    </button>
    <button class="btn btn-icon" id="connectModeBtn" onclick="setMode('connect')" title="Connect mode">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
    </button>
  </div>
  <div class="toolbar-divider"></div>
  <span style="font-size:12px;color:var(--text3)">Drag to move stages &bull; Right-click for options &bull; Double-click to edit</span>
</div>

<div class="canvas-wrapper" id="canvasWrapper">
  <div id="canvas">
    <div class="grid-bg" id="gridBg"></div>
    <svg id="svg-layer"></svg>
  </div>
</div>

<div class="minimap" id="minimap">
  <div class="minimap-viewport" id="minimapViewport"></div>
</div>

<div class="help-hint">
  <kbd>Ctrl</kbd>+<kbd>Z</kbd> Undo &nbsp; <kbd>Delete</kbd> Remove &nbsp; <kbd>Space</kbd>+Drag Pan &nbsp; <kbd>Scroll</kbd> Zoom
</div>

<div class="context-menu" id="contextMenu">
  <div class="context-item" onclick="contextAction('edit')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
    Edit Stage
  </div>
  <div class="context-item" onclick="contextAction('duplicate')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
    Duplicate
  </div>
  <div class="context-item" onclick="contextAction('connect')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
    Connect From Here
  </div>
  <div class="context-sep"></div>
  <div class="context-item danger" onclick="contextAction('delete')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
    Delete Stage
  </div>
</div>

<div class="context-menu" id="connectionContextMenu">
  <div class="context-item" onclick="editConnectionLabel()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
    Edit Label
  </div>
  <div class="context-item danger" onclick="deleteSelectedConnection()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
    Delete Connection
  </div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header"><h3 id="modalTitle">Add New Stage</h3></div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Stage Name</label>
        <input type="text" class="form-input" id="formName" placeholder="e.g., Brand Discovery">
      </div>
      <div class="form-group">
        <label class="form-label">Stage Type</label>
        <select class="form-select" id="formType">
          <option value="awareness">Awareness</option>
          <option value="consideration">Consideration</option>
          <option value="decision">Decision</option>
          <option value="purchase">Purchase</option>
          <option value="retention">Retention</option>
          <option value="advocacy">Advocacy</option>
          <option value="touchpoint">Touchpoint</option>
          <option value="action">Action</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="formDesc" placeholder="What happens at this stage?"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Emoji Icon</label>
        <input type="text" class="form-input" id="formIcon" placeholder="e.g., ðŸ‘ï¸" style="width:80px">
      </div>
      <div class="form-group">
        <label class="form-label">Color</label>
        <div class="color-options" id="colorOptions"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="modalSubmit" onclick="submitModal()">Add Stage</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// --- State ---
const COLORS = [
  {name:'purple', color:'#6c5ce7', glow:'rgba(108,92,231,.25)'},
  {name:'green',  color:'#00cec9', glow:'rgba(0,206,201,.2)'},
  {name:'orange', color:'#fdcb6e', glow:'rgba(253,203,110,.2)'},
  {name:'pink',   color:'#fd79a8', glow:'rgba(253,121,168,.2)'},
  {name:'blue',   color:'#74b9ff', glow:'rgba(116,185,255,.2)'},
  {name:'red',    color:'#ff7675', glow:'rgba(255,118,117,.2)'},
  {name:'cyan',   color:'#81ecec', glow:'rgba(129,236,236,.2)'},
  {name:'white',  color:'#dfe6e9', glow:'rgba(223,230,233,.2)'},
];

const TYPE_DEFAULTS = {
  awareness:     {icon:'ðŸ‘ï¸',  colorIdx:4, metrics:['Impressions','Reach']},
  consideration: {icon:'ðŸ¤”', colorIdx:0, metrics:['Engagement','CTR']},
  decision:      {icon:'âš–ï¸', colorIdx:2, metrics:['Comparisons','Reviews']},
  purchase:      {icon:'ðŸ’³', colorIdx:1, metrics:['Conversion','Revenue']},
  retention:     {icon:'ðŸ”„', colorIdx:5, metrics:['Churn rate','NPS']},
  advocacy:      {icon:'â­', colorIdx:6, metrics:['Referrals','Reviews']},
  touchpoint:    {icon:'ðŸ“', colorIdx:3, metrics:['Interactions']},
  action:        {icon:'âš¡', colorIdx:7, metrics:['Completion rate']},
};

let state = {
  nodes: [],
  connections: [],
  nextId: 1,
  pan: {x: 0, y: 0},
  zoom: 1,
  mode: 'select', // 'select' | 'connect'
  selectedNodes: [],
  selectedConnection: null,
  connectingFrom: null,
  undoStack: [],
};

// --- Initialization with default journey ---
function initDefaultJourney() {
  const defaults = [
    {type:'awareness',     title:'Brand Awareness',    desc:'Customer discovers the brand through ads, social media, or word of mouth.',      x:80,  y:180},
    {type:'consideration', title:'Research & Compare',  desc:'Customer researches products, reads reviews, and compares alternatives.',        x:420, y:100},
    {type:'decision',      title:'Decision Making',     desc:'Customer evaluates pricing, features, and decides on the product.',              x:760, y:180},
    {type:'purchase',      title:'Purchase',            desc:'Customer completes the transaction and receives confirmation.',                  x:1100,y:100},
    {type:'retention',     title:'Loyalty & Retention', desc:'Follow-up engagement, support, and personalized offers keep the customer.',      x:1100,y:360},
    {type:'advocacy',      title:'Brand Advocacy',      desc:'Satisfied customers leave reviews, refer friends, and become brand ambassadors.',x:760, y:360},
  ];

  defaults.forEach(d => {
    const td = TYPE_DEFAULTS[d.type];
    state.nodes.push({
      id: state.nextId++,
      type: d.type,
      title: d.title,
      desc: d.desc,
      icon: td.icon,
      colorIdx: td.colorIdx,
      x: d.x,
      y: d.y,
    });
  });

  state.connections = [
    {from:1, to:2, label:'Discovers'},
    {from:2, to:3, label:'Evaluates'},
    {from:3, to:4, label:'Converts'},
    {from:4, to:5, label:'Engages'},
    {from:5, to:6, label:'Delights'},
    {from:6, to:1, label:'Refers'},
  ];

  state.pan = {x: 50, y: 50};
}

// --- Canvas / Pan / Zoom ---
const canvasWrapper = document.getElementById('canvasWrapper');
const canvas = document.getElementById('canvas');
const svgLayer = document.getElementById('svg-layer');

let isPanning = false;
let panStart = {x:0, y:0};
let spaceDown = false;

function applyTransform() {
  canvas.style.transform = `translate(${state.pan.x}px, ${state.pan.y}px) scale(${state.zoom})`;
  document.getElementById('zoomDisplay').textContent = Math.round(state.zoom * 100) + '%';
  const gridSize = 24 * state.zoom;
  const gridBg = document.getElementById('gridBg');
  gridBg.style.backgroundSize = `${gridSize}px ${gridSize}px`;
  gridBg.style.backgroundPosition = `${state.pan.x % gridSize}px ${state.pan.y % gridSize}px`;
  updateMinimap();
}

function zoomIn() { setZoom(state.zoom * 1.2); }
function zoomOut() { setZoom(state.zoom / 1.2); }
function setZoom(z, cx, cy) {
  const oldZ = state.zoom;
  state.zoom = Math.max(0.2, Math.min(3, z));
  if (cx !== undefined) {
    state.pan.x = cx - (cx - state.pan.x) * (state.zoom / oldZ);
    state.pan.y = cy - (cy - state.pan.y) * (state.zoom / oldZ);
  }
  applyTransform();
}

function resetView() {
  state.pan = {x: 50, y: 50};
  state.zoom = 1;
  applyTransform();
}

function fitToScreen() {
  if (state.nodes.length === 0) { resetView(); return; }
  const rect = canvasWrapper.getBoundingClientRect();
  let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
  state.nodes.forEach(n => {
    minX = Math.min(minX, n.x);
    minY = Math.min(minY, n.y);
    maxX = Math.max(maxX, n.x + 260);
    maxY = Math.max(maxY, n.y + 140);
  });
  const w = maxX - minX + 120;
  const h = maxY - minY + 120;
  const scaleX = rect.width / w;
  const scaleY = rect.height / h;
  state.zoom = Math.max(0.2, Math.min(2, Math.min(scaleX, scaleY)));
  state.pan.x = (rect.width - w * state.zoom) / 2 - minX * state.zoom + 60 * state.zoom;
  state.pan.y = (rect.height - h * state.zoom) / 2 - minY * state.zoom + 60 * state.zoom;
  applyTransform();
}

canvasWrapper.addEventListener('wheel', e => {
  e.preventDefault();
  const rect = canvasWrapper.getBoundingClientRect();
  const cx = e.clientX - rect.left;
  const cy = e.clientY - rect.top;
  const delta = e.deltaY > 0 ? 0.9 : 1.1;
  setZoom(state.zoom * delta, cx, cy);
}, {passive: false});

canvasWrapper.addEventListener('mousedown', e => {
  if (e.button === 1 || (e.button === 0 && spaceDown)) {
    isPanning = true;
    panStart = {x: e.clientX - state.pan.x, y: e.clientY - state.pan.y};
    canvasWrapper.classList.add('panning');
    e.preventDefault();
  } else if (e.button === 0 && e.target === canvasWrapper || e.target.classList.contains('grid-bg') || e.target === svgLayer) {
    deselectAll();
    hideContextMenu();
  }
});

window.addEventListener('mousemove', e => {
  if (isPanning) {
    state.pan.x = e.clientX - panStart.x;
    state.pan.y = e.clientY - panStart.y;
    applyTransform();
  }
  if (draggingNode) handleDrag(e);
  if (state.connectingFrom !== null) updateGhostConnection(e);
});

window.addEventListener('mouseup', e => {
  if (isPanning) {
    isPanning = false;
    canvasWrapper.classList.remove('panning');
  }
  if (draggingNode) endDrag(e);
  if (state.connectingFrom !== null && !e.target.classList.contains('port')) {
    cancelConnection();
  }
});

window.addEventListener('keydown', e => {
  if (e.code === 'Space' && !e.target.closest('input,textarea,[contenteditable]')) {
    spaceDown = true;
    e.preventDefault();
  }
  if (e.code === 'Delete' || e.code === 'Backspace') {
    if (!e.target.closest('input,textarea,[contenteditable]')) {
      deleteSelected();
    }
  }
  if (e.ctrlKey && e.code === 'KeyZ') {
    undo();
    e.preventDefault();
  }
  if (e.code === 'Escape') {
    closeModal();
    hideContextMenu();
    cancelConnection();
    deselectAll();
  }
});
window.addEventListener('keyup', e => {
  if (e.code === 'Space') spaceDown = false;
});

// --- Node Rendering ---
function render() {
  // Remove old nodes (keep svgLayer & grid)
  canvas.querySelectorAll('.stage-node').forEach(el => el.remove());

  state.nodes.forEach(node => {
    const el = createNodeElement(node);
    canvas.appendChild(el);
  });

  renderConnections();
  updateBadge();
  updateMinimap();
}

function createNodeElement(node) {
  const c = COLORS[node.colorIdx] || COLORS[0];
  const td = TYPE_DEFAULTS[node.type] || TYPE_DEFAULTS.touchpoint;
  const el = document.createElement('div');
  el.className = 'stage-node appearing';
  el.dataset.id = node.id;
  el.style.left = node.x + 'px';
  el.style.top = node.y + 'px';

  if (state.selectedNodes.includes(node.id)) el.classList.add('selected');

  el.innerHTML = `
    <div class="port port-in" data-port="in" data-node="${node.id}"></div>
    <div class="port port-out" data-port="out" data-node="${node.id}"></div>
    <div class="stage-header">
      <div class="stage-icon" style="background:${c.glow};color:${c.color}">${node.icon}</div>
      <div class="stage-title-area">
        <input class="stage-title" value="${escHtml(node.title)}" data-field="title" data-id="${node.id}" spellcheck="false">
        <div class="stage-type" style="color:${c.color}">${node.type}</div>
      </div>
      <div class="stage-actions">
        <button class="stage-action-btn" onclick="openEditModal(${node.id})" title="Edit">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="stage-action-btn delete" onclick="deleteNode(${node.id})" title="Delete">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
        </button>
      </div>
    </div>
    <div class="stage-body">
      <textarea class="stage-desc" data-field="desc" data-id="${node.id}" spellcheck="false" rows="2">${escHtml(node.desc)}</textarea>
      <div class="stage-meta">
        ${td.metrics.map(m => `<span class="stage-metric"><svg viewBox="0 0 24 24" fill="none" stroke="${c.color}" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>${m}</span>`).join('')}
      </div>
    </div>`;

  // Events
  el.addEventListener('mousedown', e => {
    if (e.target.classList.contains('port')) return;
    if (e.target.closest('input,textarea,button')) return;
    if (e.button !== 0) return;
    startDrag(node, e, el);
  });

  el.addEventListener('contextmenu', e => {
    e.preventDefault();
    showContextMenu(e, node.id);
  });

  // Inline editing
  el.querySelector('.stage-title').addEventListener('change', function() {
    saveUndo();
    const n = getNode(+this.dataset.id);
    if (n) n.title = this.value;
  });
  el.querySelector('.stage-title').addEventListener('mousedown', e => e.stopPropagation());

  el.querySelector('.stage-desc').addEventListener('change', function() {
    saveUndo();
    const n = getNode(+this.dataset.id);
    if (n) n.desc = this.value;
  });
  el.querySelector('.stage-desc').addEventListener('mousedown', e => e.stopPropagation());

  // Ports
  el.querySelectorAll('.port').forEach(port => {
    port.addEventListener('mousedown', e => {
      e.stopPropagation();
      e.preventDefault();
      const nodeId = +port.dataset.node;
      const portType = port.dataset.port;
      if (portType === 'out' || state.mode === 'connect') {
        startConnection(nodeId, e);
      }
    });
    port.addEventListener('mouseup', e => {
      if (state.connectingFrom !== null) {
        const toId = +port.dataset.node;
        finishConnection(toId);
      }
    });
  });

  // Node click to select
  el.addEventListener('click', e => {
    if (e.target.closest('input,textarea,button,.port')) return;
    if (!e.shiftKey) {
      state.selectedNodes = [node.id];
    } else {
      const idx = state.selectedNodes.indexOf(node.id);
      if (idx >= 0) state.selectedNodes.splice(idx, 1);
      else state.selectedNodes.push(node.id);
    }
    refreshNodeSelection();
  });

  return el;
}

function refreshNodeSelection() {
  document.querySelectorAll('.stage-node').forEach(el => {
    const id = +el.dataset.id;
    el.classList.toggle('selected', state.selectedNodes.includes(id));
  });
}

function deselectAll() {
  state.selectedNodes = [];
  state.selectedConnection = null;
  refreshNodeSelection();
  renderConnections();
}

function getNode(id) { return state.nodes.find(n => n.id === id); }

function updateBadge() {
  document.getElementById('nodeCount').textContent = state.nodes.length + ' stage' + (state.nodes.length !== 1 ? 's' : '');
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// --- Drag & Drop ---
let draggingNode = null;
let dragOffset = {x:0, y:0};
let dragEl = null;
let dragStartPos = null;

function startDrag(node, e, el) {
  draggingNode = node;
  dragEl = el;
  const rect = canvasWrapper.getBoundingClientRect();
  const canvasX = (e.clientX - rect.left - state.pan.x) / state.zoom;
  const canvasY = (e.clientY - rect.top - state.pan.y) / state.zoom;
  dragOffset = {x: canvasX - node.x, y: canvasY - node.y};
  dragStartPos = {x: node.x, y: node.y};
  el.classList.add('dragging');
}

function handleDrag(e) {
  if (!draggingNode) return;
  const rect = canvasWrapper.getBoundingClientRect();
  const canvasX = (e.clientX - rect.left - state.pan.x) / state.zoom;
  const canvasY = (e.clientY - rect.top - state.pan.y) / state.zoom;
  draggingNode.x = Math.round((canvasX - dragOffset.x) / 12) * 12;
  draggingNode.y = Math.round((canvasY - dragOffset.y) / 12) * 12;
  dragEl.style.left = draggingNode.x + 'px';
  dragEl.style.top = draggingNode.y + 'px';
  renderConnections();
  updateMinimap();
}

function endDrag(e) {
  if (!draggingNode) return;
  if (dragStartPos && (dragStartPos.x !== draggingNode.x || dragStartPos.y !== draggingNode.y)) {
    saveUndo();
  }
  dragEl.classList.remove('dragging');
  draggingNode = null;
  dragEl = null;
  dragStartPos = null;
}

// --- Connections ---
let ghostLine = null;

function startConnection(nodeId, e) {
  state.connectingFrom = nodeId;
  canvasWrapper.classList.add('connecting');
  // Highlight source port
  const port = document.querySelector(`.port-out[data-node="${nodeId}"]`);
  if (port) port.classList.add('active');
  // Create ghost line
  if (!ghostLine) {
    ghostLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    ghostLine.classList.add('connection-ghost');
    svgLayer.appendChild(ghostLine);
  }
}

function updateGhostConnection(e) {
  if (state.connectingFrom === null || !ghostLine) return;
  const node = getNode(state.connectingFrom);
  if (!node) return;
  const fromX = node.x + 260;
  const fromY = node.y + 60;
  const rect = canvasWrapper.getBoundingClientRect();
  const toX = (e.clientX - rect.left - state.pan.x) / state.zoom;
  const toY = (e.clientY - rect.top - state.pan.y) / state.zoom;
  const dx = Math.abs(toX - fromX) * 0.5;
  ghostLine.setAttribute('d', `M${fromX},${fromY} C${fromX+dx},${fromY} ${toX-dx},${toY} ${toX},${toY}`);
}

function finishConnection(toId) {
  if (state.connectingFrom === null) return;
  const fromId = state.connectingFrom;
  cancelConnection();
  if (fromId === toId) return;
  // Check if connection already exists
  if (state.connections.some(c => c.from === fromId && c.to === toId)) {
    showToast('Connection already exists', 'info');
    return;
  }
  saveUndo();
  const label = prompt('Connection label (optional):', '') || '';
  state.connections.push({from: fromId, to: toId, label});
  renderConnections();
  showToast('Connection created', 'success');
}

function cancelConnection() {
  state.connectingFrom = null;
  canvasWrapper.classList.remove('connecting');
  document.querySelectorAll('.port.active').forEach(p => p.classList.remove('active'));
  if (ghostLine) {
    ghostLine.remove();
    ghostLine = null;
  }
}

function renderConnections() {
  // Clear SVG
  while (svgLayer.firstChild) svgLayer.removeChild(svgLayer.firstChild);

  // Add defs for arrowheads
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  defs.innerHTML = `
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="var(--border)"/>
    </marker>
    <marker id="arrowhead-active" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="var(--accent)"/>
    </marker>`;
  svgLayer.appendChild(defs);

  state.connections.forEach((conn, idx) => {
    const fromNode = getNode(conn.from);
    const toNode = getNode(conn.to);
    if (!fromNode || !toNode) return;

    const fromX = fromNode.x + 260;
    const fromY = fromNode.y + 60;
    const toX = toNode.x;
    const toY = toNode.y + 60;

    const isActive = state.selectedConnection === idx;
    const dx = Math.max(80, Math.abs(toX - fromX) * 0.45);

    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.classList.add('connection-group');

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', `M${fromX},${fromY} C${fromX+dx},${fromY} ${toX-dx},${toY} ${toX},${toY}`);
    path.classList.add('connection');
    if (isActive) path.classList.add('active');
    path.setAttribute('marker-end', isActive ? 'url(#arrowhead-active)' : 'url(#arrowhead)');
    path.style.pointerEvents = 'stroke';
    path.style.strokeWidth = '8';
    path.style.opacity = '0';
    g.appendChild(path);

    const pathVisible = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    pathVisible.setAttribute('d', `M${fromX},${fromY} C${fromX+dx},${fromY} ${toX-dx},${toY} ${toX},${toY}`);
    pathVisible.classList.add('connection');
    if (isActive) pathVisible.classList.add('active');
    pathVisible.setAttribute('marker-end', isActive ? 'url(#arrowhead-active)' : 'url(#arrowhead)');
    pathVisible.style.pointerEvents = 'none';
    g.appendChild(pathVisible);

    // Click handler on the wide invisible path
    path.addEventListener('click', e => {
      e.stopPropagation();
      state.selectedConnection = idx;
      state.selectedNodes = [];
      refreshNodeSelection();
      renderConnections();
    });
    path.addEventListener('contextmenu', e => {
      e.preventDefault();
      e.stopPropagation();
      state.selectedConnection = idx;
      showConnectionContextMenu(e);
    });

    // Label
    if (conn.label) {
      const midX = (fromX + toX) / 2;
      const midY = (fromY + toY) / 2 - 12;
      const labelBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      textEl.setAttribute('x', midX);
      textEl.setAttribute('y', midY);
      textEl.classList.add('connection-label');
      textEl.textContent = conn.label;

      const tw = conn.label.length * 6.5 + 16;
      labelBg.setAttribute('x', midX - tw/2);
      labelBg.setAttribute('y', midY - 12);
      labelBg.setAttribute('width', tw);
      labelBg.setAttribute('height', 20);
      labelBg.setAttribute('rx', 6);
      labelBg.setAttribute('fill', 'var(--surface)');
      labelBg.setAttribute('stroke', isActive ? 'var(--accent)' : 'var(--border)');
      labelBg.setAttribute('stroke-width', '1');
      labelBg.style.pointerEvents = 'all';
      labelBg.style.cursor = 'pointer';

      labelBg.addEventListener('dblclick', () => {
        state.selectedConnection = idx;
        editConnectionLabel();
      });

      g.appendChild(labelBg);
      g.appendChild(textEl);
    }

    svgLayer.appendChild(g);
  });
}

function editConnectionLabel() {
  if (state.selectedConnection === null) return;
  const conn = state.connections[state.selectedConnection];
  if (!conn) return;
  hideContextMenu();
  const label = prompt('Edit connection label:', conn.label || '');
  if (label !== null) {
    saveUndo();
    conn.label = label;
    renderConnections();
  }
}

function deleteSelectedConnection() {
  if (state.selectedConnection === null) return;
  saveUndo();
  state.connections.splice(state.selectedConnection, 1);
  state.selectedConnection = null;
  hideContextMenu();
  renderConnections();
  showToast('Connection removed', 'info');
}

// --- Context Menu ---
let contextNodeId = null;

function showContextMenu(e, nodeId) {
  contextNodeId = nodeId;
  state.selectedNodes = [nodeId];
  refreshNodeSelection();
  const menu = document.getElementById('contextMenu');
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('visible');
  document.getElementById('connectionContextMenu').classList.remove('visible');
}

function showConnectionContextMenu(e) {
  const menu = document.getElementById('connectionContextMenu');
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('visible');
  document.getElementById('contextMenu').classList.remove('visible');
}

function hideContextMenu() {
  document.getElementById('contextMenu').classList.remove('visible');
  document.getElementById('connectionContextMenu').classList.remove('visible');
}

document.addEventListener('click', e => {
  if (!e.target.closest('.context-menu')) hideContextMenu();
});

function contextAction(action) {
  hideContextMenu();
  if (!contextNodeId) return;
  switch(action) {
    case 'edit': openEditModal(contextNodeId); break;
    case 'duplicate': duplicateNode(contextNodeId); break;
    case 'connect':
      state.connectingFrom = contextNodeId;
      canvasWrapper.classList.add('connecting');
      const port = document.querySelector(`.port-out[data-node="${contextNodeId}"]`);
      if (port) port.classList.add('active');
      if (!ghostLine) {
        ghostLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        ghostLine.classList.add('connection-ghost');
        svgLayer.appendChild(ghostLine);
      }
      showToast('Click on a target stage to connect', 'info');
      break;
    case 'delete': deleteNode(contextNodeId); break;
  }
}

// --- CRUD ---
function deleteNode(id) {
  saveUndo();
  state.nodes = state.nodes.filter(n => n.id !== id);
  state.connections = state.connections.filter(c => c.from !== id && c.to !== id);
  state.selectedNodes = state.selectedNodes.filter(sid => sid !== id);
  render();
  showToast('Stage removed', 'info');
}

function duplicateNode(id) {
  const node = getNode(id);
  if (!node) return;
  saveUndo();
  const newNode = {...node, id: state.nextId++, x: node.x + 40, y: node.y + 40, title: node.title + ' (copy)'};
  state.nodes.push(newNode);
  render();
  showToast('Stage duplicated', 'success');
}

function deleteSelected() {
  if (state.selectedConnection !== null) {
    deleteSelectedConnection();
    return;
  }
  if (state.selectedNodes.length === 0) return;
  saveUndo();
  const ids = [...state.selectedNodes];
  state.nodes = state.nodes.filter(n => !ids.includes(n.id));
  state.connections = state.connections.filter(c => !ids.includes(c.from) && !ids.includes(c.to));
  state.selectedNodes = [];
  render();
  showToast(`Removed ${ids.length} stage${ids.length > 1 ? 's' : ''}`, 'info');
}

// --- Modal ---
let editingId = null;
let selectedColorIdx = 0;

function openAddModal() {
  editingId = null;
  document.getElementById('modalTitle').textContent = 'Add New Stage';
  document.getElementById('modalSubmit').textContent = 'Add Stage';
  document.getElementById('formName').value = '';
  document.getElementById('formType').value = 'touchpoint';
  document.getElementById('formDesc').value = '';
  document.getElementById('formIcon').value = 'ðŸ“';
  selectedColorIdx = 3;
  renderColorOptions();
  document.getElementById('modalOverlay').classList.add('visible');
  setTimeout(() => document.getElementById('formName').focus(), 100);
}

function openEditModal(id) {
  const node = getNode(id);
  if (!node) return;
  editingId = id;
  document.getElementById('modalTitle').textContent = 'Edit Stage';
  document.getElementById('modalSubmit').textContent = 'Save Changes';
  document.getElementById('formName').value = node.title;
  document.getElementById('formType').value = node.type;
  document.getElementById('formDesc').value = node.desc;
  document.getElementById('formIcon').value = node.icon;
  selectedColorIdx = node.colorIdx;
  renderColorOptions();
  document.getElementById('modalOverlay').classList.add('visible');
  setTimeout(() => document.getElementById('formName').focus(), 100);
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('visible');
  editingId = null;
}

function submitModal() {
  const name = document.getElementById('formName').value.trim();
  const type = document.getElementById('formType').value;
  const desc = document.getElementById('formDesc').value.trim();
  const icon = document.getElementById('formIcon').value.trim() || TYPE_DEFAULTS[type]?.icon || 'ðŸ“';

  if (!name) {
    document.getElementById('formName').focus();
    return;
  }

  saveUndo();

  if (editingId !== null) {
    const node = getNode(editingId);
    if (node) {
      node.title = name;
      node.type = type;
      node.desc = desc;
      node.icon = icon;
      node.colorIdx = selectedColorIdx;
    }
    showToast('Stage updated', 'success');
  } else {
    // Find a good position for new node
    let maxX = 0;
    state.nodes.forEach(n => { if (n.x + 260 > maxX) maxX = n.x + 260; });
    state.nodes.push({
      id: state.nextId++,
      type,
      title: name,
      desc: desc || 'Describe this stage...',
      icon,
      colorIdx: selectedColorIdx,
      x: maxX + 60,
      y: 180,
    });
    showToast('Stage added', 'success');
  }

  closeModal();
  render();
}

function renderColorOptions() {
  const container = document.getElementById('colorOptions');
  container.innerHTML = COLORS.map((c, i) =>
    `<div class="color-option${i===selectedColorIdx?' selected':''}" style="background:${c.color}" onclick="selectColor(${i})">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
    </div>`
  ).join('');
}

function selectColor(idx) {
  selectedColorIdx = idx;
  renderColorOptions();
}

// Type change auto-fills icon
document.getElementById('formType').addEventListener('change', function() {
  const td = TYPE_DEFAULTS[this.value];
  if (td && !editingId) {
    document.getElementById('formIcon').value = td.icon;
    selectedColorIdx = td.colorIdx;
    renderColorOptions();
  }
});

// --- Mode ---
function setMode(mode) {
  state.mode = mode;
  document.getElementById('selectModeBtn').style.background = mode === 'select' ? 'var(--surface3)' : '';
  document.getElementById('selectModeBtn').style.borderColor = mode === 'select' ? 'var(--accent)' : '';
  document.getElementById('connectModeBtn').style.background = mode === 'connect' ? 'var(--surface3)' : '';
  document.getElementById('connectModeBtn').style.borderColor = mode === 'connect' ? 'var(--accent)' : '';
  if (mode === 'connect') {
    canvasWrapper.classList.add('connecting');
  } else {
    canvasWrapper.classList.remove('connecting');
  }
}

// --- Undo ---
function saveUndo() {
  state.undoStack.push(JSON.stringify({nodes: state.nodes, connections: state.connections, nextId: state.nextId}));
  if (state.undoStack.length > 50) state.undoStack.shift();
}

function undo() {
  if (state.undoStack.length === 0) return;
  const prev = JSON.parse(state.undoStack.pop());
  state.nodes = prev.nodes;
  state.connections = prev.connections;
  state.nextId = prev.nextId;
  state.selectedNodes = [];
  state.selectedConnection = null;
  render();
  showToast('Undone', 'info');
}

// --- Export ---
function exportJSON() {
  const data = {
    name: 'Customer Journey Flow',
    exportedAt: new Date().toISOString(),
    stages: state.nodes.map(n => ({id:n.id, type:n.type, title:n.title, description:n.desc, icon:n.icon, position:{x:n.x, y:n.y}})),
    connections: state.connections.map(c => ({from:c.from, to:c.to, label:c.label})),
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'customer-journey.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Exported as JSON', 'success');
}

// --- Minimap ---
function updateMinimap() {
  const minimap = document.getElementById('minimap');
  const viewport = document.getElementById('minimapViewport');
  const mmW = 200, mmH = 140;

  if (state.nodes.length === 0) {
    viewport.style.display = 'none';
    minimap.querySelectorAll('.minimap-node').forEach(e => e.remove());
    return;
  }

  let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
  state.nodes.forEach(n => {
    minX = Math.min(minX, n.x);
    minY = Math.min(minY, n.y);
    maxX = Math.max(maxX, n.x + 260);
    maxY = Math.max(maxY, n.y + 140);
  });

  const padding = 40;
  minX -= padding; minY -= padding;
  maxX += padding; maxY += padding;
  const worldW = maxX - minX;
  const worldH = maxY - minY;
  const scale = Math.min(mmW / worldW, mmH / worldH);

  // Draw nodes
  minimap.querySelectorAll('.minimap-node,.minimap-connection').forEach(e => e.remove());

  state.nodes.forEach(n => {
    const dot = document.createElement('div');
    dot.className = 'minimap-node';
    const c = COLORS[n.colorIdx] || COLORS[0];
    dot.style.cssText = `left:${(n.x - minX)*scale}px;top:${(n.y - minY)*scale}px;width:${260*scale}px;height:${Math.max(4, 120*scale)}px;background:${c.color}`;
    minimap.appendChild(dot);
  });

  // Viewport rect
  const wrapperRect = canvasWrapper.getBoundingClientRect();
  const vpLeft = (-state.pan.x / state.zoom - minX) * scale;
  const vpTop = (-state.pan.y / state.zoom - minY) * scale;
  const vpW = (wrapperRect.width / state.zoom) * scale;
  const vpH = (wrapperRect.height / state.zoom) * scale;

  viewport.style.display = 'block';
  viewport.style.left = Math.max(0, vpLeft) + 'px';
  viewport.style.top = Math.max(0, vpTop) + 'px';
  viewport.style.width = Math.min(mmW, vpW) + 'px';
  viewport.style.height = Math.min(mmH, vpH) + 'px';
}

// --- Toast ---
function showToast(msg, type='info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="${type==='success'?'var(--green)':'var(--blue)'}" stroke-width="2"><path d="${type==='success'?'M22 11.08V12a10 10 0 11-5.93-9.14':'M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z'}"/>${type==='success'?'<path d="M22 4L12 14.01l-3-3"/>':'<line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'}</svg>${msg}`;
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'slideOut .3s ease forwards';
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}

// --- Init ---
initDefaultJourney();
render();
setTimeout(() => fitToScreen(), 100);

// Close modal on overlay click
document.getElementById('modalOverlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
});
</script>
</body>
</html>
