<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Color Match Challenge</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Space+Grotesk:wght@700&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f0f1a;
    --surface: #1a1a2e;
    --surface-light: #25253d;
    --text: #e0e0f0;
    --text-dim: #8888aa;
    --accent: #6c63ff;
    --accent-glow: rgba(108, 99, 255, 0.3);
    --success: #00e676;
    --error: #ff5252;
    --radius: 16px;
  }

  body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
  }

  /* Animated background */
  body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(108, 99, 255, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(255, 82, 82, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(0, 230, 118, 0.04) 0%, transparent 60%);
    animation: bgShift 20s ease-in-out infinite alternate;
    z-index: -1;
  }

  @keyframes bgShift {
    0% { transform: translate(0, 0) rotate(0deg); }
    100% { transform: translate(-5%, 3%) rotate(3deg); }
  }

  /* Container */
  .game-container {
    width: 100%;
    max-width: 600px;
    padding: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 24px;
  }

  /* Header / HUD */
  .hud {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
  }

  .hud-item {
    background: var(--surface);
    border: 1px solid var(--surface-light);
    border-radius: 12px;
    padding: 12px 20px;
    text-align: center;
    flex: 1;
    position: relative;
    overflow: hidden;
  }

  .hud-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-dim);
    margin-bottom: 4px;
  }

  .hud-value {
    font-family: 'Space Grotesk', 'Inter', sans-serif;
    font-size: 28px;
    font-weight: 700;
    line-height: 1.2;
  }

  .hud-value.score { color: var(--accent); }
  .hud-value.timer { color: var(--text); }
  .hud-value.streak { color: #ffd740; }

  /* Timer bar */
  .timer-bar-container {
    width: 100%;
    height: 6px;
    background: var(--surface);
    border-radius: 3px;
    overflow: hidden;
  }

  .timer-bar {
    height: 100%;
    border-radius: 3px;
    transition: width 0.1s linear, background-color 0.5s ease;
    background: linear-gradient(90deg, var(--accent), #a78bfa);
  }

  .timer-bar.warning {
    background: linear-gradient(90deg, #ff9800, #ff5252);
  }

  .timer-bar.danger {
    background: linear-gradient(90deg, #ff5252, #d32f2f);
    animation: pulse-bar 0.5s ease-in-out infinite;
  }

  @keyframes pulse-bar {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  /* Word display area */
  .word-display {
    width: 100%;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--surface);
    border: 1px solid var(--surface-light);
    border-radius: var(--radius);
    padding: 32px 24px;
    position: relative;
    overflow: hidden;
  }

  .word-display::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: 0.5;
  }

  .instruction {
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--text-dim);
    margin-bottom: 16px;
  }

  .color-word {
    font-family: 'Space Grotesk', 'Inter', sans-serif;
    font-size: clamp(48px, 10vw, 80px);
    font-weight: 900;
    letter-spacing: 4px;
    text-transform: uppercase;
    transition: transform 0.15s ease, opacity 0.15s ease;
    text-shadow: 0 0 40px currentColor;
    line-height: 1.2;
  }

  .color-word.pop-in {
    animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes popIn {
    0% { transform: scale(0.5) translateY(20px); opacity: 0; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
  }

  /* Feedback flash */
  .feedback-flash {
    position: absolute;
    inset: 0;
    border-radius: var(--radius);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s ease;
  }

  .feedback-flash.correct {
    background: radial-gradient(circle at center, rgba(0, 230, 118, 0.2), transparent 70%);
    opacity: 1;
    animation: flashFade 0.4s ease-out forwards;
  }

  .feedback-flash.wrong {
    background: radial-gradient(circle at center, rgba(255, 82, 82, 0.25), transparent 70%);
    opacity: 1;
    animation: flashFade 0.4s ease-out forwards;
  }

  @keyframes flashFade {
    0% { opacity: 1; }
    100% { opacity: 0; }
  }

  /* Score popup */
  .score-popup {
    position: absolute;
    font-family: 'Space Grotesk', 'Inter', sans-serif;
    font-size: 24px;
    font-weight: 700;
    pointer-events: none;
    animation: scoreFloat 0.8s ease-out forwards;
    z-index: 10;
  }

  .score-popup.positive { color: var(--success); }
  .score-popup.negative { color: var(--error); }

  @keyframes scoreFloat {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(-60px) scale(1.3); opacity: 0; }
  }

  /* Color buttons grid */
  .buttons-grid {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  .color-btn {
    position: relative;
    border: none;
    border-radius: 14px;
    padding: 18px 8px;
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: #fff;
    cursor: pointer;
    overflow: hidden;
    transition: transform 0.12s cubic-bezier(0.34, 1.56, 0.64, 1),
                box-shadow 0.12s ease,
                filter 0.12s ease;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
    -webkit-tap-highlight-color: transparent;
  }

  .color-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, transparent 50%, rgba(0,0,0,0.1) 100%);
    border-radius: 14px;
    pointer-events: none;
  }

  .color-btn::after {
    content: '';
    position: absolute;
    inset: 2px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
    pointer-events: none;
  }

  .color-btn:hover {
    transform: translateY(-3px) scale(1.03);
    filter: brightness(1.1);
  }

  .color-btn:active {
    transform: translateY(1px) scale(0.97);
    filter: brightness(0.9);
  }

  .color-btn.correct-flash {
    animation: correctPulse 0.4s ease;
  }

  .color-btn.wrong-flash {
    animation: wrongShake 0.4s ease;
  }

  @keyframes correctPulse {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.6); }
    50% { transform: scale(1.05); box-shadow: 0 0 20px 8px rgba(0, 230, 118, 0.3); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); }
  }

  @keyframes wrongShake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(4px); }
  }

  /* Ripple effect */
  .ripple {
    position: absolute;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    transform: scale(0);
    animation: rippleEffect 0.5s ease-out;
    pointer-events: none;
  }

  @keyframes rippleEffect {
    to { transform: scale(4); opacity: 0; }
  }

  /* Screens */
  .screen {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 24px;
    width: 100%;
    animation: fadeIn 0.4s ease;
  }

  .screen.active { display: flex; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Start screen */
  .title {
    font-family: 'Space Grotesk', 'Inter', sans-serif;
    font-size: clamp(32px, 7vw, 48px);
    font-weight: 900;
    text-align: center;
    background: linear-gradient(135deg, #6c63ff, #a78bfa, #ff6b9d);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.2;
  }

  .subtitle {
    font-size: 16px;
    color: var(--text-dim);
    text-align: center;
    max-width: 400px;
    line-height: 1.6;
  }

  .how-to-play {
    background: var(--surface);
    border: 1px solid var(--surface-light);
    border-radius: var(--radius);
    padding: 24px;
    width: 100%;
    max-width: 420px;
  }

  .how-to-play h3 {
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--accent);
    margin-bottom: 16px;
    text-align: center;
  }

  .how-to-play p {
    font-size: 14px;
    color: var(--text-dim);
    line-height: 1.7;
    text-align: center;
  }

  .how-to-play .example {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin: 16px 0;
    padding: 16px;
    background: var(--surface-light);
    border-radius: 10px;
  }

  .example-word {
    font-family: 'Space Grotesk', 'Inter', sans-serif;
    font-size: 28px;
    font-weight: 900;
    color: #4fc3f7;
  }

  .example-arrow {
    font-size: 20px;
    color: var(--text-dim);
  }

  .example-answer {
    background: #4fc3f7;
    color: #fff;
    font-weight: 700;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .start-btn, .restart-btn {
    background: linear-gradient(135deg, #6c63ff, #8b7cff);
    border: none;
    border-radius: 14px;
    padding: 18px 48px;
    font-family: 'Inter', sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: #fff;
    cursor: pointer;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1),
                box-shadow 0.15s ease;
    box-shadow: 0 4px 20px var(--accent-glow);
  }

  .start-btn:hover, .restart-btn:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 8px 30px var(--accent-glow);
  }

  .start-btn:active, .restart-btn:active {
    transform: translateY(1px) scale(0.98);
  }

  /* Game over screen */
  .final-score {
    font-family: 'Space Grotesk', 'Inter', sans-serif;
    font-size: 72px;
    font-weight: 900;
    color: var(--accent);
    text-shadow: 0 0 40px var(--accent-glow);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    width: 100%;
    max-width: 420px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--surface-light);
    border-radius: 12px;
    padding: 16px 12px;
    text-align: center;
  }

  .stat-value {
    font-family: 'Space Grotesk', 'Inter', sans-serif;
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
  }

  .stat-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  .high-score-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: linear-gradient(135deg, #ffd740, #ffab00);
    color: #1a1a2e;
    font-size: 13px;
    font-weight: 700;
    padding: 8px 16px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 1px;
    animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  /* Combo indicator */
  .combo-display {
    position: absolute;
    top: 12px;
    right: 16px;
    font-family: 'Space Grotesk', 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: #ffd740;
    opacity: 0;
    transition: opacity 0.2s ease, transform 0.2s ease;
  }

  .combo-display.visible {
    opacity: 1;
    animation: comboPulse 0.3s ease;
  }

  @keyframes comboPulse {
    0% { transform: scale(0.8); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  /* Particles */
  .particle {
    position: fixed;
    pointer-events: none;
    border-radius: 50%;
    z-index: 100;
  }

  @keyframes particleFly {
    0% { opacity: 1; transform: translate(0, 0) scale(1); }
    100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
  }

  /* Countdown overlay */
  .countdown-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 15, 26, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
    backdrop-filter: blur(4px);
  }

  .countdown-number {
    font-family: 'Space Grotesk', 'Inter', sans-serif;
    font-size: 120px;
    font-weight: 900;
    color: var(--accent);
    text-shadow: 0 0 60px var(--accent-glow);
    animation: countPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes countPop {
    0% { transform: scale(2); opacity: 0; }
    50% { transform: scale(0.9); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
  }

  /* Responsive */
  @media (max-width: 480px) {
    .game-container { padding: 16px; gap: 16px; }
    .hud-item { padding: 10px 12px; }
    .hud-value { font-size: 22px; }
    .word-display { min-height: 140px; padding: 24px 16px; }
    .color-btn { padding: 14px 6px; font-size: 13px; }
    .buttons-grid { gap: 8px; }
    .stats-grid { gap: 8px; }
  }
</style>
</head>
<body>

<div class="game-container">

  <!-- START SCREEN -->
  <div class="screen active" id="startScreen">
    <div style="margin-bottom: 8px;">
      <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
        <circle cx="32" cy="32" r="30" stroke="url(#grad)" stroke-width="3" fill="none" opacity="0.3"/>
        <circle cx="20" cy="26" r="8" fill="#ff5252" opacity="0.85"/>
        <circle cx="44" cy="26" r="8" fill="#4fc3f7" opacity="0.85"/>
        <circle cx="32" cy="44" r="8" fill="#66bb6a" opacity="0.85"/>
        <circle cx="32" cy="32" r="5" fill="#ffd740" opacity="0.9"/>
        <defs><linearGradient id="grad" x1="0" y1="0" x2="64" y2="64"><stop stop-color="#6c63ff"/><stop offset="1" stop-color="#ff6b9d"/></linearGradient></defs>
      </svg>
    </div>
    <div class="title">Color Match<br>Challenge</div>
    <p class="subtitle">Match the <strong>font color</strong>, not the word. How fast can your brain adapt?</p>

    <div class="how-to-play">
      <h3>How to Play</h3>
      <div class="example">
        <span class="example-word">RED</span>
        <span class="example-arrow">â†’</span>
        <span class="example-answer">Blue</span>
      </div>
      <p>The word says "RED" but it's displayed in <strong>blue</strong>.<br>Tap the button matching the <strong>font color</strong>!</p>
    </div>

    <button class="start-btn" id="startBtn">Start Game</button>
  </div>

  <!-- GAME SCREEN -->
  <div class="screen" id="gameScreen">
    <div class="hud">
      <div class="hud-item">
        <div class="hud-label">Score</div>
        <div class="hud-value score" id="scoreDisplay">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">Time</div>
        <div class="hud-value timer" id="timerDisplay">30</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">Streak</div>
        <div class="hud-value streak" id="streakDisplay">0</div>
      </div>
    </div>

    <div class="timer-bar-container">
      <div class="timer-bar" id="timerBar" style="width: 100%"></div>
    </div>

    <div class="word-display" id="wordDisplay">
      <div class="instruction">Tap the font color!</div>
      <div class="color-word" id="colorWord">RED</div>
      <div class="combo-display" id="comboDisplay">x2 COMBO</div>
      <div class="feedback-flash" id="feedbackFlash"></div>
    </div>

    <div class="buttons-grid" id="buttonsGrid"></div>
  </div>

  <!-- GAME OVER SCREEN -->
  <div class="screen" id="endScreen">
    <div class="title" style="font-size: clamp(24px, 5vw, 36px);">Time's Up!</div>
    <div class="final-score" id="finalScore">0</div>
    <div id="highScoreBadge" style="display:none;">
      <span class="high-score-badge">&#9733; New High Score!</span>
    </div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="statCorrect">0</div>
        <div class="stat-label">Correct</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statWrong">0</div>
        <div class="stat-label">Wrong</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statBestStreak">0</div>
        <div class="stat-label">Best Streak</div>
      </div>
    </div>
    <div style="font-size: 14px; color: var(--text-dim);">
      High Score: <span id="highScoreDisplay" style="color: #ffd740; font-weight: 700;">0</span>
    </div>
    <button class="restart-btn" id="restartBtn">Play Again</button>
  </div>

</div>

<div class="countdown-overlay" id="countdownOverlay" style="display:none;">
  <div class="countdown-number" id="countdownNumber">3</div>
</div>

<script>
(function() {
  'use strict';

  // === COLOR DEFINITIONS ===
  const COLORS = [
    { name: 'RED',    hex: '#ff5252', btnBg: '#e53935' },
    { name: 'BLUE',   hex: '#42a5f5', btnBg: '#1e88e5' },
    { name: 'GREEN',  hex: '#66bb6a', btnBg: '#43a047' },
    { name: 'YELLOW', hex: '#ffd740', btnBg: '#f9a825' },
    { name: 'PURPLE', hex: '#ab47bc', btnBg: '#8e24aa' },
    { name: 'ORANGE', hex: '#ffa726', btnBg: '#ef6c00' },
    { name: 'PINK',   hex: '#ec407a', btnBg: '#d81b60' },
    { name: 'CYAN',   hex: '#26c6da', btnBg: '#00acc1' },
    { name: 'WHITE',  hex: '#e0e0e0', btnBg: '#9e9e9e' },
  ];

  const GAME_DURATION = 30;
  const BUTTONS_COUNT = 6; // Number of color buttons shown

  // === STATE ===
  let score = 0;
  let streak = 0;
  let bestStreak = 0;
  let correctCount = 0;
  let wrongCount = 0;
  let timeLeft = GAME_DURATION;
  let timerInterval = null;
  let gameActive = false;
  let currentCorrectColor = null;
  let highScore = parseInt(localStorage.getItem('colorMatchHighScore')) || 0;
  let lastWordIndex = -1;
  let lastColorIndex = -1;

  // === DOM ELEMENTS ===
  const startScreen = document.getElementById('startScreen');
  const gameScreen = document.getElementById('gameScreen');
  const endScreen = document.getElementById('endScreen');
  const startBtn = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');
  const scoreDisplay = document.getElementById('scoreDisplay');
  const timerDisplay = document.getElementById('timerDisplay');
  const streakDisplay = document.getElementById('streakDisplay');
  const timerBar = document.getElementById('timerBar');
  const colorWord = document.getElementById('colorWord');
  const wordDisplay = document.getElementById('wordDisplay');
  const buttonsGrid = document.getElementById('buttonsGrid');
  const feedbackFlash = document.getElementById('feedbackFlash');
  const comboDisplay = document.getElementById('comboDisplay');
  const countdownOverlay = document.getElementById('countdownOverlay');
  const countdownNumber = document.getElementById('countdownNumber');

  // === AUDIO (Web Audio API for snappy feedback) ===
  let audioCtx = null;

  function getAudioCtx() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    return audioCtx;
  }

  function playTone(freq, duration, type, volume) {
    try {
      const ctx = getAudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = type || 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      gain.gain.setValueAtTime(volume || 0.12, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + (duration || 0.15));
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + (duration || 0.15));
    } catch(e) {}
  }

  function playCorrectSound() {
    playTone(523, 0.08, 'sine', 0.1);
    setTimeout(() => playTone(659, 0.08, 'sine', 0.1), 60);
    setTimeout(() => playTone(784, 0.12, 'sine', 0.08), 120);
  }

  function playWrongSound() {
    playTone(200, 0.15, 'square', 0.08);
    setTimeout(() => playTone(160, 0.2, 'square', 0.06), 100);
  }

  function playCountdownBeep() {
    playTone(440, 0.1, 'sine', 0.08);
  }

  function playGoSound() {
    playTone(880, 0.15, 'sine', 0.12);
  }

  // === UTILITY ===
  function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = randomInt(0, i);
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function showScreen(screen) {
    [startScreen, gameScreen, endScreen].forEach(s => s.classList.remove('active'));
    screen.classList.add('active');
  }

  // === PARTICLES ===
  function spawnParticles(x, y, color, count) {
    for (let i = 0; i < count; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      const size = randomInt(4, 10);
      const angle = (Math.PI * 2 * i) / count + (Math.random() - 0.5) * 0.5;
      const dist = randomInt(40, 100);
      const tx = Math.cos(angle) * dist;
      const ty = Math.sin(angle) * dist;
      p.style.cssText = `
        width: ${size}px; height: ${size}px;
        left: ${x - size / 2}px; top: ${y - size / 2}px;
        background: ${color};
        --tx: ${tx}px; --ty: ${ty}px;
        animation: particleFly ${0.4 + Math.random() * 0.3}s ease-out forwards;
      `;
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 800);
    }
  }

  // === SCORE POPUP ===
  function showScorePopup(points, isPositive) {
    const popup = document.createElement('div');
    popup.className = `score-popup ${isPositive ? 'positive' : 'negative'}`;
    popup.textContent = isPositive ? `+${points}` : `${points}`;
    popup.style.left = '50%';
    popup.style.top = '40%';
    popup.style.transform = 'translateX(-50%)';
    wordDisplay.appendChild(popup);
    setTimeout(() => popup.remove(), 800);
  }

  // === GAME LOGIC ===
  function generateRound() {
    // Pick a word (the text to display)
    let wordIndex;
    do {
      wordIndex = randomInt(0, COLORS.length - 1);
    } while (wordIndex === lastWordIndex && COLORS.length > 1);
    lastWordIndex = wordIndex;

    // Pick a font color (different from the word meaning)
    let fontColorIndex;
    do {
      fontColorIndex = randomInt(0, COLORS.length - 1);
    } while (fontColorIndex === wordIndex || (fontColorIndex === lastColorIndex && COLORS.length > 2));
    lastColorIndex = fontColorIndex;

    const wordText = COLORS[wordIndex].name;
    const fontColor = COLORS[fontColorIndex];

    currentCorrectColor = fontColor;

    // Set the word
    colorWord.textContent = wordText;
    colorWord.style.color = fontColor.hex;
    colorWord.classList.remove('pop-in');
    void colorWord.offsetWidth; // Force reflow
    colorWord.classList.add('pop-in');

    // Generate button options: must include the correct answer
    let options = [fontColor];
    const available = COLORS.filter(c => c.name !== fontColor.name);
    const shuffledAvail = shuffle(available);
    for (let i = 0; options.length < BUTTONS_COUNT && i < shuffledAvail.length; i++) {
      options.push(shuffledAvail[i]);
    }
    options = shuffle(options);

    // Render buttons
    buttonsGrid.innerHTML = '';
    options.forEach(color => {
      const btn = document.createElement('button');
      btn.className = 'color-btn';
      btn.textContent = color.name;
      btn.style.background = color.btnBg;
      btn.style.boxShadow = `0 4px 15px ${color.hex}33`;
      btn.dataset.colorName = color.name;
      btn.addEventListener('click', (e) => handleAnswer(e, color, btn));
      btn.addEventListener('mousedown', (e) => createRipple(e, btn));
      buttonsGrid.appendChild(btn);
    });
  }

  function createRipple(e, btn) {
    const rect = btn.getBoundingClientRect();
    const ripple = document.createElement('span');
    ripple.className = 'ripple';
    const size = Math.max(rect.width, rect.height);
    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
    ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';
    btn.appendChild(ripple);
    setTimeout(() => ripple.remove(), 500);
  }

  function handleAnswer(e, selectedColor, btn) {
    if (!gameActive) return;

    const isCorrect = selectedColor.name === currentCorrectColor.name;

    if (isCorrect) {
      streak++;
      correctCount++;
      if (streak > bestStreak) bestStreak = streak;

      // Score: base 10 + streak bonus
      const multiplier = Math.min(streak, 5);
      const points = 10 * multiplier;
      score += points;

      // Visual feedback
      feedbackFlash.className = 'feedback-flash correct';
      btn.classList.add('correct-flash');
      setTimeout(() => btn.classList.remove('correct-flash'), 400);

      showScorePopup(points, true);
      playCorrectSound();

      // Particles
      const rect = btn.getBoundingClientRect();
      spawnParticles(rect.left + rect.width / 2, rect.top + rect.height / 2, currentCorrectColor.hex, 8);

      // Combo display
      if (streak >= 2) {
        comboDisplay.textContent = `x${multiplier} ${multiplier >= 5 ? 'MAX!' : 'COMBO'}`;
        comboDisplay.classList.add('visible');
        comboDisplay.style.color = multiplier >= 5 ? '#ff6b9d' : '#ffd740';
      }
    } else {
      streak = 0;
      wrongCount++;

      // Penalty
      const penalty = -5;
      score = Math.max(0, score + penalty);

      feedbackFlash.className = 'feedback-flash wrong';
      btn.classList.add('wrong-flash');
      setTimeout(() => btn.classList.remove('wrong-flash'), 400);

      showScorePopup(penalty, false);
      playWrongSound();

      comboDisplay.classList.remove('visible');

      // Highlight correct button
      const buttons = buttonsGrid.querySelectorAll('.color-btn');
      buttons.forEach(b => {
        if (b.dataset.colorName === currentCorrectColor.name) {
          b.style.outline = '3px solid #fff';
          b.style.outlineOffset = '2px';
          setTimeout(() => { b.style.outline = 'none'; }, 500);
        }
      });
    }

    // Update displays
    scoreDisplay.textContent = score;
    streakDisplay.textContent = streak;

    // Brief delay then next round
    setTimeout(() => {
      feedbackFlash.className = 'feedback-flash';
      if (gameActive) generateRound();
    }, isCorrect ? 200 : 450);
  }

  function startTimer() {
    timeLeft = GAME_DURATION;
    const startTime = Date.now();
    const totalMs = GAME_DURATION * 1000;

    timerInterval = setInterval(() => {
      const elapsed = Date.now() - startTime;
      const remaining = Math.max(0, totalMs - elapsed);
      timeLeft = Math.ceil(remaining / 1000);

      timerDisplay.textContent = timeLeft;
      const pct = (remaining / totalMs) * 100;
      timerBar.style.width = pct + '%';

      // Timer bar color states
      timerBar.classList.remove('warning', 'danger');
      if (pct <= 16.67) {
        timerBar.classList.add('danger');
      } else if (pct <= 33.33) {
        timerBar.classList.add('warning');
      }

      if (remaining <= 0) {
        endGame();
      }
    }, 50);
  }

  function startGame() {
    score = 0;
    streak = 0;
    bestStreak = 0;
    correctCount = 0;
    wrongCount = 0;
    gameActive = false;
    lastWordIndex = -1;
    lastColorIndex = -1;

    scoreDisplay.textContent = '0';
    timerDisplay.textContent = GAME_DURATION;
    streakDisplay.textContent = '0';
    timerBar.style.width = '100%';
    timerBar.classList.remove('warning', 'danger');
    comboDisplay.classList.remove('visible');

    showScreen(gameScreen);
    buttonsGrid.innerHTML = '';
    colorWord.textContent = '';

    // Countdown
    runCountdown(() => {
      gameActive = true;
      generateRound();
      startTimer();
    });
  }

  function runCountdown(callback) {
    countdownOverlay.style.display = 'flex';
    let count = 3;

    function tick() {
      if (count > 0) {
        countdownNumber.textContent = count;
        countdownNumber.style.animation = 'none';
        void countdownNumber.offsetWidth;
        countdownNumber.style.animation = 'countPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
        playCountdownBeep();
        count--;
        setTimeout(tick, 700);
      } else {
        countdownNumber.textContent = 'GO!';
        countdownNumber.style.color = '#00e676';
        countdownNumber.style.animation = 'none';
        void countdownNumber.offsetWidth;
        countdownNumber.style.animation = 'countPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
        playGoSound();
        setTimeout(() => {
          countdownOverlay.style.display = 'none';
          countdownNumber.style.color = '';
          callback();
        }, 500);
      }
    }

    tick();
  }

  function endGame() {
    gameActive = false;
    clearInterval(timerInterval);
    timerInterval = null;

    // Check high score
    const isNewHigh = score > highScore;
    if (isNewHigh) {
      highScore = score;
      localStorage.setItem('colorMatchHighScore', highScore);
    }

    // Populate end screen
    document.getElementById('finalScore').textContent = score;
    document.getElementById('statCorrect').textContent = correctCount;
    document.getElementById('statWrong').textContent = wrongCount;
    document.getElementById('statBestStreak').textContent = bestStreak;
    document.getElementById('highScoreDisplay').textContent = highScore;
    document.getElementById('highScoreBadge').style.display = isNewHigh ? 'block' : 'none';

    setTimeout(() => showScreen(endScreen), 300);
  }

  // === EVENT LISTENERS ===
  startBtn.addEventListener('click', () => {
    try { getAudioCtx(); } catch(e) {}
    startGame();
  });

  restartBtn.addEventListener('click', startGame);

  // Keyboard shortcuts (1-6 for buttons)
  document.addEventListener('keydown', (e) => {
    if (!gameActive) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (startScreen.classList.contains('active')) {
          try { getAudioCtx(); } catch(ex) {}
          startGame();
        } else if (endScreen.classList.contains('active')) {
          startGame();
        }
      }
      return;
    }

    const num = parseInt(e.key);
    if (num >= 1 && num <= BUTTONS_COUNT) {
      const btns = buttonsGrid.querySelectorAll('.color-btn');
      if (btns[num - 1]) {
        btns[num - 1].click();
      }
    }
  });

})();
</script>

</body>
</html>
