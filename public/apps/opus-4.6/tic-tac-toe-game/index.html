<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Tic Tac Toe — Roman Empire Edition</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Cinzel+Decorative:wght@400;700;900&family=Spectral:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --bg-primary:#f4efe5;
  --bg-secondary:#ebe5d9;
  --bg-board:rgba(255,252,245,0.88);
  --bg-cell:rgba(255,255,255,0.55);
  --bg-cell-hover:rgba(201,168,76,0.13);
  --text-primary:#2c1810;
  --text-secondary:#6b5a4e;
  --gold:#c9a84c;
  --gold-light:#e8d48b;
  --gold-dark:#a07c2a;
  --gold-glow:rgba(201,168,76,0.35);
  --border-color:rgba(201,168,76,0.35);
  --shadow-color:rgba(44,24,16,0.12);
  --win-bg:rgba(201,168,76,0.18);
  --dialog-bg:#f8f4ec;
  --dialog-border:rgba(201,168,76,0.5);
  --btn-bg:linear-gradient(180deg,#eddfa0 0%,#c9a84c 100%);
  --btn-text:#2c1810;
  --btn-hover:linear-gradient(180deg,#f4eab8 0%,#d4b35a 100%);
  --scoreboard-bg:rgba(255,252,245,0.75);
  --x-color:#8b2500;
  --o-color:#1a4a6b;
  --banner-bg:linear-gradient(135deg,rgba(212,180,80,0.96),rgba(186,148,50,0.96));
  --banner-text:#2c1810;
  --cell-shadow:0 2px 8px rgba(44,24,16,0.07);
  --header-bg:rgba(244,239,229,0.94);
  --board-border:rgba(201,168,76,0.45);
  --board-shadow:0 8px 40px rgba(44,24,16,0.12),0 2px 8px rgba(44,24,16,0.08);
  --marble-vein:rgba(180,170,150,0.08);
  --colosseum-opacity:0.035;
}

[data-theme="night"]{
  --bg-primary:#151020;
  --bg-secondary:#1e1830;
  --bg-board:rgba(28,22,40,0.92);
  --bg-cell:rgba(48,38,62,0.55);
  --bg-cell-hover:rgba(201,168,76,0.12);
  --text-primary:#e8e0d0;
  --text-secondary:#a89880;
  --gold:#d4a843;
  --gold-light:#e8c76a;
  --gold-dark:#b08a28;
  --gold-glow:rgba(212,168,67,0.3);
  --border-color:rgba(212,168,67,0.3);
  --shadow-color:rgba(0,0,0,0.35);
  --win-bg:rgba(212,168,67,0.15);
  --dialog-bg:#241c32;
  --dialog-border:rgba(212,168,67,0.4);
  --btn-bg:linear-gradient(180deg,#d4a843 0%,#b08a28 100%);
  --btn-text:#151020;
  --btn-hover:linear-gradient(180deg,#e8c76a 0%,#c9a040 100%);
  --scoreboard-bg:rgba(28,22,40,0.75);
  --x-color:#e86850;
  --o-color:#5ba8d8;
  --banner-bg:linear-gradient(135deg,rgba(212,168,67,0.95),rgba(176,138,40,0.95));
  --banner-text:#151020;
  --cell-shadow:0 2px 12px rgba(0,0,0,0.18);
  --header-bg:rgba(21,16,32,0.96);
  --board-border:rgba(212,168,67,0.3);
  --board-shadow:0 8px 50px rgba(0,0,0,0.3),0 2px 8px rgba(0,0,0,0.15);
  --marble-vein:rgba(100,80,130,0.08);
  --colosseum-opacity:0.04;
}

html,body{
  height:100%;width:100%;
  overflow:hidden;
  font-family:'Cinzel',serif;
  background:var(--bg-primary);
  color:var(--text-primary);
  transition:background 0.5s,color 0.5s;
}

body{
  display:flex;flex-direction:column;align-items:center;
  position:relative;
}

/* Subtle marble veining background */
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    repeating-linear-gradient(110deg,transparent,transparent 80px,var(--marble-vein) 80px,var(--marble-vein) 81px),
    repeating-linear-gradient(240deg,transparent,transparent 120px,var(--marble-vein) 120px,var(--marble-vein) 121px),
    repeating-linear-gradient(170deg,transparent,transparent 60px,var(--marble-vein) 60px,var(--marble-vein) 60.5px);
  opacity:0.7;
}

/* Colosseum silhouette watermark */
body::after{
  content:'';position:fixed;bottom:0;left:50%;
  transform:translateX(-50%);
  width:min(900px,120vw);height:min(350px,40vh);
  pointer-events:none;z-index:0;
  opacity:var(--colosseum-opacity);
  background:radial-gradient(ellipse 50% 100% at 50% 100%,var(--text-primary) 0%,transparent 70%);
  mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 150'%3E%3Cpath d='M0 150 L0 60 Q10 55 20 60 L20 45 Q30 40 40 45 L40 35 Q50 28 60 35 L60 30 Q70 22 80 30 L80 25 Q90 18 100 25 L100 20 Q110 12 120 20 L120 18 Q130 10 140 18 L140 15 Q155 5 170 15 L170 12 Q185 3 200 12 Q215 3 230 12 L230 15 Q245 5 260 15 L260 18 Q270 10 280 18 L280 20 Q290 12 300 20 L300 25 Q310 18 320 25 L320 30 Q330 22 340 30 L340 35 Q350 28 360 35 L360 45 Q370 40 380 45 L380 60 Q390 55 400 60 L400 150 Z' fill='white'/%3E%3C/svg%3E");
  mask-size:100% 100%;
  mask-repeat:no-repeat;
  -webkit-mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 150'%3E%3Cpath d='M0 150 L0 60 Q10 55 20 60 L20 45 Q30 40 40 45 L40 35 Q50 28 60 35 L60 30 Q70 22 80 30 L80 25 Q90 18 100 25 L100 20 Q110 12 120 20 L120 18 Q130 10 140 18 L140 15 Q155 5 170 15 L170 12 Q185 3 200 12 Q215 3 230 12 L230 15 Q245 5 260 15 L260 18 Q270 10 280 18 L280 20 Q290 12 300 20 L300 25 Q310 18 320 25 L320 30 Q330 22 340 30 L340 35 Q350 28 360 35 L360 45 Q370 40 380 45 L380 60 Q390 55 400 60 L400 150 Z' fill='white'/%3E%3C/svg%3E");
  -webkit-mask-size:100% 100%;
  -webkit-mask-repeat:no-repeat;
}

/* ===== HEADER ===== */
.header{
  width:100%;display:flex;align-items:center;justify-content:center;
  padding:0.5rem 0.8rem;
  background:var(--header-bg);
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border-color);
  z-index:10;flex-shrink:0;
  gap:0.6rem;flex-wrap:wrap;
  position:relative;
}

.header-title{
  font-family:'Cinzel Decorative',serif;font-weight:700;
  font-size:clamp(0.8rem,2.4vmin,1.2rem);
  color:var(--gold);text-shadow:0 1px 2px var(--shadow-color);
  letter-spacing:0.1em;
  display:flex;align-items:center;gap:0.45rem;
  user-select:none;
}

.spqr-crest{width:clamp(22px,3.8vmin,34px);height:clamp(22px,3.8vmin,34px);flex-shrink:0}

.header-buttons{display:flex;gap:0.35rem;flex-shrink:0}

.btn{
  font-family:'Cinzel',serif;font-weight:600;
  font-size:clamp(0.58rem,1.4vmin,0.74rem);
  padding:0.38em 0.75em;
  border:1px solid var(--gold-dark);border-radius:6px;
  background:var(--btn-bg);color:var(--btn-text);
  cursor:pointer;transition:all 0.2s;
  text-transform:uppercase;letter-spacing:0.05em;
  white-space:nowrap;
  box-shadow:0 1px 4px var(--shadow-color);
}
.btn:hover,.btn:focus-visible{
  background:var(--btn-hover);
  box-shadow:0 2px 12px var(--gold-glow);
  transform:translateY(-1px);
}
.btn:active{transform:translateY(0);box-shadow:0 1px 3px var(--shadow-color)}
.btn:focus-visible{outline:2px solid var(--gold);outline-offset:2px}

/* ===== MAIN ===== */
.main-area{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  width:100%;min-height:0;
  padding:0.4rem 0.5rem;gap:0.4rem;
  overflow:hidden;position:relative;z-index:1;
}

/* ===== STATUS ===== */
.status-area{
  text-align:center;flex-shrink:0;
  min-height:1.8em;
  display:flex;align-items:center;justify-content:center;
  width:100%;max-width:600px;
}
.status-text{
  font-family:'Cinzel',serif;font-weight:600;
  font-size:clamp(0.75rem,2vmin,1rem);
  color:var(--text-secondary);transition:color 0.3s;
}

/* ===== VICTORY BANNER ===== */
.victory-banner{
  display:none;width:100%;max-width:480px;
  padding:0.45em 1em;
  background:var(--banner-bg);color:var(--banner-text);
  border-radius:10px;text-align:center;
  font-family:'Cinzel Decorative',serif;font-weight:700;
  font-size:clamp(0.85rem,2.3vmin,1.2rem);
  letter-spacing:0.06em;
  box-shadow:0 4px 24px var(--gold-glow),inset 0 1px 0 rgba(255,255,255,0.3);
  animation:bannerIn 0.4s ease-out;
  border:1px solid var(--gold);
  flex-shrink:0;
}
.victory-banner.visible{display:block}
@keyframes bannerIn{
  from{opacity:0;transform:translateY(-6px) scale(0.97)}
  to{opacity:1;transform:translateY(0) scale(1)}
}

/* ===== SCOREBOARD ===== */
.scoreboard{
  display:flex;gap:clamp(0.7rem,2.8vmin,1.8rem);
  justify-content:center;align-items:center;
  background:var(--scoreboard-bg);
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  padding:0.35em 1.1em;border-radius:10px;
  border:1px solid var(--border-color);flex-shrink:0;
}
.score-item{display:flex;flex-direction:column;align-items:center;gap:0.05em}
.score-label{
  font-size:clamp(0.5rem,1.3vmin,0.7rem);font-weight:600;
  text-transform:uppercase;letter-spacing:0.1em;color:var(--text-secondary);
}
.score-label.x-label{color:var(--x-color)}
.score-label.o-label{color:var(--o-color)}
.score-value{
  font-family:'Cinzel Decorative',serif;
  font-size:clamp(0.95rem,2.8vmin,1.5rem);
  font-weight:900;color:var(--gold);line-height:1;
  transition:transform 0.2s;
}
.score-value.bump{animation:scoreBump 0.3s ease-out}
@keyframes scoreBump{
  0%{transform:scale(1)}40%{transform:scale(1.3)}100%{transform:scale(1)}
}
.score-divider{width:1px;height:1.8em;background:var(--border-color)}

/* ===== BOARD ===== */
.board-container{position:relative;flex-shrink:1;min-height:0}

.board{
  --board-size:min(78vmin,420px);
  width:var(--board-size);height:var(--board-size);
  display:grid;
  grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);
  gap:clamp(5px,0.9vmin,10px);
  padding:clamp(7px,1.2vmin,14px);
  background:var(--bg-board);
  border-radius:clamp(12px,2.2vmin,20px);
  border:2px solid var(--board-border);
  box-shadow:var(--board-shadow);
  position:relative;
  backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
}

/* Decorative corner accents on board */
.board::before,.board::after{
  content:'';position:absolute;
  width:clamp(16px,3vmin,28px);height:clamp(16px,3vmin,28px);
  border:2px solid var(--gold);opacity:0.4;
  pointer-events:none;
}
.board::before{top:clamp(3px,0.5vmin,6px);left:clamp(3px,0.5vmin,6px);border-right:none;border-bottom:none;border-radius:4px 0 0 0}
.board::after{bottom:clamp(3px,0.5vmin,6px);right:clamp(3px,0.5vmin,6px);border-left:none;border-top:none;border-radius:0 0 4px 0}

.cell{
  background:var(--bg-cell);
  border:1px solid var(--border-color);
  border-radius:clamp(6px,1.2vmin,12px);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all 0.2s;
  position:relative;
  box-shadow:var(--cell-shadow);
  -webkit-tap-highlight-color:transparent;
  user-select:none;
  overflow:hidden;
}
.cell:hover:not(.taken):not(.game-over){
  background:var(--bg-cell-hover);
  box-shadow:0 4px 16px var(--gold-glow);
  transform:scale(1.04);
  border-color:var(--gold);
}
.cell:active:not(.taken):not(.game-over){transform:scale(0.97)}
.cell:focus-visible{outline:3px solid var(--gold);outline-offset:-3px;z-index:2}
.cell.taken{cursor:default}
.cell.game-over{cursor:default}
.cell.win-cell{
  background:var(--win-bg);
  box-shadow:0 0 24px var(--gold-glow),inset 0 0 12px var(--gold-glow);
  border-color:var(--gold);
}

.cell-content{
  font-size:calc(var(--board-size) / 5.8);
  font-weight:900;line-height:1;
  animation:placeGlyph 0.35s cubic-bezier(0.34,1.56,0.64,1);
  display:flex;align-items:center;justify-content:center;
  width:100%;height:100%;
}
.cell-content.x-mark{color:var(--x-color)}
.cell-content.o-mark{color:var(--o-color)}

.glyph-svg{width:62%;height:62%}

@keyframes placeGlyph{
  0%{opacity:0;transform:scale(0.3) rotate(-15deg)}
  70%{transform:scale(1.06) rotate(2deg)}
  100%{opacity:1;transform:scale(1) rotate(0)}
}

/* ===== WIN LINE CANVAS ===== */
.win-line-canvas{
  position:absolute;top:0;left:0;width:100%;height:100%;
  pointer-events:none;z-index:5;
}

/* ===== CONFETTI ===== */
#confetti-canvas{
  position:fixed;top:0;left:0;width:100%;height:100%;
  pointer-events:none;z-index:100;
}

/* ===== DIALOG ===== */
.dialog-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,0.5);
  backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);
  z-index:50;align-items:center;justify-content:center;
  padding:1rem;
}
.dialog-overlay.open{display:flex;animation:fadeIn 0.2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

.dialog{
  background:var(--dialog-bg);
  border:2px solid var(--dialog-border);
  border-radius:16px;
  padding:clamp(0.9rem,2.5vmin,1.4rem);
  max-width:400px;width:100%;max-height:85vh;
  overflow-y:auto;
  box-shadow:0 20px 60px rgba(0,0,0,0.3);
  animation:dialogIn 0.3s ease-out;
}
@keyframes dialogIn{
  from{opacity:0;transform:scale(0.93) translateY(8px)}
  to{opacity:1;transform:scale(1) translateY(0)}
}
.dialog h2{
  font-family:'Cinzel Decorative',serif;
  font-size:clamp(0.95rem,2.3vmin,1.2rem);
  color:var(--gold);margin-bottom:0.8rem;text-align:center;letter-spacing:0.05em;
}
.dialog-section{margin-bottom:0.75rem}
.dialog-section label{
  display:block;font-size:clamp(0.62rem,1.6vmin,0.78rem);
  font-weight:600;color:var(--text-secondary);
  margin-bottom:0.3rem;text-transform:uppercase;letter-spacing:0.06em;
}
.option-group{display:flex;gap:0.35rem;flex-wrap:wrap}
.option-btn{
  font-family:'Cinzel',serif;font-size:clamp(0.58rem,1.4vmin,0.72rem);
  font-weight:600;padding:0.4em 0.7em;
  border:1px solid var(--border-color);border-radius:6px;
  background:var(--bg-cell);color:var(--text-primary);
  cursor:pointer;transition:all 0.2s;flex:1;min-width:0;
  text-align:center;white-space:nowrap;
}
.option-btn:hover{border-color:var(--gold);background:var(--bg-cell-hover)}
.option-btn.active{
  background:var(--btn-bg);color:var(--btn-text);
  border-color:var(--gold-dark);box-shadow:0 2px 8px var(--gold-glow);
}
.option-btn:focus-visible{outline:2px solid var(--gold);outline-offset:2px}

.dialog-close{
  display:block;margin:0.8rem auto 0;
  font-family:'Cinzel',serif;font-weight:700;
  font-size:clamp(0.65rem,1.6vmin,0.8rem);
  padding:0.45em 1.8em;border:2px solid var(--gold-dark);border-radius:8px;
  background:var(--btn-bg);color:var(--btn-text);
  cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.08em;
}
.dialog-close:hover{background:var(--btn-hover);box-shadow:0 2px 12px var(--gold-glow)}
.dialog-close:focus-visible{outline:2px solid var(--gold);outline-offset:2px}

/* ===== FOOTER ===== */
.footer{
  padding:0.25rem;text-align:center;
  font-family:'Spectral',serif;font-style:italic;
  font-size:clamp(0.5rem,1.2vmin,0.65rem);
  color:var(--text-secondary);opacity:0.5;flex-shrink:0;
  position:relative;z-index:1;
}

/* ===== RESPONSIVE ===== */
@media (max-height:640px){
  .board{--board-size:min(68vmin,320px)}
  .header{padding:0.3rem 0.5rem}
  .scoreboard{padding:0.25em 0.8em}
  .status-area{min-height:1.4em}
  .main-area{gap:0.25rem;padding:0.25rem 0.5rem}
}
@media (max-height:500px){
  .board{--board-size:min(58vmin,280px)}
  .victory-banner{padding:0.3em 0.8em;font-size:clamp(0.7rem,2vmin,1rem)}
}
@media (max-width:400px){
  .header{gap:0.25rem;padding:0.35rem 0.4rem}
  .header-title{font-size:0.72rem}
  .btn{font-size:0.56rem;padding:0.3em 0.55em}
}
@media (min-width:768px) and (min-height:800px){
  .board{--board-size:min(72vmin,480px)}
}

@media (prefers-reduced-motion:reduce){
  *,*::before,*::after{
    animation-duration:0.01ms!important;
    transition-duration:0.01ms!important;
  }
}

.dialog::-webkit-scrollbar{width:5px}
.dialog::-webkit-scrollbar-track{background:transparent}
.dialog::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}
</style>
</head>
<body>

<header class="header">
  <div class="header-title">
    <svg class="spqr-crest" viewBox="0 0 100 100" aria-hidden="true">
      <defs>
        <linearGradient id="gG" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#e8d48b"/><stop offset="100%" stop-color="#a07c2a"/>
        </linearGradient>
      </defs>
      <path d="M50 5 L88 20 L88 54 Q88 82 50 98 Q12 82 12 54 L12 20 Z" fill="none" stroke="url(#gG)" stroke-width="2.5"/>
      <path d="M50 11 L82 24 L82 52 Q82 76 50 91 Q18 76 18 52 L18 24 Z" fill="url(#gG)" opacity="0.08"/>
      <!-- Eagle -->
      <path d="M50 32 L26 16 L18 26 L38 36 Z" fill="url(#gG)" opacity="0.85"/>
      <path d="M50 32 L74 16 L82 26 L62 36 Z" fill="url(#gG)" opacity="0.85"/>
      <path d="M50 32 L32 20 L28 24 L42 34 Z" fill="url(#gG)" opacity="0.6"/>
      <path d="M50 32 L68 20 L72 24 L58 34 Z" fill="url(#gG)" opacity="0.6"/>
      <ellipse cx="50" cy="40" rx="7" ry="9" fill="url(#gG)" opacity="0.8"/>
      <circle cx="50" cy="28" r="4.5" fill="url(#gG)"/>
      <path d="M48 27 L44 25" stroke="url(#gG)" stroke-width="1.2" stroke-linecap="round" fill="none"/>
      <!-- Laurels under eagle -->
      <path d="M36 48 Q34 56 38 62 Q34 58 33 52 Z" fill="url(#gG)" opacity="0.5"/>
      <path d="M64 48 Q66 56 62 62 Q66 58 67 52 Z" fill="url(#gG)" opacity="0.5"/>
      <text x="50" y="76" text-anchor="middle" font-family="'Cinzel',serif" font-size="13" font-weight="900" fill="url(#gG)" letter-spacing="2">SPQR</text>
    </svg>
    <span>Tic Tac Toe</span>
  </div>
  <div class="header-buttons">
    <button class="btn" id="btn-new-round" title="Start a new round">New Round</button>
    <button class="btn" id="btn-customize" title="Customize settings">Customize</button>
    <button class="btn" id="btn-reset-scores" title="Reset all scores">Reset Scores</button>
  </div>
</header>

<main class="main-area">
  <div class="status-area">
    <div class="status-text" id="status" role="status" aria-live="polite">Player X's turn</div>
  </div>
  <div class="victory-banner" id="victory-banner" role="alert" aria-live="assertive"></div>
  <div class="scoreboard" aria-label="Scoreboard">
    <div class="score-item">
      <span class="score-label x-label" id="score-x-label">X</span>
      <span class="score-value" id="score-x">0</span>
    </div>
    <div class="score-divider" aria-hidden="true"></div>
    <div class="score-item">
      <span class="score-label">Draws</span>
      <span class="score-value" id="score-draw">0</span>
    </div>
    <div class="score-divider" aria-hidden="true"></div>
    <div class="score-item">
      <span class="score-label o-label" id="score-o-label">O</span>
      <span class="score-value" id="score-o">0</span>
    </div>
  </div>
  <div class="board-container">
    <div class="board" id="board" role="grid" aria-label="Tic Tac Toe board"></div>
    <canvas class="win-line-canvas" id="win-line-canvas" aria-hidden="true"></canvas>
  </div>
</main>

<footer class="footer"><em>"Veni, Vidi, Vici"</em> — Julius Caesar</footer>

<canvas id="confetti-canvas" aria-hidden="true"></canvas>

<div class="dialog-overlay" id="dialog-overlay" role="dialog" aria-modal="true" aria-label="Customize game settings">
  <div class="dialog" id="dialog">
    <h2>Customize</h2>
    <div class="dialog-section">
      <label>Theme</label>
      <div class="option-group" id="opt-theme">
        <button class="option-btn active" data-val="day">Marble Day</button>
        <button class="option-btn" data-val="night">Night Legion</button>
      </div>
    </div>
    <div class="dialog-section">
      <label>Glyphs</label>
      <div class="option-group" id="opt-glyphs">
        <button class="option-btn active" data-val="standard">Standard X / O</button>
        <button class="option-btn" data-val="roman">Gladius / Laurel</button>
      </div>
    </div>
    <div class="dialog-section">
      <label>Mode</label>
      <div class="option-group" id="opt-mode">
        <button class="option-btn active" data-val="2p">2 Players</button>
        <button class="option-btn" data-val="ai">vs AI</button>
      </div>
    </div>
    <div class="dialog-section">
      <label>First Move</label>
      <div class="option-group" id="opt-first">
        <button class="option-btn active" data-val="X">X Goes First</button>
        <button class="option-btn" data-val="O">O Goes First</button>
      </div>
    </div>
    <div class="dialog-section" id="ai-discipline-section" style="display:none">
      <label>AI Discipline</label>
      <div class="option-group" id="opt-ai">
        <button class="option-btn" data-val="perfect">Perfect</button>
        <button class="option-btn active" data-val="pragmatic">Pragmatic</button>
        <button class="option-btn" data-val="reckless">Reckless</button>
      </div>
    </div>
    <button class="dialog-close" id="dialog-close">Close</button>
  </div>
</div>

<!-- Hidden SVG defs for glyphs (avoids duplicate IDs) -->
<svg style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true">
  <defs>
    <linearGradient id="gl-blade-day" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#b83828"/><stop offset="100%" stop-color="#6b1800"/>
    </linearGradient>
    <linearGradient id="gl-blade-night" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#f08060"/><stop offset="100%" stop-color="#c04030"/>
    </linearGradient>
    <linearGradient id="gl-leaf-day" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#2a7090"/><stop offset="100%" stop-color="#1a4a6b"/>
    </linearGradient>
    <linearGradient id="gl-leaf-night" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#78c0f0"/><stop offset="100%" stop-color="#4890c0"/>
    </linearGradient>
    <linearGradient id="gl-gold" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#e8d48b"/><stop offset="100%" stop-color="#a07c2a"/>
    </linearGradient>
    <linearGradient id="gl-grip-day" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#7a5030"/><stop offset="100%" stop-color="#5a3018"/>
    </linearGradient>
    <linearGradient id="gl-grip-night" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#a07050"/><stop offset="100%" stop-color="#705030"/>
    </linearGradient>
  </defs>
</svg>

<script>
(function(){
'use strict';

/* ===== STATE ===== */
const S = {
  board: Array(9).fill(null),
  cur: 'X',
  over: false,
  winner: null,
  winCells: [],
  scores: {X:0,O:0,D:0},
  set: {
    theme:'day', glyphs:'standard', mode:'2p',
    firstMove:'X', aiDiscipline:'pragmatic'
  },
  aiThinking: false
};

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const boardEl = $('board');
const statusEl = $('status');
const bannerEl = $('victory-banner');
const scoreXEl = $('score-x');
const scoreOEl = $('score-o');
const scoreDrawEl = $('score-draw');
const labelX = $('score-x-label');
const labelO = $('score-o-label');
const confCanvas = $('confetti-canvas');
const confCtx = confCanvas.getContext('2d');
const winCanvas = $('win-line-canvas');
const winCtx = winCanvas.getContext('2d');
const overlay = $('dialog-overlay');
const aiSec = $('ai-discipline-section');

const WINS = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

/* ===== GLYPHS ===== */
function glyphHTML(player, isWin) {
  if (S.set.glyphs === 'standard') {
    return `<div class="cell-content ${player==='X'?'x-mark':'o-mark'}">${player}</div>`;
  }
  const night = S.set.theme === 'night';
  const cls = player === 'X' ? 'x-mark' : 'o-mark';
  let svg;
  if (player === 'X') {
    const blade = night ? 'url(#gl-blade-night)' : 'url(#gl-blade-day)';
    const grip = night ? 'url(#gl-grip-night)' : 'url(#gl-grip-day)';
    const stroke = night ? '#f08060' : '#8b2500';
    svg = `<svg class="glyph-svg" viewBox="0 0 100 100">
      <path d="M50 6 L57 58 L50 68 L43 58 Z" fill="${blade}" stroke="${stroke}" stroke-width="0.8" opacity="0.95"/>
      <line x1="50" y1="12" x2="50" y2="55" stroke="rgba(255,255,255,0.15)" stroke-width="1.5"/>
      <rect x="34" y="61" width="32" height="5.5" rx="2.5" fill="url(#gl-gold)" stroke="#a07c2a" stroke-width="0.5"/>
      <rect x="45" y="66.5" width="10" height="17" rx="2.5" fill="${grip}"/>
      <line x1="47" y1="70" x2="47" y2="80" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/>
      <circle cx="50" cy="88" r="5.5" fill="url(#gl-gold)" stroke="#a07c2a" stroke-width="0.5"/>
      <circle cx="50" cy="88" r="2" fill="rgba(255,255,255,0.15)"/>
    </svg>`;
  } else {
    const leaf = night ? 'url(#gl-leaf-night)' : 'url(#gl-leaf-day)';
    const lstroke = night ? '#5ba8d8' : '#1a4a6b';
    svg = `<svg class="glyph-svg" viewBox="0 0 100 100">
      <path d="M44 86 Q30 70 28 48 Q26 28 36 16" fill="none" stroke="${lstroke}" stroke-width="2.2" stroke-linecap="round" opacity="0.7"/>
      <path d="M56 86 Q70 70 72 48 Q74 28 64 16" fill="none" stroke="${lstroke}" stroke-width="2.2" stroke-linecap="round" opacity="0.7"/>
      <ellipse cx="33" cy="24" rx="8" ry="4.5" transform="rotate(-35 33 24)" fill="${leaf}" opacity="0.92"/>
      <ellipse cx="28" cy="36" rx="8" ry="4.5" transform="rotate(-18 28 36)" fill="${leaf}" opacity="0.88"/>
      <ellipse cx="27" cy="50" rx="8" ry="4.5" transform="rotate(0 27 50)" fill="${leaf}" opacity="0.82"/>
      <ellipse cx="29" cy="63" rx="7.5" ry="4" transform="rotate(16 29 63)" fill="${leaf}" opacity="0.76"/>
      <ellipse cx="35" cy="76" rx="7" ry="3.8" transform="rotate(32 35 76)" fill="${leaf}" opacity="0.7"/>
      <ellipse cx="67" cy="24" rx="8" ry="4.5" transform="rotate(35 67 24)" fill="${leaf}" opacity="0.92"/>
      <ellipse cx="72" cy="36" rx="8" ry="4.5" transform="rotate(18 72 36)" fill="${leaf}" opacity="0.88"/>
      <ellipse cx="73" cy="50" rx="8" ry="4.5" transform="rotate(0 73 50)" fill="${leaf}" opacity="0.82"/>
      <ellipse cx="71" cy="63" rx="7.5" ry="4" transform="rotate(-16 71 63)" fill="${leaf}" opacity="0.76"/>
      <ellipse cx="65" cy="76" rx="7" ry="3.8" transform="rotate(-32 65 76)" fill="${leaf}" opacity="0.7"/>
      <circle cx="50" cy="12" r="4" fill="url(#gl-gold)"/>
      <path d="M47 12 L50 7 L53 12" fill="none" stroke="#e8d48b" stroke-width="1" stroke-linecap="round"/>
    </svg>`;
  }
  return `<div class="cell-content ${cls}">${svg}</div>`;
}

function playerName(p) {
  return S.set.glyphs === 'roman' ? (p === 'X' ? 'Gladius' : 'Laurel') : `Player ${p}`;
}

/* ===== BOARD ===== */
function createBoard() {
  boardEl.innerHTML = '';
  for (let i = 0; i < 9; i++) {
    const c = document.createElement('div');
    c.className = 'cell';
    c.setAttribute('role','gridcell');
    c.setAttribute('tabindex','0');
    c.setAttribute('aria-label',`Row ${Math.floor(i/3)+1}, Column ${(i%3)+1}: empty`);
    c.dataset.idx = i;
    c.addEventListener('click', () => cellClick(i));
    c.addEventListener('keydown', e => cellKey(e, i));
    boardEl.appendChild(c);
  }
}

function render() {
  const cells = boardEl.children;
  for (let i = 0; i < 9; i++) {
    const c = cells[i], v = S.board[i], w = S.winCells.includes(i);
    c.className = 'cell' + (v ? ' taken' : '') + (S.over ? ' game-over' : '') + (w ? ' win-cell' : '');
    c.innerHTML = v ? glyphHTML(v, w) : '';
    c.setAttribute('aria-label',`Row ${Math.floor(i/3)+1}, Column ${(i%3)+1}: ${v||'empty'}`);
  }
}

/* ===== GAME LOGIC ===== */
function cellClick(i) {
  if (S.over || S.board[i] || S.aiThinking) return;
  if (S.set.mode === 'ai' && S.cur === 'O') return;
  makeMove(i);
}

function cellKey(e, i) {
  if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); cellClick(i); return; }
  const cells = boardEl.children;
  let n = i;
  if (e.key==='ArrowRight') n = i%3<2 ? i+1 : i;
  else if (e.key==='ArrowLeft') n = i%3>0 ? i-1 : i;
  else if (e.key==='ArrowDown') n = i+3<9 ? i+3 : i;
  else if (e.key==='ArrowUp') n = i-3>=0 ? i-3 : i;
  if (n !== i) { e.preventDefault(); cells[n].focus(); }
}

function makeMove(i) {
  S.board[i] = S.cur;
  render();
  const res = checkWin();
  if (res) { endGame(res); return; }
  S.cur = S.cur === 'X' ? 'O' : 'X';
  updateStatus();
  if (S.set.mode === 'ai' && S.cur === 'O' && !S.over) {
    S.aiThinking = true;
    updateStatus();
    setTimeout(() => { S.aiThinking = false; aiMove(); }, 350);
  }
}

function checkWin() {
  for (const [a,b,c] of WINS) {
    if (S.board[a] && S.board[a]===S.board[b] && S.board[a]===S.board[c])
      return {winner:S.board[a], cells:[a,b,c]};
  }
  return S.board.every(x=>x!==null) ? {winner:null,cells:[]} : null;
}

function endGame(r) {
  S.over = true; S.winner = r.winner; S.winCells = r.cells;
  if (r.winner) {
    S.scores[r.winner]++;
    const n = playerName(r.winner);
    bannerEl.textContent = `${n} Triumphant!`;
    statusEl.textContent = `${n} wins!`;
    drawWinLine(r.cells);
    if (!reducedMotion()) launchConfetti();
  } else {
    S.scores.D++;
    bannerEl.textContent = 'A Draw \u2014 Pax Romana';
    statusEl.textContent = 'Draw!';
  }
  bannerEl.classList.add('visible');
  render();
  updateScores();
}

function updateStatus() {
  if (S.over) return;
  const n = playerName(S.cur);
  statusEl.textContent = (S.set.mode === 'ai' && S.cur === 'O')
    ? 'The Senate deliberates\u2026' : `${n}'s turn`;
}

function updateScores() {
  animateScore(scoreXEl, S.scores.X);
  animateScore(scoreOEl, S.scores.O);
  animateScore(scoreDrawEl, S.scores.D);
  labelX.textContent = S.set.glyphs === 'roman' ? 'Gladius' : 'X';
  labelO.textContent = S.set.glyphs === 'roman' ? 'Laurel' : 'O';
}

function animateScore(el, val) {
  if (el.textContent !== String(val)) {
    el.textContent = val;
    el.classList.remove('bump');
    void el.offsetWidth; // reflow
    el.classList.add('bump');
  }
}

/* ===== WIN LINE ===== */
function drawWinLine(cells) {
  const bRect = boardEl.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  winCanvas.width = bRect.width * dpr;
  winCanvas.height = bRect.height * dpr;
  winCanvas.style.width = bRect.width + 'px';
  winCanvas.style.height = bRect.height + 'px';

  const cont = boardEl.parentElement.getBoundingClientRect();
  winCanvas.style.position = 'absolute';
  winCanvas.style.top = (bRect.top - cont.top) + 'px';
  winCanvas.style.left = (bRect.left - cont.left) + 'px';

  const cEls = boardEl.children;
  const s = cEls[cells[0]].getBoundingClientRect();
  const e = cEls[cells[2]].getBoundingClientRect();
  const x1 = (s.left + s.width/2 - bRect.left) * dpr;
  const y1 = (s.top + s.height/2 - bRect.top) * dpr;
  const x2 = (e.left + e.width/2 - bRect.left) * dpr;
  const y2 = (e.top + e.height/2 - bRect.top) * dpr;

  const ctx = winCtx;
  ctx.clearRect(0, 0, winCanvas.width, winCanvas.height);

  const goldHex = S.set.theme === 'night' ? '#d4a843' : '#c9a84c';
  const glowHex = S.set.theme === 'night' ? 'rgba(212,168,67,0.5)' : 'rgba(201,168,76,0.5)';
  const lw = Math.max(3, bRect.width * 0.014) * dpr;

  if (reducedMotion()) {
    ctx.strokeStyle = goldHex;
    ctx.lineWidth = lw;
    ctx.lineCap = 'round';
    ctx.shadowColor = glowHex;
    ctx.shadowBlur = 10 * dpr;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    return;
  }

  const dur = 380;
  const t0 = performance.now();
  (function anim(t) {
    const p = Math.min((t - t0) / dur, 1);
    const ep = 1 - Math.pow(1 - p, 3);
    ctx.clearRect(0, 0, winCanvas.width, winCanvas.height);
    // Glow layer
    ctx.strokeStyle = glowHex;
    ctx.lineWidth = lw * 2.5;
    ctx.lineCap = 'round';
    ctx.shadowColor = glowHex;
    ctx.shadowBlur = 16 * dpr;
    ctx.beginPath(); ctx.moveTo(x1,y1);
    ctx.lineTo(x1+(x2-x1)*ep, y1+(y2-y1)*ep); ctx.stroke();
    // Core line
    ctx.shadowBlur = 0;
    ctx.strokeStyle = goldHex;
    ctx.lineWidth = lw;
    ctx.beginPath(); ctx.moveTo(x1,y1);
    ctx.lineTo(x1+(x2-x1)*ep, y1+(y2-y1)*ep); ctx.stroke();
    if (p < 1) requestAnimationFrame(anim);
  })(t0);
}

/* ===== CONFETTI (canvas-based) ===== */
function reducedMotion() { return window.matchMedia('(prefers-reduced-motion:reduce)').matches; }

let confParts = [], confAnim = null;

function launchConfetti() {
  const W = confCanvas.width = window.innerWidth;
  const H = confCanvas.height = window.innerHeight;
  confParts = [];
  const cols = ['#c9a84c','#e8d48b','#a07c2a','#8b2500','#1a4a6b','#e06040','#5ba0d0','#f5f0e8','#d4a843'];
  for (let i = 0; i < 150; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = 4 + Math.random() * 10;
    confParts.push({
      x: W/2 + (Math.random()-0.5)*W*0.3,
      y: H*0.35 + (Math.random()-0.5)*H*0.1,
      vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed - 6,
      w: 3 + Math.random()*7, h: 2 + Math.random()*5,
      color: cols[Math.floor(Math.random()*cols.length)],
      rot: Math.random()*360,
      rotV: (Math.random()-0.5)*14,
      grav: 0.15 + Math.random()*0.1,
      op: 1, decay: 0.004 + Math.random()*0.004,
      shape: Math.random() > 0.5 ? 'rect' : 'circle'
    });
  }
  if (confAnim) cancelAnimationFrame(confAnim);
  animConfetti();
}

function animConfetti() {
  const W = confCanvas.width, H = confCanvas.height;
  confCtx.clearRect(0,0,W,H);
  let alive = false;
  for (const p of confParts) {
    if (p.op <= 0) continue;
    alive = true;
    p.x += p.vx; p.vy += p.grav; p.y += p.vy;
    p.vx *= 0.99; p.rot += p.rotV; p.op -= p.decay;
    if (p.y > H+30) { p.op = 0; continue; }
    confCtx.save();
    confCtx.translate(p.x, p.y);
    confCtx.rotate(p.rot * Math.PI/180);
    confCtx.globalAlpha = Math.max(0, p.op);
    confCtx.fillStyle = p.color;
    if (p.shape === 'circle') {
      confCtx.beginPath();
      confCtx.ellipse(0, 0, p.w/2, p.h/2, 0, 0, Math.PI*2);
      confCtx.fill();
    } else {
      confCtx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
    }
    confCtx.restore();
  }
  confAnim = alive ? requestAnimationFrame(animConfetti) : (confCtx.clearRect(0,0,W,H), null);
}

/* ===== AI (minimax + alpha-beta) ===== */
function aiMove() {
  if (S.over) return;
  const d = S.set.aiDiscipline;
  let m;
  if (d === 'perfect') m = bestMove();
  else if (d === 'pragmatic') m = Math.random() < 0.72 ? bestMove() : randMove();
  else m = Math.random() < 0.28 ? bestMove() : randMove();
  if (m != null) makeMove(m);
}

function randMove() {
  const e = S.board.reduce((a,v,i) => v===null ? [...a,i] : a, []);
  return e.length ? e[Math.floor(Math.random()*e.length)] : null;
}

function bestMove() {
  let best = -Infinity, bi = null;
  for (let i = 0; i < 9; i++) {
    if (S.board[i] !== null) continue;
    S.board[i] = 'O';
    const s = mm(S.board, 0, false, -Infinity, Infinity);
    S.board[i] = null;
    if (s > best) { best = s; bi = i; }
  }
  return bi;
}

function mm(b, d, mx, a, bt) {
  for (const [x,y,z] of WINS) {
    if (b[x] && b[x]===b[y] && b[x]===b[z])
      return b[x]==='O' ? 10-d : d-10;
  }
  if (b.every(c=>c!==null)) return 0;
  if (mx) {
    let best = -Infinity;
    for (let i=0;i<9;i++) {
      if (b[i]!==null) continue;
      b[i]='O'; best=Math.max(best, mm(b,d+1,false,a,bt)); b[i]=null;
      a=Math.max(a,best); if(bt<=a) break;
    }
    return best;
  } else {
    let best = Infinity;
    for (let i=0;i<9;i++) {
      if (b[i]!==null) continue;
      b[i]='X'; best=Math.min(best, mm(b,d+1,true,a,bt)); b[i]=null;
      bt=Math.min(bt,best); if(bt<=a) break;
    }
    return best;
  }
}

/* ===== NEW ROUND / RESET ===== */
function newRound() {
  S.board = Array(9).fill(null);
  S.cur = S.set.firstMove; S.over = false;
  S.winner = null; S.winCells = []; S.aiThinking = false;
  bannerEl.classList.remove('visible'); bannerEl.textContent = '';
  winCtx.clearRect(0, 0, winCanvas.width, winCanvas.height);
  if (confAnim) { cancelAnimationFrame(confAnim); confCtx.clearRect(0,0,confCanvas.width,confCanvas.height); confAnim=null; }
  render(); updateStatus();
  if (S.set.mode==='ai' && S.cur==='O') {
    S.aiThinking = true; updateStatus();
    setTimeout(() => { S.aiThinking = false; aiMove(); }, 450);
  }
}

function resetScores() {
  S.scores = {X:0,O:0,D:0};
  scoreXEl.textContent = '0'; scoreOEl.textContent = '0'; scoreDrawEl.textContent = '0';
  newRound();
}

/* ===== DIALOG ===== */
function openDialog() {
  overlay.classList.add('open');
  aiSec.style.display = S.set.mode==='ai' ? '' : 'none';
  $('dialog-close').focus();
  document.addEventListener('keydown', escHandler);
}

function closeDialog() {
  overlay.classList.remove('open');
  document.removeEventListener('keydown', escHandler);
  $('btn-customize').focus();
}

function escHandler(e) { if (e.key==='Escape') closeDialog(); }

function initOpts() {
  const groups = {
    'opt-theme': {k:'theme', fn: applyTheme},
    'opt-glyphs': {k:'glyphs', fn:() => { render(); updateScores(); updateStatus(); }},
    'opt-mode': {k:'mode', fn:() => { aiSec.style.display = S.set.mode==='ai'?'':'none'; newRound(); }},
    'opt-first': {k:'firstMove', fn:newRound},
    'opt-ai': {k:'aiDiscipline', fn:()=>{}}
  };
  for (const [id, cfg] of Object.entries(groups)) {
    const btns = $(id).querySelectorAll('.option-btn');
    btns.forEach(b => {
      if (b.dataset.val === S.set[cfg.k]) b.classList.add('active');
      else b.classList.remove('active');
      b.addEventListener('click', () => {
        btns.forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        S.set[cfg.k] = b.dataset.val;
        cfg.fn();
      });
    });
  }
}

function applyTheme() {
  if (S.set.theme==='night') document.documentElement.setAttribute('data-theme','night');
  else document.documentElement.removeAttribute('data-theme');
  render();
}

/* ===== EVENTS ===== */
$('btn-new-round').addEventListener('click', newRound);
$('btn-reset-scores').addEventListener('click', resetScores);
$('btn-customize').addEventListener('click', openDialog);
$('dialog-close').addEventListener('click', closeDialog);
overlay.addEventListener('click', e => { if (e.target===overlay) closeDialog(); });

let resizeT;
window.addEventListener('resize', () => {
  clearTimeout(resizeT);
  resizeT = setTimeout(() => {
    if (S.over && S.winCells.length) drawWinLine(S.winCells);
    confCanvas.width = window.innerWidth;
    confCanvas.height = window.innerHeight;
  }, 120);
});

/* ===== INIT ===== */
createBoard();
initOpts();
updateScores();
updateStatus();

})();
</script>
</body>
</html>
