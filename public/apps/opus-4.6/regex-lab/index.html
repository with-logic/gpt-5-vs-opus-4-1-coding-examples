<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Regex Lab</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root {
  --font-mono: 'SF Mono','Cascadia Code','Fira Code','JetBrains Mono','Consolas','Monaco',monospace;
  --radius: 8px;
  --radius-sm: 4px;
  --tr: 0.2s ease;
}

[data-theme="dark"] {
  --bg-0: #0a0e14;
  --bg-1: #111820;
  --bg-2: #161d27;
  --bg-3: #1b2432;
  --bg-input: #0d1219;
  --bg-hover: #1e2a3a;
  --border: #253040;
  --border-focus: #58a6ff;
  --text-1: #e2e8f0;
  --text-2: #8899aa;
  --text-3: #556677;
  --accent: #58a6ff;
  --error: #f85149;
  --success: #3fb950;
  --title-bg: #151c25;
  --dot-r: #ff5f57; --dot-y: #febc2e; --dot-g: #28c840;
  --scroll-t: #253040;
  --badge-bg: rgba(88,166,255,0.12);
  --badge-c: #58a6ff;
  --shadow: 0 16px 48px rgba(0,0,0,0.5);
}

[data-theme="light"] {
  --bg-0: #f5f7fa;
  --bg-1: #ffffff;
  --bg-2: #f0f3f7;
  --bg-3: #e8ecf2;
  --bg-input: #ffffff;
  --bg-hover: #e4e8ee;
  --border: #d0d7e0;
  --border-focus: #0969da;
  --text-1: #1a2030;
  --text-2: #606878;
  --text-3: #8892a0;
  --accent: #0969da;
  --error: #cf222e;
  --success: #1a7f37;
  --title-bg: #e8ecf0;
  --dot-r: #ff5f57; --dot-y: #febc2e; --dot-g: #28c840;
  --scroll-t: #c5ccd5;
  --badge-bg: rgba(9,105,218,0.08);
  --badge-c: #0969da;
  --shadow: 0 16px 48px rgba(0,0,0,0.1);
}

::-webkit-scrollbar{width:7px;height:7px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--scroll-t);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--text-3)}

html{font-size:14px}
body{font-family:var(--font-mono);background:var(--bg-0);color:var(--text-1);min-height:100vh;transition:background var(--tr),color var(--tr);line-height:1.6}

/* ===== Terminal Window ===== */
.win{max-width:1200px;margin:24px auto;border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);background:var(--bg-1)}
.titlebar{background:var(--title-bg);padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);user-select:none}
.dots{display:flex;gap:8px}
.dot{width:12px;height:12px;border-radius:50%;transition:opacity var(--tr)}
.dot:hover{opacity:0.8}
.dot.r{background:var(--dot-r)}.dot.y{background:var(--dot-y)}.dot.g{background:var(--dot-g)}
.title{flex:1;text-align:center;font-size:12px;color:var(--text-2);font-weight:500;letter-spacing:0.5px}
.title-actions{display:flex;gap:6px;align-items:center}
.tbtn{background:transparent;border:1px solid var(--border);color:var(--text-2);padding:4px 10px;border-radius:var(--radius-sm);cursor:pointer;font-family:var(--font-mono);font-size:11px;transition:all var(--tr);display:flex;align-items:center;gap:5px}
.tbtn:hover{background:var(--bg-hover);color:var(--text-1);border-color:var(--text-3)}

/* ===== Content ===== */
.content{padding:20px;display:flex;flex-direction:column;gap:14px}

/* ===== Pattern Input ===== */
.pat-row{display:flex;gap:8px;align-items:stretch}
.pat-wrap{flex:1;display:flex;align-items:center;background:var(--bg-input);border:2px solid var(--border);border-radius:var(--radius);padding:0 14px;transition:all var(--tr);position:relative}
.pat-wrap:focus-within{border-color:var(--border-focus);box-shadow:0 0 0 3px rgba(88,166,255,0.12)}
.pat-wrap.err{border-color:var(--error);box-shadow:0 0 0 3px rgba(248,81,73,0.12)}
.pat-slash{color:var(--text-3);font-size:20px;font-weight:300;user-select:none}
.pat-input{flex:1;background:transparent;border:none;outline:none;color:var(--text-1);font-family:var(--font-mono);font-size:16px;padding:10px 6px;min-width:0}
.pat-input::placeholder{color:var(--text-3)}
.flags-disp{color:var(--accent);font-size:16px;user-select:none;min-width:16px;font-weight:500}

/* ===== Flags ===== */
.flags-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.lbl{font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-right:4px}
.fbtn{background:var(--bg-3);border:1px solid var(--border);color:var(--text-2);padding:4px 10px;border-radius:var(--radius-sm);cursor:pointer;font-family:var(--font-mono);font-size:12px;transition:all var(--tr);min-width:30px;text-align:center}
.fbtn:hover{background:var(--bg-hover);color:var(--text-1)}
.fbtn.on{background:var(--badge-bg);color:var(--badge-c);border-color:var(--badge-c);font-weight:600}
.flag-desc{font-size:10px;color:var(--text-3);margin-left:6px;transition:color var(--tr)}

/* ===== Quick Inserts ===== */
.qi{display:flex;gap:4px;flex-wrap:wrap;align-items:center}
.qbtn{background:var(--bg-3);border:1px solid var(--border);color:var(--text-2);padding:3px 7px;border-radius:var(--radius-sm);cursor:pointer;font-family:var(--font-mono);font-size:11px;transition:all var(--tr);white-space:nowrap}
.qbtn:hover{background:var(--bg-hover);color:var(--text-1);border-color:var(--text-3);transform:translateY(-1px)}

/* ===== Error ===== */
.err-box{background:rgba(248,81,73,0.06);border:1px solid rgba(248,81,73,0.25);border-radius:var(--radius);padding:10px 14px;display:none;font-size:12px;backdrop-filter:blur(4px)}
.err-box.vis{display:block;animation:fadeIn 0.15s ease}
.err-title{color:var(--error);font-weight:700;margin-bottom:3px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px}
.err-msg{color:var(--error);opacity:0.9;font-size:12px}
.err-caret{color:var(--error);font-weight:bold;white-space:pre;font-size:13px;line-height:1.3}

/* ===== Test Text ===== */
.section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.section-title{font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:1px;font-weight:700}
.mcount .num{color:var(--accent);font-weight:700}
.mcount{font-size:11px;color:var(--text-3)}

.tt-container{position:relative;border:2px solid var(--border);border-radius:var(--radius);overflow:hidden;background:var(--bg-input);transition:border-color var(--tr)}
.tt-container:focus-within{border-color:var(--border-focus);box-shadow:0 0 0 3px rgba(88,166,255,0.08)}

.tt-backdrop{position:absolute;top:0;left:0;right:0;bottom:0;padding:12px 14px;font-family:var(--font-mono);font-size:14px;line-height:1.6;white-space:pre-wrap;word-wrap:break-word;overflow-y:auto;pointer-events:none;color:transparent;border:2px solid transparent}

.tt-input{width:100%;min-height:140px;background:transparent;border:none;outline:none;color:var(--text-1);font-family:var(--font-mono);font-size:14px;line-height:1.6;padding:12px 14px;resize:vertical;position:relative;z-index:1;caret-color:var(--text-1)}
.tt-input::placeholder{color:var(--text-3)}

.tt-container.hl .tt-input{color:transparent}
.tt-container:not(.hl) .tt-backdrop{display:none}

/* Highlights */
.hl-m{border-radius:3px;padding:1px 0;position:relative}
.hl-m-0{background:rgba(255,107,107,0.25);box-shadow:0 0 0 1px rgba(255,107,107,0.45)}
.hl-m-1{background:rgba(81,207,102,0.25);box-shadow:0 0 0 1px rgba(81,207,102,0.45)}
.hl-m-2{background:rgba(51,154,240,0.25);box-shadow:0 0 0 1px rgba(51,154,240,0.45)}
.hl-m-3{background:rgba(252,196,25,0.25);box-shadow:0 0 0 1px rgba(252,196,25,0.45)}
.hl-m-4{background:rgba(204,93,232,0.25);box-shadow:0 0 0 1px rgba(204,93,232,0.45)}
.hl-m-5{background:rgba(255,146,43,0.25);box-shadow:0 0 0 1px rgba(255,146,43,0.45)}
.hl-m-6{background:rgba(32,201,151,0.25);box-shadow:0 0 0 1px rgba(32,201,151,0.45)}
.hl-m-7{background:rgba(229,153,247,0.25);box-shadow:0 0 0 1px rgba(229,153,247,0.45)}

.hl-g{border-radius:2px;border-bottom:2px solid}

/* ===== Output Panels ===== */
.out-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:768px){.out-grid{grid-template-columns:1fr}}

.panel{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column}
.panel-hdr{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--bg-1)}
.panel-title{font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:1px;font-weight:700}
.panel-body{padding:12px 14px;overflow-y:auto;max-height:380px;min-height:80px;flex:1}
.panel-body.scroll-p{padding:0}
.panel-empty{color:var(--text-3);font-size:12px;text-align:center;padding:32px 20px;line-height:1.8}

/* ===== Matches Table ===== */
.mt{width:100%;border-collapse:collapse;font-size:12px}
.mt th{text-align:left;padding:7px 10px;border-bottom:1px solid var(--border);color:var(--text-3);font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;position:sticky;top:0;background:var(--bg-2);z-index:1}
.mt td{padding:5px 10px;border-bottom:1px solid rgba(128,128,128,0.1);vertical-align:top;color:var(--text-1)}
.mt tr:last-child td{border-bottom:none}
.mt tr:hover td{background:var(--bg-hover)}
.mt .idx{color:var(--text-3);font-size:10px;font-weight:500}
.mt .val{font-weight:500;word-break:break-all}
.mt .rng{color:var(--text-3);font-size:11px;white-space:nowrap}
.g-chip{display:inline-block;padding:1px 7px;border-radius:4px;font-size:11px;margin:1px 2px;font-weight:500;word-break:break-all}

/* ===== Explanation ===== */
.exp-list{list-style:none;font-size:12px}
.exp-item{display:flex;gap:10px;padding:5px 0;border-bottom:1px solid rgba(128,128,128,0.08);align-items:flex-start}
.exp-item:last-child{border-bottom:none}
.exp-tok{font-weight:600;color:var(--accent);min-width:70px;flex-shrink:0;word-break:break-all;padding:2px 8px;background:var(--badge-bg);border-radius:4px;text-align:center;font-size:12px;line-height:1.4}
.exp-desc{color:var(--text-2);line-height:1.5}
.exp-indent{padding-left:18px;border-left:2px solid var(--border);margin-left:4px}

/* ===== Action Row ===== */
.act-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.abtn{background:var(--bg-3);border:1px solid var(--border);color:var(--text-2);padding:7px 16px;border-radius:var(--radius);cursor:pointer;font-family:var(--font-mono);font-size:12px;transition:all var(--tr);display:flex;align-items:center;gap:6px}
.abtn:hover{background:var(--bg-hover);color:var(--text-1);border-color:var(--text-3);transform:translateY(-1px)}
.abtn:active{transform:translateY(0)}
.abtn.pri{background:var(--badge-bg);color:var(--badge-c);border-color:rgba(88,166,255,0.25)}
.abtn.pri:hover{background:rgba(88,166,255,0.2);border-color:var(--badge-c)}

/* ===== Substitution ===== */
.sub-wrap{flex:1;display:flex;align-items:center;background:var(--bg-input);border:2px solid var(--border);border-radius:var(--radius);padding:0 12px;transition:all var(--tr)}
.sub-wrap:focus-within{border-color:var(--border-focus);box-shadow:0 0 0 3px rgba(88,166,255,0.08)}
.sub-lbl{color:var(--text-3);font-size:11px;margin-right:8px;white-space:nowrap;font-weight:600}
.sub-input{flex:1;background:transparent;border:none;outline:none;color:var(--text-1);font-family:var(--font-mono);font-size:13px;padding:8px 0}
.sub-input::placeholder{color:var(--text-3)}
.sub-result{background:var(--bg-input);border:2px solid var(--border);border-radius:var(--radius);padding:12px 14px;font-size:14px;line-height:1.6;white-space:pre-wrap;word-wrap:break-word;min-height:50px;max-height:180px;overflow-y:auto;color:var(--text-1)}

/* ===== Toast ===== */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:#1e293b;color:#e2e8f0;padding:10px 24px;border-radius:var(--radius);font-size:12px;font-family:var(--font-mono);box-shadow:0 8px 32px rgba(0,0,0,0.4);z-index:1000;opacity:0;transition:all 0.35s cubic-bezier(0.4,0,0.2,1);pointer-events:none;border:1px solid rgba(255,255,255,0.08);backdrop-filter:blur(8px)}
.toast.vis{opacity:1;transform:translateX(-50%) translateY(0)}

/* ===== Footer ===== */
.footer{text-align:center;padding:14px;font-size:10px;color:var(--text-3);border-top:1px solid var(--border);letter-spacing:0.5px}

@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}

/* ===== Responsive ===== */
@media(max-width:600px){
  .win{margin:8px;border-radius:8px}
  .content{padding:12px;gap:10px}
  .pat-row{flex-direction:column}
  .out-grid{grid-template-columns:1fr}
  .qi{gap:3px}
  .qbtn{padding:2px 5px;font-size:10px}
  .pat-input{font-size:14px}
}

/* ===== Stat badges ===== */
.stat-row{display:flex;gap:12px;flex-wrap:wrap}
.stat{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-3)}
.stat-val{color:var(--accent);font-weight:700;font-size:12px}
.stat-dot{width:6px;height:6px;border-radius:50%;background:var(--success);display:inline-block;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* ===== Tooltip for flags ===== */
.fbtn{position:relative}
.fbtn::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:#1e293b;color:#e2e8f0;padding:4px 8px;border-radius:4px;font-size:10px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.15s;z-index:10;border:1px solid rgba(255,255,255,0.08)}
.fbtn:hover::after{opacity:1}
</style>
</head>
<body>

<div class="win">
  <div class="titlebar">
    <div class="dots"><div class="dot r"></div><div class="dot y"></div><div class="dot g"></div></div>
    <div class="title">regex-lab &mdash; interactive regular expression playground</div>
    <div class="title-actions">
      <button class="tbtn" id="themeBtn"><span id="themeIco">&#9789;</span> <span id="themeLbl">Dark</span></button>
    </div>
  </div>

  <div class="content">
    <!-- Pattern -->
    <div class="pat-row">
      <div class="pat-wrap" id="patWrap">
        <span class="pat-slash">/</span>
        <input type="text" class="pat-input" id="patIn" placeholder="enter regex pattern..." spellcheck="false" autocomplete="off" autocapitalize="off">
        <span class="pat-slash">/</span>
        <span class="flags-disp" id="flagsDisp">g</span>
      </div>
    </div>

    <!-- Flags -->
    <div class="flags-row">
      <span class="lbl">Flags</span>
      <button class="fbtn on" data-flag="g" data-tip="Global: find all matches">g</button>
      <button class="fbtn" data-flag="i" data-tip="Case-insensitive">i</button>
      <button class="fbtn" data-flag="m" data-tip="Multiline: ^ $ match lines">m</button>
      <button class="fbtn" data-flag="s" data-tip="DotAll: . matches \\n">s</button>
      <button class="fbtn" data-flag="u" data-tip="Unicode support">u</button>
      <button class="fbtn" data-flag="y" data-tip="Sticky: match at lastIndex">y</button>
      <span class="flag-desc" id="flagDesc">global &mdash; find all matches</span>
    </div>

    <!-- Quick Inserts -->
    <div class="qi">
      <span class="lbl">Insert</span>
      <button class="qbtn" data-ins="\\d" title="Digit [0-9]">\\d</button>
      <button class="qbtn" data-ins="\\D" title="Non-digit">\\D</button>
      <button class="qbtn" data-ins="\\w" title="Word char">\\w</button>
      <button class="qbtn" data-ins="\\W" title="Non-word char">\\W</button>
      <button class="qbtn" data-ins="\\s" title="Whitespace">\\s</button>
      <button class="qbtn" data-ins="\\S" title="Non-whitespace">\\S</button>
      <button class="qbtn" data-ins="\\b" title="Word boundary">\\b</button>
      <button class="qbtn" data-ins="." title="Any character">.</button>
      <button class="qbtn" data-ins="+" title="One or more">+</button>
      <button class="qbtn" data-ins="*" title="Zero or more">*</button>
      <button class="qbtn" data-ins="?" title="Optional">?</button>
      <button class="qbtn" data-ins="[A-Z]" title="Uppercase range">[A-Z]</button>
      <button class="qbtn" data-ins="[a-z]" title="Lowercase range">[a-z]</button>
      <button class="qbtn" data-ins="[0-9]" title="Digit range">[0-9]</button>
      <button class="qbtn" data-ins="()" title="Capture group">()</button>
      <button class="qbtn" data-ins="(?:)" title="Non-capturing group">(?:)</button>
      <button class="qbtn" data-ins="(?=)" title="Positive lookahead">(?=)</button>
      <button class="qbtn" data-ins="(?!)" title="Negative lookahead">(?!)</button>
      <button class="qbtn" data-ins="(?<=)" title="Positive lookbehind">(?&lt;=)</button>
      <button class="qbtn" data-ins="(?<!)" title="Negative lookbehind">(?&lt;!)</button>
      <button class="qbtn" data-ins="^" title="Start of string">^</button>
      <button class="qbtn" data-ins="$" title="End of string">$</button>
      <button class="qbtn" data-ins="|" title="Alternation">|</button>
      <button class="qbtn" data-ins="{,}" title="Quantifier range">{n,m}</button>
    </div>

    <!-- Error -->
    <div class="err-box" id="errBox">
      <div class="err-title">&#9888; Regex Error</div>
      <div class="err-caret" id="errCaret"></div>
      <div class="err-msg" id="errMsg"></div>
    </div>

    <!-- Stats Row -->
    <div class="stat-row" id="statsRow">
      <div class="stat"><span class="stat-dot"></span> Live</div>
      <div class="stat">Matches: <span class="stat-val" id="statMatches">0</span></div>
      <div class="stat">Groups: <span class="stat-val" id="statGroups">0</span></div>
      <div class="stat">Steps: <span class="stat-val" id="statSteps">&mdash;</span></div>
    </div>

    <!-- Test Text -->
    <div>
      <div class="section-hdr">
        <span class="section-title">Test String</span>
        <span class="mcount" id="mcount"></span>
      </div>
      <div class="tt-container hl" id="ttContainer">
        <div class="tt-backdrop" id="ttBackdrop"></div>
        <textarea class="tt-input" id="ttInput" placeholder="Enter test text here...&#10;&#10;Matches will be highlighted in real-time as you type." spellcheck="false"></textarea>
      </div>
    </div>

    <!-- Actions -->
    <div class="act-row">
      <button class="abtn" id="clearBtn">&#10005; Clear</button>
      <button class="abtn pri" id="shareBtn">&#128279; Permalink</button>
      <button class="abtn" id="sampleBtn">&#9881; Sample</button>
      <button class="abtn" id="sampleEmailBtn">&#9993; Email</button>
      <button class="abtn" id="sampleUrlBtn">&#127760; URL</button>
    </div>

    <!-- Output Panels -->
    <div class="out-grid">
      <div class="panel">
        <div class="panel-hdr">
          <span class="panel-title">Matches</span>
          <span class="mcount" id="mcountPanel"></span>
        </div>
        <div class="panel-body scroll-p" id="matchesPanel">
          <div class="panel-empty">No matches yet.<br>Enter a pattern and test text above.</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-hdr">
          <span class="panel-title">Pattern Explanation</span>
        </div>
        <div class="panel-body" id="explPanel">
          <div class="panel-empty">Enter a regex pattern to see<br>a breakdown of its components.</div>
        </div>
      </div>
    </div>

    <!-- Substitution -->
    <div>
      <div class="section-hdr"><span class="section-title">Find &amp; Replace</span></div>
      <div style="display:flex;gap:8px;align-items:stretch">
        <div class="sub-wrap">
          <span class="sub-lbl">Replace:</span>
          <input type="text" class="sub-input" id="replIn" placeholder="e.g. $1, $&amp;, \\n" spellcheck="false">
        </div>
      </div>
      <div style="margin-top:8px">
        <div class="section-hdr"><span class="section-title">Result</span></div>
        <div class="sub-result" id="replResult"></div>
      </div>
    </div>
  </div>

  <div class="footer">Regex Lab &mdash; Vanilla HTML/CSS/JS &mdash; No dependencies</div>
</div>

<div class="toast" id="toast"></div>

<script>
(function() {
'use strict';

// DOM
const $ = id => document.getElementById(id);
const patIn = $('patIn'), ttInput = $('ttInput'), ttBackdrop = $('ttBackdrop');
const ttContainer = $('ttContainer'), flagsDisp = $('flagsDisp'), flagDesc = $('flagDesc');
const errBox = $('errBox'), errMsg = $('errMsg'), errCaret = $('errCaret');
const mcount = $('mcount'), mcountPanel = $('mcountPanel');
const matchesPanel = $('matchesPanel'), explPanel = $('explPanel');
const patWrap = $('patWrap'), replIn = $('replIn'), replResult = $('replResult');
const toast = $('toast');
const statMatches = $('statMatches'), statGroups = $('statGroups'), statSteps = $('statSteps');

// State
let flags = new Set(['g']);
let theme = localStorage.getItem('regex-lab-theme') || 'dark';
setTheme(theme);

// Theme
function setTheme(t) {
  theme = t;
  document.documentElement.setAttribute('data-theme', t);
  $('themeIco').innerHTML = t === 'dark' ? '&#9789;' : '&#9728;';
  $('themeLbl').textContent = t === 'dark' ? 'Dark' : 'Light';
  localStorage.setItem('regex-lab-theme', t);
}
$('themeBtn').onclick = () => setTheme(theme === 'dark' ? 'light' : 'dark');

// Flags
const FDESC = {g:'global &mdash; find all matches',i:'case-insensitive matching',m:'multiline &mdash; ^ and $ match line boundaries',s:'dotAll &mdash; dot matches newlines',u:'unicode &mdash; full Unicode support',y:'sticky &mdash; match from lastIndex'};
document.querySelectorAll('.fbtn').forEach(b => {
  b.onclick = () => {
    const f = b.dataset.flag;
    flags.has(f) ? flags.delete(f) : flags.add(f);
    b.classList.toggle('on', flags.has(f));
    updFlagsDisp();
    update();
  };
  b.onmouseenter = () => { flagDesc.innerHTML = FDESC[b.dataset.flag] || ''; };
});

function updFlagsDisp() {
  const s = 'gimsuy'.split('').filter(f => flags.has(f)).join('');
  flagsDisp.textContent = s || '';
  const dd = [];
  flags.forEach(f => { if (FDESC[f]) dd.push(FDESC[f]); });
  flagDesc.innerHTML = dd.join(', ') || 'no flags selected';
}

// Quick inserts
document.querySelectorAll('.qbtn').forEach(b => {
  b.onclick = () => {
    let ins = b.dataset.ins;
    if (ins === '{,}') ins = '{1,3}';
    const s = patIn.selectionStart, e = patIn.selectionEnd, v = patIn.value;
    patIn.value = v.slice(0, s) + ins + v.slice(e);
    let cur = s + ins.length;
    if (ins.endsWith(')') && ins.includes('(')) cur = s + ins.length - 1;
    else if (ins.endsWith(']')) cur = s + ins.length - 1;
    else if (ins === '{1,3}') cur = s + 1;
    patIn.setSelectionRange(cur, cur);
    patIn.focus();
    update();
  };
});

// Clear
$('clearBtn').onclick = () => {
  patIn.value = ''; ttInput.value = ''; replIn.value = '';
  replResult.textContent = '';
  update();
  patIn.focus();
  showToast('Cleared');
};

// Samples
$('sampleBtn').onclick = () => loadSample(
  '(\\w+)@(\\w+)\\.(\\w+)',
  'Contact us at:\n  support@example.com\n  admin@company.org\n  john@mail.net\n\nInvalid:\n  @missing.com\n  noatsign\n  spaces@ bad.org',
  '$1 [at] $2.$3'
);
$('sampleEmailBtn').onclick = () => loadSample(
  '[\\w.+-]+@[\\w-]+\\.[\\w.]+',
  'Emails: alice@example.com, bob.smith+tag@company.co.uk,\ninvalid@, @nouser.com, good_one@test.org',
  '[REDACTED]'
);
$('sampleUrlBtn').onclick = () => loadSample(
  'https?://[\\w.-]+(?:/[\\w./?%&=-]*)?',
  'Visit https://example.com/page?q=1&r=2\nOr http://old-site.org/path/to/resource\nNot a url: ftp://other.com\nAnother: https://sub.domain.co.uk/page',
  '[link]'
);

function loadSample(p, t, r) {
  patIn.value = p; ttInput.value = t; replIn.value = r || '';
  if (!flags.has('g')) { flags.add('g'); document.querySelector('.fbtn[data-flag="g"]').classList.add('on'); updFlagsDisp(); }
  update();
  showToast('Sample loaded');
}

// Share
$('shareBtn').onclick = () => {
  const d = { p: patIn.value, f: Array.from(flags).join(''), t: ttInput.value, r: replIn.value };
  const hash = '#' + encodeURIComponent(JSON.stringify(d));
  const url = location.origin + location.pathname + hash;
  history.replaceState(null, '', hash);
  navigator.clipboard.writeText(url).then(() => showToast('Permalink copied!')).catch(() => {
    const ta = document.createElement('textarea'); ta.value = url;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta); showToast('Permalink copied!');
  });
};

// Hash load
function loadHash() {
  if (!location.hash) return false;
  try {
    const d = JSON.parse(decodeURIComponent(location.hash.slice(1)));
    if (d.p != null) patIn.value = d.p;
    if (d.t != null) ttInput.value = d.t;
    if (d.r != null) replIn.value = d.r;
    if (d.f != null) {
      flags = new Set(d.f.split(''));
      document.querySelectorAll('.fbtn').forEach(b => b.classList.toggle('on', flags.has(b.dataset.flag)));
      updFlagsDisp();
    }
    return true;
  } catch(e) { return false; }
}

// Toast
let toastTimer;
function showToast(m) {
  toast.textContent = m;
  toast.classList.add('vis');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('vis'), 2200);
}

// Scroll sync
ttInput.addEventListener('scroll', () => {
  ttBackdrop.scrollTop = ttInput.scrollTop;
  ttBackdrop.scrollLeft = ttInput.scrollLeft;
});

// Debounced update
let ut;
function sched() { clearTimeout(ut); ut = setTimeout(update, 12); }
patIn.addEventListener('input', sched);
ttInput.addEventListener('input', sched);
replIn.addEventListener('input', sched);

// ========== MAIN UPDATE ==========
function update() {
  const pat = patIn.value, text = ttInput.value;
  const fl = 'gimsuy'.split('').filter(f => flags.has(f)).join('');

  errBox.classList.remove('vis');
  patWrap.classList.remove('err');

  if (!pat) {
    ttBackdrop.innerHTML = esc(text) + '\n';
    mcount.innerHTML = '';
    mcountPanel.innerHTML = '';
    matchesPanel.innerHTML = '<div class="panel-empty">No matches yet.<br>Enter a pattern and test text.</div>';
    updateExpl('');
    replResult.textContent = text;
    statMatches.textContent = '0';
    statGroups.textContent = '0';
    statSteps.innerHTML = '&mdash;';
    return;
  }

  let regex;
  try { regex = new RegExp(pat, fl); }
  catch(e) {
    showError(e, pat);
    ttBackdrop.innerHTML = esc(text) + '\n';
    mcount.innerHTML = '<span style="color:var(--error)">Invalid pattern</span>';
    mcountPanel.innerHTML = '';
    matchesPanel.innerHTML = '<div class="panel-empty" style="color:var(--error)">Fix the pattern error above.</div>';
    updateExpl(pat);
    replResult.textContent = text;
    statMatches.textContent = '!';
    statGroups.textContent = '0';
    statSteps.innerHTML = '&mdash;';
    return;
  }

  // Collect matches
  const matches = [];
  const t0 = performance.now();
  if (fl.includes('g') || fl.includes('y')) {
    let m, safe = 0;
    regex.lastIndex = 0;
    while ((m = regex.exec(text)) !== null && safe < 50000) {
      matches.push({ v: m[0], i: m.index, e: m.index + m[0].length, g: [...m].slice(1), ng: m.groups || null });
      if (m[0].length === 0) { regex.lastIndex = m.index + 1; if (regex.lastIndex > text.length) break; }
      safe++;
    }
  } else {
    const m = regex.exec(text);
    if (m) matches.push({ v: m[0], i: m.index, e: m.index + m[0].length, g: [...m].slice(1), ng: m.groups || null });
  }
  const elapsed = performance.now() - t0;

  // Stats
  const cnt = matches.length;
  const maxGrp = matches.reduce((a, m) => Math.max(a, m.g.filter(x => x !== undefined).length), 0);
  statMatches.textContent = cnt;
  statGroups.textContent = maxGrp;
  statSteps.textContent = elapsed < 1 ? '<1ms' : Math.round(elapsed) + 'ms';

  const ch = cnt > 0
    ? `<span class="num">${cnt}</span> match${cnt !== 1 ? 'es' : ''}`
    : '<span style="color:var(--text-3)">No matches</span>';
  mcount.innerHTML = ch;
  mcountPanel.innerHTML = ch;

  highlight(text, matches, pat, fl);
  buildTable(matches);
  updateExpl(pat);
  doReplace(regex, text);
}

// ========== ERROR ==========
function showError(e, pat) {
  patWrap.classList.add('err');
  errBox.classList.add('vis');
  let msg = e.message || 'Invalid regular expression';
  const pm = msg.match(/at position (\d+)/);
  let c = '';
  if (pm) {
    const p = parseInt(pm[1]);
    c = '  /' + pat + '/\n   ' + ' '.repeat(Math.min(p, pat.length)) + '^';
  } else {
    c = '  /' + pat + '/';
  }
  msg = msg.replace(/^Invalid regular expression: \/.*\/[gimsuy]*: /, '');
  errCaret.textContent = c;
  errMsg.textContent = msg;
}

// ========== HIGHLIGHT ==========
const GC = ['#51cf66','#339af0','#fcc419','#cc5de8','#ff922b','#20c997','#e599f7','#74c0fc'];

function highlight(text, matches, pat, fl) {
  if (!matches.length) { ttBackdrop.innerHTML = esc(text) + '\n'; return; }

  let grpRegex;
  try { grpRegex = new RegExp(pat, fl.replace(/[gy]/g, '')); } catch(e) { grpRegex = null; }

  let html = '', last = 0;
  matches.forEach((m, idx) => {
    if (m.i > last) html += esc(text.slice(last, m.i));
    const ci = idx % 8;
    const hasGrp = m.g.length > 0 && m.g.some(g => g !== undefined);
    if (grpRegex && hasGrp) {
      const ge = grpRegex.exec(m.v);
      if (ge && ge.length > 1) {
        html += `<span class="hl-m hl-m-${ci}">${hlGroups(m.v, ge)}</span>`;
      } else {
        html += `<span class="hl-m hl-m-${ci}">${esc(m.v)}</span>`;
      }
    } else {
      html += `<span class="hl-m hl-m-${ci}">${esc(m.v)}</span>`;
    }
    last = m.e;
  });
  if (last < text.length) html += esc(text.slice(last));
  // Trailing newline keeps backdrop height in sync with textarea
  ttBackdrop.innerHTML = html + '\n';
}

function hlGroups(mt, exec) {
  const gp = [];
  for (let i = 1; i < exec.length; i++) {
    if (exec[i] === undefined) continue;
    const gv = exec[i];
    let sf = 0;
    if (gp.length) { const l = gp[gp.length - 1]; sf = l.s; }
    const p = mt.indexOf(gv, sf);
    if (p !== -1) gp.push({ s: p, e: p + gv.length, gi: i, v: gv });
  }
  gp.sort((a, b) => a.s - b.s);
  // Remove overlaps
  const flt = []; let le = 0;
  for (const g of gp) { if (g.s >= le) { flt.push(g); le = g.e; } }

  let h = '', p = 0;
  for (const g of flt) {
    if (g.s > p) h += esc(mt.slice(p, g.s));
    const c = GC[(g.gi - 1) % GC.length];
    h += `<span class="hl-g" style="border-bottom-color:${c}">${esc(g.v)}</span>`;
    p = g.e;
  }
  if (p < mt.length) h += esc(mt.slice(p));
  return h;
}

// ========== MATCHES TABLE ==========
const MBG = [
  'rgba(255,107,107,0.12)','rgba(81,207,102,0.12)','rgba(51,154,240,0.12)',
  'rgba(252,196,25,0.12)','rgba(204,93,232,0.12)','rgba(255,146,43,0.12)',
  'rgba(32,201,151,0.12)','rgba(229,153,247,0.12)'
];

function buildTable(matches) {
  if (!matches.length) {
    matchesPanel.innerHTML = '<div class="panel-empty">No matches found.<br>Modify pattern or test text.</div>';
    return;
  }
  const hasG = matches.some(m => m.g.some(g => g !== undefined));
  const maxG = Math.max(...matches.map(m => m.g.length));

  let h = '<table class="mt"><thead><tr><th>#</th><th>Match</th><th>Range</th>';
  if (hasG) for (let i = 1; i <= maxG; i++) h += `<th style="color:${GC[(i-1)%GC.length]}">Grp ${i}</th>`;
  h += '</tr></thead><tbody>';

  matches.forEach((m, idx) => {
    const ci = idx % 8;
    h += `<tr><td class="idx">${idx+1}</td>`;
    const display = m.v || '<em style="color:var(--text-3)">(empty)</em>';
    h += `<td class="val" style="background:${MBG[ci]};border-radius:3px;padding:2px 8px">${m.v ? esc(m.v) : display}</td>`;
    h += `<td class="rng">${m.i}&ndash;${m.e}</td>`;
    if (hasG) {
      for (let i = 0; i < maxG; i++) {
        const gv = m.g[i];
        if (gv !== undefined) {
          const c = GC[i % GC.length];
          h += `<td><span class="g-chip" style="background:${c}18;color:${c};border:1px solid ${c}30">${esc(gv)}</span></td>`;
        } else {
          h += `<td><span style="color:var(--text-3);font-size:10px">&mdash;</span></td>`;
        }
      }
    }
    h += '</tr>';
  });
  h += '</tbody></table>';
  matchesPanel.innerHTML = h;
}

// ========== EXPLANATION ==========
function updateExpl(pat) {
  if (!pat) {
    explPanel.innerHTML = '<div class="panel-empty">Enter a regex pattern to see<br>a breakdown of its components.</div>';
    return;
  }
  const toks = tokenize(pat);
  if (!toks.length) { explPanel.innerHTML = '<div class="panel-empty">Could not parse pattern.</div>'; return; }

  let h = '<ul class="exp-list">';
  toks.forEach(t => {
    const ind = t.d ? ' exp-indent' : '';
    h += `<li class="exp-item${ind}"><span class="exp-tok">${esc(t.t)}</span><span class="exp-desc">${esc(t.desc)}</span></li>`;
  });
  h += '</ul>';
  explPanel.innerHTML = h;
}

function tokenize(pat) {
  const T = [], n = pat.length;
  let i = 0, gc = 0, d = 0;

  while (i < n) {
    const ch = pat[i], rem = pat.slice(i);

    // Character class
    if (ch === '[') {
      const end = findCCEnd(pat, i);
      const cls = pat.slice(i, end + 1);
      let desc = `Character class: any char in ${cls}`;
      if (cls[1] === '^') desc = `Negated class: any char NOT in ${cls.slice(2,-1)}`;
      const specials = {
        '[A-Z]': 'Any uppercase letter A-Z',
        '[a-z]': 'Any lowercase letter a-z',
        '[0-9]': 'Any digit 0-9',
        '[A-Za-z]': 'Any letter',
        '[A-Za-z0-9]': 'Any alphanumeric character',
        '[^\\n]': 'Any character except newline',
        '[\\s\\S]': 'Any character (including newlines)',
        '[\\w]': 'Word character (same as \\w)',
        '[\\d]': 'Digit (same as \\d)',
      };
      if (specials[cls]) desc = specials[cls];
      T.push({ t: cls, desc, d });
      i = end + 1;
      continue;
    }

    // Groups
    if (ch === '(') {
      if (rem.startsWith('(?:')) { T.push({ t: '(?:...)', desc: 'Non-capturing group', d }); d++; i += 3; continue; }
      if (rem.startsWith('(?=')) { T.push({ t: '(?=...)', desc: 'Positive lookahead: assert what follows matches', d }); d++; i += 3; continue; }
      if (rem.startsWith('(?!')) { T.push({ t: '(?!...)', desc: 'Negative lookahead: assert what follows does NOT match', d }); d++; i += 3; continue; }
      if (rem.startsWith('(?<=')) { T.push({ t: '(?<=...)', desc: 'Positive lookbehind: assert what precedes matches', d }); d++; i += 4; continue; }
      if (rem.startsWith('(?<!')) { T.push({ t: '(?<!...)', desc: 'Negative lookbehind: assert what precedes does NOT match', d }); d++; i += 4; continue; }
      const nm = rem.match(/^\(\?<([^>]+)>/);
      if (nm) { gc++; T.push({ t: `(?<${nm[1]}>)`, desc: `Named capture group #${gc}: "${nm[1]}"`, d }); d++; i += nm[0].length; continue; }
      gc++; T.push({ t: '(...)', desc: `Capturing group #${gc}`, d }); d++; i++; continue;
    }
    if (ch === ')') { if (d > 0) d--; T.push({ t: ')', desc: 'End of group', d }); i++; continue; }

    // Alternation
    if (ch === '|') { T.push({ t: '|', desc: 'Alternation (OR): match left or right side', d }); i++; continue; }

    // Anchors
    if (ch === '^') { T.push({ t: '^', desc: 'Start of string (or line in multiline mode)', d }); i++; continue; }
    if (ch === '$') { T.push({ t: '$', desc: 'End of string (or line in multiline mode)', d }); i++; continue; }

    // Escapes
    if (ch === '\\' && i + 1 < n) {
      const nx = pat[i+1];
      const ESC = {
        d:['\\d','Digit [0-9]'],D:['\\D','Non-digit [^0-9]'],
        w:['\\w','Word character [a-zA-Z0-9_]'],W:['\\W','Non-word character [^a-zA-Z0-9_]'],
        s:['\\s','Whitespace (space, tab, newline, etc.)'],S:['\\S','Non-whitespace character'],
        b:['\\b','Word boundary'],B:['\\B','Non-word boundary'],
        n:['\\n','Newline (LF)'],r:['\\r','Carriage return (CR)'],
        t:['\\t','Tab character'],f:['\\f','Form feed'],
        v:['\\v','Vertical tab'],0:['\\0','Null character'],
      };
      if (ESC[nx]) { T.push({ t: ESC[nx][0], desc: ESC[nx][1], d }); i += 2; continue; }

      // Backreference
      if (nx >= '1' && nx <= '9') {
        let ref = nx;
        if (i+2 < n && pat[i+2] >= '0' && pat[i+2] <= '9') { ref += pat[i+2]; T.push({ t: `\\${ref}`, desc: `Backreference to group #${ref}`, d }); i += 3; }
        else { T.push({ t: `\\${nx}`, desc: `Backreference to group #${nx}`, d }); i += 2; }
        continue;
      }

      // Named backref
      const nbr = rem.match(/^\\k<([^>]+)>/);
      if (nbr) { T.push({ t: nbr[0], desc: `Backreference to named group "${nbr[1]}"`, d }); i += nbr[0].length; continue; }

      // Unicode \uXXXX or \u{XXXX}
      const um = rem.match(/^\\u(\{[0-9a-fA-F]+\}|[0-9a-fA-F]{4})/);
      if (um) {
        const code = um[1].replace(/[{}]/g,'');
        let ch2 = ''; try { ch2 = String.fromCodePoint(parseInt(code,16)); } catch(e){}
        T.push({ t: um[0], desc: `Unicode U+${code.toUpperCase()}${ch2 ? ' "'+ch2+'"' : ''}`, d });
        i += um[0].length; continue;
      }

      // Hex \xXX
      const hm = rem.match(/^\\x([0-9a-fA-F]{2})/);
      if (hm) {
        const ch2 = String.fromCharCode(parseInt(hm[1],16));
        T.push({ t: hm[0], desc: `Hex char 0x${hm[1].toUpperCase()} "${ch2}"`, d });
        i += hm[0].length; continue;
      }

      // Unicode property
      const pm = rem.match(/^\\([pP])\{([^}]+)\}/);
      if (pm) {
        T.push({ t: pm[0], desc: `${pm[1]==='P'?'NOT ':''}Unicode property: ${pm[2]}`, d });
        i += pm[0].length; continue;
      }

      // Escaped literal
      T.push({ t: `\\${nx}`, desc: `Escaped literal "${nx}"`, d });
      i += 2; continue;
    }

    // Quantifiers
    if (ch === '*') { const lz = i+1<n&&pat[i+1]==='?'; T.push({ t: lz?'*?':'*', desc: lz?'Zero or more (lazy)':'Zero or more (greedy)', d }); i += lz?2:1; continue; }
    if (ch === '+') { const lz = i+1<n&&pat[i+1]==='?'; T.push({ t: lz?'+?':'+', desc: lz?'One or more (lazy)':'One or more (greedy)', d }); i += lz?2:1; continue; }
    if (ch === '?') { const lz = i+1<n&&pat[i+1]==='?'; T.push({ t: lz?'??':'?', desc: lz?'Optional (lazy)':'Optional (zero or one)', d }); i += lz?2:1; continue; }

    if (ch === '{') {
      const qm = rem.match(/^\{(\d+)(?:(,)(\d*))?\}(\?)?/);
      if (qm) {
        const tok = qm[0], min = qm[1], comma = qm[2], max = qm[3], lz = qm[4];
        let desc;
        if (!comma) desc = `Exactly ${min} times`;
        else if (!max) desc = `${min} or more times`;
        else desc = `Between ${min} and ${max} times`;
        desc += lz ? ' (lazy)' : ' (greedy)';
        T.push({ t: tok, desc, d }); i += tok.length; continue;
      }
    }

    // Dot
    if (ch === '.') { T.push({ t: '.', desc: 'Any character (except newline unless dotAll flag)', d }); i++; continue; }

    // Literal string
    let lit = '';
    while (i < n && !'^$.*+?()[]{}|\\'.includes(pat[i])) { lit += pat[i]; i++; }
    if (lit) {
      T.push({ t: lit.length === 1 ? `"${lit}"` : `"${lit}"`, desc: lit.length === 1 ? `Literal "${lit}"` : `Literal string "${lit}"`, d });
      continue;
    }

    T.push({ t: ch, desc: `"${ch}"`, d }); i++;
  }
  return T;
}

function findCCEnd(p, s) {
  let i = s + 1;
  if (i < p.length && p[i] === '^') i++;
  if (i < p.length && p[i] === ']') i++;
  while (i < p.length) {
    if (p[i] === '\\' && i+1 < p.length) { i += 2; continue; }
    if (p[i] === ']') return i;
    i++;
  }
  return p.length - 1;
}

// ========== REPLACEMENT ==========
function doReplace(regex, text) {
  const r = replIn.value;
  if (!regex || !r) { replResult.textContent = text || ''; return; }
  try { replResult.textContent = text.replace(regex, r); }
  catch(e) { replResult.textContent = text; }
}

// ========== UTILITY ==========
function esc(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ========== INIT ==========
const loaded = loadHash();
window.addEventListener('hashchange', () => { loadHash(); update(); });
update();
updFlagsDisp();
if (!loaded) patIn.focus();

})();
</script>
</body>
</html>
