<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light" />
    <title>Employee Skills Matrix</title>
    <style>
      :root {
        --bg: #f6f7fb;
        --panel: #ffffff;
        --panel-2: #fbfbfe;
        --text: #0f172a;
        --muted: #475569;
        --muted-2: #64748b;
        --border: rgba(15, 23, 42, 0.12);
        --border-2: rgba(15, 23, 42, 0.08);
        --shadow: 0 14px 32px rgba(2, 6, 23, 0.12);
        --shadow-soft: 0 10px 24px rgba(2, 6, 23, 0.10);
        --radius: 14px;
        --radius-sm: 10px;
        --radius-xs: 9px;
        --focus: rgba(99, 102, 241, 0.28);
        --accent: #4f46e5;
        --accent-2: #7c3aed;
        --good: #16a34a;
        --warn: #f59e0b;
        --bad: #ef4444;
        --chip: rgba(2, 6, 23, 0.06);
        --chip-2: rgba(79, 70, 229, 0.10);
        --grid-header: linear-gradient(180deg, rgba(248, 250, 252, 0.98), rgba(248, 250, 252, 0.94));
        --skill-col: 340px;
        --emp-col: 150px;
        --row-h: 44px;
        --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          scroll-behavior: auto !important;
          animation-duration: 0.001ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.001ms !important;
        }
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: var(--font);
        color: var(--text);
        background: radial-gradient(1200px 600px at 15% 0%, rgba(79, 70, 229, 0.12), transparent 60%),
          radial-gradient(900px 540px at 90% 10%, rgba(124, 58, 237, 0.10), transparent 55%),
          radial-gradient(900px 520px at 50% 95%, rgba(16, 185, 129, 0.08), transparent 60%), var(--bg);
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      button,
      input,
      select,
      textarea {
        font: inherit;
        color: inherit;
      }

      .app {
        min-height: 100%;
        display: grid;
        grid-template-rows: auto 1fr;
      }

      .topbar {
        position: sticky;
        top: 0;
        z-index: 50;
        background: linear-gradient(180deg, rgba(246, 247, 251, 0.92), rgba(246, 247, 251, 0.80));
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border-2);
      }

      .topbar-inner {
        max-width: 1260px;
        margin: 0 auto;
        padding: 14px 16px 12px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .brand {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
      }

      .brand-left {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }

      .logo {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        background: radial-gradient(14px 18px at 35% 35%, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0) 70%),
          linear-gradient(135deg, var(--accent), var(--accent-2));
        box-shadow: 0 10px 28px rgba(79, 70, 229, 0.26);
        display: grid;
        place-items: center;
        flex: 0 0 auto;
      }

      .logo svg {
        width: 22px;
        height: 22px;
        fill: white;
        opacity: 0.96;
      }

      .brand h1 {
        font-size: 16px;
        letter-spacing: -0.02em;
        margin: 0;
        line-height: 1.15;
      }

      .brand p {
        margin: 0;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.35;
      }

      .brand-meta {
        min-width: 0;
      }

      .right-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 10px;
        flex-wrap: wrap;
      }

      .pill {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.74);
        box-shadow: 0 6px 16px rgba(2, 6, 23, 0.06);
      }

      .pill input {
        border: none;
        background: transparent;
        outline: none;
        min-width: 240px;
      }

      .pill svg {
        width: 16px;
        height: 16px;
        color: var(--muted);
      }

      .btn {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.86);
        border-radius: 12px;
        padding: 8px 10px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        box-shadow: 0 8px 18px rgba(2, 6, 23, 0.06);
        transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 24px rgba(2, 6, 23, 0.08);
      }

      .btn:active {
        transform: translateY(0px);
      }

      .btn.primary {
        border-color: rgba(79, 70, 229, 0.34);
        background: linear-gradient(180deg, rgba(79, 70, 229, 0.96), rgba(79, 70, 229, 0.90));
        color: white;
        box-shadow: 0 14px 30px rgba(79, 70, 229, 0.24);
      }

      .btn.primary:hover {
        box-shadow: 0 16px 34px rgba(79, 70, 229, 0.26);
      }

      .btn.ghost {
        background: rgba(255, 255, 255, 0.64);
      }

      .btn svg {
        width: 16px;
        height: 16px;
      }

      .btn .k {
        font-family: var(--mono);
        font-size: 11px;
        color: var(--muted-2);
        background: rgba(2, 6, 23, 0.06);
        padding: 2px 6px;
        border-radius: 8px;
      }

      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .tab {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.74);
        border-radius: 999px;
        padding: 8px 10px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--muted);
        transition: background 120ms ease, transform 120ms ease;
      }

      .tab:hover {
        transform: translateY(-1px);
      }

      .tab[aria-selected="true"] {
        background: linear-gradient(180deg, rgba(79, 70, 229, 0.14), rgba(79, 70, 229, 0.10));
        border-color: rgba(79, 70, 229, 0.28);
        color: var(--text);
      }

      .tab svg {
        width: 16px;
        height: 16px;
      }

      .content {
        max-width: 1260px;
        width: 100%;
        margin: 0 auto;
        padding: 16px;
        display: grid;
        gap: 14px;
      }

      .panel {
        background: rgba(255, 255, 255, 0.84);
        border: 1px solid var(--border-2);
        border-radius: var(--radius);
        box-shadow: var(--shadow-soft);
      }

      .panel-inner {
        padding: 14px;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 14px;
        align-items: start;
      }

      @media (max-width: 980px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
        :root {
          --skill-col: 270px;
          --emp-col: 140px;
        }
      }

      .controls {
        display: grid;
        gap: 10px;
      }

      .section-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 6px;
      }

      .section-title h2 {
        font-size: 14px;
        margin: 0;
        letter-spacing: -0.02em;
      }

      .hint {
        color: var(--muted);
        font-size: 12px;
        line-height: 1.35;
      }

      .field {
        display: grid;
        gap: 6px;
      }

      .label {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .label .mini {
        font-family: var(--mono);
        font-size: 11px;
        color: var(--muted-2);
        background: rgba(2, 6, 23, 0.06);
        padding: 2px 6px;
        border-radius: 8px;
      }

      .input,
      .select,
      .textarea {
        width: 100%;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.90);
        border-radius: 12px;
        padding: 10px 10px;
        outline: none;
        box-shadow: 0 10px 22px rgba(2, 6, 23, 0.05);
      }

      .input:focus,
      .select:focus,
      .textarea:focus,
      .btn:focus,
      .tab:focus {
        box-shadow: 0 0 0 4px var(--focus), 0 10px 22px rgba(2, 6, 23, 0.05);
        outline: none;
      }

      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border-2);
        background: rgba(2, 6, 23, 0.03);
        color: var(--muted);
        font-size: 12px;
      }

      .chip strong {
        color: var(--text);
        font-weight: 650;
      }

      .legend {
        display: grid;
        gap: 8px;
        margin-top: 6px;
      }

      .legend-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .swatches {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
      }

      .swatch {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        border-radius: 999px;
        padding: 6px 9px;
        border: 1px solid var(--border-2);
        background: rgba(255, 255, 255, 0.70);
        font-size: 12px;
        color: var(--muted);
      }

      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.12);
      }

      .dot.l0 {
        background: #e2e8f0;
      }
      .dot.l1 {
        background: #93c5fd;
      }
      .dot.l2 {
        background: #60a5fa;
      }
      .dot.l3 {
        background: #4f46e5;
      }
      .dot.l4 {
        background: #7c3aed;
      }

      .matrix-panel {
        overflow: hidden;
      }

      .matrix-top {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        padding: 12px 14px;
        border-bottom: 1px solid var(--border-2);
        background: rgba(255, 255, 255, 0.72);
      }

      .matrix-top .meta {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .matrix-top .meta .chip {
        background: rgba(79, 70, 229, 0.08);
        border-color: rgba(79, 70, 229, 0.16);
      }

      .matrix-scroll {
        overflow: auto;
        max-height: min(64vh, 640px);
        background: rgba(255, 255, 255, 0.62);
      }

      table.matrix {
        width: max-content;
        min-width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      table.matrix th,
      table.matrix td {
        border-right: 1px solid var(--border-2);
        border-bottom: 1px solid var(--border-2);
        height: var(--row-h);
        padding: 0;
        vertical-align: middle;
        background: rgba(255, 255, 255, 0.70);
      }

      table.matrix thead th {
        position: sticky;
        top: 0;
        z-index: 5;
        background: var(--grid-header);
        backdrop-filter: blur(10px);
        border-top: 1px solid var(--border-2);
      }

      table.matrix thead th:first-child {
        left: 0;
        z-index: 8;
      }

      table.matrix tbody th {
        position: sticky;
        left: 0;
        z-index: 4;
        background: linear-gradient(90deg, rgba(248, 250, 252, 0.98), rgba(248, 250, 252, 0.90));
        border-left: 1px solid var(--border-2);
        min-width: var(--skill-col);
        max-width: var(--skill-col);
      }

      table.matrix thead th:not(:first-child) {
        min-width: var(--emp-col);
        max-width: var(--emp-col);
      }

      .corner {
        min-width: var(--skill-col);
        max-width: var(--skill-col);
        border-left: 1px solid var(--border-2);
      }

      .th-emp {
        padding: 8px 10px;
      }

      .emp-name {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: -0.015em;
        margin: 0;
        line-height: 1.15;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .emp-meta {
        margin: 3px 0 0;
        color: var(--muted);
        font-size: 11px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .th-skill {
        padding: 8px 10px;
        text-align: left;
      }

      .skill-title {
        display: flex;
        gap: 8px;
        align-items: baseline;
        justify-content: space-between;
      }

      .skill-name {
        font-size: 12px;
        font-weight: 750;
        letter-spacing: -0.015em;
        margin: 0;
        line-height: 1.15;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .skill-tags {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .tag {
        font-size: 11px;
        color: var(--muted);
        border: 1px solid var(--border-2);
        background: rgba(2, 6, 23, 0.03);
        border-radius: 999px;
        padding: 3px 7px;
        white-space: nowrap;
      }

      .tag.core {
        color: #1e40af;
        border-color: rgba(30, 64, 175, 0.18);
        background: rgba(59, 130, 246, 0.10);
      }

      .tag.compliance {
        color: #065f46;
        border-color: rgba(6, 95, 70, 0.18);
        background: rgba(16, 185, 129, 0.10);
      }

      .tag.risk {
        color: #9a3412;
        border-color: rgba(154, 52, 18, 0.18);
        background: rgba(249, 115, 22, 0.12);
      }

      .skill-desc {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 11px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .cell-btn {
        width: 100%;
        height: 100%;
        border: none;
        background: transparent;
        cursor: pointer;
        display: grid;
        place-items: center;
        position: relative;
        outline: none;
      }

      .cell-btn::before {
        content: "";
        position: absolute;
        inset: 8px 10px;
        border-radius: 12px;
        background: rgba(226, 232, 240, 0.55);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.10);
        transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
      }

      .cell-btn:hover::before {
        transform: translateY(-1px);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.14), 0 8px 16px rgba(2, 6, 23, 0.08);
      }

      .cell-btn:focus-visible::before {
        box-shadow: 0 0 0 4px var(--focus), inset 0 0 0 1px rgba(15, 23, 42, 0.14);
      }

      .cell-badge {
        position: relative;
        z-index: 1;
        font-family: var(--mono);
        font-size: 12px;
        color: rgba(15, 23, 42, 0.86);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .cell-badge .mini-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.12);
      }

      .lvl-0::before {
        background: rgba(226, 232, 240, 0.58);
      }
      .lvl-1::before {
        background: rgba(147, 197, 253, 0.38);
      }
      .lvl-2::before {
        background: rgba(96, 165, 250, 0.40);
      }
      .lvl-3::before {
        background: rgba(79, 70, 229, 0.20);
      }
      .lvl-4::before {
        background: rgba(124, 58, 237, 0.22);
      }

      .lvl-0 .mini-dot {
        background: #e2e8f0;
      }
      .lvl-1 .mini-dot {
        background: #93c5fd;
      }
      .lvl-2 .mini-dot {
        background: #60a5fa;
      }
      .lvl-3 .mini-dot {
        background: #4f46e5;
      }
      .lvl-4 .mini-dot {
        background: #7c3aed;
      }

      .below-target::after {
        content: "";
        position: absolute;
        inset: 7px 9px;
        border-radius: 13px;
        box-shadow: inset 0 0 0 2px rgba(239, 68, 68, 0.32);
        pointer-events: none;
      }

      .meets-target::after {
        content: "";
        position: absolute;
        inset: 7px 9px;
        border-radius: 13px;
        box-shadow: inset 0 0 0 2px rgba(22, 163, 74, 0.26);
        pointer-events: none;
      }

      .subtle {
        color: var(--muted);
        font-size: 12px;
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
      }

      .card {
        grid-column: span 6;
        padding: 14px;
        border-radius: var(--radius);
        border: 1px solid var(--border-2);
        background: rgba(255, 255, 255, 0.84);
        box-shadow: var(--shadow-soft);
      }

      @media (max-width: 980px) {
        .card {
          grid-column: span 12;
        }
        .pill input {
          min-width: 180px;
        }
      }

      .card h3 {
        margin: 0 0 8px;
        font-size: 14px;
        letter-spacing: -0.02em;
      }

      .metric {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        margin: 8px 0;
      }

      .metric .value {
        font-size: 26px;
        font-weight: 850;
        letter-spacing: -0.04em;
      }

      .metric .caption {
        color: var(--muted);
        font-size: 12px;
      }

      .bar {
        height: 12px;
        border-radius: 999px;
        background: rgba(2, 6, 23, 0.06);
        overflow: hidden;
        border: 1px solid rgba(2, 6, 23, 0.08);
      }

      .bar > div {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(79, 70, 229, 0.9), rgba(124, 58, 237, 0.9));
        width: 0%;
        transition: width 220ms ease;
      }

      .list {
        display: grid;
        gap: 8px;
        margin-top: 10px;
      }

      .list-item {
        border: 1px solid var(--border-2);
        border-radius: 12px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.66);
        display: grid;
        gap: 6px;
      }

      .list-item .top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .list-item .title {
        font-weight: 750;
        letter-spacing: -0.015em;
        font-size: 13px;
      }

      .list-item .meta {
        color: var(--muted);
        font-size: 12px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .list-item .mini-bar {
        height: 10px;
        border-radius: 999px;
        background: rgba(2, 6, 23, 0.06);
        overflow: hidden;
        border: 1px solid rgba(2, 6, 23, 0.08);
      }

      .list-item .mini-bar > div {
        height: 100%;
        border-radius: 999px;
        width: 0%;
        background: linear-gradient(90deg, rgba(16, 185, 129, 0.82), rgba(79, 70, 229, 0.9));
        transition: width 220ms ease;
      }

      .directory {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
      }

      .person {
        grid-column: span 6;
        border: 1px solid var(--border-2);
        border-radius: var(--radius);
        background: rgba(255, 255, 255, 0.80);
        box-shadow: var(--shadow-soft);
        overflow: hidden;
      }

      @media (max-width: 980px) {
        .person {
          grid-column: span 12;
        }
      }

      .person .head {
        padding: 12px 12px 10px;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
        border-bottom: 1px solid var(--border-2);
        background: rgba(255, 255, 255, 0.60);
      }

      .person .name {
        margin: 0;
        font-size: 14px;
        font-weight: 850;
        letter-spacing: -0.02em;
        line-height: 1.15;
      }

      .person .sub {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 12px;
      }

      .person .body {
        padding: 12px;
        display: grid;
        gap: 10px;
      }

      .kv {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 8px;
        align-items: baseline;
        font-size: 12px;
      }

      .kv .k {
        color: var(--muted);
      }

      .skill-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .skill-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 999px;
        border: 1px solid var(--border-2);
        background: rgba(2, 6, 23, 0.03);
        font-size: 12px;
        color: var(--muted);
        max-width: 100%;
      }

      .skill-pill .t {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 240px;
      }

      .skill-pill .lvl {
        font-family: var(--mono);
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(2, 6, 23, 0.06);
        color: rgba(15, 23, 42, 0.88);
        flex: 0 0 auto;
      }

      .toast-wrap {
        position: fixed;
        right: 14px;
        bottom: 14px;
        z-index: 120;
        display: grid;
        gap: 10px;
        width: min(420px, calc(100vw - 28px));
        pointer-events: none;
      }

      .toast {
        pointer-events: auto;
        border: 1px solid var(--border-2);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.86);
        box-shadow: var(--shadow);
        padding: 10px 10px;
        display: flex;
        gap: 10px;
        align-items: flex-start;
        animation: toastIn 220ms ease both;
      }

      @keyframes toastIn {
        from {
          transform: translateY(10px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .toast .badge {
        width: 32px;
        height: 32px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        flex: 0 0 auto;
      }

      .toast .badge.info {
        background: rgba(79, 70, 229, 0.12);
        color: var(--accent);
      }
      .toast .badge.good {
        background: rgba(16, 185, 129, 0.12);
        color: var(--good);
      }
      .toast .badge.warn {
        background: rgba(245, 158, 11, 0.14);
        color: #b45309;
      }
      .toast .badge.bad {
        background: rgba(239, 68, 68, 0.12);
        color: var(--bad);
      }

      .toast h4 {
        margin: 0;
        font-size: 13px;
        letter-spacing: -0.015em;
      }

      .toast p {
        margin: 3px 0 0;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.35;
      }

      .toast .x {
        margin-left: auto;
        border: 1px solid var(--border-2);
        background: rgba(255, 255, 255, 0.65);
        border-radius: 12px;
        width: 30px;
        height: 30px;
        cursor: pointer;
        display: grid;
        place-items: center;
      }

      dialog {
        border: none;
        border-radius: 18px;
        padding: 0;
        width: min(860px, calc(100vw - 26px));
        background: rgba(255, 255, 255, 0.92);
        box-shadow: var(--shadow);
      }

      dialog::backdrop {
        background: rgba(2, 6, 23, 0.42);
        backdrop-filter: blur(3px);
      }

      .modal {
        display: grid;
        grid-template-rows: auto 1fr auto;
        max-height: min(80vh, 760px);
      }

      .modal header {
        padding: 14px 14px 10px;
        border-bottom: 1px solid var(--border-2);
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        background: rgba(255, 255, 255, 0.80);
      }

      .modal header h3 {
        margin: 0;
        font-size: 14px;
        letter-spacing: -0.02em;
      }

      .modal header p {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.35;
      }

      .modal .close {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.72);
        border-radius: 12px;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: grid;
        place-items: center;
        flex: 0 0 auto;
      }

      .modal .body {
        padding: 14px;
        overflow: auto;
        display: grid;
        gap: 12px;
      }

      .modal footer {
        padding: 12px 14px;
        border-top: 1px solid var(--border-2);
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        align-items: center;
        flex-wrap: wrap;
        background: rgba(255, 255, 255, 0.76);
      }

      .two-col {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr;
      }

      @media (max-width: 780px) {
        .two-col {
          grid-template-columns: 1fr;
        }
      }

      .skill-edit {
        display: grid;
        gap: 10px;
        border: 1px solid var(--border-2);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.70);
        padding: 12px;
      }

      .skill-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        align-items: center;
        border-top: 1px dashed rgba(15, 23, 42, 0.12);
        padding-top: 10px;
      }

      .skill-row:first-child {
        border-top: none;
        padding-top: 0;
      }

      .slider {
        display: grid;
        gap: 6px;
        min-width: 220px;
      }

      input[type="range"] {
        width: 100%;
      }

      .range-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: var(--muted);
      }

      .kbd-help {
        font-size: 12px;
        color: var(--muted);
        display: grid;
        gap: 6px;
      }

      .kbd-help code {
        font-family: var(--mono);
        font-size: 11px;
        background: rgba(2, 6, 23, 0.06);
        padding: 2px 6px;
        border-radius: 8px;
      }

      .sr-only {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0, 0, 0, 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
      }

      @media print {
        .topbar,
        .controls,
        .matrix-top .actions,
        .toast-wrap,
        dialog {
          display: none !important;
        }
        body {
          background: white !important;
        }
        .panel,
        .person,
        .card {
          box-shadow: none !important;
        }
        .matrix-scroll {
          max-height: none !important;
          overflow: visible !important;
        }
        table.matrix th,
        table.matrix td {
          background: white !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="app" id="app">
      <div class="topbar">
        <div class="topbar-inner">
          <div class="brand">
            <div class="brand-left">
              <div class="logo" aria-hidden="true">
                <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                  <path
                    d="M12 12a4.2 4.2 0 1 0 0-8.4A4.2 4.2 0 0 0 12 12Zm0 2.3c-4.2 0-7.6 2.1-7.6 4.8 0 1.2 1 2.1 2.3 2.1h10.6c1.3 0 2.3-.9 2.3-2.1 0-2.7-3.4-4.8-7.6-4.8Z"
                  />
                </svg>
              </div>
              <div class="brand-meta">
                <h1>Employee Skills Matrix</h1>
                <p>HR-friendly skills coverage, gaps, and readiness — all in one place.</p>
              </div>
            </div>
            <div class="right-actions">
              <div class="pill" role="search">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    fill="currentColor"
                    d="M10.5 3a7.5 7.5 0 1 1 4.35 13.62l3.52 3.52a1 1 0 0 1-1.42 1.42l-3.52-3.52A7.5 7.5 0 0 1 10.5 3Zm0 2a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11Z"
                  />
                </svg>
                <input
                  id="globalSearch"
                  type="search"
                  placeholder="Search employees, skills, departments…"
                  autocomplete="off"
                  aria-label="Search employees, skills, departments"
                  aria-keyshortcuts="Control+K Meta+K"
                />
              </div>
              <button class="btn ghost" id="btnHelp" type="button" title="Keyboard & tips">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    fill="currentColor"
                    d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 14.7a1.2 1.2 0 1 1 0 2.4 1.2 1.2 0 0 1 0-2.4ZM11 7.6c0-.9.8-1.7 2-1.7 1.1 0 1.9.6 1.9 1.6 0 .8-.4 1.2-1.2 1.7-.9.6-1.4 1.2-1.4 2.3v.5h-1.8v-.7c0-1.5.7-2.4 1.8-3.1.7-.4.9-.7.9-1.1 0-.4-.3-.7-.8-.7-.5 0-.9.4-.9 1h-1.5Z"
                  />
                </svg>
                Help <span class="k">?</span>
              </button>
              <button class="btn" id="btnExport" type="button" title="Export JSON / CSV">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    fill="currentColor"
                    d="M12 3a1 1 0 0 1 1 1v8.59l2.3-2.3a1 1 0 1 1 1.4 1.42l-4 4a1 1 0 0 1-1.4 0l-4-4A1 1 0 1 1 8.7 10.3L11 12.59V4a1 1 0 0 1 1-1ZM5 19a1 1 0 0 1 1-1h12a1 1 0 1 1 0 2H6a1 1 0 0 1-1-1Z"
                  />
                </svg>
                Export
              </button>
              <button class="btn primary" id="btnAdd" type="button" title="Add employee or skill">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path fill="currentColor" d="M11 5a1 1 0 0 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5Z" />
                </svg>
                Add
              </button>
            </div>
          </div>

          <div class="tabs" role="tablist" aria-label="Views">
            <button class="tab" id="tabMatrix" role="tab" aria-selected="true" aria-controls="viewMatrix" type="button">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path
                  fill="currentColor"
                  d="M4 4h7v7H4V4Zm9 0h7v7h-7V4ZM4 13h7v7H4v-7Zm9 0h7v7h-7v-7Z"
                />
              </svg>
              Matrix
            </button>
            <button class="tab" id="tabInsights" role="tab" aria-selected="false" aria-controls="viewInsights" type="button">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M4 19h16v2H4v-2Zm2-2V9h3v8H6Zm5 0V5h3v12h-3Zm5 0v-6h3v6h-3Z" />
              </svg>
              Insights
            </button>
            <button class="tab" id="tabDirectory" role="tab" aria-selected="false" aria-controls="viewDirectory" type="button">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path
                  fill="currentColor"
                  d="M12 12a4.2 4.2 0 1 0 0-8.4A4.2 4.2 0 0 0 12 12Zm0 2.3c-4.2 0-7.6 2.1-7.6 4.8 0 1.2 1 2.1 2.3 2.1h10.6c1.3 0 2.3-.9 2.3-2.1 0-2.7-3.4-4.8-7.6-4.8Z"
                />
              </svg>
              Directory
            </button>
            <span class="chip" id="autosaveChip" title="Saved locally in your browser">
              <strong id="autosaveStatus">Autosaved</strong>
              <span id="autosaveTime">—</span>
            </span>
          </div>
        </div>
      </div>

      <main class="content">
        <section id="viewMatrix" class="grid-2" role="tabpanel" aria-labelledby="tabMatrix">
          <aside class="panel">
            <div class="panel-inner controls">
              <div class="section-title">
                <h2>Filters</h2>
                <button class="btn ghost" id="btnResetFilters" type="button" title="Reset filters">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      fill="currentColor"
                      d="M12 6V3l-4 4 4 4V8c2.76 0 5 2.24 5 5 0 1.17-.4 2.24-1.07 3.09l1.46 1.46A6.96 6.96 0 0 0 19 13c0-3.87-3.13-7-7-7Zm-5.93.91L4.61 5.45A6.96 6.96 0 0 0 5 13c0 3.87 3.13 7 7 7v3l4-4-4-4v3c-2.76 0-5-2.24-5-5 0-1.17.4-2.24 1.07-3.09Z"
                    />
                  </svg>
                  Reset
                </button>
              </div>

              <div class="field">
                <label class="label" for="filterDept">Employee department</label>
                <select class="select" id="filterDept"></select>
              </div>
              <div class="field">
                <label class="label" for="filterLocation">Location</label>
                <select class="select" id="filterLocation"></select>
              </div>
              <div class="field">
                <label class="label" for="filterStatus">Employment status</label>
                <select class="select" id="filterStatus"></select>
              </div>
              <div class="field">
                <label class="label" for="filterCategory">Skill category</label>
                <select class="select" id="filterCategory"></select>
              </div>
              <div class="field">
                <label class="label" for="filterCriticality">Criticality</label>
                <select class="select" id="filterCriticality"></select>
              </div>

              <div class="field">
                <label class="label" for="minLevel">
                  Show employees meeting level
                  <span class="mini" id="minLevelLabel">≥ 0</span>
                </label>
                <input id="minLevel" type="range" min="0" max="4" step="1" value="0" />
                <div class="range-labels" aria-hidden="true">
                  <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span>
                </div>
                <div class="hint">Highlights <span class="tag core">core</span> and target levels. Click a cell to cycle proficiency.</div>
              </div>

              <div class="legend">
                <div class="legend-row">
                  <div class="label">Proficiency levels</div>
                  <span class="chip" title="Keyboard navigation available"><strong>Keyboard</strong> supported</span>
                </div>
                <div class="swatches" aria-label="Proficiency legend">
                  <span class="swatch"><span class="dot l0"></span>0 None</span>
                  <span class="swatch"><span class="dot l1"></span>1 Aware</span>
                  <span class="swatch"><span class="dot l2"></span>2 Working</span>
                  <span class="swatch"><span class="dot l3"></span>3 Proficient</span>
                  <span class="swatch"><span class="dot l4"></span>4 Expert</span>
                </div>
                <div class="hint">
                  Targets are per-skill (set by HR). Red outline indicates below target; green outline indicates meets/exceeds.
                </div>
              </div>
            </div>
          </aside>

          <section class="panel matrix-panel" aria-label="Skills matrix">
            <div class="matrix-top">
              <div class="meta">
                <span class="chip"><strong id="statEmployees">—</strong> employees</span>
                <span class="chip"><strong id="statSkills">—</strong> skills</span>
                <span class="chip"><strong id="statCoverage">—</strong> target coverage</span>
              </div>
              <div class="actions row">
                <button class="btn" id="btnSort" type="button" title="Sort employees by coverage">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      fill="currentColor"
                      d="M7 6h14v2H7V6Zm0 5h10v2H7v-2Zm0 5h6v2H7v-2ZM3 5l2 2 2-2H3Zm0 10h4l-2-2-2 2Zm0 4h4l-2-2-2 2Z"
                    />
                  </svg>
                  Sort
                </button>
                <button class="btn ghost" id="btnPrint" type="button" title="Print current view">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      fill="currentColor"
                      d="M6 9V3h12v6H6Zm10-4H8v2h8V5Zm4 4h-1V7h-2v2H7V7H5v2H4a2 2 0 0 0-2 2v6h4v4h12v-4h4v-6a2 2 0 0 0-2-2Zm-6 12H8v-4h8v4Zm6-6h-4v-2H6v2H2v-4a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v4Z"
                    />
                  </svg>
                  Print
                </button>
              </div>
            </div>
            <div class="matrix-scroll" id="matrixScroll">
              <table class="matrix" id="matrixTable" aria-label="Employee skills matrix">
                <caption class="sr-only">
                  A grid of skills (rows) by employees (columns). Each cell is a proficiency level from 0 to 4; targets are
                  defined per skill.
                </caption>
                <thead id="matrixHead"></thead>
                <tbody id="matrixBody"></tbody>
              </table>
            </div>
          </section>
        </section>

        <section id="viewInsights" class="panel" role="tabpanel" aria-labelledby="tabInsights" hidden>
          <div class="panel-inner">
            <div class="section-title">
              <div>
                <h2>Insights</h2>
                <div class="hint">Coverage, gaps, and actionable recommendations for HR and people leaders.</div>
              </div>
              <div class="row">
                <button class="btn" id="btnRefreshInsights" type="button" title="Recompute insights">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      fill="currentColor"
                      d="M17.65 6.35A7.95 7.95 0 0 0 12 4V1L7 6l5 5V7c2.76 0 5 2.24 5 5 0 .86-.22 1.67-.61 2.39l1.46 1.46A7 7 0 0 0 19 12c0-1.93-.78-3.68-2.05-4.95ZM6.35 17.65A7.95 7.95 0 0 0 12 20v3l5-5-5-5v4c-2.76 0-5-2.24-5-5 0-.86.22-1.67.61-2.39L6.15 8.15A7 7 0 0 0 5 12c0 1.93.78 3.68 1.35 5.65Z"
                    />
                  </svg>
                  Refresh
                </button>
                <button class="btn ghost" id="btnShareReport" type="button" title="Copy a summary for email/Slack">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      fill="currentColor"
                      d="M16 13a3 3 0 0 0-2.24 1.02L8.91 11.7a3.07 3.07 0 0 0 0-1.4l4.8-2.32A3 3 0 1 0 13 6a2.98 2.98 0 0 0 .08.68l-4.8 2.32a3 3 0 1 0 0 4l4.85 2.33A3 3 0 1 0 16 13Z"
                    />
                  </svg>
                  Copy summary
                </button>
              </div>
            </div>

            <div class="cards" id="insightsCards"></div>
          </div>
        </section>

        <section id="viewDirectory" class="panel" role="tabpanel" aria-labelledby="tabDirectory" hidden>
          <div class="panel-inner">
            <div class="section-title">
              <div>
                <h2>Employee directory</h2>
                <div class="hint">HR-ready profiles with skill highlights, targets, and quick editing.</div>
              </div>
              <div class="row">
                <button class="btn" id="btnAddEmployee" type="button">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="currentColor" d="M11 5a1 1 0 0 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5Z" />
                  </svg>
                  Add employee
                </button>
                <button class="btn ghost" id="btnAddSkill" type="button">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      fill="currentColor"
                      d="M12 2a3 3 0 0 1 3 3v1h3a2 2 0 0 1 2 2v11a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8a2 2 0 0 1 2-2h3V5a3 3 0 0 1 3-3Zm1 4V5a1 1 0 0 0-2 0v1h2Zm-7 4v9a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-9H6Z"
                    />
                  </svg>
                  Add skill
                </button>
              </div>
            </div>
            <div class="directory" id="directoryList"></div>
          </div>
        </section>
      </main>

      <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-relevant="additions removals"></div>
    </div>

    <dialog id="modalShell" aria-labelledby="modalTitle">
      <div class="modal">
        <header>
          <div>
            <h3 id="modalTitle">Modal</h3>
            <p id="modalSubtitle" class="subtle">—</p>
          </div>
          <button class="close" id="modalClose" type="button" aria-label="Close dialog">
            <svg viewBox="0 0 24 24" aria-hidden="true" width="18" height="18">
              <path
                fill="currentColor"
                d="M18.3 5.7a1 1 0 0 0-1.4 0L12 10.6 7.1 5.7a1 1 0 0 0-1.4 1.4l4.9 4.9-4.9 4.9a1 1 0 1 0 1.4 1.4l4.9-4.9 4.9 4.9a1 1 0 0 0 1.4-1.4L13.4 12l4.9-4.9a1 1 0 0 0 0-1.4Z"
              />
            </svg>
          </button>
        </header>
        <div class="body" id="modalBody"></div>
        <footer id="modalFooter"></footer>
      </div>
    </dialog>

    <script>
      (() => {
        "use strict";

        const APP_NAME = "Employee Skills Matrix";
        const STORAGE_KEY = "esm_state_v1";
        const LEVELS = [
          { id: 0, short: "0", label: "None", desc: "No demonstrated experience yet." },
          { id: 1, short: "1", label: "Aware", desc: "Understands basics; needs guidance." },
          { id: 2, short: "2", label: "Working", desc: "Can perform tasks with occasional support." },
          { id: 3, short: "3", label: "Proficient", desc: "Reliable independent performer." },
          { id: 4, short: "4", label: "Expert", desc: "Go-to specialist; can mentor others." }
        ];

        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
        const deepClone = (obj) => {
          if (obj == null) return obj;
          try {
            if (typeof structuredClone === "function") return structuredClone(obj);
          } catch {}
          return JSON.parse(JSON.stringify(obj));
        };
        const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));
        const uniq = (arr) => Array.from(new Set(arr));
        const safeText = (s) => (s == null ? "" : String(s));
        const formatPct = (n) => `${Math.round(n)}%`;
        const plural = (n, one, many = one + "s") => (n === 1 ? one : many);

        const nowStamp = () => {
          const d = new Date();
          const hh = String(d.getHours()).padStart(2, "0");
          const mm = String(d.getMinutes()).padStart(2, "0");
          return `${hh}:${mm}`;
        };

        function defaultSeed() {
          const skills = [
            {
              id: "s-hris",
              name: "HRIS administration (Workday/SuccessFactors)",
              category: "HR Systems",
              criticality: "Core",
              target: 3,
              description: "Configure, maintain, and report from the HRIS."
            },
            {
              id: "s-compliance",
              name: "Employment law & compliance",
              category: "Compliance",
              criticality: "Core",
              target: 3,
              description: "Local employment practices, policies, and risk mitigation."
            },
            {
              id: "s-payroll",
              name: "Payroll fundamentals",
              category: "Compensation & Payroll",
              criticality: "Core",
              target: 2,
              description: "Payroll cycles, controls, and audits."
            },
            {
              id: "s-benefits",
              name: "Benefits administration",
              category: "Compensation & Payroll",
              criticality: "Core",
              target: 2,
              description: "Enrollments, vendor coordination, and employee support."
            },
            {
              id: "s-recruiting",
              name: "Recruiting operations",
              category: "Talent Acquisition",
              criticality: "Secondary",
              target: 2,
              description: "ATS workflows, scheduling, and candidate experience."
            },
            {
              id: "s-interviewing",
              name: "Structured interviewing",
              category: "Talent Acquisition",
              criticality: "Core",
              target: 3,
              description: "Competency-based interviewing and bias mitigation."
            },
            {
              id: "s-onboarding",
              name: "Onboarding program design",
              category: "People Operations",
              criticality: "Secondary",
              target: 2,
              description: "New hire onboarding and assimilation experiences."
            },
            {
              id: "s-er",
              name: "Employee relations (ER) cases",
              category: "Employee Relations",
              criticality: "Core",
              target: 3,
              description: "Investigations, documentation, and resolution planning."
            },
            {
              id: "s-coaching",
              name: "Manager coaching",
              category: "Leadership & Culture",
              criticality: "Secondary",
              target: 2,
              description: "Support leaders through performance and team challenges."
            },
            {
              id: "s-perf",
              name: "Performance cycle management",
              category: "People Operations",
              criticality: "Core",
              target: 3,
              description: "Design and run performance calibration and reviews."
            },
            {
              id: "s-analytics",
              name: "People analytics",
              category: "Analytics",
              criticality: "Secondary",
              target: 2,
              description: "Dashboards, trends, and insights storytelling."
            },
            {
              id: "s-dei",
              name: "DEI program delivery",
              category: "Leadership & Culture",
              criticality: "Secondary",
              target: 2,
              description: "Inclusive hiring and culture initiatives."
            },
            {
              id: "s-lnd",
              name: "Learning & development (L&D)",
              category: "Learning",
              criticality: "Nice-to-have",
              target: 1,
              description: "Training needs analysis and program execution."
            },
            {
              id: "s-comp",
              name: "Compensation benchmarking",
              category: "Compensation & Payroll",
              criticality: "Secondary",
              target: 2,
              description: "Market pricing and pay range design support."
            },
            {
              id: "s-privacy",
              name: "Data privacy handling",
              category: "Compliance",
              criticality: "Core",
              target: 3,
              description: "PII security, retention, and access controls."
            }
          ];

          const employees = [
            {
              id: "e-ava",
              name: "Ava Chen",
              title: "HR Business Partner",
              department: "People Team",
              location: "New York",
              manager: "VP People",
              status: "Active",
              startDate: "2022-03-14",
              skills: {
                "s-compliance": 3,
                "s-er": 4,
                "s-coaching": 3,
                "s-perf": 3,
                "s-privacy": 3,
                "s-analytics": 2,
                "s-dei": 2
              }
            },
            {
              id: "e-noah",
              name: "Noah Patel",
              title: "People Operations Specialist",
              department: "People Team",
              location: "Remote",
              manager: "Head of People Ops",
              status: "Active",
              startDate: "2023-06-01",
              skills: {
                "s-hris": 2,
                "s-onboarding": 3,
                "s-perf": 2,
                "s-payroll": 2,
                "s-benefits": 3,
                "s-privacy": 3
              }
            },
            {
              id: "e-maya",
              name: "Maya Rodriguez",
              title: "Recruiting Lead",
              department: "Talent Acquisition",
              location: "Austin",
              manager: "VP People",
              status: "Active",
              startDate: "2021-09-20",
              skills: {
                "s-recruiting": 4,
                "s-interviewing": 4,
                "s-dei": 3,
                "s-analytics": 2,
                "s-onboarding": 2
              }
            },
            {
              id: "e-oliver",
              name: "Oliver Kim",
              title: "HRIS & Analytics Analyst",
              department: "People Analytics",
              location: "San Francisco",
              manager: "Director, People Analytics",
              status: "Active",
              startDate: "2020-11-02",
              skills: {
                "s-hris": 4,
                "s-analytics": 4,
                "s-privacy": 4,
                "s-comp": 2,
                "s-perf": 2
              }
            },
            {
              id: "e-sophia",
              name: "Sophia Nguyen",
              title: "Total Rewards Partner",
              department: "Total Rewards",
              location: "Remote",
              manager: "Director, Total Rewards",
              status: "Active",
              startDate: "2022-01-10",
              skills: {
                "s-payroll": 3,
                "s-benefits": 4,
                "s-comp": 4,
                "s-privacy": 3,
                "s-compliance": 2
              }
            },
            {
              id: "e-liam",
              name: "Liam Brooks",
              title: "HR Coordinator",
              department: "People Team",
              location: "New York",
              manager: "Head of People Ops",
              status: "On Leave",
              startDate: "2024-02-12",
              skills: {
                "s-onboarding": 2,
                "s-hris": 1,
                "s-privacy": 2,
                "s-benefits": 1
              }
            }
          ];

          return {
            version: 1,
            updatedAt: Date.now(),
            settings: {
              sortMode: "name",
              filters: {
                dept: "All",
                location: "All",
                status: "All",
                category: "All",
                criticality: "All",
                minLevel: 0,
                q: ""
              }
            },
            skills,
            employees
          };
        }

        function loadState() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return defaultSeed();
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== "object") return defaultSeed();
            if (!Array.isArray(parsed.skills) || !Array.isArray(parsed.employees)) return defaultSeed();
            // Basic forward compatibility defaults
            parsed.version = parsed.version || 1;
            parsed.updatedAt = parsed.updatedAt || Date.now();
            parsed.settings = parsed.settings || defaultSeed().settings;
            parsed.settings.filters = { ...defaultSeed().settings.filters, ...(parsed.settings.filters || {}) };
            parsed.settings.sortMode = parsed.settings.sortMode || "name";
            return parsed;
          } catch {
            return defaultSeed();
          }
        }

        function saveState() {
          state.updatedAt = Date.now();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          renderAutosave();
        }

        function setAutosave(text, kind = "ok") {
          const status = $("#autosaveStatus");
          const time = $("#autosaveTime");
          status.textContent = text;
          time.textContent = nowStamp();
          const chip = $("#autosaveChip");
          chip.style.borderColor =
            kind === "bad"
              ? "rgba(239, 68, 68, 0.22)"
              : kind === "warn"
                ? "rgba(245, 158, 11, 0.28)"
                : "rgba(79, 70, 229, 0.18)";
          chip.style.background =
            kind === "bad"
              ? "rgba(239, 68, 68, 0.08)"
              : kind === "warn"
                ? "rgba(245, 158, 11, 0.10)"
                : "rgba(79, 70, 229, 0.08)";
        }

        function toast({ title, message, kind = "info", timeout = 3200 }) {
          const wrap = $("#toastWrap");
          const el = document.createElement("div");
          el.className = "toast";
          el.innerHTML = `
            <div class="badge ${kind}" aria-hidden="true">
              ${iconFor(kind)}
            </div>
            <div>
              <h4>${escapeHtml(title)}</h4>
              <p>${escapeHtml(message)}</p>
            </div>
            <button class="x" type="button" aria-label="Dismiss notification">
              <svg viewBox="0 0 24 24" aria-hidden="true" width="18" height="18">
                <path fill="currentColor" d="M18.3 5.7a1 1 0 0 0-1.4 0L12 10.6 7.1 5.7a1 1 0 0 0-1.4 1.4l4.9 4.9-4.9 4.9a1 1 0 1 0 1.4 1.4l4.9-4.9 4.9 4.9a1 1 0 0 0 1.4-1.4L13.4 12l4.9-4.9a1 1 0 0 0 0-1.4Z" />
              </svg>
            </button>
          `;
          const btn = $(".x", el);
          const remove = () => {
            if (!el.isConnected) return;
            el.style.transition = "opacity 160ms ease, transform 160ms ease";
            el.style.opacity = "0";
            el.style.transform = "translateY(8px)";
            setTimeout(() => el.remove(), 180);
          };
          btn.addEventListener("click", remove);
          wrap.prepend(el);
          if (timeout > 0) setTimeout(remove, timeout);
        }

        function iconFor(kind) {
          const common = `viewBox="0 0 24 24" width="18" height="18"`;
          if (kind === "good") {
            return `<svg ${common}><path fill="currentColor" d="M9.5 16.2 5.8 12.5a1 1 0 0 1 1.4-1.4l2.3 2.3 7.1-7.1a1 1 0 1 1 1.4 1.4l-8.5 8.5a1 1 0 0 1-1.4 0Z"/></svg>`;
          }
          if (kind === "warn") {
            return `<svg ${common}><path fill="currentColor" d="M12 2a1 1 0 0 1 .9.55l9 18a1 1 0 0 1-.9 1.45H3a1 1 0 0 1-.9-1.45l9-18A1 1 0 0 1 12 2Zm0 6a1 1 0 0 0-1 1v5a1 1 0 1 0 2 0V9a1 1 0 0 0-1-1Zm0 10a1.2 1.2 0 1 0 0 2.4A1.2 1.2 0 0 0 12 18Z"/></svg>`;
          }
          if (kind === "bad") {
            return `<svg ${common}><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm-1 5a1 1 0 0 1 2 0v7a1 1 0 1 1-2 0V7Zm1 10.7a1.2 1.2 0 1 1 0 2.4 1.2 1.2 0 0 1 0-2.4Z"/></svg>`;
          }
          return `<svg ${common}><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 8a1 1 0 0 1 1 1v6a1 1 0 1 1-2 0v-6a1 1 0 0 1 1-1Zm0-4.7a1.2 1.2 0 1 1 0 2.4 1.2 1.2 0 0 1 0-2.4Z"/></svg>`;
        }

        function escapeHtml(s) {
          return String(s).replace(/[&<>"']/g, (c) => {
            const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" };
            return map[c] || c;
          });
        }

        function pick(list, key) {
          return list.map((x) => x[key]).filter(Boolean);
        }

        function roleTagFor(skill) {
          if (skill.category === "Compliance") return "compliance";
          if (skill.criticality === "Core") return "core";
          if (skill.criticality === "Nice-to-have") return "";
          return "";
        }

        function riskTag(skill, coveragePct) {
          if (skill.criticality === "Core" && coveragePct < 60) return "risk";
          if (skill.category === "Compliance" && coveragePct < 75) return "risk";
          return "";
        }

        function levelLabel(level) {
          return LEVELS[clamp(level, 0, 4)].label;
        }

        function skillById(id) {
          return state.skills.find((s) => s.id === id);
        }

        function employeeById(id) {
          return state.employees.find((e) => e.id === id);
        }

        function normalizeString(s) {
          return safeText(s).trim().toLowerCase();
        }

        function matchesQuery(text, q) {
          const qq = normalizeString(q);
          if (!qq) return true;
          return normalizeString(text).includes(qq);
        }

        function applyGlobalSearch(q) {
          state.settings.filters.q = q;
          $("#globalSearch").value = q;
          render();
          saveState();
        }

        function derived() {
          const filters = state.settings.filters;
          const q = filters.q || "";
          const employees = state.employees
            .filter((e) => (filters.dept === "All" ? true : e.department === filters.dept))
            .filter((e) => (filters.location === "All" ? true : e.location === filters.location))
            .filter((e) => (filters.status === "All" ? true : e.status === filters.status))
            .filter((e) =>
              matchesQuery(
                `${e.name} ${e.title} ${e.department} ${e.location} ${e.manager} ${e.status}`.trim(),
                q
              )
            );

          const skills = state.skills
            .filter((s) => (filters.category === "All" ? true : s.category === filters.category))
            .filter((s) => (filters.criticality === "All" ? true : s.criticality === filters.criticality))
            .filter((s) => matchesQuery(`${s.name} ${s.category} ${s.criticality} ${s.description}`.trim(), q));

          // Sorting
          const sortMode = state.settings.sortMode || "name";
          const sortedEmployees = [...employees];
          if (sortMode === "coverage") {
            sortedEmployees.sort((a, b) => employeeCoverageScore(b, skills) - employeeCoverageScore(a, skills));
          } else if (sortMode === "department") {
            sortedEmployees.sort((a, b) => (a.department + a.name).localeCompare(b.department + b.name));
          } else {
            sortedEmployees.sort((a, b) => a.name.localeCompare(b.name));
          }

          const sortedSkills = [...skills].sort((a, b) => {
            const aKey = `${a.category}::${a.criticality}::${a.name}`;
            const bKey = `${b.category}::${b.criticality}::${b.name}`;
            return aKey.localeCompare(bKey);
          });

          return { filters, q, employees: sortedEmployees, skills: sortedSkills };
        }

        function employeeCoverageScore(employee, skills) {
          if (!skills.length) return 0;
          let targets = 0;
          let met = 0;
          for (const s of skills) {
            if ((s.target ?? 0) <= 0) continue;
            targets++;
            const lvl = clamp(employee.skills?.[s.id] ?? 0, 0, 4);
            if (lvl >= s.target) met++;
          }
          if (!targets) return 0;
          return met / targets;
        }

        function overallCoverage(employees, skills) {
          let targets = 0;
          let met = 0;
          for (const s of skills) {
            if ((s.target ?? 0) <= 0) continue;
            for (const e of employees) {
              targets++;
              const lvl = clamp(e.skills?.[s.id] ?? 0, 0, 4);
              if (lvl >= s.target) met++;
            }
          }
          if (!targets) return 0;
          return met / targets;
        }

        function skillCoverage(skill, employees) {
          const target = clamp(skill.target ?? 0, 0, 4);
          if (!employees.length) return { coverage: 0, avg: 0, experts: 0, target, total: 0, met: 0 };
          let sum = 0;
          let met = 0;
          let experts = 0;
          for (const e of employees) {
            const lvl = clamp(e.skills?.[skill.id] ?? 0, 0, 4);
            sum += lvl;
            if (lvl >= target) met++;
            if (lvl >= 4) experts++;
          }
          const avg = sum / employees.length;
          const coverage = target === 0 ? 1 : met / employees.length;
          return { coverage, avg, experts, target, total: employees.length, met };
        }

        function renderAutosave() {
          const t = $("#autosaveTime");
          if (!t.textContent || t.textContent === "—") t.textContent = nowStamp();
        }

        function fillSelect(selectEl, options, current) {
          selectEl.innerHTML = options
            .map((o) => `<option value="${escapeHtml(o)}" ${o === current ? "selected" : ""}>${escapeHtml(o)}</option>`)
            .join("");
        }

        function renderFilters() {
          const filters = state.settings.filters;

          const deptOpts = ["All", ...uniq(state.employees.map((e) => e.department)).sort()];
          const locOpts = ["All", ...uniq(state.employees.map((e) => e.location)).sort()];
          const statusOpts = ["All", ...uniq(state.employees.map((e) => e.status)).sort()];
          const catOpts = ["All", ...uniq(state.skills.map((s) => s.category)).sort()];
          const critOpts = ["All", ...uniq(state.skills.map((s) => s.criticality)).sort()];

          fillSelect($("#filterDept"), deptOpts, filters.dept);
          fillSelect($("#filterLocation"), locOpts, filters.location);
          fillSelect($("#filterStatus"), statusOpts, filters.status);
          fillSelect($("#filterCategory"), catOpts, filters.category);
          fillSelect($("#filterCriticality"), critOpts, filters.criticality);

          $("#minLevel").value = String(filters.minLevel);
          $("#minLevelLabel").textContent = `≥ ${filters.minLevel}`;
          $("#globalSearch").value = filters.q || "";
        }

        function renderStats(view) {
          $("#statEmployees").textContent = String(view.employees.length);
          $("#statSkills").textContent = String(view.skills.length);
          const cov = overallCoverage(view.employees, view.skills);
          $("#statCoverage").textContent = view.skills.length ? formatPct(cov * 100) : "—";
        }

        function cellClass(level, target) {
          const lvl = clamp(level, 0, 4);
          const t = clamp(target ?? 0, 0, 4);
          const base = `cell-btn lvl-${lvl}`;
          if (t === 0) return base;
          if (lvl >= t) return base + " meets-target";
          return base + " below-target";
        }

        function renderMatrix() {
          const view = derived();
          renderStats(view);

          const head = $("#matrixHead");
          const body = $("#matrixBody");
          const minLevel = clamp(Number(view.filters.minLevel ?? 0), 0, 4);

          // Header
          const headRow = document.createElement("tr");
          const corner = document.createElement("th");
          corner.className = "corner th-skill";
          corner.scope = "col";
          corner.innerHTML = `
            <div class="skill-title">
              <div>
                <div class="skill-name">Skill</div>
                <div class="skill-desc">Target • Category • Criticality</div>
              </div>
              <div class="skill-tags">
                <span class="tag" title="Sorted by category, then criticality, then name">Sorted</span>
              </div>
            </div>
          `;
          headRow.appendChild(corner);
          for (const e of view.employees) {
            const th = document.createElement("th");
            th.className = "th-emp";
            th.scope = "col";
            th.innerHTML = `
              <p class="emp-name" title="${escapeHtml(e.name)}">${escapeHtml(e.name)}</p>
              <p class="emp-meta" title="${escapeHtml(`${e.title} • ${e.department}`)}">${escapeHtml(
                `${e.title}`
              )}</p>
            `;
            headRow.appendChild(th);
          }
          head.innerHTML = "";
          head.appendChild(headRow);

          // Body
          body.innerHTML = "";
          const frag = document.createDocumentFragment();

          for (const s of view.skills) {
            const tr = document.createElement("tr");
            const th = document.createElement("th");
            th.className = "th-skill";
            th.scope = "row";

            const coverageInfo = skillCoverage(s, view.employees);
            const covPct = coverageInfo.coverage * 100;
            const tag1 = roleTagFor(s);
            const tag2 = riskTag(s, covPct);
            const tags = [tag1, tag2].filter(Boolean);

            const catTag =
              s.category === "Compliance" ? `<span class="tag compliance">Compliance</span>` : `<span class="tag">${escapeHtml(s.category)}</span>`;
            const critTag = s.criticality === "Core" ? `<span class="tag core">Core</span>` : `<span class="tag">${escapeHtml(s.criticality)}</span>`;
            const risk =
              tags.includes("risk")
                ? `<span class="tag risk" title="Low target coverage for a core/compliance skill">Risk</span>`
                : "";

            th.innerHTML = `
              <div class="skill-title">
                <p class="skill-name" title="${escapeHtml(s.name)}">${escapeHtml(s.name)}</p>
                <div class="skill-tags">
                  <span class="tag" title="Target proficiency set by HR">Target ${escapeHtml(String(s.target ?? 0))}</span>
                  ${critTag}
                  ${catTag}
                  ${risk}
                </div>
              </div>
              <p class="skill-desc" title="${escapeHtml(s.description || "")}">
                ${escapeHtml(s.description || "—")}
                • Coverage ${formatPct(covPct)} • Avg ${coverageInfo.avg.toFixed(1)} • Experts ${coverageInfo.experts}
              </p>
            `;
            tr.appendChild(th);

            for (const e of view.employees) {
              const td = document.createElement("td");
              const lvl = clamp(e.skills?.[s.id] ?? 0, 0, 4);
              const meetsMin = lvl >= minLevel;
              const btn = document.createElement("button");
              btn.type = "button";
              btn.className = cellClass(lvl, s.target);
              btn.dataset.empId = e.id;
              btn.dataset.skillId = s.id;
              btn.dataset.level = String(lvl);
              btn.setAttribute(
                "aria-label",
                `${e.name} — ${s.name}: level ${lvl} (${levelLabel(lvl)}). Target ${s.target ?? 0}. Click to change.`
              );
              btn.title = `${e.name}\n${s.name}\nLevel ${lvl} (${levelLabel(lvl)})\nTarget ${s.target ?? 0}\n\nTip: Click cycles. Shift+Click goes backward. Keys 0–4 set level.`;
              btn.innerHTML = `
                <span class="cell-badge" aria-hidden="true">
                  <span class="mini-dot"></span>
                  <span>${meetsMin ? lvl : "·"}</span>
                </span>
              `;
              td.appendChild(btn);
              tr.appendChild(td);
            }
            frag.appendChild(tr);
          }
          body.appendChild(frag);

          // If no rows
          if (!view.skills.length || !view.employees.length) {
            const tr = document.createElement("tr");
            const th = document.createElement("th");
            th.className = "th-skill";
            th.scope = "row";
            th.innerHTML = `
              <div class="skill-title">
                <p class="skill-name">No results</p>
                <div class="skill-tags"><span class="tag">Try adjusting filters</span></div>
              </div>
              <p class="skill-desc">Use the search box or reset filters. You can also add employees/skills.</p>
            `;
            tr.appendChild(th);
            const td = document.createElement("td");
            td.colSpan = Math.max(1, view.employees.length);
            td.style.padding = "12px";
            td.innerHTML = `<div class="hint">Nothing to display in the matrix yet.</div>`;
            tr.appendChild(td);
            body.appendChild(tr);
          }
        }

        function renderDirectory() {
          const view = derived();
          const list = $("#directoryList");
          const frag = document.createDocumentFragment();
          list.innerHTML = "";

          const skillsById = new Map(state.skills.map((s) => [s.id, s]));
          for (const e of view.employees) {
            const allPairs = Object.entries(e.skills || {})
              .map(([sid, lvl]) => ({ s: skillsById.get(sid), lvl: clamp(lvl ?? 0, 0, 4) }))
              .filter((x) => x.s)
              .sort((a, b) => b.lvl - a.lvl || a.s.name.localeCompare(b.s.name));

            const highlights = allPairs.filter((x) => x.lvl >= 3).slice(0, 6);
            const meets = Math.round(employeeCoverageScore(e, state.skills) * 100);

            const card = document.createElement("article");
            card.className = "person";
            card.innerHTML = `
              <div class="head">
                <div style="min-width:0">
                  <p class="name">${escapeHtml(e.name)}</p>
                  <p class="sub">${escapeHtml(e.title)} • ${escapeHtml(e.department)} • ${escapeHtml(
              e.location
            )} • <span class="tag ${e.status === "Active" ? "core" : ""}">${escapeHtml(e.status)}</span></p>
                </div>
                <button class="btn" type="button" data-action="edit-employee" data-id="${escapeHtml(e.id)}">
                  <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 17.25V21h3.75L17.8 9.95l-3.75-3.75L3 17.25Zm18.7-11.2a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83Z"/></svg>
                  Edit
                </button>
              </div>
              <div class="body">
                <div class="kv"><div class="k">Manager</div><div>${escapeHtml(e.manager || "—")}</div></div>
                <div class="kv"><div class="k">Start date</div><div>${escapeHtml(e.startDate || "—")}</div></div>
                <div class="kv"><div class="k">Target coverage</div><div><strong>${meets}%</strong> <span class="subtle">(skills at/above target)</span></div></div>
                <div>
                  <div class="subtle">Highlights (levels 3–4)</div>
                  <div class="skill-badges">
                    ${
                      highlights.length
                        ? highlights
                            .map(
                              (x) =>
                                `<span class="skill-pill" title="${escapeHtml(
                                  x.s.name
                                )} — ${escapeHtml(levelLabel(x.lvl))}"><span class="dot l${x.lvl}" aria-hidden="true"></span><span class="t">${escapeHtml(
                                  x.s.name
                                )}</span><span class="lvl">${x.lvl}</span></span>`
                            )
                            .join("")
                        : `<span class="subtle">No highlights yet — add skill evidence to build a development plan.</span>`
                    }
                  </div>
                </div>
              </div>
            `;
            frag.appendChild(card);
          }

          list.appendChild(frag);
        }

        function insightsCompute() {
          const view = derived();
          const employees = view.employees;
          const skills = view.skills;

          const overall = overallCoverage(employees, skills);
          const coreSkills = skills.filter((s) => s.criticality === "Core");
          const complianceSkills = skills.filter((s) => s.category === "Compliance");
          const coreCov = overallCoverage(employees, coreSkills);
          const compCov = overallCoverage(employees, complianceSkills);

          const bySkill = skills.map((s) => {
            const c = skillCoverage(s, employees);
            const covPct = c.coverage * 100;
            const deficit = clamp((c.target === 0 ? 100 : 100 - covPct), 0, 100);
            return {
              ...s,
              covPct,
              avg: c.avg,
              experts: c.experts,
              met: c.met,
              total: c.total,
              deficit
            };
          });

          const topRisks = [...bySkill]
            .sort((a, b) => {
              const aW = (a.criticality === "Core" ? 2 : 1) * (a.category === "Compliance" ? 2 : 1);
              const bW = (b.criticality === "Core" ? 2 : 1) * (b.category === "Compliance" ? 2 : 1);
              return bW * b.deficit - aW * a.deficit || a.covPct - b.covPct;
            })
            .slice(0, 7);

          const topExperts = bySkill
            .filter((x) => x.experts > 0)
            .sort((a, b) => b.experts - a.experts || b.covPct - a.covPct)
            .slice(0, 7);

          const employeeScores = employees
            .map((e) => {
              const score = employeeCoverageScore(e, skills);
              const top = Object.entries(e.skills || {})
                .map(([sid, lvl]) => ({ sid, lvl: clamp(lvl ?? 0, 0, 4) }))
                .sort((a, b) => b.lvl - a.lvl)
                .slice(0, 3)
                .map((x) => `${skillById(x.sid)?.name || "Skill"} (${x.lvl})`);
              return { e, score, top };
            })
            .sort((a, b) => b.score - a.score);

          // Training recommendations: prioritize risky skills and identify close-to-target employees
          const recs = [];
          const prioritized = [...bySkill]
            .filter((x) => (x.target ?? 0) > 0)
            .sort((a, b) => {
              const aW = (a.criticality === "Core" ? 2 : 1) * (a.category === "Compliance" ? 2 : 1);
              const bW = (b.criticality === "Core" ? 2 : 1) * (b.category === "Compliance" ? 2 : 1);
              return bW * b.deficit - aW * a.deficit;
            })
            .slice(0, 6);

          for (const s of prioritized) {
            const target = clamp(s.target ?? 0, 0, 4);
            const candidates = employees
              .map((e) => ({ e, lvl: clamp(e.skills?.[s.id] ?? 0, 0, 4) }))
              .filter((x) => x.lvl < target)
              .sort((a, b) => b.lvl - a.lvl)
              .slice(0, 4);
            if (!candidates.length) continue;
            recs.push({
              skill: s,
              target,
              candidates,
              rationale:
                s.category === "Compliance"
                  ? "Reduce compliance exposure by building depth."
                  : s.criticality === "Core"
                    ? "Strengthen core operating capability."
                    : "Build resilience and coverage."
            });
          }

          return {
            view,
            overall,
            coreCov,
            compCov,
            bySkill,
            topRisks,
            topExperts,
            employeeScores,
            recs
          };
        }

        function renderInsights() {
          const wrap = $("#insightsCards");
          wrap.innerHTML = "";
          const data = insightsCompute();

          const cards = [];
          cards.push(renderCardSummary(data));
          cards.push(renderCardRisks(data));
          cards.push(renderCardRecommendations(data));
          cards.push(renderCardExperts(data));
          cards.push(renderCardReadiness(data));

          for (const c of cards) wrap.appendChild(c);
          animateBars(wrap);
        }

        function renderCardSummary(data) {
          const el = document.createElement("div");
          el.className = "card";
          const overall = Math.round(data.overall * 100);
          const core = Math.round(data.coreCov * 100);
          const comp = Math.round(data.compCov * 100);
          const employees = data.view.employees.length;
          const skills = data.view.skills.length;

          const gaps = data.bySkill
            .filter((s) => (s.target ?? 0) > 0 && s.covPct < 70)
            .slice(0, 999).length;

          el.innerHTML = `
            <h3>Coverage snapshot</h3>
            <div class="metric"><div><div class="value">${overall}%</div><div class="caption">Overall target coverage</div></div>
              <div class="chip"><strong>${employees}</strong> ${plural(employees, "employee")} • <strong>${skills}</strong> ${plural(skills, "skill")}</div>
            </div>
            <div class="bar" aria-label="Overall coverage bar"><div data-pct="${overall}"></div></div>
            <div class="row" style="margin-top:10px">
              <span class="chip"><strong>${core}%</strong> core skills coverage</span>
              <span class="chip"><strong>${comp}%</strong> compliance coverage</span>
              <span class="chip"><strong>${gaps}</strong> skills below 70%</span>
            </div>
            <p class="hint" style="margin:10px 0 0">
              Tip: Use <span class="tag core">Core</span> + <span class="tag compliance">Compliance</span> filters to focus on high-impact skills for audits and workforce planning.
            </p>
          `;
          return el;
        }

        function renderCardRisks(data) {
          const el = document.createElement("div");
          el.className = "card";
          el.innerHTML = `
            <h3>Highest gap skills</h3>
            <div class="hint">Sorted by weighted deficit (core + compliance prioritized).</div>
            <div class="list" id="riskList"></div>
          `;
          const list = $("#riskList", el);
          for (const s of data.topRisks) {
            const tag = riskTag(s, s.covPct);
            const li = document.createElement("div");
            li.className = "list-item";
            const tagHtml = [
              s.criticality === "Core" ? `<span class="tag core">Core</span>` : `<span class="tag">${escapeHtml(s.criticality)}</span>`,
              s.category === "Compliance" ? `<span class="tag compliance">Compliance</span>` : `<span class="tag">${escapeHtml(s.category)}</span>`,
              tag ? `<span class="tag risk">Risk</span>` : ""
            ]
              .filter(Boolean)
              .join(" ");
            li.innerHTML = `
              <div class="top">
                <div class="title">${escapeHtml(s.name)}</div>
                <div class="skill-tags" style="justify-content:flex-end">${tagHtml}</div>
              </div>
              <div class="meta">
                <span>Target ${escapeHtml(String(s.target ?? 0))}</span>
                <span>Coverage <strong>${formatPct(s.covPct)}</strong> (${s.met}/${s.total})</span>
                <span>Avg ${s.avg.toFixed(1)}</span>
              </div>
              <div class="mini-bar" aria-label="Coverage bar"><div data-pct="${Math.round(s.covPct)}"></div></div>
            `;
            list.appendChild(li);
          }
          return el;
        }

        function renderCardRecommendations(data) {
          const el = document.createElement("div");
          el.className = "card";
          el.innerHTML = `
            <h3>Development recommendations</h3>
            <div class="hint">Suggested focus areas and who is closest to meeting target.</div>
            <div class="list" id="recList"></div>
          `;
          const list = $("#recList", el);
          if (!data.recs.length) {
            const li = document.createElement("div");
            li.className = "list-item";
            li.innerHTML = `<div class="title">No recommendations right now</div><div class="meta">Add targets to skills or expand the matrix to generate actionable suggestions.</div>`;
            list.appendChild(li);
            return el;
          }
          for (const r of data.recs) {
            const li = document.createElement("div");
            li.className = "list-item";
            li.innerHTML = `
              <div class="top">
                <div class="title">${escapeHtml(r.skill.name)}</div>
                <div class="skill-tags" style="justify-content:flex-end">
                  <span class="tag">Target ${escapeHtml(String(r.target))}</span>
                  ${r.skill.criticality === "Core" ? `<span class="tag core">Core</span>` : `<span class="tag">${escapeHtml(r.skill.criticality)}</span>`}
                  ${r.skill.category === "Compliance" ? `<span class="tag compliance">Compliance</span>` : `<span class="tag">${escapeHtml(r.skill.category)}</span>`}
                </div>
              </div>
              <div class="meta">
                <span>${escapeHtml(r.rationale)}</span>
                <span>Closest: ${r.candidates.map((c) => `${escapeHtml(c.e.name)} (${c.lvl})`).join(", ")}</span>
              </div>
            `;
            list.appendChild(li);
          }
          return el;
        }

        function renderCardExperts(data) {
          const el = document.createElement("div");
          el.className = "card";
          el.innerHTML = `
            <h3>Expert coverage</h3>
            <div class="hint">Where do we have mentors (level 4) to scale capability?</div>
            <div class="list" id="expList"></div>
          `;
          const list = $("#expList", el);
          if (!data.topExperts.length) {
            const li = document.createElement("div");
            li.className = "list-item";
            li.innerHTML = `<div class="title">No experts recorded</div><div class="meta">Assign level 4 where a person can mentor others — it helps HR plan coverage.</div>`;
            list.appendChild(li);
            return el;
          }
          for (const s of data.topExperts) {
            const li = document.createElement("div");
            li.className = "list-item";
            li.innerHTML = `
              <div class="top">
                <div class="title">${escapeHtml(s.name)}</div>
                <div class="skill-tags"><span class="tag">Experts ${escapeHtml(String(s.experts))}</span></div>
              </div>
              <div class="meta">
                <span>${escapeHtml(s.category)}</span>
                <span>Coverage ${formatPct(s.covPct)}</span>
                <span>Target ${escapeHtml(String(s.target ?? 0))}</span>
              </div>
              <div class="mini-bar" aria-label="Coverage bar"><div data-pct="${Math.round(s.covPct)}"></div></div>
            `;
            list.appendChild(li);
          }
          return el;
        }

        function renderCardReadiness(data) {
          const el = document.createElement("div");
          el.className = "card";
          const top = data.employeeScores.slice(0, 8);
          const avg = data.employeeScores.length
            ? Math.round((data.employeeScores.reduce((a, x) => a + x.score, 0) / data.employeeScores.length) * 100)
            : 0;
          el.innerHTML = `
            <h3>Employee readiness</h3>
            <div class="hint">Percent of targeted skills met by each employee (within current filters).</div>
            <div class="metric">
              <div>
                <div class="value">${avg}%</div>
                <div class="caption">Average readiness</div>
              </div>
              <div class="chip"><strong>${top.length}</strong> shown</div>
            </div>
            <div class="list" id="readyList"></div>
          `;
          const list = $("#readyList", el);
          for (const x of top) {
            const pct = Math.round(x.score * 100);
            const li = document.createElement("div");
            li.className = "list-item";
            li.innerHTML = `
              <div class="top">
                <div class="title">${escapeHtml(x.e.name)}</div>
                <div class="skill-tags"><span class="tag">${pct}%</span></div>
              </div>
              <div class="meta">
                <span>${escapeHtml(x.e.title)}</span>
                <span>${escapeHtml(x.e.department)}</span>
                <span>${escapeHtml(x.e.location)}</span>
              </div>
              <div class="mini-bar"><div data-pct="${pct}"></div></div>
            `;
            list.appendChild(li);
          }
          return el;
        }

        function animateBars(root) {
          const bars = $$("[data-pct]", root);
          requestAnimationFrame(() => {
            for (const b of bars) {
              const pct = clamp(Number(b.getAttribute("data-pct")) || 0, 0, 100);
              b.style.width = pct + "%";
            }
          });
        }

        function setTab(id) {
          const tabs = [
            { tab: $("#tabMatrix"), panel: $("#viewMatrix") },
            { tab: $("#tabInsights"), panel: $("#viewInsights") },
            { tab: $("#tabDirectory"), panel: $("#viewDirectory") }
          ];
          for (const t of tabs) {
            const selected = t.tab.id === id;
            t.tab.setAttribute("aria-selected", selected ? "true" : "false");
            t.panel.hidden = !selected;
          }
          if (id === "tabInsights") renderInsights();
          if (id === "tabDirectory") renderDirectory();
        }

        function cycleLevel(current, dir = 1) {
          const nxt = (current + dir + 5) % 5;
          return nxt;
        }

        function updateSkillLevel(empId, skillId, level) {
          const e = employeeById(empId);
          if (!e) return;
          if (!e.skills) e.skills = {};
          const next = clamp(level, 0, 4);
          e.skills[skillId] = next;
          saveState();
          renderMatrix();
        }

        function handleCellAction(evt) {
          const btn = evt.target.closest(".cell-btn");
          if (!btn) return;
          const empId = btn.dataset.empId;
          const skillId = btn.dataset.skillId;
          const curr = clamp(Number(btn.dataset.level || 0), 0, 4);
          const dir = evt.shiftKey ? -1 : 1;
          const next = cycleLevel(curr, dir);
          updateSkillLevel(empId, skillId, next);
          toast({
            title: "Updated proficiency",
            message: `${employeeById(empId)?.name || "Employee"} — ${skillById(skillId)?.name || "Skill"}: ${next} (${levelLabel(next)})`,
            kind: "good",
            timeout: 2200
          });
        }

        function focusNextCell(fromBtn, dx, dy) {
          const all = $$(".cell-btn", $("#matrixBody"));
          if (!all.length) return;
          const index = all.indexOf(fromBtn);
          if (index < 0) return;
          const view = derived();
          const cols = view.employees.length;
          if (!cols) return;
          const rows = view.skills.length;
          if (!rows) return;
          const row = Math.floor(index / cols);
          const col = index % cols;
          const nRow = clamp(row + dy, 0, rows - 1);
          const nCol = clamp(col + dx, 0, cols - 1);
          const nextIndex = nRow * cols + nCol;
          const next = all[nextIndex];
          if (next) next.focus({ preventScroll: false });
        }

        function handleMatrixKeydown(evt) {
          const btn = evt.target.closest(".cell-btn");
          if (!btn) return;
          const key = evt.key;
          if (key === "ArrowRight") {
            evt.preventDefault();
            focusNextCell(btn, 1, 0);
            return;
          }
          if (key === "ArrowLeft") {
            evt.preventDefault();
            focusNextCell(btn, -1, 0);
            return;
          }
          if (key === "ArrowDown") {
            evt.preventDefault();
            focusNextCell(btn, 0, 1);
            return;
          }
          if (key === "ArrowUp") {
            evt.preventDefault();
            focusNextCell(btn, 0, -1);
            return;
          }
          if (key === "Enter" || key === " ") {
            evt.preventDefault();
            const curr = clamp(Number(btn.dataset.level || 0), 0, 4);
            const next = cycleLevel(curr, evt.shiftKey ? -1 : 1);
            updateSkillLevel(btn.dataset.empId, btn.dataset.skillId, next);
            return;
          }
          if (/^[0-4]$/.test(key)) {
            evt.preventDefault();
            updateSkillLevel(btn.dataset.empId, btn.dataset.skillId, Number(key));
            return;
          }
        }

        // Modal helpers
        const modal = $("#modalShell");
        const modalTitle = $("#modalTitle");
        const modalSubtitle = $("#modalSubtitle");
        const modalBody = $("#modalBody");
        const modalFooter = $("#modalFooter");
        const modalClose = $("#modalClose");

        let lastFocus = null;

        function openModal({ title, subtitle, body, footer, onClose }) {
          lastFocus = document.activeElement;
          modalTitle.textContent = title;
          modalSubtitle.textContent = subtitle || " ";
          modalBody.innerHTML = "";
          modalFooter.innerHTML = "";

          if (body) modalBody.appendChild(body);
          if (footer) modalFooter.appendChild(footer);

          const close = () => {
            if (typeof modal.close === "function") modal.close();
            else modal.removeAttribute("open");
            if (typeof onClose === "function") onClose();
            setTimeout(() => {
              if (lastFocus && lastFocus.focus) lastFocus.focus();
            }, 0);
          };

          modalClose.onclick = close;
          modal.addEventListener(
            "close",
            () => {
              modalClose.onclick = null;
            },
            { once: true }
          );

          if (typeof modal.showModal === "function") modal.showModal();
          else modal.setAttribute("open", "");
          // Focus first focusable
          const focusable = $$(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
            modal
          ).filter((el) => !el.disabled);
          if (focusable[0]) focusable[0].focus();
        }

        function btnEl({ label, variant = "", icon = "", onClick, title }) {
          const b = document.createElement("button");
          b.type = "button";
          b.className = `btn ${variant}`.trim();
          if (title) b.title = title;
          b.innerHTML = `${icon ? icon : ""}${escapeHtml(label)}`;
          b.addEventListener("click", onClick);
          return b;
        }

        function openHelp() {
          const body = document.createElement("div");
          body.innerHTML = `
            <div class="two-col">
              <div class="kbd-help">
                <div><strong>Matrix shortcuts</strong></div>
                <div><code>Click</code> cycle level • <code>Shift</code> + click goes backwards</div>
                <div><code>0–4</code> set proficiency directly</div>
                <div><code>Arrow keys</code> move across the grid</div>
                <div><code>Enter</code> / <code>Space</code> cycle in place</div>
              </div>
              <div class="kbd-help">
                <div><strong>HR tips</strong></div>
                <div>Set skill targets to define “coverage” expectations.</div>
                <div>Use <code>Core</code> and <code>Compliance</code> filters to surface audit gaps.</div>
                <div>Export CSV for sharing with leaders; export JSON for backup.</div>
              </div>
            </div>
            <div class="hint" style="margin-top:12px">
              Data is stored locally in this browser (no network calls). Use Export to back up or share.
            </div>
          `;
          const footer = document.createElement("div");
          footer.appendChild(
            btnEl({
              label: "Close",
              variant: "primary",
              onClick: () => modal.close()
            })
          );
          openModal({ title: "Help & keyboard", subtitle: "Efficient editing and HR best practices.", body, footer });
        }

        function openAddMenu() {
          const body = document.createElement("div");
          body.innerHTML = `
            <div class="two-col">
              <div class="skill-edit">
                <div>
                  <div style="font-weight:800; letter-spacing:-0.02em">Add an employee</div>
                  <div class="hint">Create a profile and start tracking skills coverage.</div>
                </div>
                <button class="btn primary" type="button" id="quickAddEmployee">
                  <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 12a4.2 4.2 0 1 0 0-8.4A4.2 4.2 0 0 0 12 12Zm0 2.3c-4.2 0-7.6 2.1-7.6 4.8 0 1.2 1 2.1 2.3 2.1h10.6c1.3 0 2.3-.9 2.3-2.1 0-2.7-3.4-4.8-7.6-4.8Z"/><path fill="currentColor" d="M19 7h-2V5a1 1 0 1 0-2 0v2h-2a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0V9h2a1 1 0 1 0 0-2Z"/></svg>
                  Add employee
                </button>
              </div>
              <div class="skill-edit">
                <div>
                  <div style="font-weight:800; letter-spacing:-0.02em">Add a skill</div>
                  <div class="hint">Define targets, category, and criticality for HR reporting.</div>
                </div>
                <button class="btn" type="button" id="quickAddSkill">
                  <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2a3 3 0 0 1 3 3v1h3a2 2 0 0 1 2 2v11a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8a2 2 0 0 1 2-2h3V5a3 3 0 0 1 3-3Zm1 4V5a1 1 0 0 0-2 0v1h2Zm-3 6a1 1 0 0 0 0 2h2v2a1 1 0 1 0 2 0v-2h2a1 1 0 1 0 0-2h-2v-2a1 1 0 1 0-2 0v2h-2Z"/></svg>
                  Add skill
                </button>
              </div>
            </div>
          `;
          const footer = document.createElement("div");
          footer.appendChild(
            btnEl({
              label: "Close",
              onClick: () => modal.close()
            })
          );
          openModal({
            title: "Add",
            subtitle: "Build your matrix with employees and skills.",
            body,
            footer,
            onClose: () => {}
          });
          $("#quickAddEmployee", body).addEventListener("click", () => {
            modal.close();
            openEmployeeEditor(null);
          });
          $("#quickAddSkill", body).addEventListener("click", () => {
            modal.close();
            openSkillEditor(null);
          });
        }

        function openExport() {
          const view = derived();
          const exportJson = () => {
            const payload = {
              ...state,
              exportedAt: new Date().toISOString(),
              app: APP_NAME
            };
            download(`employee-skills-matrix.json`, JSON.stringify(payload, null, 2), "application/json");
            toast({ title: "Exported JSON", message: "Full dataset downloaded.", kind: "good" });
          };

          const exportCsv = () => {
            const rows = [];
            const header = [
              "Skill",
              "Category",
              "Criticality",
              "Target",
              ...view.employees.map((e) => `${e.name} (${e.title})`)
            ];
            rows.push(header);
            for (const s of view.skills) {
              const row = [s.name, s.category, s.criticality, String(s.target ?? 0)];
              for (const e of view.employees) row.push(String(clamp(e.skills?.[s.id] ?? 0, 0, 4)));
              rows.push(row);
            }
            download(`employee-skills-matrix.csv`, toCsv(rows), "text/csv");
            toast({ title: "Exported CSV", message: "Matrix downloaded (current filters).", kind: "good" });
          };

          const body = document.createElement("div");
          body.innerHTML = `
            <div class="two-col">
              <div class="skill-edit">
                <div>
                  <div style="font-weight:800; letter-spacing:-0.02em">Export</div>
                  <div class="hint">Download your dataset for sharing, backup, or audit artifacts.</div>
                </div>
                <div class="row">
                  <button class="btn primary" type="button" id="doJson">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M5 4h10l4 4v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Zm9 1.5V9h3.5L14 5.5Z"/><path fill="currentColor" d="M7 13h10v2H7v-2Zm0 4h10v2H7v-2Z"/></svg>
                    JSON (full)
                  </button>
                  <button class="btn" type="button" id="doCsv">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M5 4h10l4 4v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Zm9 1.5V9h3.5L14 5.5Z"/><path fill="currentColor" d="M7 13h10v2H7v-2Zm0 4h10v2H7v-2Z"/></svg>
                    CSV (matrix)
                  </button>
                </div>
                <div class="hint">
                  CSV exports the current view (filters + sorting). JSON includes everything (skills, employees, settings).
                </div>
              </div>
              <div class="skill-edit">
                <div>
                  <div style="font-weight:800; letter-spacing:-0.02em">Import / reset</div>
                  <div class="hint">Paste JSON to restore or merge a dataset. Or reset to sample data.</div>
                </div>
                <textarea class="textarea" id="importArea" rows="8" placeholder="Paste JSON export here…"></textarea>
                <div class="row">
                  <button class="btn" type="button" id="doImport">Import JSON</button>
                  <button class="btn ghost" type="button" id="doReset" title="Resets local data to sample dataset">Reset sample</button>
                </div>
                <div class="hint">
                  Import runs locally. Tip: export first before importing or resetting.
                </div>
              </div>
            </div>
          `;
          const footer = document.createElement("div");
          footer.appendChild(
            btnEl({
              label: "Close",
              variant: "primary",
              onClick: () => modal.close()
            })
          );
          openModal({
            title: "Export / Import",
            subtitle: "Share, back up, and restore your matrix.",
            body,
            footer
          });

          $("#doJson", body).addEventListener("click", exportJson);
          $("#doCsv", body).addEventListener("click", exportCsv);

          $("#doReset", body).addEventListener("click", () => {
            state = defaultSeed();
            saveState();
            render();
            toast({ title: "Reset complete", message: "Restored sample dataset.", kind: "warn" });
            modal.close();
          });

          $("#doImport", body).addEventListener("click", () => {
            const raw = $("#importArea", body).value.trim();
            if (!raw) {
              toast({ title: "Nothing to import", message: "Paste a JSON export first.", kind: "warn" });
              return;
            }
            try {
              const parsed = JSON.parse(raw);
              const next = validateImport(parsed);
              state = next;
              saveState();
              render();
              toast({ title: "Imported", message: "Dataset loaded successfully.", kind: "good" });
              modal.close();
            } catch (e) {
              toast({
                title: "Import failed",
                message: "JSON was not recognized. Please paste a valid export.",
                kind: "bad",
                timeout: 4200
              });
            }
          });
        }

        function validateImport(parsed) {
          if (!parsed || typeof parsed !== "object") throw new Error("invalid");
          const skills = Array.isArray(parsed.skills) ? parsed.skills : null;
          const employees = Array.isArray(parsed.employees) ? parsed.employees : null;
          if (!skills || !employees) throw new Error("invalid");
          const cleanedSkills = skills
            .map((s) => ({
              id: safeText(s.id || uid()),
              name: safeText(s.name || "Untitled skill"),
              category: safeText(s.category || "General"),
              criticality: safeText(s.criticality || "Secondary"),
              target: clamp(Number(s.target ?? 0), 0, 4),
              description: safeText(s.description || "")
            }))
            .filter((s) => s.id && s.name);
          const skillIds = new Set(cleanedSkills.map((s) => s.id));
          const cleanedEmployees = employees
            .map((e) => {
              const skillsObj = e.skills && typeof e.skills === "object" ? e.skills : {};
              const cleaned = {};
              for (const [sid, lvl] of Object.entries(skillsObj)) {
                if (!skillIds.has(sid)) continue;
                cleaned[sid] = clamp(Number(lvl ?? 0), 0, 4);
              }
              return {
                id: safeText(e.id || uid()),
                name: safeText(e.name || "Unnamed"),
                title: safeText(e.title || ""),
                department: safeText(e.department || "Unassigned"),
                location: safeText(e.location || "Unassigned"),
                manager: safeText(e.manager || ""),
                status: safeText(e.status || "Active"),
                startDate: safeText(e.startDate || ""),
                skills: cleaned
              };
            })
            .filter((e) => e.id && e.name);

          const next = defaultSeed();
          next.skills = cleanedSkills;
          next.employees = cleanedEmployees;
          next.settings = { ...next.settings, ...(parsed.settings || {}) };
          next.settings.filters = { ...next.settings.filters, ...((parsed.settings || {}).filters || {}) };
          next.settings.sortMode = (parsed.settings || {}).sortMode || next.settings.sortMode;
          next.updatedAt = Date.now();
          return next;
        }

        function toCsv(rows) {
          return rows
            .map((row) =>
              row
                .map((cell) => {
                  const s = String(cell ?? "");
                  if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
                  return s;
                })
                .join(",")
            )
            .join("\n");
        }

        function download(filename, content, mime) {
          const blob = new Blob([content], { type: mime || "application/octet-stream" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 500);
        }

        function openEmployeeEditor(employeeId) {
          const isNew = !employeeId;
          let employee = employeeId ? deepClone(employeeById(employeeId)) : null;
          if (!employee) {
            const suggestedDept = state.employees[0]?.department || "People Team";
            employee = {
              id: uid(),
              name: "",
              title: "",
              department: suggestedDept,
              location: "Remote",
              manager: "",
              status: "Active",
              startDate: "",
              notes: "",
              skills: {}
            };
          }
          const skillList = [...state.skills].sort(
            (a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name)
          );

          const body = document.createElement("div");
          body.innerHTML = `
            <div class="two-col">
              <div class="field">
                <div class="label">Full name</div>
                <input class="input" id="empName" placeholder="e.g., Jordan Lee" value="${escapeHtml(employee?.name || "")}" />
              </div>
              <div class="field">
                <div class="label">Title / role</div>
                <input class="input" id="empTitle" placeholder="e.g., People Ops Partner" value="${escapeHtml(employee?.title || "")}" />
              </div>
              <div class="field">
                <div class="label">Department</div>
                <input class="input" id="empDept" placeholder="e.g., People Team" value="${escapeHtml(employee?.department || "")}" />
              </div>
              <div class="field">
                <div class="label">Location</div>
                <input class="input" id="empLoc" placeholder="e.g., Remote" value="${escapeHtml(employee?.location || "")}" />
              </div>
              <div class="field">
                <div class="label">Manager</div>
                <input class="input" id="empMgr" placeholder="e.g., Director, HR" value="${escapeHtml(employee?.manager || "")}" />
              </div>
              <div class="field">
                <div class="label">Status</div>
                <select class="select" id="empStatus">
                  ${["Active", "On Leave", "Contractor", "Departed"]
                    .map((s) => `<option value="${escapeHtml(s)}" ${employee?.status === s ? "selected" : ""}>${escapeHtml(s)}</option>`)
                    .join("")}
                </select>
              </div>
              <div class="field">
                <div class="label">Start date</div>
                <input class="input" id="empStart" type="date" value="${escapeHtml(employee?.startDate || "")}" />
              </div>
              <div class="field">
                <div class="label">Notes <span class="mini">Optional</span></div>
                <input class="input" id="empNotes" placeholder="e.g., Mentor for ER cases" value="${escapeHtml(employee?.notes || "")}" />
              </div>
            </div>

            <div class="skill-edit">
              <div class="row" style="justify-content:space-between">
                <div>
                  <div style="font-weight:800; letter-spacing:-0.02em">Skills</div>
                  <div class="hint">Set proficiency evidence as of today. Targets are defined on the skill itself.</div>
                </div>
                <div class="row">
                  <input class="input" id="skillSearch" placeholder="Search skills…" style="max-width:260px" />
                  <button class="btn ghost" type="button" id="fillTargets" title="Set missing skills to target-1 (starter plan)">Auto-plan</button>
                </div>
              </div>
              <div id="skillRows"></div>
            </div>
          `;

          const renderSkillRows = () => {
            const q = normalizeString($("#skillSearch", body).value);
            const rows = $("#skillRows", body);
            const skills = skillList.filter((s) => !q || normalizeString(`${s.name} ${s.category} ${s.criticality}`).includes(q));
            rows.innerHTML = "";
            const frag = document.createDocumentFragment();
            for (const s of skills) {
              const current = clamp(employee?.skills?.[s.id] ?? 0, 0, 4);
              const row = document.createElement("div");
              row.className = "skill-row";
              row.innerHTML = `
                <div style="min-width:0">
                  <div style="display:flex; gap:8px; align-items:center; justify-content:space-between">
                    <div style="font-weight:800; letter-spacing:-0.015em; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${escapeHtml(
                      s.name
                    )}</div>
                    <div class="skill-tags" style="justify-content:flex-end">
                      <span class="tag">Target ${escapeHtml(String(s.target ?? 0))}</span>
                      ${s.criticality === "Core" ? `<span class="tag core">Core</span>` : `<span class="tag">${escapeHtml(s.criticality)}</span>`}
                      ${s.category === "Compliance" ? `<span class="tag compliance">Compliance</span>` : `<span class="tag">${escapeHtml(s.category)}</span>`}
                    </div>
                  </div>
                  <div class="hint" style="margin-top:4px">${escapeHtml(s.description || "")}</div>
                </div>
                <div class="slider">
                  <div class="label">Proficiency <span class="mini" id="lvlLabel-${escapeHtml(s.id)}">${current} • ${escapeHtml(
                    levelLabel(current)
                  )}</span></div>
                  <input type="range" min="0" max="4" step="1" value="${current}" data-sid="${escapeHtml(
                    s.id
                  )}" class="rangeSkill" />
                  <div class="range-labels" aria-hidden="true"><span>0</span><span>1</span><span>2</span><span>3</span><span>4</span></div>
                </div>
              `;
              frag.appendChild(row);
            }
            rows.appendChild(frag);
            for (const r of $$(".rangeSkill", rows)) {
              r.addEventListener("input", (evt) => {
                const sid = evt.target.getAttribute("data-sid");
                const lvl = clamp(Number(evt.target.value || 0), 0, 4);
                if (!employee) return;
                if (!employee.skills) employee.skills = {};
                employee.skills[sid] = lvl;
                const lbl = $(`#lvlLabel-${cssEscape(sid)}`, body);
                if (lbl) lbl.textContent = `${lvl} • ${levelLabel(lvl)}`;
              });
            }
          };

          renderSkillRows();
          $("#skillSearch", body).addEventListener("input", renderSkillRows);

          $("#fillTargets", body).addEventListener("click", () => {
            for (const s of state.skills) {
              const existing = clamp(employee.skills?.[s.id] ?? 0, 0, 4);
              if (existing > 0) continue;
              const target = clamp(s.target ?? 0, 0, 4);
              if (target <= 0) continue;
              employee.skills[s.id] = clamp(target - 1, 0, 4);
            }
            renderSkillRows();
            toast({ title: "Auto-plan applied", message: "Filled missing skills as a starter plan (target-1).", kind: "info" });
          });

          const footer = document.createElement("div");
          const saveBtn = btnEl({
            label: isNew ? "Add employee" : "Save changes",
            variant: "primary",
            onClick: () => {
              const name = safeText($("#empName", body).value).trim();
              if (!name) {
                toast({ title: "Missing name", message: "Employee name is required.", kind: "warn" });
                $("#empName", body).focus();
                return;
              }
              employee.name = name;
              employee.title = safeText($("#empTitle", body).value).trim();
              employee.department = safeText($("#empDept", body).value).trim() || "Unassigned";
              employee.location = safeText($("#empLoc", body).value).trim() || "Unassigned";
              employee.manager = safeText($("#empMgr", body).value).trim();
              employee.status = safeText($("#empStatus", body).value).trim() || "Active";
              employee.startDate = safeText($("#empStart", body).value).trim();
              employee.notes = safeText($("#empNotes", body).value).trim();

              if (isNew) {
                state.employees.push(employee);
                toast({ title: "Employee added", message: `${employee.name} added to the matrix.`, kind: "good" });
              } else {
                const idx = state.employees.findIndex((x) => x.id === employeeId);
                if (idx >= 0) state.employees[idx] = employee;
                toast({ title: "Saved", message: `${employee.name} updated.`, kind: "good" });
              }
              saveState();
              render();
              modal.close();
            }
          });

          const delBtn =
            isNew
              ? null
              : btnEl({
                  label: "Delete",
                  variant: "ghost",
                  title: "Remove employee from the dataset",
                  onClick: () => {
                    const ok = confirm(`Delete ${employee?.name || "this employee"}? This cannot be undone.`);
                    if (!ok) return;
                    state.employees = state.employees.filter((x) => x.id !== employeeId);
                    saveState();
                    render();
                    toast({ title: "Deleted", message: "Employee removed.", kind: "warn" });
                    modal.close();
                  }
                });
          const cancelBtn = btnEl({ label: "Cancel", onClick: () => modal.close() });
          if (delBtn) footer.appendChild(delBtn);
          footer.appendChild(cancelBtn);
          footer.appendChild(saveBtn);

          openModal({
            title: isNew ? "Add employee" : "Edit employee",
            subtitle: "HR profile details and skill proficiency levels.",
            body,
            footer
          });
        }

        function openSkillEditor(skillId) {
          const isNew = !skillId;
          let skill = skillId ? deepClone(skillById(skillId)) : null;
          if (!skill) {
            skill = {
              id: uid(),
              name: "",
              category: "People Operations",
              criticality: "Secondary",
              target: 2,
              description: ""
            };
          }

          const body = document.createElement("div");
          body.innerHTML = `
            <div class="two-col">
              <div class="field">
                <div class="label">Skill name</div>
                <input class="input" id="skillName" placeholder="e.g., I-9 verification" value="${escapeHtml(skill.name)}" />
              </div>
              <div class="field">
                <div class="label">Category</div>
                <input class="input" id="skillCat" placeholder="e.g., Compliance" value="${escapeHtml(skill.category)}" />
              </div>
              <div class="field">
                <div class="label">Criticality</div>
                <select class="select" id="skillCrit">
                  ${["Core", "Secondary", "Nice-to-have"]
                    .map((c) => `<option value="${escapeHtml(c)}" ${skill.criticality === c ? "selected" : ""}>${escapeHtml(c)}</option>`)
                    .join("")}
                </select>
              </div>
              <div class="field">
                <div class="label">Target proficiency <span class="mini" id="targetLbl">${escapeHtml(String(skill.target))}</span></div>
                <input id="skillTarget" type="range" min="0" max="4" step="1" value="${escapeHtml(String(skill.target))}" />
                <div class="range-labels" aria-hidden="true"><span>0</span><span>1</span><span>2</span><span>3</span><span>4</span></div>
                <div class="hint">Set to <strong>0</strong> if this skill should not be tracked for target coverage.</div>
              </div>
            </div>
            <div class="field">
              <div class="label">Description <span class="mini">Optional</span></div>
              <textarea class="textarea" id="skillDesc" rows="4" placeholder="Define what ‘proficient’ looks like.">${escapeHtml(
                skill.description || ""
              )}</textarea>
            </div>
            <div class="hint">
              HR note: Use target levels for workforce planning (e.g., compliance targets for audit readiness).
            </div>
          `;

          $("#skillTarget", body).addEventListener("input", (e) => {
            $("#targetLbl", body).textContent = String(e.target.value);
          });

          const footer = document.createElement("div");
          const saveBtn = btnEl({
            label: isNew ? "Add skill" : "Save changes",
            variant: "primary",
            onClick: () => {
              const name = safeText($("#skillName", body).value).trim();
              if (!name) {
                toast({ title: "Missing name", message: "Skill name is required.", kind: "warn" });
                $("#skillName", body).focus();
                return;
              }
              skill.name = name;
              skill.category = safeText($("#skillCat", body).value).trim() || "General";
              skill.criticality = safeText($("#skillCrit", body).value).trim() || "Secondary";
              skill.target = clamp(Number($("#skillTarget", body).value ?? 0), 0, 4);
              skill.description = safeText($("#skillDesc", body).value).trim();

              if (isNew) {
                state.skills.push(skill);
                toast({ title: "Skill added", message: `${skill.name} added.`, kind: "good" });
              } else {
                const idx = state.skills.findIndex((s) => s.id === skillId);
                if (idx >= 0) state.skills[idx] = skill;
                toast({ title: "Saved", message: `${skill.name} updated.`, kind: "good" });
              }
              saveState();
              render();
              modal.close();
            }
          });

          const delBtn =
            isNew
              ? null
              : btnEl({
                  label: "Delete",
                  variant: "ghost",
                  title: "Remove skill from dataset (keeps employee records clean)",
                  onClick: () => {
                    const ok = confirm(`Delete skill "${skill?.name || "this"}"? This will remove it from all employees.`);
                    if (!ok) return;
                    const sid = skillId;
                    state.skills = state.skills.filter((s) => s.id !== sid);
                    for (const e of state.employees) {
                      if (e.skills && sid in e.skills) delete e.skills[sid];
                    }
                    saveState();
                    render();
                    toast({ title: "Deleted", message: "Skill removed.", kind: "warn" });
                    modal.close();
                  }
                });

          footer.appendChild(btnEl({ label: "Cancel", onClick: () => modal.close() }));
          if (delBtn) footer.appendChild(delBtn);
          footer.appendChild(saveBtn);

          openModal({
            title: isNew ? "Add skill" : "Edit skill",
            subtitle: "Set targets and categorization for HR reporting.",
            body,
            footer
          });
        }

        function copySummary() {
          const data = insightsCompute();
          const overall = Math.round(data.overall * 100);
          const core = Math.round(data.coreCov * 100);
          const comp = Math.round(data.compCov * 100);
          const risks = data.topRisks
            .slice(0, 5)
            .map((s) => `- ${s.name}: ${Math.round(s.covPct)}% (target ${s.target})`)
            .join("\n");
          const text = `Employee Skills Matrix — summary\n\nOverall target coverage: ${overall}%\nCore skills coverage: ${core}%\nCompliance coverage: ${comp}%\n\nTop gaps:\n${risks}\n\nGenerated: ${new Date().toLocaleString()}`;
          const clipboard = navigator.clipboard && typeof navigator.clipboard.writeText === "function";
          if (clipboard) {
            navigator.clipboard
              .writeText(text)
              .then(() => toast({ title: "Copied", message: "Summary copied to clipboard.", kind: "good" }))
              .catch(() =>
                toast({ title: "Copy failed", message: "Clipboard unavailable in this browser context.", kind: "warn" })
              );
            return;
          }
          try {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.setAttribute("readonly", "");
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
            toast({ title: "Copied", message: "Summary copied to clipboard.", kind: "good" });
          } catch {
            toast({ title: "Copy failed", message: "Clipboard unavailable in this browser context.", kind: "warn" });
          }
        }

        function cssEscape(s) {
          if (window.CSS && CSS.escape) return CSS.escape(s);
          return String(s).replace(/[^a-zA-Z0-9_-]/g, (c) => "\\" + c);
        }

        function render() {
          renderFilters();
          renderMatrix();
          if ($("#tabInsights").getAttribute("aria-selected") === "true") renderInsights();
          if ($("#tabDirectory").getAttribute("aria-selected") === "true") renderDirectory();
        }

        function bind() {
          $("#tabMatrix").addEventListener("click", () => setTab("tabMatrix"));
          $("#tabInsights").addEventListener("click", () => setTab("tabInsights"));
          $("#tabDirectory").addEventListener("click", () => setTab("tabDirectory"));

          $("#btnHelp").addEventListener("click", openHelp);
          document.addEventListener("keydown", (e) => {
            if (e.key === "?" && !e.ctrlKey && !e.metaKey && !e.altKey) {
              // only when not typing
              const active = document.activeElement;
              const typing = active && ["INPUT", "TEXTAREA", "SELECT"].includes(active.tagName);
              if (!typing && !modal.open) {
                e.preventDefault();
                openHelp();
              }
            }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
              e.preventDefault();
              $("#globalSearch").focus();
            }
          });

          $("#globalSearch").addEventListener("input", (e) => {
            state.settings.filters.q = e.target.value;
            render();
            saveState();
          });

          $("#filterDept").addEventListener("change", (e) => {
            state.settings.filters.dept = e.target.value;
            render();
            saveState();
          });
          $("#filterLocation").addEventListener("change", (e) => {
            state.settings.filters.location = e.target.value;
            render();
            saveState();
          });
          $("#filterStatus").addEventListener("change", (e) => {
            state.settings.filters.status = e.target.value;
            render();
            saveState();
          });
          $("#filterCategory").addEventListener("change", (e) => {
            state.settings.filters.category = e.target.value;
            render();
            saveState();
          });
          $("#filterCriticality").addEventListener("change", (e) => {
            state.settings.filters.criticality = e.target.value;
            render();
            saveState();
          });

          $("#minLevel").addEventListener("input", (e) => {
            const v = clamp(Number(e.target.value ?? 0), 0, 4);
            state.settings.filters.minLevel = v;
            $("#minLevelLabel").textContent = `≥ ${v}`;
            renderMatrix();
            saveState();
          });

          $("#btnResetFilters").addEventListener("click", () => {
            state.settings.filters = { ...defaultSeed().settings.filters, q: state.settings.filters.q || "" };
            render();
            saveState();
            toast({ title: "Filters reset", message: "Showing full matrix.", kind: "info" });
          });

          $("#matrixBody").addEventListener("click", handleCellAction);
          $("#matrixBody").addEventListener("keydown", handleMatrixKeydown);

          $("#btnSort").addEventListener("click", () => {
            const modes = ["name", "coverage", "department"];
            const idx = modes.indexOf(state.settings.sortMode);
            state.settings.sortMode = modes[(idx + 1 + modes.length) % modes.length];
            saveState();
            render();
            toast({
              title: "Sorting updated",
              message:
                state.settings.sortMode === "coverage"
                  ? "Employees sorted by target coverage."
                  : state.settings.sortMode === "department"
                    ? "Employees sorted by department."
                    : "Employees sorted by name.",
              kind: "info"
            });
          });

          $("#btnPrint").addEventListener("click", () => window.print());
          $("#btnExport").addEventListener("click", openExport);
          $("#btnAdd").addEventListener("click", openAddMenu);
          $("#btnAddEmployee").addEventListener("click", () => openEmployeeEditor(null));
          $("#btnAddSkill").addEventListener("click", () => openSkillEditor(null));

          $("#btnRefreshInsights").addEventListener("click", () => {
            renderInsights();
            toast({ title: "Refreshed", message: "Insights updated.", kind: "good" });
          });
          $("#btnShareReport").addEventListener("click", copySummary);

          $("#directoryList").addEventListener("click", (e) => {
            const btn = e.target.closest('[data-action="edit-employee"]');
            if (!btn) return;
            openEmployeeEditor(btn.getAttribute("data-id"));
          });
        }

        let state = loadState();

        // Initialize
        bind();
        render();
        setAutosave("Autosaved", "ok");

        // First-run hint
        if (!localStorage.getItem(STORAGE_KEY + "_welcomed")) {
          localStorage.setItem(STORAGE_KEY + "_welcomed", "1");
          setTimeout(() => {
            toast({
              title: "Welcome",
              message: "Click cells to update proficiency. Use Insights for HR-ready coverage and recommendations.",
              kind: "info",
              timeout: 5200
            });
          }, 650);
        }

        // Expose tiny debug hook (no data exfiltration, local only)
        window.__ESM__ = {
          getState: () => deepClone(state),
          setSearch: applyGlobalSearch
        };
      })();
    </script>
  </body>
</html>
