<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light" />
    <title>Event Feedback Dashboard</title>
    <style>
      :root {
        --bg: #f6f8fc;
        --card: #ffffff;
        --ink: #0f172a;
        --muted: #475569;
        --muted-2: #64748b;
        --border: rgba(15, 23, 42, 0.12);
        --shadow: 0 14px 40px rgba(15, 23, 42, 0.08);
        --shadow-sm: 0 8px 24px rgba(15, 23, 42, 0.08);
        --accent: #3648ff;
        --accent-2: #1f2dff;
        --accent-soft: rgba(54, 72, 255, 0.12);
        --good: #0f766e;
        --warn: #b45309;
        --bad: #b91c1c;
        --focus: 0 0 0 4px rgba(54, 72, 255, 0.18);
        --radius: 16px;
        --radius-sm: 12px;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
          monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: var(--sans);
        color: var(--ink);
        background: radial-gradient(1200px 600px at 15% -10%, rgba(54, 72, 255, 0.12), rgba(54, 72, 255, 0)),
          radial-gradient(900px 450px at 90% 0%, rgba(2, 132, 199, 0.1), rgba(2, 132, 199, 0)),
          linear-gradient(180deg, #f8fbff, var(--bg));
      }

      .app {
        max-width: 1240px;
        margin: 0 auto;
        padding: 18px 18px 28px;
      }

      .topbar {
        position: sticky;
        top: 0;
        z-index: 5;
        padding: 14px 0 12px;
        backdrop-filter: blur(10px);
        background: linear-gradient(180deg, rgba(248, 251, 255, 0.92), rgba(248, 251, 255, 0.72));
        border-bottom: 1px solid rgba(15, 23, 42, 0.06);
        margin: 0 -18px 14px;
      }
      .topbarInner {
        max-width: 1240px;
        margin: 0 auto;
        padding: 0 18px;
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 14px;
        align-items: start;
      }
      @media (max-width: 920px) {
        .topbarInner {
          grid-template-columns: 1fr;
        }
      }

      .brand {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }
      .logo {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(54, 72, 255, 1), rgba(14, 165, 233, 1));
        box-shadow: 0 12px 30px rgba(54, 72, 255, 0.22);
        display: grid;
        place-items: center;
        flex: 0 0 auto;
      }
      .logo svg {
        width: 22px;
        height: 22px;
        color: white;
      }
      h1 {
        font-size: 20px;
        line-height: 1.2;
        margin: 0;
        letter-spacing: -0.02em;
      }
      .subtitle {
        margin: 6px 0 0;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.35;
      }

      .controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }

      .searchRow {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }
      @media (max-width: 640px) {
        .searchRow {
          grid-template-columns: 1fr;
        }
      }

      .search {
        position: relative;
      }
      .search input {
        width: 100%;
        height: 44px;
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.75);
        padding: 0 86px 0 44px;
        color: var(--ink);
        outline: none;
        box-shadow: 0 1px 0 rgba(15, 23, 42, 0.02);
        transition: box-shadow 140ms ease, border-color 140ms ease, background 140ms ease;
      }
      .search input::placeholder {
        color: rgba(71, 85, 105, 0.8);
      }
      .search input:focus {
        border-color: rgba(54, 72, 255, 0.35);
        box-shadow: var(--focus);
        background: rgba(255, 255, 255, 0.92);
      }
      .search .icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        color: rgba(71, 85, 105, 0.9);
      }
      .search .clearBtn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
      }

      .btn {
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.76);
        height: 40px;
        padding: 0 12px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        color: var(--ink);
        font-weight: 600;
        font-size: 13px;
        letter-spacing: -0.01em;
        user-select: none;
        transition: transform 90ms ease, box-shadow 140ms ease, background 140ms ease, border-color 140ms ease;
      }
      .btn:hover {
        background: rgba(255, 255, 255, 0.92);
        box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn:focus-visible {
        outline: none;
        box-shadow: var(--focus);
        border-color: rgba(54, 72, 255, 0.35);
      }
      .btnPrimary {
        border-color: rgba(54, 72, 255, 0.24);
        background: linear-gradient(180deg, rgba(54, 72, 255, 0.96), rgba(31, 45, 255, 0.96));
        color: white;
        box-shadow: 0 14px 32px rgba(54, 72, 255, 0.22);
      }
      .btnPrimary:hover {
        background: linear-gradient(180deg, rgba(54, 72, 255, 1), rgba(31, 45, 255, 1));
      }
      .btnGhost {
        background: transparent;
        border-color: rgba(15, 23, 42, 0.12);
      }
      .btnSm {
        height: 32px;
        padding: 0 10px;
        border-radius: 10px;
        font-size: 12px;
      }
      .btn .btnIcon {
        width: 16px;
        height: 16px;
      }

      .metaRow {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.72);
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
      }
      .chip strong {
        color: var(--ink);
        font-weight: 800;
        letter-spacing: -0.01em;
      }
      .chip .dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: rgba(71, 85, 105, 0.7);
      }
      .chip .kbd {
        font-family: var(--mono);
        font-size: 11px;
        padding: 1px 6px;
        border-radius: 8px;
        border: 1px solid rgba(15, 23, 42, 0.14);
        background: rgba(248, 250, 252, 0.92);
        color: rgba(15, 23, 42, 0.8);
      }

      .card {
        background: rgba(255, 255, 255, 0.86);
        border: 1px solid rgba(15, 23, 42, 0.1);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
      }

      .summaryCard {
        padding: 14px 14px 12px;
        margin: 10px 0 14px;
        overflow: hidden;
        position: relative;
      }
      .summaryTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }
      .summaryTitle {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 999px;
        padding: 7px 10px;
        background: rgba(54, 72, 255, 0.1);
        border: 1px solid rgba(54, 72, 255, 0.18);
        color: rgba(18, 33, 175, 0.95);
        font-weight: 800;
        font-size: 12px;
        letter-spacing: -0.01em;
      }
      .badge svg {
        width: 16px;
        height: 16px;
      }
      .iconBtn {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.72);
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: box-shadow 140ms ease, background 140ms ease, border-color 140ms ease;
      }
      .iconBtn:hover {
        background: rgba(255, 255, 255, 0.92);
        box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
      }
      .iconBtn:focus-visible {
        outline: none;
        box-shadow: var(--focus);
        border-color: rgba(54, 72, 255, 0.35);
      }
      .iconBtn svg {
        width: 16px;
        height: 16px;
        color: rgba(71, 85, 105, 0.95);
      }

      .summaryGrid {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 12px;
      }
      @media (max-width: 920px) {
        .summaryGrid {
          grid-template-columns: 1fr;
        }
      }
      .metricGrid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
      }
      @media (max-width: 920px) {
        .metricGrid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      .metric {
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.1);
        background: rgba(248, 250, 252, 0.7);
      }
      .metric .label {
        color: var(--muted-2);
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.01em;
        text-transform: uppercase;
      }
      .metric .value {
        margin-top: 6px;
        font-size: 18px;
        font-weight: 900;
        letter-spacing: -0.02em;
      }
      .metric .hint {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.35;
      }

      .summaryList {
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.1);
        background: rgba(248, 250, 252, 0.7);
      }
      .summaryList h2 {
        margin: 0;
        font-size: 13px;
        letter-spacing: -0.01em;
      }
      .summaryList ul {
        margin: 8px 0 0;
        padding-left: 18px;
        color: rgba(15, 23, 42, 0.9);
        font-size: 13px;
        line-height: 1.4;
      }
      .summaryList li {
        margin: 6px 0;
      }
      .summaryList .muted {
        color: var(--muted);
      }

      .summaryShowRow {
        display: none;
        margin: 0 0 14px;
      }
      .summaryShowRow.show {
        display: flex;
        justify-content: flex-end;
      }

      .tableCard {
        padding: 0;
        overflow: hidden;
      }
      .tableTop {
        padding: 12px 14px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        background: rgba(255, 255, 255, 0.92);
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
      }
      .tableTop .left {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .tableTop .right {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .tableTop .caption {
        font-weight: 900;
        letter-spacing: -0.01em;
      }
      .tableTop .subcaption {
        color: var(--muted);
        font-size: 12px;
      }

      .tableWrap {
        width: 100%;
        overflow: auto;
      }
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 960px;
      }
      thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: rgba(248, 250, 252, 0.94);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(15, 23, 42, 0.1);
      }
      th,
      td {
        padding: 12px 14px;
        text-align: left;
        vertical-align: top;
      }
      tbody tr {
        background: rgba(255, 255, 255, 0.92);
      }
      tbody tr:nth-child(2n) {
        background: rgba(248, 250, 252, 0.92);
      }
      tbody tr:hover {
        background: rgba(54, 72, 255, 0.04);
      }

      .thBtn {
        width: 100%;
        display: inline-flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 10px;
        margin: -10px -10px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: rgba(15, 23, 42, 0.92);
        font-weight: 900;
        font-size: 12px;
        letter-spacing: 0.01em;
        text-transform: uppercase;
      }
      .thBtn:focus-visible {
        outline: none;
        box-shadow: var(--focus);
        border-radius: 12px;
      }
      .sortIcon {
        width: 18px;
        height: 18px;
        color: rgba(71, 85, 105, 0.9);
        flex: 0 0 auto;
      }
      .sortIcon.active {
        color: rgba(54, 72, 255, 0.95);
      }

      .colDate {
        width: 140px;
        white-space: nowrap;
      }
      .colEvent {
        width: 220px;
      }
      .colParticipant {
        width: 190px;
      }
      .colRating {
        width: 140px;
      }
      .colFeedback {
        width: 520px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        padding: 6px 10px;
        border: 1px solid rgba(15, 23, 42, 0.1);
        background: rgba(255, 255, 255, 0.7);
        color: rgba(15, 23, 42, 0.92);
        font-size: 12px;
        font-weight: 700;
      }
      .pill.good {
        border-color: rgba(15, 118, 110, 0.22);
        background: rgba(15, 118, 110, 0.08);
        color: rgba(15, 118, 110, 0.95);
      }
      .pill.warn {
        border-color: rgba(180, 83, 9, 0.22);
        background: rgba(180, 83, 9, 0.08);
        color: rgba(180, 83, 9, 0.95);
      }
      .pill.bad {
        border-color: rgba(185, 28, 28, 0.22);
        background: rgba(185, 28, 28, 0.08);
        color: rgba(185, 28, 28, 0.95);
      }

      .rating {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .stars {
        display: inline-flex;
        gap: 2px;
        transform: translateY(1px);
      }
      .stars svg {
        width: 16px;
        height: 16px;
      }
      .stars .on {
        color: rgba(54, 72, 255, 0.95);
      }
      .stars .off {
        color: rgba(148, 163, 184, 0.75);
      }
      .ratingNum {
        font-weight: 900;
        font-size: 13px;
      }
      .ratingSub {
        color: var(--muted);
        font-size: 12px;
        margin-top: 2px;
      }

      .feedbackCell {
        display: grid;
        gap: 8px;
      }
      .feedbackPreview {
        color: rgba(15, 23, 42, 0.92);
        font-size: 13px;
        line-height: 1.45;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .feedbackActions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .linkBtn {
        background: transparent;
        border: none;
        padding: 0;
        cursor: pointer;
        color: rgba(54, 72, 255, 0.98);
        font-weight: 800;
        font-size: 12px;
        letter-spacing: -0.01em;
      }
      .linkBtn:hover {
        text-decoration: underline;
        text-underline-offset: 2px;
      }
      mark {
        border-radius: 6px;
        padding: 0 4px;
        background: rgba(54, 72, 255, 0.14);
        color: rgba(18, 33, 175, 0.95);
      }

      .emptyState {
        padding: 26px 18px;
        text-align: center;
        color: var(--muted);
      }
      .emptyState h3 {
        margin: 0;
        font-size: 15px;
        color: rgba(15, 23, 42, 0.92);
        letter-spacing: -0.01em;
      }
      .emptyState p {
        margin: 8px 0 0;
        font-size: 13px;
      }

      .footer {
        margin-top: 14px;
        color: rgba(71, 85, 105, 0.92);
        font-size: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
      }
      .footer a {
        color: rgba(54, 72, 255, 0.98);
        text-decoration: none;
        font-weight: 800;
      }
      .footer a:hover {
        text-decoration: underline;
        text-underline-offset: 2px;
      }

      .modal {
        position: fixed;
        inset: 0;
        display: none;
        z-index: 50;
      }
      .modal.show {
        display: grid;
        place-items: center;
      }
      .backdrop {
        position: absolute;
        inset: 0;
        background: rgba(2, 6, 23, 0.52);
        backdrop-filter: blur(8px);
      }
      .dialog {
        position: relative;
        width: min(860px, calc(100vw - 24px));
        max-height: min(78vh, 820px);
        overflow: hidden;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.94);
        border: 1px solid rgba(255, 255, 255, 0.55);
        box-shadow: 0 26px 70px rgba(2, 6, 23, 0.4);
        display: grid;
        grid-template-rows: auto 1fr auto;
      }
      .dialogHeader {
        padding: 14px 14px 10px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .dialogHeader h2 {
        margin: 0;
        font-size: 14px;
        letter-spacing: -0.01em;
      }
      .dialogBody {
        padding: 14px;
        overflow: auto;
      }
      .detailGrid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 12px;
      }
      @media (max-width: 760px) {
        .detailGrid {
          grid-template-columns: 1fr;
        }
      }
      .detail {
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.1);
        background: rgba(248, 250, 252, 0.7);
      }
      .detail .k {
        color: var(--muted-2);
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.02em;
      }
      .detail .v {
        margin-top: 6px;
        font-weight: 900;
        letter-spacing: -0.01em;
      }
      .feedbackFull {
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.1);
        background: rgba(255, 255, 255, 0.9);
        padding: 12px 12px;
        font-size: 13px;
        line-height: 1.55;
        white-space: pre-wrap;
      }
      .dialogFooter {
        padding: 12px 14px;
        border-top: 1px solid rgba(15, 23, 42, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .toast {
        position: fixed;
        right: 16px;
        bottom: 16px;
        z-index: 60;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.14);
        background: rgba(255, 255, 255, 0.92);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.14);
        color: rgba(15, 23, 42, 0.92);
        font-size: 13px;
        display: none;
        max-width: min(420px, calc(100vw - 32px));
      }
      .toast.show {
        display: block;
        animation: toastIn 180ms ease-out;
      }
      @keyframes toastIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="topbar" role="banner">
      <div class="topbarInner">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path
                d="M6.4 16.5c1.6 1.5 3.6 2.3 5.6 2.3 3.9 0 7.1-2.8 7.1-6.3S15.9 6.2 12 6.2c-2.2 0-4.3.9-5.9 2.6"
                stroke="currentColor"
                stroke-width="2.2"
                stroke-linecap="round"
              />
              <path
                d="M6.2 8.6v4.6c0 .7-.6 1.3-1.3 1.3H3.4"
                stroke="currentColor"
                stroke-width="2.2"
                stroke-linecap="round"
              />
              <path
                d="M11 10.3h5.2M11 13.8h3.6"
                stroke="currentColor"
                stroke-width="2.2"
                stroke-linecap="round"
              />
            </svg>
          </div>
          <div>
            <h1>Event Feedback Dashboard</h1>
            <p class="subtitle">
              Search, sort, and review participant submissions across recent events. Long feedback stays readable with
              quick “View full” details.
            </p>
          </div>
        </div>

        <div class="controls" aria-label="Controls">
          <div class="searchRow">
            <div class="search">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path
                  d="M10.8 18.2a7.4 7.4 0 1 1 0-14.8 7.4 7.4 0 0 1 0 14.8Z"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <path d="M16.6 16.6 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
              <label for="searchInput" class="srOnly">Search feedback entries</label>
              <input
                id="searchInput"
                type="text"
                autocomplete="off"
                spellcheck="false"
                placeholder="Search event, participant, rating, or feedback…"
              />
              <button id="clearSearch" class="btn btnSm clearBtn" type="button" title="Clear (Esc)">
                Clear
              </button>
            </div>
            <button id="exportCsv" class="btn btnPrimary" type="button" title="Download as CSV">
              <svg class="btnIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path
                  d="M12 3v10m0 0 3.5-3.5M12 13 8.5 9.5"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M4 14.5V18a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-3.5"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              Export CSV
            </button>
          </div>

          <div class="metaRow" aria-label="Status">
            <div class="chips">
              <span class="chip"><span class="dot"></span> Entries: <strong id="entriesTotal">—</strong></span>
              <span class="chip"><span class="dot"></span> Showing: <strong id="entriesShown">—</strong></span>
              <span class="chip"><span class="dot"></span> Sort: <strong id="sortLabel">—</strong></span>
              <span class="chip"><span class="kbd">Esc</span> clears search</span>
            </div>
            <div class="right">
              <button id="resetView" class="btn btnGhost btnSm" type="button" title="Reset search and sorting">
                Reset view
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="app" role="main">
      <section id="summaryCard" class="card summaryCard" aria-label="AI summary">
        <div class="summaryTop">
          <div class="summaryTitle">
            <span class="badge">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path
                  d="M12 2.8c-2.8 2.4-4.3 4.7-4.3 6.9 0 2.2 1.6 3.9 4.3 3.9s4.3-1.7 4.3-3.9c0-2.2-1.5-4.5-4.3-6.9Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linejoin="round"
                />
                <path
                  d="M6 20.5c1.8-1.8 3.8-2.7 6-2.7s4.2.9 6 2.7"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              AI summary
            </span>
            <span class="subtitle" id="summarySub">Updated from current dataset</span>
          </div>
          <button id="closeSummary" class="iconBtn" type="button" aria-label="Close summary">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path
                d="M7 7l10 10M17 7 7 17"
                stroke="currentColor"
                stroke-width="2.2"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div class="summaryGrid">
          <div>
            <div class="metricGrid" id="metricGrid"></div>
          </div>
          <div class="summaryList">
            <h2>Highlights & next actions</h2>
            <ul id="summaryBullets"></ul>
            <div class="muted" id="summaryNote" style="margin-top: 10px; font-size: 12px"></div>
          </div>
        </div>
      </section>

      <div id="summaryShowRow" class="summaryShowRow">
        <button id="showSummary" class="btn btnSm" type="button">
          <svg class="btnIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path
              d="M12 3c6 0 10 5 10 9s-4 9-10 9S2 16 2 12s4-9 10-9Z"
              stroke="currentColor"
              stroke-width="2"
            />
            <path
              d="M9.5 12.2 11.4 14l3.4-4"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          Show AI summary
        </button>
      </div>

      <section class="card tableCard" aria-label="Feedback table">
        <div class="tableTop">
          <div class="left">
            <div>
              <div class="caption">All submissions</div>
              <div class="subcaption">Click a column header to sort. Use search to filter by keyword.</div>
            </div>
          </div>
          <div class="right">
            <span id="sentimentPill" class="pill">—</span>
          </div>
        </div>
        <div class="tableWrap">
          <table aria-describedby="tableHint">
            <thead>
              <tr>
                <th class="colDate">
                  <button class="thBtn" type="button" data-key="date">
                    <span>Date</span>
                    <span class="sortIcon" data-icon-for="date" aria-hidden="true"></span>
                  </button>
                </th>
                <th class="colEvent">
                  <button class="thBtn" type="button" data-key="event">
                    <span>Event</span>
                    <span class="sortIcon" data-icon-for="event" aria-hidden="true"></span>
                  </button>
                </th>
                <th class="colParticipant">
                  <button class="thBtn" type="button" data-key="participant">
                    <span>Participant</span>
                    <span class="sortIcon" data-icon-for="participant" aria-hidden="true"></span>
                  </button>
                </th>
                <th class="colRating">
                  <button class="thBtn" type="button" data-key="rating">
                    <span>Rating</span>
                    <span class="sortIcon" data-icon-for="rating" aria-hidden="true"></span>
                  </button>
                </th>
                <th class="colFeedback">
                  <button class="thBtn" type="button" data-key="feedback">
                    <span>Feedback</span>
                    <span class="sortIcon" data-icon-for="feedback" aria-hidden="true"></span>
                  </button>
                </th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
          <div id="tableHint" class="srOnly">
            Use the search bar to filter by keyword. Click “View full” to read longer comments without losing context.
          </div>
        </div>
      </section>

      <div class="footer">
        <div>Dataset is randomly generated on load for demo purposes.</div>
        <div>
          Tip: click a rating to sort, or <a href="#" id="scrollTop">jump to top</a>.
        </div>
      </div>
    </div>

    <div id="modal" class="modal" aria-hidden="true">
      <div class="backdrop" data-close="true"></div>
      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="dialogHeader">
          <h2 id="modalTitle">Feedback details</h2>
          <button id="closeModal" class="iconBtn" type="button" aria-label="Close details">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path
                d="M7 7l10 10M17 7 7 17"
                stroke="currentColor"
                stroke-width="2.2"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>
        <div class="dialogBody">
          <div class="detailGrid" id="modalMeta"></div>
          <div class="feedbackFull" id="modalFeedback"></div>
        </div>
        <div class="dialogFooter">
          <span style="color: rgba(71, 85, 105, 0.92); font-size: 12px"
            >Press <span style="font-family: var(--mono)">Esc</span> to close.</span
          >
          <div style="display: flex; gap: 10px; align-items: center">
            <button id="copyFeedback" class="btn btnSm" type="button">
              <svg class="btnIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path
                  d="M8 8h10v12H8z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linejoin="round"
                />
                <path
                  d="M6 16H5a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              Copy
            </button>
            <button id="closeModal2" class="btn btnSm btnPrimary" type="button">Done</button>
          </div>
        </div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <style>
      .srOnly {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>

    <script>
      (() => {
        const $ = (sel, parent = document) => parent.querySelector(sel);
        const $$ = (sel, parent = document) => Array.from(parent.querySelectorAll(sel));

        const escapeHtml = (value) =>
          String(value)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#39;");

        const formatDate = (date) => {
          const d = new Date(date);
          return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
        };

        const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

        const seedFromString = (str) => {
          let h = 2166136261;
          for (let i = 0; i < str.length; i++) {
            h ^= str.charCodeAt(i);
            h = Math.imul(h, 16777619);
          }
          return h >>> 0;
        };

        const mulberry32 = (a) => {
          return () => {
            let t = (a += 0x6d2b79f5);
            t = Math.imul(t ^ (t >>> 15), t | 1);
            t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
            return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
          };
        };

        const pick = (rng, arr) => arr[Math.floor(rng() * arr.length)];
        const pickWeighted = (rng, options) => {
          const total = options.reduce((s, o) => s + o.w, 0);
          let r = rng() * total;
          for (const o of options) {
            r -= o.w;
            if (r <= 0) return o.v;
          }
          return options[options.length - 1].v;
        };

        const normalize = (s) => String(s ?? "").toLowerCase();

        const buildStarSvg = (on) => {
          return `
            <svg viewBox="0 0 24 24" fill="currentColor" class="${on ? "on" : "off"}" aria-hidden="true">
              <path d="M12 17.3 6.6 20l1-6-4.6-4 6.1-.9L12 3.6l2.9 5.5 6.1.9-4.6 4 1 6L12 17.3Z"/>
            </svg>
          `;
        };

        const sortIconSvg = (state) => {
          if (state === "asc") {
            return `
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 14l5-5 5 5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            `;
          }
          if (state === "desc") {
            return `
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            `;
          }
          return `
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M8 10l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 14l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          `;
        };

        const highlight = (text, q) => {
          const safe = escapeHtml(text);
          const query = String(q || "").trim();
          if (!query) return safe;
          const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
          const re = new RegExp(`(${escaped})`, "ig");
          return safe.replace(re, "<mark>$1</mark>");
        };

        const topicLexicon = [
          { k: "audio", terms: ["audio", "mic", "microphone", "sound", "speaker volume", "AV"] },
          { k: "slides", terms: ["slides", "deck", "presentation", "visuals"] },
          { k: "timing", terms: ["timing", "schedule", "agenda", "pace", "timekeeping"] },
          { k: "networking", terms: ["networking", "connections", "meet", "introduced", "chat"] },
          { k: "venue", terms: ["venue", "room", "seating", "temperature", "lighting"] },
          { k: "food", terms: ["coffee", "lunch", "snacks", "catering", "food"] },
          { k: "registration", terms: ["registration", "check-in", "badge", "sign-in"] },
          { k: "qanda", terms: ["q&a", "questions", "panel", "discussion"] },
          { k: "content", terms: ["content", "examples", "case study", "depth", "practical"] },
          { k: "workshops", terms: ["workshop", "hands-on", "exercise", "lab"] }
        ];

        const generateDataset = () => {
          const seed = seedFromString(`event-feedback-${new Date().toDateString()}`);
          const rng = mulberry32(seed);

          const first = [
            "Ava",
            "Noah",
            "Mia",
            "Liam",
            "Sophia",
            "Ethan",
            "Isabella",
            "Oliver",
            "Amelia",
            "James",
            "Charlotte",
            "Benjamin",
            "Harper",
            "Lucas",
            "Evelyn",
            "Henry",
            "Ella",
            "Daniel",
            "Grace",
            "Jack",
            "Nora",
            "Leo",
            "Zoe",
            "Aria",
            "Mateo",
            "Aiden",
            "Layla",
            "Chloe",
            "Ryan",
            "Hannah"
          ];

          const last = [
            "Patel",
            "Nguyen",
            "Johnson",
            "Garcia",
            "Chen",
            "Brown",
            "Martinez",
            "Khan",
            "Kim",
            "Singh",
            "Lopez",
            "Williams",
            "Davis",
            "Wilson",
            "Anderson",
            "Thomas",
            "Moore",
            "Jackson",
            "Martin",
            "Lee",
            "Thompson",
            "White",
            "Harris",
            "Clark",
            "Lewis",
            "Robinson",
            "Walker",
            "Young",
            "Hall",
            "Allen"
          ];

          const events = [
            "Q4 Leadership Offsite",
            "Customer Success Summit",
            "Sales Kickoff 2026",
            "Product Roadmap Town Hall",
            "Security & Compliance Briefing",
            "Operational Excellence Workshop",
            "AI Enablement Bootcamp",
            "Partner Ecosystem Roundtable",
            "Finance Planning Deep Dive",
            "People & Culture Forum",
            "Engineering Demo Day",
            "Global Marketing Sync",
            "Risk Management Seminar",
            "Innovation Lab Showcase",
            "Service Reliability Review"
          ];

          const roles = [
            "Program Manager",
            "Account Executive",
            "Customer Success Manager",
            "Operations Analyst",
            "Solutions Architect",
            "Finance Partner",
            "Product Manager",
            "Engineering Lead",
            "People Ops Specialist",
            "Marketing Manager"
          ];

          const areas = [
            "breakout sessions",
            "panel discussion",
            "hands-on workshop",
            "opening keynote",
            "case studies",
            "demo segment",
            "live Q&A",
            "facilitated roundtable"
          ];

          const positives = [
            "The speaker was clear and credible, and the examples felt immediately usable.",
            "Great energy in the room—really appreciated the practical framing and crisp takeaways.",
            "The pacing was strong, and the content landed well for both new and experienced attendees.",
            "Loved the balance between strategy and execution; it made follow-up actions feel achievable."
          ];

          const neutrals = [
            "The overall structure worked, but a bit more time for discussion would have helped.",
            "Content was solid; some sections felt slightly repetitive, but the core message was valuable.",
            "Good session—there were a few moments where transitions felt abrupt, but it still delivered."
          ];

          const improvements = [
            "Audio fluctuated at times; a quick mic check before each segment would reduce distractions.",
            "Slides were information-dense in places—larger fonts or fewer bullets would improve readability.",
            "The agenda ran a little long; a tighter timebox for Q&A would keep things on track.",
            "Check-in was slightly congested; adding a second line or earlier badge pickup could help.",
            "Seating was tight near the back; reserving more space for overflow would be appreciated.",
            "Coffee ran out quickly; staggering refills or adding a second station would be a win."
          ];

          const asks = [
            "Next time, a short pre-read or glossary would help align everyone on terminology.",
            "Would love to see more customer quotes and concrete benchmarks in the next iteration.",
            "A follow-up email with links to the deck and recommended next steps would be very helpful.",
            "If possible, record the session so teams in other time zones can catch up asynchronously."
          ];

          const craftFeedback = (rng, rating) => {
            const base =
              rating >= 4
                ? pick(rng, positives)
                : rating === 3
                  ? pick(rng, neutrals)
                  : "There were a few strong ideas, but the execution didn’t quite match the intent.";
            const improvement =
              rating >= 4
                ? pickWeighted(rng, [
                    { v: pick(rng, improvements), w: 0.55 },
                    { v: "I’d still recommend a bit more time for networking; it was a highlight for many of us.", w: 0.45 }
                  ])
                : pick(rng, improvements);
            const ask = pick(rng, asks);
            const area = pick(rng, areas);
            const extra =
              rating <= 2
                ? "A clearer run-of-show and tighter facilitation would make the session more engaging throughout."
                : "The team did a great job keeping things moving while staying open to questions.";
            return `${base} The ${area} was especially memorable. ${improvement} ${ask} ${extra}`;
          };

          const now = Date.now();
          const daysBack = 120;

          const used = new Set();
          const rows = [];
          for (let i = 0; i < 30; i++) {
            const participant = (() => {
              for (let tries = 0; tries < 8; tries++) {
                const name = `${pick(rng, first)} ${pick(rng, last)}`;
                if (!used.has(name)) {
                  used.add(name);
                  return name;
                }
              }
              return `${pick(rng, first)} ${pick(rng, last)}`;
            })();

            const rating = pickWeighted(rng, [
              { v: 5, w: 0.28 },
              { v: 4, w: 0.36 },
              { v: 3, w: 0.22 },
              { v: 2, w: 0.11 },
              { v: 1, w: 0.03 }
            ]);

            const event = pick(rng, events);
            const role = pick(rng, roles);
            const offsetDays = Math.floor(rng() * daysBack);
            const date = new Date(now - offsetDays * 24 * 60 * 60 * 1000);
            date.setHours(9 + Math.floor(rng() * 8), Math.floor(rng() * 60), 0, 0);

            const feedback = craftFeedback(rng, rating);
            rows.push({
              id: `r_${i}_${Math.floor(rng() * 1e9)}`,
              dateISO: date.toISOString(),
              dateDisplay: formatDate(date),
              event,
              participant,
              role,
              rating,
              feedback
            });
          }

          return rows.sort((a, b) => b.dateISO.localeCompare(a.dateISO));
        };

        const state = {
          rows: generateDataset(),
          query: "",
          sortKey: "date",
          sortDir: "desc",
          modalId: null,
          summaryClosed: false,
          lastFocusEl: null
        };

        const SORT_KEYS = {
          date: { label: "Date", get: (r) => r.dateISO },
          event: { label: "Event", get: (r) => normalize(r.event) },
          participant: { label: "Participant", get: (r) => normalize(r.participant) },
          rating: { label: "Rating", get: (r) => r.rating },
          feedback: { label: "Feedback", get: (r) => normalize(r.feedback) }
        };

        const getFilteredSorted = () => {
          const q = normalize(state.query).trim();
          const filtered = !q
            ? state.rows.slice()
            : state.rows.filter((r) => {
                const hay = `${r.dateDisplay} ${r.event} ${r.participant} ${r.role} ${r.rating} ${r.feedback}`.toLowerCase();
                return hay.includes(q);
              });

          const { sortKey, sortDir } = state;
          const def = SORT_KEYS[sortKey] || SORT_KEYS.date;
          const dir = sortDir === "asc" ? 1 : -1;

          filtered.sort((a, b) => {
            const av = def.get(a);
            const bv = def.get(b);
            if (sortKey === "rating") return (av - bv) * dir || b.dateISO.localeCompare(a.dateISO);
            if (sortKey === "date") return av.localeCompare(bv) * dir;
            if (av < bv) return -1 * dir;
            if (av > bv) return 1 * dir;
            return b.dateISO.localeCompare(a.dateISO);
          });

          return filtered;
        };

        const ratingPillClass = (rating) => (rating >= 4 ? "good" : rating === 3 ? "warn" : "bad");
        const ratingLabel = (rating) => (rating >= 4 ? "Positive" : rating === 3 ? "Mixed" : "Needs attention");

        const renderStars = (rating) => {
          const stars = Array.from({ length: 5 }, (_, i) => buildStarSvg(i < rating));
          return `<span class="stars" aria-hidden="true">${stars.join("")}</span>`;
        };

        const renderTable = () => {
          const tbody = $("#tableBody");
          const rows = getFilteredSorted();
          $("#entriesTotal").textContent = String(state.rows.length);
          $("#entriesShown").textContent = String(rows.length);
          $("#sortLabel").textContent = `${SORT_KEYS[state.sortKey]?.label || "Date"} ${state.sortDir.toUpperCase()}`;

          const avg = rows.length ? rows.reduce((s, r) => s + r.rating, 0) / rows.length : 0;
          const pill = $("#sentimentPill");
          pill.className = rows.length ? `pill ${ratingPillClass(Math.round(avg))}` : "pill";
          pill.textContent = rows.length ? `Avg ${avg.toFixed(1)} · ${ratingLabel(Math.round(avg))}` : "—";

          for (const el of $$("[data-icon-for]")) {
            const key = el.getAttribute("data-icon-for");
            const active = key === state.sortKey ? state.sortDir : "none";
            el.innerHTML = sortIconSvg(active === "none" ? null : active);
            el.classList.toggle("active", key === state.sortKey);
          }

          if (!rows.length) {
            tbody.innerHTML = `
              <tr>
                <td colspan="5">
                  <div class="emptyState">
                    <h3>No results found</h3>
                    <p>Try a broader keyword (e.g., <span style="font-family: var(--mono)">audio</span>, <span style="font-family: var(--mono)">networking</span>, or an event name).</p>
                  </div>
                </td>
              </tr>
            `;
            return;
          }

          const q = state.query.trim();
          tbody.innerHTML = rows
            .map((r) => {
              const preview = highlight(r.feedback, q);
              const event = highlight(r.event, q);
              const participant = highlight(r.participant, q);
              const date = highlight(r.dateDisplay, q);
              return `
                <tr>
                  <td class="colDate"><span title="${escapeHtml(r.dateISO)}">${date}</span></td>
                  <td class="colEvent">
                    <div style="font-weight: 900; letter-spacing: -0.01em">${event}</div>
                    <div style="margin-top: 4px; color: rgba(71, 85, 105, 0.92); font-size: 12px">${escapeHtml(
                      r.role
                    )}</div>
                  </td>
                  <td class="colParticipant">
                    <div style="font-weight: 900; letter-spacing: -0.01em">${participant}</div>
                  </td>
                  <td class="colRating">
                    <div class="rating">
                      <div>
                        <div style="display: flex; align-items: center; gap: 8px">
                          ${renderStars(r.rating)}
                          <span class="ratingNum">${r.rating}.0</span>
                        </div>
                        <div class="ratingSub">${escapeHtml(ratingLabel(r.rating))}</div>
                      </div>
                    </div>
                  </td>
                  <td class="colFeedback">
                    <div class="feedbackCell">
                      <div class="feedbackPreview">${preview}</div>
                      <div class="feedbackActions">
                        <button class="linkBtn" type="button" data-action="view" data-id="${escapeHtml(
                          r.id
                        )}">View full</button>
                        <span style="color: rgba(100, 116, 139, 0.95); font-size: 12px">ID <span style="font-family: var(--mono)">${escapeHtml(
                          r.id.split("_").slice(1, 3).join("-")
                        )}</span></span>
                      </div>
                    </div>
                  </td>
                </tr>
              `;
            })
            .join("");
        };

        const detectTopics = (rows) => {
          const counts = new Map(topicLexicon.map((t) => [t.k, 0]));
          for (const r of rows) {
            const text = normalize(r.feedback);
            for (const t of topicLexicon) {
              if (t.terms.some((term) => text.includes(term))) counts.set(t.k, (counts.get(t.k) || 0) + 1);
            }
          }
          const ranked = Array.from(counts.entries())
            .sort((a, b) => b[1] - a[1])
            .filter(([, c]) => c > 0)
            .slice(0, 4);
          const label = (k) => {
            const map = {
              audio: "Audio / AV",
              slides: "Slides",
              timing: "Timing",
              networking: "Networking",
              venue: "Venue",
              food: "Catering",
              registration: "Registration",
              qanda: "Q&A",
              content: "Content depth",
              workshops: "Workshops"
            };
            return map[k] || k;
          };
          return ranked.map(([k, c]) => ({ key: k, label: label(k), count: c }));
        };

        const computeSummary = () => {
          const rows = state.rows.slice();
          const byEvent = new Map();
          for (const r of rows) {
            const key = r.event;
            const v = byEvent.get(key) || { event: key, count: 0, sum: 0 };
            v.count += 1;
            v.sum += r.rating;
            byEvent.set(key, v);
          }

          const eventsRanked = Array.from(byEvent.values())
            .map((e) => ({ ...e, avg: e.sum / e.count }))
            .sort((a, b) => b.avg - a.avg || b.count - a.count);

          const avg = rows.reduce((s, r) => s + r.rating, 0) / rows.length;
          const dist = rows.reduce(
            (acc, r) => {
              acc[r.rating] = (acc[r.rating] || 0) + 1;
              return acc;
            },
            { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }
          );

          const top = eventsRanked[0];
          const bottom = eventsRanked.slice().sort((a, b) => a.avg - b.avg || b.count - a.count)[0];
          const topics = detectTopics(rows);

          const polarity = (rating) => (rating >= 4 ? "positive" : rating === 3 ? "mixed" : "negative");
          const sentimentShare = {
            positive: rows.filter((r) => polarity(r.rating) === "positive").length,
            mixed: rows.filter((r) => polarity(r.rating) === "mixed").length,
            negative: rows.filter((r) => polarity(r.rating) === "negative").length
          };

          return {
            avg,
            total: rows.length,
            dist,
            top,
            bottom,
            topics,
            sentimentShare
          };
        };

        const renderSummary = () => {
          const s = computeSummary();
          const metrics = [
            {
              label: "Average rating",
              value: s.avg.toFixed(1),
              hint: `${s.sentimentShare.positive} positive · ${s.sentimentShare.mixed} mixed · ${s.sentimentShare.negative} needs attention`
            },
            {
              label: "Top event",
              value: s.top ? s.top.event : "—",
              hint: s.top ? `${s.top.avg.toFixed(1)} avg across ${s.top.count} submission${s.top.count === 1 ? "" : "s"}` : ""
            },
            {
              label: "Needs focus",
              value: s.bottom ? s.bottom.event : "—",
              hint: s.bottom ? `${s.bottom.avg.toFixed(1)} avg across ${s.bottom.count} submission${s.bottom.count === 1 ? "" : "s"}` : ""
            },
            {
              label: "Most mentioned",
              value: s.topics[0] ? s.topics[0].label : "—",
              hint: s.topics.length ? `${s.topics.map((t) => `${t.label} (${t.count})`).join(" · ")}` : "No dominant themes detected"
            }
          ];

          const metricGrid = $("#metricGrid");
          metricGrid.innerHTML = metrics
            .map(
              (m) => `
              <div class="metric">
                <div class="label">${escapeHtml(m.label)}</div>
                <div class="value" title="${escapeHtml(m.value)}">${escapeHtml(m.value)}</div>
                <div class="hint">${escapeHtml(m.hint || "")}</div>
              </div>
            `
            )
            .join("");

          const bullets = [];
          bullets.push(
            `Overall satisfaction is ${s.avg >= 4 ? "strong" : s.avg >= 3.4 ? "healthy" : "mixed"} with an average rating of ${s.avg.toFixed(
              1
            )}/5.`
          );
          if (s.top) bullets.push(`Highest-performing event: ${s.top.event} (${s.top.avg.toFixed(1)} avg).`);
          if (s.bottom) bullets.push(`Biggest improvement opportunity: ${s.bottom.event} (${s.bottom.avg.toFixed(1)} avg).`);
          if (s.topics.length)
            bullets.push(
              `Recurring themes: ${s.topics
                .slice(0, 3)
                .map((t) => `${t.label}`)
                .join(", ")}. Prioritize quick wins in the next run-of-show.`
            );

          bullets.push("Recommended next step: publish a follow‑up email with the deck, recordings (if available), and 3 action items.");

          const ul = $("#summaryBullets");
          ul.innerHTML = bullets.map((b) => `<li>${escapeHtml(b)}</li>`).join("");

          const distLine = `Ratings distribution: 5★ ${s.dist[5]}, 4★ ${s.dist[4]}, 3★ ${s.dist[3]}, 2★ ${s.dist[2]}, 1★ ${s.dist[1]}.`;
          $("#summaryNote").textContent = distLine;
        };

        const openModal = (id) => {
          const row = state.rows.find((r) => r.id === id);
          if (!row) return;
          state.modalId = id;
          state.lastFocusEl = document.activeElement;
          const modal = $("#modal");
          modal.classList.add("show");
          modal.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";

          const meta = $("#modalMeta");
          meta.innerHTML = `
            <div class="detail"><div class="k">Date</div><div class="v">${escapeHtml(row.dateDisplay)}</div></div>
            <div class="detail"><div class="k">Event</div><div class="v">${escapeHtml(row.event)}</div></div>
            <div class="detail"><div class="k">Participant</div><div class="v">${escapeHtml(row.participant)}</div></div>
            <div class="detail"><div class="k">Rating</div><div class="v">${escapeHtml(
              `${row.rating}.0 — ${ratingLabel(row.rating)}`
            )}</div></div>
          `;
          $("#modalFeedback").textContent = row.feedback;
          $("#copyFeedback").focus();
        };

        const closeModal = () => {
          state.modalId = null;
          const modal = $("#modal");
          modal.classList.remove("show");
          modal.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";
          const el = state.lastFocusEl;
          state.lastFocusEl = null;
          if (el && typeof el.focus === "function") el.focus();
        };

        const showToast = (msg) => {
          const el = $("#toast");
          el.textContent = msg;
          el.classList.add("show");
          window.clearTimeout(showToast._t);
          showToast._t = window.setTimeout(() => el.classList.remove("show"), 2200);
        };

        const exportToCsv = () => {
          const rows = getFilteredSorted();
          const headers = ["date", "event", "participant", "rating", "feedback"];
          const esc = (s) => `"${String(s).replaceAll('"', '""')}"`;
          const lines = [
            headers.join(","),
            ...rows.map((r) => [r.dateDisplay, r.event, r.participant, r.rating, r.feedback].map(esc).join(","))
          ];
          const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          const stamp = new Date().toISOString().slice(0, 10);
          a.href = url;
          a.download = `event-feedback-${stamp}.csv`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          showToast(`Exported ${rows.length} row${rows.length === 1 ? "" : "s"} to CSV.`);
        };

        const setSummaryVisibility = (visible) => {
          const card = $("#summaryCard");
          const showRow = $("#summaryShowRow");
          if (visible) {
            card.style.display = "";
            showRow.classList.remove("show");
            state.summaryClosed = false;
          } else {
            card.style.display = "none";
            showRow.classList.add("show");
            state.summaryClosed = true;
          }
        };

        const wireEvents = () => {
          const input = $("#searchInput");
          const clear = $("#clearSearch");

          input.addEventListener("input", () => {
            state.query = input.value || "";
            renderTable();
          });

          clear.addEventListener("click", () => {
            input.value = "";
            state.query = "";
            renderTable();
            input.focus();
          });

          $("#resetView").addEventListener("click", () => {
            input.value = "";
            state.query = "";
            state.sortKey = "date";
            state.sortDir = "desc";
            renderTable();
            renderSummary();
            showToast("View reset.");
            input.focus();
          });

          $("#exportCsv").addEventListener("click", exportToCsv);

          $("#scrollTop").addEventListener("click", (e) => {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: "smooth" });
          });

          $("#closeSummary").addEventListener("click", () => setSummaryVisibility(false));
          $("#showSummary").addEventListener("click", () => setSummaryVisibility(true));

          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              if (state.modalId) {
                e.preventDefault();
                closeModal();
                return;
              }
              if (document.activeElement === input || input.value) {
                input.value = "";
                state.query = "";
                renderTable();
              }
            }

            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
              e.preventDefault();
              input.focus();
            }
          });

          document.addEventListener("click", (e) => {
            const th = e.target.closest(".thBtn");
            if (th) {
              const key = th.getAttribute("data-key");
              if (key) {
                if (state.sortKey === key) state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
                else {
                  state.sortKey = key;
                  state.sortDir = key === "date" ? "desc" : "asc";
                }
                renderTable();
              }
              return;
            }

            const view = e.target.closest('[data-action="view"]');
            if (view) {
              const id = view.getAttribute("data-id");
              if (id) openModal(id);
              return;
            }

            if (e.target && e.target.getAttribute && e.target.getAttribute("data-close") === "true") {
              closeModal();
              return;
            }
          });

          $("#closeModal").addEventListener("click", closeModal);
          $("#closeModal2").addEventListener("click", closeModal);

          $("#copyFeedback").addEventListener("click", async () => {
            if (!state.modalId) return;
            const row = state.rows.find((r) => r.id === state.modalId);
            if (!row) return;
            try {
              await navigator.clipboard.writeText(row.feedback);
              showToast("Copied feedback to clipboard.");
            } catch {
              showToast("Copy not available in this browser context.");
            }
          });
        };

        const init = () => {
          renderSummary();
          renderTable();
          wireEvents();
          $("#searchInput").focus();
        };

        init();
      })();
    </script>
  </body>
</html>
