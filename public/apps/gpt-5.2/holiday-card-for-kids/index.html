<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0b1020" />
    <title>Holiday Card for Kids ‚ú®</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Pacifico&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg0: #070a16;
        --bg1: #0b1936;
        --panel: rgba(255, 255, 255, 0.09);
        --panel2: rgba(255, 255, 255, 0.12);
        --stroke: rgba(255, 255, 255, 0.18);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.72);
        --shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
        --shadow2: 0 10px 30px rgba(0, 0, 0, 0.35);
        --good: #5ef1b7;
        --warn: #ffd16a;
        --bad: #ff5f87;
        --focus: rgba(110, 231, 255, 0.85);
        --radius: 18px;
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family:
          Fredoka,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          "Helvetica Neue",
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
        color: var(--text);
        overflow: hidden;
        background:
          radial-gradient(1200px 900px at 20% 10%, rgba(100, 255, 220, 0.12), transparent 55%),
          radial-gradient(1100px 800px at 70% 15%, rgba(255, 130, 240, 0.14), transparent 60%),
          radial-gradient(1200px 900px at 50% 95%, rgba(100, 160, 255, 0.14), transparent 60%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
      }

      .aurora {
        position: fixed;
        inset: -20%;
        pointer-events: none;
        filter: blur(24px) saturate(140%);
        opacity: 0.85;
        transform: translateZ(0);
      }
      .aurora::before,
      .aurora::after {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(45% 35% at 20% 30%, rgba(110, 255, 210, 0.45), transparent 55%),
          radial-gradient(40% 30% at 65% 25%, rgba(255, 170, 255, 0.42), transparent 58%),
          radial-gradient(40% 30% at 50% 80%, rgba(110, 190, 255, 0.38), transparent 60%);
        animation: drift 12s ease-in-out infinite alternate;
      }
      .aurora::after {
        animation-duration: 16s;
        mix-blend-mode: screen;
        opacity: 0.75;
      }

      @keyframes drift {
        0% {
          transform: translate(-2%, -2%) rotate(-2deg) scale(1.02);
        }
        100% {
          transform: translate(2%, 2%) rotate(2deg) scale(1.08);
        }
      }

      body.twinkleFlash .stage {
        animation: twinkleGlow 900ms ease-in-out both;
      }
      body.twinkleFlash .paper::before {
        animation: twinklePaper 900ms ease-in-out both;
      }
      @keyframes twinkleGlow {
        0% {
          filter: saturate(1) brightness(1);
        }
        35% {
          filter: saturate(1.25) brightness(1.08);
        }
        70% {
          filter: saturate(1.4) brightness(1.12);
        }
        100% {
          filter: saturate(1) brightness(1);
        }
      }
      @keyframes twinklePaper {
        0% {
          opacity: 0.8;
        }
        40% {
          opacity: 1;
        }
        100% {
          opacity: 0.8;
        }
      }

      canvas#snow,
      canvas#fx {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      canvas#fx {
        mix-blend-mode: screen;
      }

      .lightsString {
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        height: 74px;
        pointer-events: none;
        z-index: 2;
        opacity: 1;
        transform: translateZ(0);
      }
      body.lightsOff .lightsString {
        opacity: 0.25;
        filter: saturate(0.2);
      }
      .lightsString::before {
        content: "";
        position: absolute;
        left: -60px;
        right: -60px;
        top: 38px;
        height: 5px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.42);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12);
        transform: rotate(-1.2deg);
      }
      .lightsString .bulb {
        position: absolute;
        top: 18px;
        width: 16px;
        height: 22px;
        border-radius: 10px 10px 12px 12px;
        background: radial-gradient(120% 120% at 30% 20%, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.2));
        box-shadow:
          0 14px 22px rgba(0, 0, 0, 0.25),
          0 0 24px color-mix(in oklab, var(--b, #ffd16a) 80%, transparent);
        border: 1px solid rgba(255, 255, 255, 0.25);
        filter: saturate(120%);
        transform-origin: 50% -10px;
        animation: bulbSwing 2.8s ease-in-out infinite;
      }
      body.lightsOff .lightsString .bulb {
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.22);
        animation: none;
      }
      .lightsString .bulb::before {
        content: "";
        position: absolute;
        left: 50%;
        top: -8px;
        width: 10px;
        height: 10px;
        transform: translateX(-50%);
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.6);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12);
      }
      .lightsString .bulb::after {
        content: "";
        position: absolute;
        inset: -18px -16px -24px -16px;
        border-radius: 999px;
        background: radial-gradient(closest-side, color-mix(in oklab, var(--b, #ffd16a) 60%, transparent), transparent);
        opacity: 0.95;
        mix-blend-mode: screen;
        filter: blur(2px);
      }

      @keyframes bulbSwing {
        0% {
          transform: rotate(-2deg);
        }
        50% {
          transform: rotate(2.5deg);
        }
        100% {
          transform: rotate(-2deg);
        }
      }

      .app {
        position: relative;
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 14px;
      }

      .topbar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
        border: 1px solid var(--stroke);
        border-radius: var(--radius);
        box-shadow: var(--shadow2);
        backdrop-filter: blur(12px);
      }

      .brand {
        display: flex;
        align-items: baseline;
        gap: 10px;
        min-width: 240px;
      }
      .brand .title {
        font-family: Pacifico, Fredoka, cursive;
        font-size: 22px;
        letter-spacing: 0.2px;
        line-height: 1;
      }
      .brand .sub {
        font-size: 12px;
        color: var(--muted);
      }

      .quick {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        justify-content: flex-end;
        flex-wrap: wrap;
      }

      button,
      select,
      input[type="text"] {
        font-family: inherit;
      }

      .btn {
        border: 1px solid var(--stroke);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.08));
        color: var(--text);
        padding: 9px 12px;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.22);
        transition: transform 140ms ease, background 180ms ease, border-color 180ms ease;
        user-select: none;
      }
      .btn:hover {
        transform: translateY(-1px);
        border-color: rgba(255, 255, 255, 0.26);
      }
      .btn:active {
        transform: translateY(0px) scale(0.98);
      }
      .btn.primary {
        background: linear-gradient(180deg, rgba(110, 255, 210, 0.26), rgba(255, 255, 255, 0.08));
        border-color: rgba(110, 255, 210, 0.38);
      }
      .btn.warn {
        background: linear-gradient(180deg, rgba(255, 209, 106, 0.22), rgba(255, 255, 255, 0.08));
        border-color: rgba(255, 209, 106, 0.38);
      }
      .btn.bad {
        background: linear-gradient(180deg, rgba(255, 95, 135, 0.22), rgba(255, 255, 255, 0.08));
        border-color: rgba(255, 95, 135, 0.38);
      }
      .btn.small {
        padding: 7px 10px;
        border-radius: 11px;
        font-size: 13px;
      }
      .btn:focus-visible {
        outline: 3px solid var(--focus);
        outline-offset: 2px;
      }

      .main {
        display: grid;
        grid-template-columns: 330px minmax(380px, 1fr) 290px;
        gap: 12px;
        min-height: 0;
        flex: 1;
      }

      .panel {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
        border: 1px solid var(--stroke);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(12px);
        min-height: 0;
      }

      .tray {
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .panelHead {
        padding: 12px 12px 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.14);
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }
      .panelHead h2 {
        margin: 0;
        font-size: 16px;
        letter-spacing: 0.2px;
      }
      .panelHead .meta {
        font-size: 12px;
        color: var(--muted);
      }

      .stickerGrid {
        padding: 12px;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
        overflow: auto;
        min-height: 0;
      }

      .stickerTile {
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.06));
        border-radius: 16px;
        padding: 10px 10px 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 6px;
        cursor: grab;
        user-select: none;
        touch-action: none;
        transition: transform 140ms ease, border-color 180ms ease, background 180ms ease;
      }
      .stickerTile:hover {
        transform: translateY(-2px);
        border-color: rgba(255, 255, 255, 0.3);
      }
      .stickerTile:active {
        cursor: grabbing;
        transform: translateY(0px) scale(0.98);
      }
      .stickerTile .icon {
        width: 54px;
        height: 54px;
        border-radius: 18px;
        display: grid;
        place-items: center;
        background:
          radial-gradient(120% 120% at 30% 25%, rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0.18)),
          radial-gradient(80% 80% at 70% 70%, color-mix(in oklab, var(--accent) 60%, transparent), transparent 55%);
        border: 1px solid rgba(255, 255, 255, 0.22);
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.24);
      }
      .stickerTile .icon span {
        font-size: 30px;
        filter: drop-shadow(0 8px 10px rgba(0, 0, 0, 0.24));
        transform: translateZ(0);
      }
      .stickerTile .label {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.82);
        text-align: center;
        line-height: 1.1;
      }

      .trayHint {
        padding: 10px 12px 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.14);
        color: var(--muted);
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .trayHint kbd {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
          monospace;
        background: rgba(0, 0, 0, 0.22);
        border: 1px solid rgba(255, 255, 255, 0.16);
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.84);
      }

      .stageCol {
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 0;
      }
      .stageTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
        padding: 10px 12px;
      }
      .fieldRow {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .field {
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 13px;
        color: var(--muted);
      }
      .field input[type="text"] {
        width: 150px;
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(0, 0, 0, 0.22);
        color: rgba(255, 255, 255, 0.92);
        outline: none;
      }
      .field input[type="text"]:focus {
        border-color: rgba(110, 231, 255, 0.5);
        box-shadow: 0 0 0 4px rgba(110, 231, 255, 0.18);
      }

      .field select {
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(0, 0, 0, 0.22);
        color: rgba(255, 255, 255, 0.9);
        outline: none;
      }
      .field input[type="color"] {
        width: 44px;
        height: 36px;
        padding: 0;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(0, 0, 0, 0.22);
        cursor: pointer;
      }
      .field input[type="color"]::-webkit-color-swatch-wrapper {
        padding: 8px;
      }
      .field input[type="color"]::-webkit-color-swatch {
        border: none;
        border-radius: 10px;
      }

      .stageWrap {
        position: relative;
        padding: 12px;
        display: grid;
        place-items: center;
        overflow: hidden;
        min-height: 0;
      }

      .stage {
        position: relative;
        width: min(880px, 100%);
        aspect-ratio: 16 / 10;
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        overflow: hidden;
        box-shadow:
          0 34px 80px rgba(0, 0, 0, 0.45),
          inset 0 1px 0 rgba(255, 255, 255, 0.25);
        transform: perspective(1100px) rotateX(1.5deg) rotateY(-1.8deg);
        background:
          radial-gradient(1200px 900px at 30% 10%, rgba(255, 255, 255, 0.12), transparent 55%),
          radial-gradient(1000px 800px at 70% 10%, rgba(255, 255, 255, 0.08), transparent 60%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
      }

      .stage::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(12px 12px at 18% 26%, rgba(255, 255, 255, 0.14), transparent 60%),
          radial-gradient(10px 10px at 62% 20%, rgba(255, 255, 255, 0.12), transparent 60%),
          radial-gradient(14px 14px at 82% 34%, rgba(255, 255, 255, 0.12), transparent 60%),
          radial-gradient(10px 10px at 75% 82%, rgba(255, 255, 255, 0.12), transparent 60%),
          radial-gradient(10px 10px at 28% 76%, rgba(255, 255, 255, 0.1), transparent 60%),
          radial-gradient(700px 450px at 50% 100%, rgba(0, 0, 0, 0.26), transparent 65%);
        opacity: 0.8;
        pointer-events: none;
      }

      .paper {
        position: absolute;
        inset: 18px;
        border-radius: 18px;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.12);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.7),
          inset 0 -28px 90px rgba(0, 0, 0, 0.12);
        background:
          radial-gradient(1000px 700px at 30% 15%, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.86)),
          repeating-linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.05) 0px,
            rgba(255, 255, 255, 0.05) 9px,
            rgba(0, 0, 0, 0.02) 9px,
            rgba(0, 0, 0, 0.02) 12px
          );
      }

      .paper::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(900px 700px at 15% 15%, rgba(130, 230, 255, 0.22), transparent 55%),
          radial-gradient(900px 700px at 85% 12%, rgba(255, 170, 245, 0.18), transparent 58%),
          radial-gradient(900px 700px at 50% 92%, rgba(110, 255, 210, 0.18), transparent 60%);
        opacity: 0.8;
        mix-blend-mode: multiply;
        pointer-events: none;
      }

      .message {
        position: absolute;
        inset: 20px 24px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        color: rgba(10, 16, 34, 0.9);
        text-shadow: 0 1px 0 rgba(255, 255, 255, 0.55);
      }

      .message .title {
        font-family: Pacifico, cursive;
        font-size: clamp(22px, 2.6vw, 34px);
        line-height: 1.1;
      }
      .message .body {
        font-size: clamp(14px, 1.5vw, 18px);
        line-height: 1.5;
        max-width: 56ch;
      }
      .message .sig {
        margin-top: auto;
        font-weight: 700;
        font-size: 16px;
      }

      .editable {
        border-radius: 12px;
        padding: 6px 8px;
        outline: none;
      }
      .editable:focus {
        box-shadow: 0 0 0 4px rgba(110, 231, 255, 0.22);
        background: rgba(255, 255, 255, 0.75);
      }

      .bg-snowy .paper::after {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(18px 18px at 20% 30%, rgba(255, 255, 255, 0.55), transparent 60%),
          radial-gradient(14px 14px at 68% 22%, rgba(255, 255, 255, 0.45), transparent 60%),
          radial-gradient(18px 18px at 78% 62%, rgba(255, 255, 255, 0.4), transparent 60%),
          radial-gradient(18px 18px at 38% 74%, rgba(255, 255, 255, 0.4), transparent 60%),
          radial-gradient(900px 700px at 50% 105%, rgba(90, 145, 255, 0.16), transparent 60%);
        opacity: 0.55;
        mix-blend-mode: screen;
        pointer-events: none;
      }
      .bg-candy .paper::after {
        content: "";
        position: absolute;
        inset: 0;
        background:
          repeating-linear-gradient(
            135deg,
            rgba(255, 95, 135, 0.12) 0px,
            rgba(255, 95, 135, 0.12) 10px,
            rgba(255, 255, 255, 0.25) 10px,
            rgba(255, 255, 255, 0.25) 20px
          );
        opacity: 0.6;
        pointer-events: none;
      }
      .bg-night .paper::after {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(3px 3px at 18% 26%, rgba(255, 255, 255, 0.75), transparent 65%),
          radial-gradient(2px 2px at 62% 20%, rgba(255, 255, 255, 0.7), transparent 65%),
          radial-gradient(3px 3px at 82% 34%, rgba(255, 255, 255, 0.72), transparent 65%),
          radial-gradient(2px 2px at 75% 82%, rgba(255, 255, 255, 0.6), transparent 65%),
          radial-gradient(2px 2px at 28% 76%, rgba(255, 255, 255, 0.6), transparent 65%),
          radial-gradient(700px 450px at 50% 0%, rgba(75, 120, 255, 0.22), transparent 60%),
          radial-gradient(700px 450px at 50% 100%, rgba(110, 255, 210, 0.12), transparent 65%),
          linear-gradient(180deg, rgba(10, 16, 34, 0.06), rgba(10, 16, 34, 0.02));
        opacity: 0.65;
        mix-blend-mode: multiply;
        pointer-events: none;
      }

      .layer {
        position: absolute;
        inset: 0;
      }

      .drawCanvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      body.penOn .drawCanvas {
        pointer-events: auto;
        cursor: crosshair;
      }

      #stickersLayer {
        position: absolute;
        inset: 0;
      }

      .sticker {
        position: absolute;
        width: 78px;
        height: 78px;
        border-radius: 22px;
        display: grid;
        place-items: center;
        user-select: none;
        touch-action: none;
        cursor: grab;
        border: 1px solid rgba(255, 255, 255, 0.22);
        background:
          radial-gradient(120% 120% at 30% 25%, rgba(255, 255, 255, 0.86), rgba(255, 255, 255, 0.32)),
          radial-gradient(70% 70% at 70% 75%, color-mix(in oklab, var(--accent) 60%, transparent), transparent 58%);
        box-shadow:
          0 18px 42px rgba(0, 0, 0, 0.22),
          inset 0 1px 0 rgba(255, 255, 255, 0.65);
        transform-origin: 50% 60%;
      }
      .sticker::before {
        content: "";
        position: absolute;
        inset: -2px;
        border-radius: 24px;
        background: radial-gradient(90% 80% at 50% 20%, rgba(255, 255, 255, 0.55), transparent 62%);
        opacity: 0.8;
        pointer-events: none;
        mix-blend-mode: screen;
      }
      .sticker .emoji {
        font-size: 40px;
        filter: drop-shadow(0 10px 12px rgba(0, 0, 0, 0.22));
      }
      .sticker:active {
        cursor: grabbing;
      }
      .sticker.selected {
        outline: 3px solid rgba(110, 231, 255, 0.75);
        outline-offset: 3px;
      }
      .sticker.pop {
        animation: pop 300ms cubic-bezier(0.2, 0.9, 0.2, 1) both;
      }
      .sticker.wiggle {
        animation: wiggle 420ms ease-in-out both;
      }

      @keyframes pop {
        0% {
          transform: translate(-50%, -50%) rotate(var(--r, 0deg)) scale(calc(var(--s, 1) * 0.88));
        }
        60% {
          transform: translate(-50%, -50%) rotate(var(--r, 0deg)) scale(calc(var(--s, 1) * 1.1));
        }
        100% {
          transform: translate(-50%, -50%) rotate(var(--r, 0deg)) scale(var(--s, 1));
        }
      }
      @keyframes wiggle {
        0% {
          transform: translate(-50%, -50%) rotate(calc(var(--r, 0deg) - 10deg)) scale(var(--s, 1));
        }
        50% {
          transform: translate(-50%, -50%) rotate(calc(var(--r, 0deg) + 12deg)) scale(var(--s, 1));
        }
        100% {
          transform: translate(-50%, -50%) rotate(var(--r, 0deg)) scale(var(--s, 1));
        }
      }

      .toolbox {
        position: absolute;
        display: flex;
        gap: 8px;
        padding: 10px;
        border-radius: 16px;
        background: rgba(0, 0, 0, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(10px);
        transform: translate(-50%, -115%);
        pointer-events: auto;
      }
      .toolbox.hidden {
        display: none;
      }
      .toolbox .btn {
        box-shadow: none;
      }
      .toolbox .sep {
        width: 1px;
        background: rgba(255, 255, 255, 0.18);
        margin: 0 2px;
      }

      .side {
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .sideBody {
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow: auto;
        min-height: 0;
      }
      .tip {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.82);
        line-height: 1.35;
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.14);
      }
      .tip strong {
        color: rgba(255, 255, 255, 0.95);
      }
      .footer {
        padding: 0 4px;
        font-size: 12px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }

      .toast {
        position: fixed;
        left: 50%;
        bottom: 14px;
        transform: translateX(-50%);
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.18);
        color: rgba(255, 255, 255, 0.92);
        font-size: 13px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(10px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 180ms ease, transform 180ms ease;
        z-index: 50;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-4px);
      }

      dialog {
        border: 1px solid rgba(255, 255, 255, 0.22);
        border-radius: 18px;
        background: rgba(16, 20, 40, 0.88);
        color: rgba(255, 255, 255, 0.92);
        padding: 0;
        box-shadow: 0 40px 120px rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(16px);
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.5);
      }
      .modal {
        padding: 14px 14px 12px;
        width: min(720px, calc(100vw - 28px));
      }
      .modal h3 {
        margin: 2px 0 8px;
        font-size: 18px;
      }
      .modal p {
        margin: 8px 0;
        color: rgba(255, 255, 255, 0.84);
        line-height: 1.5;
      }
      .modal .grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
        margin: 12px 0 10px;
      }
      .modal .card {
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.07);
        border: 1px solid rgba(255, 255, 255, 0.14);
        padding: 10px 12px;
        color: rgba(255, 255, 255, 0.86);
      }
      .modal .card b {
        color: rgba(255, 255, 255, 0.95);
      }
      .modal .actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.14);
      }

      @media (max-width: 1060px) {
        body {
          overflow: auto;
        }
        .app {
          min-height: 100%;
          overflow: hidden;
        }
        .main {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto auto;
        }
        .tray {
          order: 2;
        }
        .stageCol {
          order: 1;
        }
        .side {
          order: 3;
        }
        .stage {
          transform: none;
        }
        canvas#snow,
        canvas#fx {
          position: fixed;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .aurora::before,
        .aurora::after {
          animation: none;
        }
        .sticker.pop,
        .sticker.wiggle {
          animation: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="aurora" aria-hidden="true"></div>
    <canvas id="snow"></canvas>
    <canvas id="fx"></canvas>
    <div id="lightsString" class="lightsString" aria-hidden="true"></div>

    <div class="app">
      <header class="topbar panel">
        <div class="brand">
          <div class="title">Happy Holidays!</div>
          <div class="sub">Drag stickers ‚Ä¢ Tap to wiggle ‚Ä¢ Make a card</div>
        </div>
        <div class="quick">
          <button class="btn small" id="soundBtn" type="button" aria-pressed="true">Sound: On</button>
          <button class="btn small" id="jingleBtn" type="button">Play Jingle</button>
          <button class="btn small primary" id="sprinkleBtn" type="button">Magic Sprinkle</button>
          <button class="btn small" id="downloadBtn" type="button">Download PNG</button>
          <button class="btn small" id="helpBtn" type="button">How to Play</button>
          <button class="btn small warn" id="resetBtn" type="button">Reset</button>
        </div>
      </header>

      <main class="main">
        <section class="panel tray" aria-label="Sticker tray">
          <div class="panelHead">
            <h2>Sticker Tray</h2>
            <div class="meta">Drag onto the card</div>
          </div>
          <div class="stickerGrid" id="stickerGrid"></div>
          <div class="trayHint">
            <span>Tip: tap a sticker twice to remove it.</span>
            <span><kbd>‚å´</kbd> deletes selected</span>
          </div>
        </section>

        <section class="panel stageCol" aria-label="Holiday card maker">
          <div class="stageTop">
            <div class="fieldRow">
              <label class="field"
                >To
                <input id="toName" type="text" autocomplete="off" inputmode="text" placeholder="Friend" value="Friend" />
              </label>
              <label class="field"
                >From
                <input id="fromName" type="text" autocomplete="off" inputmode="text" placeholder="Me" value="Me" />
              </label>
            </div>
            <div class="fieldRow">
              <label class="field"
                >Background
                <select id="bgSelect" aria-label="Background style">
                  <option value="bg-snowy">Snowy</option>
                  <option value="bg-candy">Candy Stripes</option>
                  <option value="bg-night">Night Sky</option>
                </select>
              </label>
              <button class="btn small" id="penBtn" type="button" aria-pressed="false">Magic Pen: Off</button>
              <label class="field" title="Pen color"
                >Color <input id="penColor" type="color" value="#ffd16a" aria-label="Pen color" />
              </label>
              <button class="btn small" id="shuffleBtn" type="button">Surprise Layout</button>
            </div>
          </div>

          <div class="stageWrap">
            <div class="stage bg-snowy" id="stage" aria-label="Holiday card canvas">
              <div class="paper" aria-hidden="true"></div>
              <div class="message" aria-label="Message">
                <div class="title" id="msgTitle">Happy Holidays, <span id="toInline">Friend</span>!</div>
                <div class="body editable" id="msgBody" contenteditable="true" spellcheck="false">
                  May your days be merry, bright, and full of giggles. ‚ùÑÔ∏èüéÅ
                  <br />
                  <b>Drag</b> stickers onto this card and make it super colorful!
                </div>
                <div class="sig">‚Äî <span id="fromInline">Me</span></div>
              </div>
              <canvas id="drawCanvas" class="drawCanvas" aria-label="Drawing canvas"></canvas>
              <div id="stickersLayer" class="layer" aria-hidden="false"></div>
              <div id="toolbox" class="toolbox hidden" role="group" aria-label="Sticker tools">
                <button class="btn small" type="button" data-act="bigger" title="Bigger">+</button>
                <button class="btn small" type="button" data-act="smaller" title="Smaller">‚àí</button>
                <div class="sep" aria-hidden="true"></div>
                <button class="btn small" type="button" data-act="rotL" title="Rotate left">‚ü≤</button>
                <button class="btn small" type="button" data-act="rotR" title="Rotate right">‚ü≥</button>
                <button class="btn small" type="button" data-act="flip" title="Flip">‚áã</button>
                <div class="sep" aria-hidden="true"></div>
                <button class="btn small" type="button" data-act="front" title="Bring to front">Front</button>
                <button class="btn small" type="button" data-act="back" title="Send back">Back</button>
                <button class="btn small bad" type="button" data-act="delete" title="Delete">‚úï</button>
              </div>
            </div>
          </div>
        </section>

        <aside class="panel side" aria-label="Fun buttons">
          <div class="panelHead">
            <h2>Fun Buttons</h2>
            <div class="meta">Try them!</div>
          </div>
          <div class="sideBody">
            <button class="btn primary" id="partyBtn" type="button">Sticker Party</button>
            <button class="btn" id="shakeBtn" type="button">Shake Snow Globe</button>
            <button class="btn" id="twinkleBtn" type="button">Twinkle!</button>
            <button class="btn" id="lightsBtn" type="button">Toggle Lights</button>
            <button class="btn" id="eraseBtn" type="button">Erase Doodles</button>
            <button class="btn" id="clearBtn" type="button">Clear Stickers</button>
            <div class="tip" id="tipBox">
              <strong>Kid-friendly tips:</strong>
              <div>Drag stickers onto the card. Tap a sticker to select it and use the tools.</div>
              <div>Double-tap a sticker to remove it.</div>
              <div>Turn on <b>Magic Pen</b> to draw sparkly lines!</div>
            </div>
          </div>
        </aside>
      </main>

      <div class="footer">
        <div>Made with ‚ùÑÔ∏è + üé® + a tiny bit of magic.</div>
        <div>Try: sprinkle ‚Üí party ‚Üí shake!</div>
      </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <dialog id="helpDialog" aria-label="How to play">
      <div class="modal">
        <h3>How to Play</h3>
        <p>This is your holiday card playground. Make it sparkle!</p>
        <div class="grid">
          <div class="card"><b>Drag</b> stickers from the tray onto the card.</div>
          <div class="card"><b>Tap</b> a sticker to select it and use the mini tools.</div>
          <div class="card"><b>Double-tap</b> a sticker to remove it (or press <b>‚å´</b>).</div>
          <div class="card"><b>Magic Pen</b> draws sparkly doodles. <b>Download PNG</b> saves your card.</div>
        </div>
        <p style="margin-bottom: 0">Psst‚Ä¶ sounds turn on after your first tap. Try <b>Play Jingle</b> and <b>Toggle Lights</b>!</p>
        <div class="actions">
          <button class="btn" id="closeHelpBtn" type="button">Let‚Äôs Go!</button>
        </div>
      </div>
    </dialog>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
      (() => {
        "use strict";

        const $ = (sel, root = document) => root.querySelector(sel);
        const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
        const lerp = (a, b, t) => a + (b - a) * t;
        const rand = (a, b) => a + Math.random() * (b - a);
        const pick = (arr) => arr[(Math.random() * arr.length) | 0];

        const stickerDefs = [
          { type: "tree", label: "Tree", emoji: "üéÑ", accent: "#41e28a" },
          { type: "star", label: "Star", emoji: "‚≠êÔ∏è", accent: "#ffd16a" },
          { type: "gift", label: "Present", emoji: "üéÅ", accent: "#ff5f87" },
          { type: "snowman", label: "Snowman", emoji: "‚òÉÔ∏è", accent: "#8fd8ff" },
          { type: "santa", label: "Santa", emoji: "üéÖ", accent: "#ff5b5b" },
          { type: "elf", label: "Elf", emoji: "üßù", accent: "#5ef1b7" },
          { type: "reindeer", label: "Reindeer", emoji: "ü¶å", accent: "#caa27a" },
          { type: "sled", label: "Sled", emoji: "üõ∑", accent: "#ff9f6a" },
          { type: "candycane", label: "Candy", emoji: "üç≠", accent: "#ff6ad5" },
          { type: "gingerbread", label: "Gingerbread", emoji: "üç™", accent: "#d6b38f" },
          { type: "donut", label: "Donut", emoji: "üç©", accent: "#ffd9f0" },
          { type: "cocoa", label: "Cocoa", emoji: "‚òïÔ∏è", accent: "#b592ff" },
          { type: "bell", label: "Bell", emoji: "üîî", accent: "#ffd16a" },
          { type: "music", label: "Music", emoji: "üé∂", accent: "#cfe0ff" },
          { type: "snowflake", label: "Snowflake", emoji: "‚ùÑÔ∏è", accent: "#6ee7ff" },
          { type: "scarf", label: "Scarf", emoji: "üß£", accent: "#ff5f87" },
          { type: "mitten", label: "Mitten", emoji: "üß§", accent: "#ff9f6a" },
          { type: "stocking", label: "Stocking", emoji: "üß¶", accent: "#ff5f87" },
          { type: "skates", label: "Skates", emoji: "‚õ∏Ô∏è", accent: "#7ad3ff" },
          { type: "penguin", label: "Penguin", emoji: "üêß", accent: "#7ad3ff" },
          { type: "sparkle", label: "Sparkle", emoji: "‚ú®", accent: "#ffd16a" },
          { type: "heart", label: "Heart", emoji: "üíñ", accent: "#ff6ad5" },
          { type: "rainbow", label: "Rainbow", emoji: "üåà", accent: "#b592ff" },
          { type: "unicorn", label: "Unicorn", emoji: "ü¶Ñ", accent: "#b592ff" },
          { type: "dino", label: "Dino", emoji: "ü¶ñ", accent: "#41e28a" },
        ];
        const stickerByType = new Map(stickerDefs.map((d) => [d.type, d]));

        const els = {
          stage: $("#stage"),
          stickersLayer: $("#stickersLayer"),
          stickerGrid: $("#stickerGrid"),
          toolbox: $("#toolbox"),
          toast: $("#toast"),
          drawCanvas: $("#drawCanvas"),
          msgBody: $("#msgBody"),
          lightsString: $("#lightsString"),
          toName: $("#toName"),
          fromName: $("#fromName"),
          toInline: $("#toInline"),
          fromInline: $("#fromInline"),
          bgSelect: $("#bgSelect"),
          penBtn: $("#penBtn"),
          penColor: $("#penColor"),
          helpBtn: $("#helpBtn"),
          closeHelpBtn: $("#closeHelpBtn"),
          helpDialog: $("#helpDialog"),
          resetBtn: $("#resetBtn"),
          downloadBtn: $("#downloadBtn"),
          jingleBtn: $("#jingleBtn"),
          clearBtn: $("#clearBtn"),
          partyBtn: $("#partyBtn"),
          shakeBtn: $("#shakeBtn"),
          twinkleBtn: $("#twinkleBtn"),
          lightsBtn: $("#lightsBtn"),
          eraseBtn: $("#eraseBtn"),
          sprinkleBtn: $("#sprinkleBtn"),
          shuffleBtn: $("#shuffleBtn"),
          soundBtn: $("#soundBtn"),
        };

        const state = {
          stickers: new Map(),
          z: 10,
          selectedId: null,
          dragging: null,
          penMode: false,
          penColor: "#ffd16a",
          loaded: false,
          restoring: false,
          soundEnabled: true,
          soundArmed: false,
        };

        function toast(msg) {
          els.toast.textContent = msg;
          els.toast.classList.add("show");
          window.clearTimeout(toast._t);
          toast._t = window.setTimeout(() => els.toast.classList.remove("show"), 1600);
        }

        const STORAGE_KEY = "holiday_card_kids_v1";
        let saveTimer = 0;

        function scheduleSave() {
          if (state.restoring) return;
          if (!("localStorage" in window)) return;
          window.clearTimeout(saveTimer);
          saveTimer = window.setTimeout(saveState, 450);
        }

        function serializeState() {
          const r = els.stage.getBoundingClientRect();
          const w = r.width || 1;
          const h = r.height || 1;
          return {
            v: 1,
            bg: els.bgSelect.value,
            to: els.toName.value,
            from: els.fromName.value,
            msg: els.msgBody.innerHTML,
            penColor: state.penColor,
            lightsOff: document.body.classList.contains("lightsOff"),
            stickers: [...state.stickers.values()].map((d) => ({
              type: d.type,
              x: d.x / w,
              y: d.y / h,
              scale: d.scale,
              rot: d.rot,
              flip: d.flip,
              z: d.z,
            })),
          };
        }

        function saveState() {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(serializeState()));
          } catch {
            // ignore
          }
        }

        function restoreState(saved) {
          if (!saved || typeof saved !== "object") return false;
          state.restoring = true;
          try {
            if (saved.bg) {
              els.bgSelect.value = saved.bg;
              els.stage.classList.remove("bg-snowy", "bg-candy", "bg-night");
              els.stage.classList.add(saved.bg);
            }

            if (typeof saved.to === "string") els.toName.value = saved.to;
            if (typeof saved.from === "string") els.fromName.value = saved.from;
            if (typeof saved.msg === "string") els.msgBody.innerHTML = saved.msg;
            syncNames();

            if (typeof saved.penColor === "string" && /^#([0-9a-f]{3}){1,2}$/i.test(saved.penColor)) {
              state.penColor = saved.penColor;
              els.penColor.value = saved.penColor;
            }
            document.body.classList.toggle("lightsOff", !!saved.lightsOff);

            clearStickers();
            const r = els.stage.getBoundingClientRect();
            const w = r.width || 1;
            const h = r.height || 1;
            const list = Array.isArray(saved.stickers) ? saved.stickers.slice() : [];
            list.sort((a, b) => (a?.z ?? 0) - (b?.z ?? 0));
            for (const s of list) {
              if (!s || !stickerByType.has(s.type)) continue;
              createSticker(s.type, clamp((s.x ?? 0.5) * w, 18, w - 18), clamp((s.y ?? 0.5) * h, 18, h - 18), {
                scale: clamp(s.scale ?? 1, 0.5, 2.2),
                rot: s.rot ?? rand(-12, 12),
                flip: !!s.flip,
                z: typeof s.z === "number" ? s.z : ++state.z,
              });
              state.z = Math.max(state.z, typeof s.z === "number" ? s.z : state.z);
            }
            setSelected(null);
            state.loaded = true;
            return true;
          } finally {
            state.restoring = false;
          }
        }

        function tryRestoreFromStorage() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return false;
            const saved = JSON.parse(raw);
            return restoreState(saved);
          } catch {
            return false;
          }
        }

        function buildLightsString() {
          const host = els.lightsString;
          if (!host) return;
          const colors = ["#ffd16a", "#ff5f87", "#6ee7ff", "#5ef1b7", "#cfe0ff"];
          host.innerHTML = "";
          const n = 28;
          for (let i = 0; i < n; i++) {
            const b = document.createElement("span");
            b.className = "bulb";
            b.style.left = `${(i / (n - 1)) * 100}%`;
            b.style.setProperty("--b", colors[i % colors.length]);
            b.style.animationDelay = `${rand(0, 1.7).toFixed(2)}s`;
            b.style.animationDuration = `${rand(2.3, 3.6).toFixed(2)}s`;
            b.style.transform = `translateX(-50%) rotate(${rand(-4, 4).toFixed(2)}deg)`;
            host.appendChild(b);
          }
        }

        const draw = {
          ctx: null,
          dpr: 1,
          down: false,
          lastX: 0,
          lastY: 0,
        };

        function resizeDraw(preserve = true) {
          if (!els.drawCanvas) return;
          const w = Math.max(1, els.stage.clientWidth);
          const h = Math.max(1, els.stage.clientHeight);
          const dpr = Math.max(1, Math.min(2.25, window.devicePixelRatio || 1));
          const cw = Math.floor(w * dpr);
          const ch = Math.floor(h * dpr);
          const c = els.drawCanvas;

          let prev = null;
          if (preserve && c.width && c.height) {
            prev = document.createElement("canvas");
            prev.width = c.width;
            prev.height = c.height;
            prev.getContext("2d").drawImage(c, 0, 0);
          }

          if (c.width !== cw || c.height !== ch) {
            c.width = cw;
            c.height = ch;
          }

          draw.dpr = dpr;
          draw.ctx = c.getContext("2d");
          draw.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
          draw.ctx.lineCap = "round";
          draw.ctx.lineJoin = "round";

          if (prev) {
            draw.ctx.globalAlpha = 1;
            draw.ctx.drawImage(prev, 0, 0, prev.width / dpr, prev.height / dpr, 0, 0, w, h);
          }
        }

        function clearDoodles() {
          if (!draw.ctx) resizeDraw(false);
          if (!draw.ctx) return;
          draw.ctx.clearRect(0, 0, els.stage.clientWidth, els.stage.clientHeight);
        }

        function drawLine(x0, y0, x1, y1, pressure = 0.5) {
          if (!draw.ctx) resizeDraw(true);
          const ctx = draw.ctx;
          const w = clamp(3.4 + pressure * 8.2, 3.4, 12.5);
          ctx.save();
          ctx.globalCompositeOperation = "source-over";
          ctx.globalAlpha = 0.9;
          ctx.shadowBlur = 16;
          ctx.shadowColor = state.penColor;
          ctx.strokeStyle = state.penColor;
          ctx.lineWidth = w;
          ctx.beginPath();
          ctx.moveTo(x0, y0);
          ctx.lineTo(x1, y1);
          ctx.stroke();
          ctx.restore();
        }

        function setPenMode(on) {
          state.penMode = !!on;
          document.body.classList.toggle("penOn", state.penMode);
          els.penBtn.textContent = `Magic Pen: ${state.penMode ? "On" : "Off"}`;
          els.penBtn.setAttribute("aria-pressed", state.penMode ? "true" : "false");
          toast(state.penMode ? "Magic Pen on! Draw sparkles ‚ú®" : "Magic Pen off.");
          sfx("tap");
          scheduleSave();
        }

        function setSelected(id) {
          if (state.selectedId === id) return;
          if (state.selectedId && state.stickers.has(state.selectedId)) {
            state.stickers.get(state.selectedId).el.classList.remove("selected");
          }
          state.selectedId = id;
          if (!id || !state.stickers.has(id)) {
            els.toolbox.classList.add("hidden");
            return;
          }
          const item = state.stickers.get(id);
          item.el.classList.add("selected");
          positionToolbox(item.el);
          els.toolbox.classList.remove("hidden");
        }

        function positionToolbox(stickerEl) {
          const stageRect = els.stage.getBoundingClientRect();
          const rect = stickerEl.getBoundingClientRect();
          const cx = rect.left + rect.width / 2 - stageRect.left;
          const top = rect.top - stageRect.top;
          els.toolbox.style.left = `${cx}px`;
          els.toolbox.style.top = `${top}px`;
        }

        function applyTransform(data) {
          const flip = data.flip ? " scaleX(-1)" : "";
          data.el.style.left = `${data.x}px`;
          data.el.style.top = `${data.y}px`;
          data.el.style.zIndex = `${data.z}`;
          data.el.style.setProperty("--s", data.scale);
          data.el.style.setProperty("--r", `${data.rot}deg`);
          data.el.style.transform = `translate(-50%, -50%) rotate(${data.rot}deg) scale(${data.scale})${flip}`;
        }

        function newId() {
          return Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
        }

        function createSticker(type, x, y, opts = {}) {
          const def = stickerByType.get(type) || pick(stickerDefs);
          const id = opts.id || newId();
          const el = document.createElement("div");
          el.className = "sticker";
          el.dataset.id = id;
          el.dataset.type = def.type;
          el.setAttribute("role", "button");
          el.setAttribute("tabindex", "0");
          el.setAttribute("aria-label", `${def.label} sticker`);
          el.style.setProperty("--accent", def.accent);
          el.innerHTML = `<span class="emoji" aria-hidden="true">${def.emoji}</span>`;

          const data = {
            id,
            type: def.type,
            x,
            y,
            scale: opts.scale ?? 1,
            rot: opts.rot ?? rand(-12, 12),
            flip: opts.flip ?? false,
            z: opts.z ?? ++state.z,
            el,
          };
          state.stickers.set(id, data);
          els.stickersLayer.appendChild(el);
          applyTransform(data);
          wireSticker(el);
          scheduleSave();
          return data;
        }

        function deleteSticker(id) {
          const data = state.stickers.get(id);
          if (!data) return;
          data.el.remove();
          state.stickers.delete(id);
          if (state.selectedId === id) setSelected(null);
          scheduleSave();
        }

        function clearStickers() {
          [...state.stickers.keys()].forEach(deleteSticker);
          scheduleSave();
        }

        function wireSticker(el) {
          let start = null;
          let moved = false;
          let lastTap = 0;

          el.addEventListener("pointerdown", (e) => {
            armSoundOnce();
            e.preventDefault();
            e.stopPropagation();
            el.setPointerCapture(e.pointerId);
            const id = el.dataset.id;
            setSelected(id);
            const data = state.stickers.get(id);
            if (!data) return;

            const stageRect = els.stage.getBoundingClientRect();
            start = {
              pid: e.pointerId,
              x: e.clientX,
              y: e.clientY,
              ox: data.x,
              oy: data.y,
              stageRect,
              t: performance.now(),
            };
            moved = false;
            data.z = ++state.z;
            applyTransform(data);
            state.dragging = { id };
          });

          el.addEventListener("pointermove", (e) => {
            if (!start || e.pointerId !== start.pid) return;
            const id = el.dataset.id;
            const data = state.stickers.get(id);
            if (!data) return;
            const dx = e.clientX - start.x;
            const dy = e.clientY - start.y;
            if (Math.hypot(dx, dy) > 3) moved = true;
            const nx = start.ox + dx;
            const ny = start.oy + dy;
            const pad = 18;
            data.x = clamp(nx, pad, start.stageRect.width - pad);
            data.y = clamp(ny, pad, start.stageRect.height - pad);
            applyTransform(data);
            positionToolbox(data.el);
          });

          el.addEventListener("pointerup", (e) => {
            if (!start || e.pointerId !== start.pid) return;
            el.releasePointerCapture(e.pointerId);
            const id = el.dataset.id;
            const data = state.stickers.get(id);
            start = null;
            state.dragging = null;
            if (!data) return;

            if (!moved) {
              const now = performance.now();
	              if (now - lastTap < 320) {
	                deleteSticker(id);
	                toast("Sticker poof! ‚ú®");
	                sfx("poof");
	                fx?.burstAt(e.clientX, e.clientY, { kind: "poof" });
	                return;
	              }
              lastTap = now;
              data.el.classList.remove("wiggle");
	              void data.el.offsetWidth;
	              data.el.classList.add("wiggle");
	              sfx(data.type === "bell" ? "bell" : "tap");
	              fx?.burstAroundEl(data.el, { kind: "tap" });
	              return;
	            }
            data.el.classList.remove("pop");
	            void data.el.offsetWidth;
	            data.el.classList.add("pop");
	            sfx("drop");
	            fx?.burstAroundEl(data.el, { kind: "drop" });
	            if (navigator.vibrate) navigator.vibrate(10);
	          });

	          el.addEventListener("dblclick", (e) => {
	            e.preventDefault();
	            deleteSticker(el.dataset.id);
	            toast("Sticker removed.");
	            sfx("poof");
	            fx?.burstAt(e.clientX, e.clientY, { kind: "poof" });
	          });

          el.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              el.classList.remove("wiggle");
              void el.offsetWidth;
              el.classList.add("wiggle");
              sfx("tap");
            }
          });
        }

        function buildTray() {
          els.stickerGrid.innerHTML = "";
          for (const def of stickerDefs) {
            const btn = document.createElement("div");
            btn.className = "stickerTile";
            btn.style.setProperty("--accent", def.accent);
            btn.dataset.type = def.type;
            btn.innerHTML = `
              <div class="icon" aria-hidden="true"><span>${def.emoji}</span></div>
              <div class="label">${def.label}</div>
            `;
            wireTrayTile(btn);
            els.stickerGrid.appendChild(btn);
          }
        }

        function wireTrayTile(tile) {
          let start = null;
          tile.addEventListener("pointerdown", (e) => {
            armSoundOnce();
            e.preventDefault();
            tile.setPointerCapture(e.pointerId);
            const stageRect = els.stage.getBoundingClientRect();
            start = { pid: e.pointerId, x: e.clientX, y: e.clientY, stageRect, moved: false };
          });
          tile.addEventListener("pointermove", (e) => {
            if (!start || e.pointerId !== start.pid) return;
            const dx = e.clientX - start.x;
            const dy = e.clientY - start.y;
            if (Math.hypot(dx, dy) > 7) start.moved = true;
          });
          tile.addEventListener("pointerup", (e) => {
            if (!start || e.pointerId !== start.pid) return;
            tile.releasePointerCapture(e.pointerId);
            const type = tile.dataset.type;
            const stageRect = start.stageRect;
            const sx = e.clientX - stageRect.left;
            const sy = e.clientY - stageRect.top;
            const inside = sx >= 0 && sy >= 0 && sx <= stageRect.width && sy <= stageRect.height;
            if (start.moved && inside) {
              const data = createSticker(type, clamp(sx, 18, stageRect.width - 18), clamp(sy, 18, stageRect.height - 18), {
                scale: rand(0.92, 1.12),
              });
              setSelected(data.id);
              data.el.classList.add("pop");
              sfx("drop");
            } else {
              tossSticker(type);
            }
            start = null;
          });
        }

        function tossSticker(type) {
          const stageRect = els.stage.getBoundingClientRect();
          const x = rand(stageRect.width * 0.18, stageRect.width * 0.82);
          const y = rand(stageRect.height * 0.25, stageRect.height * 0.8);
          const data = createSticker(type, x, y, { scale: rand(0.9, 1.2), rot: rand(-18, 18) });
          setSelected(data.id);
          data.el.classList.add("pop");
          toast("Sticker tossed! üéØ");
          sfx("drop");
        }

        function seedDefaults() {
          clearStickers();
          const r = els.stage.getBoundingClientRect();
          const w = r.width;
          const h = r.height;
          createSticker("tree", w * 0.22, h * 0.72, { scale: 1.15, rot: -6 });
          createSticker("snowman", w * 0.82, h * 0.74, { scale: 1.1, rot: 8 });
          createSticker("gift", w * 0.66, h * 0.78, { scale: 1.05, rot: -12 });
          createSticker("star", w * 0.78, h * 0.22, { scale: 1.05, rot: 12 });
          createSticker("sparkle", w * 0.26, h * 0.24, { scale: 1.0, rot: -10 });
          setSelected(null);
          scheduleSave();
        }

        function normalizeName(s) {
          const v = (s || "").trim();
          return v.length ? v.slice(0, 26) : "";
        }

        function syncNames() {
          const to = normalizeName(els.toName.value) || "Friend";
          const from = normalizeName(els.fromName.value) || "Me";
          els.toInline.textContent = to;
          els.fromInline.textContent = from;
        }

        class SoundEngine {
          constructor() {
            this.ctx = null;
            this.master = null;
            this.enabled = true;
            this._noise = null;
          }
          arm() {
            if (this.ctx) return;
            const Ctx = window.AudioContext || window.webkitAudioContext;
            if (!Ctx) return;
            this.ctx = new Ctx();
            this.master = this.ctx.createGain();
            this.master.gain.value = 0.55;
            this.master.connect(this.ctx.destination);
          }
          async resume() {
            if (!this.ctx) return;
            if (this.ctx.state !== "running") {
              try {
                await this.ctx.resume();
              } catch {
                // ignore
              }
            }
          }
          setEnabled(v) {
            this.enabled = !!v;
            if (this.master && this.ctx) {
              const now = this.ctx.currentTime;
              const target = this.enabled ? 0.55 : 0.0001;
              this.master.gain.setTargetAtTime(target, now, 0.02);
            }
          }
          _env(gain, t, a = 0.008, d = 0.14, s = 0.0001) {
            gain.cancelScheduledValues(t);
            gain.setValueAtTime(0.0001, t);
            gain.exponentialRampToValueAtTime(1.0, t + a);
            gain.exponentialRampToValueAtTime(s, t + a + d);
          }
          _tone(freq, type, dur = 0.18, detune = 0, vol = 0.7) {
            if (!this.ctx || !this.master || !this.enabled) return;
            const t = this.ctx.currentTime;
            const o = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            o.type = type;
            o.frequency.setValueAtTime(freq, t);
            o.detune.setValueAtTime(detune, t);
            g.gain.setValueAtTime(0.0001, t);
            this._env(g.gain, t, 0.006, dur, 0.0001);
            const pre = this.ctx.createGain();
            pre.gain.value = vol;
            o.connect(g);
            g.connect(pre);
            pre.connect(this.master);
            o.start(t);
            o.stop(t + dur + 0.03);
          }
          _toneAt(freq, type, tStart, dur = 0.18, detune = 0, vol = 0.7) {
            if (!this.ctx || !this.master || !this.enabled) return;
            const o = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            o.type = type;
            o.frequency.setValueAtTime(freq, tStart);
            o.detune.setValueAtTime(detune, tStart);
            g.gain.setValueAtTime(0.0001, tStart);
            this._env(g.gain, tStart, 0.006, dur, 0.0001);
            const pre = this.ctx.createGain();
            pre.gain.value = vol;
            o.connect(g);
            g.connect(pre);
            pre.connect(this.master);
            o.start(tStart);
            o.stop(tStart + dur + 0.03);
          }
          _chord(freqs, type = "triangle", dur = 0.22) {
            if (!this.ctx || !this.master || !this.enabled) return;
            const t = this.ctx.currentTime;
            for (let i = 0; i < freqs.length; i++) {
              const f = freqs[i];
              const o = this.ctx.createOscillator();
              const g = this.ctx.createGain();
              o.type = type;
              o.frequency.setValueAtTime(f, t);
              g.gain.setValueAtTime(0.0001, t);
              this._env(g.gain, t + i * 0.01, 0.01, dur + i * 0.02, 0.0001);
              o.connect(g);
              g.connect(this.master);
              o.start(t + i * 0.01);
              o.stop(t + dur + 0.05 + i * 0.01);
            }
          }
          _noiseNode() {
            if (!this.ctx) return null;
            if (this._noise) return this._noise;
            const len = (this.ctx.sampleRate * 0.5) | 0;
            const buf = this.ctx.createBuffer(1, len, this.ctx.sampleRate);
            const ch = buf.getChannelData(0);
            for (let i = 0; i < len; i++) ch[i] = (Math.random() * 2 - 1) * 0.8;
            this._noise = buf;
            return buf;
          }
          pop() {
            this._tone(rand(420, 680), "sine", 0.12, rand(-20, 20), 0.6);
          }
          tap() {
            this._tone(rand(520, 860), "triangle", 0.08, rand(-15, 15), 0.45);
          }
          bell() {
            this._chord([988, 1175, 1568], "sine", 0.32);
          }
          poof() {
            this._tone(rand(220, 340), "sine", 0.16, rand(-10, 10), 0.35);
            this._tone(rand(780, 980), "triangle", 0.08, rand(-10, 10), 0.25);
          }
          sparkle() {
            this._tone(1568, "sine", 0.08, rand(-20, 20), 0.25);
            this._tone(1976, "triangle", 0.09, rand(-15, 15), 0.22);
          }
          party() {
            this._chord([523.25, 659.25, 783.99], "triangle", 0.25);
            this._tone(1046.5, "sine", 0.1, rand(-20, 20), 0.18);
          }
          jingle() {
            if (!this.ctx || !this.enabled) return;
            const t0 = this.ctx.currentTime + 0.05;
            const beat = 0.22;
            const E = 659.25;
            const G = 783.99;
            const C = 523.25;
            const D = 587.33;
            const F = 698.46;
            const melody = [
              [E, 0],
              [E, 1],
              [E, 2],
              [E, 4],
              [E, 5],
              [E, 6],
              [E, 8],
              [G, 9],
              [C, 10],
              [D, 11],
              [E, 12],
              [F, 14],
              [F, 15],
              [F, 16],
              [F, 17],
              [F, 18],
              [E, 20],
              [E, 21],
              [E, 22],
              [E, 23],
              [D, 24],
              [D, 25],
              [E, 26],
              [D, 27],
              [G, 28],
            ];
            for (const [f, i] of melody) this._toneAt(f, "triangle", t0 + i * beat, beat * 0.9, rand(-10, 10), 0.24);
            // soft ‚Äúbell‚Äù sparkle on top
            for (let i = 0; i < 10; i++) this._toneAt(1568 + i * 10, "sine", t0 + (i * 3) * beat, 0.08, 0, 0.07);
          }
          whoosh() {
            if (!this.ctx || !this.master || !this.enabled) return;
            const t = this.ctx.currentTime;
            const src = this.ctx.createBufferSource();
            const buf = this._noiseNode();
            if (!buf) return;
            src.buffer = buf;
            const filter = this.ctx.createBiquadFilter();
            filter.type = "lowpass";
            filter.frequency.setValueAtTime(1200, t);
            filter.frequency.exponentialRampToValueAtTime(280, t + 0.45);
            const g = this.ctx.createGain();
            g.gain.setValueAtTime(0.0001, t);
            this._env(g.gain, t, 0.01, 0.45, 0.0001);
            src.connect(filter);
            filter.connect(g);
            g.connect(this.master);
            src.start(t);
            src.stop(t + 0.55);
          }
        }

        const sound = new SoundEngine();
        let fx = null;

        function armSoundOnce() {
          if (state.soundArmed) return;
          state.soundArmed = true;
          sound.arm();
          sound.setEnabled(state.soundEnabled);
          sound.resume();
        }
        function sfx(kind) {
          if (!state.soundEnabled || !state.soundArmed) return;
          if (kind === "drop") return sound.pop();
          if (kind === "tap") return sound.tap();
          if (kind === "bell") return sound.bell();
          if (kind === "poof") return sound.poof();
          if (kind === "sprinkle") return sound.sparkle();
          if (kind === "party") return sound.party();
          if (kind === "whoosh") return sound.whoosh();
          if (kind === "twinkle") return sound.sparkle();
          return sound.tap();
        }

        function shuffleLayout() {
          if (!state.stickers.size) return;
          const r = els.stage.getBoundingClientRect();
          for (const data of state.stickers.values()) {
            data.x = rand(r.width * 0.15, r.width * 0.85);
            data.y = rand(r.height * 0.18, r.height * 0.85);
            data.rot = rand(-18, 18);
            data.scale = rand(0.85, 1.25);
            data.z = ++state.z;
            applyTransform(data);
          }
          setSelected(state.selectedId);
          toast("Surprise layout! üé≤");
          scheduleSave();
        }

        async function downloadPng() {
          armSoundOnce();
          const prevSel = state.selectedId;
          setSelected(null);
          els.toolbox.classList.add("hidden");
          toast("Making your PNG‚Ä¶");
          sfx("sprinkle");
          try {
            const h2c = window.html2canvas;
            if (typeof h2c !== "function") {
              toast("Download needs the renderer (html2canvas).");
              return;
            }
            const canvas = await h2c(els.stage, { backgroundColor: null, scale: 2 });
            const a = document.createElement("a");
            a.download = `holiday-card-${Date.now()}.png`;
            a.href = canvas.toDataURL("image/png");
            document.body.appendChild(a);
            a.click();
            a.remove();
            toast("Saved! üéÅ");
            const r = els.stage.getBoundingClientRect();
            fx?.confettiAt(r.left + r.width * 0.52, r.top + r.height * 0.35);
          } catch {
            toast("Couldn‚Äôt download. Try again!");
          } finally {
            if (prevSel && state.stickers.has(prevSel)) setSelected(prevSel);
          }
        }

        function sprinkle() {
          toast("Sparkles incoming‚Ä¶ ‚ú®");
          sfx("sprinkle");
          const r = els.stage.getBoundingClientRect();
          fx?.burstAt(r.left + r.width * 0.5, r.top + r.height * 0.38, { kind: "sprinkle", count: 90 });
        }

        function party() {
          const types = stickerDefs.map((d) => d.type);
          const r = els.stage.getBoundingClientRect();
          for (let i = 0; i < 12; i++) {
            createSticker(pick(types), rand(30, r.width - 30), rand(30, r.height - 30), {
              scale: rand(0.8, 1.25),
              rot: rand(-20, 20),
            }).el.classList.add("pop");
          }
          toast("Sticker Party!!! üéâ");
          sfx("party");
          fx?.confettiAt(r.left + r.width * 0.55, r.top + r.height * 0.35);
        }

        function shake() {
          toast("Brrrr‚Ä¶ snow shake! ‚ùÑÔ∏è");
          sfx("whoosh");
          fx?.gust();
        }

        function twinkle() {
          toast("Twinkle twinkle! üåü");
          sfx("twinkle");
          document.body.classList.add("twinkleFlash");
          window.clearTimeout(twinkle._t);
          twinkle._t = window.setTimeout(() => document.body.classList.remove("twinkleFlash"), 980);
          const r = els.stage.getBoundingClientRect();
          fx?.burstAt(r.left + r.width * 0.35, r.top + r.height * 0.22, { kind: "twinkle", count: 45 });
        }

        function toolAct(act) {
          const id = state.selectedId;
          const data = id ? state.stickers.get(id) : null;
          if (!data) return;
          if (act === "bigger") data.scale = clamp(data.scale + 0.08, 0.5, 2.2);
          if (act === "smaller") data.scale = clamp(data.scale - 0.08, 0.5, 2.2);
          if (act === "rotL") data.rot -= 10;
          if (act === "rotR") data.rot += 10;
          if (act === "flip") data.flip = !data.flip;
          if (act === "front") data.z = ++state.z;
          if (act === "back") data.z = 1;
          if (act === "delete") {
            deleteSticker(id);
            toast("Poof! ‚ú®");
            sfx("poof");
            return;
          }
          applyTransform(data);
          positionToolbox(data.el);
          sfx("tap");
          scheduleSave();
        }

        function onKey(e) {
          if (e.key === "Escape") setSelected(null);
          if (e.key === "Backspace" || e.key === "Delete") {
            if (state.selectedId) {
              deleteSticker(state.selectedId);
              toast("Deleted.");
              sfx("poof");
            }
          }
          const data = state.selectedId ? state.stickers.get(state.selectedId) : null;
          if (!data) return;
          const step = e.shiftKey ? 18 : 8;
          if (e.key === "ArrowLeft") data.x -= step;
          if (e.key === "ArrowRight") data.x += step;
          if (e.key === "ArrowUp") data.y -= step;
          if (e.key === "ArrowDown") data.y += step;
          if (e.key.startsWith("Arrow")) {
            const r = els.stage.getBoundingClientRect();
            data.x = clamp(data.x, 18, r.width - 18);
            data.y = clamp(data.y, 18, r.height - 18);
            applyTransform(data);
            positionToolbox(data.el);
          }
        }

        function onResize() {
          resizeDraw(true);
          // Re-seed defaults once we have stage measurements.
          if (!state.stickers.size && !state.loaded) seedDefaults();
          if (state.selectedId && state.stickers.has(state.selectedId)) positionToolbox(state.stickers.get(state.selectedId).el);
        }

        function wireUI() {
          els.stage.addEventListener("pointerdown", () => setSelected(null));
          els.toolbox.addEventListener("pointerdown", (e) => e.stopPropagation());
          els.toolbox.addEventListener("click", (e) => {
            const btn = e.target.closest("[data-act]");
            if (!btn) return;
            toolAct(btn.dataset.act);
          });

          els.toName.addEventListener("input", () => {
            syncNames();
            scheduleSave();
          });
          els.fromName.addEventListener("input", () => {
            syncNames();
            scheduleSave();
          });
          els.msgBody.addEventListener("input", scheduleSave);
          els.bgSelect.addEventListener("change", () => {
            els.stage.classList.remove("bg-snowy", "bg-candy", "bg-night");
            els.stage.classList.add(els.bgSelect.value);
            toast("New background! üé®");
            sfx("tap");
            scheduleSave();
          });
          els.penBtn.addEventListener("click", () => setPenMode(!state.penMode));
          els.penColor.addEventListener("input", () => {
            state.penColor = els.penColor.value;
            toast("New pen color! üé®");
            sfx("tap");
            scheduleSave();
          });

          els.helpBtn.addEventListener("click", () => els.helpDialog.showModal());
          els.closeHelpBtn.addEventListener("click", () => els.helpDialog.close());
          els.helpDialog.addEventListener("click", (e) => {
            const r = els.helpDialog.getBoundingClientRect();
            const inside = e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom;
            if (!inside) els.helpDialog.close();
          });

          els.resetBtn.addEventListener("click", () => {
            seedDefaults();
            toast("Back to the cozy starter card!");
            sfx("tap");
          });
          els.clearBtn.addEventListener("click", () => {
            clearStickers();
            toast("All clear. Add new stickers!");
            sfx("poof");
          });
          els.partyBtn.addEventListener("click", party);
          els.shakeBtn.addEventListener("click", shake);
          els.twinkleBtn.addEventListener("click", twinkle);
          els.lightsBtn.addEventListener("click", () => {
            document.body.classList.toggle("lightsOff");
            toast(document.body.classList.contains("lightsOff") ? "Lights dimmed üåô" : "Lights on! üí°");
            sfx("tap");
            scheduleSave();
          });
          els.eraseBtn.addEventListener("click", () => {
            clearDoodles();
            toast("Doodles erased! üßº");
            sfx("poof");
            const r = els.stage.getBoundingClientRect();
            fx?.burstAt(r.left + r.width * 0.5, r.top + r.height * 0.45, { kind: "poof", count: 40 });
          });
          els.sprinkleBtn.addEventListener("click", sprinkle);
          els.shuffleBtn.addEventListener("click", shuffleLayout);
          els.jingleBtn.addEventListener("click", () => {
            armSoundOnce();
            toast("Jingle time! üé∂");
            sound.jingle();
            const r = els.stage.getBoundingClientRect();
            fx?.burstAt(r.left + r.width * 0.55, r.top + r.height * 0.3, { kind: "sprinkle", count: 80 });
          });
          els.downloadBtn.addEventListener("click", downloadPng);

          els.soundBtn.addEventListener("click", () => {
            state.soundEnabled = !state.soundEnabled;
            els.soundBtn.textContent = `Sound: ${state.soundEnabled ? "On" : "Off"}`;
            els.soundBtn.setAttribute("aria-pressed", state.soundEnabled ? "true" : "false");
            toast(state.soundEnabled ? "Sounds on! üîä" : "Sounds off. ü§´");
            sound.setEnabled(state.soundEnabled);
          });

          const canvasPoint = (e) => {
            const r = els.drawCanvas.getBoundingClientRect();
            return { x: e.clientX - r.left, y: e.clientY - r.top };
          };
          els.drawCanvas.addEventListener("contextmenu", (e) => e.preventDefault());
          els.drawCanvas.addEventListener("pointerdown", (e) => {
            if (!state.penMode) return;
            armSoundOnce();
            e.preventDefault();
            e.stopPropagation();
            els.drawCanvas.setPointerCapture(e.pointerId);
            const p = canvasPoint(e);
            draw.down = true;
            draw.lastX = p.x;
            draw.lastY = p.y;
            drawLine(p.x, p.y, p.x + 0.01, p.y + 0.01, e.pressure || 0.5);
            fx?.burstAt(e.clientX, e.clientY, { kind: "tap", count: 6 });
          });
          els.drawCanvas.addEventListener("pointermove", (e) => {
            if (!state.penMode || !draw.down) return;
            e.preventDefault();
            e.stopPropagation();
            const p = canvasPoint(e);
            drawLine(draw.lastX, draw.lastY, p.x, p.y, e.pressure || 0.5);
            draw.lastX = p.x;
            draw.lastY = p.y;
            if (Math.random() < 0.08) fx?.burstAt(e.clientX, e.clientY, { kind: "tap", count: 2 });
          });
          const drawUp = (e) => {
            if (!state.penMode) return;
            draw.down = false;
            if (e && typeof e.clientX === "number") fx?.burstAt(e.clientX, e.clientY, { kind: "sprinkle", count: 14 });
          };
          els.drawCanvas.addEventListener("pointerup", drawUp);
          els.drawCanvas.addEventListener("pointercancel", drawUp);

          window.addEventListener("keydown", onKey);
          window.addEventListener("resize", () => window.requestAnimationFrame(onResize));
        }

        function bootFx() {
          const snowCanvas = document.getElementById("snow");
          const fxCanvas = document.getElementById("fx");
          const snowCtx = snowCanvas.getContext("2d");
          const fxCtx = fxCanvas.getContext("2d");
          const flakes = [];
          const sparks = [];
          const confetti = [];
          let wind = 0.0;
          let windT = 0;
          let last = performance.now();

          function fit() {
            const dpr = Math.max(1, Math.min(2.25, window.devicePixelRatio || 1));
            const w = Math.floor(window.innerWidth * dpr);
            const h = Math.floor(window.innerHeight * dpr);
            for (const [c, ctx] of [
              [snowCanvas, snowCtx],
              [fxCanvas, fxCtx],
            ]) {
              if (c.width !== w || c.height !== h) {
                c.width = w;
                c.height = h;
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
              }
            }
          }

          function makeFlake() {
            const size = rand(0.9, 3.8);
            const wob = rand(-0.6, 0.6);
            return {
              x: rand(0, window.innerWidth),
              y: rand(-40, window.innerHeight + 40),
              r: size,
              vx: wob,
              vy: rand(0.6, 1.65) + size * 0.12,
              a: rand(0.22, 0.75),
              t: rand(0, 1000),
            };
          }

          function seedSnow() {
            flakes.length = 0;
            const count = Math.floor(clamp(window.innerWidth / 10, 80, 170));
            for (let i = 0; i < count; i++) flakes.push(makeFlake());
          }

          function drawSnow(dt) {
            snowCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
            snowCtx.save();
            for (const f of flakes) {
              f.t += dt * 0.001;
              f.x += (f.vx + wind) * (1 + f.r * 0.08);
              f.y += f.vy * (1 + f.r * 0.06);
              const sway = Math.sin(f.t * 1.3) * 0.7;
              f.x += sway * 0.35;
              if (f.y > window.innerHeight + 30) {
                f.y = rand(-60, -10);
                f.x = rand(0, window.innerWidth);
              }
              if (f.x < -40) f.x = window.innerWidth + 40;
              if (f.x > window.innerWidth + 40) f.x = -40;

              snowCtx.globalAlpha = f.a;
              const g = snowCtx.createRadialGradient(f.x - f.r * 0.4, f.y - f.r * 0.4, 0, f.x, f.y, f.r * 2.2);
              g.addColorStop(0, "rgba(255,255,255,0.95)");
              g.addColorStop(1, "rgba(255,255,255,0)");
              snowCtx.fillStyle = g;
              snowCtx.beginPath();
              snowCtx.arc(f.x, f.y, f.r * 2.2, 0, Math.PI * 2);
              snowCtx.fill();

              if (f.r > 2.7 && Math.random() < 0.018) {
                snowCtx.globalAlpha = f.a * 0.55;
                snowCtx.strokeStyle = "rgba(200,245,255,0.75)";
                snowCtx.lineWidth = 1;
                snowCtx.beginPath();
                snowCtx.moveTo(f.x - f.r * 1.6, f.y);
                snowCtx.lineTo(f.x + f.r * 1.6, f.y);
                snowCtx.moveTo(f.x, f.y - f.r * 1.6);
                snowCtx.lineTo(f.x, f.y + f.r * 1.6);
                snowCtx.stroke();
              }
            }
            snowCtx.restore();
          }

          function stepParticles(list, dt, draw) {
            for (let i = list.length - 1; i >= 0; i--) {
              const p = list[i];
              p.age += dt;
              if (p.age >= p.life) {
                list.splice(i, 1);
                continue;
              }
              p.vx *= Math.pow(0.998, dt);
              p.vy *= Math.pow(0.998, dt);
              p.vy += p.g * (dt / 16.67);
              p.x += p.vx * (dt / 16.67);
              p.y += p.vy * (dt / 16.67);
              p.rot += p.spin * (dt / 16.67);
              draw(p);
            }
          }

          function drawFx(dt) {
            fxCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
            fxCtx.save();
            fxCtx.globalCompositeOperation = "lighter";

            stepParticles(sparks, dt, (p) => {
              const t = p.age / p.life;
              const a = (1 - t) * p.a;
              fxCtx.globalAlpha = a;
              fxCtx.translate(p.x, p.y);
              fxCtx.rotate(p.rot);
              fxCtx.fillStyle = p.color;
              const s = lerp(p.size, 0.1, t);
              fxCtx.beginPath();
              fxCtx.moveTo(-s, 0);
              fxCtx.lineTo(0, -s * 0.85);
              fxCtx.lineTo(s, 0);
              fxCtx.lineTo(0, s * 0.85);
              fxCtx.closePath();
              fxCtx.fill();
              fxCtx.setTransform(1, 0, 0, 1, 0, 0);
            });

            fxCtx.globalCompositeOperation = "source-over";
            stepParticles(confetti, dt, (p) => {
              const t = p.age / p.life;
              const a = (1 - t) * p.a;
              fxCtx.globalAlpha = a;
              fxCtx.translate(p.x, p.y);
              fxCtx.rotate(p.rot);
              fxCtx.fillStyle = p.color;
              const w = p.w * (1 - t * 0.1);
              const h = p.h * (1 - t * 0.1);
              fxCtx.fillRect(-w / 2, -h / 2, w, h);
              fxCtx.setTransform(1, 0, 0, 1, 0, 0);
            });

            fxCtx.restore();
          }

          function tick(now) {
            const dt = clamp(now - last, 0, 40);
            last = now;
            windT += dt;
            wind *= Math.pow(0.992, dt);
            if (windT > 2200) {
              windT = 0;
              wind += rand(-0.18, 0.18);
            }

            drawSnow(dt);
            drawFx(dt);
            requestAnimationFrame(tick);
          }

          function burstAt(x, y, opts = {}) {
            const kind = opts.kind || "sprinkle";
            const count =
              opts.count ??
              (kind === "drop" ? 18 : kind === "tap" ? 10 : kind === "poof" ? 34 : kind === "twinkle" ? 28 : 70);
            const palette = {
              drop: ["#ffffff", "#bff4ff", "#ffd9f0", "#c7ffea"],
              tap: ["#ffffff", "#bff4ff"],
              sprinkle: ["#ffffff", "#ffe8a8", "#ffd9f0", "#c7ffea", "#cfe0ff"],
              twinkle: ["#ffffff", "#ffe8a8", "#bff4ff"],
              poof: ["#ffffff", "#cfe0ff", "#ffd9f0"],
            }[kind] || ["#ffffff"];
            for (let i = 0; i < count; i++) {
              const ang = rand(0, Math.PI * 2);
              const sp = rand(kind === "drop" ? 0.9 : 1.2, kind === "poof" ? 5.0 : 3.2);
              sparks.push({
                x: x + rand(-2, 2),
                y: y + rand(-2, 2),
                vx: Math.cos(ang) * sp + rand(-0.2, 0.2),
                vy: Math.sin(ang) * sp + rand(-0.2, 0.2),
                g: kind === "twinkle" ? -0.015 : 0.02,
                a: rand(0.55, 0.95),
                life: rand(380, 920),
                age: 0,
                size: rand(2.2, kind === "sprinkle" ? 6.0 : 4.8),
                color: pick(palette),
                rot: rand(0, Math.PI * 2),
                spin: rand(-0.09, 0.09),
              });
            }
          }

          function burstAroundEl(el, opts = {}) {
            const r = el.getBoundingClientRect();
            burstAt(r.left + r.width / 2, r.top + r.height / 2, opts);
          }

          function confettiAt(x, y) {
            const colors = ["#ffd16a", "#ff5f87", "#6ee7ff", "#5ef1b7", "#cfe0ff", "#ffffff"];
            for (let i = 0; i < 70; i++) {
              confetti.push({
                x: x + rand(-20, 20),
                y: y + rand(-16, 16),
                vx: rand(-2.8, 2.8),
                vy: rand(-5.8, -1.8),
                g: 0.15,
                a: rand(0.55, 0.95),
                life: rand(900, 1500),
                age: 0,
                w: rand(4, 10),
                h: rand(6, 14),
                color: pick(colors),
                rot: rand(0, Math.PI * 2),
                spin: rand(-0.18, 0.18),
              });
            }
          }

          function gust() {
            wind += rand(-0.65, 0.65);
            for (let i = 0; i < 24; i++) flakes.push(makeFlake());
            while (flakes.length > 210) flakes.shift();
          }

          fit();
          seedSnow();
          requestAnimationFrame(tick);
          window.addEventListener("resize", () => {
            fit();
            seedSnow();
          });

          fx = { burstAt, burstAroundEl, confettiAt, gust };
        }

        function init() {
          window.addEventListener("pointerdown", armSoundOnce, { once: true, passive: true });
          buildTray();
          wireUI();
          bootFx();
          buildLightsString();
          state.penColor = els.penColor.value || state.penColor;
          syncNames();
          resizeDraw(false);
          const restored = tryRestoreFromStorage();
          onResize();
          if (restored) toast("Welcome back! ‚ùÑÔ∏è");
          setTimeout(() => {
            if (!state.soundArmed) els.helpDialog.showModal();
          }, 450);
        }

        init();
      })();
    </script>
  </body>
</html>
