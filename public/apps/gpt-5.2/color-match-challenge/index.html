<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0b1020" />
    <title>Color Match Challenge</title>
    <style>
      :root {
        --bg0: #070a12;
        --bg1: #0b1020;
        --panel: rgba(255, 255, 255, 0.07);
        --panel2: rgba(255, 255, 255, 0.11);
        --stroke: rgba(255, 255, 255, 0.14);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.66);
        --muted2: rgba(255, 255, 255, 0.5);
        --shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
        --shadow2: 0 10px 30px rgba(0, 0, 0, 0.3);
        --radius-xl: 28px;
        --radius-lg: 20px;
        --radius-md: 16px;
        --radius-sm: 14px;
        --ring: rgba(255, 255, 255, 0.22);
        --ok: #3ddc84;
        --bad: #ff4d4d;
        --warn: #ffd54a;
        --ease-out: cubic-bezier(0.2, 0.85, 0.2, 1);
        --ease-pop: cubic-bezier(0.2, 1.3, 0.2, 1);
        --p: 1;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        color: var(--text);
        background:
          radial-gradient(1200px 800px at 20% 10%, rgba(126, 87, 255, 0.22), transparent 50%),
          radial-gradient(1000px 900px at 80% 0%, rgba(61, 220, 132, 0.16), transparent 55%),
          radial-gradient(1000px 1000px at 60% 100%, rgba(255, 213, 74, 0.14), transparent 60%),
          linear-gradient(180deg, var(--bg1), var(--bg0));
        overflow-x: hidden;
      }

      a {
        color: inherit;
      }

      .wrap {
        min-height: 100%;
        display: grid;
        place-items: center;
        padding: clamp(14px, 3vw, 28px);
      }

      .shell {
        width: min(980px, 100%);
        display: grid;
        gap: clamp(12px, 2vw, 18px);
      }

      .topbar {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        align-items: center;
      }

      .title {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: baseline;
      }

      .title h1 {
        margin: 0;
        font-weight: 860;
        letter-spacing: -0.04em;
        font-size: clamp(22px, 2.2vw, 28px);
      }

      .badge {
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.8);
        padding: 6px 10px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        border-radius: 999px;
      }

      .panel {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.09), rgba(255, 255, 255, 0.05));
        border: 1px solid var(--stroke);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow);
        overflow: hidden;
        position: relative;
      }

      .panel::before {
        content: "";
        position: absolute;
        inset: -2px;
        background:
          radial-gradient(600px 160px at 20% 0%, rgba(255, 255, 255, 0.12), transparent 50%),
          radial-gradient(540px 220px at 80% 0%, rgba(255, 255, 255, 0.09), transparent 55%);
        pointer-events: none;
        opacity: 0.9;
        filter: blur(0px);
      }

      .panelInner {
        position: relative;
        z-index: 1;
        padding: clamp(16px, 3.2vw, 26px);
        display: grid;
        gap: clamp(14px, 2.5vw, 20px);
      }

      .statsRow {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: clamp(10px, 2vw, 14px);
        align-items: stretch;
      }

      .stat {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.18);
        box-shadow: var(--shadow2);
        padding: 14px 14px 12px;
        display: grid;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }

      .stat small {
        color: var(--muted2);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 11px;
      }

      .stat .val {
        font-variant-numeric: tabular-nums;
        font-size: clamp(22px, 3vw, 34px);
        font-weight: 820;
        letter-spacing: -0.03em;
        line-height: 1;
      }

      .timerStat {
        padding-right: 86px;
      }

      .ring {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 56px;
        height: 56px;
        border-radius: 999px;
        background:
          conic-gradient(from -90deg, rgba(255, 255, 255, 0.92) calc(var(--p) * 1turn), rgba(255, 255, 255, 0.12) 0);
        display: grid;
        place-items: center;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.18);
      }

      .ring::after {
        content: "";
        width: 44px;
        height: 44px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.26);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.12);
      }

      .promptCard {
        border-radius: var(--radius-xl);
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.28), rgba(0, 0, 0, 0.18));
        box-shadow: var(--shadow2);
        padding: clamp(18px, 3vw, 26px);
        display: grid;
        gap: 10px;
        align-items: center;
        min-height: 190px;
        position: relative;
        overflow: hidden;
      }

      .promptCard::before {
        content: "";
        position: absolute;
        inset: -40px;
        background:
          radial-gradient(220px 120px at 10% 15%, rgba(255, 255, 255, 0.08), transparent 55%),
          radial-gradient(260px 140px at 90% 0%, rgba(255, 255, 255, 0.07), transparent 60%),
          radial-gradient(380px 180px at 70% 110%, rgba(255, 255, 255, 0.06), transparent 60%);
        pointer-events: none;
        filter: blur(0px);
      }

      .promptCardInner {
        position: relative;
        z-index: 1;
        display: grid;
        gap: 8px;
        text-align: center;
      }

      .hint {
        margin: 0;
        color: var(--muted);
        font-size: clamp(14px, 1.6vw, 16px);
        letter-spacing: 0.01em;
      }

      .word {
        margin: 0;
        font-weight: 900;
        letter-spacing: -0.06em;
        font-size: clamp(56px, 10vw, 110px);
        line-height: 0.95;
        text-shadow: 0 18px 60px rgba(0, 0, 0, 0.55);
        will-change: transform, filter;
        user-select: none;
      }

      .subhint {
        margin: 0;
        font-size: 13px;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.62);
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: clamp(10px, 2vw, 14px);
      }

      .btn {
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(255, 255, 255, 0.06);
        border-radius: var(--radius-lg);
        padding: 14px 14px;
        cursor: pointer;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        display: grid;
        align-items: center;
        justify-items: start;
        gap: 10px;
        min-height: 74px;
        box-shadow: var(--shadow2);
        transition:
          transform 130ms var(--ease-out),
          filter 130ms var(--ease-out),
          background 160ms var(--ease-out),
          border-color 160ms var(--ease-out);
        overflow: hidden;
      }

      .btn:focus-visible {
        outline: none;
        box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.16), var(--shadow2);
      }

      .btn:hover {
        filter: brightness(1.05);
      }

      .btn:active,
      .btn.pressed {
        transform: translateY(2px) scale(0.985);
        filter: brightness(0.98);
      }

      .btn[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
        filter: grayscale(0.1);
      }

      .btnTop {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
      }

      .swatch {
        width: 18px;
        height: 18px;
        border-radius: 6px;
        background: var(--c);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.18);
        flex: 0 0 auto;
      }

      .btnLabel {
        font-weight: 840;
        letter-spacing: -0.02em;
        font-size: 16px;
        line-height: 1.1;
      }

      .btnHint {
        margin-left: auto;
        font-size: 12px;
        letter-spacing: 0.06em;
        color: rgba(255, 255, 255, 0.72);
        border: 1px solid rgba(255, 255, 255, 0.16);
        padding: 6px 8px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.12);
      }

      .btnFill {
        position: absolute;
        inset: 0;
        background: radial-gradient(120px 90px at 15% 0%, rgba(255, 255, 255, 0.14), transparent 60%),
          linear-gradient(180deg, var(--c1), var(--c2));
        opacity: 0.84;
        pointer-events: none;
      }

      .btnFill::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.1), transparent 55%);
        opacity: 0.6;
      }

      .btnContent {
        position: relative;
        z-index: 1;
        width: 100%;
      }

      .ripple {
        position: absolute;
        border-radius: 999px;
        transform: translate(-50%, -50%) scale(0);
        background: rgba(255, 255, 255, 0.28);
        pointer-events: none;
        animation: ripple 520ms var(--ease-out) forwards;
        mix-blend-mode: overlay;
      }

      @keyframes ripple {
        to {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0;
        }
      }

      .footerRow {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        color: var(--muted2);
        font-size: 13px;
      }

      .pillRow {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .pill {
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        border-radius: 999px;
        padding: 10px 12px;
        display: inline-flex;
        gap: 10px;
        align-items: center;
        box-shadow: var(--shadow2);
      }

      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        user-select: none;
      }

      .toggle input {
        appearance: none;
        -webkit-appearance: none;
        width: 42px;
        height: 24px;
        background: rgba(255, 255, 255, 0.14);
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 999px;
        position: relative;
        outline: none;
        transition: background 150ms var(--ease-out);
      }

      .toggle input::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 3px;
        width: 18px;
        height: 18px;
        transform: translateY(-50%);
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.86);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
        transition: transform 160ms var(--ease-pop);
      }

      .toggle input:checked {
        background: rgba(61, 220, 132, 0.35);
        border-color: rgba(61, 220, 132, 0.36);
      }

      .toggle input:checked::after {
        transform: translateY(-50%) translateX(18px);
      }

      .toggle span {
        color: rgba(255, 255, 255, 0.74);
        font-size: 13px;
        letter-spacing: 0.02em;
      }

      .overlay {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        padding: clamp(14px, 3vw, 28px);
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 50;
      }

      .modal {
        width: min(880px, 100%);
        border-radius: 30px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.06));
        box-shadow: var(--shadow);
        overflow: hidden;
        position: relative;
      }

      .modal::before {
        content: "";
        position: absolute;
        inset: -2px;
        background:
          radial-gradient(700px 280px at 15% 0%, rgba(255, 255, 255, 0.14), transparent 58%),
          radial-gradient(520px 260px at 85% 0%, rgba(255, 255, 255, 0.1), transparent 60%);
        pointer-events: none;
        opacity: 0.9;
      }

      .modalInner {
        position: relative;
        z-index: 1;
        padding: clamp(18px, 3.5vw, 28px);
        display: grid;
        gap: 14px;
      }

      .modal h2 {
        margin: 0;
        font-size: clamp(26px, 3vw, 36px);
        letter-spacing: -0.05em;
        font-weight: 900;
      }

      .modal p {
        margin: 0;
        color: rgba(255, 255, 255, 0.78);
        line-height: 1.5;
        font-size: 15px;
      }

      .ctaRow {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 8px;
      }

      .cta {
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.92);
        border-radius: 16px;
        padding: 14px 16px;
        font-weight: 860;
        letter-spacing: -0.02em;
        cursor: pointer;
        touch-action: manipulation;
        transition:
          transform 130ms var(--ease-out),
          background 160ms var(--ease-out),
          border-color 160ms var(--ease-out),
          filter 160ms var(--ease-out);
        box-shadow: var(--shadow2);
      }

      .cta:hover {
        filter: brightness(1.05);
      }

      .cta:active {
        transform: translateY(2px) scale(0.99);
      }

      .cta.primary {
        background: linear-gradient(180deg, rgba(61, 220, 132, 0.42), rgba(61, 220, 132, 0.22));
        border-color: rgba(61, 220, 132, 0.44);
      }

      .cta.ghost {
        background: rgba(0, 0, 0, 0.12);
      }

      .kpiGrid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 8px;
      }

      .kpi {
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.16);
        padding: 12px 14px;
        display: grid;
        gap: 6px;
      }

      .kpi small {
        color: rgba(255, 255, 255, 0.6);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 11px;
      }

      .kpi strong {
        font-size: 22px;
        letter-spacing: -0.03em;
        font-weight: 900;
        font-variant-numeric: tabular-nums;
      }

      .toast {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.46);
        border: 1px solid rgba(255, 255, 255, 0.14);
        color: rgba(255, 255, 255, 0.9);
        padding: 10px 12px;
        border-radius: 999px;
        box-shadow: var(--shadow2);
        font-size: 13px;
        letter-spacing: 0.02em;
        opacity: 0;
        pointer-events: none;
        transition:
          opacity 200ms var(--ease-out),
          transform 200ms var(--ease-out);
        z-index: 70;
      }

      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-6px);
      }

      .fxOk {
        animation: okPulse 320ms var(--ease-pop);
      }

      .fxBad {
        animation: badShake 360ms var(--ease-out);
      }

      @keyframes okPulse {
        0% {
          transform: scale(1);
          filter: saturate(1);
        }
        55% {
          transform: scale(1.02);
          filter: saturate(1.4);
        }
        100% {
          transform: scale(1);
          filter: saturate(1);
        }
      }

      @keyframes badShake {
        0% {
          transform: translateX(0);
        }
        20% {
          transform: translateX(-8px);
        }
        40% {
          transform: translateX(7px);
        }
        60% {
          transform: translateX(-5px);
        }
        80% {
          transform: translateX(4px);
        }
        100% {
          transform: translateX(0);
        }
      }

      .wordIn {
        animation: wordIn 210ms var(--ease-pop);
      }

      @keyframes wordIn {
        0% {
          transform: translateY(6px) scale(0.985);
          opacity: 0.75;
        }
        100% {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }

      .pulseUrgent {
        animation: urgent 800ms ease-in-out infinite;
      }

      @keyframes urgent {
        0%,
        100% {
          filter: brightness(1);
        }
        50% {
          filter: brightness(1.18);
        }
      }

      canvas#confetti {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 65;
      }

      @media (max-width: 820px) {
        .statsRow {
          grid-template-columns: 1fr 1fr;
        }
        .statsRow .stat:nth-child(3) {
          grid-column: 1 / -1;
        }
        .controls {
          grid-template-columns: repeat(2, 1fr);
        }
        .timerStat {
          padding-right: 72px;
        }
        .ring {
          width: 50px;
          height: 50px;
        }
        .ring::after {
          width: 39px;
          height: 39px;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 1ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 1ms !important;
          scroll-behavior: auto !important;
        }
      }
    </style>
  </head>
  <body>
    <canvas id="confetti" aria-hidden="true"></canvas>
    <div class="wrap">
      <div class="shell">
        <div class="topbar">
          <div class="title">
            <h1>Color Match Challenge</h1>
            <span class="badge">Tap the font color</span>
          </div>
          <div class="pillRow" role="group" aria-label="Settings">
            <label class="pill toggle" title="Sound effects">
              <input id="soundToggle" type="checkbox" checked />
              <span>Sound</span>
            </label>
            <label class="pill toggle" title="Haptic feedback (if supported)">
              <input id="hapticToggle" type="checkbox" checked />
              <span>Haptics</span>
            </label>
          </div>
        </div>

        <section class="panel" aria-label="Game">
          <div class="panelInner">
            <div class="statsRow" aria-label="Stats">
              <div class="stat">
                <small>Score</small>
                <div class="val" id="scoreVal" aria-live="polite">0</div>
              </div>

              <div class="stat timerStat">
                <small>Time</small>
                <div class="val" id="timeVal" aria-live="polite">30.0</div>
                <div class="ring" id="timeRing" aria-hidden="true"></div>
              </div>

              <div class="stat">
                <small>Streak</small>
                <div class="val" id="streakVal">0</div>
              </div>
            </div>

            <div class="promptCard" id="promptCard" aria-label="Prompt">
              <div class="promptCardInner">
                <p class="hint" id="hintText">Click the button that matches the <strong>font color</strong>.</p>
                <h2 class="word" id="wordText">READY</h2>
                <p class="subhint" id="subHint">Word meaning can be a trap.</p>
              </div>
            </div>

            <div class="controls" id="controls" aria-label="Color buttons"></div>

            <div class="footerRow">
              <div>
                Best: <strong id="bestVal">0</strong> · Accuracy: <strong id="accVal">—</strong>
              </div>
              <div>
                Keyboard: <strong>1–8</strong> · Start/Restart: <strong>Space</strong>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <div class="overlay" id="startOverlay" role="dialog" aria-modal="true" aria-labelledby="startTitle">
      <div class="modal">
        <div class="modalInner">
          <h2 id="startTitle">30 seconds. Pure focus.</h2>
          <p>
            You’ll see a color word (like “RED”), but it will be drawn in a random <em>font color</em>. Ignore the word’s
            meaning and tap the button that matches the font color.
          </p>
          <div class="kpiGrid" aria-label="Quick tips">
            <div class="kpi">
              <small>Rule</small>
              <strong>Match color</strong>
            </div>
            <div class="kpi">
              <small>Scoring</small>
              <strong>+1 correct</strong>
            </div>
            <div class="kpi">
              <small>Speed</small>
              <strong>Instant next</strong>
            </div>
          </div>
          <div class="ctaRow">
            <button class="cta primary" id="startBtn">Start</button>
            <button class="cta ghost" id="practiceBtn" title="Try a few rounds without the timer">Practice</button>
            <span style="color: rgba(255, 255, 255, 0.7); font-size: 13px"
              >Tip: press <strong>Space</strong> to start.</span
            >
          </div>
        </div>
      </div>
    </div>

    <div class="overlay" id="endOverlay" style="display: none" role="dialog" aria-modal="true" aria-labelledby="endTitle">
      <div class="modal">
        <div class="modalInner">
          <h2 id="endTitle">Time!</h2>
          <p id="endSummary">Nice run.</p>
          <div class="kpiGrid" aria-label="Results">
            <div class="kpi">
              <small>Score</small>
              <strong id="endScore">0</strong>
            </div>
            <div class="kpi">
              <small>Accuracy</small>
              <strong id="endAcc">—</strong>
            </div>
            <div class="kpi">
              <small>Best</small>
              <strong id="endBest">0</strong>
            </div>
          </div>
          <div class="ctaRow">
            <button class="cta primary" id="restartBtn">Play again</button>
            <button class="cta ghost" id="closeBtn">Close</button>
            <span style="color: rgba(255, 255, 255, 0.7); font-size: 13px"
              >Press <strong>Space</strong> to restart.</span
            >
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <script>
      (() => {
        const GAME_SECONDS = 30;
        const STORAGE_KEY = "cmc_best_v1";

        const COLORS = [
          { id: "red", name: "RED", hex: "#ff3b30", key: "1" },
          { id: "green", name: "GREEN", hex: "#34c759", key: "2" },
          { id: "blue", name: "BLUE", hex: "#0a84ff", key: "3" },
          { id: "yellow", name: "YELLOW", hex: "#ffd60a", key: "4" },
          { id: "purple", name: "PURPLE", hex: "#bf5af2", key: "5" },
          { id: "orange", name: "ORANGE", hex: "#ff9f0a", key: "6" },
          { id: "pink", name: "PINK", hex: "#ff2d55", key: "7" },
          { id: "cyan", name: "CYAN", hex: "#5ac8fa", key: "8" },
        ];

        const $ = (sel) => document.querySelector(sel);
        const controlsEl = $("#controls");
        const promptCardEl = $("#promptCard");
        const wordEl = $("#wordText");
        const scoreEl = $("#scoreVal");
        const timeEl = $("#timeVal");
        const streakEl = $("#streakVal");
        const ringEl = $("#timeRing");
        const bestEl = $("#bestVal");
        const accEl = $("#accVal");
        const toastEl = $("#toast");
        const startOverlay = $("#startOverlay");
        const endOverlay = $("#endOverlay");

        const soundToggle = $("#soundToggle");
        const hapticToggle = $("#hapticToggle");

        const startBtn = $("#startBtn");
        const practiceBtn = $("#practiceBtn");
        const restartBtn = $("#restartBtn");
        const closeBtn = $("#closeBtn");

        const endScoreEl = $("#endScore");
        const endAccEl = $("#endAcc");
        const endBestEl = $("#endBest");
        const endSummaryEl = $("#endSummary");

        const confettiCanvas = $("#confetti");
        const confettiCtx = confettiCanvas.getContext("2d", { alpha: true });

        /** @type {{running:boolean, practice:boolean, score:number, streak:number, attempts:number, correct:number, endAt:number, targetIndex:number, raf:number|null, lastPromptAt:number}} */
        const state = {
          running: false,
          practice: false,
          score: 0,
          streak: 0,
          attempts: 0,
          correct: 0,
          endAt: 0,
          targetIndex: 0,
          raf: null,
          lastPromptAt: 0,
        };

        let best = Number(localStorage.getItem(STORAGE_KEY) || "0") || 0;
        bestEl.textContent = String(best);

        // Audio: lightweight tones, no assets.
        /** @type {AudioContext | null} */
        let audioCtx = null;
        let audioUnlocked = false;

        function hexToRgb(hex) {
          const h = String(hex).replace("#", "").trim();
          if (h.length !== 6) return { r: 255, g: 255, b: 255 };
          return {
            r: parseInt(h.slice(0, 2), 16),
            g: parseInt(h.slice(2, 4), 16),
            b: parseInt(h.slice(4, 6), 16),
          };
        }

        function rgbToHex({ r, g, b }) {
          const to2 = (n) => n.toString(16).padStart(2, "0");
          return `#${to2(clamp(Math.round(r), 0, 255))}${to2(clamp(Math.round(g), 0, 255))}${to2(clamp(Math.round(b), 0, 255))}`;
        }

        function mixRgb(a, b, t) {
          return { r: a.r + (b.r - a.r) * t, g: a.g + (b.g - a.g) * t, b: a.b + (b.b - a.b) * t };
        }

        function ensureAudio() {
          if (!soundToggle.checked) return;
          if (audioUnlocked) return;
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          audioCtx = audioCtx || new Ctx();
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          g.gain.value = 0.0001;
          o.frequency.value = 440;
          o.type = "sine";
          o.connect(g);
          g.connect(audioCtx.destination);
          o.start();
          o.stop(audioCtx.currentTime + 0.01);
          audioUnlocked = true;
        }

        function tone(freq, ms, type = "sine", gain = 0.055) {
          if (!soundToggle.checked) return;
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          audioCtx = audioCtx || new Ctx();
          if (audioCtx.state === "suspended") audioCtx.resume().catch(() => {});
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          const t0 = audioCtx.currentTime;
          o.type = type;
          o.frequency.setValueAtTime(freq, t0);
          g.gain.setValueAtTime(0.0001, t0);
          g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + Math.max(0.03, ms / 1000));
          o.connect(g);
          g.connect(audioCtx.destination);
          o.start(t0);
          o.stop(t0 + ms / 1000 + 0.03);
        }

        function buzz(pattern = [12]) {
          if (!hapticToggle.checked) return;
          if (!("vibrate" in navigator)) return;
          try {
            navigator.vibrate(pattern);
          } catch {}
        }

        function showToast(msg) {
          toastEl.textContent = msg;
          toastEl.classList.add("show");
          window.clearTimeout(showToast._t);
          showToast._t = window.setTimeout(() => toastEl.classList.remove("show"), 1300);
        }

        function clamp(n, a, b) {
          return Math.max(a, Math.min(b, n));
        }

        function formatTime(seconds) {
          return seconds.toFixed(1);
        }

        function setRingProgress(p) {
          document.documentElement.style.setProperty("--p", String(clamp(p, 0, 1)));
        }

        function setButtonsEnabled(enabled) {
          controlsEl.querySelectorAll("button.btn").forEach((b) => (b.disabled = !enabled));
        }

        function pickNextPrompt() {
          const now = performance.now();
          // Avoid accidental rapid repeats.
          const wordIndex = Math.floor(Math.random() * COLORS.length);
          let targetIndex = Math.floor(Math.random() * COLORS.length);

          // Make mismatches slightly more likely for better Stroop effect.
          const mismatchBias = 0.72;
          if (Math.random() < mismatchBias && targetIndex === wordIndex) {
            targetIndex = (targetIndex + 1 + Math.floor(Math.random() * (COLORS.length - 1))) % COLORS.length;
          }

          // Extra guard for "same prompt" feel.
          if (now - state.lastPromptAt < 130) {
            targetIndex = (targetIndex + 3) % COLORS.length;
          }
          state.lastPromptAt = now;
          state.targetIndex = targetIndex;

          wordEl.textContent = COLORS[wordIndex].name;
          wordEl.style.color = COLORS[targetIndex].hex;
          wordEl.classList.remove("wordIn");
          // Reflow to restart animation.
          void wordEl.offsetWidth;
          wordEl.classList.add("wordIn");
        }

        function updateStatsUI() {
          scoreEl.textContent = String(state.score);
          streakEl.textContent = String(state.streak);
          const acc = state.attempts ? Math.round((state.correct / state.attempts) * 100) : null;
          accEl.textContent = acc === null ? "—" : `${acc}%`;
        }

        function setPromptFX(kind) {
          promptCardEl.classList.remove("fxOk", "fxBad");
          void promptCardEl.offsetWidth;
          promptCardEl.classList.add(kind === "ok" ? "fxOk" : "fxBad");
        }

        function addRipple(btn, clientX, clientY) {
          const rect = btn.getBoundingClientRect();
          const x = clientX - rect.left;
          const y = clientY - rect.top;
          const size = Math.max(rect.width, rect.height) * 1.6;
          const el = document.createElement("span");
          el.className = "ripple";
          el.style.width = `${size}px`;
          el.style.height = `${size}px`;
          el.style.left = `${x}px`;
          el.style.top = `${y}px`;
          btn.appendChild(el);
          window.setTimeout(() => el.remove(), 600);
        }

        function answer(colorIndex, source = "tap") {
          if (!state.running && !state.practice) return;

          state.attempts += 1;
          const correct = colorIndex === state.targetIndex;
          if (correct) {
            state.correct += 1;
            state.score += 1;
            state.streak += 1;
            setPromptFX("ok");
            tone(880 + Math.min(240, state.streak * 12), 70, "triangle", 0.05);
            buzz([10]);
            if (state.streak > 0 && state.streak % 8 === 0) {
              showToast(`Streak ×${state.streak}`);
            }
          } else {
            state.streak = 0;
            setPromptFX("bad");
            tone(180, 110, "sawtooth", 0.04);
            buzz([18, 30, 10]);
          }
          updateStatsUI();

          // Next prompt immediately (but let the press animation land).
          window.setTimeout(() => pickNextPrompt(), 60);
        }

        function resizeConfetti() {
          const dpr = Math.min(2, window.devicePixelRatio || 1);
          confettiCanvas.width = Math.floor(window.innerWidth * dpr);
          confettiCanvas.height = Math.floor(window.innerHeight * dpr);
          confettiCanvas.style.width = `${window.innerWidth}px`;
          confettiCanvas.style.height = `${window.innerHeight}px`;
          confettiCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        /** @type {{x:number,y:number,vx:number,vy:number,r:number,rot:number,vr:number,c:string,shape:number,life:number}[]} */
        let confetti = [];
        let confettiRaf = 0;

        function launchConfetti(intensity = 1) {
          resizeConfetti();
          const count = Math.floor(140 * intensity);
          const w = window.innerWidth;
          const h = window.innerHeight;
          const colors = COLORS.map((c) => c.hex);
          confetti = [];
          for (let i = 0; i < count; i++) {
            const c = colors[Math.floor(Math.random() * colors.length)];
            confetti.push({
              x: w * (0.15 + 0.7 * Math.random()),
              y: h * (0.25 + 0.1 * Math.random()),
              vx: (Math.random() - 0.5) * 10,
              vy: -8 - Math.random() * 10,
              r: 4 + Math.random() * 6,
              rot: Math.random() * Math.PI * 2,
              vr: (Math.random() - 0.5) * 0.35,
              c,
              shape: Math.random() < 0.5 ? 0 : 1,
              life: 80 + Math.random() * 50,
            });
          }

          cancelAnimationFrame(confettiRaf);
          confettiRaf = requestAnimationFrame(tickConfetti);
        }

        function tickConfetti() {
          confettiCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
          const g = 0.38;
          for (const p of confetti) {
            p.vy += g;
            p.x += p.vx;
            p.y += p.vy;
            p.rot += p.vr;
            p.vx *= 0.985;
            p.life -= 1;
          }
          confetti = confetti.filter((p) => p.life > 0 && p.y < window.innerHeight + 40);

          for (const p of confetti) {
            confettiCtx.save();
            confettiCtx.translate(p.x, p.y);
            confettiCtx.rotate(p.rot);
            confettiCtx.fillStyle = p.c;
            confettiCtx.globalAlpha = clamp(p.life / 120, 0, 1);
            if (p.shape === 0) {
              confettiCtx.fillRect(-p.r, -p.r * 0.55, p.r * 2.1, p.r * 1.1);
            } else {
              confettiCtx.beginPath();
              confettiCtx.arc(0, 0, p.r * 0.72, 0, Math.PI * 2);
              confettiCtx.fill();
            }
            confettiCtx.restore();
          }

          if (confetti.length) {
            confettiRaf = requestAnimationFrame(tickConfetti);
          } else {
            confettiCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
          }
        }

        function setRunningUI(isRunning) {
          setButtonsEnabled(isRunning || state.practice);
          if (!isRunning && !state.practice) {
            wordEl.textContent = "READY";
            wordEl.style.color = "rgba(255,255,255,0.85)";
          }
        }

        function startGame({ practice = false } = {}) {
          ensureAudio();
          tone(440, 70, "sine", 0.04);
          buzz([8]);

          state.practice = practice;
          state.running = !practice;
          state.score = 0;
          state.streak = 0;
          state.attempts = 0;
          state.correct = 0;
          state.targetIndex = 0;

          updateStatsUI();
          startOverlay.style.display = "none";
          endOverlay.style.display = "none";

          if (!practice) {
            const now = performance.now();
            state.endAt = now + GAME_SECONDS * 1000;
            setRingProgress(1);
            tickTimer();
          } else {
            timeEl.textContent = "∞";
            setRingProgress(1);
            ringEl.classList.remove("pulseUrgent");
          }

          setRunningUI(true);
          pickNextPrompt();
          showToast(practice ? "Practice mode (no timer)" : "Go!");
        }

        function endGame() {
          state.running = false;
          cancelAnimationFrame(state.raf);
          state.raf = null;

          setButtonsEnabled(false);
          ringEl.classList.remove("pulseUrgent");
          timeEl.textContent = "0.0";
          setRingProgress(0);

          const acc = state.attempts ? Math.round((state.correct / state.attempts) * 100) : 0;
          endScoreEl.textContent = String(state.score);
          endAccEl.textContent = `${acc}%`;
          endBestEl.textContent = String(best);

          const isBest = state.score > best;
          if (isBest) {
            best = state.score;
            localStorage.setItem(STORAGE_KEY, String(best));
            bestEl.textContent = String(best);
            endBestEl.textContent = String(best);
            endSummaryEl.textContent = "New best! Sharp eyes.";
            launchConfetti(1.15);
            tone(990, 110, "triangle", 0.06);
            window.setTimeout(() => tone(1320, 120, "triangle", 0.06), 120);
          } else {
            endSummaryEl.textContent = acc >= 80 ? "Clean accuracy." : "Speed up and trust the color.";
            tone(240, 130, "sine", 0.04);
          }

          endOverlay.style.display = "grid";
          endOverlay.querySelector("button")?.focus();
          setRunningUI(false);
        }

        function tickTimer() {
          if (!state.running) return;
          const now = performance.now();
          const remainingMs = Math.max(0, state.endAt - now);
          const remaining = remainingMs / 1000;
          timeEl.textContent = formatTime(remaining);
          setRingProgress(remaining / GAME_SECONDS);

          if (remaining <= 5.0) ringEl.classList.add("pulseUrgent");
          if (remaining <= 0.0001) {
            endGame();
            return;
          }
          state.raf = requestAnimationFrame(tickTimer);
        }

        function buildButtons() {
          controlsEl.innerHTML = "";
          for (let i = 0; i < COLORS.length; i++) {
            const c = COLORS[i];
            const base = hexToRgb(c.hex);
            const c1 = rgbToHex(mixRgb(base, { r: 255, g: 255, b: 255 }, 0.12));
            const c2 = rgbToHex(mixRgb(base, { r: 0, g: 0, b: 0 }, 0.22));
            const btn = document.createElement("button");
            btn.className = "btn";
            btn.type = "button";
            btn.dataset.index = String(i);
            btn.style.setProperty("--c", c.hex);
            btn.style.setProperty("--c1", c1);
            btn.style.setProperty("--c2", c2);
            btn.disabled = true;
            btn.setAttribute("aria-label", `${c.name} (key ${c.key})`);

            const fill = document.createElement("div");
            fill.className = "btnFill";

            const content = document.createElement("div");
            content.className = "btnContent";
            content.innerHTML = `
              <div class="btnTop">
                <span class="swatch" aria-hidden="true"></span>
                <div class="btnLabel">${c.name}</div>
                <div class="btnHint" aria-hidden="true">${c.key}</div>
              </div>
            `;

            btn.appendChild(fill);
            btn.appendChild(content);

            btn.addEventListener("pointerdown", (e) => {
              ensureAudio();
              addRipple(btn, e.clientX, e.clientY);
              btn.classList.add("pressed");
              window.setTimeout(() => btn.classList.remove("pressed"), 140);
            });

            btn.addEventListener("click", () => answer(i, "tap"));

            controlsEl.appendChild(btn);
          }
        }

        function openStart() {
          state.running = false;
          state.practice = false;
          cancelAnimationFrame(state.raf);
          state.raf = null;
          startOverlay.style.display = "grid";
          endOverlay.style.display = "none";
          setRunningUI(false);
          setButtonsEnabled(false);
          timeEl.textContent = formatTime(GAME_SECONDS);
          setRingProgress(1);
          ringEl.classList.remove("pulseUrgent");
          accEl.textContent = "—";
          streakEl.textContent = "0";
          scoreEl.textContent = "0";
          startBtn.focus();
        }

        function stopPractice() {
          state.practice = false;
          setButtonsEnabled(false);
          timeEl.textContent = formatTime(GAME_SECONDS);
          setRingProgress(1);
          ringEl.classList.remove("pulseUrgent");
          wordEl.textContent = "READY";
          wordEl.style.color = "rgba(255,255,255,0.85)";
          showToast("Practice ended");
        }

        function handleKey(e) {
          if (e.key === " " || e.code === "Space") {
            e.preventDefault();
            if (startOverlay.style.display !== "none") {
              startGame({ practice: false });
              return;
            }
            if (endOverlay.style.display !== "none") {
              startGame({ practice: false });
              return;
            }
            if (!state.running && !state.practice) {
              startOverlay.style.display = "grid";
              return;
            }
          }
          const idx = COLORS.findIndex((c) => c.key === e.key);
          if (idx >= 0) {
            answer(idx, "key");
          }
          if (e.key === "Escape") {
            if (state.practice) stopPractice();
          }
        }

        function bindEvents() {
          startBtn.addEventListener("click", () => startGame({ practice: false }));
          practiceBtn.addEventListener("click", () => startGame({ practice: true }));
          restartBtn.addEventListener("click", () => startGame({ practice: false }));
          closeBtn.addEventListener("click", () => {
            endOverlay.style.display = "none";
            openStart();
          });

          document.addEventListener("keydown", handleKey);
          window.addEventListener("resize", () => resizeConfetti(), { passive: true });
        }

        buildButtons();
        bindEvents();
        resizeConfetti();
        openStart();
      })();
    </script>
  </body>
</html>
