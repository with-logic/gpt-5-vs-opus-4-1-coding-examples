<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <meta
      name="description"
      content="Healthy Meal Tracker ‚Äî log meals, ingredients, calories, and view daily summaries."
    />
    <title>Healthy Meal Tracker</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script>
      // Tailwind CDN config (must be before the CDN script)
      tailwind = {
        config: {
          darkMode: "class",
          theme: {
            extend: {
              fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui", "sans-serif"] },
              colors: {
                brand: {
                  50: "#eefcf3",
                  100: "#d7f7e3",
                  200: "#b2efc9",
                  300: "#7ee0a6",
                  400: "#39c779",
                  500: "#1eab60",
                  600: "#16854c",
                  700: "#136b40",
                  800: "#125636",
                  900: "#10482f",
                },
              },
              boxShadow: {
                soft: "0 10px 30px rgba(2, 6, 23, 0.08)",
                softDark: "0 12px 36px rgba(0, 0, 0, 0.35)",
              },
            },
          },
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --ring: rgba(30, 171, 96, 0.35);
      }
      html {
        scroll-behavior: smooth;
      }
      ::selection {
        background: rgba(30, 171, 96, 0.22);
      }
      .focus-ring:focus {
        outline: none;
        box-shadow:
          0 0 0 3px var(--ring),
          0 0 0 1px rgba(15, 23, 42, 0.25);
      }
      .no-spin::-webkit-outer-spin-button,
      .no-spin::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .no-spin {
        -moz-appearance: textfield;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        border-radius: 9999px;
        padding: 0.25rem 0.6rem;
        font-size: 0.875rem;
      }
      .chip button {
        border-radius: 9999px;
        padding: 0.15rem 0.35rem;
      }
      .toast-enter {
        animation: toastIn 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
      }
      @keyframes toastIn {
        from {
          transform: translateY(10px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .skeleton {
        background: linear-gradient(90deg, rgba(148, 163, 184, 0.18), rgba(148, 163, 184, 0.08), rgba(148, 163, 184, 0.18));
        background-size: 220% 100%;
        animation: shimmer 1.3s ease-in-out infinite;
      }
      @keyframes shimmer {
        0% {
          background-position: 0% 0%;
        }
        100% {
          background-position: 220% 0%;
        }
      }
    </style>
  </head>

  <body class="min-h-full bg-slate-50 text-slate-900 antialiased dark:bg-slate-950 dark:text-slate-50">
    <div class="pointer-events-none fixed inset-x-0 top-0 -z-10 h-64 bg-gradient-to-b from-brand-100/70 to-transparent dark:from-brand-900/30"></div>

    <header class="sticky top-0 z-30 border-b border-slate-200/70 bg-white/80 backdrop-blur dark:border-slate-800/70 dark:bg-slate-950/70">
      <div class="mx-auto max-w-6xl px-4 py-3">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex items-center gap-3">
            <div class="grid h-10 w-10 place-items-center rounded-2xl bg-gradient-to-br from-brand-400 to-brand-700 text-white shadow-soft dark:shadow-softDark" aria-hidden="true">
              <span class="text-lg">ü•ó</span>
            </div>
            <div>
              <div class="flex items-center gap-2">
                <h1 class="text-lg font-semibold leading-tight">Healthy Meal Tracker</h1>
                <span class="hidden rounded-full border border-slate-200 bg-white px-2 py-0.5 text-xs text-slate-600 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-300 sm:inline">Offline-friendly</span>
              </div>
              <p class="text-sm text-slate-600 dark:text-slate-300">Log meals, ingredients, and calories. See your day at a glance.</p>
            </div>
          </div>

          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-3">
            <div class="flex items-center gap-2">
              <label for="datePicker" class="text-sm font-medium text-slate-700 dark:text-slate-200">Date</label>
              <input
                id="datePicker"
                type="date"
                class="focus-ring h-10 rounded-xl border border-slate-200 bg-white px-3 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-900"
              />
              <button id="todayBtn" class="focus-ring h-10 rounded-xl border border-slate-200 bg-white px-3 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800" type="button">
                Today
              </button>
            </div>

            <div class="flex items-center gap-2">
              <button id="settingsBtn" class="focus-ring inline-flex h-10 items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800" type="button">
                <span aria-hidden="true">‚öôÔ∏è</span><span>Goals</span>
              </button>
              <button id="themeBtn" class="focus-ring inline-flex h-10 items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800" type="button">
                <span id="themeIcon" aria-hidden="true">üåô</span><span id="themeLabel">Dark</span>
              </button>
              <div class="relative">
                <button id="dataBtn" class="focus-ring inline-flex h-10 items-center gap-2 rounded-xl bg-brand-600 px-3 text-sm font-semibold text-white shadow-soft hover:bg-brand-700 dark:shadow-softDark" type="button">
                  <span aria-hidden="true">üóÇÔ∏è</span><span>Data</span>
                </button>
                <div id="dataMenu" class="absolute right-0 mt-2 hidden w-56 overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-soft dark:border-slate-800 dark:bg-slate-900 dark:shadow-softDark" role="menu" aria-label="Data menu">
                  <button id="exportBtn" class="w-full px-4 py-3 text-left text-sm hover:bg-slate-50 dark:hover:bg-slate-800" role="menuitem" type="button">Export meals</button>
                  <label class="block cursor-pointer px-4 py-3 text-sm hover:bg-slate-50 dark:hover:bg-slate-800">
                    <span>Import meals</span>
                    <input id="importInput" type="file" accept="application/json" class="hidden" />
                  </label>
                  <div class="h-px bg-slate-100 dark:bg-slate-800"></div>
                  <button id="clearAllBtn" class="w-full px-4 py-3 text-left text-sm text-rose-700 hover:bg-rose-50 dark:text-rose-300 dark:hover:bg-rose-950/40" role="menuitem" type="button">Clear all data</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-6xl px-4 py-6">
      <section class="grid gap-6 lg:grid-cols-12">
        <div class="lg:col-span-8">
          <div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-soft dark:border-slate-800 dark:bg-slate-900 dark:shadow-softDark">
            <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <h2 class="text-base font-semibold">Daily summary</h2>
                  <span id="summaryDateLabel" class="truncate text-sm text-slate-600 dark:text-slate-300"></span>
                </div>
                <p id="summarySub" class="mt-1 text-sm text-slate-600 dark:text-slate-300">Set your goals and start logging.</p>
              </div>
              <div class="flex shrink-0 items-center gap-2">
                <button id="copySummaryBtn" class="focus-ring inline-flex h-10 items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button">
                  <span aria-hidden="true">üìã</span><span>Copy</span>
                </button>
                <button id="clearDayBtn" class="focus-ring inline-flex h-10 items-center gap-2 rounded-xl border border-rose-200 bg-rose-50 px-3 text-sm font-medium text-rose-800 hover:bg-rose-100 dark:border-rose-900/50 dark:bg-rose-950/30 dark:text-rose-200 dark:hover:bg-rose-950/45" type="button">
                  <span aria-hidden="true">üßπ</span><span>Clear day</span>
                </button>
              </div>
            </div>

            <div class="mt-5 grid gap-4 sm:grid-cols-3">
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 dark:border-slate-800 dark:bg-slate-950/40">
                <div class="flex items-center justify-between">
                  <p class="text-sm font-medium text-slate-700 dark:text-slate-200">Calories</p>
                  <span class="text-sm text-slate-500 dark:text-slate-400" aria-hidden="true">üî•</span>
                </div>
                <div class="mt-2 flex items-baseline gap-2">
                  <p id="totalCalories" class="text-2xl font-semibold tabular-nums">0</p>
                  <p class="text-sm text-slate-600 dark:text-slate-300"><span id="calGoalLabel">/ 2000</span> kcal</p>
                </div>
                <div class="mt-3 h-2 overflow-hidden rounded-full bg-slate-200 dark:bg-slate-800" aria-hidden="true">
                  <div id="calProgress" class="h-full w-0 rounded-full bg-gradient-to-r from-brand-400 to-brand-700 transition-[width] duration-500"></div>
                </div>
                <p id="calHint" class="mt-2 text-xs text-slate-600 dark:text-slate-300">0% of your goal</p>
              </div>

              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 dark:border-slate-800 dark:bg-slate-950/40">
                <div class="flex items-center justify-between">
                  <p class="text-sm font-medium text-slate-700 dark:text-slate-200">Macros</p>
                  <span class="text-sm text-slate-500 dark:text-slate-400" aria-hidden="true">ü•ë</span>
                </div>
                <div class="mt-2 grid grid-cols-3 gap-2 text-sm">
                  <div>
                    <p class="text-xs text-slate-600 dark:text-slate-300">Protein</p>
                    <p id="totalProtein" class="mt-0.5 font-semibold tabular-nums">0g</p>
                  </div>
                  <div>
                    <p class="text-xs text-slate-600 dark:text-slate-300">Carbs</p>
                    <p id="totalCarbs" class="mt-0.5 font-semibold tabular-nums">0g</p>
                  </div>
                  <div>
                    <p class="text-xs text-slate-600 dark:text-slate-300">Fat</p>
                    <p id="totalFat" class="mt-0.5 font-semibold tabular-nums">0g</p>
                  </div>
                </div>
                <div class="mt-3 space-y-2 text-xs">
                  <div>
                    <div class="flex items-center justify-between text-slate-600 dark:text-slate-300">
                      <span>Protein</span><span id="proteinGoalLabel">/ 120g</span>
                    </div>
                    <div class="mt-1 h-2 overflow-hidden rounded-full bg-slate-200 dark:bg-slate-800">
                      <div id="proteinProgress" class="h-full w-0 rounded-full bg-sky-500 transition-[width] duration-500"></div>
                    </div>
                  </div>
                  <div>
                    <div class="flex items-center justify-between text-slate-600 dark:text-slate-300">
                      <span>Carbs</span><span id="carbGoalLabel">/ 200g</span>
                    </div>
                    <div class="mt-1 h-2 overflow-hidden rounded-full bg-slate-200 dark:bg-slate-800">
                      <div id="carbProgress" class="h-full w-0 rounded-full bg-amber-500 transition-[width] duration-500"></div>
                    </div>
                  </div>
                  <div>
                    <div class="flex items-center justify-between text-slate-600 dark:text-slate-300">
                      <span>Fat</span><span id="fatGoalLabel">/ 70g</span>
                    </div>
                    <div class="mt-1 h-2 overflow-hidden rounded-full bg-slate-200 dark:bg-slate-800">
                      <div id="fatProgress" class="h-full w-0 rounded-full bg-rose-500 transition-[width] duration-500"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 dark:border-slate-800 dark:bg-slate-950/40">
                <div class="flex items-center justify-between">
                  <p class="text-sm font-medium text-slate-700 dark:text-slate-200">Meals</p>
                  <span class="text-sm text-slate-500 dark:text-slate-400" aria-hidden="true">üçΩÔ∏è</span>
                </div>
                <div class="mt-2 flex items-baseline gap-2">
                  <p id="mealCount" class="text-2xl font-semibold tabular-nums">0</p>
                  <p class="text-sm text-slate-600 dark:text-slate-300">logged</p>
                </div>
                <div class="mt-3 grid grid-cols-2 gap-2">
                  <div class="rounded-xl border border-slate-200 bg-white p-3 text-xs text-slate-700 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200">
                    <p class="text-slate-500 dark:text-slate-400">Avg / meal</p>
                    <p id="avgPerMeal" class="mt-1 font-semibold tabular-nums">0 kcal</p>
                  </div>
                  <div class="rounded-xl border border-slate-200 bg-white p-3 text-xs text-slate-700 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200">
                    <p class="text-slate-500 dark:text-slate-400">Top ingredient</p>
                    <p id="topIngredient" class="mt-1 truncate font-semibold">‚Äî</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-6 grid gap-4 lg:grid-cols-2">
              <div class="rounded-2xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-950/30">
                <div class="flex items-center justify-between">
                  <p class="text-sm font-semibold">Calories per meal</p>
                  <p class="text-xs text-slate-500 dark:text-slate-400">Bar chart</p>
                </div>
                <div class="mt-3 h-56">
                  <canvas id="caloriesChart" aria-label="Calories per meal chart" role="img"></canvas>
                </div>
              </div>

              <div class="rounded-2xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-950/30">
                <div class="flex items-center justify-between">
                  <p class="text-sm font-semibold">Macro balance</p>
                  <p class="text-xs text-slate-500 dark:text-slate-400">Doughnut</p>
                </div>
                <div class="mt-3 h-56">
                  <canvas id="macrosChart" aria-label="Macros chart" role="img"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-4">
          <div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-soft dark:border-slate-800 dark:bg-slate-900 dark:shadow-softDark">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h2 id="formTitle" class="text-base font-semibold">Log a meal</h2>
                <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">Add ingredients and calories ‚Äî keep it simple.</p>
              </div>
              <button id="resetFormBtn" class="focus-ring hidden h-10 rounded-xl border border-slate-200 bg-white px-3 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button">
                Reset
              </button>
            </div>

            <form id="mealForm" class="mt-5 space-y-4">
              <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-1">
                <div class="sm:col-span-2 lg:col-span-1">
                  <label for="mealName" class="text-sm font-medium text-slate-700 dark:text-slate-200">Meal name</label>
                  <div class="mt-1 flex items-center gap-2">
                    <input
                      id="mealName"
                      class="focus-ring h-11 w-full rounded-2xl border border-slate-200 bg-white px-4 text-sm shadow-sm placeholder:text-slate-400 dark:border-slate-800 dark:bg-slate-950"
                      placeholder="e.g., Chicken salad"
                      autocomplete="off"
                      required
                    />
                    <button id="suggestBtn" class="focus-ring inline-flex h-11 items-center justify-center rounded-2xl border border-slate-200 bg-white px-3 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button" aria-label="Show suggestions">
                      ‚ú®
                    </button>
                  </div>
                  <div id="suggestions" class="mt-2 hidden flex flex-wrap gap-2" aria-label="Meal suggestions"></div>
                </div>

                <div>
                  <label for="mealTime" class="text-sm font-medium text-slate-700 dark:text-slate-200">Time</label>
                  <input id="mealTime" type="time" class="focus-ring mt-1 h-11 w-full rounded-2xl border border-slate-200 bg-white px-4 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-950" />
                </div>

                <div>
                  <label for="mealCalories" class="text-sm font-medium text-slate-700 dark:text-slate-200">Calories</label>
                  <input
                    id="mealCalories"
                    type="number"
                    min="0"
                    step="1"
                    inputmode="numeric"
                    class="no-spin focus-ring mt-1 h-11 w-full rounded-2xl border border-slate-200 bg-white px-4 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-950"
                    placeholder="0"
                    required
                  />
                </div>
              </div>

              <div class="grid gap-3 sm:grid-cols-3 lg:grid-cols-1">
                <div>
                  <label for="mealProtein" class="text-sm font-medium text-slate-700 dark:text-slate-200">Protein (g)</label>
                  <input id="mealProtein" type="number" min="0" step="1" inputmode="numeric" class="no-spin focus-ring mt-1 h-11 w-full rounded-2xl border border-slate-200 bg-white px-4 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-950" placeholder="0" />
                </div>
                <div>
                  <label for="mealCarbs" class="text-sm font-medium text-slate-700 dark:text-slate-200">Carbs (g)</label>
                  <input id="mealCarbs" type="number" min="0" step="1" inputmode="numeric" class="no-spin focus-ring mt-1 h-11 w-full rounded-2xl border border-slate-200 bg-white px-4 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-950" placeholder="0" />
                </div>
                <div>
                  <label for="mealFat" class="text-sm font-medium text-slate-700 dark:text-slate-200">Fat (g)</label>
                  <input id="mealFat" type="number" min="0" step="1" inputmode="numeric" class="no-spin focus-ring mt-1 h-11 w-full rounded-2xl border border-slate-200 bg-white px-4 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-950" placeholder="0" />
                </div>
              </div>

              <div>
                <label for="ingredientInput" class="text-sm font-medium text-slate-700 dark:text-slate-200">Ingredients</label>
                <p class="mt-1 text-xs text-slate-600 dark:text-slate-300">Type an ingredient and press Enter (or add comma-separated).</p>
                <div class="mt-2 flex items-center gap-2">
                  <input
                    id="ingredientInput"
                    class="focus-ring h-11 w-full rounded-2xl border border-slate-200 bg-white px-4 text-sm shadow-sm placeholder:text-slate-400 dark:border-slate-800 dark:bg-slate-950"
                    placeholder="e.g., spinach, tomato, olive oil"
                    autocomplete="off"
                  />
                  <button id="addIngredientBtn" class="focus-ring inline-flex h-11 items-center justify-center rounded-2xl bg-slate-900 px-3 text-sm font-semibold text-white shadow-sm hover:bg-slate-800 dark:bg-white dark:text-slate-900 dark:hover:bg-slate-100" type="button">
                    Add
                  </button>
                </div>
                <div id="ingredientChips" class="mt-3 flex flex-wrap gap-2"></div>
                <div class="mt-3 flex flex-wrap gap-2" aria-label="Ingredient quick picks">
                  <button class="quick-ingredient focus-ring rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button" data-value="leafy greens">
                    ü•¨ leafy greens
                  </button>
                  <button class="quick-ingredient focus-ring rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button" data-value="berries">
                    ü´ê berries
                  </button>
                  <button class="quick-ingredient focus-ring rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button" data-value="Greek yogurt">
                    üç∂ Greek yogurt
                  </button>
                  <button class="quick-ingredient focus-ring rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button" data-value="nuts">
                    ü•ú nuts
                  </button>
                  <button class="quick-ingredient focus-ring rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button" data-value="whole grains">
                    üåæ whole grains
                  </button>
                </div>
              </div>

              <div>
                <label for="mealNotes" class="text-sm font-medium text-slate-700 dark:text-slate-200">Notes (optional)</label>
                <textarea
                  id="mealNotes"
                  rows="2"
                  class="focus-ring mt-1 w-full resize-y rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm placeholder:text-slate-400 dark:border-slate-800 dark:bg-slate-950"
                  placeholder="How did it feel? Any tweaks for next time?"
                ></textarea>
              </div>

              <div class="flex flex-col gap-2 sm:flex-row">
                <button id="submitBtn" class="focus-ring inline-flex h-11 flex-1 items-center justify-center gap-2 rounded-2xl bg-brand-600 px-4 text-sm font-semibold text-white shadow-soft hover:bg-brand-700 dark:shadow-softDark" type="submit">
                  <span id="submitIcon" aria-hidden="true">‚ûï</span>
                  <span id="submitLabel">Add meal</span>
                </button>
                <button id="demoBtn" class="focus-ring inline-flex h-11 items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 text-sm font-semibold text-slate-800 shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button">
                  <span aria-hidden="true">üç±</span><span>Demo day</span>
                </button>
              </div>

              <p class="text-xs text-slate-600 dark:text-slate-300">
                Tip: Use <span class="font-semibold">Tab</span> through fields, and press <span class="font-semibold">Enter</span> in Ingredients to add.
              </p>
            </form>
          </div>
        </div>
      </section>

      <section class="mt-6">
        <div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-soft dark:border-slate-800 dark:bg-slate-900 dark:shadow-softDark">
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 class="text-base font-semibold">Meals for this day</h2>
              <p id="listSub" class="mt-1 text-sm text-slate-600 dark:text-slate-300">Everything you logged shows up here.</p>
            </div>
            <div class="flex items-center gap-2">
              <div class="relative w-full sm:w-72">
                <input
                  id="searchInput"
                  class="focus-ring h-11 w-full rounded-2xl border border-slate-200 bg-white pl-10 pr-4 text-sm shadow-sm placeholder:text-slate-400 dark:border-slate-800 dark:bg-slate-950"
                  placeholder="Search meals or ingredients‚Ä¶"
                  autocomplete="off"
                />
                <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" aria-hidden="true">üîé</span>
              </div>
              <button id="sortBtn" class="focus-ring inline-flex h-11 items-center gap-2 rounded-2xl border border-slate-200 bg-white px-3 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button" aria-label="Toggle sort order">
                <span id="sortIcon" aria-hidden="true">üïí</span><span id="sortLabel">Time</span>
              </button>
            </div>
          </div>

          <div id="mealsList" class="mt-5 grid gap-3"></div>

          <div id="emptyState" class="mt-5 hidden rounded-2xl border border-dashed border-slate-300 bg-slate-50 p-8 text-center dark:border-slate-700 dark:bg-slate-950/40">
            <p class="text-2xl" aria-hidden="true">üçì</p>
            <h3 class="mt-2 text-base font-semibold">No meals logged yet</h3>
            <p class="mx-auto mt-1 max-w-md text-sm text-slate-600 dark:text-slate-300">
              Add your first meal on the right. You‚Äôll see calories per meal, an ingredient list, and your daily totals here.
            </p>
          </div>
        </div>
      </section>
    </main>

    <!-- Settings Modal -->
    <div id="settingsOverlay" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
      <div class="relative mx-auto flex min-h-full max-w-2xl items-center justify-center p-4">
        <div class="w-full rounded-3xl border border-slate-200 bg-white p-5 shadow-soft dark:border-slate-800 dark:bg-slate-900 dark:shadow-softDark">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-base font-semibold">Goals</h2>
              <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">Used for progress bars and ‚Äú% of goal‚Äù hints.</p>
            </div>
            <button id="closeSettingsBtn" class="focus-ring inline-flex h-10 items-center justify-center rounded-xl border border-slate-200 bg-white px-3 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button">
              Close
            </button>
          </div>

          <form id="settingsForm" class="mt-5 grid gap-4 sm:grid-cols-2">
            <div class="sm:col-span-2">
              <label for="goalCalories" class="text-sm font-medium text-slate-700 dark:text-slate-200">Daily calories (kcal)</label>
              <input id="goalCalories" type="number" min="0" step="10" class="no-spin focus-ring mt-1 h-11 w-full rounded-2xl border border-slate-200 bg-white px-4 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-950" />
            </div>
            <div>
              <label for="goalProtein" class="text-sm font-medium text-slate-700 dark:text-slate-200">Protein goal (g)</label>
              <input id="goalProtein" type="number" min="0" step="5" class="no-spin focus-ring mt-1 h-11 w-full rounded-2xl border border-slate-200 bg-white px-4 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-950" />
            </div>
            <div>
              <label for="goalCarbs" class="text-sm font-medium text-slate-700 dark:text-slate-200">Carbs goal (g)</label>
              <input id="goalCarbs" type="number" min="0" step="5" class="no-spin focus-ring mt-1 h-11 w-full rounded-2xl border border-slate-200 bg-white px-4 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-950" />
            </div>
            <div>
              <label for="goalFat" class="text-sm font-medium text-slate-700 dark:text-slate-200">Fat goal (g)</label>
              <input id="goalFat" type="number" min="0" step="5" class="no-spin focus-ring mt-1 h-11 w-full rounded-2xl border border-slate-200 bg-white px-4 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-950" />
            </div>
            <div>
              <label for="weekStartsOn" class="text-sm font-medium text-slate-700 dark:text-slate-200">Week starts</label>
              <select id="weekStartsOn" class="focus-ring mt-1 h-11 w-full rounded-2xl border border-slate-200 bg-white px-4 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-950">
                <option value="monday">Monday</option>
                <option value="sunday">Sunday</option>
              </select>
            </div>

            <div class="sm:col-span-2 flex flex-col gap-2 sm:flex-row sm:justify-end">
              <button id="resetGoalsBtn" class="focus-ring inline-flex h-11 items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 text-sm font-semibold text-slate-800 shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button">
                Reset defaults
              </button>
              <button class="focus-ring inline-flex h-11 items-center justify-center rounded-2xl bg-brand-600 px-4 text-sm font-semibold text-white shadow-soft hover:bg-brand-700 dark:shadow-softDark" type="submit">
                Save goals
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Toasts -->
    <div class="pointer-events-none fixed inset-x-0 bottom-4 z-50 mx-auto flex max-w-6xl px-4">
      <div id="toasts" class="pointer-events-auto ml-auto flex w-full max-w-sm flex-col gap-2"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
      (() => {
        "use strict";

        const STORAGE_KEY_MEALS = "hmt_meals_v1";
        const STORAGE_KEY_SETTINGS = "hmt_settings_v1";
        const STORAGE_KEY_UI = "hmt_ui_v1";

        const DEFAULT_SETTINGS = {
          calorieGoal: 2000,
          proteinGoal: 120,
          carbGoal: 200,
          fatGoal: 70,
          weekStartsOn: "monday",
        };

        const MEAL_SUGGESTIONS = [
          { name: "Greek yogurt & berries", calories: 320, protein: 22, carbs: 40, fat: 8, ingredients: ["Greek yogurt", "berries", "honey", "chia seeds"] },
          { name: "Chicken salad bowl", calories: 540, protein: 42, carbs: 28, fat: 22, ingredients: ["chicken", "leafy greens", "tomato", "cucumber", "olive oil"] },
          { name: "Overnight oats", calories: 420, protein: 18, carbs: 58, fat: 12, ingredients: ["oats", "milk", "banana", "peanut butter"] },
          { name: "Salmon + veggies", calories: 610, protein: 40, carbs: 22, fat: 34, ingredients: ["salmon", "broccoli", "lemon", "olive oil"] },
          { name: "Tofu stir-fry", calories: 520, protein: 28, carbs: 55, fat: 18, ingredients: ["tofu", "mixed vegetables", "soy sauce", "garlic"] },
        ];

        const $ = (id) => document.getElementById(id);
        const escapeHtml = (s) =>
          String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");

        const clamp01 = (n) => Math.max(0, Math.min(1, n));
        const round1 = (n) => Math.round(n * 10) / 10;

        function todayISO() {
          const d = new Date();
          const pad = (x) => String(x).padStart(2, "0");
          return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
        }

        function nowTime() {
          const d = new Date();
          const pad = (x) => String(x).padStart(2, "0");
          return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        function safeJsonParse(raw, fallback) {
          try {
            const parsed = JSON.parse(raw);
            return parsed ?? fallback;
          } catch {
            return fallback;
          }
        }

        function loadMeals() {
          const raw = localStorage.getItem(STORAGE_KEY_MEALS);
          const parsed = safeJsonParse(raw, []);
          if (!Array.isArray(parsed)) return [];
          return parsed
            .filter((m) => m && typeof m === "object")
            .map((m) => ({
              id: String(m.id ?? ""),
              date: String(m.date ?? ""),
              time: String(m.time ?? ""),
              name: String(m.name ?? ""),
              calories: Number.isFinite(Number(m.calories)) ? Number(m.calories) : 0,
              protein: Number.isFinite(Number(m.protein)) ? Number(m.protein) : 0,
              carbs: Number.isFinite(Number(m.carbs)) ? Number(m.carbs) : 0,
              fat: Number.isFinite(Number(m.fat)) ? Number(m.fat) : 0,
              ingredients: Array.isArray(m.ingredients) ? m.ingredients.map(String).filter(Boolean) : [],
              notes: String(m.notes ?? ""),
              createdAt: Number.isFinite(Number(m.createdAt)) ? Number(m.createdAt) : Date.now(),
              updatedAt: Number.isFinite(Number(m.updatedAt)) ? Number(m.updatedAt) : Date.now(),
            }))
            .filter((m) => m.id && m.date);
        }

        function saveMeals(meals) {
          localStorage.setItem(STORAGE_KEY_MEALS, JSON.stringify(meals));
        }

        function loadSettings() {
          const raw = localStorage.getItem(STORAGE_KEY_SETTINGS);
          const parsed = safeJsonParse(raw, {});
          return {
            ...DEFAULT_SETTINGS,
            calorieGoal: Number.isFinite(Number(parsed.calorieGoal)) ? Number(parsed.calorieGoal) : DEFAULT_SETTINGS.calorieGoal,
            proteinGoal: Number.isFinite(Number(parsed.proteinGoal)) ? Number(parsed.proteinGoal) : DEFAULT_SETTINGS.proteinGoal,
            carbGoal: Number.isFinite(Number(parsed.carbGoal)) ? Number(parsed.carbGoal) : DEFAULT_SETTINGS.carbGoal,
            fatGoal: Number.isFinite(Number(parsed.fatGoal)) ? Number(parsed.fatGoal) : DEFAULT_SETTINGS.fatGoal,
            weekStartsOn: parsed.weekStartsOn === "sunday" ? "sunday" : DEFAULT_SETTINGS.weekStartsOn,
          };
        }

        function saveSettings(settings) {
          localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
        }

        function loadUiState() {
          const raw = localStorage.getItem(STORAGE_KEY_UI);
          const parsed = safeJsonParse(raw, {});
          return {
            theme: parsed.theme === "dark" ? "dark" : parsed.theme === "light" ? "light" : "system",
            sortMode: parsed.sortMode === "calories" ? "calories" : "time",
          };
        }

        function saveUiState(ui) {
          localStorage.setItem(STORAGE_KEY_UI, JSON.stringify(ui));
        }

        function uid() {
          if (globalThis.crypto?.randomUUID) return crypto.randomUUID();
          return `m_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
        }

        function normalizeIngredient(s) {
          return String(s).trim().replace(/\s+/g, " ");
        }

        function foodIconFor(meal) {
          const txt = `${meal.name} ${meal.ingredients.join(" ")}`.toLowerCase();
          const has = (re) => re.test(txt);
          if (has(/\b(yogurt|berries|oats|granola)\b/)) return "ü•£";
          if (has(/\b(salad|greens|spinach|kale)\b/)) return "ü•ó";
          if (has(/\b(chicken|turkey)\b/)) return "üçó";
          if (has(/\b(salmon|fish|tuna|shrimp)\b/)) return "üêü";
          if (has(/\b(egg|omelet)\b/)) return "üç≥";
          if (has(/\b(tofu|tempeh)\b/)) return "üç≤";
          if (has(/\b(soup|broth)\b/)) return "üçú";
          if (has(/\b(smoothie)\b/)) return "ü•§";
          if (has(/\b(fruit|banana|apple|orange)\b/)) return "üçé";
          if (has(/\b(rice|grain|quinoa)\b/)) return "üçö";
          return "üçΩÔ∏è";
        }

        function formatPrettyDate(isoDate) {
          const d = new Date(`${isoDate}T00:00:00`);
          if (Number.isNaN(d.getTime())) return isoDate;
          return d.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric", year: "numeric" });
        }

        function sum(arr) {
          return arr.reduce((a, b) => a + b, 0);
        }

        function toast(message, options = {}) {
          const node = document.createElement("div");
          node.className =
            "toast-enter flex items-start gap-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-soft dark:border-slate-800 dark:bg-slate-900 dark:shadow-softDark";

          const icon = document.createElement("div");
          icon.className = "mt-0.5 grid h-9 w-9 shrink-0 place-items-center rounded-2xl bg-slate-900 text-white dark:bg-white dark:text-slate-900";
          icon.textContent = options.icon ?? "‚úÖ";

          const body = document.createElement("div");
          body.className = "min-w-0 flex-1";
          body.innerHTML = `<p class="text-sm font-medium">${escapeHtml(message)}</p>`;
          if (options.sub) {
            body.innerHTML += `<p class="mt-0.5 text-xs text-slate-600 dark:text-slate-300">${escapeHtml(options.sub)}</p>`;
          }

          const actions = document.createElement("div");
          actions.className = "flex items-center gap-2";

          if (typeof options.action === "function") {
            const btn = document.createElement("button");
            btn.className =
              "focus-ring inline-flex h-9 items-center justify-center rounded-xl border border-slate-200 bg-white px-3 text-xs font-semibold text-slate-800 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:hover:bg-slate-800";
            btn.type = "button";
            btn.textContent = options.actionLabel ?? "Undo";
            btn.addEventListener("click", () => {
              options.action?.();
              node.remove();
            });
            actions.appendChild(btn);
          }

          const close = document.createElement("button");
          close.className = "focus-ring inline-flex h-9 w-9 items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800";
          close.type = "button";
          close.setAttribute("aria-label", "Dismiss");
          close.textContent = "‚úï";
          close.addEventListener("click", () => node.remove());
          actions.appendChild(close);

          node.appendChild(icon);
          node.appendChild(body);
          node.appendChild(actions);

          $("toasts").appendChild(node);

          const timeout = window.setTimeout(() => node.remove(), options.timeoutMs ?? 3500);
          node.addEventListener("mouseenter", () => window.clearTimeout(timeout), { once: true });
        }

        function setTheme(theme) {
          const root = document.documentElement;
          const systemDark = window.matchMedia?.("(prefers-color-scheme: dark)").matches;
          const effective = theme === "system" ? (systemDark ? "dark" : "light") : theme;
          root.classList.toggle("dark", effective === "dark");
          const nextLabel = effective === "dark" ? "Light" : "Dark";
          $("themeLabel").textContent = nextLabel;
          $("themeIcon").textContent = effective === "dark" ? "‚òÄÔ∏è" : "üåô";
        }

        function buildSummaryText(dateIso, dayMeals, settings) {
          const totals = getTotals(dayMeals);
          const lines = [];
          lines.push(`Healthy Meal Tracker ‚Äî ${formatPrettyDate(dateIso)}`);
          lines.push(`Meals: ${dayMeals.length}`);
          lines.push(`Calories: ${Math.round(totals.calories)} / ${Math.round(settings.calorieGoal)} kcal`);
          lines.push(`Protein: ${Math.round(totals.protein)}g, Carbs: ${Math.round(totals.carbs)}g, Fat: ${Math.round(totals.fat)}g`);
          if (dayMeals.length) {
            lines.push("");
            for (const m of dayMeals) {
              lines.push(`- ${m.time || "‚Äî"} ${m.name} (${Math.round(m.calories)} kcal) ‚Äî ${m.ingredients.slice(0, 5).join(", ")}${m.ingredients.length > 5 ? "‚Ä¶" : ""}`);
            }
          }
          return lines.join("\n");
        }

        function getTotals(dayMeals) {
          return {
            calories: sum(dayMeals.map((m) => Number(m.calories) || 0)),
            protein: sum(dayMeals.map((m) => Number(m.protein) || 0)),
            carbs: sum(dayMeals.map((m) => Number(m.carbs) || 0)),
            fat: sum(dayMeals.map((m) => Number(m.fat) || 0)),
          };
        }

        function topIngredient(dayMeals) {
          const freq = new Map();
          for (const meal of dayMeals) {
            for (const ing of meal.ingredients) {
              const key = normalizeIngredient(ing).toLowerCase();
              if (!key) continue;
              freq.set(key, (freq.get(key) ?? 0) + 1);
            }
          }
          let best = null;
          for (const [k, v] of freq.entries()) {
            if (!best || v > best.count) best = { name: k, count: v };
          }
          if (!best) return "‚Äî";
          return best.name.replace(/(^\w)|(\s\w)/g, (m) => m.toUpperCase());
        }

        function withinDay(meal, dateIso) {
          return meal.date === dateIso;
        }

        function parseIngredientsInput(raw) {
          return String(raw)
            .split(",")
            .map(normalizeIngredient)
            .filter(Boolean);
        }

        function setDataMenu(open) {
          const menu = $("dataMenu");
          menu.classList.toggle("hidden", !open);
          if (open) {
            const onClickAway = (e) => {
              if (!menu.contains(e.target) && e.target !== $("dataBtn")) setDataMenu(false);
            };
            const onEsc = (e) => {
              if (e.key === "Escape") setDataMenu(false);
            };
            window.addEventListener("mousedown", onClickAway, { once: true });
            window.addEventListener("keydown", onEsc, { once: true });
          }
        }

        function setSettingsOpen(open) {
          $("settingsOverlay").classList.toggle("hidden", !open);
          if (open) {
            $("goalCalories").focus();
          } else {
            $("settingsBtn").focus();
          }
        }

        function renderIngredientsChips(ingredients, onRemove) {
          const wrap = $("ingredientChips");
          wrap.innerHTML = "";
          if (!ingredients.length) return;
          for (const ing of ingredients) {
            const chip = document.createElement("span");
            chip.className =
              "chip border border-slate-200 bg-white text-slate-700 shadow-sm dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200";
            chip.innerHTML = `<span>${escapeHtml(ing)}</span>`;
            const btn = document.createElement("button");
            btn.className = "focus-ring border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800";
            btn.type = "button";
            btn.setAttribute("aria-label", `Remove ${ing}`);
            btn.textContent = "‚úï";
            btn.addEventListener("click", () => onRemove(ing));
            chip.appendChild(btn);
            wrap.appendChild(chip);
          }
        }

        function renderSuggestions() {
          const box = $("suggestions");
          box.innerHTML = "";
          for (const s of MEAL_SUGGESTIONS) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "focus-ring rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800";
            btn.textContent = `${s.name}`;
            btn.addEventListener("click", () => {
              $("mealName").value = s.name;
              $("mealCalories").value = String(s.calories);
              $("mealProtein").value = String(s.protein);
              $("mealCarbs").value = String(s.carbs);
              $("mealFat").value = String(s.fat);
              state.ingredientDraft = [...s.ingredients];
              renderIngredientsChips(state.ingredientDraft, removeIngredientDraft);
              box.classList.add("hidden");
              $("mealName").focus();
              toast("Suggestion applied", { icon: "‚ú®", sub: "Tweak ingredients or macros before saving." });
            });
            box.appendChild(btn);
          }
        }

        function renderMealsList(dayMeals, query, sortMode) {
          const list = $("mealsList");
          list.innerHTML = "";

          const q = normalizeIngredient(query).toLowerCase();
          let filtered = dayMeals;
          if (q) {
            filtered = dayMeals.filter((m) => {
              const hay = `${m.name} ${m.ingredients.join(" ")} ${m.notes}`.toLowerCase();
              return hay.includes(q);
            });
          }

          const sorted = [...filtered].sort((a, b) => {
            if (sortMode === "calories") return (b.calories || 0) - (a.calories || 0);
            const ta = a.time || "99:99";
            const tb = b.time || "99:99";
            return ta.localeCompare(tb);
          });

          $("emptyState").classList.toggle("hidden", dayMeals.length !== 0);
          $("listSub").textContent = q ? `Showing ${sorted.length} match${sorted.length === 1 ? "" : "es"} for ‚Äú${query}‚Äù.` : "Everything you logged shows up here.";

          if (!sorted.length) {
            if (q) {
              const empty = document.createElement("div");
              empty.className =
                "rounded-2xl border border-dashed border-slate-300 bg-slate-50 p-6 text-center text-sm text-slate-600 dark:border-slate-700 dark:bg-slate-950/40 dark:text-slate-300";
              empty.innerHTML = `No matches for <span class="font-semibold">${escapeHtml(query)}</span>.`;
              list.appendChild(empty);
            }
            return;
          }

          for (const meal of sorted) {
            const card = document.createElement("article");
            card.className =
              "rounded-2xl border border-slate-200 bg-white p-4 shadow-sm transition hover:shadow-soft dark:border-slate-800 dark:bg-slate-950/30 dark:hover:shadow-softDark";

            const icon = foodIconFor(meal);
            const calories = Math.max(0, Number(meal.calories) || 0);
            const protein = Math.max(0, Number(meal.protein) || 0);
            const carbs = Math.max(0, Number(meal.carbs) || 0);
            const fat = Math.max(0, Number(meal.fat) || 0);

            const ingHtml =
              meal.ingredients.length === 0
                ? `<span class="text-xs text-slate-500 dark:text-slate-400">No ingredients listed</span>`
                : meal.ingredients
                    .slice(0, 10)
                    .map(
                      (ing) =>
                        `<span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-2 py-0.5 text-xs text-slate-700 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200">${escapeHtml(
                          ing
                        )}</span>`
                    )
                    .join(" ");

            const notesHtml = meal.notes
              ? `<div class="mt-2 rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs text-slate-700 dark:border-slate-800 dark:bg-slate-950/40 dark:text-slate-200"><span class="font-semibold">Notes:</span> ${escapeHtml(
                  meal.notes
                )}</div>`
              : "";

            card.innerHTML = `
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="flex items-center gap-2">
                    <div class="grid h-10 w-10 place-items-center rounded-2xl bg-slate-900 text-white dark:bg-white dark:text-slate-900" aria-hidden="true">${icon}</div>
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        <p class="truncate text-sm font-semibold">${escapeHtml(meal.name)}</p>
                        <span class="rounded-full bg-brand-100 px-2 py-0.5 text-xs font-semibold text-brand-800 dark:bg-brand-900/40 dark:text-brand-200">${Math.round(
                          calories
                        )} kcal</span>
                      </div>
                      <p class="text-xs text-slate-600 dark:text-slate-300">${meal.time ? escapeHtml(meal.time) : "Time not set"} ¬∑ P ${Math.round(
                        protein
                      )}g ¬∑ C ${Math.round(carbs)}g ¬∑ F ${Math.round(fat)}g</p>
                    </div>
                  </div>
                  <div class="mt-3 flex flex-wrap gap-2">
                    ${ingHtml}
                    ${meal.ingredients.length > 10 ? `<span class="text-xs text-slate-500 dark:text-slate-400">+${meal.ingredients.length - 10} more</span>` : ""}
                  </div>
                  ${notesHtml}
                </div>
                <div class="flex shrink-0 flex-col items-end gap-2">
                  <div class="flex items-center gap-2">
                    <button data-action="edit" class="focus-ring inline-flex h-9 items-center justify-center rounded-xl border border-slate-200 bg-white px-3 text-xs font-semibold text-slate-800 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button">Edit</button>
                    <button data-action="dup" class="focus-ring inline-flex h-9 items-center justify-center rounded-xl border border-slate-200 bg-white px-3 text-xs font-semibold text-slate-800 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200 dark:hover:bg-slate-800" type="button">Duplicate</button>
                  </div>
                  <button data-action="del" class="focus-ring inline-flex h-9 items-center justify-center rounded-xl border border-rose-200 bg-rose-50 px-3 text-xs font-semibold text-rose-800 hover:bg-rose-100 dark:border-rose-900/50 dark:bg-rose-950/30 dark:text-rose-200 dark:hover:bg-rose-950/45" type="button">Delete</button>
                </div>
              </div>
            `;

            card.querySelector('[data-action="edit"]').addEventListener("click", () => startEditMeal(meal.id));
            card.querySelector('[data-action="dup"]').addEventListener("click", () => duplicateMeal(meal.id));
            card.querySelector('[data-action="del"]').addEventListener("click", () => deleteMeal(meal.id));
            list.appendChild(card);
          }
        }

        function updateProgressBar(el, ratio, colorClasses) {
          el.style.width = `${Math.round(clamp01(ratio) * 100)}%`;
          if (colorClasses) el.className = el.className.split(" ").filter((c) => !c.startsWith("bg-")).join(" ") + " " + colorClasses;
        }

        function setEditMode(on) {
          $("resetFormBtn").classList.toggle("hidden", !on);
          $("formTitle").textContent = on ? "Edit meal" : "Log a meal";
          $("submitLabel").textContent = on ? "Save changes" : "Add meal";
          $("submitIcon").textContent = on ? "‚úÖ" : "‚ûï";
        }

        function resetForm() {
          state.editingId = null;
          state.ingredientDraft = [];
          setEditMode(false);
          $("mealForm").reset();
          $("mealTime").value = nowTime();
          renderIngredientsChips(state.ingredientDraft, removeIngredientDraft);
        }

        function removeIngredientDraft(ing) {
          state.ingredientDraft = state.ingredientDraft.filter((x) => x !== ing);
          renderIngredientsChips(state.ingredientDraft, removeIngredientDraft);
        }

        function addIngredientsFromInput() {
          const raw = $("ingredientInput").value;
          const list = parseIngredientsInput(raw);
          if (!list.length) return;

          const existing = new Set(state.ingredientDraft.map((x) => x.toLowerCase()));
          for (const ing of list) {
            const key = ing.toLowerCase();
            if (existing.has(key)) continue;
            state.ingredientDraft.push(ing);
            existing.add(key);
          }
          $("ingredientInput").value = "";
          renderIngredientsChips(state.ingredientDraft, removeIngredientDraft);
        }

        function getDayMeals() {
          return state.meals.filter((m) => withinDay(m, state.selectedDate));
        }

        function renderSummary() {
          const dayMeals = getDayMeals().sort((a, b) => (a.time || "99:99").localeCompare(b.time || "99:99"));
          const totals = getTotals(dayMeals);
          const s = state.settings;

          $("summaryDateLabel").textContent = formatPrettyDate(state.selectedDate);

          $("totalCalories").textContent = String(Math.round(totals.calories));
          $("calGoalLabel").textContent = `/ ${Math.round(s.calorieGoal)}`;
          const calRatio = s.calorieGoal > 0 ? totals.calories / s.calorieGoal : 0;
          updateProgressBar($("calProgress"), calRatio);
          $("calHint").textContent = `${Math.round(clamp01(calRatio) * 100)}% of your goal`;

          $("totalProtein").textContent = `${Math.round(totals.protein)}g`;
          $("totalCarbs").textContent = `${Math.round(totals.carbs)}g`;
          $("totalFat").textContent = `${Math.round(totals.fat)}g`;

          $("proteinGoalLabel").textContent = `/ ${Math.round(s.proteinGoal)}g`;
          $("carbGoalLabel").textContent = `/ ${Math.round(s.carbGoal)}g`;
          $("fatGoalLabel").textContent = `/ ${Math.round(s.fatGoal)}g`;

          updateProgressBar($("proteinProgress"), s.proteinGoal > 0 ? totals.protein / s.proteinGoal : 0);
          updateProgressBar($("carbProgress"), s.carbGoal > 0 ? totals.carbs / s.carbGoal : 0);
          updateProgressBar($("fatProgress"), s.fatGoal > 0 ? totals.fat / s.fatGoal : 0);

          $("mealCount").textContent = String(dayMeals.length);
          $("avgPerMeal").textContent = dayMeals.length ? `${Math.round(totals.calories / dayMeals.length)} kcal` : "0 kcal";
          $("topIngredient").textContent = topIngredient(dayMeals);

          if (!dayMeals.length) {
            $("summarySub").textContent = "No meals yet ‚Äî add one to start tracking your day.";
          } else {
            const left = Math.round(s.calorieGoal - totals.calories);
            $("summarySub").textContent =
              s.calorieGoal > 0 ? (left >= 0 ? `${left} kcal remaining to hit your goal.` : `${Math.abs(left)} kcal over your goal.`) : "Set a calorie goal for progress hints.";
          }

          updateCharts(dayMeals, totals);
          renderMealsList(dayMeals, state.searchQuery, state.ui.sortMode);
        }

        let caloriesChart = null;
        let macrosChart = null;

        function chartThemeColors() {
          const dark = document.documentElement.classList.contains("dark");
          return {
            grid: dark ? "rgba(148, 163, 184, 0.12)" : "rgba(148, 163, 184, 0.25)",
            ticks: dark ? "rgba(226, 232, 240, 0.75)" : "rgba(15, 23, 42, 0.65)",
            tooltipBg: dark ? "rgba(15, 23, 42, 0.95)" : "rgba(255, 255, 255, 0.98)",
            tooltipText: dark ? "rgba(226, 232, 240, 0.95)" : "rgba(15, 23, 42, 0.9)",
          };
        }

        function initCharts() {
          const calCtx = $("caloriesChart");
          const macCtx = $("macrosChart");
          const colors = chartThemeColors();

          caloriesChart = new Chart(calCtx, {
            type: "bar",
            data: { labels: [], datasets: [{ label: "Calories", data: [], backgroundColor: "rgba(30, 171, 96, 0.85)", borderRadius: 10 }] },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: colors.tooltipBg,
                  titleColor: colors.tooltipText,
                  bodyColor: colors.tooltipText,
                  borderColor: "rgba(148, 163, 184, 0.25)",
                  borderWidth: 1,
                },
              },
              scales: {
                x: {
                  grid: { display: false },
                  ticks: { color: colors.ticks, maxRotation: 0, autoSkip: true },
                },
                y: {
                  grid: { color: colors.grid },
                  ticks: { color: colors.ticks, precision: 0 },
                },
              },
            },
          });

          macrosChart = new Chart(macCtx, {
            type: "doughnut",
            data: {
              labels: ["Protein", "Carbs", "Fat"],
              datasets: [
                {
                  data: [0, 0, 0],
                  backgroundColor: ["rgba(14, 165, 233, 0.9)", "rgba(245, 158, 11, 0.9)", "rgba(244, 63, 94, 0.9)"],
                  borderWidth: 0,
                  hoverOffset: 6,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "64%",
              plugins: {
                legend: { position: "bottom", labels: { color: colors.ticks, boxWidth: 12, usePointStyle: true, pointStyle: "circle" } },
                tooltip: {
                  backgroundColor: colors.tooltipBg,
                  titleColor: colors.tooltipText,
                  bodyColor: colors.tooltipText,
                  borderColor: "rgba(148, 163, 184, 0.25)",
                  borderWidth: 1,
                  callbacks: {
                    label: (ctx) => {
                      const label = ctx.label ?? "";
                      const v = Number(ctx.raw) || 0;
                      return `${label}: ${Math.round(v)}g`;
                    },
                  },
                },
              },
            },
          });
        }

        function updateCharts(dayMeals, totals) {
          if (!caloriesChart || !macrosChart) return;
          const colors = chartThemeColors();

          const labels = dayMeals.map((m) => (m.time ? m.time : "‚Äî"));
          const data = dayMeals.map((m) => Math.max(0, Number(m.calories) || 0));
          caloriesChart.data.labels = labels.length ? labels : ["‚Äî"];
          caloriesChart.data.datasets[0].data = labels.length ? data : [0];
          caloriesChart.options.scales.y.grid.color = colors.grid;
          caloriesChart.options.scales.y.ticks.color = colors.ticks;
          caloriesChart.options.scales.x.ticks.color = colors.ticks;
          caloriesChart.options.plugins.tooltip.backgroundColor = colors.tooltipBg;
          caloriesChart.options.plugins.tooltip.titleColor = colors.tooltipText;
          caloriesChart.options.plugins.tooltip.bodyColor = colors.tooltipText;
          caloriesChart.update();

          macrosChart.data.datasets[0].data = [totals.protein, totals.carbs, totals.fat];
          macrosChart.options.plugins.legend.labels.color = colors.ticks;
          macrosChart.options.plugins.tooltip.backgroundColor = colors.tooltipBg;
          macrosChart.options.plugins.tooltip.titleColor = colors.tooltipText;
          macrosChart.options.plugins.tooltip.bodyColor = colors.tooltipText;
          macrosChart.update();
        }

        function startEditMeal(id) {
          const meal = state.meals.find((m) => m.id === id);
          if (!meal) return;
          state.editingId = id;
          setEditMode(true);
          $("mealName").value = meal.name;
          $("mealTime").value = meal.time || nowTime();
          $("mealCalories").value = String(meal.calories ?? 0);
          $("mealProtein").value = String(meal.protein ?? 0);
          $("mealCarbs").value = String(meal.carbs ?? 0);
          $("mealFat").value = String(meal.fat ?? 0);
          $("mealNotes").value = meal.notes ?? "";
          state.ingredientDraft = [...(meal.ingredients ?? [])];
          renderIngredientsChips(state.ingredientDraft, removeIngredientDraft);
          $("mealName").focus();
          toast("Editing meal", { icon: "‚úèÔ∏è", sub: "Save changes or Reset to cancel." });
        }

        function duplicateMeal(id) {
          const meal = state.meals.find((m) => m.id === id);
          if (!meal) return;
          const copy = {
            ...meal,
            id: uid(),
            time: nowTime(),
            createdAt: Date.now(),
            updatedAt: Date.now(),
          };
          state.meals.push(copy);
          saveMeals(state.meals);
          renderSummary();
          toast("Meal duplicated", { icon: "üß©", sub: "A copy was added with the current time." });
        }

        function deleteMeal(id) {
          const idx = state.meals.findIndex((m) => m.id === id);
          if (idx === -1) return;
          const [removed] = state.meals.splice(idx, 1);
          saveMeals(state.meals);
          renderSummary();
          toast("Meal deleted", {
            icon: "üóëÔ∏è",
            sub: removed?.name ? removed.name : undefined,
            actionLabel: "Undo",
            action: () => {
              state.meals.push(removed);
              saveMeals(state.meals);
              renderSummary();
              toast("Restored", { icon: "‚Ü©Ô∏è", timeoutMs: 2000 });
            },
          });
        }

        function clearDay(dateIso) {
          const before = state.meals.slice();
          const remaining = state.meals.filter((m) => !withinDay(m, dateIso));
          if (remaining.length === state.meals.length) {
            toast("Nothing to clear", { icon: "üßπ", timeoutMs: 2200 });
            return;
          }
          state.meals = remaining;
          saveMeals(state.meals);
          renderSummary();
          toast("Day cleared", {
            icon: "üßπ",
            sub: formatPrettyDate(dateIso),
            actionLabel: "Undo",
            action: () => {
              state.meals = before;
              saveMeals(state.meals);
              renderSummary();
            },
          });
        }

        function exportMeals() {
          const payload = {
            app: "Healthy Meal Tracker",
            version: 1,
            exportedAt: new Date().toISOString(),
            settings: state.settings,
            meals: state.meals,
          };
          const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `healthy-meal-tracker-${todayISO()}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          toast("Export started", { icon: "‚¨áÔ∏è", sub: "Downloaded as JSON." });
        }

        async function importMeals(file) {
          const text = await file.text();
          const parsed = safeJsonParse(text, null);
          if (!parsed || typeof parsed !== "object") throw new Error("Invalid JSON");
          const incomingMeals = Array.isArray(parsed.meals) ? parsed.meals : Array.isArray(parsed) ? parsed : null;
          if (!incomingMeals) throw new Error("No meals found");

          const normalized = incomingMeals
            .filter((m) => m && typeof m === "object")
            .map((m) => ({
              id: String(m.id ?? uid()),
              date: String(m.date ?? ""),
              time: String(m.time ?? ""),
              name: String(m.name ?? ""),
              calories: Number.isFinite(Number(m.calories)) ? Number(m.calories) : 0,
              protein: Number.isFinite(Number(m.protein)) ? Number(m.protein) : 0,
              carbs: Number.isFinite(Number(m.carbs)) ? Number(m.carbs) : 0,
              fat: Number.isFinite(Number(m.fat)) ? Number(m.fat) : 0,
              ingredients: Array.isArray(m.ingredients) ? m.ingredients.map(String).filter(Boolean) : [],
              notes: String(m.notes ?? ""),
              createdAt: Number.isFinite(Number(m.createdAt)) ? Number(m.createdAt) : Date.now(),
              updatedAt: Number.isFinite(Number(m.updatedAt)) ? Number(m.updatedAt) : Date.now(),
            }))
            .filter((m) => m.date && m.name);

          const existing = new Map(state.meals.map((m) => [m.id, m]));
          for (const m of normalized) existing.set(m.id, m);
          state.meals = Array.from(existing.values());
          saveMeals(state.meals);

          if (parsed.settings && typeof parsed.settings === "object") {
            state.settings = {
              ...state.settings,
              calorieGoal: Number.isFinite(Number(parsed.settings.calorieGoal)) ? Number(parsed.settings.calorieGoal) : state.settings.calorieGoal,
              proteinGoal: Number.isFinite(Number(parsed.settings.proteinGoal)) ? Number(parsed.settings.proteinGoal) : state.settings.proteinGoal,
              carbGoal: Number.isFinite(Number(parsed.settings.carbGoal)) ? Number(parsed.settings.carbGoal) : state.settings.carbGoal,
              fatGoal: Number.isFinite(Number(parsed.settings.fatGoal)) ? Number(parsed.settings.fatGoal) : state.settings.fatGoal,
            };
            saveSettings(state.settings);
          }

          renderSummary();
          toast("Import complete", { icon: "‚¨ÜÔ∏è", sub: `Loaded ${normalized.length} meal${normalized.length === 1 ? "" : "s"}.` });
        }

        function clearAllData() {
          const beforeMeals = state.meals.slice();
          const beforeSettings = { ...state.settings };
          localStorage.removeItem(STORAGE_KEY_MEALS);
          localStorage.removeItem(STORAGE_KEY_SETTINGS);
          state.meals = [];
          state.settings = { ...DEFAULT_SETTINGS };
          saveSettings(state.settings);
          renderSettingsForm();
          resetForm();
          renderSummary();
          toast("All data cleared", {
            icon: "üß®",
            actionLabel: "Undo",
            action: () => {
              state.meals = beforeMeals;
              state.settings = beforeSettings;
              saveMeals(state.meals);
              saveSettings(state.settings);
              renderSettingsForm();
              renderSummary();
            },
          });
        }

        function renderSettingsForm() {
          $("goalCalories").value = String(state.settings.calorieGoal);
          $("goalProtein").value = String(state.settings.proteinGoal);
          $("goalCarbs").value = String(state.settings.carbGoal);
          $("goalFat").value = String(state.settings.fatGoal);
          $("weekStartsOn").value = state.settings.weekStartsOn;
        }

        function seedDemoDay() {
          const date = state.selectedDate;
          const base = [
            { time: "07:45", name: "Overnight oats", calories: 420, protein: 18, carbs: 58, fat: 12, ingredients: ["oats", "milk", "banana", "peanut butter"] },
            { time: "12:20", name: "Chicken salad bowl", calories: 540, protein: 42, carbs: 28, fat: 22, ingredients: ["chicken", "leafy greens", "tomato", "cucumber", "olive oil"] },
            { time: "16:10", name: "Apple + nuts", calories: 260, protein: 6, carbs: 28, fat: 14, ingredients: ["apple", "nuts"] },
            { time: "19:05", name: "Salmon + veggies", calories: 610, protein: 40, carbs: 22, fat: 34, ingredients: ["salmon", "broccoli", "lemon", "olive oil"] },
          ];
          const beforeCount = state.meals.length;
          for (const b of base) {
            state.meals.push({
              id: uid(),
              date,
              time: b.time,
              name: b.name,
              calories: b.calories,
              protein: b.protein,
              carbs: b.carbs,
              fat: b.fat,
              ingredients: b.ingredients,
              notes: "",
              createdAt: Date.now(),
              updatedAt: Date.now(),
            });
          }
          saveMeals(state.meals);
          renderSummary();
          toast("Demo meals added", { icon: "üç±", sub: `Added ${state.meals.length - beforeCount} meals for ${formatPrettyDate(date)}.` });
        }

        async function copySummary() {
          const dayMeals = getDayMeals().sort((a, b) => (a.time || "99:99").localeCompare(b.time || "99:99"));
          const text = buildSummaryText(state.selectedDate, dayMeals, state.settings);
          try {
            await navigator.clipboard.writeText(text);
            toast("Summary copied", { icon: "üìã", sub: "Paste it into notes or messages." });
          } catch {
            // Fallback
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
            toast("Summary copied", { icon: "üìã", sub: "Clipboard fallback used." });
          }
        }

        const state = {
          meals: [],
          settings: { ...DEFAULT_SETTINGS },
          ui: loadUiState(),
          selectedDate: todayISO(),
          ingredientDraft: [],
          editingId: null,
          searchQuery: "",
        };

        function initUi() {
          // Theme
          const systemDark = window.matchMedia?.("(prefers-color-scheme: dark)");
          const savedTheme = state.ui.theme;
          if (savedTheme !== "system") setTheme(savedTheme);
          else setTheme("system");
          systemDark?.addEventListener?.("change", () => {
            if (state.ui.theme === "system") setTheme("system");
          });

          // Date
          $("datePicker").value = state.selectedDate;
          $("mealTime").value = nowTime();
          $("summaryDateLabel").textContent = formatPrettyDate(state.selectedDate);

          // Suggestions
          renderSuggestions();

          // Sort button
          const applySortUi = () => {
            const mode = state.ui.sortMode;
            $("sortLabel").textContent = mode === "time" ? "Time" : "Calories";
            $("sortIcon").textContent = mode === "time" ? "üïí" : "üî•";
          };
          applySortUi();

          // Data menu
          $("dataBtn").addEventListener("click", () => setDataMenu($("dataMenu").classList.contains("hidden")));

          // Theme toggle cycles system -> dark -> light -> system
          $("themeBtn").addEventListener("click", () => {
            const current = state.ui.theme;
            const next = current === "system" ? "dark" : current === "dark" ? "light" : "system";
            state.ui.theme = next;
            saveUiState(state.ui);
            setTheme(next);
            toast("Theme updated", { icon: "üéõÔ∏è", sub: next === "system" ? "Following system setting." : `Switched to ${next}.`, timeoutMs: 2200 });
            renderSummary();
          });

          $("todayBtn").addEventListener("click", () => {
            state.selectedDate = todayISO();
            $("datePicker").value = state.selectedDate;
            resetForm();
            renderSummary();
          });

          $("datePicker").addEventListener("change", (e) => {
            state.selectedDate = e.target.value || todayISO();
            resetForm();
            renderSummary();
          });

          $("settingsBtn").addEventListener("click", () => {
            renderSettingsForm();
            setSettingsOpen(true);
          });
          $("closeSettingsBtn").addEventListener("click", () => setSettingsOpen(false));
          $("settingsOverlay").addEventListener("click", (e) => {
            if (e.target === $("settingsOverlay").children[0]) setSettingsOpen(false);
          });
          window.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && !$("settingsOverlay").classList.contains("hidden")) setSettingsOpen(false);
          });

          $("settingsForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const next = {
              calorieGoal: Math.max(0, Number($("goalCalories").value) || 0),
              proteinGoal: Math.max(0, Number($("goalProtein").value) || 0),
              carbGoal: Math.max(0, Number($("goalCarbs").value) || 0),
              fatGoal: Math.max(0, Number($("goalFat").value) || 0),
              weekStartsOn: $("weekStartsOn").value === "sunday" ? "sunday" : "monday",
            };
            state.settings = next;
            saveSettings(state.settings);
            setSettingsOpen(false);
            renderSummary();
            toast("Goals saved", { icon: "üéØ", sub: "Progress bars updated." });
          });

          $("resetGoalsBtn").addEventListener("click", () => {
            state.settings = { ...DEFAULT_SETTINGS };
            saveSettings(state.settings);
            renderSettingsForm();
            renderSummary();
            toast("Goals reset", { icon: "‚Ü©Ô∏è", timeoutMs: 2200 });
          });

          // Export/Import/Clear
          $("exportBtn").addEventListener("click", () => {
            setDataMenu(false);
            exportMeals();
          });
          $("importInput").addEventListener("change", async (e) => {
            setDataMenu(false);
            const file = e.target.files?.[0];
            e.target.value = "";
            if (!file) return;
            try {
              await importMeals(file);
            } catch (err) {
              toast("Import failed", { icon: "‚ö†Ô∏è", sub: err?.message ? String(err.message) : "Invalid file." });
            }
          });
          $("clearAllBtn").addEventListener("click", () => {
            setDataMenu(false);
            const ok = confirm("Clear ALL meals and goals from this device?");
            if (ok) clearAllData();
          });

          // Search & sort
          $("searchInput").addEventListener("input", (e) => {
            state.searchQuery = e.target.value || "";
            renderSummary();
          });
          $("sortBtn").addEventListener("click", () => {
            state.ui.sortMode = state.ui.sortMode === "time" ? "calories" : "time";
            saveUiState(state.ui);
            applySortUi();
            renderSummary();
          });

          // Suggestions toggler
          $("suggestBtn").addEventListener("click", () => {
            $("suggestions").classList.toggle("hidden");
          });

          // Ingredient input handlers
          $("addIngredientBtn").addEventListener("click", () => addIngredientsFromInput());
          $("ingredientInput").addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              addIngredientsFromInput();
              return;
            }
            if (e.key === "," && !e.shiftKey) {
              // On comma, treat as separator
              window.setTimeout(() => addIngredientsFromInput(), 0);
            }
          });
          document.querySelectorAll(".quick-ingredient").forEach((btn) => {
            btn.addEventListener("click", () => {
              const v = btn.getAttribute("data-value") || "";
              if (!v) return;
              const key = v.toLowerCase();
              if (state.ingredientDraft.some((x) => x.toLowerCase() === key)) return;
              state.ingredientDraft.push(v);
              renderIngredientsChips(state.ingredientDraft, removeIngredientDraft);
            });
          });

          $("resetFormBtn").addEventListener("click", () => {
            resetForm();
            toast("Edit canceled", { icon: "‚Ü©Ô∏è", timeoutMs: 2200 });
          });

          // Form submit
          $("mealForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const name = normalizeIngredient($("mealName").value);
            const time = $("mealTime").value || "";
            const calories = Math.max(0, Number($("mealCalories").value) || 0);
            const protein = Math.max(0, Number($("mealProtein").value) || 0);
            const carbs = Math.max(0, Number($("mealCarbs").value) || 0);
            const fat = Math.max(0, Number($("mealFat").value) || 0);
            const notes = normalizeIngredient($("mealNotes").value);
            const ingredients = [...state.ingredientDraft];

            if (!name) return;
            if (!Number.isFinite(calories)) return;

            const now = Date.now();
            if (state.editingId) {
              const idx = state.meals.findIndex((m) => m.id === state.editingId);
              if (idx !== -1) {
                state.meals[idx] = {
                  ...state.meals[idx],
                  date: state.selectedDate,
                  time,
                  name,
                  calories,
                  protein,
                  carbs,
                  fat,
                  ingredients,
                  notes,
                  updatedAt: now,
                };
                saveMeals(state.meals);
                toast("Meal updated", { icon: "‚úÖ", sub: name });
              }
            } else {
              state.meals.push({
                id: uid(),
                date: state.selectedDate,
                time,
                name,
                calories,
                protein,
                carbs,
                fat,
                ingredients,
                notes,
                createdAt: now,
                updatedAt: now,
              });
              saveMeals(state.meals);
              toast("Meal added", { icon: "‚ûï", sub: name });
            }

            resetForm();
            renderSummary();
            $("mealName").focus();
          });

          $("demoBtn").addEventListener("click", () => seedDemoDay());
          $("clearDayBtn").addEventListener("click", () => {
            const ok = confirm(`Clear all meals for ${formatPrettyDate(state.selectedDate)}?`);
            if (ok) clearDay(state.selectedDate);
          });
          $("copySummaryBtn").addEventListener("click", () => copySummary());

          // Click-away for suggestions
          window.addEventListener("mousedown", (e) => {
            if (e.target === $("suggestBtn")) return;
            if ($("suggestions").contains(e.target)) return;
            $("suggestions").classList.add("hidden");
          });
        }

        function initData() {
          state.meals = loadMeals();
          state.settings = loadSettings();
          renderSettingsForm();
        }

        function init() {
          initData();
          initCharts();
          initUi();
          resetForm();
          renderSummary();
          toast("Ready", { icon: "ü•ó", sub: "Your data stays on this device (localStorage).", timeoutMs: 2400 });
        }

        document.addEventListener("DOMContentLoaded", init);
      })();
    </script>
  </body>
</html>
