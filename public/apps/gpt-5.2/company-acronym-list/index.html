<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>Company Acronym List</title>
    <style>
      :root {
        --bg: #0b1220;
        --surface: rgba(255, 255, 255, 0.06);
        --surface-2: rgba(255, 255, 255, 0.085);
        --card: rgba(255, 255, 255, 0.08);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.7);
        --faint: rgba(255, 255, 255, 0.55);
        --border: rgba(255, 255, 255, 0.12);
        --shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
        --shadow-soft: 0 14px 40px rgba(0, 0, 0, 0.32);
        --primary: #7c5cff;
        --primary-2: #3ad5ff;
        --good: #2dd4bf;
        --warn: #fbbf24;
        --bad: #fb7185;
        --radius: 16px;
        --radius-sm: 12px;
        --ring: 0 0 0 4px rgba(124, 92, 255, 0.25);
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
      }

      [data-theme="light"] {
        --bg: #f6f7fb;
        --surface: rgba(20, 30, 54, 0.05);
        --surface-2: rgba(20, 30, 54, 0.075);
        --card: rgba(255, 255, 255, 0.9);
        --text: rgba(10, 14, 22, 0.92);
        --muted: rgba(10, 14, 22, 0.72);
        --faint: rgba(10, 14, 22, 0.6);
        --border: rgba(10, 14, 22, 0.12);
        --shadow: 0 18px 60px rgba(10, 14, 22, 0.12);
        --shadow-soft: 0 14px 40px rgba(10, 14, 22, 0.1);
        --ring: 0 0 0 4px rgba(124, 92, 255, 0.2);
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          scroll-behavior: auto !important;
          transition: none !important;
          animation: none !important;
        }
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: var(--sans);
        background: radial-gradient(1200px 900px at 20% 10%, rgba(124, 92, 255, 0.25), transparent 55%),
          radial-gradient(900px 700px at 85% 30%, rgba(58, 213, 255, 0.2), transparent 55%),
          radial-gradient(900px 700px at 60% 95%, rgba(45, 212, 191, 0.16), transparent 55%), var(--bg);
        color: var(--text);
        line-height: 1.4;
      }

      a {
        color: inherit;
      }

      button,
      input,
      select,
      textarea {
        font: inherit;
        color: inherit;
      }

      ::selection {
        background: rgba(124, 92, 255, 0.35);
      }

      .app {
        min-height: 100%;
        display: flex;
        flex-direction: column;
      }

      .topbar {
        position: sticky;
        top: 0;
        z-index: 40;
        backdrop-filter: blur(14px);
        background: linear-gradient(to bottom, rgba(12, 18, 32, 0.92), rgba(12, 18, 32, 0.65));
        border-bottom: 1px solid var(--border);
      }
      [data-theme="light"] .topbar {
        background: linear-gradient(to bottom, rgba(246, 247, 251, 0.92), rgba(246, 247, 251, 0.7));
      }

      .topbar-inner {
        max-width: 1200px;
        margin: 0 auto;
        padding: 18px 18px 14px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 14px;
        align-items: start;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }

      .logo {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        background: radial-gradient(16px 16px at 25% 30%, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0)),
          linear-gradient(135deg, rgba(124, 92, 255, 0.9), rgba(58, 213, 255, 0.7));
        box-shadow: 0 16px 40px rgba(124, 92, 255, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      [data-theme="light"] .logo {
        border: 1px solid rgba(10, 14, 22, 0.1);
      }

      .brand h1 {
        margin: 0;
        font-size: 16px;
        letter-spacing: 0.2px;
        font-weight: 700;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .brand p {
        margin: 2px 0 0;
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .top-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 10px;
        flex-wrap: wrap;
      }

      .pill {
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 8px 10px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.12);
      }
      [data-theme="light"] .pill {
        box-shadow: 0 10px 26px rgba(10, 14, 22, 0.08);
      }

      .segmented {
        display: inline-flex;
        gap: 6px;
        padding: 6px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--surface);
      }

      .segmented button {
        border: 0;
        background: transparent;
        padding: 8px 10px;
        border-radius: 999px;
        font-weight: 650;
        color: var(--muted);
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease, color 120ms ease;
      }
      .segmented button[aria-selected="true"] {
        background: linear-gradient(135deg, rgba(124, 92, 255, 0.25), rgba(58, 213, 255, 0.14));
        color: var(--text);
        box-shadow: 0 10px 22px rgba(124, 92, 255, 0.12);
      }
      .segmented button:hover {
        transform: translateY(-1px);
      }

      .icon-btn {
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: 12px;
        padding: 10px 10px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      }
      .icon-btn:hover {
        transform: translateY(-1px);
        background: var(--surface-2);
        border-color: rgba(124, 92, 255, 0.35);
      }

      .icon {
        width: 18px;
        height: 18px;
        display: inline-block;
      }

      .kbd {
        font-family: var(--mono);
        font-size: 11px;
        padding: 2px 6px;
        border: 1px solid var(--border);
        border-bottom-color: rgba(0, 0, 0, 0.25);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.06);
        color: var(--faint);
      }
      [data-theme="light"] .kbd {
        background: rgba(10, 14, 22, 0.04);
        border-bottom-color: rgba(10, 14, 22, 0.16);
      }

      .searchbar {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 18px 16px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        align-items: center;
      }

      .search {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 12px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--border);
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.22);
      }
      [data-theme="light"] .search {
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 18px 50px rgba(10, 14, 22, 0.12);
      }

      .search input {
        width: 100%;
        background: transparent;
        border: 0;
        outline: none;
        font-size: 14px;
      }

      .search .hint {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--muted);
        white-space: nowrap;
        font-size: 12px;
      }

      .content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px 18px 40px;
        width: 100%;
        flex: 1;
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 16px;
        align-items: start;
      }

      .panel {
        position: sticky;
        top: 128px;
        border-radius: var(--radius);
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-soft);
        overflow: clip;
      }
      [data-theme="light"] .panel {
        background: rgba(255, 255, 255, 0.8);
      }

      .panel header {
        padding: 14px 14px 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(to bottom, rgba(255, 255, 255, 0.06), transparent);
      }
      [data-theme="light"] .panel header {
        background: linear-gradient(to bottom, rgba(124, 92, 255, 0.08), transparent);
      }

      .panel header h2 {
        margin: 0;
        font-size: 13px;
        font-weight: 750;
        letter-spacing: 0.2px;
      }

      .panel .body {
        padding: 12px 14px 14px;
        display: grid;
        gap: 12px;
      }

      .row {
        display: grid;
        gap: 8px;
      }

      .label {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .select,
      .toggle {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        padding: 10px 10px;
        outline: none;
      }
      [data-theme="light"] .select,
      [data-theme="light"] .toggle {
        background: rgba(10, 14, 22, 0.03);
      }

      .select:focus-visible,
      .toggle:focus-visible,
      .icon-btn:focus-visible,
      .segmented button:focus-visible,
      .chip:focus-visible,
      .btn:focus-visible,
      .item:focus-visible,
      .modal button:focus-visible,
      .modal input:focus-visible,
      .modal textarea:focus-visible {
        outline: none;
        box-shadow: var(--ring);
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .chip {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        border-radius: 999px;
        padding: 7px 10px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
        color: var(--muted);
        font-weight: 650;
        user-select: none;
      }
      [data-theme="light"] .chip {
        background: rgba(10, 14, 22, 0.02);
      }
      .chip[data-selected="true"] {
        background: linear-gradient(135deg, rgba(124, 92, 255, 0.24), rgba(58, 213, 255, 0.14));
        border-color: rgba(124, 92, 255, 0.42);
        color: var(--text);
        box-shadow: 0 12px 26px rgba(124, 92, 255, 0.13);
      }
      .chip:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.08);
      }

      .chip .dot {
        width: 8px;
        height: 8px;
        border-radius: 99px;
        background: rgba(255, 255, 255, 0.35);
      }
      .chip[data-selected="true"] .dot {
        background: rgba(58, 213, 255, 0.9);
      }

      .btn {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 10px 12px;
        cursor: pointer;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      }
      [data-theme="light"] .btn {
        background: rgba(10, 14, 22, 0.03);
      }
      .btn:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.09);
        border-color: rgba(124, 92, 255, 0.35);
      }
      .btn.primary {
        border-color: rgba(124, 92, 255, 0.45);
        background: linear-gradient(135deg, rgba(124, 92, 255, 0.38), rgba(58, 213, 255, 0.18));
        box-shadow: 0 18px 50px rgba(124, 92, 255, 0.18);
      }
      .btn.primary:hover {
        background: linear-gradient(135deg, rgba(124, 92, 255, 0.46), rgba(58, 213, 255, 0.22));
      }
      .btn.danger:hover {
        border-color: rgba(251, 113, 133, 0.55);
      }

      .small {
        font-size: 12px;
        color: var(--muted);
      }

      .main {
        display: grid;
        gap: 14px;
      }

      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }

      .stats {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--muted);
        font-size: 12px;
      }

      .items {
        display: grid;
        gap: 12px;
      }

      .item {
        text-align: left;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        box-shadow: 0 20px 55px rgba(0, 0, 0, 0.22);
        padding: 14px 14px 12px;
        cursor: pointer;
        transition: transform 140ms ease, background 140ms ease, border-color 140ms ease, box-shadow 140ms ease;
        display: grid;
        gap: 10px;
      }
      [data-theme="light"] .item {
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 18px 50px rgba(10, 14, 22, 0.1);
      }

      .item:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.085);
        border-color: rgba(124, 92, 255, 0.35);
        box-shadow: 0 26px 64px rgba(0, 0, 0, 0.32);
      }
      [data-theme="light"] .item:hover {
        box-shadow: 0 26px 64px rgba(10, 14, 22, 0.14);
      }

      .item-top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
      }

      .acronym {
        font-family: var(--mono);
        font-size: 18px;
        font-weight: 900;
        letter-spacing: 0.6px;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 8px;
        background: rgba(255, 255, 255, 0.05);
        color: var(--muted);
      }

      .badge strong {
        color: var(--text);
        font-weight: 800;
      }

      .definition {
        font-size: 14px;
        color: var(--text);
      }

      .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .tag {
        font-size: 11px;
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 5px 8px;
        background: rgba(255, 255, 255, 0.05);
        color: var(--muted);
      }
      .tag .hash {
        color: rgba(58, 213, 255, 0.85);
        font-weight: 800;
        margin-right: 2px;
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .star {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 9px 10px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      }
      .star:hover {
        transform: translateY(-1px);
        border-color: rgba(251, 191, 36, 0.55);
      }
      .star[data-on="true"] {
        border-color: rgba(251, 191, 36, 0.55);
        background: rgba(251, 191, 36, 0.12);
      }

      .highlight {
        background: rgba(58, 213, 255, 0.18);
        border: 1px solid rgba(58, 213, 255, 0.25);
        border-radius: 6px;
        padding: 0 3px;
      }

      .empty {
        border: 1px dashed var(--border);
        border-radius: var(--radius);
        padding: 18px;
        color: var(--muted);
        background: rgba(255, 255, 255, 0.03);
      }

      .footer {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px 18px 36px;
        color: var(--muted);
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      /* Quiz */
      .quiz {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: rgba(255, 255, 255, 0.06);
        box-shadow: var(--shadow);
        overflow: clip;
      }
      [data-theme="light"] .quiz {
        background: rgba(255, 255, 255, 0.88);
      }

      .quiz header {
        padding: 14px 14px 10px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(to bottom, rgba(255, 255, 255, 0.06), transparent);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .quiz header h2 {
        margin: 0;
        font-size: 14px;
        font-weight: 800;
        letter-spacing: 0.2px;
      }

      .progress {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--muted);
        font-size: 12px;
      }

      .bar {
        width: 120px;
        height: 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--border);
        overflow: hidden;
      }
      .bar > div {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, rgba(124, 92, 255, 0.85), rgba(58, 213, 255, 0.85));
      }

      .quiz .body {
        padding: 14px;
        display: grid;
        gap: 12px;
      }

      .question {
        border: 1px solid var(--border);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.05);
        padding: 14px;
        display: grid;
        gap: 10px;
      }

      .prompt {
        font-size: 12px;
        color: var(--muted);
      }

      .prompt strong {
        color: var(--text);
        font-weight: 850;
      }

      .qtext {
        font-family: var(--mono);
        font-size: 18px;
        font-weight: 900;
        letter-spacing: 0.4px;
      }

      .choices {
        display: grid;
        gap: 10px;
      }

      .choice {
        width: 100%;
        text-align: left;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      }
      .choice:hover {
        transform: translateY(-1px);
        border-color: rgba(58, 213, 255, 0.35);
      }
      .choice[data-state="correct"] {
        border-color: rgba(45, 212, 191, 0.55);
        background: rgba(45, 212, 191, 0.12);
      }
      .choice[data-state="wrong"] {
        border-color: rgba(251, 113, 133, 0.55);
        background: rgba(251, 113, 133, 0.1);
      }

      .answer {
        display: grid;
        gap: 10px;
      }

      .answer input {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.05);
        padding: 12px 12px;
        outline: none;
      }

      .feedback {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px 12px;
        background: rgba(255, 255, 255, 0.05);
        display: grid;
        gap: 6px;
      }

      .feedback .line {
        display: flex;
        gap: 10px;
        align-items: baseline;
        flex-wrap: wrap;
      }

      .feedback .pilltag {
        font-size: 11px;
        padding: 5px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        color: var(--muted);
      }

      .feedback .pilltag.good {
        border-color: rgba(45, 212, 191, 0.55);
        background: rgba(45, 212, 191, 0.12);
      }
      .feedback .pilltag.bad {
        border-color: rgba(251, 113, 133, 0.55);
        background: rgba(251, 113, 133, 0.1);
      }

      .result-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
      }
      .statbox {
        border: 1px solid var(--border);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.05);
        padding: 12px;
      }
      .statbox .k {
        color: var(--muted);
        font-size: 12px;
      }
      .statbox .v {
        margin-top: 4px;
        font-size: 18px;
        font-weight: 850;
        letter-spacing: 0.2px;
      }

      /* Modal */
      .backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(10px);
        z-index: 60;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }
      .backdrop[data-open="true"] {
        display: flex;
      }
      .modal {
        width: min(720px, 100%);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: rgba(15, 20, 33, 0.92);
        box-shadow: var(--shadow);
        overflow: clip;
      }
      [data-theme="light"] .modal {
        background: rgba(255, 255, 255, 0.92);
      }
      .modal header {
        padding: 14px 14px 10px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .modal header h3 {
        margin: 0;
        font-size: 14px;
        font-weight: 850;
      }
      .modal .body {
        padding: 14px;
        display: grid;
        gap: 12px;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .field {
        display: grid;
        gap: 7px;
      }
      .field label {
        font-size: 12px;
        color: var(--muted);
      }
      .field input,
      .field textarea,
      .field select {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.06);
        padding: 10px 10px;
        outline: none;
      }
      [data-theme="light"] .field input,
      [data-theme="light"] .field textarea,
      [data-theme="light"] .field select {
        background: rgba(10, 14, 22, 0.03);
      }
      .field textarea {
        min-height: 90px;
        resize: vertical;
      }
      .modal footer {
        padding: 12px 14px 14px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }

      /* Toast */
      .toasts {
        position: fixed;
        right: 16px;
        bottom: 16px;
        z-index: 80;
        display: grid;
        gap: 10px;
      }
      .toast {
        width: min(420px, calc(100vw - 32px));
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(15, 20, 33, 0.92);
        box-shadow: var(--shadow-soft);
        padding: 10px 12px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }
      [data-theme="light"] .toast {
        background: rgba(255, 255, 255, 0.92);
      }
      .toast .t {
        font-weight: 800;
        font-size: 12px;
      }
      .toast .m {
        color: var(--muted);
        font-size: 12px;
        margin-top: 2px;
      }

      /* Mobile */
      .mobile-only {
        display: none;
      }

      @media (max-width: 980px) {
        .content {
          grid-template-columns: 1fr;
        }
        .panel {
          position: relative;
          top: auto;
          display: none;
        }
        .mobile-only {
          display: inline-flex;
        }
      }

      @media (max-width: 520px) {
        .topbar-inner {
          grid-template-columns: 1fr;
        }
        .searchbar {
          grid-template-columns: 1fr;
        }
        .brand p {
          display: none;
        }
        .grid2 {
          grid-template-columns: 1fr;
        }
        .result-grid {
          grid-template-columns: 1fr;
        }
        .bar {
          width: 100px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app" id="app">
      <div class="topbar">
        <div class="topbar-inner">
          <div class="brand" aria-label="Company Acronym List">
            <div class="logo" aria-hidden="true"></div>
            <div style="min-width: 0">
              <h1>Company Acronym List</h1>
              <p id="subtitle">Search, filter by tags, and quiz yourself</p>
            </div>
          </div>
          <div class="top-actions">
            <div class="segmented" role="tablist" aria-label="Views">
              <button id="tabLibrary" role="tab" aria-selected="true" aria-controls="viewLibrary">Library</button>
              <button id="tabQuiz" role="tab" aria-selected="false" aria-controls="viewQuiz">Quiz</button>
            </div>
            <button class="icon-btn mobile-only" id="btnFilters" type="button" title="Filters">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path
                  d="M10 18h4m-7-6h10M5 6h14"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              Filters
            </button>
            <button class="icon-btn" id="btnHelp" type="button" title="Help">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path
                  d="M12 17h.01M12 14a4 4 0 1 0-4-4"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
                <path
                  d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10Z"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
            </button>
            <button class="icon-btn" id="btnTheme" type="button" title="Theme">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path
                  d="M21 12.8A8.5 8.5 0 1 1 11.2 3a6.5 6.5 0 0 0 9.8 9.8Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linejoin="round"
                />
              </svg>
              <span id="themeLabel" class="small">System</span>
            </button>
          </div>
        </div>

        <div class="searchbar">
          <div class="search" role="search">
            <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path
                d="M21 21l-4.3-4.3m1.8-5.2a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
            <input id="searchInput" type="search" placeholder="Search acronyms, definitions, tags… (e.g., “OKR”, “oncall”, “security”)" autocomplete="off" />
            <div class="hint" aria-hidden="true"><span class="kbd">/</span> focus</div>
          </div>
          <div class="pill" aria-label="Quick actions">
            <button class="btn" id="btnAdd" type="button" title="Add an acronym">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
              Add
            </button>
            <button class="btn" id="btnReset" type="button" title="Reset filters and search">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path
                  d="M21 12a9 9 0 1 1-3-6.7M21 3v6h-6"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Reset
            </button>
          </div>
        </div>
      </div>

      <main class="content" aria-live="polite">
        <aside class="panel" id="filtersPanel" aria-label="Filters">
          <header>
            <h2>Filters</h2>
            <span class="small" id="filterSummary">—</span>
          </header>
          <div class="body">
            <div class="row">
              <div class="label">
                <span>Sort</span>
              </div>
              <select class="select" id="sortSelect">
                <option value="relevance">Relevance</option>
                <option value="az">A → Z</option>
                <option value="za">Z → A</option>
                <option value="mostSeen">Most viewed</option>
                <option value="leastKnown">Least known</option>
              </select>
            </div>
            <div class="row">
              <div class="label">
                <span>Scope</span>
              </div>
              <select class="select" id="scopeSelect">
                <option value="all">All acronyms</option>
                <option value="favorites">Starred only</option>
                <option value="custom">Custom only</option>
              </select>
            </div>

            <div class="row">
              <div class="label">
                <span>Tags</span>
                <button class="btn" id="btnClearTags" type="button" style="padding: 6px 10px">Clear</button>
              </div>
              <div class="chips" id="tagChips"></div>
              <div class="small">Tip: select multiple tags to narrow results.</div>
            </div>

            <div class="row" id="quizSettingsRow">
              <div class="label"><span>Quiz settings</span></div>
              <select class="select" id="quizModeSelect" title="Quiz format">
                <option value="mc">Multiple choice</option>
                <option value="type">Type answer</option>
              </select>
              <select class="select" id="quizDirectionSelect" title="What to ask">
                <option value="a2d">Acronym → Definition</option>
                <option value="d2a">Definition → Acronym</option>
                <option value="mixed">Mixed</option>
              </select>
              <select class="select" id="quizCountSelect" title="Questions per quiz">
                <option value="5">5 questions</option>
                <option value="10" selected>10 questions</option>
                <option value="15">15 questions</option>
                <option value="20">20 questions</option>
              </select>
              <button class="btn primary" id="btnStartQuiz" type="button">
                <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path
                    d="M8 5v14l12-7-12-7Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linejoin="round"
                  />
                </svg>
                Start quiz
              </button>
              <div class="small" id="quizHint">Uses current search + tag filters.</div>
            </div>

            <div class="row">
              <div class="label"><span>Data</span></div>
              <button class="btn" id="btnManage" type="button">
                <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path
                    d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                  <path
                    d="M19.4 15a7.7 7.7 0 0 0 .1-6l2-1.2-2-3.5-2.4 1a7.8 7.8 0 0 0-5.2-2.9L11.5 0h-4l-.4 2.4A7.8 7.8 0 0 0 2 5.3l-2.4-1L-2.4 7.8l2 1.2a7.7 7.7 0 0 0 0 6l-2 1.2 2 3.5 2.4-1a7.8 7.8 0 0 0 5.2 2.9L7.5 24h4l.4-2.4a7.8 7.8 0 0 0 5.1-2.9l2.4 1 2-3.5-2-1.2Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linejoin="round"
                    opacity="0.5"
                  />
                </svg>
                Import / export
              </button>
              <button class="btn danger" id="btnResetStats" type="button" title="Resets quiz and view stats">
                <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path
                    d="M3 6h18M8 6V4h8v2m-1 0v16a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2V6"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                Reset stats
              </button>
            </div>
          </div>
        </aside>

        <section class="main">
          <div id="viewLibrary" role="tabpanel" aria-labelledby="tabLibrary">
            <div class="toolbar">
              <div class="stats">
                <span id="countLabel">—</span>
                <span aria-hidden="true">•</span>
                <span id="tagLabel">—</span>
              </div>
              <div class="stats">
                <span class="kbd">g</span><span class="kbd">l</span><span class="small">Library</span>
                <span class="kbd">g</span><span class="kbd">q</span><span class="small">Quiz</span>
              </div>
            </div>
            <div class="items" id="items"></div>
            <div class="empty" id="emptyState" hidden>
              <strong>No matches.</strong>
              <div class="small" style="margin-top: 6px">
                Try fewer tags, clear the search, or add your own acronym.
              </div>
            </div>
          </div>

          <div id="viewQuiz" role="tabpanel" aria-labelledby="tabQuiz" hidden>
            <div class="quiz" id="quizCard">
              <header>
                <h2>Quiz mode</h2>
                <div class="progress">
                  <span id="quizProgressText">Not started</span>
                  <div class="bar" aria-hidden="true"><div id="quizProgressBar"></div></div>
                </div>
              </header>
              <div class="body" id="quizBody">
                <div class="empty">
                  <strong>Ready when you are.</strong>
                  <div class="small" style="margin-top: 6px">
                    Use the filters on the left (or the Filters button on mobile), then click “Start quiz”.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>

      <div class="footer">
        <div>
          Built for quick recall: search, tag filters, and a quiz that focuses on the acronyms you miss most.
        </div>
        <div class="small">
          Local-only: custom acronyms and stats stay in your browser (<span class="kbd">?</span> for help).
        </div>
      </div>

      <!-- Modals -->
      <div class="backdrop" id="modalBackdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
          <header>
            <h3 id="modalTitle">Modal</h3>
            <button class="icon-btn" id="modalClose" type="button" title="Close">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </button>
          </header>
          <div class="body" id="modalBody"></div>
          <footer id="modalFooter"></footer>
        </div>
      </div>

      <div class="toasts" id="toasts" aria-live="polite" aria-relevant="additions"></div>
    </div>

    <script>
      (() => {
        "use strict";

        const STORAGE = {
          prefs: "cal.prefs.v1",
          custom: "cal.custom.v1",
          stats: "cal.stats.v1",
          views: "cal.views.v1",
        };

        const ICONS = {
          star: `<svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 17.3l-5.2 3 1.4-5.9L3.5 10l6.1-.5L12 4l2.4 5.5 6.1.5-4.7 4.4 1.4 5.9-5.2-3Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>`,
          pencil: `<svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
          trash: `<svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M8 6V4h8v2m-1 0v14a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
        };

        const SEED = [
          {
            id: "okr",
            acronym: "OKR",
            definition: "Objectives & Key Results — a goal-setting framework for measurable outcomes.",
            tags: ["Process", "Strategy", "Leadership"],
            example: "Our Q2 OKRs focus on reliability and activation.",
          },
          {
            id: "kpi",
            acronym: "KPI",
            definition: "Key Performance Indicator — a metric used to measure progress against a goal.",
            tags: ["Process", "Analytics"],
            example: "DAU is a KPI we track weekly.",
          },
          {
            id: "dri",
            acronym: "DRI",
            definition: "Directly Responsible Individual — the single owner accountable for an outcome.",
            tags: ["Process", "Leadership", "Execution"],
            example: "Assign a DRI before the kickoff to avoid ambiguity.",
          },
          {
            id: "adr",
            acronym: "ADR",
            definition: "Architecture Decision Record — a short doc capturing a significant technical decision and rationale.",
            tags: ["Engineering", "Process", "Docs"],
            example: "We wrote an ADR for the datastore migration.",
          },
          {
            id: "rfc",
            acronym: "RFC",
            definition: "Request for Comments — a proposal for feedback before committing to a change.",
            tags: ["Engineering", "Process", "Collaboration"],
            example: "Post an RFC before reworking the auth flow.",
          },
          {
            id: "pr",
            acronym: "PR",
            definition: "Pull Request — a change proposal for code review and merge.",
            tags: ["Engineering", "DevOps"],
            example: "Please add tests to the PR before approval.",
          },
          {
            id: "ci-cd",
            acronym: "CI/CD",
            definition: "Continuous Integration / Continuous Delivery — automated build, test, and release pipelines.",
            tags: ["Engineering", "DevOps", "Release"],
            example: "CI/CD failed due to a lint error.",
          },
          {
            id: "sla",
            acronym: "SLA",
            definition: "Service Level Agreement — a formal commitment (often external) to service performance.",
            tags: ["Reliability", "Customer", "Legal"],
            example: "The SLA guarantees 99.9% uptime.",
          },
          {
            id: "slo",
            acronym: "SLO",
            definition: "Service Level Objective — an internal reliability target used to guide engineering tradeoffs.",
            tags: ["Reliability", "Engineering"],
            example: "We set an SLO for p95 latency.",
          },
          {
            id: "sli",
            acronym: "SLI",
            definition: "Service Level Indicator — a measurement used to evaluate an SLO (e.g., availability, latency).",
            tags: ["Reliability", "Engineering"],
            example: "Error rate is an SLI we monitor.",
          },
          {
            id: "p0",
            acronym: "P0",
            definition: "Priority 0 — the highest urgency (often production-down or severe customer impact).",
            tags: ["Process", "Reliability", "Incident"],
            example: "This is a P0; page on-call immediately.",
          },
          {
            id: "oncall",
            acronym: "On-call",
            definition: "A rotation responsible for responding to incidents and operational issues.",
            tags: ["Reliability", "Incident", "Team: SRE"],
            example: "The on-call engineer acknowledged the page.",
          },
          {
            id: "rca",
            acronym: "RCA",
            definition: "Root Cause Analysis — investigation explaining why an incident happened and how to prevent it.",
            tags: ["Incident", "Process"],
            example: "We publish an RCA within 5 business days.",
          },
          {
            id: "pir",
            acronym: "PIR",
            definition: "Post-Incident Review — a structured debrief with learnings and follow-ups.",
            tags: ["Incident", "Process"],
            example: "PIR notes include action items with DRIs.",
          },
          {
            id: "gtm",
            acronym: "GTM",
            definition: "Go-To-Market — the plan to launch and grow a product (positioning, channels, enablement).",
            tags: ["Product", "Sales", "Marketing"],
            example: "We aligned on GTM messaging with Sales.",
          },
          {
            id: "prd",
            acronym: "PRD",
            definition: "Product Requirements Document — defines problem, goals, scope, and requirements.",
            tags: ["Product", "Docs", "Process"],
            example: "The PRD includes success metrics and constraints.",
          },
          {
            id: "mvp",
            acronym: "MVP",
            definition: "Minimum Viable Product — the smallest release that delivers value and enables learning.",
            tags: ["Product", "Strategy"],
            example: "Ship the MVP, then iterate based on feedback.",
          },
          {
            id: "nps",
            acronym: "NPS",
            definition: "Net Promoter Score — a loyalty metric based on likelihood to recommend.",
            tags: ["Customer", "Analytics"],
            example: "NPS improved after the onboarding redesign.",
          },
          {
            id: "qbr",
            acronym: "QBR",
            definition: "Quarterly Business Review — a recurring meeting to review performance, priorities, and risks.",
            tags: ["Leadership", "Process", "Customer"],
            example: "We present roadmap updates in the QBR.",
          },
          {
            id: "ttr",
            acronym: "TTR",
            definition: "Time To Resolve — how long it takes to fully resolve an incident or issue.",
            tags: ["Incident", "Analytics", "Reliability"],
            example: "We reduced TTR by improving runbooks.",
          },
          {
            id: "mttr",
            acronym: "MTTR",
            definition: "Mean Time To Resolve — average time required to restore service after an incident.",
            tags: ["Reliability", "Analytics", "Incident"],
            example: "MTTR dropped after better alerting.",
          },
          {
            id: "iam",
            acronym: "IAM",
            definition: "Identity & Access Management — controlling who can access what, and under which conditions.",
            tags: ["Security", "Engineering"],
            example: "IAM policies are managed via groups and roles.",
          },
          {
            id: "soc2",
            acronym: "SOC 2",
            definition: "A compliance framework focused on security, availability, and confidentiality controls.",
            tags: ["Security", "Compliance", "Process"],
            example: "Evidence collection supports our SOC 2 audit.",
          },
          {
            id: "gdpr",
            acronym: "GDPR",
            definition: "General Data Protection Regulation — EU privacy law governing personal data processing.",
            tags: ["Legal", "Privacy", "Compliance"],
            example: "We handle GDPR deletion requests within the SLA.",
          },
          {
            id: "pii",
            acronym: "PII",
            definition: "Personally Identifiable Information — data that can identify an individual.",
            tags: ["Privacy", "Security"],
            example: "Never log PII in plaintext.",
          },
          {
            id: "rbac",
            acronym: "RBAC",
            definition: "Role-Based Access Control — permissions grouped by role rather than individual.",
            tags: ["Security", "Engineering"],
            example: "RBAC simplifies access reviews.",
          },
          {
            id: "tpm",
            acronym: "TPM",
            definition: "Technical Program Manager — drives cross-team execution and delivery coordination.",
            tags: ["Team: Program", "Execution", "Leadership"],
            example: "The TPM kept dependencies unblocked.",
          },
          {
            id: "tshirt",
            acronym: "T-shirt sizing",
            definition: "Rough sizing method (S/M/L/XL) for estimation when precision isn’t available.",
            tags: ["Process", "Planning"],
            example: "We T-shirt sized the epics during kickoff.",
          },
          {
            id: "spike",
            acronym: "Spike",
            definition: "A time-boxed research task to reduce uncertainty before committing to an approach.",
            tags: ["Engineering", "Planning", "Process"],
            example: "Do a spike to validate the vendor integration.",
          },
          {
            id: "wip",
            acronym: "WIP",
            definition: "Work In Progress — a partially completed task or the limit of simultaneous work.",
            tags: ["Process", "Execution"],
            example: "Keep WIP low to improve flow.",
          },
          {
            id: "ra",
            acronym: "RA",
            definition: "Risk Assessment — identifying and mitigating risks (security, compliance, delivery).",
            tags: ["Security", "Process", "Leadership"],
            example: "Complete the RA before the external launch.",
          },
          {
            id: "raci",
            acronym: "RACI",
            definition: "Responsible, Accountable, Consulted, Informed — a matrix clarifying roles in a project.",
            tags: ["Process", "Leadership", "Execution"],
            example: "We used a RACI to align stakeholders.",
          },
          {
            id: "eod",
            acronym: "EOD",
            definition: "End Of Day — commonly used in async updates and deadlines.",
            tags: ["Communication", "Process"],
            example: "Please send the draft by EOD.",
          },
          {
            id: "fyi",
            acronym: "FYI",
            definition: "For Your Information — indicates no action needed.",
            tags: ["Communication"],
            example: "FYI: the release window moved to Friday.",
          },
          {
            id: "tbd",
            acronym: "TBD",
            definition: "To Be Determined — a placeholder for unknown or pending decisions.",
            tags: ["Communication", "Planning"],
            example: "Owner is TBD until staffing is final.",
          },
          {
            id: "eta",
            acronym: "ETA",
            definition: "Estimated Time of Arrival — when something is expected to be ready or delivered.",
            tags: ["Communication", "Execution"],
            example: "What’s the ETA on the hotfix?",
          },
          {
            id: "e2e",
            acronym: "E2E",
            definition: "End-to-End — covering the full flow, not just a component.",
            tags: ["Engineering", "Quality"],
            example: "We added E2E tests for signup.",
          },
          {
            id: "uat",
            acronym: "UAT",
            definition: "User Acceptance Testing — validation by end users or stakeholders before launch.",
            tags: ["Quality", "Process", "Customer"],
            example: "UAT found edge cases in billing.",
          },
          {
            id: "ga",
            acronym: "GA",
            definition: "General Availability — the product is fully launched and supported.",
            tags: ["Product", "Release"],
            example: "We’re targeting GA next month.",
          },
          {
            id: "beta",
            acronym: "Beta",
            definition: "Limited release phase to gather feedback before GA.",
            tags: ["Product", "Release"],
            example: "Beta users get early access to new features.",
          },
          {
            id: "poc",
            acronym: "PoC",
            definition: "Proof of Concept — a small build to validate feasibility, not production readiness.",
            tags: ["Engineering", "Planning", "Product"],
            example: "The PoC showed the approach works at small scale.",
          },
          {
            id: "ttrq",
            acronym: "TTRQ",
            definition: "Time To Respond (Questions) — internal metric for how quickly we answer customer questions.",
            tags: ["Customer", "Analytics", "Team: Support"],
            example: "We improved TTRQ by routing questions to specialists.",
          },
          {
            id: "se",
            acronym: "SE",
            definition: "Sales Engineer — partners with sales to demonstrate and scope technical solutions.",
            tags: ["Team: Sales", "Customer"],
            example: "Loop in an SE for enterprise evaluations.",
          },
          {
            id: "cs",
            acronym: "CS",
            definition: "Customer Success — helps customers adopt, retain, and expand.",
            tags: ["Team: CS", "Customer"],
            example: "CS requested product changes based on churn feedback.",
          },
          {
            id: "revops",
            acronym: "RevOps",
            definition: "Revenue Operations — aligns sales, marketing, and success operations and systems.",
            tags: ["Team: Ops", "Sales", "Analytics"],
            example: "RevOps cleaned up pipeline stages.",
          },
          {
            id: "dmaic",
            acronym: "DMAIC",
            definition: "Define, Measure, Analyze, Improve, Control — structured process improvement approach.",
            tags: ["Process", "Operations"],
            example: "We used DMAIC to reduce onboarding time.",
          },
          {
            id: "runbook",
            acronym: "Runbook",
            definition: "Step-by-step operational guide for handling incidents or routine procedures.",
            tags: ["Reliability", "Docs", "Incident"],
            example: "Follow the runbook for regional failover.",
          },
          {
            id: "l10n",
            acronym: "L10n",
            definition: "Localization — adapting product language and formats for a locale (dates, currency, strings).",
            tags: ["Engineering", "Product"],
            example: "L10n work includes translations and formatting.",
          },
          {
            id: "i18n",
            acronym: "i18n",
            definition: "Internationalization — designing systems to support multiple languages and locales.",
            tags: ["Engineering", "Product"],
            example: "i18n enables L10n later with less rework.",
          },
          {
            id: "pi-planning",
            acronym: "PI Planning",
            definition: "Program Increment planning — aligning multiple teams on a time-boxed plan (often SAFe).",
            tags: ["Planning", "Process", "Leadership"],
            example: "We synchronize dependencies during PI Planning.",
          },
          {
            id: "tldr",
            acronym: "TL;DR",
            definition: "Too Long; Didn’t Read — a short summary at the top of a longer message.",
            tags: ["Communication", "Docs"],
            example: "Add a TL;DR to long proposals.",
          },
        ].map((x) => ({ ...x, source: "seed" }));

        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
        const now = () => Date.now();

        function escapeHTML(s) {
          return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function normalizeText(s) {
          return String(s || "")
            .toLowerCase()
            .normalize("NFKD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^\w\s/-]/g, " ")
            .replace(/\s+/g, " ")
            .trim();
        }

        function tokenizeWords(s) {
          return normalizeText(s)
            .split(" ")
            .map((w) => w.trim())
            .filter((w) => w.length >= 3);
        }

        function diceCoefficient(a, b) {
          const s1 = normalizeText(a).replace(/\s+/g, " ");
          const s2 = normalizeText(b).replace(/\s+/g, " ");
          if (!s1 || !s2) return 0;
          if (s1 === s2) return 1;
          const bigrams = (s) => {
            const out = [];
            for (let i = 0; i < s.length - 1; i++) out.push(s.slice(i, i + 2));
            return out;
          };
          const b1 = bigrams(s1);
          const b2 = bigrams(s2);
          const counts = new Map();
          for (const x of b1) counts.set(x, (counts.get(x) || 0) + 1);
          let overlap = 0;
          for (const x of b2) {
            const n = counts.get(x) || 0;
            if (n > 0) {
              overlap += 1;
              counts.set(x, n - 1);
            }
          }
          return (2 * overlap) / (b1.length + b2.length);
        }

        function isTypingCorrect(user, answer, dir) {
          const u = String(user || "").trim();
          const a = String(answer || "").trim();
          if (!u || !a) return false;

          const un = normalizeText(u);
          const an = normalizeText(a);
          if (un === an) return true;

          if (dir === "d2a") {
            const u2 = un.replace(/\s+/g, "");
            const a2 = an.replace(/\s+/g, "");
            if (!u2 || !a2) return false;
            if (u2 === a2) return true;
            return a2.includes(u2) || u2.includes(a2);
          }

          const uWords = tokenizeWords(u);
          const aWords = new Set(tokenizeWords(a));
          const covered = uWords.length ? uWords.filter((w) => aWords.has(w)).length / uWords.length : 0;
          if (covered >= 0.75 && uWords.length >= 2) return true;
          return diceCoefficient(u, a) >= 0.74;
        }

        function debounce(fn, ms) {
          let t = null;
          return (...args) => {
            window.clearTimeout(t);
            t = window.setTimeout(() => fn(...args), ms);
          };
        }

        function toast(title, message) {
          const host = $("#toasts");
          const node = document.createElement("div");
          node.className = "toast";
          node.innerHTML = `
            <div aria-hidden="true" style="margin-top:2px">
              <span style="display:inline-block;width:10px;height:10px;border-radius:99px;background:linear-gradient(135deg, rgba(124,92,255,.9), rgba(58,213,255,.75));border:1px solid rgba(255,255,255,.18)"></span>
            </div>
            <div style="min-width:0">
              <div class="t">${escapeHTML(title)}</div>
              <div class="m">${escapeHTML(message)}</div>
            </div>`;
          host.appendChild(node);
          window.setTimeout(() => {
            node.style.opacity = "0";
            node.style.transform = "translateY(6px)";
            node.style.transition = "opacity 250ms ease, transform 250ms ease";
            window.setTimeout(() => node.remove(), 300);
          }, 3200);
        }

        function safeJSONParse(s, fallback) {
          try {
            return JSON.parse(s);
          } catch {
            return fallback;
          }
        }

        function loadLocal(key, fallback) {
          return safeJSONParse(localStorage.getItem(key) || "", fallback);
        }

        function saveLocal(key, value) {
          localStorage.setItem(key, JSON.stringify(value));
        }

        function dedupe(arr) {
          const out = [];
          const seen = new Set();
          for (const v of arr) {
            const k = String(v);
            if (seen.has(k)) continue;
            seen.add(k);
            out.push(v);
          }
          return out;
        }

        function formatPct(n) {
          const v = Math.round(n * 100);
          return `${v}%`;
        }

        function makeId(acronym) {
          const base = normalizeText(acronym).replace(/\s+/g, "-").replace(/[^a-z0-9-]/g, "");
          return base || `custom-${Math.random().toString(16).slice(2)}`;
        }

        function buildTagIndex(items) {
          const tagCounts = new Map();
          for (const item of items) {
            for (const t of item.tags || []) {
              tagCounts.set(t, (tagCounts.get(t) || 0) + 1);
            }
          }
          return Array.from(tagCounts.entries())
            .map(([tag, count]) => ({ tag, count }))
            .sort((a, b) => b.count - a.count || a.tag.localeCompare(b.tag));
        }

        function scoreItem(item, tokens) {
          if (!tokens.length) return 0;
          const a = normalizeText(item.acronym);
          const d = normalizeText(item.definition);
          const tags = normalizeText((item.tags || []).join(" "));
          const ex = normalizeText(item.example || "");

          let score = 0;
          for (const t of tokens) {
            if (!t) continue;
            if (a === t) score += 30;
            else if (a.startsWith(t)) score += 18;
            else if (a.includes(t)) score += 12;
            if (d.includes(t)) score += 8;
            if (tags.includes(t)) score += 7;
            if (ex.includes(t)) score += 4;
          }

          // bonus for tighter match
          score += clamp(12 - a.length, 0, 6);
          return score;
        }

        function highlight(text, queryTokens) {
          const raw = String(text);
          const q = (queryTokens || []).filter(Boolean).sort((a, b) => b.length - a.length)[0];
          if (!q || q.length < 2) return escapeHTML(raw);
          const idx = raw.toLowerCase().indexOf(q.toLowerCase());
          if (idx === -1) return escapeHTML(raw);
          const before = escapeHTML(raw.slice(0, idx));
          const mid = escapeHTML(raw.slice(idx, idx + q.length));
          const after = escapeHTML(raw.slice(idx + q.length));
          return `${before}<span class="highlight">${mid}</span>${after}`;
        }

        function themeToLabel(v) {
          if (v === "light") return "Light";
          if (v === "dark") return "Dark";
          return "System";
        }

        const prefs = loadLocal(STORAGE.prefs, {
          theme: "system",
          view: "library",
          sort: "relevance",
          scope: "all",
          selectedTags: [],
          quizMode: "mc",
          quizDirection: "a2d",
          quizCount: 10,
        });

        const stats = loadLocal(STORAGE.stats, {
          attempts: {}, // id -> {a:number,c:number,ts:number}
        });
        const views = loadLocal(STORAGE.views, {
          seen: {}, // id -> number
        });

        function mergeItems(seed, custom) {
          const map = new Map(seed.map((x) => [x.id, x]));
          for (const c of custom) {
            if (!c || !c.id) continue;
            map.set(c.id, { ...c, source: "custom" });
          }
          return Array.from(map.values());
        }

        let custom = loadLocal(STORAGE.custom, []);
        if (!Array.isArray(custom)) custom = [];

        const state = {
          view: prefs.view === "quiz" ? "quiz" : "library",
          query: "",
          sort: prefs.sort || "relevance",
          scope: prefs.scope || "all",
          selectedTags: new Set(prefs.selectedTags || []),
          theme: prefs.theme || "system",
          quizMode: prefs.quizMode || "mc",
          quizDirection: prefs.quizDirection || "a2d",
          quizCount: clamp(Number(prefs.quizCount) || 10, 5, 20),
          lastFocused: null,
          quiz: null,
        };

        function applyTheme() {
          const root = document.documentElement;
          if (state.theme === "system") root.removeAttribute("data-theme");
          else root.setAttribute("data-theme", state.theme);
          $("#themeLabel").textContent = themeToLabel(state.theme);
        }

        function persistPrefs() {
          saveLocal(STORAGE.prefs, {
            theme: state.theme,
            view: state.view,
            sort: state.sort,
            scope: state.scope,
            selectedTags: Array.from(state.selectedTags),
            quizMode: state.quizMode,
            quizDirection: state.quizDirection,
            quizCount: state.quizCount,
          });
        }

        function getAllItems() {
          return mergeItems(SEED, custom);
        }

        function getFavorites() {
          const f = loadLocal("cal.favs.v1", {});
          return f && typeof f === "object" ? f : {};
        }

        function setFavorite(id, on) {
          const f = getFavorites();
          if (on) f[id] = 1;
          else delete f[id];
          saveLocal("cal.favs.v1", f);
        }

        function isFavorite(id) {
          const f = getFavorites();
          return !!f[id];
        }

        function getAttemptStats(id) {
          const s = stats.attempts[id] || { a: 0, c: 0, ts: 0 };
          return { a: Number(s.a || 0), c: Number(s.c || 0), ts: Number(s.ts || 0) };
        }

        function recordAttempt(id, correct) {
          const s = getAttemptStats(id);
          s.a += 1;
          if (correct) s.c += 1;
          s.ts = now();
          stats.attempts[id] = s;
          saveLocal(STORAGE.stats, stats);
        }

        function recordView(id) {
          const n = Number(views.seen[id] || 0) + 1;
          views.seen[id] = n;
          saveLocal(STORAGE.views, views);
        }

        function accuracy(id) {
          const s = getAttemptStats(id);
          if (!s.a) return null;
          return s.c / s.a;
        }

        function leastKnownScore(id) {
          const a = accuracy(id);
          if (a == null) return 1.2;
          // lower accuracy => higher weight; also reward low-attempt items
          const s = getAttemptStats(id);
          const uncertainty = 1 / Math.sqrt(1 + s.a);
          return (1.0 + (1 - a) * 1.8) * (1.0 + uncertainty * 0.8);
        }

        function getQueryTokens() {
          const q = normalizeText(state.query);
          if (!q) return [];
          return q.split(" ").filter(Boolean);
        }

        function withinScope(item) {
          if (state.scope === "favorites") return isFavorite(item.id);
          if (state.scope === "custom") return item.source === "custom";
          return true;
        }

        function tagMatch(item) {
          if (!state.selectedTags.size) return true;
          const set = new Set(item.tags || []);
          for (const t of state.selectedTags) if (!set.has(t)) return false;
          return true;
        }

        function computeVisible() {
          const items = getAllItems();
          const tokens = getQueryTokens();
          let rows = items
            .filter(withinScope)
            .filter(tagMatch)
            .map((it) => ({ it, s: scoreItem(it, tokens) }))
            .filter(({ it, s }) => (tokens.length ? s > 0 : true));

          const sort = state.sort;
          if (sort === "az") rows.sort((a, b) => a.it.acronym.localeCompare(b.it.acronym));
          else if (sort === "za") rows.sort((a, b) => b.it.acronym.localeCompare(a.it.acronym));
          else if (sort === "mostSeen") rows.sort((a, b) => (views.seen[b.it.id] || 0) - (views.seen[a.it.id] || 0));
          else if (sort === "leastKnown") rows.sort((a, b) => leastKnownScore(b.it.id) - leastKnownScore(a.it.id));
          else rows.sort((a, b) => b.s - a.s || a.it.acronym.localeCompare(b.it.acronym));

          return { rows, tokens, allCount: items.length };
        }

        function renderTags() {
          const tags = buildTagIndex(getAllItems());
          const host = $("#tagChips");
          host.innerHTML = "";
          for (const { tag, count } of tags) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "chip";
            btn.setAttribute("data-selected", state.selectedTags.has(tag) ? "true" : "false");
            btn.innerHTML = `<span class="dot" aria-hidden="true"></span><span>${escapeHTML(tag)}</span><span class="small">(${count})</span>`;
            btn.addEventListener("click", () => {
              if (state.selectedTags.has(tag)) state.selectedTags.delete(tag);
              else state.selectedTags.add(tag);
              persistPrefs();
              render();
            });
            host.appendChild(btn);
          }
        }

        function renderLibrary() {
          const { rows, tokens, allCount } = computeVisible();
          const itemsHost = $("#items");
          itemsHost.innerHTML = "";
          $("#emptyState").hidden = rows.length !== 0;

          $("#countLabel").textContent = `${rows.length} of ${allCount} acronyms`;
          const tagInfo = state.selectedTags.size
            ? `Tags: ${Array.from(state.selectedTags).join(", ")}`
            : "Tags: All";
          $("#tagLabel").textContent = tagInfo;

          const summary = [
            state.selectedTags.size ? `${state.selectedTags.size} tag${state.selectedTags.size === 1 ? "" : "s"}` : "All tags",
            state.scope === "favorites" ? "Starred" : state.scope === "custom" ? "Custom" : "All",
          ].join(" • ");
          $("#filterSummary").textContent = summary;

          for (const { it, s } of rows) {
            const isFav = isFavorite(it.id);
            const seen = Number(views.seen[it.id] || 0);
            const a = accuracy(it.id);
            const aText = a == null ? "—" : formatPct(a);

            const node = document.createElement("article");
            node.className = "item";
            node.tabIndex = 0;
            node.setAttribute("role", "button");
            node.setAttribute("aria-label", `${it.acronym}: ${it.definition}`);
            node.innerHTML = `
              <div class="item-top">
                <div style="min-width:0">
                  <div class="acronym">${highlight(it.acronym, tokens)}</div>
                  <div class="badge" title="Your stats for this acronym">
                    <span style="opacity:.9">Seen</span> <strong>${seen}</strong>
                    <span style="opacity:.55">•</span>
                    <span style="opacity:.9">Quiz</span> <strong>${aText}</strong>
                  </div>
                </div>
                <div class="actions">
                  <button class="star" type="button" data-on="${isFav ? "true" : "false"}" title="${
                    isFav ? "Unstar" : "Star"
                  }">${ICONS.star}</button>
                  <button class="star" type="button" data-action="edit" title="Edit (custom)">${ICONS.pencil}</button>
                </div>
              </div>
              <div class="definition">${escapeHTML(it.definition)}</div>
              <div class="meta">
                ${(it.tags || [])
                  .slice(0, 7)
                  .map((t) => `<span class="tag"><span class="hash">#</span>${escapeHTML(t)}</span>`)
                  .join("")}
                ${(it.tags || []).length > 7 ? `<span class="tag">+${(it.tags || []).length - 7} more</span>` : ""}
              </div>
              ${
                it.example
                  ? `<div class="small"><span style="color:var(--faint)">Example:</span> ${escapeHTML(it.example)}</div>`
                  : ""
              }
              ${
                s && tokens.length
                  ? `<div class="small"><span style="color:var(--faint)">Match:</span> relevance ${s}</div>`
                  : ""
              }
            `;

            const [btnStar, btnEdit] = $$(".actions .star", node);
            btnStar.addEventListener("click", (e) => {
              e.stopPropagation();
              const next = !isFavorite(it.id);
              setFavorite(it.id, next);
              toast(next ? "Starred" : "Unstarred", it.acronym);
              renderLibrary(); // cheaper than full render for quick feedback
            });

            btnEdit.addEventListener("click", (e) => {
              e.stopPropagation();
              if (it.source !== "custom") {
                toast("Seed item", "Add a custom copy to edit (keeps the original).");
                openAddModal({
                  acronym: it.acronym,
                  definition: it.definition,
                  tags: (it.tags || []).join(", "),
                  example: it.example || "",
                });
                return;
              }
              openAddModal({
                id: it.id,
                acronym: it.acronym,
                definition: it.definition,
                tags: (it.tags || []).join(", "),
                example: it.example || "",
              });
            });

            const open = () => {
              recordView(it.id);
              openDetailsModal(it);
              renderLibrary();
            };
            node.addEventListener("click", open);
            node.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                open();
              }
            });

            itemsHost.appendChild(node);
          }
        }

        function setView(view) {
          state.view = view;
          $("#tabLibrary").setAttribute("aria-selected", view === "library" ? "true" : "false");
          $("#tabQuiz").setAttribute("aria-selected", view === "quiz" ? "true" : "false");
          $("#viewLibrary").hidden = view !== "library";
          $("#viewQuiz").hidden = view !== "quiz";
          $("#quizSettingsRow").style.display = view === "quiz" ? "grid" : "grid";
          persistPrefs();
        }

        function setModal(open) {
          const b = $("#modalBackdrop");
          b.setAttribute("data-open", open ? "true" : "false");
          b.setAttribute("aria-hidden", open ? "false" : "true");
          document.body.style.overflow = open ? "hidden" : "";
        }

        function openModal({ title, bodyHTML, footerHTML, onOpen }) {
          $("#modalTitle").textContent = title;
          $("#modalBody").innerHTML = bodyHTML;
          $("#modalFooter").innerHTML = footerHTML || "";
          setModal(true);
          if (typeof onOpen === "function") onOpen();
        }

        function closeModal() {
          setModal(false);
          $("#modalBody").innerHTML = "";
          $("#modalFooter").innerHTML = "";
        }

        function openDetailsModal(item) {
          const isFav = isFavorite(item.id);
          const seen = Number(views.seen[item.id] || 0);
          const s = getAttemptStats(item.id);
          const acc = s.a ? s.c / s.a : null;
          const accLabel = acc == null ? "No quiz attempts yet" : `${s.c}/${s.a} correct (${formatPct(acc)})`;
          openModal({
            title: item.acronym,
            bodyHTML: `
              <div class="small" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                <span class="badge"><span style="opacity:.9">Seen</span> <strong>${seen}</strong></span>
                <span class="badge"><span style="opacity:.9">Quiz</span> <strong>${escapeHTML(accLabel)}</strong></span>
                <span class="badge"><span style="opacity:.9">Source</span> <strong>${escapeHTML(item.source)}</strong></span>
              </div>
              <div style="font-size:14px">${escapeHTML(item.definition)}</div>
              ${
                item.example
                  ? `<div class="small"><span style="color:var(--faint)">Example:</span> ${escapeHTML(item.example)}</div>`
                  : `<div class="small"><span style="color:var(--faint)">Example:</span> Add one to make it stick.</div>`
              }
              <div class="meta" aria-label="Tags">
                ${(item.tags || [])
                  .map((t) => `<span class="tag"><span class="hash">#</span>${escapeHTML(t)}</span>`)
                  .join("")}
              </div>
              <div class="small">Tip: use tags like <span class="kbd">Team: SRE</span> or <span class="kbd">Project: Atlas</span> to keep things organized.</div>
            `,
            footerHTML: `
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn" id="detailStar" type="button">${ICONS.star} ${isFav ? "Unstar" : "Star"}</button>
                <button class="btn" id="detailQuiz" type="button">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M8 5v14l12-7-12-7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                  </svg>
                  Quiz this
                </button>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn" id="detailEdit" type="button">${ICONS.pencil} ${
                  item.source === "custom" ? "Edit" : "Add custom copy"
                }</button>
                ${
                  item.source === "custom"
                    ? `<button class="btn danger" id="detailDelete" type="button">${ICONS.trash} Delete</button>`
                    : ""
                }
                <button class="btn primary" id="detailClose" type="button">Done</button>
              </div>
            `,
            onOpen: () => {
              $("#detailClose").addEventListener("click", closeModal);
              $("#detailStar").addEventListener("click", () => {
                const next = !isFavorite(item.id);
                setFavorite(item.id, next);
                toast(next ? "Starred" : "Unstarred", item.acronym);
                closeModal();
                render();
              });
              $("#detailEdit").addEventListener("click", () => {
                closeModal();
                openAddModal({
                  ...(item.source === "custom" ? { id: item.id } : {}),
                  acronym: item.acronym,
                  definition: item.definition,
                  tags: (item.tags || []).join(", "),
                  example: item.example || "",
                });
              });
              const del = $("#detailDelete");
              if (del) {
                del.addEventListener("click", () => {
                  closeModal();
                  confirmDeleteCustom(item.id, item.acronym);
                });
              }
              $("#detailQuiz").addEventListener("click", () => {
                closeModal();
                setView("quiz");
                startQuiz({ items: [item], forcePoolFromFilters: false });
              });
            },
          });
        }

        function openAddModal(preset = {}) {
          const editing = !!preset.id;
          openModal({
            title: editing ? "Edit acronym" : "Add acronym",
            bodyHTML: `
              <div class="grid2">
                <div class="field">
                  <label for="fAcr">Acronym</label>
                  <input id="fAcr" placeholder="e.g., OKR" value="${escapeHTML(preset.acronym || "")}" />
                </div>
                <div class="field">
                  <label for="fTags">Tags (comma-separated)</label>
                  <input id="fTags" placeholder="Team: Eng, Process, Project: Atlas" value="${escapeHTML(preset.tags || "")}" />
                </div>
              </div>
              <div class="field">
                <label for="fDef">Definition</label>
                <textarea id="fDef" placeholder="What does it stand for? What does it mean?">${escapeHTML(
                  preset.definition || ""
                )}</textarea>
              </div>
              <div class="field">
                <label for="fEx">Example (optional)</label>
                <input id="fEx" placeholder="How would you use it in a sentence?" value="${escapeHTML(
                  preset.example || ""
                )}" />
              </div>
              <div class="small">
                Saved locally. You can export/import your custom list from the Data menu.
              </div>
            `,
            footerHTML: `
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn" id="btnCancelAdd" type="button">Cancel</button>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                ${editing ? `<button class="btn danger" id="btnDeleteAdd" type="button">${ICONS.trash} Delete</button>` : ""}
                <button class="btn primary" id="btnSaveAdd" type="button">Save</button>
              </div>
            `,
            onOpen: () => {
              const acr = $("#fAcr");
              acr.focus();
              const save = () => {
                const acronym = String($("#fAcr").value || "").trim();
                const definition = String($("#fDef").value || "").trim();
                const tags = dedupe(
                  String($("#fTags").value || "")
                    .split(",")
                    .map((x) => x.trim())
                    .filter(Boolean)
                );
                const example = String($("#fEx").value || "").trim();

                if (!acronym || acronym.length < 2) {
                  toast("Missing acronym", "Please enter an acronym (at least 2 characters).");
                  return;
                }
                if (!definition || definition.length < 6) {
                  toast("Missing definition", "Please enter a clear definition.");
                  return;
                }

                const id = preset.id || makeId(acronym);
                const next = { id, acronym, definition, tags, example, updatedAt: now(), source: "custom" };

                const existing = loadLocal(STORAGE.custom, []);
                const arr = Array.isArray(existing) ? existing.filter((x) => x && x.id !== id) : [];
                arr.unshift(next);
                saveLocal(STORAGE.custom, arr);
                custom = arr;
                toast(editing ? "Updated" : "Saved", acronym);
                closeModal();
                render();
              };

              $("#btnSaveAdd").addEventListener("click", save);
              $("#btnCancelAdd").addEventListener("click", closeModal);
              const del = $("#btnDeleteAdd");
              if (del) {
                del.addEventListener("click", () => {
                  closeModal();
                  confirmDeleteCustom(preset.id, preset.acronym || preset.id);
                });
              }
              $("#fDef").addEventListener("keydown", (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === "Enter") save();
              });
            },
          });
        }

        function confirmDeleteCustom(id, label) {
          openModal({
            title: "Delete custom acronym?",
            bodyHTML: `
              <div>Delete <span class="kbd">${escapeHTML(label)}</span> from your custom list?</div>
              <div class="small">This does not affect seed acronyms. This action cannot be undone.</div>
            `,
            footerHTML: `
              <button class="btn" id="btnNo" type="button">Cancel</button>
              <button class="btn danger" id="btnYes" type="button">${ICONS.trash} Delete</button>
            `,
            onOpen: () => {
              $("#btnNo").addEventListener("click", closeModal);
              $("#btnYes").addEventListener("click", () => {
                const existing = loadLocal(STORAGE.custom, []);
                const arr = Array.isArray(existing) ? existing.filter((x) => x && x.id !== id) : [];
                saveLocal(STORAGE.custom, arr);
                custom = arr;
                toast("Deleted", String(label));
                closeModal();
                render();
              });
            },
          });
        }

        function openManageModal() {
          const payload = { version: 1, exportedAt: new Date().toISOString(), custom, stats, views, favorites: getFavorites() };
          openModal({
            title: "Import / export",
            bodyHTML: `
              <div class="grid2">
                <div class="field">
                  <label>Export</label>
                  <textarea id="exportBox" readonly>${escapeHTML(JSON.stringify(payload, null, 2))}</textarea>
                  <div class="small">Copy/paste to share with teammates. (Includes custom acronyms + your local stats.)</div>
                  <button class="btn" id="btnDownload" type="button">Download JSON</button>
                </div>
                <div class="field">
                  <label>Import</label>
                  <textarea id="importBox" placeholder="Paste JSON here…"></textarea>
                  <div class="small">Imports custom acronyms, favorites, and stats from a previous export.</div>
                  <button class="btn primary" id="btnImport" type="button">Import</button>
                </div>
              </div>
            `,
            footerHTML: `
              <button class="btn" id="btnCloseManage" type="button">Close</button>
            `,
            onOpen: () => {
              $("#btnCloseManage").addEventListener("click", closeModal);
              $("#btnDownload").addEventListener("click", () => {
                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "company-acronyms.json";
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                toast("Downloaded", "company-acronyms.json");
              });
              $("#btnImport").addEventListener("click", () => {
                const raw = String($("#importBox").value || "").trim();
                if (!raw) return toast("Nothing to import", "Paste JSON from an export first.");
                const data = safeJSONParse(raw, null);
                if (!data || typeof data !== "object") return toast("Invalid JSON", "Could not parse the import payload.");
                const importedCustom = Array.isArray(data.custom) ? data.custom : Array.isArray(data.acronyms) ? data.acronyms : [];
                const importedFavs = data.favorites && typeof data.favorites === "object" ? data.favorites : null;
                const importedStats = data.stats && typeof data.stats === "object" ? data.stats : null;
                const importedViews = data.views && typeof data.views === "object" ? data.views : null;

                if (importedCustom.length) {
                  const sanitized = importedCustom
                    .filter((x) => x && typeof x === "object")
                    .map((x) => ({
                      id: String(x.id || makeId(x.acronym || "custom")).slice(0, 80),
                      acronym: String(x.acronym || "").slice(0, 60),
                      definition: String(x.definition || "").slice(0, 800),
                      tags: Array.isArray(x.tags)
                        ? dedupe(x.tags.map((t) => String(t).slice(0, 40)))
                        : dedupe(String(x.tags || "").split(",").map((t) => t.trim()).filter(Boolean)),
                      example: String(x.example || "").slice(0, 240),
                      updatedAt: Number(x.updatedAt || now()),
                      source: "custom",
                    }))
                    .filter((x) => x.acronym && x.definition);
                  saveLocal(STORAGE.custom, sanitized);
                  custom = sanitized;
                }
                if (importedFavs) saveLocal("cal.favs.v1", importedFavs);
                if (importedStats) saveLocal(STORAGE.stats, importedStats);
                if (importedViews) saveLocal(STORAGE.views, importedViews);

                toast("Imported", "Your data is now available in this browser.");
                closeModal();
                // Reload in-memory stats/views too
                const st = loadLocal(STORAGE.stats, { attempts: {} });
                stats.attempts = st.attempts || {};
                const vw = loadLocal(STORAGE.views, { seen: {} });
                views.seen = vw.seen || {};
                render();
              });
            },
          });
        }

        function openHelpModal() {
          openModal({
            title: "Help & shortcuts",
            bodyHTML: `
              <div class="small">
                <div style="display:grid;gap:10px">
                  <div>
                    <div style="font-weight:850;color:var(--text)">Search</div>
                    <div>Type acronyms, keywords, or tags. Examples: <span class="kbd">OKR</span>, <span class="kbd">incident</span>, <span class="kbd">Team:</span></div>
                  </div>
                  <div>
                    <div style="font-weight:850;color:var(--text)">Tags</div>
                    <div>Click tags to filter. Use structured tags like <span class="kbd">Team: SRE</span>, <span class="kbd">Project: Atlas</span>, <span class="kbd">Process</span>.</div>
                  </div>
                  <div>
                    <div style="font-weight:850;color:var(--text)">Quiz</div>
                    <div>Quiz uses your current filters and focuses more on acronyms you miss. Multiple choice or typing mode.</div>
                  </div>
                  <div>
                    <div style="font-weight:850;color:var(--text)">Shortcuts</div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
                      <span class="kbd">/</span><span class="small">Focus search</span>
                      <span class="kbd">g</span><span class="kbd">l</span><span class="small">Library</span>
                      <span class="kbd">g</span><span class="kbd">q</span><span class="small">Quiz</span>
                      <span class="kbd">Esc</span><span class="small">Close modal</span>
                    </div>
                  </div>
                </div>
              </div>
            `,
            footerHTML: `
              <button class="btn primary" id="btnHelpClose" type="button">Got it</button>
            `,
            onOpen: () => $("#btnHelpClose").addEventListener("click", closeModal),
          });
        }

        function shuffle(a) {
          const arr = a.slice();
          for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
          }
          return arr;
        }

        function weightedSample(items, weightFn, count) {
          const pool = items.map((it) => ({ it, w: Math.max(0.0001, Number(weightFn(it)) || 0.0001) }));
          const picked = [];
          const used = new Set();
          while (picked.length < count && used.size < pool.length) {
            const total = pool.reduce((acc, x) => (used.has(x.it.id) ? acc : acc + x.w), 0);
            let r = Math.random() * total;
            for (const x of pool) {
              if (used.has(x.it.id)) continue;
              r -= x.w;
              if (r <= 0) {
                used.add(x.it.id);
                picked.push(x.it);
                break;
              }
            }
          }
          return picked;
        }

        function buildQuizPoolFromFilters() {
          const { rows } = computeVisible();
          return rows.map((r) => r.it);
        }

        function buildQuestion(item, pool, mode, direction) {
          const dir =
            direction === "mixed" ? (Math.random() < 0.5 ? "a2d" : "d2a") : direction === "d2a" ? "d2a" : "a2d";

          const prompt = dir === "a2d" ? item.acronym : item.definition;
          const answer = dir === "a2d" ? item.definition : item.acronym;

          if (mode === "mc") {
            const distractors = shuffle(
              pool
                .filter((x) => x.id !== item.id)
                .slice(0, 24)
                .map((x) => (dir === "a2d" ? x.definition : x.acronym))
            )
              .filter(Boolean)
              .slice(0, 3);
            const choices = shuffle([answer, ...distractors]);
            return { itemId: item.id, dir, mode, prompt, answer, choices };
          }

          return { itemId: item.id, dir, mode, prompt, answer, choices: null };
        }

        function startQuiz({ items = null, forcePoolFromFilters = true } = {}) {
          const all = getAllItems()
            .filter(withinScope)
            .filter(tagMatch)
            .filter((x) => x && x.acronym && x.definition);
          const filterPool = forcePoolFromFilters
            ? buildQuizPoolFromFilters().filter((x) => x && x.acronym && x.definition)
            : all;
          const choicePool = filterPool.length ? filterPool : all;
          const questionCandidates =
            items && items.length ? items.filter((x) => x && x.acronym && x.definition) : choicePool;

          const count = clamp(Number(state.quizCount) || 10, 1, 50);
          const minPool = state.quizMode === "mc" ? 4 : 1;
          if (choicePool.length < minPool || questionCandidates.length < 1) {
            toast(
              "Not enough items",
              state.quizMode === "mc" ? "Need at least 4 acronyms for multiple choice." : "Add more acronyms first."
            );
            setView("library");
            return;
          }

          const picked =
            items && items.length
              ? questionCandidates.slice(0, count)
              : weightedSample(
                  questionCandidates,
                  (it) => leastKnownScore(it.id) + (isFavorite(it.id) ? 0.25 : 0),
                  Math.min(count, questionCandidates.length)
                );

          const qPoolForChoices = shuffle(choicePool);
          const questions = picked.map((it) => buildQuestion(it, qPoolForChoices, state.quizMode, state.quizDirection));

          state.quiz = {
            startedAt: now(),
            idx: 0,
            correct: 0,
            questions,
            answered: [], // {itemId, correct, user, answer, dir}
          };

          setView("quiz");
          renderQuiz();
          toast("Quiz started", `${questions.length} question${questions.length === 1 ? "" : "s"}`);
        }

        function renderQuiz() {
          const host = $("#quizBody");
          const session = state.quiz;

          const setProgress = (text, frac) => {
            $("#quizProgressText").textContent = text;
            $("#quizProgressBar").style.width = `${Math.round(clamp(frac, 0, 1) * 100)}%`;
          };

          if (!session) {
            setProgress("Not started", 0);
            host.innerHTML = `
              <div class="empty">
                <strong>Ready when you are.</strong>
                <div class="small" style="margin-top: 6px">
                  Use the filters, then click “Start quiz”.
                </div>
              </div>`;
            return;
          }

          const total = session.questions.length;
          const i = session.idx;

          if (i >= total) {
            const durationSec = Math.max(1, Math.round((now() - session.startedAt) / 1000));
            const pct = total ? session.correct / total : 0;
            setProgress(`Complete • ${session.correct}/${total}`, 1);
            const missed = session.answered.filter((a) => !a.correct);
            host.innerHTML = `
              <div class="result-grid">
                <div class="statbox"><div class="k">Score</div><div class="v">${Math.round(pct * 100)}%</div></div>
                <div class="statbox"><div class="k">Correct</div><div class="v">${session.correct} / ${total}</div></div>
                <div class="statbox"><div class="k">Time</div><div class="v">${durationSec}s</div></div>
              </div>
              ${
                missed.length
                  ? `<div class="question">
                      <div class="prompt"><strong>Review</strong> — focus on what you missed</div>
                      <div class="choices">
                        ${missed
                          .slice(0, 8)
                          .map((m) => {
                            const item = getAllItems().find((x) => x.id === m.itemId);
                            if (!item) return "";
                            return `<div class="feedback">
                              <div class="line">
                                <span class="pilltag bad">Missed</span>
                                <span class="kbd">${escapeHTML(item.acronym)}</span>
                                <span class="small">${escapeHTML(item.definition)}</span>
                              </div>
                              ${item.example ? `<div class="small"><span style="color:var(--faint)">Example:</span> ${escapeHTML(item.example)}</div>` : ""}
                            </div>`;
                          })
                          .join("")}
                      </div>
                    </div>`
                  : `<div class="empty"><strong>Clean sweep.</strong><div class="small" style="margin-top:6px">Try increasing the question count or switching quiz direction.</div></div>`
              }
              <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between">
                <button class="btn" id="btnQuizExit" type="button">Back to library</button>
                <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                  <button class="btn" id="btnQuizRetryMissed" type="button" ${missed.length ? "" : "disabled"}>Retry missed</button>
                  <button class="btn primary" id="btnQuizAgain" type="button">New quiz</button>
                </div>
              </div>
            `;
            $("#btnQuizExit").addEventListener("click", () => {
              state.quiz = null;
              setView("library");
              render();
            });
            $("#btnQuizAgain").addEventListener("click", () => startQuiz());
            const retry = $("#btnQuizRetryMissed");
            if (retry) {
              retry.addEventListener("click", () => {
                const items = missed
                  .map((m) => getAllItems().find((x) => x.id === m.itemId))
                  .filter(Boolean);
                startQuiz({ items, forcePoolFromFilters: false });
              });
            }
            return;
          }

          const q = session.questions[i];
          const item = getAllItems().find((x) => x.id === q.itemId) || null;
          setProgress(`Question ${i + 1} of ${total}`, i / total);

          const promptLabel = q.dir === "a2d" ? "What does this acronym mean?" : "Which acronym matches this definition?";
          const promptText = q.prompt;

          const footer = `
            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between">
              <button class="btn" id="btnQuizQuit" type="button">Quit</button>
              <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn" id="btnQuizReveal" type="button">Reveal</button>
                <button class="btn primary" id="btnQuizNext" type="button" disabled>Next</button>
              </div>
            </div>
          `;

          host.innerHTML = `
            <div class="question">
              <div class="prompt"><strong>${escapeHTML(promptLabel)}</strong></div>
              <div class="qtext">${escapeHTML(promptText)}</div>
              ${
                q.mode === "mc"
                  ? `<div class="choices" id="choices">
                      ${(q.choices || [])
                        .map(
                          (c, idx) =>
                            `<button class="choice" type="button" data-choice="${idx}">${escapeHTML(c)}</button>`
                        )
                        .join("")}
                    </div>`
                  : `<div class="answer">
                      <input id="typeInput" placeholder="${
                        q.dir === "a2d" ? "Type the definition…" : "Type the acronym…"
                      }" autocomplete="off" />
                      <button class="btn" id="btnSubmitType" type="button">Check</button>
                    </div>`
              }
              <div id="feedback"></div>
            </div>
            ${footer}
          `;

          let locked = false;
          let lastCorrect = false;
          const enableNext = () => {
            $("#btnQuizNext").disabled = false;
            $("#btnQuizNext").focus();
          };
          const showFeedback = (correct, userAnswer, revealed = false) => {
            const fb = $("#feedback");
            const correctLabel = correct ? "Correct" : "Not quite";
            const stateClass = correct ? "good" : "bad";
            const tip = item?.example ? item.example : "";
            const tags = (item?.tags || []).slice(0, 6);
            fb.innerHTML = `
              <div class="feedback">
                <div class="line">
                  <span class="pilltag ${stateClass}">${escapeHTML(correctLabel)}</span>
                  ${revealed ? `<span class="pilltag">Revealed</span>` : ""}
                  <span class="small" style="color:var(--faint)">Answer:</span>
                  <span class="small">${escapeHTML(q.answer)}</span>
                </div>
                ${
                  userAnswer
                    ? `<div class="small"><span style="color:var(--faint)">You:</span> ${escapeHTML(userAnswer)}</div>`
                    : ""
                }
                ${
                  tags.length
                    ? `<div class="meta">${tags
                        .map((t) => `<span class="tag"><span class="hash">#</span>${escapeHTML(t)}</span>`)
                        .join("")}</div>`
                    : ""
                }
                ${tip ? `<div class="small"><span style="color:var(--faint)">Example:</span> ${escapeHTML(tip)}</div>` : ""}
              </div>
            `;
          };

          const finalize = (correct, userAnswer, revealed = false) => {
            locked = true;
            lastCorrect = !!correct;
            recordAttempt(q.itemId, correct && !revealed);
            session.answered.push({ itemId: q.itemId, correct: correct && !revealed, user: userAnswer || "", answer: q.answer, dir: q.dir });
            if (correct && !revealed) session.correct += 1;
            enableNext();
          };

          $("#btnQuizQuit").addEventListener("click", () => {
            state.quiz = null;
            setView("library");
            render();
          });
          $("#btnQuizNext").addEventListener("click", () => {
            session.idx += 1;
            renderQuiz();
          });
          $("#btnQuizReveal").addEventListener("click", () => {
            if (locked) return;
            showFeedback(false, "", true);
            finalize(false, "", true);
          });

          if (q.mode === "mc") {
            const choices = $$("#choices .choice");
            const correctIndex = (q.choices || []).findIndex((c) => c === q.answer);
            const onPick = (idx) => {
              if (locked) return;
              locked = true;
              for (const [i2, btn] of choices.entries()) {
                const st = i2 === correctIndex ? "correct" : i2 === idx ? "wrong" : "";
                if (st) btn.setAttribute("data-state", st);
                btn.disabled = true;
              }
              const picked = q.choices[idx];
              const ok = idx === correctIndex;
              showFeedback(ok, picked, false);
              finalize(ok, picked, false);
            };
            choices.forEach((btn) =>
              btn.addEventListener("click", () => onPick(Number(btn.getAttribute("data-choice") || 0)))
            );
          } else {
            const input = $("#typeInput");
            const submit = () => {
              if (locked) return;
              const user = String(input.value || "").trim();
              if (!user) return toast("Type an answer", "Then click Check (or press Enter).");
              const ok = isTypingCorrect(user, q.answer, q.dir);
              showFeedback(ok, user, false);
              finalize(ok, user, false);
              input.disabled = true;
              $("#btnSubmitType").disabled = true;
            };
            $("#btnSubmitType").addEventListener("click", submit);
            input.addEventListener("keydown", (e) => {
              if (e.key === "Enter") submit();
            });
            input.focus();
          }
        }

        function render() {
          applyTheme();
          renderTags();
          renderLibrary();
          renderQuiz();
        }

        // Wire up UI
        function init() {
          applyTheme();

          const searchInput = $("#searchInput");
          searchInput.addEventListener(
            "input",
            debounce(() => {
              state.query = searchInput.value;
              renderLibrary();
            }, 80)
          );

          $("#sortSelect").value = state.sort;
          $("#sortSelect").addEventListener("change", (e) => {
            state.sort = e.target.value;
            persistPrefs();
            renderLibrary();
          });

          $("#scopeSelect").value = state.scope;
          $("#scopeSelect").addEventListener("change", (e) => {
            state.scope = e.target.value;
            persistPrefs();
            render();
          });

          $("#quizModeSelect").value = state.quizMode;
          $("#quizModeSelect").addEventListener("change", (e) => {
            state.quizMode = e.target.value;
            persistPrefs();
          });

          $("#quizDirectionSelect").value = state.quizDirection;
          $("#quizDirectionSelect").addEventListener("change", (e) => {
            state.quizDirection = e.target.value;
            persistPrefs();
          });

          $("#quizCountSelect").value = String(state.quizCount);
          $("#quizCountSelect").addEventListener("change", (e) => {
            state.quizCount = clamp(Number(e.target.value) || 10, 1, 50);
            persistPrefs();
          });

          $("#btnStartQuiz").addEventListener("click", () => startQuiz());

          $("#btnClearTags").addEventListener("click", () => {
            state.selectedTags.clear();
            persistPrefs();
            render();
          });

          $("#btnReset").addEventListener("click", () => {
            state.query = "";
            state.selectedTags.clear();
            state.sort = "relevance";
            state.scope = "all";
            $("#sortSelect").value = state.sort;
            $("#scopeSelect").value = state.scope;
            searchInput.value = "";
            persistPrefs();
            render();
            toast("Reset", "Search and filters cleared.");
          });

          $("#btnAdd").addEventListener("click", () => openAddModal());
          $("#btnManage").addEventListener("click", openManageModal);
          $("#btnHelp").addEventListener("click", openHelpModal);
          $("#btnTheme").addEventListener("click", () => {
            const next = state.theme === "system" ? "light" : state.theme === "light" ? "dark" : "system";
            state.theme = next;
            persistPrefs();
            applyTheme();
            toast("Theme", themeToLabel(next));
          });

          $("#btnResetStats").addEventListener("click", () => {
            openModal({
              title: "Reset stats?",
              bodyHTML: `
                <div>Clear local quiz stats and view counts?</div>
                <div class="small">This doesn’t remove your custom acronyms.</div>
              `,
              footerHTML: `
                <button class="btn" id="btnNo" type="button">Cancel</button>
                <button class="btn danger" id="btnYes" type="button">Reset</button>
              `,
              onOpen: () => {
                $("#btnNo").addEventListener("click", closeModal);
                $("#btnYes").addEventListener("click", () => {
                  saveLocal(STORAGE.stats, { attempts: {} });
                  saveLocal(STORAGE.views, { seen: {} });
                  stats.attempts = {};
                  views.seen = {};
                  closeModal();
                  render();
                  toast("Reset", "Stats cleared.");
                });
              },
            });
          });

          $("#tabLibrary").addEventListener("click", () => setView("library"));
          $("#tabQuiz").addEventListener("click", () => setView("quiz"));
          setView(state.view);

          // Mobile filters: reuse the panel in a modal
          $("#btnFilters").addEventListener("click", () => {
            const panel = $("#filtersPanel");
            const clone = panel.cloneNode(true);
            clone.style.display = "block";
            clone.style.position = "relative";
            clone.style.top = "auto";
            clone.style.boxShadow = "none";
            clone.style.borderRadius = "16px";
            clone.style.background = "transparent";
            clone.style.border = "0";

            openModal({
              title: "Filters",
              bodyHTML: `<div id="mobileFiltersHost"></div>`,
              footerHTML: `<button class="btn primary" id="btnCloseFilters" type="button">Done</button>`,
              onOpen: () => {
                $("#mobileFiltersHost").appendChild(clone);
                // Rebind events for clone (simple: forward changes to real controls)
                const linkSelect = (id) => {
                  const a = $(id, clone);
                  const b = $(id);
                  if (a && b) {
                    a.value = b.value;
                    a.addEventListener("change", () => {
                      b.value = a.value;
                      b.dispatchEvent(new Event("change"));
                    });
                  }
                };
                linkSelect("#sortSelect");
                linkSelect("#scopeSelect");
                linkSelect("#quizModeSelect");
                linkSelect("#quizDirectionSelect");
                linkSelect("#quizCountSelect");

                const tagHost = $("#tagChips", clone);
                if (tagHost) {
                  $$(".chip", tagHost).forEach((chip, idx) => {
                    const real = $$(".chip", $("#tagChips"))[idx];
                    if (!real) return;
                    chip.addEventListener("click", () => {
                      // real click will update state and rerender real tags; close & reopen would sync
                      real.click();
                      chip.setAttribute("data-selected", real.getAttribute("data-selected"));
                    });
                  });
                }
                const clearTags = $("#btnClearTags", clone);
                if (clearTags) clearTags.addEventListener("click", () => $("#btnClearTags").click());
                const startQuizBtn = $("#btnStartQuiz", clone);
                if (startQuizBtn) startQuizBtn.addEventListener("click", () => $("#btnStartQuiz").click());
                const manage = $("#btnManage", clone);
                if (manage) manage.addEventListener("click", () => $("#btnManage").click());
                const resetStats = $("#btnResetStats", clone);
                if (resetStats) resetStats.addEventListener("click", () => $("#btnResetStats").click());

                $("#btnCloseFilters").addEventListener("click", closeModal);
              },
            });
          });

          $("#modalClose").addEventListener("click", closeModal);
          $("#modalBackdrop").addEventListener("click", (e) => {
            if (e.target === $("#modalBackdrop")) closeModal();
          });
          window.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closeModal();
          });

          // Keyboard shortcuts
          let gMode = false;
          window.addEventListener("keydown", (e) => {
            const isTyping =
              document.activeElement &&
              ["INPUT", "TEXTAREA", "SELECT"].includes(document.activeElement.tagName) &&
              document.activeElement !== document.body;
            if (!isTyping && e.key === "/") {
              e.preventDefault();
              searchInput.focus();
              return;
            }
            if (!isTyping && (e.key === "?" || (e.shiftKey && e.key === "/"))) {
              e.preventDefault();
              openHelpModal();
              return;
            }
            if (isTyping) return;

            if (gMode) {
              gMode = false;
              if (e.key.toLowerCase() === "l") setView("library");
              if (e.key.toLowerCase() === "q") setView("quiz");
              return;
            }
            if (e.key.toLowerCase() === "g") {
              gMode = true;
              window.setTimeout(() => (gMode = false), 700);
            }
          });

          // First paint
          render();
        }

        init();
      })();
    </script>
  </body>
</html>
