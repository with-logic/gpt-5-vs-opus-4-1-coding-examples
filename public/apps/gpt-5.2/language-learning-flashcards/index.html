<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark light" />
    <title>Language Learning Flashcards</title>
    <style>
      :root {
        --bg0: #070816;
        --bg1: #0b1230;
        --card: rgba(255, 255, 255, 0.08);
        --card2: rgba(255, 255, 255, 0.12);
        --line: rgba(255, 255, 255, 0.14);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.72);
        --faint: rgba(255, 255, 255, 0.55);
        --shadow: 0 24px 70px rgba(0, 0, 0, 0.55);
        --shadow2: 0 14px 40px rgba(0, 0, 0, 0.4);
        --radius: 18px;
        --radius2: 14px;
        --focus: rgba(126, 231, 255, 0.9);
        --accent: #7ee7ff;
        --accent2: #a78bfa;
        --good: #34d399;
        --warn: #fbbf24;
        --danger: #fb7185;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
        color: var(--text);
        background:
          radial-gradient(900px 600px at 10% 0%, rgba(167, 139, 250, 0.22), transparent 60%),
          radial-gradient(900px 700px at 95% 10%, rgba(126, 231, 255, 0.2), transparent 62%),
          radial-gradient(1100px 780px at 40% 120%, rgba(52, 211, 153, 0.13), transparent 56%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        overflow-x: hidden;
      }

      a {
        color: inherit;
      }

      .wrap {
        width: min(1080px, calc(100% - 32px));
        margin: 0 auto;
        padding: 24px 0 36px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 14px;
        border: 1px solid var(--line);
        border-radius: calc(var(--radius) + 6px);
        background: rgba(255, 255, 255, 0.06);
        box-shadow: var(--shadow2);
        backdrop-filter: blur(12px);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }

      .logo {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        background:
          radial-gradient(18px 18px at 30% 25%, rgba(255, 255, 255, 0.22), transparent 60%),
          linear-gradient(135deg, rgba(126, 231, 255, 0.85), rgba(167, 139, 250, 0.9));
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.25),
          0 18px 48px rgba(0, 0, 0, 0.35);
        position: relative;
        overflow: hidden;
      }
      .logo::after {
        content: "";
        position: absolute;
        inset: -40%;
        background: conic-gradient(from 90deg, rgba(255, 255, 255, 0.12), transparent 45%, rgba(255, 255, 255, 0.18));
        transform: rotate(22deg);
        filter: blur(1px);
      }

      .title {
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .title h1 {
        font-size: 16px;
        line-height: 1.1;
        margin: 0;
        letter-spacing: 0.2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .title .subtitle {
        font-size: 12.5px;
        color: var(--muted);
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.06);
        color: var(--muted);
        font-size: 12.5px;
      }

      .chip strong {
        color: var(--text);
        font-weight: 600;
      }

      button,
      select {
        font: inherit;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        cursor: pointer;
        user-select: none;
        transition:
          transform 140ms ease,
          background 140ms ease,
          border-color 140ms ease,
          opacity 140ms ease;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12);
      }
      .btn:hover {
        background: rgba(255, 255, 255, 0.11);
        border-color: rgba(255, 255, 255, 0.2);
      }
      .btn:active {
        transform: translateY(1px) scale(0.99);
      }
      .btn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }
      .btn.primary {
        background: linear-gradient(135deg, rgba(126, 231, 255, 0.22), rgba(167, 139, 250, 0.24));
        border-color: rgba(126, 231, 255, 0.28);
      }
      .btn.danger {
        border-color: rgba(251, 113, 133, 0.35);
        background: rgba(251, 113, 133, 0.09);
      }
      .btn.ghost {
        background: transparent;
      }

      .btn .icon {
        width: 16px;
        height: 16px;
        display: inline-block;
      }

      .select {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: rgba(10, 12, 26, 0.55);
        color: var(--text);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
        appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, rgba(255, 255, 255, 0.7) 50%),
          linear-gradient(135deg, rgba(255, 255, 255, 0.7) 50%, transparent 50%),
          linear-gradient(to right, transparent, transparent);
        background-position:
          calc(100% - 18px) calc(50% - 2px),
          calc(100% - 13px) calc(50% - 2px),
          0 0;
        background-size:
          5px 5px,
          5px 5px,
          100% 100%;
        background-repeat: no-repeat;
        padding-right: 32px;
      }

      :focus-visible {
        outline: 2px solid var(--focus);
        outline-offset: 3px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1.15fr 0.85fr;
        gap: 18px;
        margin-top: 18px;
        align-items: start;
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .panel {
        border: 1px solid var(--line);
        border-radius: calc(var(--radius) + 8px);
        background: rgba(255, 255, 255, 0.06);
        box-shadow: var(--shadow2);
        backdrop-filter: blur(14px);
        overflow: hidden;
      }

      .panel-header {
        padding: 14px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .panel-header h2 {
        margin: 0;
        font-size: 13px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .panel-body {
        padding: 16px;
      }

      .welcome {
        display: grid;
        gap: 12px;
      }

      .welcome h2 {
        margin: 0;
        font-size: 22px;
        letter-spacing: -0.01em;
      }

      .welcome p {
        margin: 0;
        color: var(--muted);
        line-height: 1.45;
      }

      .lang-cards {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }
      @media (max-width: 520px) {
        .lang-cards {
          grid-template-columns: 1fr;
        }
      }

      .lang-card {
        position: relative;
        padding: 14px 14px 12px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.07);
        cursor: pointer;
        transition:
          transform 140ms ease,
          background 140ms ease,
          border-color 140ms ease;
        user-select: none;
      }
      .lang-card:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.22);
      }
      .lang-card:active {
        transform: translateY(0) scale(0.99);
      }
      .lang-card[aria-pressed="true"] {
        border-color: rgba(126, 231, 255, 0.35);
        background: linear-gradient(135deg, rgba(126, 231, 255, 0.14), rgba(167, 139, 250, 0.16));
      }

      .lang-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .lang-meta {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }

      .flag {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.09);
        border: 1px solid rgba(255, 255, 255, 0.12);
        font-size: 18px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12);
      }

      .lang-name {
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .lang-name .primary {
        font-weight: 650;
        letter-spacing: 0.2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .lang-name .secondary {
        margin-top: 2px;
        font-size: 12.5px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .small {
        font-size: 12.5px;
        color: var(--muted);
      }

      .hint {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px dashed rgba(255, 255, 255, 0.18);
        color: var(--muted);
        background: rgba(0, 0, 0, 0.1);
      }

      .deck {
        display: grid;
        gap: 14px;
      }

      .progress {
        display: grid;
        gap: 10px;
      }

      .progress-row {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
      }

      .progress-row .big {
        font-size: 18px;
        font-weight: 650;
        letter-spacing: -0.01em;
      }

      .bar {
        height: 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.06);
        overflow: hidden;
      }
      .bar > div {
        height: 100%;
        width: 0%;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(126, 231, 255, 0.95), rgba(167, 139, 250, 0.95));
        transition: width 260ms ease;
      }

      .card-area {
        display: grid;
        place-items: center;
        padding: 10px 0 4px;
      }

      .scene {
        width: min(560px, 100%);
        aspect-ratio: 16 / 10;
        min-height: 300px;
        position: relative;
        perspective: 1400px;
      }

      .scene::before,
      .scene::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: calc(var(--radius) + 12px);
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.07);
        transform: translateY(10px) scale(0.98);
        filter: blur(0.2px);
      }
      .scene::after {
        transform: translateY(18px) scale(0.96);
        background: rgba(255, 255, 255, 0.02);
      }

      .card {
        position: absolute;
        inset: 0;
        border-radius: calc(var(--radius) + 12px);
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.09), rgba(255, 255, 255, 0.06));
        box-shadow: var(--shadow);
        transform-style: preserve-3d;
        cursor: pointer;
        user-select: none;
        isolation: isolate;
      }

      .card::before {
        content: "";
        position: absolute;
        inset: 1px;
        border-radius: calc(var(--radius) + 11px);
        background:
          radial-gradient(80px 70px at 14% 18%, rgba(126, 231, 255, 0.17), transparent 70%),
          radial-gradient(120px 100px at 85% 20%, rgba(167, 139, 250, 0.15), transparent 70%),
          radial-gradient(120px 120px at 60% 100%, rgba(52, 211, 153, 0.12), transparent 60%);
        opacity: 0.7;
        pointer-events: none;
      }

      .card-inner {
        position: absolute;
        inset: 0;
        border-radius: calc(var(--radius) + 12px);
        transform-style: preserve-3d;
        transition: transform 680ms cubic-bezier(0.2, 0.9, 0.2, 1);
      }

      .card.flipped .card-inner {
        transform: rotateY(180deg);
      }

      .face {
        position: absolute;
        inset: 0;
        border-radius: calc(var(--radius) + 12px);
        padding: 18px 18px 16px;
        backface-visibility: hidden;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 14px;
      }

      .face.back {
        transform: rotateY(180deg);
      }

      .face-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.12);
        color: var(--muted);
        font-size: 12.5px;
      }

      .pill .dot {
        width: 9px;
        height: 9px;
        border-radius: 99px;
        background: rgba(126, 231, 255, 0.95);
        box-shadow: 0 0 0 4px rgba(126, 231, 255, 0.15);
      }
      .pill.back .dot {
        background: rgba(167, 139, 250, 0.95);
        box-shadow: 0 0 0 4px rgba(167, 139, 250, 0.14);
      }

      .speak {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.07);
        display: grid;
        place-items: center;
        cursor: pointer;
        transition:
          transform 140ms ease,
          background 140ms ease,
          border-color 140ms ease,
          opacity 140ms ease;
      }
      .speak:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.22);
      }
      .speak:active {
        transform: translateY(1px);
      }
      .speak:disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }
      .speak svg {
        width: 18px;
        height: 18px;
        fill: none;
        stroke: rgba(255, 255, 255, 0.86);
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      .phrase {
        display: grid;
        place-items: center;
        text-align: center;
        padding: 0 12px;
      }

      .phrase .text {
        font-size: clamp(22px, 4.2vw, 38px);
        font-weight: 750;
        letter-spacing: -0.02em;
        line-height: 1.12;
        text-wrap: balance;
      }

      .phrase .note {
        margin-top: 10px;
        font-size: 14px;
        color: var(--muted);
        letter-spacing: 0.01em;
      }

      .face-bottom {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        color: var(--muted);
        font-size: 12.5px;
      }

      .kbd {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
        text-align: right;
      }

      kbd {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        padding: 2px 7px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(0, 0, 0, 0.14);
        color: rgba(255, 255, 255, 0.86);
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
      }
      @media (max-width: 520px) {
        .controls {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      .side {
        display: grid;
        gap: 14px;
      }

      .field {
        display: grid;
        gap: 8px;
      }

      .field label {
        font-size: 12.5px;
        color: var(--muted);
      }

      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .list {
        display: grid;
        gap: 10px;
      }

      .mini {
        padding: 12px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.05);
        display: grid;
        gap: 6px;
      }

      .mini .line1 {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .mini .line1 strong {
        font-size: 13.5px;
      }

      .mini .line2 {
        color: var(--muted);
        font-size: 12.5px;
        line-height: 1.3;
      }

      .toast {
        position: fixed;
        left: 50%;
        top: 14px;
        transform: translateX(-50%);
        z-index: 30;
        width: min(720px, calc(100% - 24px));
        pointer-events: none;
      }

      .toast .card {
        pointer-events: auto;
        position: relative;
        inset: auto;
        width: 100%;
        padding: 12px 12px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(15, 18, 41, 0.72);
        backdrop-filter: blur(12px);
        box-shadow: var(--shadow2);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        animation: toastIn 220ms ease both;
      }

      @keyframes toastIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .toast .msg {
        color: rgba(255, 255, 255, 0.9);
        font-size: 13px;
        line-height: 1.35;
      }

      .toast .msg em {
        color: var(--accent);
        font-style: normal;
        font-weight: 650;
      }

      .modal {
        position: fixed;
        inset: 0;
        z-index: 40;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 18px;
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(8px);
      }

      .modal[aria-hidden="false"] {
        display: flex;
      }

      .modal .sheet {
        width: min(760px, 100%);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(15, 18, 41, 0.78);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .sheet-header {
        padding: 14px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .sheet-header h3 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--muted);
      }
      .sheet-body {
        padding: 16px;
        display: grid;
        gap: 14px;
      }

      .learned-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }
      @media (max-width: 700px) {
        .learned-grid {
          grid-template-columns: 1fr;
        }
      }

      .learned-item {
        padding: 12px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.05);
        display: grid;
        gap: 6px;
      }

      .learned-item .top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .learned-item .top strong {
        font-size: 13.5px;
        line-height: 1.2;
      }

      .learned-item .bottom {
        color: var(--muted);
        font-size: 12.5px;
        line-height: 1.35;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 9px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.12);
        color: var(--muted);
        font-size: 12px;
      }

      .success {
        color: rgba(52, 211, 153, 0.98);
      }

      .muted {
        color: var(--muted);
      }

      .sr {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .hidden {
        display: none !important;
      }

      .swapOut {
        animation: swapOut 240ms ease both;
      }
      .swapIn {
        animation: swapIn 240ms ease both;
      }
      .shuffleWiggle {
        animation: shuffleWiggle 520ms cubic-bezier(0.2, 0.9, 0.2, 1) both;
      }

      @keyframes swapOut {
        from {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        to {
          opacity: 0;
          transform: translateY(8px) scale(0.985);
        }
      }
      @keyframes swapIn {
        from {
          opacity: 0;
          transform: translateY(8px) scale(0.985);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      @keyframes shuffleWiggle {
        0% {
          transform: rotate(0deg) scale(1);
        }
        25% {
          transform: rotate(-2deg) translateX(-10px) scale(1.01);
        }
        55% {
          transform: rotate(1.5deg) translateX(10px) scale(1.01);
        }
        100% {
          transform: rotate(0deg) scale(1);
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .card-inner,
        .btn,
        .bar > div {
          transition: none !important;
        }
        .swapOut,
        .swapIn,
        .shuffleWiggle,
        .toast .card {
          animation: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

    <div class="modal" id="settingsModal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Settings">
      <div class="sheet" role="document">
        <div class="sheet-header">
          <h3 id="settingsTitle">Settings</h3>
          <button class="btn ghost" id="closeSettingsBtn" type="button">
            <span class="icon" aria-hidden="true">‚úï</span>
            <span id="closeLabel">Close</span>
          </button>
        </div>
        <div class="sheet-body">
          <div class="field">
            <label for="uiLangSelect" id="uiLangLabel">UI language</label>
            <select class="select" id="uiLangSelect"></select>
          </div>
          <div class="field">
            <label for="sourceLangSelect" id="sourceLangLabel">Front side (I speak)</label>
            <select class="select" id="sourceLangSelect"></select>
            <div class="small" id="sourceLangHint"></div>
          </div>
          <div class="row">
            <button class="btn" id="learnedBtn" type="button">
              <span class="icon" aria-hidden="true">‚úì</span>
              <span id="viewLearnedLabel">View learned</span>
            </button>
            <button class="btn danger" id="resetBtn" type="button">
              <span class="icon" aria-hidden="true">‚Ü∫</span>
              <span id="resetLabel">Reset progress</span>
            </button>
          </div>
          <div class="small muted" id="shortcutsHint"></div>
        </div>
      </div>
    </div>

    <div class="modal" id="learnedModal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Learned">
      <div class="sheet" role="document">
        <div class="sheet-header">
          <h3 id="learnedTitle">Learned</h3>
          <button class="btn ghost" id="closeLearnedBtn" type="button">
            <span class="icon" aria-hidden="true">‚úï</span>
            <span id="closeLearnedLabel">Close</span>
          </button>
        </div>
        <div class="sheet-body">
          <div class="row">
            <span class="badge" id="learnedCountBadge"></span>
            <span class="small muted" id="learnedHint"></span>
          </div>
          <div class="learned-grid" id="learnedGrid"></div>
        </div>
      </div>
    </div>

    <main class="wrap" id="app">
      <header class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="title">
            <h1 id="appTitle">Language Learning Flashcards</h1>
            <div class="subtitle" id="appSubtitle">Flip ‚Ä¢ Listen ‚Ä¢ Learn</div>
          </div>
        </div>
        <div class="actions">
          <span class="chip" id="langChip"><strong id="chipFrom">EN</strong><span aria-hidden="true">‚Üí</span><strong id="chipTo">ES</strong></span>
          <span class="chip"><span id="chipProgressLabel">Progress</span><strong id="chipProgressValue">0/10</strong></span>
          <button class="btn primary" id="openSettingsBtn" type="button" aria-haspopup="dialog">
            <span class="icon" aria-hidden="true">‚öôÔ∏é</span>
            <span id="settingsLabel">Settings</span>
          </button>
        </div>
      </header>

      <section class="grid" aria-label="Flashcards">
        <div class="panel" id="mainPanel">
          <div class="panel-header">
            <h2 id="mainHeader">Start</h2>
            <div class="row">
              <span class="badge" id="statusBadge"></span>
            </div>
          </div>
          <div class="panel-body" id="mainBody">
            <div class="welcome" id="welcome">
              <h2 id="welcomeTitle">Pick a language</h2>
              <p id="welcomeCopy">Choose the language you want to learn. We‚Äôll use your device locale to translate the interface and pick a default ‚ÄúI speak‚Äù language.</p>
              <div class="row">
                <div class="field" style="min-width: 260px; flex: 1">
                  <label for="welcomeSourceSelect" id="welcomeSourceLabel">I speak</label>
                  <select class="select" id="welcomeSourceSelect"></select>
                </div>
              </div>
              <div class="field">
                <label id="welcomeLearnLabel">I want to learn</label>
                <div class="lang-cards" id="learnLangCards"></div>
              </div>
              <div class="hint" id="welcomeHint">
                <div id="welcomeHintText">Tip: click a card (or press Space) to flip it.</div>
                <div class="kbd" aria-hidden="true"><kbd>Space</kbd> <kbd>‚Üê</kbd><kbd>‚Üí</kbd> <kbd>L</kbd> <kbd>S</kbd></div>
              </div>
            </div>

            <div class="deck hidden" id="deck">
              <div class="progress">
                <div class="progress-row">
                  <div class="big" id="progressTitle">Today‚Äôs set</div>
                  <div class="small" id="progressMeta">10 travel phrases</div>
                </div>
                <div class="bar" aria-hidden="true"><div id="barFill"></div></div>
              </div>

              <div class="card-area">
                <div class="scene" id="scene">
                  <div class="card" id="card" role="button" tabindex="0" aria-label="Flashcard">
                    <div class="card-inner">
                      <div class="face front">
                        <div class="face-top">
                          <span class="pill"><span class="dot" aria-hidden="true"></span><span id="frontLangLabel">Front</span></span>
                          <button class="speak" id="speakFront" type="button" aria-label="Speak front">
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                              <path d="M11 5 7 9H4v6h3l4 4z"></path>
                              <path d="M15.5 8.5a4 4 0 0 1 0 7"></path>
                              <path d="M17.8 6.2a7 7 0 0 1 0 11.6"></path>
                            </svg>
                          </button>
                        </div>
                        <div class="phrase">
                          <div class="text" id="frontText">‚Äî</div>
                          <div class="note" id="frontNote"></div>
                        </div>
                        <div class="face-bottom">
                          <span id="tapHint">Tap/click to flip</span>
                          <span class="kbd" aria-hidden="true"><kbd>Space</kbd></span>
                        </div>
                      </div>

                      <div class="face back">
                        <div class="face-top">
                          <span class="pill back"><span class="dot" aria-hidden="true"></span><span id="backLangLabel">Back</span></span>
                          <button class="speak" id="speakBack" type="button" aria-label="Speak back">
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                              <path d="M11 5 7 9H4v6h3l4 4z"></path>
                              <path d="M15.5 8.5a4 4 0 0 1 0 7"></path>
                              <path d="M17.8 6.2a7 7 0 0 1 0 11.6"></path>
                            </svg>
                          </button>
                        </div>
                        <div class="phrase">
                          <div class="text" id="backText">‚Äî</div>
                          <div class="note" id="backNote"></div>
                        </div>
                        <div class="face-bottom">
                          <span id="answerHint">Mark learned when it feels automatic.</span>
                          <span class="kbd" aria-hidden="true"><kbd>L</kbd></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="controls" role="group" aria-label="Controls">
                <button class="btn" id="prevBtn" type="button">
                  <span class="icon" aria-hidden="true">‚Üê</span>
                  <span id="prevLabel">Prev</span>
                </button>
                <button class="btn" id="nextBtn" type="button">
                  <span id="nextLabel">Next</span>
                  <span class="icon" aria-hidden="true">‚Üí</span>
                </button>
                <button class="btn" id="shuffleBtn" type="button">
                  <span class="icon" aria-hidden="true">‚§Æ</span>
                  <span id="shuffleLabel">Shuffle</span>
                </button>
                <button class="btn primary" id="learnBtn" type="button">
                  <span class="icon" aria-hidden="true">‚úì</span>
                  <span id="learnLabel">Mark learned</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <aside class="side">
          <div class="panel">
            <div class="panel-header">
              <h2 id="sideHeader">Quick setup</h2>
              <span class="badge" id="voiceBadge"></span>
            </div>
            <div class="panel-body">
              <div class="field">
                <label for="learnLangSelect" id="learnLangLabel">Learning</label>
                <select class="select" id="learnLangSelect"></select>
              </div>
              <div class="field">
                <label for="inlineSourceSelect" id="inlineSourceLabel">Front side (I speak)</label>
                <select class="select" id="inlineSourceSelect"></select>
              </div>
              <div class="row">
                <button class="btn" id="restartBtn" type="button">
                  <span class="icon" aria-hidden="true">‚òÖ</span>
                  <span id="restartLabel">Start over</span>
                </button>
                <button class="btn" id="openLearnedBtn" type="button" aria-haspopup="dialog">
                  <span class="icon" aria-hidden="true">‚úì</span>
                  <span id="openLearnedLabel">Learned</span>
                </button>
              </div>
              <div class="list">
                <div class="mini">
                  <div class="line1">
                    <strong id="miniTipTitle">Practice tip</strong>
                    <span class="badge" id="miniCount">10</span>
                  </div>
                  <div class="line2" id="miniTipBody">Say the front phrase out loud, flip, then repeat the answer twice.</div>
                </div>
                <div class="mini">
                  <div class="line1">
                    <strong id="miniKeysTitle">Keyboard</strong>
                    <span class="badge">Space ‚Ä¢ ‚Üê/‚Üí ‚Ä¢ L ‚Ä¢ S</span>
                  </div>
                  <div class="line2" id="miniKeysBody">Space flips. L marks learned. S shuffles. Arrow keys navigate.</div>
                </div>
              </div>
            </div>
          </div>
        </aside>
      </section>
    </main>

    <script>
      (() => {
        "use strict";

        const APP_KEY = "ll_flashcards_v1";
        const SUPPORTED = ["en", "es", "fr", "ja"];
        const LANG = {
          en: { label: "English", native: "English", flag: "üá¨üáß" },
          es: { label: "Spanish", native: "Espa√±ol", flag: "üá™üá∏" },
          fr: { label: "French", native: "Fran√ßais", flag: "üá´üá∑" },
          ja: { label: "Japanese", native: "Êó•Êú¨Ë™û", flag: "üáØüáµ" },
        };

        const STR = {
          en: {
            appTitle: "Language Learning Flashcards",
            appSubtitle: "Flip ‚Ä¢ Listen ‚Ä¢ Learn",
            start: "Start",
            setup: "Quick setup",
            progress: "Progress",
            settings: "Settings",
            close: "Close",
            settingsTitle: "Settings",
            uiLang: "UI language",
            sourceLang: "Front side (I speak)",
            sourceHint: "The front shows what you already understand.",
            viewLearned: "View learned",
            learned: "Learned",
            reset: "Reset progress",
            shortcuts: "Shortcuts: Space flip ‚Ä¢ ‚Üê/‚Üí navigate ‚Ä¢ L learned ‚Ä¢ S shuffle ‚Ä¢ Esc close dialogs",
            welcomeTitle: "Pick a language",
            welcomeCopy:
              "Choose the language you want to learn. The interface follows your device locale and you can change it anytime.",
            iSpeak: "I speak",
            iWantToLearn: "I want to learn",
            tip: "Tip: click a card (or press Space) to flip it.",
            today: "Today‚Äôs set",
            travelPhrases: "10 travel phrases",
            front: "Front",
            back: "Back",
            tapFlip: "Tap/click to flip",
            markHint: "Mark learned when it feels automatic.",
            prev: "Prev",
            next: "Next",
            shuffle: "Shuffle",
            markLearned: "Mark learned",
            startOver: "Switch language",
            practiceTipTitle: "Practice tip",
            practiceTipBody: "Say the front phrase out loud, flip, then repeat the answer twice.",
            keyboardTitle: "Keyboard",
            keyboardBody: "Space flips. L marks learned. S shuffles. Arrow keys navigate.",
            voiceReady: "Voice",
            voiceOk: "Ready",
            voiceMaybe: "Optional",
            noLearnLang: "Choose a language to begin.",
            status: ({ remaining, total }) => `${remaining} remaining ‚Ä¢ ${total} total`,
            learnedCount: ({ n }) => `${n} learned`,
            noLearnedYet: "No learned phrases yet.",
            learnedHint: "Tap a phrase to unlearn it.",
            unlearn: "Unlearn",
            toastLearned: ({ from, to }) => `Marked as learned: <em>${from}</em> ‚Üí <em>${to}</em>`,
            undo: "Undo",
            toastShuffled: "Shuffled the deck.",
            toastReset: "Progress reset.",
            doneTitle: "All done!",
            doneBody: "You‚Äôve learned all 10 phrases for this language.",
            doneCta: "Review learned",
          },
          es: {
            appTitle: "Tarjetas para aprender idiomas",
            appSubtitle: "Voltea ‚Ä¢ Escucha ‚Ä¢ Aprende",
            start: "Inicio",
            setup: "Configuraci√≥n r√°pida",
            progress: "Progreso",
            settings: "Ajustes",
            close: "Cerrar",
            settingsTitle: "Ajustes",
            uiLang: "Idioma de la interfaz",
            sourceLang: "Cara frontal (yo hablo)",
            sourceHint: "La cara frontal muestra lo que ya entiendes.",
            viewLearned: "Ver aprendidas",
            learned: "Aprendidas",
            reset: "Reiniciar progreso",
            shortcuts: "Atajos: Espacio voltea ‚Ä¢ ‚Üê/‚Üí navega ‚Ä¢ L aprendida ‚Ä¢ S mezclar ‚Ä¢ Esc cierra di√°logos",
            welcomeTitle: "Elige un idioma",
            welcomeCopy:
              "Selecciona el idioma que quieres aprender. La interfaz usa el idioma de tu dispositivo y puedes cambiarlo cuando quieras.",
            iSpeak: "Yo hablo",
            iWantToLearn: "Quiero aprender",
            tip: "Consejo: haz clic en una tarjeta (o pulsa Espacio) para voltearla.",
            today: "Set de hoy",
            travelPhrases: "10 frases de viaje",
            front: "Frente",
            back: "Reverso",
            tapFlip: "Toca/clic para voltear",
            markHint: "Marca como aprendida cuando salga autom√°ticamente.",
            prev: "Anterior",
            next: "Siguiente",
            shuffle: "Mezclar",
            markLearned: "Marcar aprendida",
            startOver: "Cambiar idioma",
            practiceTipTitle: "Consejo",
            practiceTipBody: "Di la frase del frente, voltea y repite la respuesta dos veces.",
            keyboardTitle: "Teclado",
            keyboardBody: "Espacio voltea. L marca aprendida. S mezcla. Flechas navegan.",
            voiceReady: "Voz",
            voiceOk: "Lista",
            voiceMaybe: "Opcional",
            noLearnLang: "Elige un idioma para empezar.",
            status: ({ remaining, total }) => `${remaining} pendientes ‚Ä¢ ${total} total`,
            learnedCount: ({ n }) => `${n} aprendidas`,
            noLearnedYet: "A√∫n no hay frases aprendidas.",
            learnedHint: "Toca una frase para desmarcarla.",
            unlearn: "Desmarcar",
            toastLearned: ({ from, to }) => `Marcada como aprendida: <em>${from}</em> ‚Üí <em>${to}</em>`,
            undo: "Deshacer",
            toastShuffled: "Baraja mezclada.",
            toastReset: "Progreso reiniciado.",
            doneTitle: "¬°Listo!",
            doneBody: "Has aprendido las 10 frases de este idioma.",
            doneCta: "Ver aprendidas",
          },
          fr: {
            appTitle: "Cartes m√©moire ‚Äì langues",
            appSubtitle: "Retourne ‚Ä¢ √âcoute ‚Ä¢ Apprends",
            start: "D√©but",
            setup: "R√©glages rapides",
            progress: "Progression",
            settings: "R√©glages",
            close: "Fermer",
            settingsTitle: "R√©glages",
            uiLang: "Langue de l‚Äôinterface",
            sourceLang: "Recto (je parle)",
            sourceHint: "Le recto montre ce que tu comprends d√©j√†.",
            viewLearned: "Voir acquis",
            learned: "Acquis",
            reset: "R√©initialiser",
            shortcuts: "Raccourcis : Espace retourne ‚Ä¢ ‚Üê/‚Üí navigue ‚Ä¢ L acquis ‚Ä¢ S m√©langer ‚Ä¢ √âchap ferme les fen√™tres",
            welcomeTitle: "Choisis une langue",
            welcomeCopy:
              "S√©lectionne la langue que tu veux apprendre. L‚Äôinterface suit la langue de ton appareil et tu peux la changer √† tout moment.",
            iSpeak: "Je parle",
            iWantToLearn: "Je veux apprendre",
            tip: "Astuce : clique sur une carte (ou appuie sur Espace) pour la retourner.",
            today: "S√©rie du jour",
            travelPhrases: "10 phrases de voyage",
            front: "Recto",
            back: "Verso",
            tapFlip: "Clique pour retourner",
            markHint: "Marque ¬´ acquis ¬ª quand c‚Äôest automatique.",
            prev: "Pr√©c√©dent",
            next: "Suivant",
            shuffle: "M√©langer",
            markLearned: "Marquer acquis",
            startOver: "Changer de langue",
            practiceTipTitle: "Conseil",
            practiceTipBody: "Dis la phrase du recto, retourne, puis r√©p√®te la r√©ponse deux fois.",
            keyboardTitle: "Clavier",
            keyboardBody: "Espace retourne. L marque acquis. S m√©lange. Fl√®ches naviguent.",
            voiceReady: "Voix",
            voiceOk: "Pr√™te",
            voiceMaybe: "Optionnelle",
            noLearnLang: "Choisis une langue pour commencer.",
            status: ({ remaining, total }) => `${remaining} restantes ‚Ä¢ ${total} au total`,
            learnedCount: ({ n }) => `${n} acquis`,
            noLearnedYet: "Aucune phrase acquise pour l‚Äôinstant.",
            learnedHint: "Clique sur une phrase pour l‚Äôannuler.",
            unlearn: "Annuler",
            toastLearned: ({ from, to }) => `Marqu√© comme acquis : <em>${from}</em> ‚Üí <em>${to}</em>`,
            undo: "Annuler",
            toastShuffled: "Paquet m√©lang√©.",
            toastReset: "Progression r√©initialis√©e.",
            doneTitle: "Termin√© !",
            doneBody: "Tu as appris les 10 phrases pour cette langue.",
            doneCta: "Voir acquis",
          },
          ja: {
            appTitle: "Ë™ûÂ≠¶„Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ",
            appSubtitle: "„ÇÅ„Åè„Çã ‚Ä¢ ËÅû„Åè ‚Ä¢ Ë¶ö„Åà„Çã",
            start: "„Çπ„Çø„Éº„Éà",
            setup: "„ÇØ„Ç§„ÉÉ„ÇØË®≠ÂÆö",
            progress: "ÈÄ≤Êçó",
            settings: "Ë®≠ÂÆö",
            close: "Èñâ„Åò„Çã",
            settingsTitle: "Ë®≠ÂÆö",
            uiLang: "UI Ë®ÄË™û",
            sourceLang: "Ë°®ÔºàËá™ÂàÜ„ÅÆË®ÄË™ûÔºâ",
            sourceHint: "Ë°®„ÅØ„Åô„Åß„Å´ÁêÜËß£„Åß„Åç„ÇãË®ÄË™û„Å´„Åó„Åæ„Åô„ÄÇ",
            viewLearned: "ÁøíÂæóÊ∏à„Åø„ÇíË¶ã„Çã",
            learned: "ÁøíÂæóÊ∏à„Åø",
            reset: "ÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà",
            shortcuts: "„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÔºöSpace „Åß„ÇÅ„Åè„Çã ‚Ä¢ ‚Üê/‚Üí „ÅßÁßªÂãï ‚Ä¢ L „ÅßÁøíÂæó ‚Ä¢ S „Åß„Ç∑„É£„ÉÉ„Éï„É´ ‚Ä¢ Esc „ÅßÈñâ„Åò„Çã",
            welcomeTitle: "Ë®ÄË™û„ÇíÈÅ∏Êäû",
            welcomeCopy:
              "Â≠¶„Å≥„Åü„ÅÑË®ÄË™û„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇUI „ÅØÁ´ØÊú´„ÅÆË®ÄË™û„Å´Âêà„Çè„Åõ„Å¶Ë°®Á§∫„Åï„Çå„ÄÅ„ÅÑ„Å§„Åß„ÇÇÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ",
            iSpeak: "Ëá™ÂàÜ„ÅÆË®ÄË™û",
            iWantToLearn: "Â≠¶„Å≥„Åü„ÅÑË®ÄË™û",
            tip: "„Éí„É≥„ÉàÔºö„Ç´„Éº„Éâ„Çí„ÇØ„É™„ÉÉ„ÇØÔºà„Åæ„Åü„ÅØ SpaceÔºâ„ÅßË£èËøî„Åõ„Åæ„Åô„ÄÇ",
            today: "‰ªäÊó•„ÅÆ„Çª„ÉÉ„Éà",
            travelPhrases: "ÊóÖË°å„Åß‰Ωø„Åà„Çã10„Éï„É¨„Éº„Ç∫",
            front: "Ë°®",
            back: "Ë£è",
            tapFlip: "„Çø„ÉÉ„Éó„Åß„ÇÅ„Åè„Çã",
            markHint: "Ëá™ÁÑ∂„Å´Âá∫„Å¶„Åè„Çã„Çà„ÅÜ„Å´„Å™„Å£„Åü„Çâ„ÄåÁøíÂæó„Äç„Å´„Åó„Åæ„Åô„ÄÇ",
            prev: "Ââç„Å∏",
            next: "Ê¨°„Å∏",
            shuffle: "„Ç∑„É£„ÉÉ„Éï„É´",
            markLearned: "ÁøíÂæó„Å´„Åô„Çã",
            startOver: "Ë®ÄË™û„ÇíÂ§âÊõ¥",
            practiceTipTitle: "Á∑¥Áøí„ÅÆ„Ç≥„ÉÑ",
            practiceTipBody: "Ë°®„ÇíÂ£∞„Å´Âá∫„Åó„ÄÅ„ÇÅ„Åè„Å£„Å¶Á≠î„Åà„Çí2ÂõûÁπ∞„ÇäËøî„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ",
            keyboardTitle: "„Ç≠„Éº„Éú„Éº„Éâ",
            keyboardBody: "Space „Åß„ÇÅ„Åè„Çã„ÄÇL „ÅßÁøíÂæó„ÄÇS „Åß„Ç∑„É£„ÉÉ„Éï„É´„ÄÇÁü¢Âç∞„ÅßÁßªÂãï„ÄÇ",
            voiceReady: "Èü≥Â£∞",
            voiceOk: "Âà©Áî®ÂèØ",
            voiceMaybe: "‰ªªÊÑè",
            noLearnLang: "ÊúÄÂàù„Å´Â≠¶„Å≥„Åü„ÅÑË®ÄË™û„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ",
            status: ({ remaining, total }) => `ÊÆã„Çä ${remaining} ‚Ä¢ ÂÖ® ${total}`,
            learnedCount: ({ n }) => `ÁøíÂæó ${n}`,
            noLearnedYet: "„Åæ„Å†ÁøíÂæóÊ∏à„Åø„ÅÆ„Éï„É¨„Éº„Ç∫„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ",
            learnedHint: "„Éï„É¨„Éº„Ç∫„Çí„Çø„ÉÉ„Éó„Åô„Çã„Å®Âèñ„ÇäÊ∂à„Åõ„Åæ„Åô„ÄÇ",
            unlearn: "Âèñ„ÇäÊ∂à„Åô",
            toastLearned: ({ from, to }) => `ÁøíÂæó„Å´„Åó„Åæ„Åó„ÅüÔºö<em>${from}</em> ‚Üí <em>${to}</em>`,
            undo: "ÂÖÉ„Å´Êàª„Åô",
            toastShuffled: "„Ç∑„É£„ÉÉ„Éï„É´„Åó„Åæ„Åó„Åü„ÄÇ",
            toastReset: "ÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ",
            doneTitle: "ÂÆå‰∫ÜÔºÅ",
            doneBody: "„Åì„ÅÆË®ÄË™û„ÅÆ10„Éï„É¨„Éº„Ç∫„Çí„Åô„Åπ„Å¶ÁøíÂæó„Åó„Åæ„Åó„Åü„ÄÇ",
            doneCta: "ÁøíÂæóÊ∏à„Åø„ÇíË¶ã„Çã",
          },
        };

        const PHRASES = [
          {
            id: "hello",
            text: { en: "Hello", es: "Hola", fr: "Bonjour", ja: "„Åì„Çì„Å´„Å°„ÅØ" },
            note: { ja: "Konnichiwa" },
          },
          {
            id: "thanks",
            text: { en: "Thank you", es: "Gracias", fr: "Merci", ja: "„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô" },
            note: { ja: "Arigat≈ç gozaimasu" },
          },
          {
            id: "excuse",
            text: { en: "Excuse me / Sorry", es: "Perd√≥n / Disculpe", fr: "Excusez‚Äëmoi / Pardon", ja: "„Åô„Åø„Åæ„Åõ„Çì" },
            note: { ja: "Sumimasen" },
          },
          {
            id: "english",
            text: { en: "Do you speak English?", es: "¬øHabla ingl√©s?", fr: "Parlez‚Äëvous anglais ?", ja: "Ëã±Ë™û„ÇíË©±„Åõ„Åæ„Åô„ÅãÔºü" },
            note: { ja: "Eigo o hanasemasu ka?" },
          },
          {
            id: "bathroom",
            text: { en: "Where is the bathroom?", es: "¬øD√≥nde est√° el ba√±o?", fr: "O√π sont les toilettes ?", ja: "„Éà„Ç§„É¨„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü" },
            note: { ja: "Toire wa doko desu ka?" },
          },
          {
            id: "price",
            text: { en: "How much does this cost?", es: "¬øCu√°nto cuesta esto?", fr: "Combien √ßa co√ªte ?", ja: "„Åì„Çå„ÅØ„ÅÑ„Åè„Çâ„Åß„Åô„ÅãÔºü" },
            note: { ja: "Kore wa ikura desu ka?" },
          },
          {
            id: "pleaseThis",
            text: { en: "I would like this, please.", es: "Me gustar√≠a esto, por favor.", fr: "Je voudrais ceci, s‚Äôil vous pla√Æt.", ja: "„Åì„Çå„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ" },
            note: { ja: "Kore o kudasai." },
          },
          {
            id: "help",
            text: { en: "Help!", es: "¬°Ayuda!", fr: "√Ä l‚Äôaide !", ja: "Âä©„Åë„Å¶ÔºÅ" },
            note: { ja: "Tasukete!" },
          },
          {
            id: "station",
            text: { en: "Where is the train station?", es: "¬øD√≥nde est√° la estaci√≥n de tren?", fr: "O√π est la gare ?", ja: "ÈßÖ„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü" },
            note: { ja: "Eki wa doko desu ka?" },
          },
          {
            id: "water",
            text: { en: "Water, please.", es: "Agua, por favor.", fr: "De l‚Äôeau, s‚Äôil vous pla√Æt.", ja: "„ÅäÊ∞¥„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ" },
            note: { ja: "O‚Äëmizu o kudasai." },
          },
        ];

        const $ = (sel) => document.querySelector(sel);
        const el = {
          appTitle: $("#appTitle"),
          appSubtitle: $("#appSubtitle"),
          mainHeader: $("#mainHeader"),
          statusBadge: $("#statusBadge"),
          langChip: $("#langChip"),
          chipFrom: $("#chipFrom"),
          chipTo: $("#chipTo"),
          chipProgressLabel: $("#chipProgressLabel"),
          chipProgressValue: $("#chipProgressValue"),
          openSettingsBtn: $("#openSettingsBtn"),
          settingsLabel: $("#settingsLabel"),

          settingsModal: $("#settingsModal"),
          settingsTitle: $("#settingsTitle"),
          closeSettingsBtn: $("#closeSettingsBtn"),
          closeLabel: $("#closeLabel"),
          uiLangLabel: $("#uiLangLabel"),
          uiLangSelect: $("#uiLangSelect"),
          sourceLangLabel: $("#sourceLangLabel"),
          sourceLangSelect: $("#sourceLangSelect"),
          sourceLangHint: $("#sourceLangHint"),
          viewLearnedLabel: $("#viewLearnedLabel"),
          learnedBtn: $("#learnedBtn"),
          resetBtn: $("#resetBtn"),
          resetLabel: $("#resetLabel"),
          shortcutsHint: $("#shortcutsHint"),

          learnedModal: $("#learnedModal"),
          learnedTitle: $("#learnedTitle"),
          closeLearnedBtn: $("#closeLearnedBtn"),
          closeLearnedLabel: $("#closeLearnedLabel"),
          learnedCountBadge: $("#learnedCountBadge"),
          learnedHint: $("#learnedHint"),
          learnedGrid: $("#learnedGrid"),

          welcome: $("#welcome"),
          welcomeTitle: $("#welcomeTitle"),
          welcomeCopy: $("#welcomeCopy"),
          welcomeSourceLabel: $("#welcomeSourceLabel"),
          welcomeSourceSelect: $("#welcomeSourceSelect"),
          welcomeLearnLabel: $("#welcomeLearnLabel"),
          learnLangCards: $("#learnLangCards"),
          welcomeHintText: $("#welcomeHintText"),

          deck: $("#deck"),
          progressTitle: $("#progressTitle"),
          progressMeta: $("#progressMeta"),
          barFill: $("#barFill"),

          card: $("#card"),
          scene: $("#scene"),
          frontLangLabel: $("#frontLangLabel"),
          backLangLabel: $("#backLangLabel"),
          frontText: $("#frontText"),
          backText: $("#backText"),
          frontNote: $("#frontNote"),
          backNote: $("#backNote"),
          tapHint: $("#tapHint"),
          answerHint: $("#answerHint"),
          speakFront: $("#speakFront"),
          speakBack: $("#speakBack"),

          prevBtn: $("#prevBtn"),
          nextBtn: $("#nextBtn"),
          shuffleBtn: $("#shuffleBtn"),
          learnBtn: $("#learnBtn"),
          prevLabel: $("#prevLabel"),
          nextLabel: $("#nextLabel"),
          shuffleLabel: $("#shuffleLabel"),
          learnLabel: $("#learnLabel"),

          sideHeader: $("#sideHeader"),
          voiceBadge: $("#voiceBadge"),
          learnLangLabel: $("#learnLangLabel"),
          learnLangSelect: $("#learnLangSelect"),
          inlineSourceLabel: $("#inlineSourceLabel"),
          inlineSourceSelect: $("#inlineSourceSelect"),
          restartBtn: $("#restartBtn"),
          restartLabel: $("#restartLabel"),
          openLearnedBtn: $("#openLearnedBtn"),
          openLearnedLabel: $("#openLearnedLabel"),
          miniTipTitle: $("#miniTipTitle"),
          miniTipBody: $("#miniTipBody"),
          miniKeysTitle: $("#miniKeysTitle"),
          miniKeysBody: $("#miniKeysBody"),
          miniCount: $("#miniCount"),

          toast: $("#toast"),
        };

        const prefersReducedMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

        function detectUILang() {
          const list = Array.isArray(navigator.languages) && navigator.languages.length ? navigator.languages : [navigator.language];
          for (const lang of list) {
            const l = String(lang || "").toLowerCase();
            if (l.startsWith("es")) return "es";
            if (l.startsWith("fr")) return "fr";
            if (l.startsWith("ja")) return "ja";
            if (l.startsWith("en")) return "en";
          }
          return "en";
        }

        function clampToSupported(lang, fallback = "en") {
          if (!lang) return fallback;
          const p = String(lang).toLowerCase().slice(0, 2);
          return SUPPORTED.includes(p) ? p : fallback;
        }

        function defaultSourceFor(learnLang, uiLang) {
          if (uiLang && uiLang !== learnLang) return uiLang;
          const preferred = ["en", "es", "fr", "ja"];
          for (const l of preferred) if (l !== learnLang) return l;
          return "en";
        }

        function loadState() {
          const uiLang = detectUILang();
          const base = {
            uiLang,
            learnLang: null,
            sourceLang: uiLang,
            learned: { en: [], es: [], fr: [], ja: [] },
          };
          try {
            const raw = localStorage.getItem(APP_KEY);
            if (!raw) return base;
            const parsed = JSON.parse(raw);
            const next = {
              ...base,
              ...parsed,
              uiLang: clampToSupported(parsed?.uiLang, base.uiLang),
              learnLang: parsed?.learnLang ? clampToSupported(parsed.learnLang, null) : null,
              sourceLang: clampToSupported(parsed?.sourceLang, base.sourceLang),
              learned: { ...base.learned, ...(parsed?.learned || {}) },
            };
            for (const k of SUPPORTED) {
              next.learned[k] = Array.isArray(next.learned[k]) ? next.learned[k].filter(Boolean) : [];
            }
            if (next.learnLang && next.sourceLang === next.learnLang) next.sourceLang = defaultSourceFor(next.learnLang, next.uiLang);
            return next;
          } catch {
            return base;
          }
        }

        function saveState() {
          localStorage.setItem(APP_KEY, JSON.stringify(state));
        }

        let state = loadState();
        let remaining = [];
        let idx = 0;
        let toastTimer = null;
        let lastUndo = null;

        function t(key, vars) {
          const pack = STR[state.uiLang] || STR.en;
          const v = pack[key];
          if (typeof v === "function") return v(vars || {});
          return v ?? (STR.en[key] ?? String(key));
        }

        let displayNames = null;
        let displayNamesLang = null;
        function getDisplayNames() {
          if (displayNamesLang === state.uiLang) return displayNames;
          displayNamesLang = state.uiLang;
          try {
            displayNames = typeof Intl !== "undefined" && Intl.DisplayNames ? new Intl.DisplayNames([state.uiLang], { type: "language" }) : null;
          } catch {
            displayNames = null;
          }
          return displayNames;
        }

        function languageName(code) {
          const item = LANG[code];
          const dn = getDisplayNames();
          const localized = dn?.of?.(code);
          if (state.uiLang === code) return item?.native || localized || code.toUpperCase();
          return localized || item?.label || code.toUpperCase();
        }

        function phraseById(id) {
          return PHRASES.find((p) => p.id === id) || null;
        }

        function buildRemaining() {
          if (!state.learnLang) return [];
          const learnedSet = new Set(state.learned[state.learnLang] || []);
          return PHRASES.map((p) => p.id).filter((id) => !learnedSet.has(id));
        }

        function shuffleInPlace(arr) {
          for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
          }
          return arr;
        }

        function isDialogOpen() {
          return el.settingsModal.getAttribute("aria-hidden") === "false" || el.learnedModal.getAttribute("aria-hidden") === "false";
        }

        function openModal(node) {
          node.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";
          const focusable = node.querySelector("button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])");
          focusable?.focus?.();
        }

        function closeModal(node) {
          node.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";
        }

        function showToast(html, actionLabel, onAction, ms = 4600) {
          clearTimeout(toastTimer);
          el.toast.innerHTML = "";
          const wrap = document.createElement("div");
          wrap.className = "card";
          const msg = document.createElement("div");
          msg.className = "msg";
          msg.innerHTML = html;
          wrap.appendChild(msg);
          if (actionLabel && typeof onAction === "function") {
            const btn = document.createElement("button");
            btn.className = "btn";
            btn.type = "button";
            btn.textContent = actionLabel;
            btn.addEventListener("click", () => {
              try {
                onAction();
              } finally {
                el.toast.innerHTML = "";
              }
            });
            wrap.appendChild(btn);
          }
          el.toast.appendChild(wrap);
          toastTimer = setTimeout(() => (el.toast.innerHTML = ""), ms);
        }

        function speak(text, lang) {
          if (!("speechSynthesis" in window) || !window.speechSynthesis) return false;
          try {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang === "ja" ? "ja-JP" : lang === "es" ? "es-ES" : lang === "fr" ? "fr-FR" : "en-US";
            const voices = window.speechSynthesis.getVoices?.() || [];
            const preferred = voices.filter((v) => String(v.lang || "").toLowerCase().startsWith(u.lang.toLowerCase().slice(0, 2)));
            const best =
              preferred.find((v) => v.localService && !/novelty|whisper|kids/i.test(v.name || "")) ||
              preferred.find((v) => !/novelty|whisper|kids/i.test(v.name || "")) ||
              preferred[0];
            if (best) u.voice = best;
            window.speechSynthesis.speak(u);
            return true;
          } catch {
            return false;
          }
        }

        function setCardFlipped(next) {
          const shouldFlip = !!next;
          el.card.classList.toggle("flipped", shouldFlip);
          el.card.setAttribute("aria-pressed", String(shouldFlip));
        }

        function animateCardSwap() {
          if (prefersReducedMotion) return;
          el.scene.classList.remove("swapIn");
          el.scene.classList.add("swapOut");
          window.setTimeout(() => {
            el.scene.classList.remove("swapOut");
            el.scene.classList.add("swapIn");
            window.setTimeout(() => el.scene.classList.remove("swapIn"), 260);
          }, 230);
        }

        function animateShuffle() {
          if (prefersReducedMotion) return;
          el.card.classList.remove("shuffleWiggle");
          void el.card.offsetWidth;
          el.card.classList.add("shuffleWiggle");
          window.setTimeout(() => el.card.classList.remove("shuffleWiggle"), 560);
        }

        function setLearnLang(next) {
          const learnLang = clampToSupported(next, null);
          state.learnLang = learnLang;
          if (learnLang && state.sourceLang === learnLang) state.sourceLang = defaultSourceFor(learnLang, state.uiLang);
          saveState();
          remaining = buildRemaining();
          idx = 0;
          setCardFlipped(false);
          render();
        }

        function setSourceLang(next) {
          const sourceLang = clampToSupported(next, state.uiLang);
          state.sourceLang = sourceLang;
          if (state.learnLang && state.sourceLang === state.learnLang) state.sourceLang = defaultSourceFor(state.learnLang, state.uiLang);
          saveState();
          setCardFlipped(false);
          animateCardSwap();
          render();
        }

        function setUILang(next) {
          state.uiLang = clampToSupported(next, "en");
          document.documentElement.lang = state.uiLang;
          if (state.learnLang && state.sourceLang === state.learnLang) state.sourceLang = defaultSourceFor(state.learnLang, state.uiLang);
          saveState();
          render();
        }

        function markLearned() {
          if (!state.learnLang || remaining.length === 0) return;
          const removedIndex = idx;
          const id = remaining[idx];
          const learnedList = state.learned[state.learnLang] || (state.learned[state.learnLang] = []);
          if (!learnedList.includes(id)) learnedList.push(id);
          learnedList.sort((a, b) => PHRASES.findIndex((p) => p.id === a) - PHRASES.findIndex((p) => p.id === b));
          remaining.splice(idx, 1);
          if (idx >= remaining.length) idx = Math.max(0, remaining.length - 1);
          saveState();
          setCardFlipped(false);

          const p = phraseById(id);
          const from = p?.text?.[state.sourceLang] ?? "‚Äî";
          const to = p?.text?.[state.learnLang] ?? "‚Äî";
          lastUndo = { learnLang: state.learnLang, id, idx: removedIndex };
          showToast(
            t("toastLearned", { from: escapeHTML(from), to: escapeHTML(to) }),
            t("undo"),
            () => undoLearned(),
            5200,
          );

          animateCardSwap();
          render();
          maybeCelebrateDone();
        }

        function undoLearned() {
          if (!lastUndo) return;
          const { learnLang, id, idx: prevIdx } = lastUndo;
          if (!learnLang || !id) return;
          const list = state.learned[learnLang] || [];
          const i = list.indexOf(id);
          if (i >= 0) list.splice(i, 1);
          if (state.learnLang === learnLang) {
            remaining.splice(Math.min(prevIdx, remaining.length), 0, id);
            idx = Math.min(prevIdx, remaining.length - 1);
            setCardFlipped(false);
          }
          saveState();
          lastUndo = null;
          render();
        }

        function nextCard(dir) {
          if (remaining.length === 0) return;
          const before = idx;
          idx = (idx + dir + remaining.length) % remaining.length;
          if (idx !== before) {
            setCardFlipped(false);
            animateCardSwap();
            render();
          }
        }

        function shuffleDeck() {
          if (remaining.length <= 1) return;
          animateShuffle();
          window.setTimeout(
            () => {
              remaining = shuffleInPlace([...remaining]);
              idx = 0;
              setCardFlipped(false);
              saveState();
              showToast(t("toastShuffled"));
              render();
            },
            prefersReducedMotion ? 0 : 280,
          );
        }

        function resetProgress() {
          if (!state.learnLang) return;
          state.learned[state.learnLang] = [];
          remaining = buildRemaining();
          idx = 0;
          setCardFlipped(false);
          saveState();
          showToast(t("toastReset"));
          animateCardSwap();
          render();
        }

        function buildSelectOptions(select, selected, filterFn) {
          select.innerHTML = "";
          for (const code of SUPPORTED) {
            if (filterFn && !filterFn(code)) continue;
            const opt = document.createElement("option");
            opt.value = code;
            opt.textContent = `${LANG[code].flag} ${languageName(code)} (${LANG[code].native})`;
            if (code === selected) opt.selected = true;
            select.appendChild(opt);
          }
        }

        function buildLearnLangCards(container, selected) {
          container.innerHTML = "";
          for (const code of SUPPORTED) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "lang-card";
            btn.setAttribute("aria-pressed", String(code === selected));
            btn.innerHTML = `
              <div class="lang-row">
                <div class="lang-meta">
                  <div class="flag" aria-hidden="true">${LANG[code].flag}</div>
                  <div class="lang-name">
                    <div class="primary">${languageName(code)}</div>
                    <div class="secondary">${LANG[code].native}</div>
                  </div>
                </div>
                <div class="badge">${code.toUpperCase()}</div>
              </div>
            `;
            btn.addEventListener("click", () => setLearnLang(code));
            container.appendChild(btn);
          }
        }

        function maybeCelebrateDone() {
          if (!state.learnLang) return;
          const learnedCount = (state.learned[state.learnLang] || []).length;
          if (learnedCount !== PHRASES.length) return;
          if (prefersReducedMotion) return;

          const canvas = document.createElement("canvas");
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          canvas.style.position = "fixed";
          canvas.style.inset = "0";
          canvas.style.zIndex = "20";
          canvas.style.pointerEvents = "none";
          document.body.appendChild(canvas);
          const ctx = canvas.getContext("2d");
          if (!ctx) return;

          const colors = ["#7ee7ff", "#a78bfa", "#34d399", "#fbbf24", "#fb7185"];
          const pieces = Array.from({ length: 140 }, () => ({
            x: Math.random() * canvas.width,
            y: -20 - Math.random() * canvas.height * 0.2,
            r: 4 + Math.random() * 5,
            vx: -2.8 + Math.random() * 5.6,
            vy: 2.2 + Math.random() * 4.8,
            rot: Math.random() * Math.PI,
            vr: -0.16 + Math.random() * 0.32,
            color: colors[Math.floor(Math.random() * colors.length)],
          }));

          const t0 = performance.now();
          const duration = 1500;
          function draw(now) {
            const dt = Math.min(32, now - (draw.last || now));
            draw.last = now;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.globalAlpha = 0.95;
            for (const p of pieces) {
              p.x += p.vx * (dt / 16);
              p.y += p.vy * (dt / 16);
              p.rot += p.vr * (dt / 16);
              p.vy += 0.06 * (dt / 16);
              ctx.save();
              ctx.translate(p.x, p.y);
              ctx.rotate(p.rot);
              ctx.fillStyle = p.color;
              ctx.fillRect(-p.r, -p.r / 2, p.r * 2, p.r);
              ctx.restore();
            }
            if (now - t0 < duration) requestAnimationFrame(draw);
            else canvas.remove();
          }
          requestAnimationFrame(draw);
        }

        function renderLearnedModal() {
          el.learnedGrid.innerHTML = "";
          if (!state.learnLang) return;
          const learnedList = state.learned[state.learnLang] || [];
          el.learnedCountBadge.textContent = t("learnedCount", { n: learnedList.length });
          el.learnedHint.textContent = t("learnedHint");

          if (learnedList.length === 0) {
            const empty = document.createElement("div");
            empty.className = "mini";
            empty.innerHTML = `<div class="line1"><strong>${t("learned")}</strong></div><div class="line2">${t("noLearnedYet")}</div>`;
            el.learnedGrid.appendChild(empty);
            return;
          }

          for (const id of learnedList) {
            const p = phraseById(id);
            const from = p?.text?.[state.sourceLang] ?? "‚Äî";
            const to = p?.text?.[state.learnLang] ?? "‚Äî";
            const note = p?.note?.[state.learnLang] || "";
            const item = document.createElement("div");
            item.className = "learned-item";
            item.innerHTML = `
              <div class="top">
                <strong>${escapeHTML(from)}</strong>
                <button class="btn" type="button">${t("unlearn")}</button>
              </div>
              <div class="bottom">${escapeHTML(to)}${note ? ` <span class="muted">(${escapeHTML(note)})</span>` : ""}</div>
            `;
            item.querySelector("button").addEventListener("click", () => {
              const list = state.learned[state.learnLang] || [];
              const i = list.indexOf(id);
              if (i >= 0) list.splice(i, 1);
              remaining = buildRemaining();
              idx = 0;
              saveState();
              render();
              renderLearnedModal();
            });
            el.learnedGrid.appendChild(item);
          }
        }

        function escapeHTML(s) {
          return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function render() {
          document.documentElement.lang = state.uiLang;
          document.title = t("appTitle");

          el.appTitle.textContent = t("appTitle");
          el.appSubtitle.textContent = t("appSubtitle");
          el.mainHeader.textContent = state.learnLang ? t("today") : t("start");
          el.sideHeader.textContent = t("setup");
          el.settingsLabel.textContent = t("settings");
          el.settingsTitle.textContent = t("settingsTitle");
          el.closeLabel.textContent = t("close");
          el.closeLearnedLabel.textContent = t("close");

          el.uiLangLabel.textContent = t("uiLang");
          el.sourceLangLabel.textContent = t("sourceLang");
          el.sourceLangHint.textContent = t("sourceHint");
          el.viewLearnedLabel.textContent = t("viewLearned");
          el.resetLabel.textContent = t("reset");
          el.shortcutsHint.textContent = t("shortcuts");

          el.welcomeTitle.textContent = t("welcomeTitle");
          el.welcomeCopy.textContent = t("welcomeCopy");
          el.welcomeSourceLabel.textContent = t("iSpeak");
          el.welcomeLearnLabel.textContent = t("iWantToLearn");
          el.welcomeHintText.textContent = t("tip");

          el.progressTitle.textContent = t("today");
          el.progressMeta.textContent = t("travelPhrases");
          el.frontLangLabel.textContent = t("front");
          el.backLangLabel.textContent = t("back");
          el.tapHint.textContent = t("tapFlip");
          el.answerHint.textContent = t("markHint");
          el.prevLabel.textContent = t("prev");
          el.nextLabel.textContent = t("next");
          el.shuffleLabel.textContent = t("shuffle");
          el.learnLabel.textContent = t("markLearned");

          el.learnedTitle.textContent = t("learned");
          el.openLearnedLabel.textContent = t("learned");

          el.learnLangLabel.textContent = t("iWantToLearn");
          el.inlineSourceLabel.textContent = t("sourceLang");
          el.restartLabel.textContent = t("startOver");
          el.miniTipTitle.textContent = t("practiceTipTitle");
          el.miniTipBody.textContent = t("practiceTipBody");
          el.miniKeysTitle.textContent = t("keyboardTitle");
          el.miniKeysBody.textContent = t("keyboardBody");
          el.chipProgressLabel.textContent = t("progress");

          buildSelectOptions(el.uiLangSelect, state.uiLang);
          buildSelectOptions(el.learnLangSelect, state.learnLang || "en");
          buildSelectOptions(el.welcomeSourceSelect, state.sourceLang);
          buildSelectOptions(el.sourceLangSelect, state.sourceLang);
          buildSelectOptions(el.inlineSourceSelect, state.sourceLang);
          buildLearnLangCards(el.learnLangCards, state.learnLang);

          if (!state.learnLang) {
            remaining = [];
            idx = 0;
          }
          if (idx >= remaining.length) idx = Math.max(0, remaining.length - 1);

          const total = PHRASES.length;
          const learnedCount = state.learnLang ? (state.learned[state.learnLang] || []).length : 0;
          const remCount = state.learnLang ? remaining.length : total;
          const pct = total ? Math.round((learnedCount / total) * 100) : 0;

          el.chipFrom.textContent = (state.learnLang ? state.sourceLang : state.uiLang).toUpperCase();
          el.chipTo.textContent = (state.learnLang || "‚Äî").toUpperCase();
          el.langChip.style.opacity = state.learnLang ? "1" : "0.65";
          el.chipProgressValue.textContent = `${learnedCount}/${total}`;

          el.statusBadge.textContent = state.learnLang ? t("status", { remaining: remCount, total }) : t("noLearnLang");
          el.barFill.style.width = `${pct}%`;
          el.miniCount.textContent = String(remCount);

          const voicesSupported = "speechSynthesis" in window && !!window.SpeechSynthesisUtterance;
          el.voiceBadge.textContent = `${t("voiceReady")}: ${voicesSupported ? t("voiceOk") : t("voiceMaybe")}`;

          if (!state.learnLang) {
            el.welcome.classList.remove("hidden");
            el.deck.classList.add("hidden");
            el.prevBtn.disabled = true;
            el.nextBtn.disabled = true;
            el.shuffleBtn.disabled = true;
            el.learnBtn.disabled = true;
            el.speakFront.disabled = !voicesSupported;
            el.speakBack.disabled = !voicesSupported;
            el.frontText.textContent = "‚Äî";
            el.backText.textContent = "‚Äî";
            el.frontNote.textContent = "";
            el.backNote.textContent = "";
            return;
          }

          el.welcome.classList.add("hidden");
          el.deck.classList.remove("hidden");
          el.learnLangSelect.value = state.learnLang;
          el.inlineSourceSelect.value = state.sourceLang;
          el.sourceLangSelect.value = state.sourceLang;
          el.welcomeSourceSelect.value = state.sourceLang;

          if (remaining.length === 0) {
            el.frontText.textContent = t("doneTitle");
            el.backText.textContent = t("doneBody");
            el.frontNote.textContent = "";
            el.backNote.textContent = "";
            el.prevBtn.disabled = true;
            el.nextBtn.disabled = true;
            el.shuffleBtn.disabled = true;
            el.learnBtn.disabled = true;
            el.speakFront.disabled = true;
            el.speakBack.disabled = true;
            setCardFlipped(false);
            return;
          }

          const current = phraseById(remaining[idx]);
          const from = current?.text?.[state.sourceLang] ?? current?.text?.en ?? "‚Äî";
          const to = current?.text?.[state.learnLang] ?? current?.text?.en ?? "‚Äî";
          el.frontText.textContent = from;
          el.backText.textContent = to;
          el.frontNote.textContent = current?.note?.[state.sourceLang] || "";
          el.backNote.textContent = current?.note?.[state.learnLang] || "";

          el.prevBtn.disabled = remaining.length <= 1;
          el.nextBtn.disabled = remaining.length <= 1;
          el.shuffleBtn.disabled = remaining.length <= 1;
          el.learnBtn.disabled = false;
          el.speakFront.disabled = !voicesSupported;
          el.speakBack.disabled = !voicesSupported;
        }

        // Event wiring
        el.openSettingsBtn.addEventListener("click", () => openModal(el.settingsModal));
        el.closeSettingsBtn.addEventListener("click", () => closeModal(el.settingsModal));
        el.closeLearnedBtn.addEventListener("click", () => closeModal(el.learnedModal));
        el.settingsModal.addEventListener("click", (e) => {
          if (e.target === el.settingsModal) closeModal(el.settingsModal);
        });
        el.learnedModal.addEventListener("click", (e) => {
          if (e.target === el.learnedModal) closeModal(el.learnedModal);
        });
        el.learnedBtn.addEventListener("click", () => {
          closeModal(el.settingsModal);
          renderLearnedModal();
          openModal(el.learnedModal);
        });
        el.openLearnedBtn.addEventListener("click", () => {
          renderLearnedModal();
          openModal(el.learnedModal);
        });

        el.resetBtn.addEventListener("click", () => resetProgress());
        el.restartBtn.addEventListener("click", () => {
          state.learnLang = null;
          saveState();
          remaining = [];
          idx = 0;
          setCardFlipped(false);
          render();
        });

        el.uiLangSelect.addEventListener("change", (e) => setUILang(e.target.value));
        el.sourceLangSelect.addEventListener("change", (e) => setSourceLang(e.target.value));
        el.inlineSourceSelect.addEventListener("change", (e) => setSourceLang(e.target.value));
        el.welcomeSourceSelect.addEventListener("change", (e) => setSourceLang(e.target.value));
        el.learnLangSelect.addEventListener("change", (e) => setLearnLang(e.target.value));

        el.prevBtn.addEventListener("click", () => nextCard(-1));
        el.nextBtn.addEventListener("click", () => nextCard(1));
        el.shuffleBtn.addEventListener("click", () => shuffleDeck());
        el.learnBtn.addEventListener("click", () => markLearned());

        el.card.addEventListener("click", (e) => {
          const target = e.target;
          if (target && (target.closest?.("button") || target.closest?.(".speak"))) return;
          if (!state.learnLang || remaining.length === 0) return;
          setCardFlipped(!el.card.classList.contains("flipped"));
        });

        el.card.addEventListener("keydown", (e) => {
          if (e.key === " " || e.key === "Enter") {
            e.preventDefault();
            el.card.click();
          }
        });

        el.speakFront.addEventListener("click", (e) => {
          e.preventDefault();
          if (!state.learnLang || remaining.length === 0) return;
          const current = phraseById(remaining[idx]);
          const text = current?.text?.[state.sourceLang] ?? "";
          if (!text) return;
          speak(text, state.sourceLang);
        });

        el.speakBack.addEventListener("click", (e) => {
          e.preventDefault();
          if (!state.learnLang || remaining.length === 0) return;
          const current = phraseById(remaining[idx]);
          const text = current?.text?.[state.learnLang] ?? "";
          if (!text) return;
          speak(text, state.learnLang);
        });

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            if (el.learnedModal.getAttribute("aria-hidden") === "false") closeModal(el.learnedModal);
            else if (el.settingsModal.getAttribute("aria-hidden") === "false") closeModal(el.settingsModal);
            return;
          }
          if (isDialogOpen()) return;
          if (!state.learnLang) return;
          if (e.key === "ArrowLeft") nextCard(-1);
          else if (e.key === "ArrowRight") nextCard(1);
          else if (e.key.toLowerCase() === "l") markLearned();
          else if (e.key.toLowerCase() === "s") shuffleDeck();
          else if (e.key === " ") {
            e.preventDefault();
            if (remaining.length === 0) return;
            setCardFlipped(!el.card.classList.contains("flipped"));
          }
        });

        // Speech voices sometimes load async; re-render badge once loaded.
        if ("speechSynthesis" in window && window.speechSynthesis?.addEventListener) {
          window.speechSynthesis.addEventListener("voiceschanged", () => render());
        }

        // Initialize defaults
        if (!state.learnLang) {
          state.sourceLang = clampToSupported(state.sourceLang, state.uiLang);
          saveState();
        } else {
          remaining = buildRemaining();
          if (state.sourceLang === state.learnLang) state.sourceLang = defaultSourceFor(state.learnLang, state.uiLang);
          saveState();
        }

        render();
      })();
    </script>
  </body>
</html>
