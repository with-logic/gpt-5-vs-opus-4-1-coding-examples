<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark light" />
    <title>Camping Gear Checklist</title>
    <style>
      :root {
        --bg0: #07130d;
        --bg1: #0b1e14;
        --card: rgba(12, 29, 21, 0.72);
        --card2: rgba(10, 24, 17, 0.62);
        --stroke: rgba(201, 231, 209, 0.14);
        --stroke2: rgba(201, 231, 209, 0.22);
        --text: #eaf6ee;
        --muted: rgba(234, 246, 238, 0.78);
        --muted2: rgba(234, 246, 238, 0.62);
        --danger: #ff6b6b;
        --warn: #ffd166;
        --ok: #3ee28c;
        --accent: #57e6ff;
        --accent2: #a7ff83;
        --shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
        --shadow2: 0 10px 24px rgba(0, 0, 0, 0.35);
        --radius: 18px;
        --radius2: 14px;
        --ring: 0 0 0 3px rgba(87, 230, 255, 0.22), 0 0 0 1px rgba(87, 230, 255, 0.35);
        --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: var(--font);
        color: var(--text);
        background: radial-gradient(1200px 650px at 20% 0%, rgba(87, 230, 255, 0.14), transparent 55%),
          radial-gradient(1000px 700px at 80% 10%, rgba(167, 255, 131, 0.12), transparent 60%),
          radial-gradient(900px 600px at 50% 120%, rgba(255, 209, 102, 0.08), transparent 60%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        overflow-x: hidden;
      }

      /* Subtle topo + noise overlay (data URI SVG + gradient ‚Äúgrain‚Äù). */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        opacity: 0.14;
        mix-blend-mode: screen;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="800" height="800" viewBox="0 0 800 800"><g fill="none" stroke="rgba(255,255,255,0.18)" stroke-width="1"><path d="M0 120c140-90 220 90 360 0s220 90 440 0"/><path d="M0 190c160-70 220 110 360 20s220 110 440 20"/><path d="M0 260c170-60 230 120 360 40s230 120 440 40"/><path d="M0 330c190-50 240 130 360 60s240 130 440 60"/><path d="M0 400c200-40 250 140 360 80s250 140 440 80"/><path d="M0 470c220-30 260 150 360 100s260 150 440 100"/><path d="M0 540c230-20 270 160 360 120s270 160 440 120"/><path d="M0 610c250-10 280 170 360 140s280 170 440 140"/><path d="M0 680c270 0 290 180 360 160s290 180 440 160"/></g></svg>');
        background-size: 820px 820px;
        background-position: 40% 20%;
        filter: blur(0.1px);
      }
      body::after {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.035), rgba(255, 255, 255, 0.035) 1px, transparent 1px, transparent 3px);
        opacity: 0.06;
        mix-blend-mode: overlay;
      }

      a {
        color: inherit;
      }

      .skip {
        position: absolute;
        left: -9999px;
        top: 12px;
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid var(--stroke2);
        padding: 10px 12px;
        border-radius: 12px;
        z-index: 10;
      }
      .skip:focus {
        left: 12px;
        outline: none;
        box-shadow: var(--ring);
      }

      .wrap {
        width: min(1180px, calc(100% - 28px));
        margin: 26px auto 60px;
      }

      header {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
        align-items: start;
        margin-bottom: 18px;
      }
      .brand {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding: 18px 18px 16px;
        border-radius: var(--radius);
        background: linear-gradient(180deg, rgba(20, 50, 36, 0.72), rgba(8, 20, 14, 0.66));
        border: 1px solid rgba(201, 231, 209, 0.14);
        box-shadow: var(--shadow2);
        position: relative;
        overflow: hidden;
      }
      .brand::before {
        content: "";
        position: absolute;
        inset: -2px;
        background: radial-gradient(700px 220px at 20% 0%, rgba(87, 230, 255, 0.18), transparent 65%),
          radial-gradient(600px 220px at 75% 10%, rgba(167, 255, 131, 0.14), transparent 70%);
        opacity: 0.65;
        pointer-events: none;
      }
      .brand > * {
        position: relative;
        z-index: 1;
      }
      .title {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }
      .logo {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        background: linear-gradient(180deg, rgba(87, 230, 255, 0.18), rgba(167, 255, 131, 0.12));
        border: 1px solid rgba(201, 231, 209, 0.22);
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.25);
        flex: 0 0 auto;
      }
      .title h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
        line-height: 1.15;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .subtitle {
        margin: 2px 0 0;
        font-size: 12.5px;
        color: var(--muted2);
        line-height: 1.3;
      }
      .right {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: rgba(6, 15, 11, 0.46);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      .pill strong {
        font-size: 12.5px;
        letter-spacing: 0.15px;
      }
      .pill .tiny {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
      }

      .grid {
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 14px;
      }
      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        border-radius: var(--radius);
        background: var(--card);
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow);
        overflow: hidden;
        position: relative;
      }
      .card::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(650px 260px at 30% 0%, rgba(87, 230, 255, 0.08), transparent 60%),
          radial-gradient(600px 240px at 78% 10%, rgba(167, 255, 131, 0.07), transparent 65%);
        opacity: 1;
      }
      .card > * {
        position: relative;
        z-index: 1;
      }

      .card-h {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 14px 14px 12px;
        border-bottom: 1px solid rgba(201, 231, 209, 0.12);
        background: linear-gradient(180deg, rgba(9, 22, 16, 0.54), rgba(9, 22, 16, 0));
      }
      .card-h h2 {
        margin: 0;
        font-size: 13px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        color: rgba(234, 246, 238, 0.86);
      }
      .card-b {
        padding: 14px;
      }

      .row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .row.stretch {
        justify-content: space-between;
      }
      .row > * {
        flex: 0 0 auto;
      }

      .btn {
        appearance: none;
        border: 1px solid rgba(201, 231, 209, 0.16);
        background: rgba(5, 14, 10, 0.55);
        color: var(--text);
        padding: 9px 10px;
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.12s ease, border-color 0.12s ease, background 0.12s ease;
        font-weight: 650;
        font-size: 13px;
        letter-spacing: 0.2px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn:hover {
        transform: translateY(-1px);
        border-color: rgba(87, 230, 255, 0.35);
        background: rgba(8, 20, 14, 0.66);
      }
      .btn:active {
        transform: translateY(0);
      }
      .btn:focus-visible {
        outline: none;
        box-shadow: var(--ring);
      }
      .btn.primary {
        border-color: rgba(87, 230, 255, 0.38);
        background: linear-gradient(180deg, rgba(87, 230, 255, 0.14), rgba(6, 15, 11, 0.55));
      }
      .btn.danger {
        border-color: rgba(255, 107, 107, 0.42);
      }
      .btn.ghost {
        background: transparent;
        border-color: rgba(201, 231, 209, 0.12);
      }
      .btn.small {
        padding: 8px 9px;
        border-radius: 11px;
        font-size: 12.5px;
      }

      .seg {
        display: inline-flex;
        align-items: center;
        gap: 0;
        border: 1px solid rgba(201, 231, 209, 0.16);
        border-radius: 999px;
        overflow: hidden;
        background: rgba(5, 14, 10, 0.5);
      }
      .seg button {
        border: 0;
        background: transparent;
        color: rgba(234, 246, 238, 0.74);
        padding: 8px 10px;
        cursor: pointer;
        font-size: 12.5px;
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .seg button[aria-pressed="true"] {
        background: rgba(87, 230, 255, 0.16);
        color: var(--text);
      }
      .seg button:focus-visible {
        outline: none;
        box-shadow: inset 0 0 0 2px rgba(87, 230, 255, 0.24);
      }

      input,
      select,
      textarea {
        border: 1px solid rgba(201, 231, 209, 0.16);
        background: rgba(5, 14, 10, 0.45);
        color: var(--text);
        padding: 10px 10px;
        border-radius: 12px;
        font: inherit;
        font-size: 13px;
        letter-spacing: 0.1px;
      }
      input::placeholder,
      textarea::placeholder {
        color: rgba(234, 246, 238, 0.45);
      }
      input:focus-visible,
      select:focus-visible,
      textarea:focus-visible {
        outline: none;
        box-shadow: var(--ring);
        border-color: rgba(87, 230, 255, 0.32);
      }
      textarea {
        min-height: 92px;
        resize: vertical;
        width: 100%;
      }

      .select {
        display: grid;
        gap: 6px;
      }
      .label {
        font-size: 12px;
        letter-spacing: 0.35px;
        text-transform: uppercase;
        color: rgba(234, 246, 238, 0.7);
      }

      .toolbar {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }
      @media (max-width: 680px) {
        .toolbar {
          grid-template-columns: 1fr;
        }
      }
      .filters {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
        border: 1px solid rgba(201, 231, 209, 0.14);
        background: rgba(5, 14, 10, 0.5);
        color: rgba(234, 246, 238, 0.86);
      }
      .badge.ok {
        border-color: rgba(62, 226, 140, 0.3);
        background: rgba(62, 226, 140, 0.1);
      }
      .badge.warn {
        border-color: rgba(255, 209, 102, 0.35);
        background: rgba(255, 209, 102, 0.12);
      }
      .badge.danger {
        border-color: rgba(255, 107, 107, 0.42);
        background: rgba(255, 107, 107, 0.14);
      }

      .hint {
        font-size: 12.5px;
        color: var(--muted2);
        line-height: 1.35;
      }

      .stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      @media (max-width: 520px) {
        .stats {
          grid-template-columns: 1fr;
        }
      }
      .kpi {
        border: 1px solid rgba(201, 231, 209, 0.12);
        background: rgba(5, 14, 10, 0.42);
        border-radius: 16px;
        padding: 12px;
      }
      .kpi .k {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.45px;
        color: rgba(234, 246, 238, 0.7);
        margin-bottom: 6px;
      }
      .kpi .v {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }
      .kpi .num {
        font-size: 18px;
        font-weight: 850;
        letter-spacing: 0.2px;
      }
      .kpi .sub {
        font-size: 12px;
        color: rgba(234, 246, 238, 0.7);
        font-family: var(--mono);
      }

      .bar {
        height: 10px;
        border-radius: 999px;
        background: rgba(234, 246, 238, 0.08);
        border: 1px solid rgba(201, 231, 209, 0.12);
        overflow: hidden;
        margin-top: 10px;
      }
      .bar > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, rgba(87, 230, 255, 0.9), rgba(167, 255, 131, 0.9));
        border-radius: 999px;
        box-shadow: 0 0 20px rgba(87, 230, 255, 0.22);
        transition: width 0.24s ease;
      }

      .cats {
        display: grid;
        gap: 10px;
      }

      details.cat {
        border: 1px solid rgba(201, 231, 209, 0.12);
        border-radius: 16px;
        background: rgba(5, 14, 10, 0.35);
        overflow: hidden;
      }
      details.cat[open] {
        border-color: rgba(201, 231, 209, 0.18);
      }
      summary {
        list-style: none;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 12px 12px;
      }
      summary::-webkit-details-marker {
        display: none;
      }
      summary:focus-visible {
        outline: none;
        box-shadow: var(--ring);
        border-radius: 14px;
      }
      .cat-title {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }
      .cat-title .ic {
        width: 28px;
        height: 28px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        background: rgba(87, 230, 255, 0.12);
        border: 1px solid rgba(201, 231, 209, 0.14);
      }
      .cat-title h3 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .cat-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 0 0 auto;
        color: rgba(234, 246, 238, 0.7);
        font-family: var(--mono);
        font-size: 12px;
      }
      .items {
        padding: 0 10px 10px;
        display: grid;
        gap: 8px;
      }

      .item {
        display: grid;
        grid-template-columns: 24px 1.6fr 0.7fr 0.7fr auto;
        gap: 10px;
        align-items: center;
        padding: 10px 10px;
        border-radius: 14px;
        border: 1px solid rgba(201, 231, 209, 0.12);
        background: rgba(8, 20, 14, 0.34);
      }
      @media (max-width: 720px) {
        .item {
          grid-template-columns: 24px 1fr auto;
          grid-auto-rows: auto;
          gap: 10px;
        }
        .item .w,
        .item .qty {
          grid-column: 2 / 3;
          justify-self: start;
        }
        .item .w {
          margin-top: -6px;
        }
      }
      .item.packed {
        border-color: rgba(62, 226, 140, 0.26);
        background: rgba(62, 226, 140, 0.07);
      }
      .item .name {
        min-width: 0;
      }
      .item .name .top {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
      }
      .item .name strong {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 13.5px;
        letter-spacing: 0.2px;
      }
      .item .name .meta {
        margin-top: 2px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        color: rgba(234, 246, 238, 0.68);
        font-size: 12px;
      }
      .pill2 {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 7px;
        border-radius: 999px;
        border: 1px solid rgba(201, 231, 209, 0.12);
        background: rgba(5, 14, 10, 0.45);
        font-family: var(--mono);
        font-size: 11.5px;
      }
      .pill2.ess {
        border-color: rgba(255, 209, 102, 0.28);
        background: rgba(255, 209, 102, 0.1);
      }
      .pill2.con {
        border-color: rgba(87, 230, 255, 0.25);
        background: rgba(87, 230, 255, 0.08);
      }

      .mini {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        justify-content: flex-end;
        color: rgba(234, 246, 238, 0.7);
        font-family: var(--mono);
        font-size: 12px;
      }
      .qtyctrl {
        display: inline-flex;
        align-items: center;
        border: 1px solid rgba(201, 231, 209, 0.14);
        border-radius: 999px;
        overflow: hidden;
        background: rgba(5, 14, 10, 0.42);
      }
      .qtyctrl button {
        border: 0;
        background: transparent;
        color: rgba(234, 246, 238, 0.86);
        padding: 7px 10px;
        cursor: pointer;
        font-weight: 900;
      }
      .qtyctrl button:hover {
        background: rgba(234, 246, 238, 0.06);
      }
      .qtyctrl span {
        min-width: 34px;
        text-align: center;
        font-family: var(--mono);
        font-size: 12px;
        color: rgba(234, 246, 238, 0.78);
        padding: 0 8px;
      }

      .iconbtn {
        appearance: none;
        border: 1px solid rgba(201, 231, 209, 0.14);
        background: rgba(5, 14, 10, 0.45);
        color: var(--text);
        padding: 8px;
        border-radius: 12px;
        cursor: pointer;
        display: inline-grid;
        place-items: center;
      }
      .iconbtn:hover {
        border-color: rgba(87, 230, 255, 0.32);
        background: rgba(8, 20, 14, 0.62);
      }
      .iconbtn:focus-visible {
        outline: none;
        box-shadow: var(--ring);
      }

      .foot {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .foot .left {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      dialog {
        width: min(560px, calc(100% - 22px));
        border: 1px solid rgba(201, 231, 209, 0.2);
        border-radius: 18px;
        background: rgba(10, 24, 17, 0.95);
        color: var(--text);
        box-shadow: 0 30px 100px rgba(0, 0, 0, 0.7);
        padding: 0;
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.62);
        backdrop-filter: blur(4px);
      }
      .dlg-h {
        padding: 14px 14px 12px;
        border-bottom: 1px solid rgba(201, 231, 209, 0.14);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .dlg-h h3 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.4px;
        text-transform: uppercase;
        color: rgba(234, 246, 238, 0.9);
      }
      .dlg-b {
        padding: 14px;
        display: grid;
        gap: 12px;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      @media (max-width: 520px) {
        .grid2 {
          grid-template-columns: 1fr;
        }
      }
      .actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 10px;
        padding: 0 14px 14px;
      }

      .toast {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        background: rgba(6, 15, 11, 0.82);
        border: 1px solid rgba(201, 231, 209, 0.18);
        border-radius: 999px;
        padding: 10px 12px;
        box-shadow: var(--shadow2);
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.18s ease, transform 0.18s ease;
        max-width: min(720px, calc(100% - 20px));
      }
      .toast.show {
        opacity: 1;
        pointer-events: auto;
        transform: translateX(-50%) translateY(-2px);
      }
      .toast .msg {
        font-size: 13px;
        color: rgba(234, 246, 238, 0.9);
      }
      .toast .kbd {
        font-family: var(--mono);
        font-size: 12px;
        color: rgba(234, 246, 238, 0.72);
        border: 1px solid rgba(201, 231, 209, 0.14);
        padding: 4px 7px;
        border-radius: 10px;
        background: rgba(234, 246, 238, 0.05);
      }

      .kbd {
        font-family: var(--mono);
        font-size: 12px;
        color: rgba(234, 246, 238, 0.78);
        border: 1px solid rgba(201, 231, 209, 0.14);
        padding: 3px 6px;
        border-radius: 10px;
        background: rgba(234, 246, 238, 0.05);
      }

      .sr {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
  </head>
  <body>
    <a class="skip" href="#main">Skip to checklist</a>
    <div class="wrap">
      <header>
        <div class="brand">
          <div class="title">
            <div class="logo" aria-hidden="true">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path
                  d="M4 19l8-14 8 14"
                  stroke="rgba(234,246,238,0.92)"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M8.2 19l3.8-6.7L15.8 19"
                  stroke="rgba(87,230,255,0.9)"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </div>
            <div style="min-width: 0">
              <h1>Camping Gear Checklist</h1>
              <p class="subtitle">Track packs, weigh essentials, and save trip-ready lists.</p>
            </div>
          </div>
          <div class="right">
            <span class="pill" title="Auto-saved locally to your browser">
              <strong>Saved</strong>
              <span class="tiny" id="saveState">‚Äî</span>
            </span>
            <div class="seg" role="group" aria-label="Weight units">
              <button type="button" data-unit="g" aria-pressed="false">g</button>
              <button type="button" data-unit="oz" aria-pressed="true">oz</button>
              <button type="button" data-unit="lb" aria-pressed="false">lb</button>
            </div>
          </div>
        </div>
      </header>

      <div class="grid">
        <main id="main" class="card" aria-label="Checklist">
          <div class="card-h">
            <h2>Checklist</h2>
            <div class="row">
              <div class="select">
                <div class="label">List</div>
                <select id="listSelect" aria-label="Select saved list"></select>
              </div>
              <button class="btn small" id="btnNew" type="button" title="Create a new list">
                <span aria-hidden="true">Ôºã</span><span>New</span>
              </button>
              <button class="btn small ghost" id="btnDuplicate" type="button" title="Duplicate current list">
                <span aria-hidden="true">‚éò</span><span>Duplicate</span>
              </button>
              <button class="btn small ghost" id="btnRename" type="button" title="Rename current list">
                <span aria-hidden="true">‚úé</span><span>Rename</span>
              </button>
              <button class="btn small danger ghost" id="btnDeleteList" type="button" title="Delete current list">
                <span aria-hidden="true">üóë</span><span>Delete</span>
              </button>
            </div>
          </div>

          <div class="card-b">
            <div class="toolbar">
              <label class="sr" for="search">Search items</label>
              <input id="search" type="search" placeholder="Search items (e.g., headlamp, stove)..." autocomplete="off" />
              <div class="filters" aria-label="Filters">
                <button class="btn small" type="button" data-filter="all" id="fltAll">All</button>
                <button class="btn small ghost" type="button" data-filter="unpacked" id="fltUnpacked">Unpacked</button>
                <button class="btn small ghost" type="button" data-filter="packed" id="fltPacked">Packed</button>
                <button class="btn small ghost" type="button" data-filter="essential" id="fltEssential">Essentials</button>
              </div>
            </div>

            <div class="hint" style="margin-top: 10px">
              Tip: toggle packed with the checkbox. Press <span class="kbd">/</span> to search, <span class="kbd">N</span> to add
              an item.
            </div>

            <div style="height: 12px"></div>
            <div class="cats" id="cats"></div>

            <div class="foot">
              <div class="left">
                <button class="btn primary" id="btnAdd" type="button">
                  <span aria-hidden="true">Ôºã</span><span>Add item</span>
                </button>
                <button class="btn" id="btnQuickPack" type="button" title="Pack all essentials that aren‚Äôt packed yet">
                  <span aria-hidden="true">‚úì</span><span>Pack essentials</span>
                </button>
                <button class="btn ghost" id="btnResetPacked" type="button" title="Mark everything as unpacked">
                  <span aria-hidden="true">‚Ü∫</span><span>Reset packed</span>
                </button>
              </div>
              <div class="row">
                <span class="badge" id="progressBadge">0 / 0 packed</span>
                <span class="badge ok" id="weightBadge">0 oz</span>
              </div>
            </div>
          </div>
        </main>

        <aside class="card" aria-label="Trip details and weight calculator">
          <div class="card-h">
            <h2>Weight &amp; Notes</h2>
            <div class="row">
              <button class="btn small ghost" id="btnExport" type="button" title="Export current list as JSON">
                <span aria-hidden="true">‚á™</span><span>Export</span>
              </button>
              <button class="btn small ghost" id="btnImport" type="button" title="Import a list JSON">
                <span aria-hidden="true">‚á©</span><span>Import</span>
              </button>
            </div>
          </div>
          <div class="card-b">
            <div class="stats" aria-label="Stats">
              <div class="kpi">
                <div class="k">Packed weight</div>
                <div class="v">
                  <div class="num" id="kpiPacked">0 oz</div>
                  <div class="sub" id="kpiPackedSub">0 items</div>
                </div>
              </div>
              <div class="kpi">
                <div class="k">Total list weight</div>
                <div class="v">
                  <div class="num" id="kpiTotal">0 oz</div>
                  <div class="sub" id="kpiTotalSub">0 items</div>
                </div>
              </div>
              <div class="kpi">
                <div class="k">Base weight</div>
                <div class="v">
                  <div class="num" id="kpiBase">0 oz</div>
                  <div class="sub">excludes consumables</div>
                </div>
              </div>
              <div class="kpi">
                <div class="k">Goal</div>
                <div class="v">
                  <div class="num" id="kpiGoal">‚Äî</div>
                  <div class="sub" id="kpiGoalSub">set a target</div>
                </div>
                <div class="bar" aria-hidden="true"><i id="goalBar"></i></div>
              </div>
            </div>

            <div style="height: 12px"></div>
            <div class="grid2">
              <div class="select">
                <div class="label">Goal pack weight</div>
                <input id="goalInput" inputmode="decimal" placeholder="e.g., 25 (lb) or 400 (oz)" />
              </div>
              <div class="select">
                <div class="label">Trip style</div>
                <select id="tripStyle">
                  <option value="backpacking">Backpacking</option>
                  <option value="car">Car camping</option>
                  <option value="bike">Bikepacking</option>
                  <option value="canoe">Canoe/kayak</option>
                  <option value="snow">Snow camping</option>
                </select>
              </div>
            </div>

            <div style="height: 12px"></div>
            <div class="select">
              <div class="label">Trip notes</div>
              <textarea id="notes" placeholder="Route, weather, permits, water sources, food plan‚Ä¶"></textarea>
            </div>

            <div style="height: 12px"></div>
            <div class="hint">
              Everything is stored locally in your browser (no network calls). Export to share or to move between devices.
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Add/Edit Item Dialog -->
    <dialog id="dlgItem" aria-label="Add or edit item">
      <form method="dialog" id="itemForm">
        <div class="dlg-h">
          <h3 id="dlgItemTitle">Add item</h3>
          <button class="iconbtn" value="cancel" aria-label="Close" formnovalidate>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 6l12 12M18 6L6 18" stroke="rgba(234,246,238,0.88)" stroke-width="2" stroke-linecap="round" />
            </svg>
          </button>
        </div>
        <div class="dlg-b">
          <div class="select">
            <div class="label">Item name</div>
            <input id="fName" required placeholder="e.g., Headlamp, Tent stakes, Water filter" />
          </div>
          <div class="grid2">
            <div class="select">
              <div class="label">Category</div>
              <select id="fCategory"></select>
            </div>
            <div class="select">
              <div class="label">Quantity</div>
              <input id="fQty" inputmode="numeric" pattern="[0-9]*" placeholder="1" />
            </div>
          </div>
          <div class="grid2">
            <div class="select">
              <div class="label">Weight (per item)</div>
              <input id="fWeight" inputmode="decimal" placeholder="e.g., 3.2" />
            </div>
            <div class="select">
              <div class="label">Notes (optional)</div>
              <input id="fNotes" placeholder="brand, size, packed location‚Ä¶" />
            </div>
          </div>
          <div class="row" style="justify-content: space-between">
            <label class="badge warn" style="cursor: pointer">
              <input id="fEssential" type="checkbox" style="margin: 0 6px 0 0; accent-color: var(--warn)" />
              Essential
            </label>
            <label class="badge" style="cursor: pointer">
              <input id="fConsumable" type="checkbox" style="margin: 0 6px 0 0; accent-color: var(--accent)" />
              Consumable
            </label>
            <label class="badge ok" style="cursor: pointer">
              <input id="fPacked" type="checkbox" style="margin: 0 6px 0 0; accent-color: var(--ok)" />
              Packed
            </label>
          </div>
        </div>
        <div class="actions">
          <button class="btn ghost" value="cancel" type="submit" formnovalidate>Cancel</button>
          <button class="btn primary" id="btnSaveItem" value="default" type="submit">Save item</button>
        </div>
      </form>
    </dialog>

    <!-- New/Rename Dialog -->
    <dialog id="dlgList" aria-label="Create or rename list">
      <form method="dialog" id="listForm">
        <div class="dlg-h">
          <h3 id="dlgListTitle">New list</h3>
          <button class="iconbtn" value="cancel" aria-label="Close" formnovalidate>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 6l12 12M18 6L6 18" stroke="rgba(234,246,238,0.88)" stroke-width="2" stroke-linecap="round" />
            </svg>
          </button>
        </div>
        <div class="dlg-b">
          <div class="select">
            <div class="label">List name</div>
            <input id="listName" required placeholder="e.g., Tahoe Weekend, Family Car Camp" />
          </div>
          <div class="select" id="templateRow">
            <div class="label">Start from template</div>
            <select id="templateSelect"></select>
            <div class="hint" id="templateHint">Choose a starter set you can customize.</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn ghost" value="cancel" type="submit" formnovalidate>Cancel</button>
          <button class="btn primary" id="btnSaveList" value="default" type="submit">Save</button>
        </div>
      </form>
    </dialog>

    <!-- Import Dialog -->
    <dialog id="dlgImport" aria-label="Import list JSON">
      <form method="dialog" id="importForm">
        <div class="dlg-h">
          <h3>Import</h3>
          <button class="iconbtn" value="cancel" aria-label="Close" formnovalidate>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 6l12 12M18 6L6 18" stroke="rgba(234,246,238,0.88)" stroke-width="2" stroke-linecap="round" />
            </svg>
          </button>
        </div>
        <div class="dlg-b">
          <div class="select">
            <div class="label">Paste JSON</div>
            <textarea id="importText" placeholder='{"name":"...","items":[...]}'></textarea>
            <div class="hint">You can paste a list export or a single list object.</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn ghost" value="cancel" type="submit" formnovalidate>Cancel</button>
          <button class="btn primary" id="btnDoImport" value="default" type="submit">Import</button>
        </div>
      </form>
    </dialog>

    <div class="toast" id="toast" role="status" aria-live="polite">
      <span class="msg" id="toastMsg">Saved</span>
      <span class="kbd" id="toastKbd" style="display: none"></span>
    </div>

    <script>
      (() => {
        "use strict";

        const STORAGE_KEY = "cgcl.v1";
        const PREFS_KEY = "cgcl.prefs.v1";

        const OZ_TO_G = 28.349523125;
        const LB_TO_G = 453.59237;

        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const ui = {
          saveState: $("#saveState"),
          unitSeg: $$(".seg button"),
          listSelect: $("#listSelect"),
          btnNew: $("#btnNew"),
          btnDuplicate: $("#btnDuplicate"),
          btnRename: $("#btnRename"),
          btnDeleteList: $("#btnDeleteList"),
          search: $("#search"),
          cats: $("#cats"),
          btnAdd: $("#btnAdd"),
          btnQuickPack: $("#btnQuickPack"),
          btnResetPacked: $("#btnResetPacked"),
          progressBadge: $("#progressBadge"),
          weightBadge: $("#weightBadge"),
          btnExport: $("#btnExport"),
          btnImport: $("#btnImport"),
          notes: $("#notes"),
          goalInput: $("#goalInput"),
          tripStyle: $("#tripStyle"),
          kpiPacked: $("#kpiPacked"),
          kpiPackedSub: $("#kpiPackedSub"),
          kpiTotal: $("#kpiTotal"),
          kpiTotalSub: $("#kpiTotalSub"),
          kpiBase: $("#kpiBase"),
          kpiGoal: $("#kpiGoal"),
          kpiGoalSub: $("#kpiGoalSub"),
          goalBar: $("#goalBar"),
          toast: $("#toast"),
          toastMsg: $("#toastMsg"),
          toastKbd: $("#toastKbd"),
        };

        const dlgItem = $("#dlgItem");
        const dlgList = $("#dlgList");
        const dlgImport = $("#dlgImport");

        const itemForm = $("#itemForm");
        const fName = $("#fName");
        const fCategory = $("#fCategory");
        const fQty = $("#fQty");
        const fWeight = $("#fWeight");
        const fNotes = $("#fNotes");
        const fEssential = $("#fEssential");
        const fConsumable = $("#fConsumable");
        const fPacked = $("#fPacked");
        const dlgItemTitle = $("#dlgItemTitle");
        const btnSaveItem = $("#btnSaveItem");

        const listForm = $("#listForm");
        const dlgListTitle = $("#dlgListTitle");
        const listName = $("#listName");
        const templateRow = $("#templateRow");
        const templateSelect = $("#templateSelect");
        const templateHint = $("#templateHint");
        const btnSaveList = $("#btnSaveList");

        const importText = $("#importText");
        const btnDoImport = $("#btnDoImport");
        const importForm = $("#importForm");

        let state = null;
        let prefs = null;
        let activeList = null;
        let filterMode = "all";
        let itemEditingId = null;
        let listDialogMode = "new"; // new | rename
        let lastSaveAt = 0;
        let toastTimer = null;

        const CATEGORIES = [
          { id: "shelter", name: "Shelter", icon: "‚õ∫" },
          { id: "sleep", name: "Sleep", icon: "üåô" },
          { id: "cook", name: "Cook & Water", icon: "üî•" },
          { id: "clothing", name: "Clothing", icon: "üß•" },
          { id: "tools", name: "Tools & Repair", icon: "üß∞" },
          { id: "safety", name: "Safety & Navigation", icon: "üß≠" },
          { id: "hygiene", name: "Hygiene", icon: "üßº" },
          { id: "extras", name: "Extras", icon: "üå≤" },
          { id: "food", name: "Food", icon: "ü•ú" },
        ];

        const TEMPLATES = [
          {
            id: "backpacking",
            name: "Weekend Backpacking (starter)",
            tripStyle: "backpacking",
            goal: { unit: "lb", value: 25 },
            items: [
              ["shelter", "Tent (inner + fly)", 1200, 1, true, false, ""],
              ["shelter", "Footprint / groundsheet", 200, 1, false, false, ""],
              ["shelter", "Tent stakes", 90, 1, true, false, ""],
              ["sleep", "Sleeping bag/quilt", 900, 1, true, false, ""],
              ["sleep", "Sleeping pad", 450, 1, true, false, ""],
              ["sleep", "Pillow (optional)", 90, 1, false, false, ""],
              ["cook", "Stove", 85, 1, true, false, ""],
              ["cook", "Fuel canister", 230, 1, true, true, ""],
              ["cook", "Pot / mug", 160, 1, true, false, ""],
              ["cook", "Spoon", 18, 1, true, false, ""],
              ["cook", "Water filter", 100, 1, true, false, ""],
              ["cook", "Water bottles/bladder", 140, 2, true, false, ""],
              ["clothing", "Rain jacket", 260, 1, true, false, ""],
              ["clothing", "Insulating layer", 340, 1, true, false, ""],
              ["clothing", "Base layers (sleep)", 220, 1, false, false, ""],
              ["clothing", "Extra socks", 60, 2, true, false, ""],
              ["tools", "Headlamp", 90, 1, true, false, "spare batteries"],
              ["tools", "Knife / multitool", 75, 1, true, false, ""],
              ["tools", "Duct tape (wrap)", 20, 1, false, false, ""],
              ["safety", "First aid kit", 180, 1, true, false, ""],
              ["safety", "Map/offline route", 5, 1, true, false, ""],
              ["safety", "Whistle", 8, 1, true, false, ""],
              ["hygiene", "Toothbrush + paste", 35, 1, true, true, ""],
              ["hygiene", "Sunscreen", 70, 1, true, true, ""],
              ["hygiene", "Hand sanitizer", 45, 1, true, true, ""],
              ["food", "Meals (2‚Äì3 days)", 700, 1, true, true, "estimate"],
              ["food", "Snacks", 300, 1, true, true, "estimate"],
              ["extras", "Trash bag", 20, 1, true, true, ""],
            ],
          },
          {
            id: "car",
            name: "Car Camping (starter)",
            tripStyle: "car",
            goal: null,
            items: [
              ["shelter", "Tent", 3800, 1, true, false, ""],
              ["shelter", "Tarp / shade", 900, 1, false, false, ""],
              ["sleep", "Sleeping bag", 1500, 1, true, false, ""],
              ["sleep", "Sleeping pad/air mattress", 2100, 1, true, false, ""],
              ["sleep", "Pillow", 300, 1, false, false, ""],
              ["cook", "Cooler", 4500, 1, true, false, ""],
              ["cook", "Camp stove", 2500, 1, true, false, ""],
              ["cook", "Fuel", 350, 1, true, true, ""],
              ["cook", "Pot/pan", 650, 1, true, false, ""],
              ["cook", "Plates/bowls", 120, 4, true, false, ""],
              ["cook", "Utensils", 40, 4, true, false, ""],
              ["cook", "Water jug", 900, 1, true, false, ""],
              ["tools", "Lantern", 550, 1, false, false, ""],
              ["tools", "Headlamp", 90, 2, true, false, ""],
              ["safety", "First aid kit", 250, 1, true, false, ""],
              ["extras", "Camp chairs", 2500, 2, false, false, ""],
              ["extras", "Games/cards", 250, 1, false, false, ""],
              ["hygiene", "Soap", 90, 1, true, true, ""],
              ["food", "Food & drinks", 1500, 1, true, true, "estimate"],
            ],
          },
          {
            id: "minimal",
            name: "Blank List",
            tripStyle: "backpacking",
            goal: null,
            items: [],
          },
        ];

        function uid() {
          try {
            return crypto.randomUUID();
          } catch {
            return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
          }
        }

        function clamp(n, a, b) {
          return Math.max(a, Math.min(b, n));
        }

        function safeNum(n, fallback = 0) {
          const x = Number(n);
          return Number.isFinite(x) ? x : fallback;
        }

        function nowIso() {
          return new Date().toISOString();
        }

        function formatWeight(g, unit) {
          const grams = safeNum(g, 0);
          if (unit === "g") return `${Math.round(grams)} g`;
          if (unit === "lb") return `${(grams / LB_TO_G).toFixed(2).replace(/\.00$/, "")} lb`;
          return `${(grams / OZ_TO_G).toFixed(1).replace(/\.0$/, "")} oz`;
        }

        function parseWeightToGrams(valueStr, unit) {
          const v = String(valueStr ?? "").trim().replace(",", ".");
          if (!v) return null;
          const n = Number(v);
          if (!Number.isFinite(n) || n < 0) return null;
          if (unit === "g") return n;
          if (unit === "lb") return n * LB_TO_G;
          return n * OZ_TO_G;
        }

        function prettyCount(n, word) {
          return `${n} ${word}${n === 1 ? "" : "s"}`;
        }

        function toast(msg, kbd = "") {
          ui.toastMsg.textContent = msg;
          if (kbd) {
            ui.toastKbd.style.display = "";
            ui.toastKbd.textContent = kbd;
          } else {
            ui.toastKbd.style.display = "none";
            ui.toastKbd.textContent = "";
          }
          ui.toast.classList.add("show");
          window.clearTimeout(toastTimer);
          toastTimer = window.setTimeout(() => ui.toast.classList.remove("show"), 2200);
        }

        function loadPrefs() {
          const def = { unit: "oz", collapsed: {}, filter: "all" };
          try {
            const raw = localStorage.getItem(PREFS_KEY);
            if (!raw) return def;
            const p = JSON.parse(raw);
            return { ...def, ...p, collapsed: { ...(p?.collapsed || {}) } };
          } catch {
            return def;
          }
        }

        function savePrefs() {
          try {
            localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
          } catch {
            // ignore
          }
        }

        function seedState() {
          const listFromTemplate = (tpl, nameOverride = null) => {
            const listId = uid();
            const items = tpl.items.map(([cat, name, g, qty, essential, consumable, notes]) => ({
              id: uid(),
              name,
              category: cat,
              weightG: safeNum(g, 0),
              qty: clamp(Math.round(safeNum(qty, 1)), 1, 999),
              essential: Boolean(essential),
              consumable: Boolean(consumable),
              packed: false,
              notes: notes || "",
              createdAt: nowIso(),
              updatedAt: nowIso(),
            }));
            return {
              id: listId,
              name: nameOverride || tpl.name.replace(" (starter)", ""),
              tripStyle: tpl.tripStyle,
              goalG: tpl.goal ? parseWeightToGrams(String(tpl.goal.value), tpl.goal.unit) : null,
              notes: "",
              items,
              createdAt: nowIso(),
              updatedAt: nowIso(),
            };
          };

          const initial = listFromTemplate(TEMPLATES[0], "Weekend Backpacking");
          const state = {
            version: 1,
            activeListId: initial.id,
            lists: [initial],
            createdAt: nowIso(),
            updatedAt: nowIso(),
          };
          return state;
        }

        function loadState() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return seedState();
            const s = JSON.parse(raw);
            if (!s || s.version !== 1 || !Array.isArray(s.lists)) return seedState();
            if (!s.lists.length) return seedState();
            return s;
          } catch {
            return seedState();
          }
        }

        function stampSaved() {
          lastSaveAt = Date.now();
          const d = new Date(lastSaveAt);
          const hh = String(d.getHours()).padStart(2, "0");
          const mm = String(d.getMinutes()).padStart(2, "0");
          ui.saveState.textContent = `${hh}:${mm}`;
        }

        function persist() {
          if (!state) return;
          state.updatedAt = nowIso();
          if (activeList) activeList.updatedAt = nowIso();
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            stampSaved();
          } catch {
            toast("Couldn‚Äôt save (storage full?)");
          }
        }

        function getActiveList() {
          const id = state.activeListId;
          let list = state.lists.find((l) => l.id === id) || null;
          if (!list) {
            list = state.lists[0] || null;
            state.activeListId = list?.id || null;
          }
          return list;
        }

        function sortItemsForDisplay(items) {
          const cOrder = new Map(CATEGORIES.map((c, i) => [c.id, i]));
          return [...items].sort((a, b) => {
            const ca = cOrder.has(a.category) ? cOrder.get(a.category) : 999;
            const cb = cOrder.has(b.category) ? cOrder.get(b.category) : 999;
            if (ca !== cb) return ca - cb;
            const pa = a.packed ? 1 : 0;
            const pb = b.packed ? 1 : 0;
            if (pa !== pb) return pa - pb;
            return a.name.localeCompare(b.name);
          });
        }

        function listStats(list) {
          const items = list.items || [];
          let totalG = 0;
          let packedG = 0;
          let baseG = 0;
          let packedCount = 0;
          let totalCount = 0;
          for (const it of items) {
            const qty = clamp(Math.round(safeNum(it.qty, 1)), 1, 999);
            const g = clamp(safeNum(it.weightG, 0), 0, 9e9) * qty;
            totalG += g;
            totalCount += qty;
            if (!it.consumable) baseG += g;
            if (it.packed) {
              packedG += g;
              packedCount += qty;
            }
          }
          return { totalG, packedG, baseG, packedCount, totalCount };
        }

        function itemMatches(it, q) {
          if (!q) return true;
          const s = (it.name + " " + (it.notes || "")).toLowerCase();
          return s.includes(q);
        }

        function itemPassesFilter(it) {
          if (filterMode === "packed") return !!it.packed;
          if (filterMode === "unpacked") return !it.packed;
          if (filterMode === "essential") return !!it.essential;
          return true;
        }

        function setFilter(mode) {
          filterMode = mode;
          prefs.filter = mode;
          savePrefs();
          $("#fltAll").classList.toggle("ghost", mode !== "all");
          $("#fltUnpacked").classList.toggle("ghost", mode !== "unpacked");
          $("#fltPacked").classList.toggle("ghost", mode !== "packed");
          $("#fltEssential").classList.toggle("ghost", mode !== "essential");
          render();
        }

        function setUnit(unit) {
          prefs.unit = unit;
          savePrefs();
          ui.unitSeg.forEach((b) => (b.setAttribute("aria-pressed", String(b.dataset.unit === unit))));
          render();
        }

        function ensureCategoryOptions() {
          fCategory.innerHTML = "";
          for (const c of CATEGORIES) {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = `${c.icon} ${c.name}`;
            fCategory.appendChild(opt);
          }
        }

        function renderListSelect() {
          ui.listSelect.innerHTML = "";
          for (const l of state.lists) {
            const opt = document.createElement("option");
            opt.value = l.id;
            opt.textContent = l.name;
            ui.listSelect.appendChild(opt);
          }
          ui.listSelect.value = state.activeListId;
        }

        function renderStats() {
          const { totalG, packedG, baseG, packedCount, totalCount } = listStats(activeList);
          const unit = prefs.unit;

          ui.progressBadge.textContent = `${packedCount} / ${totalCount} packed`;
          ui.weightBadge.textContent = `${formatWeight(packedG, unit)} packed`;

          ui.kpiPacked.textContent = formatWeight(packedG, unit);
          ui.kpiPackedSub.textContent = `${prettyCount(packedCount, "item")} packed`;

          ui.kpiTotal.textContent = formatWeight(totalG, unit);
          ui.kpiTotalSub.textContent = `${prettyCount(totalCount, "item")} total`;

          ui.kpiBase.textContent = formatWeight(baseG, unit);

          const goalG = activeList.goalG;
          if (!goalG || goalG <= 0) {
            ui.kpiGoal.textContent = "‚Äî";
            ui.kpiGoalSub.textContent = "set a target";
            ui.goalBar.style.width = "0%";
          } else {
            ui.kpiGoal.textContent = formatWeight(goalG, unit);
            const pct = clamp((totalG / goalG) * 100, 0, 130);
            ui.goalBar.style.width = `${Math.min(pct, 100)}%`;
            const delta = goalG - totalG;
            if (delta >= 0) ui.kpiGoalSub.textContent = `${formatWeight(delta, unit)} remaining`;
            else ui.kpiGoalSub.textContent = `${formatWeight(Math.abs(delta), unit)} over`;
          }
        }

        function catIcon(categoryId) {
          return CATEGORIES.find((c) => c.id === categoryId)?.icon || "üèï";
        }

        function catName(categoryId) {
          return CATEGORIES.find((c) => c.id === categoryId)?.name || "Other";
        }

        function renderCategories() {
          const unit = prefs.unit;
          const q = ui.search.value.trim().toLowerCase();
          const items = sortItemsForDisplay(activeList.items || []);

          const byCat = new Map();
          for (const it of items) {
            if (!itemMatches(it, q)) continue;
            if (!itemPassesFilter(it)) continue;
            const c = it.category || "extras";
            if (!byCat.has(c)) byCat.set(c, []);
            byCat.get(c).push(it);
          }

          const order = [...new Set(CATEGORIES.map((c) => c.id).concat([...byCat.keys()]))];
          ui.cats.innerHTML = "";

          let any = false;
          for (const cId of order) {
            const group = byCat.get(cId);
            if (!group || !group.length) continue;
            any = true;

            const det = document.createElement("details");
            det.className = "cat";
            det.open = !prefs.collapsed[cId];
            det.addEventListener("toggle", () => {
              prefs.collapsed[cId] = !det.open;
              savePrefs();
            });

            const sum = document.createElement("summary");
            const left = document.createElement("div");
            left.className = "cat-title";
            left.innerHTML = `
              <div class="ic" aria-hidden="true">${catIcon(cId)}</div>
              <div style="min-width:0">
                <h3>${escapeHtml(catName(cId))}</h3>
              </div>
            `;
            const meta = document.createElement("div");
            meta.className = "cat-meta";

            let catTotalG = 0;
            let catPackedG = 0;
            let catCount = 0;
            let catPackedCount = 0;
            for (const it of group) {
              const qty = clamp(Math.round(safeNum(it.qty, 1)), 1, 999);
              const g = clamp(safeNum(it.weightG, 0), 0, 9e9) * qty;
              catTotalG += g;
              catCount += qty;
              if (it.packed) {
                catPackedG += g;
                catPackedCount += qty;
              }
            }

            meta.textContent = `${catPackedCount}/${catCount} ¬∑ ${formatWeight(catPackedG, unit)} / ${formatWeight(catTotalG, unit)}`;

            sum.appendChild(left);
            sum.appendChild(meta);

            const itemsWrap = document.createElement("div");
            itemsWrap.className = "items";

            for (const it of group) {
              itemsWrap.appendChild(renderItem(it, unit, q));
            }

            det.appendChild(sum);
            det.appendChild(itemsWrap);
            ui.cats.appendChild(det);
          }

          if (!any) {
            const empty = document.createElement("div");
            empty.className = "hint";
            empty.style.padding = "8px 2px";
            empty.textContent = q ? "No matches. Try a different search." : "No items yet. Add a few to get started.";
            ui.cats.appendChild(empty);
          }
        }

        function escapeHtml(s) {
          return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function renderItem(it, unit, q) {
          const row = document.createElement("div");
          row.className = "item" + (it.packed ? " packed" : "");
          row.dataset.id = it.id;

          const qty = clamp(Math.round(safeNum(it.qty, 1)), 1, 999);
          const gPer = clamp(safeNum(it.weightG, 0), 0, 9e9);
          const gTotal = gPer * qty;

          const nameStrong = q ? highlight(it.name, q) : escapeHtml(it.name);
          const notes = (it.notes || "").trim();
          const notesHtml = notes ? `<span class="pill2">${escapeHtml(notes)}</span>` : "";
          const ess = it.essential ? `<span class="pill2 ess">‚òÖ essential</span>` : "";
          const con = it.consumable ? `<span class="pill2 con">‚óå consumable</span>` : "";
          const perLabel = gPer > 0 ? `${formatWeight(gPer, unit)} each` : "weight ‚Äî";
          const totalLabel = gTotal > 0 ? formatWeight(gTotal, unit) : "‚Äî";

          row.innerHTML = `
            <input type="checkbox" ${it.packed ? "checked" : ""} aria-label="Mark packed: ${escapeHtml(it.name)}" style="accent-color: var(--ok); width:18px; height:18px;" />
            <div class="name">
              <div class="top"><strong>${nameStrong}</strong></div>
              <div class="meta">
                <span class="pill2">${perLabel}</span>
                ${ess}
                ${con}
                ${notesHtml}
              </div>
            </div>
            <div class="qty">
              <div class="qtyctrl" aria-label="Quantity">
                <button type="button" data-act="dec" aria-label="Decrease quantity">‚àí</button>
                <span aria-label="Quantity value">${qty}</span>
                <button type="button" data-act="inc" aria-label="Increase quantity">Ôºã</button>
              </div>
            </div>
            <div class="w mini" aria-label="Total weight">${totalLabel}</div>
            <div class="row" style="justify-content:flex-end; gap:8px;">
              <button type="button" class="iconbtn" data-act="edit" aria-label="Edit item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M12 20h9" stroke="rgba(234,246,238,0.78)" stroke-width="2" stroke-linecap="round"/>
                  <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"
                    stroke="rgba(87,230,255,0.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button type="button" class="iconbtn" data-act="del" aria-label="Delete item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M3 6h18" stroke="rgba(234,246,238,0.78)" stroke-width="2" stroke-linecap="round"/>
                  <path d="M8 6V4h8v2" stroke="rgba(234,246,238,0.78)" stroke-width="2" stroke-linecap="round"/>
                  <path d="M6 6l1 14h10l1-14" stroke="rgba(255,107,107,0.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          `;

          const cb = row.querySelector('input[type="checkbox"]');
          cb.addEventListener("change", () => {
            it.packed = cb.checked;
            it.updatedAt = nowIso();
            persist();
            render();
          });

          row.addEventListener("click", (e) => {
            const t = e.target;
            if (!(t instanceof Element)) return;
            const btn = t.closest("button");
            if (!btn) return;
            const act = btn.dataset.act;
            if (act === "inc" || act === "dec") {
              const next = clamp(qty + (act === "inc" ? 1 : -1), 1, 999);
              it.qty = next;
              it.updatedAt = nowIso();
              persist();
              render();
            } else if (act === "edit") {
              openItemDialog("edit", it.id);
            } else if (act === "del") {
              const ok = confirm(`Delete ‚Äú${it.name}‚Äù?`);
              if (!ok) return;
              activeList.items = activeList.items.filter((x) => x.id !== it.id);
              persist();
              toast("Item deleted");
              render();
            }
          });

          return row;
        }

        function highlight(text, q) {
          const s = String(text);
          const idx = s.toLowerCase().indexOf(q);
          if (idx < 0) return escapeHtml(s);
          const a = escapeHtml(s.slice(0, idx));
          const b = escapeHtml(s.slice(idx, idx + q.length));
          const c = escapeHtml(s.slice(idx + q.length));
          return `${a}<mark style="background: rgba(255,209,102,0.18); color: inherit; padding: 0 2px; border-radius: 6px; border: 1px solid rgba(255,209,102,0.22)">${b}</mark>${c}`;
        }

        function render() {
          if (!activeList) return;
          renderListSelect();
          ui.notes.value = activeList.notes || "";
          ui.tripStyle.value = activeList.tripStyle || "backpacking";
          ui.goalInput.value = goalInputDisplay(activeList.goalG, prefs.unit);
          renderStats();
          renderCategories();
        }

        function goalInputDisplay(goalG, unit) {
          if (!goalG || goalG <= 0) return "";
          if (unit === "g") return String(Math.round(goalG));
          if (unit === "lb") return String((goalG / LB_TO_G).toFixed(2).replace(/\.00$/, ""));
          return String((goalG / OZ_TO_G).toFixed(1).replace(/\.0$/, ""));
        }

        function openItemDialog(mode, itemId = null) {
          itemEditingId = itemId;
          ensureCategoryOptions();

          const isEdit = mode === "edit" && itemId;
          dlgItemTitle.textContent = isEdit ? "Edit item" : "Add item";
          btnSaveItem.textContent = isEdit ? "Save changes" : "Save item";

          const unit = prefs.unit;
          if (isEdit) {
            const it = activeList.items.find((x) => x.id === itemId);
            if (!it) return;
            fName.value = it.name || "";
            fCategory.value = it.category || "extras";
            fQty.value = String(clamp(Math.round(safeNum(it.qty, 1)), 1, 999));
            const per = clamp(safeNum(it.weightG, 0), 0, 9e9);
            if (per > 0) {
              if (unit === "g") fWeight.value = String(Math.round(per));
              else if (unit === "lb") fWeight.value = String((per / LB_TO_G).toFixed(2).replace(/\.00$/, ""));
              else fWeight.value = String((per / OZ_TO_G).toFixed(1).replace(/\.0$/, ""));
            } else {
              fWeight.value = "";
            }
            fNotes.value = it.notes || "";
            fEssential.checked = !!it.essential;
            fConsumable.checked = !!it.consumable;
            fPacked.checked = !!it.packed;
          } else {
            fName.value = "";
            fCategory.value = guessCategoryFromTripStyle(activeList.tripStyle);
            fQty.value = "1";
            fWeight.value = "";
            fNotes.value = "";
            fEssential.checked = false;
            fConsumable.checked = false;
            fPacked.checked = false;
          }

          dlgItem.showModal();
          setTimeout(() => fName.focus(), 50);
        }

        function guessCategoryFromTripStyle(style) {
          if (style === "car") return "extras";
          if (style === "snow") return "clothing";
          return "shelter";
        }

        function openListDialog(mode) {
          listDialogMode = mode;
          if (mode === "rename") {
            dlgListTitle.textContent = "Rename list";
            btnSaveList.textContent = "Rename";
            listName.value = activeList?.name || "";
            templateRow.style.display = "none";
          } else {
            dlgListTitle.textContent = "New list";
            btnSaveList.textContent = "Create";
            listName.value = "";
            templateRow.style.display = "";
            templateSelect.innerHTML = "";
            for (const tpl of TEMPLATES) {
              const opt = document.createElement("option");
              opt.value = tpl.id;
              opt.textContent = tpl.name;
              templateSelect.appendChild(opt);
            }
            templateSelect.value = "backpacking";
            templateHint.textContent = "Choose a starter set you can customize.";
          }
          dlgList.showModal();
          setTimeout(() => listName.focus(), 50);
        }

        function createListFromTemplate(templateId, name) {
          const tpl = TEMPLATES.find((t) => t.id === templateId) || TEMPLATES[0];
          const list = {
            id: uid(),
            name: name || tpl.name.replace(" (starter)", ""),
            tripStyle: tpl.tripStyle,
            goalG: tpl.goal ? parseWeightToGrams(String(tpl.goal.value), tpl.goal.unit) : null,
            notes: "",
            items: tpl.items.map(([cat, nm, g, qty, ess, con, notes]) => ({
              id: uid(),
              name: nm,
              category: cat,
              weightG: safeNum(g, 0),
              qty: clamp(Math.round(safeNum(qty, 1)), 1, 999),
              essential: !!ess,
              consumable: !!con,
              packed: false,
              notes: notes || "",
              createdAt: nowIso(),
              updatedAt: nowIso(),
            })),
            createdAt: nowIso(),
            updatedAt: nowIso(),
          };
          state.lists.unshift(list);
          state.activeListId = list.id;
          activeList = list;
          persist();
          toast("List created", "N");
          render();
        }

        function duplicateActiveList() {
          const src = activeList;
          const copy = {
            ...structuredCloneSafe(src),
            id: uid(),
            name: src.name + " (copy)",
            createdAt: nowIso(),
            updatedAt: nowIso(),
            items: (src.items || []).map((it) => ({ ...structuredCloneSafe(it), id: uid(), packed: false })),
          };
          state.lists.unshift(copy);
          state.activeListId = copy.id;
          activeList = copy;
          persist();
          toast("List duplicated");
          render();
        }

        function structuredCloneSafe(obj) {
          try {
            return structuredClone(obj);
          } catch {
            return JSON.parse(JSON.stringify(obj));
          }
        }

        function deleteActiveList() {
          if (state.lists.length <= 1) {
            toast("Keep at least one list");
            return;
          }
          const ok = confirm(`Delete the list ‚Äú${activeList.name}‚Äù? This can‚Äôt be undone.`);
          if (!ok) return;
          state.lists = state.lists.filter((l) => l.id !== activeList.id);
          state.activeListId = state.lists[0].id;
          activeList = getActiveList();
          persist();
          toast("List deleted");
          render();
        }

        function exportActiveList() {
          const payload = {
            name: activeList.name,
            tripStyle: activeList.tripStyle,
            goalG: activeList.goalG,
            notes: activeList.notes,
            items: activeList.items,
            exportedAt: nowIso(),
            app: "Camping Gear Checklist",
            version: 1,
          };
          const json = JSON.stringify(payload, null, 2);
          const doClipboard = async () => {
            try {
              await navigator.clipboard.writeText(json);
              toast("Export copied to clipboard");
              return true;
            } catch {
              return false;
            }
          };
          doClipboard().then((copied) => {
            if (copied) return;
            // Fallback: download
            const blob = new Blob([json], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${activeList.name.replace(/[^\w\-]+/g, "_").slice(0, 40) || "camping_gear"}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            toast("Export downloaded");
          });
        }

        function openImportDialog() {
          importText.value = "";
          dlgImport.showModal();
          setTimeout(() => importText.focus(), 50);
        }

        function importFromJson(text) {
          let obj = null;
          try {
            obj = JSON.parse(text);
          } catch {
            toast("Invalid JSON");
            return;
          }
          if (obj && obj.version === 1 && Array.isArray(obj.lists)) {
            const imported = obj.lists.map((l) => normalizeImportedListObject(l)).filter(Boolean);
            if (!imported.length) {
              toast("Couldn‚Äôt import: no lists found");
              return;
            }
            state.lists.unshift(...imported);
            state.activeListId = imported[0].id;
            activeList = getActiveList();
            persist();
            toast(`Imported ${imported.length} list${imported.length === 1 ? "" : "s"}`);
            render();
            return;
          }

          const maybeList = normalizeImportedList(obj);
          if (!maybeList) {
            toast("Couldn‚Äôt import: unrecognized format");
            return;
          }
          state.lists.unshift(maybeList);
          state.activeListId = maybeList.id;
          activeList = maybeList;
          persist();
          toast("Imported");
          render();
        }

        function normalizeImportedList(obj) {
          // Accept either a raw list export payload or a list object.
          const src = obj?.items ? obj : obj?.list?.items ? obj.list : null;
          if (!src || !Array.isArray(src.items)) return null;
          return normalizeImportedListObject(src);
        }

        function normalizeImportedListObject(src) {
          if (!src || !Array.isArray(src.items)) return null;
          const name = String(src.name || "Imported list").slice(0, 80);
          const tripStyle = String(src.tripStyle || "backpacking");
          const goalG = src.goalG != null ? safeNum(src.goalG, null) : null;
          const notes = String(src.notes || "");

          const items = src.items
            .filter((x) => x && typeof x === "object")
            .map((x) => ({
              id: uid(),
              name: String(x.name || "Item").slice(0, 120),
              category: String(x.category || "extras"),
              weightG: clamp(safeNum(x.weightG, 0), 0, 9e9),
              qty: clamp(Math.round(safeNum(x.qty, 1)), 1, 999),
              essential: !!x.essential,
              consumable: !!x.consumable,
              packed: !!x.packed,
              notes: String(x.notes || "").slice(0, 200),
              createdAt: nowIso(),
              updatedAt: nowIso(),
            }));

          return {
            id: uid(),
            name,
            tripStyle,
            goalG: goalG && goalG > 0 ? goalG : null,
            notes,
            items,
            createdAt: nowIso(),
            updatedAt: nowIso(),
          };
        }

        function packEssentials() {
          let changed = 0;
          for (const it of activeList.items) {
            if (it.essential && !it.packed) {
              it.packed = true;
              it.updatedAt = nowIso();
              changed++;
            }
          }
          if (changed) {
            persist();
            toast(`Packed ${changed} essential${changed === 1 ? "" : "s"}`);
            render();
          } else {
            toast("Essentials already packed");
          }
        }

        function resetPacked() {
          const ok = confirm("Mark all items as unpacked?");
          if (!ok) return;
          for (const it of activeList.items) {
            it.packed = false;
            it.updatedAt = nowIso();
          }
          persist();
          toast("Packed state reset");
          render();
        }

        function addOrEditItemFromForm() {
          const unit = prefs.unit;
          const nm = fName.value.trim();
          if (!nm) return;

          const category = fCategory.value || "extras";
          const qty = clamp(Math.round(safeNum(fQty.value || 1, 1)), 1, 999);
          const wG = parseWeightToGrams(fWeight.value, unit) ?? 0;
          const notes = fNotes.value.trim();
          const essential = !!fEssential.checked;
          const consumable = !!fConsumable.checked;
          const packed = !!fPacked.checked;

          if (itemEditingId) {
            const it = activeList.items.find((x) => x.id === itemEditingId);
            if (!it) return;
            it.name = nm;
            it.category = category;
            it.qty = qty;
            it.weightG = clamp(wG, 0, 9e9);
            it.notes = notes;
            it.essential = essential;
            it.consumable = consumable;
            it.packed = packed;
            it.updatedAt = nowIso();
            persist();
            toast("Item updated");
            render();
          } else {
            const it = {
              id: uid(),
              name: nm,
              category,
              qty,
              weightG: clamp(wG, 0, 9e9),
              notes,
              essential,
              consumable,
              packed,
              createdAt: nowIso(),
              updatedAt: nowIso(),
            };
            activeList.items.unshift(it);
            persist();
            toast("Item added", "N");
            render();
          }
        }

        function parseGoalFromInput() {
          const raw = ui.goalInput.value.trim();
          if (!raw) return null;

          // Accept e.g., "25 lb", "400oz", "9000 g". If unit omitted, use current display unit.
          const m = raw.match(/^([0-9]+(?:[.,][0-9]+)?)\s*([a-zA-Z]+)?$/);
          if (!m) return null;
          const val = m[1].replace(",", ".");
          const unitRaw = (m[2] || prefs.unit).toLowerCase();
          const unit = unitRaw.startsWith("g") ? "g" : unitRaw.startsWith("lb") ? "lb" : unitRaw.startsWith("oz") ? "oz" : prefs.unit;
          return parseWeightToGrams(val, unit);
        }

        function wire() {
          ui.unitSeg.forEach((b) =>
            b.addEventListener("click", () => {
              setUnit(b.dataset.unit);
              toast(`Unit set to ${b.dataset.unit}`);
            })
          );

          ui.listSelect.addEventListener("change", () => {
            state.activeListId = ui.listSelect.value;
            activeList = getActiveList();
            persist();
            render();
          });

          ui.btnNew.addEventListener("click", () => openListDialog("new"));
          ui.btnRename.addEventListener("click", () => openListDialog("rename"));
          ui.btnDuplicate.addEventListener("click", () => duplicateActiveList());
          ui.btnDeleteList.addEventListener("click", () => deleteActiveList());

          ui.search.addEventListener("input", () => renderCategories());
          $("#fltAll").addEventListener("click", () => setFilter("all"));
          $("#fltUnpacked").addEventListener("click", () => setFilter("unpacked"));
          $("#fltPacked").addEventListener("click", () => setFilter("packed"));
          $("#fltEssential").addEventListener("click", () => setFilter("essential"));

          ui.btnAdd.addEventListener("click", () => openItemDialog("new"));
          ui.btnQuickPack.addEventListener("click", () => packEssentials());
          ui.btnResetPacked.addEventListener("click", () => resetPacked());

          ui.notes.addEventListener("input", () => {
            activeList.notes = ui.notes.value;
            persist();
          });

          ui.tripStyle.addEventListener("change", () => {
            activeList.tripStyle = ui.tripStyle.value;
            persist();
            render();
          });

          ui.goalInput.addEventListener("change", () => {
            const g = parseGoalFromInput();
            activeList.goalG = g && g > 0 ? g : null;
            persist();
            render();
          });
          ui.goalInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              ui.goalInput.blur();
            }
          });

          ui.btnExport.addEventListener("click", () => exportActiveList());
          ui.btnImport.addEventListener("click", () => openImportDialog());

          itemForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const action = (document.activeElement && document.activeElement.getAttribute("value")) || "";
            if (action === "cancel") {
              dlgItem.close("cancel");
              return;
            }
            addOrEditItemFromForm();
            dlgItem.close("ok");
          });
          dlgItem.addEventListener("close", () => {
            itemEditingId = null;
            itemForm.reset();
          });

          listForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const action = (document.activeElement && document.activeElement.getAttribute("value")) || "";
            if (action === "cancel") {
              dlgList.close("cancel");
              return;
            }
            const nm = listName.value.trim();
            if (!nm) return;
            if (listDialogMode === "rename") {
              activeList.name = nm.slice(0, 80);
              persist();
              toast("Renamed");
              render();
              dlgList.close("ok");
              return;
            }
            createListFromTemplate(templateSelect.value, nm);
            dlgList.close("ok");
          });

          importForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const action = (document.activeElement && document.activeElement.getAttribute("value")) || "";
            if (action === "cancel") {
              dlgImport.close("cancel");
              return;
            }
            importFromJson(importText.value);
            dlgImport.close("ok");
          });

          // Keyboard shortcuts
          window.addEventListener("keydown", (e) => {
            if (e.defaultPrevented) return;
            const tag = (e.target && e.target.tagName) || "";
            const inField = ["INPUT", "TEXTAREA", "SELECT"].includes(tag);

            if (e.key === "/" && !inField) {
              e.preventDefault();
              ui.search.focus();
              toast("Search", "/");
              return;
            }
            if ((e.key === "n" || e.key === "N") && !inField) {
              e.preventDefault();
              openItemDialog("new");
              return;
            }
            if ((e.key === "e" || e.key === "E") && (e.metaKey || e.ctrlKey)) {
              e.preventDefault();
              exportActiveList();
            }
          });
        }

        function init() {
          prefs = loadPrefs();
          state = loadState();
          activeList = getActiveList();

          // Ensure structure
          for (const l of state.lists) {
            l.items = Array.isArray(l.items) ? l.items : [];
            if (!l.createdAt) l.createdAt = nowIso();
            if (!l.updatedAt) l.updatedAt = nowIso();
            for (const it of l.items) {
              if (!it.id) it.id = uid();
              it.qty = clamp(Math.round(safeNum(it.qty, 1)), 1, 999);
              it.weightG = clamp(safeNum(it.weightG, 0), 0, 9e9);
              it.category = String(it.category || "extras");
              it.name = String(it.name || "Item");
              it.notes = String(it.notes || "");
              it.essential = !!it.essential;
              it.consumable = !!it.consumable;
              it.packed = !!it.packed;
            }
          }

          // Apply prefs + initial filter
          setUnit(prefs.unit || "oz");
          setFilter(prefs.filter || "all");

          ensureCategoryOptions();
          stampSaved();
          wire();
          render();

          // Nice first-run toast
          const isFirstRun = !localStorage.getItem(STORAGE_KEY + ".seen");
          if (isFirstRun) {
            localStorage.setItem(STORAGE_KEY + ".seen", "1");
            toast("Auto-saves locally ¬∑ Export to share", "Ctrl/‚åòE");
          }
        }

        // Light guard: if dialogs unsupported, fallback to prompt/confirm.
        function ensureDialogs() {
          const supported = typeof HTMLDialogElement !== "undefined" && dlgItem && typeof dlgItem.showModal === "function";
          if (supported) return;

          // Replace open handlers with prompt-based flows.
          ui.btnAdd.addEventListener("click", () => {
            const nm = prompt("Item name?");
            if (!nm) return;
            const w = prompt(`Weight per item (${prefs.unit})? (optional)`, "");
            const wG = w ? parseWeightToGrams(w, prefs.unit) ?? 0 : 0;
            activeList.items.unshift({
              id: uid(),
              name: nm.trim(),
              category: "extras",
              qty: 1,
              weightG: clamp(wG, 0, 9e9),
              notes: "",
              essential: false,
              consumable: false,
              packed: false,
              createdAt: nowIso(),
              updatedAt: nowIso(),
            });
            persist();
            render();
          });
        }

        init();
        ensureDialogs();
      })();
    </script>
  </body>
</html>
