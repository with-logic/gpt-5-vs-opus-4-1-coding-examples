<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <meta
      name="description"
      content="Custom QR Code Generator — generate QR codes from text or URLs with color customization and PNG download."
    />
    <title>Custom QR Code Generator</title>
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%23101828'/%3E%3Cg fill='white'%3E%3Crect x='14' y='14' width='14' height='14' rx='3'/%3E%3Crect x='36' y='14' width='14' height='14' rx='3'/%3E%3Crect x='14' y='36' width='14' height='14' rx='3'/%3E%3Crect x='30' y='30' width='6' height='6' rx='2' opacity='.9'/%3E%3Crect x='40' y='34' width='4' height='4' rx='1.6' opacity='.9'/%3E%3Crect x='34' y='42' width='4' height='4' rx='1.6' opacity='.9'/%3E%3C/g%3E%3C/svg%3E"
    />
    <style>
      :root {
        --bg: #0b1220;
        --panel: rgba(255, 255, 255, 0.06);
        --panel-2: rgba(255, 255, 255, 0.08);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.66);
        --faint: rgba(255, 255, 255, 0.14);
        --stroke: rgba(255, 255, 255, 0.12);
        --shadow: 0 18px 65px rgba(0, 0, 0, 0.55);
        --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.38);
        --radius: 18px;
        --radius-sm: 12px;
        --accent: #7c3aed;
        --accent-2: #22c55e;
        --danger: #ef4444;
        --warn: #f59e0b;
        --ok: #22c55e;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial,
          "Apple Color Emoji", "Segoe UI Emoji";
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f6f7fb;
          --panel: rgba(255, 255, 255, 0.82);
          --panel-2: rgba(255, 255, 255, 0.92);
          --text: rgba(9, 12, 19, 0.92);
          --muted: rgba(9, 12, 19, 0.62);
          --faint: rgba(9, 12, 19, 0.14);
          --stroke: rgba(9, 12, 19, 0.12);
          --shadow: 0 18px 65px rgba(17, 24, 39, 0.18);
          --shadow-soft: 0 10px 35px rgba(17, 24, 39, 0.12);
        }
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: var(--sans);
        color: var(--text);
        background: radial-gradient(1200px 800px at 15% 10%, rgba(124, 58, 237, 0.26), transparent 55%),
          radial-gradient(1100px 800px at 85% 0%, rgba(34, 197, 94, 0.22), transparent 56%),
          radial-gradient(900px 720px at 70% 90%, rgba(59, 130, 246, 0.18), transparent 58%), var(--bg);
        line-height: 1.35;
      }

      a {
        color: inherit;
      }

      .wrap {
        max-width: 1180px;
        margin: 0 auto;
        padding: 24px 20px 28px;
      }

      header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 18px;
        padding: 10px 2px 18px;
      }

      .brand {
        display: flex;
        gap: 14px;
        align-items: center;
        min-width: 260px;
      }

      .mark {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: linear-gradient(135deg, rgba(124, 58, 237, 1), rgba(34, 197, 94, 1));
        box-shadow: 0 14px 45px rgba(0, 0, 0, 0.22);
        position: relative;
        overflow: hidden;
      }

      .mark::before {
        content: "";
        position: absolute;
        inset: -40%;
        background: radial-gradient(circle at 25% 20%, rgba(255, 255, 255, 0.46), transparent 44%),
          radial-gradient(circle at 75% 70%, rgba(255, 255, 255, 0.22), transparent 48%);
        transform: rotate(12deg);
      }

      h1 {
        margin: 0;
        font-size: 20px;
        letter-spacing: -0.02em;
      }

      .sub {
        margin-top: 3px;
        font-size: 13px;
        color: var(--muted);
      }

      .top-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .chip {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: color-mix(in srgb, var(--panel) 86%, transparent);
        color: var(--muted);
        font-size: 12px;
        user-select: none;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 99px;
        background: var(--ok);
        box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.16);
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(320px, 1.3fr) minmax(320px, 0.9fr);
        gap: 16px;
        align-items: start;
      }

      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .brand {
          min-width: 0;
        }
        header {
          align-items: flex-start;
          flex-direction: column;
        }
        .top-actions {
          justify-content: flex-start;
        }
      }

      .card {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        overflow: hidden;
      }

      .card-inner {
        padding: 14px;
      }

      .preview {
        display: grid;
        place-items: center;
        padding: 16px;
        min-height: 520px;
        position: relative;
      }

      @media (max-width: 980px) {
        .preview {
          min-height: 420px;
        }
      }

      .canvas-shell {
        width: min(520px, 92%);
        aspect-ratio: 1/1;
        border-radius: calc(var(--radius) + 6px);
        padding: 16px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.07), rgba(255, 255, 255, 0.03));
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow-soft);
        position: relative;
      }

      .checker {
        position: absolute;
        inset: 16px;
        border-radius: calc(var(--radius) + 2px);
        background: linear-gradient(45deg, rgba(0, 0, 0, 0.07) 25%, transparent 25%),
          linear-gradient(-45deg, rgba(0, 0, 0, 0.07) 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, rgba(0, 0, 0, 0.07) 75%),
          linear-gradient(-45deg, transparent 75%, rgba(0, 0, 0, 0.07) 75%);
        background-size: 16px 16px;
        background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
        opacity: 0.22;
        pointer-events: none;
      }

      canvas {
        width: 100%;
        height: 100%;
        display: block;
        border-radius: calc(var(--radius) + 2px);
        image-rendering: pixelated;
        background: transparent;
        position: relative;
        z-index: 1;
      }

      .preview-meta {
        position: absolute;
        left: 16px;
        right: 16px;
        bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        color: var(--muted);
        font-size: 12px;
      }

      .kbd {
        font-family: var(--mono);
        padding: 3px 7px;
        border-radius: 8px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.05);
        color: var(--muted);
      }

      .panel {
        padding: 14px;
      }

      .panel h2 {
        margin: 0 0 10px;
        font-size: 14px;
        color: var(--muted);
        font-weight: 600;
        letter-spacing: 0.02em;
        text-transform: uppercase;
      }

      .field {
        display: grid;
        gap: 8px;
        margin-bottom: 12px;
      }

      label {
        font-size: 13px;
        color: var(--muted);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      textarea,
      input[type="text"],
      select {
        width: 100%;
        font-family: inherit;
        color: var(--text);
        background: color-mix(in srgb, var(--panel-2) 92%, transparent);
        border: 1px solid var(--stroke);
        border-radius: 14px;
        padding: 11px 12px;
        outline: none;
        transition: border-color 120ms ease, box-shadow 120ms ease;
      }

      textarea {
        resize: vertical;
        min-height: 98px;
        max-height: 220px;
      }

      textarea:focus,
      input[type="text"]:focus,
      select:focus {
        border-color: color-mix(in srgb, var(--accent) 58%, var(--stroke));
        box-shadow: 0 0 0 5px rgba(124, 58, 237, 0.2);
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .row3 {
        display: grid;
        grid-template-columns: 1.1fr 1fr 1fr;
        gap: 10px;
      }

      .inline {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .btn {
        appearance: none;
        border: 1px solid var(--stroke);
        background: color-mix(in srgb, var(--panel-2) 92%, transparent);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 14px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: -0.01em;
        transition: transform 90ms ease, border-color 120ms ease, background 120ms ease, box-shadow 120ms ease;
        user-select: none;
      }

      .btn:hover {
        border-color: color-mix(in srgb, var(--accent) 46%, var(--stroke));
        box-shadow: 0 14px 40px rgba(124, 58, 237, 0.14);
      }

      .btn:active {
        transform: translateY(1px);
      }

      .btn.primary {
        border-color: color-mix(in srgb, var(--accent) 55%, var(--stroke));
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.95), rgba(34, 197, 94, 0.62));
        box-shadow: 0 16px 55px rgba(0, 0, 0, 0.22);
      }

      .btn.primary:hover {
        box-shadow: 0 18px 62px rgba(0, 0, 0, 0.26);
      }

      .btn.ghost {
        background: transparent;
      }

      .btn[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
      }

      .hint {
        font-size: 12px;
        color: var(--muted);
      }

      .status {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.04);
        font-size: 12px;
        color: var(--muted);
        display: flex;
        gap: 10px;
        align-items: flex-start;
      }

      .status[aria-hidden="true"] {
        display: none;
      }

      .badge {
        font-family: var(--mono);
        font-size: 11px;
        padding: 2px 7px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        color: var(--muted);
      }

      .status.error {
        border-color: color-mix(in srgb, var(--danger) 40%, var(--stroke));
        background: color-mix(in srgb, rgba(239, 68, 68, 0.12) 70%, transparent);
        color: color-mix(in srgb, var(--danger) 82%, var(--text));
      }

      input[type="range"] {
        width: 100%;
        accent-color: var(--accent);
      }

      .range-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }

      .num {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
        padding: 7px 9px;
        border: 1px solid var(--stroke);
        border-radius: 12px;
        min-width: 74px;
        text-align: right;
        background: rgba(255, 255, 255, 0.04);
      }

      .color-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }

      .color {
        display: inline-flex;
        gap: 10px;
        align-items: center;
        justify-content: flex-end;
      }

      input[type="color"] {
        width: 40px;
        height: 34px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: transparent;
        padding: 0;
        cursor: pointer;
      }

      .toggle {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        cursor: pointer;
        user-select: none;
        font-size: 12px;
        color: var(--muted);
      }

      .toggle input {
        width: 42px;
        height: 24px;
        appearance: none;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.06);
        position: relative;
        outline: none;
        transition: background 140ms ease, border-color 140ms ease;
      }

      .toggle input::after {
        content: "";
        position: absolute;
        top: 3px;
        left: 3px;
        width: 18px;
        height: 18px;
        border-radius: 99px;
        background: rgba(255, 255, 255, 0.86);
        transition: transform 140ms ease;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
      }

      .toggle input:checked {
        background: color-mix(in srgb, var(--accent) 46%, rgba(255, 255, 255, 0.06));
        border-color: color-mix(in srgb, var(--accent) 46%, var(--stroke));
      }

      .toggle input:checked::after {
        transform: translateX(18px);
      }

      details {
        border: 1px solid var(--stroke);
        border-radius: var(--radius-sm);
        background: rgba(255, 255, 255, 0.03);
        overflow: hidden;
      }

      summary {
        list-style: none;
        cursor: pointer;
        padding: 10px 12px;
        font-size: 13px;
        color: var(--muted);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      summary::-webkit-details-marker {
        display: none;
      }

      .chev {
        width: 18px;
        height: 18px;
        border-radius: 9px;
        display: grid;
        place-items: center;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.03);
        transition: transform 140ms ease;
      }

      details[open] .chev {
        transform: rotate(180deg);
      }

      .advanced {
        padding: 10px 12px 12px;
      }

      footer {
        margin-top: 14px;
        color: var(--muted);
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
        padding: 0 2px;
      }

      .mono {
        font-family: var(--mono);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="brand">
          <div class="mark" aria-hidden="true"></div>
          <div>
            <h1>Custom QR Code Generator</h1>
            <div class="sub">Generate a QR code from text or a URL — customize colors, then download PNG.</div>
          </div>
        </div>
        <div class="top-actions" aria-label="Status">
          <div class="chip" title="Works fully client-side">
            <span class="dot" aria-hidden="true"></span>
            <span>Local-only rendering</span>
          </div>
          <div class="chip" title="PNG export uses your browser">
            <span class="mono" id="exportInfo">PNG</span>
            <span>Download-ready</span>
          </div>
        </div>
      </header>

      <main class="grid">
        <section class="card" aria-label="Preview">
          <div class="preview">
            <div class="canvas-shell" aria-label="QR preview">
              <div class="checker" aria-hidden="true"></div>
              <canvas id="qrCanvas" width="1024" height="1024"></canvas>
            </div>
            <div class="preview-meta">
              <div id="previewMetaLeft">Enter content to generate</div>
              <div class="kbd" title="Tip">Ctrl/⌘ + Enter</div>
            </div>
          </div>
        </section>

        <section class="card" aria-label="Controls">
          <div class="panel card-inner">
            <h2>Input</h2>
            <div class="field">
              <label for="content">
                <span>Text / URL</span>
                <span class="badge" id="charCount">0 chars</span>
              </label>
              <textarea
                id="content"
                placeholder="Paste a URL (e.g. https://...) or any text…"
                spellcheck="false"
                autocomplete="off"
                autocapitalize="off"
                rows="4"
              ></textarea>
              <div class="inline">
                <button class="btn ghost" id="exampleBtn" type="button">Use example</button>
                <button class="btn ghost" id="clearBtn" type="button">Clear</button>
              </div>
              <div class="hint">Your content stays in your browser. Nothing is uploaded.</div>
            </div>

            <h2>Style</h2>
            <div class="row">
              <div class="field">
                <label for="fg">Foreground</label>
                <div class="color-row">
                  <input id="fg" type="text" inputmode="text" autocomplete="off" spellcheck="false" />
                  <div class="color">
                    <input id="fgPicker" type="color" aria-label="Pick foreground color" />
                  </div>
                </div>
              </div>
              <div class="field">
                <label for="bg">Background</label>
                <div class="color-row">
                  <input id="bg" type="text" inputmode="text" autocomplete="off" spellcheck="false" />
                  <div class="color">
                    <input id="bgPicker" type="color" aria-label="Pick background color" />
                  </div>
                </div>
              </div>
            </div>
            <div class="inline" style="margin: 2px 0 12px">
              <label class="toggle" title="Use a transparent PNG background">
                <input id="transparent" type="checkbox" />
                Transparent background
              </label>
              <button class="btn ghost" id="swapBtn" type="button" title="Swap foreground and background">Swap</button>
            </div>

            <div class="field">
              <label for="size">Output size</label>
              <div class="range-row">
                <input id="size" type="range" min="256" max="2048" step="16" />
                <div class="num" id="sizeNum">—</div>
              </div>
            </div>

            <div class="row3">
              <div class="field">
                <label for="ecc">Error correction</label>
                <select id="ecc">
                  <option value="M" selected>Medium (M)</option>
                  <option value="L">Low (L)</option>
                  <option value="Q">Quartile (Q)</option>
                  <option value="H">High (H)</option>
                </select>
              </div>
              <div class="field">
                <label for="margin">Quiet zone</label>
                <select id="margin">
                  <option value="2">Small</option>
                  <option value="4" selected>Normal</option>
                  <option value="6">Large</option>
                  <option value="0">None</option>
                </select>
              </div>
              <div class="field">
                <label for="style">Modules</label>
                <select id="style">
                  <option value="square" selected>Square</option>
                  <option value="rounded">Rounded</option>
                  <option value="dots">Dots</option>
                </select>
              </div>
            </div>

            <details id="advancedDetails">
              <summary>
                <span>Advanced</span>
                <span class="chev" aria-hidden="true">⌄</span>
              </summary>
              <div class="advanced">
                <div class="row">
                  <div class="field">
                    <label for="eyeStyle">Finder style</label>
                    <select id="eyeStyle">
                      <option value="square" selected>Square</option>
                      <option value="rounded">Rounded</option>
                    </select>
                  </div>
                  <div class="field">
                    <label for="eyeColor">Finder color</label>
                    <div class="color-row">
                      <input id="eyeColor" type="text" inputmode="text" autocomplete="off" spellcheck="false" />
                      <div class="color">
                        <input id="eyePicker" type="color" aria-label="Pick finder color" />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="field" style="margin-bottom: 0">
                  <label class="toggle" title="Adds a subtle diagonal gradient to the modules">
                    <input id="gradientOn" type="checkbox" />
                    Foreground gradient
                  </label>
                </div>
                <div class="row" id="gradientRow" style="display: none; margin-top: 10px">
                  <div class="field">
                    <label for="fg2">Gradient end</label>
                    <div class="color-row">
                      <input id="fg2" type="text" inputmode="text" autocomplete="off" spellcheck="false" />
                      <div class="color">
                        <input id="fg2Picker" type="color" aria-label="Pick gradient end color" />
                      </div>
                    </div>
                  </div>
                  <div class="field">
                    <label for="gradientAngle">Angle</label>
                    <div class="range-row">
                      <input id="gradientAngle" type="range" min="0" max="360" step="1" />
                      <div class="num" id="gradientAngleNum">—</div>
                    </div>
                  </div>
                </div>
                <div class="hint" style="margin-top: 8px">
                  Tip: For printing or busy backgrounds, prefer higher contrast and keep a normal quiet zone.
                </div>
              </div>
            </details>

            <h2 style="margin-top: 14px">Export</h2>
            <div class="inline">
              <button class="btn primary" id="downloadBtn" type="button">Download PNG</button>
              <button class="btn" id="copyBtn" type="button">Copy PNG</button>
              <button class="btn ghost" id="shareBtn" type="button">Share…</button>
            </div>

            <div id="status" class="status" role="status" aria-live="polite" aria-hidden="true"></div>
          </div>
        </section>
      </main>

      <footer>
        <div>
          Built for speed: updates live, no server calls. Uses a tiny QR matrix library from a CDN.
        </div>
        <div class="mono">v1.0</div>
      </footer>
    </div>

    <noscript>
      <div style="padding: 16px; color: #fff; background: #111827; font-family: ui-sans-serif, system-ui">
        JavaScript is required to generate QR codes.
      </div>
    </noscript>

    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script>
      (() => {
        const $ = (sel) => document.querySelector(sel);

        const canvas = $("#qrCanvas");
        const ctx = canvas.getContext("2d");

        const el = {
          content: $("#content"),
          charCount: $("#charCount"),
          exampleBtn: $("#exampleBtn"),
          clearBtn: $("#clearBtn"),
          fg: $("#fg"),
          fgPicker: $("#fgPicker"),
          bg: $("#bg"),
          bgPicker: $("#bgPicker"),
          transparent: $("#transparent"),
          swapBtn: $("#swapBtn"),
          size: $("#size"),
          sizeNum: $("#sizeNum"),
          ecc: $("#ecc"),
          margin: $("#margin"),
          style: $("#style"),
          eyeStyle: $("#eyeStyle"),
          eyeColor: $("#eyeColor"),
          eyePicker: $("#eyePicker"),
          gradientOn: $("#gradientOn"),
          gradientRow: $("#gradientRow"),
          fg2: $("#fg2"),
          fg2Picker: $("#fg2Picker"),
          gradientAngle: $("#gradientAngle"),
          gradientAngleNum: $("#gradientAngleNum"),
          downloadBtn: $("#downloadBtn"),
          copyBtn: $("#copyBtn"),
          shareBtn: $("#shareBtn"),
          status: $("#status"),
          previewMetaLeft: $("#previewMetaLeft"),
          exportInfo: $("#exportInfo"),
        };

        const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

        function normalizeHex(input) {
          const s = String(input || "").trim();
          if (!s) return null;
          const m = s.match(/^#?([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/);
          if (!m) return null;
          let hex = m[1].toLowerCase();
          if (hex.length === 3) hex = hex.split("").map((c) => c + c).join("");
          return "#" + hex;
        }

        function setStatus(kind, msg, code) {
          if (!msg) {
            el.status.setAttribute("aria-hidden", "true");
            el.status.classList.remove("error");
            el.status.textContent = "";
            return;
          }
          el.status.setAttribute("aria-hidden", "false");
          el.status.classList.toggle("error", kind === "error");
          el.status.textContent = code ? `${msg} (${code})` : msg;
        }

        function setCharCount() {
          const len = el.content.value.length;
          el.charCount.textContent = `${len} char${len === 1 ? "" : "s"}`;
        }

        function roundedRectPath(ctx2, x, y, w, h, rTL, rTR, rBR, rBL) {
          const maxR = Math.min(w, h) / 2;
          const tl = clamp(rTL, 0, maxR);
          const tr = clamp(rTR, 0, maxR);
          const br = clamp(rBR, 0, maxR);
          const bl = clamp(rBL, 0, maxR);
          ctx2.beginPath();
          ctx2.moveTo(x + tl, y);
          ctx2.lineTo(x + w - tr, y);
          ctx2.quadraticCurveTo(x + w, y, x + w, y + tr);
          ctx2.lineTo(x + w, y + h - br);
          ctx2.quadraticCurveTo(x + w, y + h, x + w - br, y + h);
          ctx2.lineTo(x + bl, y + h);
          ctx2.quadraticCurveTo(x, y + h, x, y + h - bl);
          ctx2.lineTo(x, y + tl);
          ctx2.quadraticCurveTo(x, y, x + tl, y);
          ctx2.closePath();
        }

        function drawFinder(x, y, modulePx, fgStyle, bgStyle, finderStyle) {
          const outer = 7 * modulePx;
          const innerWhite = 5 * modulePx;
          const innerDark = 3 * modulePx;
          const rOuter = finderStyle === "rounded" ? modulePx * 2.2 : 0;
          const rInner = finderStyle === "rounded" ? modulePx * 1.4 : 0;
          const rCore = finderStyle === "rounded" ? modulePx * 1.1 : 0;

          ctx.fillStyle = fgStyle;
          if (rOuter > 0) {
            roundedRectPath(ctx, x, y, outer, outer, rOuter, rOuter, rOuter, rOuter);
            ctx.fill();
          } else {
            ctx.fillRect(x, y, outer, outer);
          }

          if (bgStyle === null) {
            ctx.clearRect(x + modulePx, y + modulePx, innerWhite, innerWhite);
          } else {
            ctx.fillStyle = bgStyle;
            if (rInner > 0) {
              roundedRectPath(
                ctx,
                x + modulePx,
                y + modulePx,
                innerWhite,
                innerWhite,
                rInner,
                rInner,
                rInner,
                rInner
              );
              ctx.fill();
            } else {
              ctx.fillRect(x + modulePx, y + modulePx, innerWhite, innerWhite);
            }
          }

          ctx.fillStyle = fgStyle;
          if (rCore > 0) {
            roundedRectPath(
              ctx,
              x + 2 * modulePx,
              y + 2 * modulePx,
              innerDark,
              innerDark,
              rCore,
              rCore,
              rCore,
              rCore
            );
            ctx.fill();
          } else {
            ctx.fillRect(x + 2 * modulePx, y + 2 * modulePx, innerDark, innerDark);
          }
        }

        function isInFinder(r, c, count) {
          const inTL = r < 7 && c < 7;
          const inTR = r < 7 && c >= count - 7;
          const inBL = r >= count - 7 && c < 7;
          return inTL || inTR || inBL;
        }

        function updateGradientVisibility() {
          const on = !!el.gradientOn.checked;
          el.gradientRow.style.display = on ? "" : "none";
        }

        function syncColorInputs(textInput, picker) {
          const hex = normalizeHex(textInput.value);
          if (hex) picker.value = hex;
        }

        function setColorPair(textInput, picker, hex) {
          textInput.value = hex;
          picker.value = hex;
        }

        function safeFilenameFromText(text) {
          const base = String(text || "")
            .trim()
            .replace(/^https?:\/\//i, "")
            .replace(/[^\p{L}\p{N}]+/gu, "-")
            .replace(/-+/g, "-")
            .replace(/^-|-$/g, "")
            .slice(0, 42);
          return (base || "qr-code") + ".png";
        }

        function getFillStyle(pixelSize, fg1, fg2, angleDeg) {
          if (!el.gradientOn.checked) return fg1;
          const rad = ((Number(angleDeg) || 0) * Math.PI) / 180;
          const cx = pixelSize / 2;
          const cy = pixelSize / 2;
          const dx = Math.cos(rad) * pixelSize * 0.75;
          const dy = Math.sin(rad) * pixelSize * 0.75;
          const g = ctx.createLinearGradient(cx - dx, cy - dy, cx + dx, cy + dy);
          g.addColorStop(0, fg1);
          g.addColorStop(1, fg2);
          return g;
        }

	        function render() {
	          const content = el.content.value.trim();
	          setCharCount();

          const fg = normalizeHex(el.fg.value) || "#111827";
          const bg = normalizeHex(el.bg.value) || "#ffffff";
          const eyeColor = normalizeHex(el.eyeColor.value) || fg;
          const fg2 = normalizeHex(el.fg2.value) || "#22c55e";

          const ecc = String(el.ecc.value || "M").toUpperCase();
          const quiet = clamp(parseInt(el.margin.value, 10) || 4, 0, 12);
          const style = String(el.style.value || "square");
          const eyeStyle = String(el.eyeStyle.value || "square");

          const targetSize = clamp(parseInt(el.size.value, 10) || 768, 256, 2048);
          const angle = clamp(parseInt(el.gradientAngle.value, 10) || 45, 0, 360);

          el.sizeNum.textContent = `${targetSize}px`;
          el.gradientAngleNum.textContent = `${angle}°`;

	          if (!content) {
	            ctx.clearRect(0, 0, canvas.width, canvas.height);
	            el.previewMetaLeft.textContent = "Enter content to generate";
	            setStatus(null, null);
	            el.downloadBtn.disabled = true;
	            el.copyBtn.disabled = true;
	            el.shareBtn.disabled = true;
	            return;
	          }

	          if (typeof window.qrcode !== "function") {
	            ctx.clearRect(0, 0, canvas.width, canvas.height);
	            el.previewMetaLeft.textContent = "QR library not loaded";
	            setStatus(
	              "error",
	              "QR generator library failed to load. Check your connection or refresh the page.",
	              "LIB_FAIL"
	            );
	            el.downloadBtn.disabled = true;
	            el.copyBtn.disabled = true;
	            el.shareBtn.disabled = true;
	            return;
	          }

	          let qr;
	          try {
	            // qrcode-generator provides a global `qrcode` function.
	            qr = window.qrcode(0, ecc);
	            qr.addData(content);
	            qr.make();
	          } catch (e) {
	            ctx.clearRect(0, 0, canvas.width, canvas.height);
	            el.previewMetaLeft.textContent = "Could not generate QR";
	            const msg = String((e && e.message) || "");
	            const friendly = msg.toLowerCase().includes("overflow")
	              ? "Content is too long for the selected error correction level."
	              : "Could not generate a QR code with the current settings.";
	            setStatus("error", friendly, "GEN_FAIL");
	            el.downloadBtn.disabled = true;
	            el.copyBtn.disabled = true;
	            el.shareBtn.disabled = true;
	            return;
	          }

          const count = qr.getModuleCount();
          const totalModules = count + quiet * 2;

          const dpr = clamp(window.devicePixelRatio || 1, 1, 3);
          const idealPixels = Math.round(targetSize * dpr);
          const modulePx = Math.max(1, Math.floor(idealPixels / totalModules));
          const pixelSize = modulePx * totalModules;

          canvas.width = pixelSize;
          canvas.height = pixelSize;

          const bgStyle = el.transparent.checked ? null : bg;
          if (bgStyle === null) {
            ctx.clearRect(0, 0, pixelSize, pixelSize);
          } else {
            ctx.fillStyle = bgStyle;
            ctx.fillRect(0, 0, pixelSize, pixelSize);
          }

          const fillStyle = getFillStyle(pixelSize, fg, fg2, angle);
          const eyeFillStyle = getFillStyle(pixelSize, eyeColor, fg2, angle);

          const baseRadius = style === "rounded" ? modulePx * 0.55 : 0;
          const dotRadius = modulePx * 0.44;

          const drawModule = (r, c) => {
            const x = (c + quiet) * modulePx;
            const y = (r + quiet) * modulePx;
            if (style === "square") {
              ctx.fillRect(x, y, modulePx, modulePx);
              return;
            }
            if (style === "dots") {
              ctx.beginPath();
              ctx.arc(x + modulePx / 2, y + modulePx / 2, dotRadius, 0, Math.PI * 2);
              ctx.fill();
              return;
            }

            const up = r > 0 ? qr.isDark(r - 1, c) : false;
            const down = r < count - 1 ? qr.isDark(r + 1, c) : false;
            const left = c > 0 ? qr.isDark(r, c - 1) : false;
            const right = c < count - 1 ? qr.isDark(r, c + 1) : false;

            const tl = !up && !left ? baseRadius : 0;
            const tr = !up && !right ? baseRadius : 0;
            const br = !down && !right ? baseRadius : 0;
            const bl = !down && !left ? baseRadius : 0;

            roundedRectPath(ctx, x, y, modulePx, modulePx, tl, tr, br, bl);
            ctx.fill();
          };

          ctx.fillStyle = fillStyle;
          for (let r = 0; r < count; r++) {
            for (let c = 0; c < count; c++) {
              if (!qr.isDark(r, c)) continue;
              if (isInFinder(r, c, count)) continue;
              drawModule(r, c);
            }
          }

	          // Finder patterns (top-left, top-right, bottom-left)
	          ctx.save();
	          const finderFg = eyeFillStyle;
	          const finderBg = bgStyle;
	          const top = quiet * modulePx;
	          const left = quiet * modulePx;
          drawFinder(left, top, modulePx, finderFg, finderBg, eyeStyle);
          drawFinder((quiet + (count - 7)) * modulePx, top, modulePx, finderFg, finderBg, eyeStyle);
          drawFinder(left, (quiet + (count - 7)) * modulePx, modulePx, finderFg, finderBg, eyeStyle);
          ctx.restore();

          const displaySize = Math.round(pixelSize / dpr);
          el.previewMetaLeft.textContent = `${displaySize}px • ${count}×${count} • ECC ${ecc}`;

          el.downloadBtn.disabled = false;
          el.copyBtn.disabled = !("clipboard" in navigator) || typeof window.ClipboardItem === "undefined";
          el.shareBtn.disabled = !navigator.share;

          setStatus(null, null);
        }

        let raf = 0;
        function scheduleRender() {
          cancelAnimationFrame(raf);
          raf = requestAnimationFrame(render);
        }

        async function downloadPng() {
          setStatus(null, null);
          const content = el.content.value.trim();
          if (!content) return;
          const name = safeFilenameFromText(content);
          canvas.toBlob((blob) => {
            if (!blob) {
              setStatus("error", "Unable to export PNG from canvas.", "EXPORT_FAIL");
              return;
            }
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 4000);
          }, "image/png");
        }

        async function copyPng() {
          setStatus(null, null);
          const content = el.content.value.trim();
          if (!content) return;
          if (!("clipboard" in navigator) || typeof window.ClipboardItem === "undefined") {
            setStatus("error", "Copy is not supported in this browser.", "NO_CLIPBOARD");
            return;
          }
          const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
          if (!blob) {
            setStatus("error", "Unable to export PNG for copying.", "EXPORT_FAIL");
            return;
          }
          try {
            await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]);
            setStatus(null, "Copied PNG to clipboard.");
          } catch (e) {
            setStatus("error", "Clipboard permission denied or unavailable.", "CLIP_FAIL");
          }
        }

        async function sharePng() {
          setStatus(null, null);
          const content = el.content.value.trim();
          if (!content) return;
          if (!navigator.share) {
            setStatus("error", "Sharing is not supported in this browser.", "NO_SHARE");
            return;
          }

          const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
          if (!blob) {
            setStatus("error", "Unable to export PNG for sharing.", "EXPORT_FAIL");
            return;
          }
          const file = new File([blob], safeFilenameFromText(content), { type: "image/png" });

          try {
            if (navigator.canShare && !navigator.canShare({ files: [file] })) {
              await navigator.share({ title: "QR Code", text: content });
              return;
            }
            await navigator.share({ title: "QR Code", text: content, files: [file] });
          } catch (e) {
            // User canceled; keep quiet.
          }
        }

        function loadSettings() {
          try {
            const raw = localStorage.getItem("custom-qr-settings:v1");
            if (!raw) return;
            const s = JSON.parse(raw);
            if (s && typeof s === "object") {
              if (typeof s.fg === "string") el.fg.value = s.fg;
              if (typeof s.bg === "string") el.bg.value = s.bg;
              if (typeof s.eyeColor === "string") el.eyeColor.value = s.eyeColor;
              if (typeof s.fg2 === "string") el.fg2.value = s.fg2;
              if (typeof s.transparent === "boolean") el.transparent.checked = s.transparent;
              if (typeof s.size === "number") el.size.value = String(clamp(s.size, 256, 2048));
              if (typeof s.ecc === "string") el.ecc.value = s.ecc;
              if (typeof s.margin === "string") el.margin.value = s.margin;
              if (typeof s.style === "string") el.style.value = s.style;
              if (typeof s.eyeStyle === "string") el.eyeStyle.value = s.eyeStyle;
              if (typeof s.gradientOn === "boolean") el.gradientOn.checked = s.gradientOn;
              if (typeof s.gradientAngle === "number") el.gradientAngle.value = String(clamp(s.gradientAngle, 0, 360));
            }
          } catch {
            // ignore
          }
        }

        function saveSettings() {
          try {
            const s = {
              fg: normalizeHex(el.fg.value) || el.fg.value,
              bg: normalizeHex(el.bg.value) || el.bg.value,
              eyeColor: normalizeHex(el.eyeColor.value) || el.eyeColor.value,
              fg2: normalizeHex(el.fg2.value) || el.fg2.value,
              transparent: !!el.transparent.checked,
              size: parseInt(el.size.value, 10) || 768,
              ecc: el.ecc.value,
              margin: el.margin.value,
              style: el.style.value,
              eyeStyle: el.eyeStyle.value,
              gradientOn: !!el.gradientOn.checked,
              gradientAngle: parseInt(el.gradientAngle.value, 10) || 45,
            };
            localStorage.setItem("custom-qr-settings:v1", JSON.stringify(s));
          } catch {
            // ignore
          }
        }

        function initDefaults() {
          el.size.value = "768";
          setColorPair(el.fg, el.fgPicker, "#111827");
          setColorPair(el.bg, el.bgPicker, "#ffffff");
          setColorPair(el.eyeColor, el.eyePicker, "#111827");
          setColorPair(el.fg2, el.fg2Picker, "#22c55e");
          el.gradientAngle.value = "45";
          el.exportInfo.textContent = "PNG";
        }

        function bind() {
          const onAnyChange = () => {
            syncColorInputs(el.fg, el.fgPicker);
            syncColorInputs(el.bg, el.bgPicker);
            syncColorInputs(el.eyeColor, el.eyePicker);
            syncColorInputs(el.fg2, el.fg2Picker);
            updateGradientVisibility();
            saveSettings();
            scheduleRender();
          };

          el.content.addEventListener("input", () => {
            setCharCount();
            scheduleRender();
          });

          el.content.addEventListener("keydown", (e) => {
            const meta = e.metaKey || e.ctrlKey;
            if (meta && e.key === "Enter") {
              e.preventDefault();
              downloadPng();
            }
          });

          el.exampleBtn.addEventListener("click", () => {
            el.content.value = "https://example.com?source=custom-qr";
            el.content.focus();
            onAnyChange();
          });

          el.clearBtn.addEventListener("click", () => {
            el.content.value = "";
            el.content.focus();
            setStatus(null, null);
            scheduleRender();
          });

          el.swapBtn.addEventListener("click", () => {
            const fg = el.fg.value;
            el.fg.value = el.bg.value;
            el.bg.value = fg;
            syncColorInputs(el.fg, el.fgPicker);
            syncColorInputs(el.bg, el.bgPicker);
            onAnyChange();
          });

          const colorBind = (textEl, pickEl, onPick) => {
            textEl.addEventListener("change", onAnyChange);
            textEl.addEventListener("input", () => {
              const hex = normalizeHex(textEl.value);
              if (hex) pickEl.value = hex;
              scheduleRender();
            });
            pickEl.addEventListener("input", () => {
              textEl.value = pickEl.value;
              if (onPick) onPick();
              onAnyChange();
            });
          };

          colorBind(el.fg, el.fgPicker);
          colorBind(el.bg, el.bgPicker);
          colorBind(el.eyeColor, el.eyePicker);
          colorBind(el.fg2, el.fg2Picker, () => {
            if (!el.gradientOn.checked) el.gradientOn.checked = true;
          });

          [
            el.transparent,
            el.size,
            el.ecc,
            el.margin,
            el.style,
            el.eyeStyle,
            el.gradientOn,
            el.gradientAngle,
          ].forEach((node) => node.addEventListener("input", onAnyChange));
          [el.ecc, el.margin, el.style, el.eyeStyle].forEach((node) => node.addEventListener("change", onAnyChange));

          el.downloadBtn.addEventListener("click", downloadPng);
          el.copyBtn.addEventListener("click", copyPng);
          el.shareBtn.addEventListener("click", sharePng);

          window.addEventListener("resize", () => scheduleRender());
        }

        // Boot
        initDefaults();
        loadSettings();
        updateGradientVisibility();

        // Keep pickers in sync with any loaded settings.
        syncColorInputs(el.fg, el.fgPicker);
        syncColorInputs(el.bg, el.bgPicker);
        syncColorInputs(el.eyeColor, el.eyePicker);
        syncColorInputs(el.fg2, el.fg2Picker);

        bind();
        scheduleRender();
      })();
    </script>
  </body>
</html>
