<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="color-scheme" content="dark light" />
    <title>Interactive World Clock</title>
    <style>
      :root {
        --bg0: #070a12;
        --bg1: #0b1020;
        --panel: rgba(255, 255, 255, 0.06);
        --panel2: rgba(255, 255, 255, 0.085);
        --stroke: rgba(255, 255, 255, 0.12);
        --stroke2: rgba(255, 255, 255, 0.18);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.68);
        --muted2: rgba(255, 255, 255, 0.55);
        --shadow: rgba(0, 0, 0, 0.45);
        --focus: rgba(124, 92, 255, 0.65);
        --ok: rgba(69, 255, 180, 0.9);
        --warn: rgba(255, 210, 94, 0.9);
        --bad: rgba(255, 98, 122, 0.95);
        --radius: 18px;
        --radius2: 22px;
        --max: 1120px;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          "Apple Color Emoji", "Segoe UI Emoji";
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: var(--sans);
        color: var(--text);
        background: radial-gradient(1100px 680px at 10% 0%, rgba(124, 92, 255, 0.22), transparent 60%),
          radial-gradient(900px 640px at 100% 10%, rgba(64, 214, 255, 0.18), transparent 55%),
          radial-gradient(900px 720px at 55% 105%, rgba(255, 146, 92, 0.13), transparent 60%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        overflow-x: hidden;
      }

      a {
        color: inherit;
      }

      .app {
        min-height: 100%;
        padding: 24px 16px 42px;
      }

      .topbar {
        width: min(var(--max), 100%);
        margin: 0 auto;
        display: grid;
        gap: 14px;
      }

      .brand {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 18px;
      }

      .title {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
      }
      .title h1 {
        margin: 0;
        font-size: clamp(22px, 2.6vw, 30px);
        letter-spacing: -0.02em;
        line-height: 1.1;
      }
      .title p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
        line-height: 1.3;
      }

      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: flex-end;
        flex-wrap: wrap;
      }

      .pill {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 999px;
        padding: 10px 12px;
        display: flex;
        gap: 10px;
        align-items: center;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 16px 42px var(--shadow);
      }

      .pill label {
        color: var(--muted);
        font-size: 13px;
        white-space: nowrap;
      }

      .toggle {
        position: relative;
        width: 56px;
        height: 30px;
        border-radius: 999px;
        border: 1px solid var(--stroke2);
        background: rgba(255, 255, 255, 0.06);
        display: inline-flex;
        align-items: center;
        padding: 2px;
        cursor: pointer;
        user-select: none;
      }
      .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
        position: absolute;
      }
      .knob {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.35));
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.55);
        transform: translateX(0);
        transition: transform 220ms cubic-bezier(0.2, 0.9, 0.2, 1);
      }
      .toggle[data-on="true"] .knob {
        transform: translateX(26px);
      }

      .btn {
        border: 1px solid var(--stroke2);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 999px;
        font-size: 13px;
        cursor: pointer;
        transition: transform 140ms ease, background 140ms ease, border-color 140ms ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.11);
        border-color: rgba(255, 255, 255, 0.26);
      }
      .btn:active {
        transform: translateY(0);
      }
      .btn:focus-visible,
      .toggle:focus-visible,
      .input:focus-within,
      .card:focus-within {
        outline: 2px solid var(--focus);
        outline-offset: 2px;
      }
      .btn.secondary {
        background: rgba(255, 255, 255, 0.06);
      }

      .panel {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.07), rgba(255, 255, 255, 0.05));
        border: 1px solid var(--stroke);
        border-radius: var(--radius2);
        padding: 14px;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 18px 50px var(--shadow);
      }

      .addRow {
        display: grid;
        grid-template-columns: 1.6fr auto;
        gap: 12px;
        align-items: start;
      }
      @media (max-width: 720px) {
        .addRow {
          grid-template-columns: 1fr;
        }
      }

      .input {
        position: relative;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: rgba(0, 0, 0, 0.14);
        padding: 10px 10px 10px 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        min-height: 46px;
      }

      .input .spark {
        width: 24px;
        height: 24px;
        flex: none;
        opacity: 0.92;
        filter: drop-shadow(0 10px 18px rgba(0, 0, 0, 0.42));
      }

      .input input {
        width: 100%;
        border: 0;
        outline: none;
        background: transparent;
        color: var(--text);
        font-size: 14px;
        padding: 0;
      }
      .input input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .hint {
        color: var(--muted2);
        font-size: 12px;
        margin-top: 8px;
        line-height: 1.3;
      }
      .hint kbd {
        font-family: var(--mono);
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.14);
      }

      .suggest {
        position: absolute;
        left: 10px;
        right: 10px;
        top: calc(100% + 8px);
        z-index: 50;
        background: rgba(10, 13, 26, 0.82);
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 22px 70px rgba(0, 0, 0, 0.62);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        display: none;
      }
      .suggest[data-open="true"] {
        display: block;
      }
      .suggest .row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        padding: 10px 12px;
        cursor: pointer;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }
      .suggest .row:first-child {
        border-top: 0;
      }
      .suggest .row:hover,
      .suggest .row[aria-selected="true"] {
        background: rgba(255, 255, 255, 0.08);
      }
      .suggest .name {
        font-size: 13px;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .suggest .meta {
        font-size: 12px;
        color: var(--muted2);
        white-space: nowrap;
      }

      .quick {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: flex-end;
        align-content: start;
      }
      @media (max-width: 720px) {
        .quick {
          justify-content: flex-start;
        }
      }
      .chip {
        border-radius: 999px;
        padding: 8px 10px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.9);
        font-size: 12px;
        cursor: pointer;
        transition: background 140ms ease, transform 140ms ease;
      }
      .chip:hover {
        background: rgba(255, 255, 255, 0.09);
        transform: translateY(-1px);
      }
      .chip[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .main {
        width: min(var(--max), 100%);
        margin: 16px auto 0;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 14px;
      }
      @media (max-width: 1020px) {
        .grid {
          gap: 12px;
        }
      }
      @media (max-width: 860px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        grid-column: span 6;
        position: relative;
        border-radius: var(--radius2);
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        box-shadow: 0 22px 70px rgba(0, 0, 0, 0.52);
        isolation: isolate;
        transform: translateZ(0);
        transition: transform 170ms ease, border-color 170ms ease;
      }
      .card:hover {
        transform: translateY(-2px);
        border-color: rgba(255, 255, 255, 0.22);
      }
      @media (max-width: 860px) {
        .card {
          grid-column: 1 / -1;
        }
      }

      .card::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(700px 260px at 20% 0%, rgba(255, 255, 255, 0.12), transparent 45%),
          radial-gradient(540px 340px at 80% 20%, rgba(255, 255, 255, 0.08), transparent 55%),
          linear-gradient(180deg, rgba(0, 0, 0, 0.18), rgba(0, 0, 0, 0.46));
        opacity: 0.9;
        z-index: -1;
      }

      .card::after {
        content: "";
        position: absolute;
        inset: 0;
        z-index: -2;
        background: radial-gradient(900px 520px at 20% 0%, var(--g0), transparent 60%),
          radial-gradient(800px 520px at 90% 20%, var(--g1), transparent 60%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.03));
        filter: saturate(1.1);
      }

      .card[data-tod="morning"] {
        --g0: rgba(255, 178, 108, 0.5);
        --g1: rgba(255, 98, 122, 0.24);
      }
      .card[data-tod="afternoon"] {
        --g0: rgba(96, 221, 255, 0.48);
        --g1: rgba(124, 92, 255, 0.22);
      }
      .card[data-tod="evening"] {
        --g0: rgba(255, 146, 92, 0.36);
        --g1: rgba(176, 92, 255, 0.3);
      }
      .card[data-tod="night"] {
        --g0: rgba(92, 124, 255, 0.26);
        --g1: rgba(64, 214, 255, 0.16);
      }

      .cardInner {
        padding: 14px 14px 16px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 14px;
        align-items: center;
      }

      .cityTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        min-width: 0;
      }
      .cityLeft {
        display: flex;
        gap: 10px;
        align-items: center;
        min-width: 0;
      }
      .badge {
        width: 36px;
        height: 36px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.14);
        display: grid;
        place-items: center;
        box-shadow: 0 14px 32px rgba(0, 0, 0, 0.35);
        flex: none;
      }
      .badge svg {
        width: 22px;
        height: 22px;
        opacity: 0.92;
      }

      .cityName {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
      }
      .cityName .name {
        font-weight: 650;
        letter-spacing: -0.01em;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .cityName .sub {
        font-size: 12px;
        color: var(--muted2);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .iconBtn {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.88);
        display: grid;
        place-items: center;
        cursor: pointer;
        transition: background 140ms ease, transform 140ms ease, border-color 140ms ease;
      }
      .iconBtn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.22);
        transform: translateY(-1px);
      }
      .iconBtn:active {
        transform: translateY(0);
      }
      .iconBtn svg {
        width: 18px;
        height: 18px;
      }

      .timeBlock {
        display: grid;
        gap: 8px;
        margin-top: 12px;
      }
      .bigTime {
        font-family: var(--mono);
        font-size: clamp(30px, 3.8vw, 44px);
        line-height: 1;
        letter-spacing: -0.03em;
        text-shadow: 0 18px 50px rgba(0, 0, 0, 0.55);
      }
      .metaRow {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: baseline;
        color: var(--muted);
        font-size: 12px;
      }
      .tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.78);
      }
      .tag strong {
        font-weight: 650;
        color: rgba(255, 255, 255, 0.92);
      }

      .clock {
        width: 122px;
        height: 122px;
        border-radius: 999px;
        position: relative;
        display: grid;
        place-items: center;
        background:
          radial-gradient(circle at 35% 25%, rgba(255, 255, 255, 0.22), transparent 55%),
          radial-gradient(circle at 65% 70%, rgba(255, 255, 255, 0.08), transparent 60%),
          rgba(0, 0, 0, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08), 0 18px 55px rgba(0, 0, 0, 0.45);
        overflow: hidden;
      }
      .clock svg {
        width: 100%;
        height: 100%;
      }
      .clock .dot {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.6);
      }

      .empty {
        grid-column: 1 / -1;
        border-radius: var(--radius2);
        border: 1px dashed rgba(255, 255, 255, 0.22);
        background: rgba(255, 255, 255, 0.035);
        padding: 18px;
        color: var(--muted);
      }
      .empty strong {
        color: rgba(255, 255, 255, 0.92);
      }

      .toast {
        position: fixed;
        left: 50%;
        bottom: 16px;
        transform: translateX(-50%);
        background: rgba(10, 13, 26, 0.78);
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 14px;
        padding: 10px 12px;
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        box-shadow: 0 18px 70px rgba(0, 0, 0, 0.6);
        max-width: min(560px, calc(100% - 20px));
        display: none;
        z-index: 80;
      }
      .toast[data-open="true"] {
        display: block;
        animation: toastIn 240ms cubic-bezier(0.2, 0.9, 0.2, 1);
      }
      @keyframes toastIn {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      .toast .t {
        color: rgba(255, 255, 255, 0.9);
        font-size: 13px;
        line-height: 1.35;
      }
      .toast .t code {
        font-family: var(--mono);
        font-size: 12px;
        padding: 1px 6px;
        border-radius: 9px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.07);
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          scroll-behavior: auto !important;
          transition: none !important;
          animation: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="brand">
          <div class="title">
            <h1>Interactive World Clock</h1>
            <p>Track multiple cities at a glance—colors shift with local morning, afternoon, evening, and night.</p>
          </div>

          <div class="controls" aria-label="Clock controls">
            <div class="pill" role="group" aria-label="Time format">
              <label for="fmtToggle"><span id="fmtLabel">24h</span> format</label>
              <div class="toggle" id="fmtToggle" tabindex="0" role="switch" aria-checked="false" data-on="false">
                <input id="fmtToggleInput" type="checkbox" aria-hidden="true" />
                <div class="knob" aria-hidden="true"></div>
              </div>
            </div>
            <button class="btn secondary" id="resetBtn" type="button" title="Reset to defaults">Reset</button>
          </div>
        </div>

        <section class="panel" aria-label="Add city">
          <div class="addRow">
            <div>
              <div class="input" id="searchWrap" role="combobox" aria-expanded="false" aria-owns="suggestList" aria-haspopup="listbox">
                <svg class="spark" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path
                    d="M12 2c3.8 3.3 5.7 6.2 5.7 8.7 0 3.3-2.2 5.3-5.7 5.3S6.3 14 6.3 10.7C6.3 8.2 8.2 5.3 12 2Z"
                    stroke="rgba(255,255,255,.8)"
                    stroke-width="1.4"
                  />
                  <path d="M12 16v6" stroke="rgba(255,255,255,.7)" stroke-width="1.4" stroke-linecap="round" />
                  <path
                    d="M7.3 20.3c1.4-1.3 2.9-2 4.7-2s3.3.7 4.7 2"
                    stroke="rgba(255,255,255,.55)"
                    stroke-width="1.2"
                    stroke-linecap="round"
                  />
                </svg>
                <input
                  id="searchInput"
                  type="text"
                  inputmode="search"
                  autocomplete="off"
                  spellcheck="false"
                  placeholder="Add a city (e.g., Tokyo) or a timezone (e.g., Europe/Paris)"
                  aria-autocomplete="list"
                  aria-controls="suggestList"
                  aria-activedescendant=""
                />
                <button class="btn" id="addBtn" type="button" title="Add selected city">
                  Add
                </button>

                <div class="suggest" id="suggest" data-open="false">
                  <div id="suggestList" role="listbox" aria-label="City suggestions"></div>
                </div>
              </div>
              <div class="hint">
                Tips: <kbd>Enter</kbd> to add • <kbd>↑</kbd>/<kbd>↓</kbd> to navigate • <kbd>Esc</kbd> to close
              </div>
            </div>

            <div class="quick" aria-label="Quick add cities">
              <button class="chip" type="button" data-quick="America/New_York">New York</button>
              <button class="chip" type="button" data-quick="Europe/London">London</button>
              <button class="chip" type="button" data-quick="Europe/Paris">Paris</button>
              <button class="chip" type="button" data-quick="Asia/Tokyo">Tokyo</button>
              <button class="chip" type="button" data-quick="Asia/Singapore">Singapore</button>
              <button class="chip" type="button" data-quick="Australia/Sydney">Sydney</button>
              <button class="chip" type="button" data-quick="UTC">UTC</button>
            </div>
          </div>
        </section>
      </header>

      <main class="main">
        <section class="grid" id="grid" aria-label="City clocks"></section>
      </main>

      <div class="toast" id="toast" role="status" aria-live="polite" data-open="false">
        <div class="t" id="toastText"></div>
      </div>
    </div>

    <script>
      (() => {
        "use strict";

        const STORAGE_KEY = "iwc:v1";

        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const ICONS = {
          morning: `
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 16.5h16" stroke="rgba(255,255,255,.75)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M7 16.5c1.8-3.4 3.9-5.1 5-5.1s3.2 1.7 5 5.1" stroke="rgba(255,255,255,.85)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M12 4.2v3" stroke="rgba(255,255,255,.72)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M6.6 6.7l2 2" stroke="rgba(255,255,255,.58)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M17.4 6.7l-2 2" stroke="rgba(255,255,255,.58)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M4.6 11.1h2.8" stroke="rgba(255,255,255,.52)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M16.6 11.1h2.8" stroke="rgba(255,255,255,.52)" stroke-width="1.5" stroke-linecap="round"/>
            </svg>`,
          afternoon: `
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 6.4a5.6 5.6 0 1 0 0 11.2a5.6 5.6 0 0 0 0-11.2Z" stroke="rgba(255,255,255,.86)" stroke-width="1.5"/>
              <path d="M12 2.2v2.6" stroke="rgba(255,255,255,.64)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M12 19.2v2.6" stroke="rgba(255,255,255,.64)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M4.2 12h2.6" stroke="rgba(255,255,255,.55)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M17.2 12h2.6" stroke="rgba(255,255,255,.55)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M6.2 6.2l1.8 1.8" stroke="rgba(255,255,255,.55)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M16 16l1.8 1.8" stroke="rgba(255,255,255,.55)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M6.2 17.8 8 16" stroke="rgba(255,255,255,.45)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M16 8 17.8 6.2" stroke="rgba(255,255,255,.45)" stroke-width="1.5" stroke-linecap="round"/>
            </svg>`,
          evening: `
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 16.5h16" stroke="rgba(255,255,255,.75)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M7 16.5c1.8-3.4 3.9-5.1 5-5.1s3.2 1.7 5 5.1" stroke="rgba(255,255,255,.85)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M12 7.2v-3" stroke="rgba(255,255,255,.62)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M15.4 5.6l-2 2" stroke="rgba(255,255,255,.55)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M8.6 5.6l2 2" stroke="rgba(255,255,255,.55)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M18.2 8.9h-2.8" stroke="rgba(255,255,255,.45)" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M8.6 8.9H5.8" stroke="rgba(255,255,255,.45)" stroke-width="1.5" stroke-linecap="round"/>
            </svg>`,
          night: `
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M14.7 3.2c-3.3.8-5.7 3.8-5.7 7.3 0 4.1 3.3 7.4 7.4 7.4 1.8 0 3.4-.6 4.7-1.6-1.1 2.9-3.9 4.9-7.2 4.9-4.2 0-7.6-3.4-7.6-7.6 0-3.9 2.9-7 6.6-7.8Z" fill="rgba(255,255,255,.86)"/>
              <path d="M6.3 6.6l.5 1.4 1.4.5-1.4.5-.5 1.4-.5-1.4-1.4-.5 1.4-.5.5-1.4Z" fill="rgba(255,255,255,.55)"/>
              <path d="M18.2 7.1l.4 1.1 1.1.4-1.1.4-.4 1.1-.4-1.1-1.1-.4 1.1-.4.4-1.1Z" fill="rgba(255,255,255,.45)"/>
            </svg>`,
          x: `
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M7 7l10 10" stroke="rgba(255,255,255,.82)" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M17 7 7 17" stroke="rgba(255,255,255,.82)" stroke-width="1.6" stroke-linecap="round"/>
            </svg>`,
        };

        const CITY_CATALOG = [
          { name: "Local Time", tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC", note: "Your device" },
          { name: "UTC", tz: "UTC", note: "Coordinated Universal Time" },
          { name: "New York", tz: "America/New_York", note: "United States" },
          { name: "Los Angeles", tz: "America/Los_Angeles", note: "United States" },
          { name: "Chicago", tz: "America/Chicago", note: "United States" },
          { name: "Toronto", tz: "America/Toronto", note: "Canada" },
          { name: "Vancouver", tz: "America/Vancouver", note: "Canada" },
          { name: "Mexico City", tz: "America/Mexico_City", note: "Mexico" },
          { name: "São Paulo", tz: "America/Sao_Paulo", note: "Brazil" },
          { name: "Buenos Aires", tz: "America/Argentina/Buenos_Aires", note: "Argentina" },
          { name: "Santiago", tz: "America/Santiago", note: "Chile" },
          { name: "Bogotá", tz: "America/Bogota", note: "Colombia" },
          { name: "Lima", tz: "America/Lima", note: "Peru" },
          { name: "Honolulu", tz: "Pacific/Honolulu", note: "Hawaii" },
          { name: "Anchorage", tz: "America/Anchorage", note: "Alaska" },
          { name: "London", tz: "Europe/London", note: "United Kingdom" },
          { name: "Dublin", tz: "Europe/Dublin", note: "Ireland" },
          { name: "Lisbon", tz: "Europe/Lisbon", note: "Portugal" },
          { name: "Paris", tz: "Europe/Paris", note: "France" },
          { name: "Amsterdam", tz: "Europe/Amsterdam", note: "Netherlands" },
          { name: "Berlin", tz: "Europe/Berlin", note: "Germany" },
          { name: "Zurich", tz: "Europe/Zurich", note: "Switzerland" },
          { name: "Rome", tz: "Europe/Rome", note: "Italy" },
          { name: "Madrid", tz: "Europe/Madrid", note: "Spain" },
          { name: "Stockholm", tz: "Europe/Stockholm", note: "Sweden" },
          { name: "Oslo", tz: "Europe/Oslo", note: "Norway" },
          { name: "Copenhagen", tz: "Europe/Copenhagen", note: "Denmark" },
          { name: "Vienna", tz: "Europe/Vienna", note: "Austria" },
          { name: "Prague", tz: "Europe/Prague", note: "Czechia" },
          { name: "Warsaw", tz: "Europe/Warsaw", note: "Poland" },
          { name: "Athens", tz: "Europe/Athens", note: "Greece" },
          { name: "Istanbul", tz: "Europe/Istanbul", note: "Türkiye" },
          { name: "Kyiv", tz: "Europe/Kyiv", note: "Ukraine" },
          { name: "Moscow", tz: "Europe/Moscow", note: "Russia" },
          { name: "Cairo", tz: "Africa/Cairo", note: "Egypt" },
          { name: "Nairobi", tz: "Africa/Nairobi", note: "Kenya" },
          { name: "Johannesburg", tz: "Africa/Johannesburg", note: "South Africa" },
          { name: "Lagos", tz: "Africa/Lagos", note: "Nigeria" },
          { name: "Casablanca", tz: "Africa/Casablanca", note: "Morocco" },
          { name: "Dubai", tz: "Asia/Dubai", note: "UAE" },
          { name: "Riyadh", tz: "Asia/Riyadh", note: "Saudi Arabia" },
          { name: "Tehran", tz: "Asia/Tehran", note: "Iran" },
          { name: "Karachi", tz: "Asia/Karachi", note: "Pakistan" },
          { name: "Delhi", tz: "Asia/Kolkata", note: "India" },
          { name: "Kathmandu", tz: "Asia/Kathmandu", note: "Nepal" },
          { name: "Dhaka", tz: "Asia/Dhaka", note: "Bangladesh" },
          { name: "Bangkok", tz: "Asia/Bangkok", note: "Thailand" },
          { name: "Singapore", tz: "Asia/Singapore", note: "Singapore" },
          { name: "Hong Kong", tz: "Asia/Hong_Kong", note: "Hong Kong" },
          { name: "Shanghai", tz: "Asia/Shanghai", note: "China" },
          { name: "Seoul", tz: "Asia/Seoul", note: "South Korea" },
          { name: "Tokyo", tz: "Asia/Tokyo", note: "Japan" },
          { name: "Taipei", tz: "Asia/Taipei", note: "Taiwan" },
          { name: "Jakarta", tz: "Asia/Jakarta", note: "Indonesia" },
          { name: "Manila", tz: "Asia/Manila", note: "Philippines" },
          { name: "Hanoi", tz: "Asia/Bangkok", note: "Vietnam" },
          { name: "Auckland", tz: "Pacific/Auckland", note: "New Zealand" },
          { name: "Sydney", tz: "Australia/Sydney", note: "Australia" },
          { name: "Melbourne", tz: "Australia/Melbourne", note: "Australia" },
          { name: "Perth", tz: "Australia/Perth", note: "Australia" },
          { name: "Brisbane", tz: "Australia/Brisbane", note: "Australia" },
        ];

        const SUPPORTED_TZS = (() => {
          try {
            if (typeof Intl.supportedValuesOf !== "function") return [];
            const list = Intl.supportedValuesOf("timeZone");
            if (!Array.isArray(list)) return [];
            // Keep as strings; match using lowercase includes.
            return list.filter((z) => typeof z === "string" && z.length > 2);
          } catch {
            return [];
          }
        })();

        const DEFAULT_TZS = (() => {
          const localTz = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
          const picks = [localTz, "UTC", "America/New_York", "Europe/London", "Asia/Tokyo"];
          return Array.from(new Set(picks));
        })();

        const state = {
          hour12: false, // false => 24h
          cities: [],
        };

        const ui = {
          grid: $("#grid"),
          fmtToggle: $("#fmtToggle"),
          fmtToggleInput: $("#fmtToggleInput"),
          fmtLabel: $("#fmtLabel"),
          resetBtn: $("#resetBtn"),
          searchWrap: $("#searchWrap"),
          searchInput: $("#searchInput"),
          addBtn: $("#addBtn"),
          suggest: $("#suggest"),
          suggestList: $("#suggestList"),
          toast: $("#toast"),
          toastText: $("#toastText"),
        };

        const cardRefs = new Map(); // id -> {root, time, date, tod, icon, offset, diff, hands...}
        const fmtCache = new Map(); // key -> Intl.DateTimeFormat

        const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
        const norm = (s) =>
          (s || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .trim();

        function toast(msg) {
          ui.toastText.innerHTML = msg;
          ui.toast.dataset.open = "true";
          clearTimeout(toast._t);
          toast._t = setTimeout(() => {
            ui.toast.dataset.open = "false";
          }, 2200);
        }

        function safeTimeZone(tz) {
          if (!tz) return null;
          try {
            new Intl.DateTimeFormat("en-US", { timeZone: tz }).format(new Date());
            return tz;
          } catch {
            return null;
          }
        }

        function getFormatter(timeZone, hour12, withSeconds) {
          const key = `${timeZone}|${hour12 ? "12" : "24"}|${withSeconds ? "s" : "-"}`;
          const existing = fmtCache.get(key);
          if (existing) return existing;
          const fmt = new Intl.DateTimeFormat(undefined, {
            timeZone,
            hour: "2-digit",
            minute: "2-digit",
            second: withSeconds ? "2-digit" : undefined,
            hour12,
          });
          fmtCache.set(key, fmt);
          return fmt;
        }

        function getParts(timeZone) {
          // Always compute numeric parts using 24h clock to drive theme + analog hands.
          const fmt = getParts._fmt.get(timeZone);
          if (fmt) return fmt.formatToParts(new Date());
          const nf = new Intl.DateTimeFormat(undefined, {
            timeZone,
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hourCycle: "h23",
            weekday: "short",
            month: "short",
            day: "2-digit",
            year: "numeric",
          });
          getParts._fmt.set(timeZone, nf);
          return nf.formatToParts(new Date());
        }
        getParts._fmt = new Map();

        function partsToObj(parts) {
          const out = Object.create(null);
          for (const p of parts) {
            if (p.type !== "literal") out[p.type] = p.value;
          }
          return out;
        }

        function timeOfDay(hour) {
          if (hour >= 5 && hour <= 11) return "morning";
          if (hour >= 12 && hour <= 16) return "afternoon";
          if (hour >= 17 && hour <= 20) return "evening";
          return "night";
        }

        function formatOffsetMinutes(offsetMinutes) {
          const sign = offsetMinutes >= 0 ? "+" : "-";
          const abs = Math.abs(offsetMinutes);
          const h = Math.floor(abs / 60);
          const m = abs % 60;
          return `UTC${sign}${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
        }

        function getOffsetMinutesForZone(timeZone, at = new Date()) {
          const fmt = getOffsetMinutesForZone._fmt.get(timeZone);
          let f = fmt;
          if (!f) {
            f = new Intl.DateTimeFormat("en-US", {
              timeZone,
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
              hourCycle: "h23",
            });
            getOffsetMinutesForZone._fmt.set(timeZone, f);
          }
          const p = partsToObj(f.formatToParts(at));
          // Build a UTC timestamp for the same wall-clock parts in the target zone.
          const asUTC = Date.UTC(
            Number(p.year),
            Number(p.month) - 1,
            Number(p.day),
            Number(p.hour),
            Number(p.minute),
            Number(p.second)
          );
          return Math.round((asUTC - at.getTime()) / 60000);
        }
        getOffsetMinutesForZone._fmt = new Map();

        function diffFromLocalMinutes(targetTz) {
          const localTz = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
          const now = new Date();
          const local = getOffsetMinutesForZone(localTz, now);
          const target = getOffsetMinutesForZone(targetTz, now);
          return target - local;
        }

        function humanDiff(minutes) {
          if (minutes === 0) return "Same as you";
          const sign = minutes > 0 ? "+" : "-";
          const abs = Math.abs(minutes);
          const h = Math.floor(abs / 60);
          const m = abs % 60;
          if (m === 0) return `${sign}${h}h`;
          return `${sign}${h}h ${m}m`;
        }

        function cityIdFor(tz) {
          return tz;
        }

        function displayNameForTz(tz) {
          const known = CITY_CATALOG.find((c) => c.tz === tz);
          if (known) return known.name;
          const pretty = tz.includes("/") ? tz.split("/").slice(-1)[0].replace(/_/g, " ") : tz;
          return pretty;
        }

        function noteForTz(tz) {
          const known = CITY_CATALOG.find((c) => c.tz === tz);
          if (known?.note) return known.note;
          return tz;
        }

        function save() {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ hour12: state.hour12, cities: state.cities }));
          } catch {
            // ignore
          }
        }

        function load() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return false;
            const parsed = JSON.parse(raw);
            if (typeof parsed !== "object" || !parsed) return false;
            if (typeof parsed.hour12 === "boolean") state.hour12 = parsed.hour12;
            if (Array.isArray(parsed.cities)) {
              const tzs = parsed.cities.map((c) => safeTimeZone(c?.tz)).filter(Boolean);
              state.cities = Array.from(new Set(tzs)).map((tz) => ({ id: cityIdFor(tz), tz, name: displayNameForTz(tz) }));
            }
            return true;
          } catch {
            return false;
          }
        }

        function setDefaults() {
          state.hour12 = false;
          state.cities = DEFAULT_TZS.map((tz) => ({ id: cityIdFor(tz), tz, name: displayNameForTz(tz) }));
          save();
        }

        function setToggleUI() {
          ui.fmtToggle.dataset.on = state.hour12 ? "true" : "false";
          ui.fmtToggle.setAttribute("aria-checked", state.hour12 ? "true" : "false");
          ui.fmtToggleInput.checked = state.hour12;
          ui.fmtLabel.textContent = state.hour12 ? "12h" : "24h";
        }

        function createClockSvg() {
          const idx = (createClockSvg._i = (createClockSvg._i || 0) + 1);
          const ringId = `ring-${idx}`;
          const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          svg.setAttribute("viewBox", "0 0 100 100");
          svg.innerHTML = `
            <defs>
              <linearGradient id="${ringId}" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="rgba(255,255,255,.35)"/>
                <stop offset="1" stop-color="rgba(255,255,255,.08)"/>
              </linearGradient>
            </defs>
            <circle cx="50" cy="50" r="44" fill="none" stroke="url(#${ringId})" stroke-width="2.2" />
            <circle cx="50" cy="50" r="37" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="6" />
            <g opacity="0.65">
              ${Array.from({ length: 12 })
                .map((_, i) => {
                  const a = (i * Math.PI) / 6;
                  const x1 = 50 + Math.cos(a) * 38;
                  const y1 = 50 + Math.sin(a) * 38;
                  const x2 = 50 + Math.cos(a) * 42;
                  const y2 = 50 + Math.sin(a) * 42;
                  return `<line x1="${x1.toFixed(2)}" y1="${y1.toFixed(2)}" x2="${x2.toFixed(2)}" y2="${y2.toFixed(
                    2
                  )}" stroke="rgba(255,255,255,.25)" stroke-width="${i % 3 === 0 ? 1.2 : 0.9}" stroke-linecap="round"/>`;
                })
                .join("")}
            </g>
            <g>
              <line data-hand="h" x1="50" y1="52" x2="50" y2="28" stroke="rgba(255,255,255,.86)" stroke-width="3.4" stroke-linecap="round"/>
              <line data-hand="m" x1="50" y1="52" x2="50" y2="20" stroke="rgba(255,255,255,.72)" stroke-width="2.3" stroke-linecap="round"/>
              <line data-hand="s" x1="50" y1="54" x2="50" y2="16" stroke="rgba(255,255,255,.48)" stroke-width="1.4" stroke-linecap="round"/>
            </g>
          `;
          return svg;
        }

        function createCard(city) {
          const root = document.createElement("article");
          root.className = "card";
          root.dataset.tod = "night";
          root.setAttribute("data-id", city.id);
          root.setAttribute("tabindex", "-1");

          const inner = document.createElement("div");
          inner.className = "cardInner";

          const left = document.createElement("div");

          const top = document.createElement("div");
          top.className = "cityTop";

          const cityLeft = document.createElement("div");
          cityLeft.className = "cityLeft";

          const badge = document.createElement("div");
          badge.className = "badge";
          badge.innerHTML = ICONS.night;

          const nameWrap = document.createElement("div");
          nameWrap.className = "cityName";

          const name = document.createElement("div");
          name.className = "name";
          name.textContent = city.name;

          const sub = document.createElement("div");
          sub.className = "sub";
          sub.textContent = noteForTz(city.tz);

          nameWrap.appendChild(name);
          nameWrap.appendChild(sub);

          cityLeft.appendChild(badge);
          cityLeft.appendChild(nameWrap);

          const actions = document.createElement("div");
          actions.style.display = "flex";
          actions.style.gap = "8px";
          actions.style.alignItems = "center";

          const remove = document.createElement("button");
          remove.className = "iconBtn";
          remove.type = "button";
          remove.title = `Remove ${city.name}`;
          remove.setAttribute("aria-label", `Remove ${city.name}`);
          remove.innerHTML = ICONS.x;
          remove.addEventListener("click", () => removeCity(city.id));

          actions.appendChild(remove);

          top.appendChild(cityLeft);
          top.appendChild(actions);

          const timeBlock = document.createElement("div");
          timeBlock.className = "timeBlock";

          const bigTime = document.createElement("div");
          bigTime.className = "bigTime";
          bigTime.textContent = "--:--:--";

          const metaRow = document.createElement("div");
          metaRow.className = "metaRow";

          const todTag = document.createElement("span");
          todTag.className = "tag";
          todTag.innerHTML = `<strong>—</strong>`;

          const date = document.createElement("span");
          date.className = "tag";
          date.innerHTML = `<strong>—</strong>`;

          const offset = document.createElement("span");
          offset.className = "tag";
          offset.innerHTML = `<strong>—</strong>`;

          const diff = document.createElement("span");
          diff.className = "tag";
          diff.innerHTML = `<strong>—</strong>`;

          metaRow.appendChild(todTag);
          metaRow.appendChild(date);
          metaRow.appendChild(offset);
          metaRow.appendChild(diff);

          timeBlock.appendChild(bigTime);
          timeBlock.appendChild(metaRow);

          left.appendChild(top);
          left.appendChild(timeBlock);

          const clock = document.createElement("div");
          clock.className = "clock";
          const svg = createClockSvg();
          clock.appendChild(svg);
          const dot = document.createElement("div");
          dot.className = "dot";
          clock.appendChild(dot);

          inner.appendChild(left);
          inner.appendChild(clock);
          root.appendChild(inner);

          const hands = {
            h: svg.querySelector('[data-hand="h"]'),
            m: svg.querySelector('[data-hand="m"]'),
            s: svg.querySelector('[data-hand="s"]'),
          };

          cardRefs.set(city.id, {
            root,
            badge,
            name,
            sub,
            bigTime,
            todTag,
            date,
            offset,
            diff,
            hands,
            tz: city.tz,
            lastTod: null,
          });

          return root;
        }

        function render() {
          ui.grid.innerHTML = "";
          cardRefs.clear();

          if (!state.cities.length) {
            const empty = document.createElement("div");
            empty.className = "empty";
            empty.innerHTML =
              `<strong>No cities yet.</strong> Add one above to start tracking time across the world.` +
              `<div style="margin-top:10px;color:rgba(255,255,255,.62);font-size:12px">Try <code style="font-family:var(--mono);">Europe/Paris</code> or click a quick chip.</div>`;
            ui.grid.appendChild(empty);
            return;
          }

          for (const city of state.cities) {
            ui.grid.appendChild(createCard(city));
          }
        }

        function removeCity(id) {
          const idx = state.cities.findIndex((c) => c.id === id);
          if (idx === -1) return;
          const removed = state.cities[idx];
          state.cities.splice(idx, 1);
          save();
          render();
          tick(true);
          toast(`Removed <code>${removed.name}</code>.`);
          updateQuickDisabled();
        }

        function addCityByTz(tz) {
          const safe = safeTimeZone(tz);
          if (!safe) {
            toast(`Timezone <code>${escapeHtml(tz)}</code> isn’t recognized on this device.`);
            return;
          }
          const id = cityIdFor(safe);
          if (state.cities.some((c) => c.id === id)) {
            toast(`<code>${escapeHtml(displayNameForTz(safe))}</code> is already on your board.`);
            return;
          }
          const city = { id, tz: safe, name: displayNameForTz(safe) };
          state.cities.unshift(city);
          save();
          render();
          tick(true);
          toast(`Added <code>${escapeHtml(city.name)}</code>.`);
          updateQuickDisabled();
        }

        function escapeHtml(s) {
          return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#39;");
        }

        function searchCatalog(q) {
          const query = norm(q);
          if (!query) return [];
          const tokens = query.split(/\s+/).filter(Boolean);
          const score = (c) => {
            const hay = norm(`${c.name} ${c.tz} ${c.note || ""}`);
            let s = 0;
            for (const t of tokens) {
              const i = hay.indexOf(t);
              if (i === -1) return -1;
              s += i === 0 ? 3 : i < 6 ? 2 : 1;
            }
            // Prefer exact starts on name.
            const n = norm(c.name);
            if (n.startsWith(query)) s += 4;
            else if (n.includes(query)) s += 2;
            return s;
          };

          const results = [];
          for (const c of CITY_CATALOG) {
            const sc = score(c);
            if (sc >= 0) results.push({ c, sc });
          }
          results.sort((a, b) => b.sc - a.sc || a.c.name.localeCompare(b.c.name));
          const top = results.slice(0, 8).map((r) => r.c);

          // Supplement with supported IANA zones if available (useful for power users).
          if (top.length < 8 && SUPPORTED_TZS.length && (query.includes("/") || query.length >= 4)) {
            const already = new Set(top.map((c) => c.tz));
            const qlc = query.toLowerCase();
            for (const tz of SUPPORTED_TZS) {
              if (already.size >= 8) break;
              const tzlc = tz.toLowerCase();
              if (!tzlc.includes(qlc)) continue;
              if (already.has(tz)) continue;
              already.add(tz);
              const pretty = tz.includes("/") ? tz.split("/").slice(-1)[0].replace(/_/g, " ") : tz;
              top.push({ name: pretty, tz, note: "Timezone" });
            }
          }

          return top;
        }

        const suggestState = {
          open: false,
          items: [],
          index: -1,
        };

        function openSuggest(items) {
          suggestState.items = items;
          suggestState.index = items.length ? 0 : -1;
          suggestState.open = !!items.length;
          ui.suggest.dataset.open = suggestState.open ? "true" : "false";
          ui.searchWrap.setAttribute("aria-expanded", suggestState.open ? "true" : "false");
          ui.suggestList.innerHTML = "";

          if (!items.length) return;
          for (let i = 0; i < items.length; i++) {
            const c = items[i];
            const row = document.createElement("div");
            row.className = "row";
            row.setAttribute("role", "option");
            row.id = `opt-${i}`;
            row.setAttribute("aria-selected", i === suggestState.index ? "true" : "false");
            row.innerHTML = `
              <div class="name">${escapeHtml(c.name)}</div>
              <div class="meta">${escapeHtml(c.tz)}</div>
            `;
            row.addEventListener("mousedown", (e) => {
              // Prevent input blur before click.
              e.preventDefault();
            });
            row.addEventListener("click", () => {
              addCityByTz(c.tz);
              closeSuggest();
              ui.searchInput.value = "";
              ui.searchInput.focus();
            });
            ui.suggestList.appendChild(row);
          }
          syncActiveDescendant();
        }

        function closeSuggest() {
          suggestState.open = false;
          suggestState.items = [];
          suggestState.index = -1;
          ui.suggest.dataset.open = "false";
          ui.searchWrap.setAttribute("aria-expanded", "false");
          ui.searchInput.setAttribute("aria-activedescendant", "");
        }

        function setSuggestIndex(next) {
          if (!suggestState.open) return;
          const max = suggestState.items.length - 1;
          suggestState.index = clamp(next, 0, max);
          $$("#suggestList .row", ui.suggest).forEach((el, i) => {
            el.setAttribute("aria-selected", i === suggestState.index ? "true" : "false");
          });
          syncActiveDescendant();
        }

        function syncActiveDescendant() {
          if (!suggestState.open || suggestState.index < 0) {
            ui.searchInput.setAttribute("aria-activedescendant", "");
            return;
          }
          ui.searchInput.setAttribute("aria-activedescendant", `opt-${suggestState.index}`);
        }

        function pickFromSuggest() {
          if (suggestState.open && suggestState.index >= 0) {
            const c = suggestState.items[suggestState.index];
            addCityByTz(c.tz);
            closeSuggest();
            ui.searchInput.value = "";
            ui.searchInput.focus();
            return true;
          }
          return false;
        }

        function updateQuickDisabled() {
          $$("[data-quick]").forEach((btn) => {
            const tz = btn.getAttribute("data-quick");
            btn.disabled = state.cities.some((c) => c.tz === tz);
          });
        }

        function renderSuggestForInput() {
          const q = ui.searchInput.value;
          const items = searchCatalog(q);
          openSuggest(items);
        }

        function tick(forceMeta = false) {
          const now = new Date();
          for (const city of state.cities) {
            const ref = cardRefs.get(city.id);
            if (!ref) continue;

            const parts = partsToObj(getParts(city.tz));
            const hour = Number(parts.hour);
            const minute = Number(parts.minute);
            const second = Number(parts.second);

            const tod = timeOfDay(hour);
            if (tod !== ref.lastTod) {
              ref.lastTod = tod;
              ref.root.dataset.tod = tod;
              ref.badge.innerHTML = ICONS[tod];
              const label = tod === "morning" ? "Morning" : tod === "afternoon" ? "Afternoon" : tod === "evening" ? "Evening" : "Night";
              ref.todTag.innerHTML = `<strong>${label}</strong>`;
            }

            const timeFmt = getFormatter(city.tz, state.hour12, true);
            ref.bigTime.textContent = timeFmt.format(now);

            const hour12Val = ((hour % 12) || 12);
            const hForAnalog = hour12Val % 12;
            const sDeg = second * 6;
            const mDeg = minute * 6 + second * 0.1;
            const hDeg = hForAnalog * 30 + minute * 0.5;
            ref.hands.s.setAttribute("transform", `rotate(${sDeg} 50 50)`);
            ref.hands.m.setAttribute("transform", `rotate(${mDeg} 50 50)`);
            ref.hands.h.setAttribute("transform", `rotate(${hDeg} 50 50)`);

            if (forceMeta || ref._lastMetaDay !== parts.day || ref._lastMetaMonth !== parts.month || ref._lastMetaYear !== parts.year) {
              ref._lastMetaDay = parts.day;
              ref._lastMetaMonth = parts.month;
              ref._lastMetaYear = parts.year;
              ref.date.innerHTML = `<strong>${escapeHtml(parts.weekday)}</strong> ${escapeHtml(parts.month)} ${escapeHtml(parts.day)}, ${escapeHtml(
                parts.year
              )}`;
            }

            if (forceMeta || ref._lastOffsetStamp !== Math.floor(now.getTime() / 60000)) {
              ref._lastOffsetStamp = Math.floor(now.getTime() / 60000);
              const off = getOffsetMinutesForZone(city.tz, now);
              ref.offset.innerHTML = `<strong>${formatOffsetMinutes(off)}</strong>`;
              const diff = diffFromLocalMinutes(city.tz);
              ref.diff.innerHTML = `<strong>${escapeHtml(humanDiff(diff))}</strong> from you`;
            }
          }
        }

        function alignToNextSecond() {
          const ms = Date.now();
          const next = 1000 - (ms % 1000);
          clearTimeout(alignToNextSecond._t);
          alignToNextSecond._t = setTimeout(() => {
            tick();
            alignToNextSecond();
          }, next);
        }

        function toggleFormat() {
          state.hour12 = !state.hour12;
          setToggleUI();
          save();
          tick(true);
          toast(`Switched to <code>${state.hour12 ? "12h" : "24h"}</code> format.`);
        }

        function addFromInput() {
          const raw = ui.searchInput.value.trim();
          if (!raw) return;
          if (pickFromSuggest()) return;

          const match = raw.match(/([A-Za-z0-9._+-]+\/[A-Za-z0-9._+-]+(?:\/[A-Za-z0-9._+-]+)?|UTC)/);
          if (match) {
            const tz = match[1];
            addCityByTz(tz);
            ui.searchInput.value = "";
            closeSuggest();
            return;
          }

          const best = searchCatalog(raw)[0];
          if (best) {
            addCityByTz(best.tz);
            ui.searchInput.value = "";
            closeSuggest();
            return;
          }

          toast(`No match for <code>${escapeHtml(raw)}</code>. Try an IANA timezone like <code>Europe/Paris</code>.`);
        }

        function wire() {
          ui.fmtToggle.addEventListener("click", toggleFormat);
          ui.fmtToggle.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              toggleFormat();
            }
          });

          ui.resetBtn.addEventListener("click", () => {
            setDefaults();
            setToggleUI();
            render();
            tick(true);
            updateQuickDisabled();
            toast("Reset to defaults.");
          });

          ui.searchInput.addEventListener("input", () => {
            renderSuggestForInput();
          });

          ui.searchInput.addEventListener("focus", () => {
            renderSuggestForInput();
          });

          ui.searchInput.addEventListener("keydown", (e) => {
            if (e.key === "ArrowDown") {
              if (!suggestState.open) renderSuggestForInput();
              setSuggestIndex(suggestState.index + 1);
              e.preventDefault();
              return;
            }
            if (e.key === "ArrowUp") {
              if (!suggestState.open) renderSuggestForInput();
              setSuggestIndex(suggestState.index - 1);
              e.preventDefault();
              return;
            }
            if (e.key === "Enter") {
              e.preventDefault();
              addFromInput();
              return;
            }
            if (e.key === "Escape") {
              closeSuggest();
              return;
            }
          });

          ui.addBtn.addEventListener("click", addFromInput);

          document.addEventListener("click", (e) => {
            const inside = ui.searchWrap.contains(e.target);
            if (!inside) closeSuggest();
          });

          $$("[data-quick]").forEach((btn) => {
            btn.addEventListener("click", () => addCityByTz(btn.getAttribute("data-quick")));
          });
        }

        function init() {
          const ok = load();
          if (!ok || !state.cities.length) setDefaults();

          // Ensure all zones are valid and unique.
          const unique = [];
          const seen = new Set();
          for (const c of state.cities) {
            const tz = safeTimeZone(c?.tz);
            if (!tz) continue;
            if (seen.has(tz)) continue;
            seen.add(tz);
            unique.push({ id: cityIdFor(tz), tz, name: displayNameForTz(tz) });
          }
          state.cities = unique;

          setToggleUI();
          render();
          tick(true);
          alignToNextSecond();
          wire();
          updateQuickDisabled();

          // Soft nudge: if device doesn't support time zones well.
          if (!safeTimeZone("Europe/Paris")) {
            toast("Note: this browser has limited timezone support.");
          }
        }

        init();
      })();
    </script>
  </body>
</html>
