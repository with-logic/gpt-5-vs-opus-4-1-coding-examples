<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark" />
    <title>Music Theory Trainer</title>
    <style>
      :root{
        --bg0:#070711;
        --bg1:#0b1020;
        --card:#0e1630cc;
        --card2:#0b1228cc;
        --stroke:#22305a;
        --text:#eaf1ff;
        --muted:#b7c3ffcc;
        --faint:#9fb0ff88;
        --hot:#7bf0ff;
        --hot2:#b081ff;
        --good:#4dffb2;
        --bad:#ff4d86;
        --warn:#ffd14d;
        --shadow: 0 18px 60px rgba(0,0,0,.55);
        --shadow2: 0 12px 30px rgba(0,0,0,.35);
        --radius: 18px;
        --radius2: 14px;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        --keyW: 48px;
        --keyH: 210px;
      }

      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        font-family:var(--sans);
        color:var(--text);
        background:
          radial-gradient(1200px 700px at 10% 0%, rgba(123,240,255,.15), transparent 55%),
          radial-gradient(900px 600px at 85% 10%, rgba(176,129,255,.16), transparent 55%),
          radial-gradient(800px 800px at 50% 90%, rgba(77,255,178,.12), transparent 60%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        overflow-x:hidden;
      }

      a{color:inherit}
      button, input, select{font:inherit}
      .noSelect{user-select:none; -webkit-user-select:none}
      .srOnly{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}

      /* Ambient animated “sound waves” */
      .bgWaves{
        position:fixed; inset:-20vh -20vw;
        pointer-events:none;
        opacity:.35;
        filter: blur(0px);
        mix-blend-mode: screen;
        z-index:-1;
      }
      .bgWaves:before, .bgWaves:after{
        content:"";
        position:absolute; inset:0;
        background:
          radial-gradient(circle at 15% 25%, rgba(123,240,255,.26), transparent 35%),
          radial-gradient(circle at 80% 30%, rgba(176,129,255,.22), transparent 38%),
          radial-gradient(circle at 60% 80%, rgba(77,255,178,.16), transparent 42%);
        transform-origin: 50% 50%;
        animation: drift 18s ease-in-out infinite alternate;
      }
      .bgWaves:after{
        opacity:.65;
        animation-duration: 26s;
        filter: blur(18px);
      }
      @keyframes drift{
        0%{transform: translate3d(-2%, -1%, 0) scale(1.02) rotate(-1.2deg)}
        50%{transform: translate3d(2%, 1%, 0) scale(1.06) rotate(1.2deg)}
        100%{transform: translate3d(-1%, 2%, 0) scale(1.03) rotate(-.6deg)}
      }

      #app{
        min-height:100%;
        display:flex;
        flex-direction:column;
      }

      header{
        position:sticky;
        top:0;
        z-index:10;
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        background: linear-gradient(180deg, rgba(7,7,17,.92), rgba(7,7,17,.55));
        border-bottom:1px solid rgba(34,48,90,.55);
      }
      .topBar{
        max-width:1200px;
        margin:0 auto;
        padding:16px 16px 10px;
        display:flex;
        gap:14px;
        align-items:center;
        justify-content:space-between;
      }

      .brand{
        display:flex;
        gap:12px;
        align-items:center;
        min-width: 260px;
      }
      .logo{
        width:42px; height:42px;
        border-radius:14px;
        background:
          radial-gradient(circle at 30% 20%, rgba(123,240,255,.95), rgba(123,240,255,.2) 45%, transparent 55%),
          radial-gradient(circle at 70% 70%, rgba(176,129,255,.85), rgba(176,129,255,.18) 55%, transparent 65%),
          linear-gradient(135deg, rgba(255,255,255,.1), rgba(255,255,255,.02));
        border:1px solid rgba(255,255,255,.14);
        box-shadow: 0 10px 35px rgba(0,0,0,.45);
        position:relative;
        overflow:hidden;
      }
      .logo:after{
        content:"";
        position:absolute; inset:-40%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
        transform: rotate(22deg) translateX(-40%);
        animation: sheen 3.5s ease-in-out infinite;
      }
      @keyframes sheen{
        0%, 55%{transform: rotate(22deg) translateX(-70%);}
        80%{transform: rotate(22deg) translateX(70%);}
        100%{transform: rotate(22deg) translateX(70%);}
      }
      .brand h1{
        font-size: 18px;
        margin:0;
        letter-spacing: .2px;
        line-height:1.05;
      }
      .tag{
        font-size:12px;
        color:var(--muted);
        margin-top:2px;
      }

      .tabs{
        display:flex;
        gap:8px;
        align-items:center;
        flex-wrap:wrap;
        justify-content:center;
      }
      .tab{
        border:1px solid rgba(34,48,90,.7);
        background: linear-gradient(180deg, rgba(18,26,56,.65), rgba(10,14,30,.35));
        color:var(--text);
        padding:9px 12px;
        border-radius: 999px;
        cursor:pointer;
        transition: transform .12s ease, border-color .2s ease, background .2s ease;
        box-shadow: 0 10px 18px rgba(0,0,0,.18);
      }
      .tab:hover{transform: translateY(-1px); border-color: rgba(123,240,255,.65)}
      .tab[aria-selected="true"]{
        background:
          radial-gradient(circle at 30% 20%, rgba(123,240,255,.22), transparent 45%),
          radial-gradient(circle at 80% 70%, rgba(176,129,255,.18), transparent 55%),
          linear-gradient(180deg, rgba(24,36,74,.9), rgba(12,16,34,.55));
        border-color: rgba(123,240,255,.85);
        box-shadow: 0 18px 30px rgba(0,0,0,.35);
      }
      .tab small{
        color: var(--muted);
        margin-left:6px;
        font-family: var(--mono);
        font-size:11px;
      }

      .hud{
        display:flex;
        gap:10px;
        align-items:center;
        justify-content:flex-end;
        min-width: 250px;
      }
      .pill{
        border:1px solid rgba(34,48,90,.65);
        background: rgba(10,14,30,.35);
        border-radius:999px;
        padding:8px 10px;
        display:flex;
        gap:10px;
        align-items:center;
        box-shadow: var(--shadow2);
      }
      .pill strong{font-size:12px; letter-spacing:.1px}
      .pill span{
        font-family: var(--mono);
        font-size:12px;
        color: var(--muted);
      }
      .pill .dot{
        width:8px; height:8px; border-radius:999px;
        background: rgba(255,255,255,.18);
        box-shadow: 0 0 0 2px rgba(255,255,255,.08);
      }
      .pill .dot.on{background: var(--good); box-shadow: 0 0 0 2px rgba(77,255,178,.2), 0 0 14px rgba(77,255,178,.25)}

      main{
        flex:1;
        max-width:1200px;
        width:100%;
        margin:0 auto;
        padding: 16px 16px 18px;
      }

      .layout{
        display:grid;
        grid-template-columns: 360px 1fr;
        gap: 14px;
        align-items:start;
      }
      @media (max-width: 980px){
        .layout{grid-template-columns: 1fr}
        .brand{min-width:auto}
        .hud{min-width:auto}
      }

      .card{
        border:1px solid rgba(34,48,90,.7);
        background: linear-gradient(180deg, var(--card), var(--card2));
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow:hidden;
      }
      .cardHeader{
        padding: 12px 14px;
        border-bottom:1px solid rgba(34,48,90,.55);
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
      }
      .cardHeader h2{
        margin:0;
        font-size: 13px;
        letter-spacing: .5px;
        text-transform: uppercase;
        color: var(--muted);
      }
      .cardBody{padding: 14px}

      .hint{
        color:var(--muted);
        font-size: 13px;
        line-height: 1.4;
      }
      .hint b{color:var(--text)}
      .split{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:10px;
      }
      @media (max-width: 480px){.split{grid-template-columns: 1fr}}

      label{
        display:flex;
        flex-direction:column;
        gap:6px;
        font-size: 12px;
        color: var(--muted);
      }
      select, input[type="range"], input[type="checkbox"], button{
        accent-color: var(--hot);
      }
      select{
        background: rgba(7,10,20,.55);
        border: 1px solid rgba(34,48,90,.75);
        color: var(--text);
        padding: 9px 10px;
        border-radius: 12px;
        outline:none;
      }
      input[type="range"]{width:100%}
      .row{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
      }
      .row .val{
        font-family: var(--mono);
        font-size: 12px;
        color: var(--text);
        opacity:.9;
        min-width: 48px;
        text-align:right;
      }
      .toggle{
        display:flex; align-items:center; gap:8px;
        font-size: 13px;
        color: var(--muted);
      }
      .toggle input{transform: translateY(1px)}

      .btn{
        border:1px solid rgba(34,48,90,.75);
        background: linear-gradient(180deg, rgba(20,28,60,.8), rgba(10,14,30,.35));
        color: var(--text);
        padding: 10px 12px;
        border-radius: 14px;
        cursor:pointer;
        transition: transform .12s ease, border-color .2s ease, background .2s ease;
        box-shadow: 0 10px 18px rgba(0,0,0,.18);
      }
      .btn:hover{transform: translateY(-1px); border-color: rgba(123,240,255,.7)}
      .btn:active{transform: translateY(0px) scale(.99)}
      .btn.primary{
        border-color: rgba(123,240,255,.85);
        background:
          radial-gradient(circle at 25% 20%, rgba(123,240,255,.22), transparent 45%),
          radial-gradient(circle at 85% 70%, rgba(176,129,255,.16), transparent 55%),
          linear-gradient(180deg, rgba(24,36,74,.92), rgba(12,16,34,.55));
      }
      .btn.good{border-color: rgba(77,255,178,.75)}
      .btn.bad{border-color: rgba(255,77,134,.75)}
      .btn.ghost{
        background: rgba(7,10,20,.25);
      }
      .btnRow{
        display:flex;
        flex-wrap:wrap;
        gap:10px;
        align-items:center;
      }

      .panel{min-height: 520px}
      .view{display:none}
      .view.active{display:block}

      .hero{
        display:grid;
        grid-template-columns: 1.2fr .8fr;
        gap: 12px;
        align-items:stretch;
      }
      @media (max-width: 980px){.hero{grid-template-columns: 1fr}}

      .heroCard{
        border-radius: var(--radius);
        padding: 14px 14px 12px;
        border:1px solid rgba(34,48,90,.65);
        background:
          radial-gradient(circle at 25% 0%, rgba(123,240,255,.12), transparent 42%),
          radial-gradient(circle at 95% 65%, rgba(176,129,255,.14), transparent 52%),
          linear-gradient(180deg, rgba(18,26,56,.6), rgba(10,14,30,.25));
        box-shadow: var(--shadow);
        overflow:hidden;
        position:relative;
      }
      .heroCard:after{
        content:"";
        position:absolute; inset:-40% -35%;
        background:
          repeating-linear-gradient(90deg,
            rgba(123,240,255,.0) 0px,
            rgba(123,240,255,.0) 12px,
            rgba(123,240,255,.08) 13px,
            rgba(123,240,255,.0) 22px),
          radial-gradient(circle at 30% 20%, rgba(77,255,178,.10), transparent 45%);
        transform: rotate(-8deg);
        opacity:.6;
        pointer-events:none;
        animation: lines 12s linear infinite;
      }
      @keyframes lines{
        0%{transform: translate3d(-2%, -1%, 0) rotate(-8deg)}
        100%{transform: translate3d(2%, 1%, 0) rotate(-8deg)}
      }
      .heroTitle{
        display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      }
      .heroTitle h3{margin:0; font-size: 16px; letter-spacing:.2px}
      .heroTitle p{margin:6px 0 0; color:var(--muted); font-size: 13px; line-height:1.35}
      .miniEq{
        display:flex; gap:3px; align-items:flex-end; height: 26px; margin-top:2px;
        opacity:.9;
      }
      .miniEq span{
        width:4px; border-radius:999px;
        background: linear-gradient(180deg, rgba(123,240,255,1), rgba(176,129,255,1));
        animation: eq 1.1s ease-in-out infinite;
      }
      .miniEq span:nth-child(2){animation-delay: .1s}
      .miniEq span:nth-child(3){animation-delay: .2s}
      .miniEq span:nth-child(4){animation-delay: .3s}
      .miniEq span:nth-child(5){animation-delay: .4s}
      @keyframes eq{
        0%,100%{height: 6px; opacity:.7}
        45%{height: 26px; opacity:1}
      }

      .callouts{
        margin-top: 10px;
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:10px;
      }
      @media (max-width: 520px){.callouts{grid-template-columns: 1fr}}
      .callout{
        border:1px solid rgba(34,48,90,.55);
        background: rgba(7,10,20,.28);
        border-radius: 14px;
        padding: 10px 10px;
      }
      .callout .k{
        font-family: var(--mono);
        font-size: 11px;
        color: var(--muted);
      }
      .callout .v{
        font-size: 13px;
        margin-top: 4px;
        line-height:1.3;
      }

      .bigReadout{
        font-family: var(--mono);
        font-size: 14px;
        line-height:1.3;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid rgba(34,48,90,.55);
        background: rgba(7,10,20,.35);
        display:flex;
        gap:10px;
        align-items:center;
        justify-content:space-between;
        margin-top: 10px;
      }
      .bigReadout .right{
        color: var(--muted);
        font-size: 12px;
        display:flex;
        gap:8px;
        align-items:center;
      }
      .badge{
        font-family: var(--mono);
        font-size: 11px;
        padding: 3px 7px;
        border-radius: 999px;
        border:1px solid rgba(34,48,90,.75);
        background: rgba(7,10,20,.35);
        color: var(--muted);
      }
      .badge.good{border-color: rgba(77,255,178,.55); color: rgba(77,255,178,.9)}
      .badge.bad{border-color: rgba(255,77,134,.55); color: rgba(255,77,134,.9)}
      .badge.hot{border-color: rgba(123,240,255,.6); color: rgba(123,240,255,.95)}

      /* Piano */
      .pianoDock{
        position:sticky;
        bottom:0;
        z-index:9;
        border-top:1px solid rgba(34,48,90,.55);
        background: linear-gradient(180deg, rgba(7,7,17,.10), rgba(7,7,17,.82));
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
      }
      .pianoTop{
        max-width:1200px;
        margin:0 auto;
        padding: 10px 16px 8px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
      }
      .pianoTop .now{
        display:flex;
        gap:10px;
        align-items:center;
        font-family: var(--mono);
        color: var(--muted);
        font-size: 12px;
      }
      .pianoTop .now strong{
        color: var(--text);
        font-size: 12px;
        letter-spacing:.2px;
      }
      .pianoWrap{
        max-width:1200px;
        margin:0 auto;
        padding: 0 8px 14px;
        overflow-x:auto;
        overflow-y:hidden;
        scrollbar-color: rgba(123,240,255,.35) rgba(7,10,20,.2);
      }
      .piano{
        position:relative;
        height: calc(var(--keyH) + 14px);
        padding: 8px 8px 6px;
        border-radius: 18px;
        border:1px solid rgba(34,48,90,.65);
        background:
          radial-gradient(600px 240px at 40% -10%, rgba(123,240,255,.14), transparent 55%),
          radial-gradient(650px 260px at 80% 120%, rgba(176,129,255,.12), transparent 55%),
          linear-gradient(180deg, rgba(15,18,38,.9), rgba(7,10,20,.55));
        box-shadow: var(--shadow);
        min-width: 720px;
      }
      .keys{
        position:relative;
        display:flex;
        align-items:flex-end;
        height: var(--keyH);
        padding-bottom: 0;
      }
      .wKey{
        position:relative;
        width: var(--keyW);
        height: var(--keyH);
        border-radius: 0 0 12px 12px;
        border: 1px solid rgba(0,0,0,.45);
        border-top: 1px solid rgba(255,255,255,.06);
        background:
          linear-gradient(180deg, rgba(255,255,255,.92), rgba(232,236,255,.82)),
          radial-gradient(circle at 50% 0%, rgba(123,240,255,.14), transparent 55%);
        box-shadow: inset 0 -10px 18px rgba(0,0,0,.08);
        padding:0;
        cursor:pointer;
        transition: filter .12s ease, transform .06s ease;
      }
      .wKey:active{transform: translateY(1px)}
      .wKey .kLabel{
        position:absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 10px;
        font-family: var(--mono);
        color: rgba(0,0,0,.65);
        opacity:.75;
        pointer-events:none;
      }
      .bKey{
        position:absolute;
        top: 0px;
        right: calc(var(--keyW) * -0.32);
        width: calc(var(--keyW) * 0.62);
        height: calc(var(--keyH) * 0.62);
        border-radius: 0 0 10px 10px;
        border: 1px solid rgba(0,0,0,.7);
        border-top: 1px solid rgba(255,255,255,.10);
        background:
          linear-gradient(180deg, rgba(24,26,46,.98), rgba(10,10,18,.98));
        box-shadow: inset 0 -14px 20px rgba(0,0,0,.45), 0 10px 16px rgba(0,0,0,.35);
        z-index: 3;
        padding:0;
        cursor:pointer;
        transition: filter .12s ease, transform .06s ease;
      }
      .bKey:active{transform: translateY(1px)}
      .bKey .kLabel{
        position:absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 10px;
        font-family: var(--mono);
        color: rgba(240,245,255,.75);
        opacity:.78;
        pointer-events:none;
      }

      .keyOn{
        filter: brightness(1.06) saturate(1.25);
        box-shadow:
          inset 0 -10px 18px rgba(0,0,0,.06),
          0 0 0 2px rgba(123,240,255,.22),
          0 0 22px rgba(123,240,255,.25);
      }
      .bKey.keyOn{
        box-shadow:
          inset 0 -14px 20px rgba(0,0,0,.35),
          0 0 0 2px rgba(176,129,255,.22),
          0 0 24px rgba(176,129,255,.25);
      }

      .hintOn{
        outline: 2px solid rgba(255,209,77,.65);
        outline-offset: -2px;
      }

      .scaleOn{
        outline: 2px solid rgba(77,255,178,.55);
        outline-offset: -2px;
      }
      .rootOn{
        outline: 2px solid rgba(123,240,255,.75);
        outline-offset: -2px;
      }

      .pianoMeta{
        position:absolute;
        top: 10px;
        right: 12px;
        display:flex;
        gap:8px;
        align-items:center;
        font-family: var(--mono);
        font-size: 11px;
        color: rgba(234,241,255,.88);
        opacity:.9;
      }

      /* Lessons widgets */
      .grid2{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        align-items:stretch;
      }
      @media (max-width: 980px){.grid2{grid-template-columns: 1fr}}
      .noteList{
        display:flex;
        flex-wrap:wrap;
        gap:8px;
        margin-top:10px;
      }
      .chip{
        border:1px solid rgba(34,48,90,.7);
        background: rgba(7,10,20,.28);
        border-radius:999px;
        padding: 7px 10px;
        font-family: var(--mono);
        font-size: 12px;
        color: var(--text);
      }
      .chip.muted{color: var(--muted)}
      .chip.hot{border-color: rgba(123,240,255,.6); color: rgba(123,240,255,.95)}
      .chip.good{border-color: rgba(77,255,178,.55); color: rgba(77,255,178,.92)}
      .chip.warn{border-color: rgba(255,209,77,.55); color: rgba(255,209,77,.92)}
      .divider{height:1px; background: rgba(34,48,90,.55); margin: 12px 0}

      /* Circle of fifths */
      .cofWrap{
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .cof{
        width: min(380px, 100%);
        aspect-ratio: 1/1;
        filter: drop-shadow(0 18px 40px rgba(0,0,0,.35));
      }
      .cof .seg{
        cursor:pointer;
        transition: transform .12s ease, filter .15s ease;
        transform-origin: 50% 50%;
      }
      .cof .seg:hover{filter: brightness(1.12); transform: scale(1.01)}
      .cof .seg.on{filter: brightness(1.18)}
      .cof text{
        font-family: var(--mono);
        fill: rgba(234,241,255,.9);
        font-size: 11px;
        pointer-events:none;
      }
      .cof .center{
        fill: rgba(7,10,20,.65);
        stroke: rgba(34,48,90,.85);
        stroke-width: 1.2;
      }

      /* Ear training */
      .gameGrid{
        display:grid;
        grid-template-columns: 1.1fr .9fr;
        gap: 12px;
      }
      @media (max-width: 980px){.gameGrid{grid-template-columns: 1fr}}
      .choices{
        display:flex;
        flex-wrap:wrap;
        gap:8px;
        margin-top:10px;
      }
      .choice{
        padding: 9px 10px;
        border-radius: 999px;
        border: 1px solid rgba(34,48,90,.75);
        background: rgba(7,10,20,.25);
        cursor:pointer;
        font-family: var(--mono);
        font-size: 12px;
        color: var(--text);
      }
      .choice:hover{border-color: rgba(123,240,255,.65)}
      .choice.good{border-color: rgba(77,255,178,.6); color: rgba(77,255,178,.95)}
      .choice.bad{border-color: rgba(255,77,134,.6); color: rgba(255,77,134,.95)}

      /* Progress */
      .statsGrid{
        display:grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
      }
      @media (max-width: 820px){.statsGrid{grid-template-columns: 1fr}}
      .stat{
        border:1px solid rgba(34,48,90,.65);
        background: rgba(7,10,20,.25);
        border-radius: 16px;
        padding: 12px 12px;
      }
      .stat .k{
        color: var(--muted);
        font-size: 12px;
        letter-spacing:.4px;
        text-transform:uppercase;
      }
      .stat .v{
        font-family: var(--mono);
        font-size: 22px;
        margin-top: 6px;
      }
      .achievements{
        display:flex;
        flex-wrap:wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .ach{
        width: 120px;
        border-radius: 16px;
        padding: 10px 10px;
        border: 1px solid rgba(34,48,90,.65);
        background: rgba(7,10,20,.25);
        opacity: .55;
      }
      .ach.on{
        opacity: 1;
        border-color: rgba(123,240,255,.55);
        box-shadow: 0 0 0 2px rgba(123,240,255,.12);
      }
      .ach .t{
        font-family: var(--mono);
        font-size: 12px;
      }
      .ach .d{
        margin-top: 6px;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.3;
      }

      /* Boot overlay */
      #boot{
        position:fixed; inset:0;
        display:flex;
        align-items:center;
        justify-content:center;
        background:
          radial-gradient(900px 600px at 50% 30%, rgba(123,240,255,.18), transparent 55%),
          radial-gradient(900px 700px at 55% 70%, rgba(176,129,255,.16), transparent 55%),
          linear-gradient(180deg, rgba(7,7,17,.96), rgba(7,7,17,.84));
        z-index:100;
      }
      #boot .panel{
        width: min(560px, calc(100vw - 28px));
        border-radius: 22px;
        border: 1px solid rgba(34,48,90,.75);
        background: linear-gradient(180deg, rgba(18,26,56,.72), rgba(10,14,30,.35));
        box-shadow: 0 30px 120px rgba(0,0,0,.65);
        padding: 18px 16px 14px;
      }
      #boot h2{margin:0; font-size: 18px}
      #boot p{margin:8px 0 0; color: var(--muted); line-height:1.4}
      #boot .btnRow{margin-top: 12px}
      #boot .fine{
        margin-top: 10px;
        color: rgba(183,195,255,.85);
        font-size: 12px;
        line-height:1.35;
      }

      /* Toast */
      #toast{
        position:fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: calc(18px + env(safe-area-inset-bottom, 0px));
        z-index: 200;
        pointer-events:none;
        display:flex;
        flex-direction:column;
        gap:8px;
      }
      .toast{
        pointer-events:none;
        min-width: 220px;
        max-width: min(560px, calc(100vw - 28px));
        border: 1px solid rgba(34,48,90,.75);
        border-radius: 999px;
        padding: 10px 12px;
        background: rgba(7,10,20,.72);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        box-shadow: 0 18px 50px rgba(0,0,0,.55);
        color: var(--text);
        font-size: 13px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        opacity:0;
        transform: translateY(10px);
        animation: toastIn .22s ease forwards;
      }
      .toast .small{
        font-family: var(--mono);
        font-size: 11px;
        color: var(--muted);
      }
      @keyframes toastIn{to{opacity:1; transform: translateY(0)}}

    </style>
  </head>
  <body>
    <div class="bgWaves" aria-hidden="true"></div>

    <div id="boot" class="noSelect">
      <div class="panel">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
          <div>
            <h2>Music Theory Trainer</h2>
            <p>Interactive piano + ear training. Learn notes, scales, and chords by playing them.</p>
          </div>
          <div class="miniEq" aria-hidden="true">
            <span></span><span></span><span></span><span></span><span></span>
          </div>
        </div>
        <div class="divider"></div>
        <div class="hint">
          <b>Tip:</b> Use your computer keyboard to play notes (A–K for white keys; W/E/T/Y/U for black keys).<br />
          Ear training works best with headphones.
        </div>
        <div class="btnRow">
          <button id="btnStart" class="btn primary">Start (enable audio)</button>
          <button id="btnSilent" class="btn ghost">Start silent</button>
        </div>
        <div class="fine">
          Audio is generated locally with the Web Audio API (no recordings). Your progress is saved in this browser via localStorage.
        </div>
      </div>
    </div>

    <div id="app">
      <header>
        <div class="topBar">
          <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>
              <h1>Music Theory Trainer</h1>
              <div class="tag">Notes • Scales • Chords • Ear training</div>
            </div>
          </div>

          <nav class="tabs" role="tablist" aria-label="Main views">
            <button class="tab" role="tab" aria-selected="true" data-view="playground">Playground <small>1</small></button>
            <button class="tab" role="tab" aria-selected="false" data-view="lessons">Lessons <small>2</small></button>
            <button class="tab" role="tab" aria-selected="false" data-view="ear">Ear Training <small>3</small></button>
            <button class="tab" role="tab" aria-selected="false" data-view="progress">Progress <small>4</small></button>
          </nav>

          <div class="hud">
            <div class="pill" title="Audio status">
              <div id="audioDot" class="dot"></div>
              <strong>Audio</strong>
              <span id="audioStatus">off</span>
            </div>
            <div class="pill" title="Your progress">
              <strong>XP</strong>
              <span id="xp">0</span>
              <strong>Streak</strong>
              <span id="streak">0</span>
            </div>
          </div>
        </div>
      </header>

      <main>
        <div class="layout">
          <div class="leftCol">
            <div class="card">
              <div class="cardHeader">
                <h2>Sound</h2>
                <button id="btnPanic" class="btn ghost" style="padding:7px 10px; border-radius:999px;" title="Stop all notes (Esc)">Panic</button>
              </div>
              <div class="cardBody">
                <div class="split">
                  <label>
                    Waveform
                    <select id="wave">
                      <option value="triangle">Triangle (warm)</option>
                      <option value="sine">Sine (pure)</option>
                      <option value="sawtooth">Saw (bright)</option>
                      <option value="square">Square (chiptune)</option>
                    </select>
                  </label>
                  <label>
                    Tuning
                    <select id="tuning">
                      <option value="440">A4 = 440 Hz</option>
                      <option value="432">A4 = 432 Hz</option>
                      <option value="442">A4 = 442 Hz</option>
                    </select>
                  </label>
                </div>
                <div style="height:10px"></div>
                <label class="row">
                  <span>Volume</span>
                  <span class="val" id="volVal">70%</span>
                </label>
                <input id="volume" type="range" min="0" max="100" value="70" />

                <div style="height:10px"></div>
                <div class="split">
                  <div>
                    <label class="row">
                      <span>Attack</span>
                      <span class="val" id="atkVal">12ms</span>
                    </label>
                    <input id="attack" type="range" min="0" max="250" value="12" />
                  </div>
                  <div>
                    <label class="row">
                      <span>Release</span>
                      <span class="val" id="relVal">180ms</span>
                    </label>
                    <input id="release" type="range" min="40" max="1200" value="180" />
                  </div>
                </div>
                <div style="height:10px"></div>
                <label class="row">
                  <span>Space (delay)</span>
                  <span class="val" id="spaceVal">20%</span>
                </label>
                <input id="space" type="range" min="0" max="100" value="20" />

                <div style="height:10px"></div>
                <div class="toggle">
                  <input id="sustain" type="checkbox" />
                  <label for="sustain" style="gap:0; font-size:13px; color:var(--muted); flex-direction:row; align-items:center;">
                    Sustain mode (spacebar toggles)
                  </label>
                </div>

                <div style="height:12px"></div>
                <div class="hint">
                  <b>Shortcuts:</b> <span style="font-family:var(--mono)">Esc</span> panic, <span style="font-family:var(--mono)">R</span> replay (games), <span style="font-family:var(--mono)">Enter</span> next (games)
                </div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="card">
              <div class="cardHeader">
                <h2>Piano Range</h2>
                <button id="btnCenterC" class="btn ghost" style="padding:7px 10px; border-radius:999px;" title="Scroll to middle C">Center</button>
              </div>
              <div class="cardBody">
                <div class="split">
                  <label>
                    Low octave
                    <select id="lowOct">
                      <option value="2">C2</option>
                      <option value="3" selected>C3</option>
                      <option value="4">C4</option>
                    </select>
                  </label>
                  <label>
                    Octaves
                    <select id="octaves">
                      <option value="2">2</option>
                      <option value="3" selected>3</option>
                      <option value="4">4</option>
                    </select>
                  </label>
                </div>
                <div style="height:10px"></div>
                <div class="split">
                  <div class="toggle">
                    <input id="useFlats" type="checkbox" />
                    <label for="useFlats" style="gap:0; font-size:13px; color:var(--muted); flex-direction:row; align-items:center;">
                      Prefer flats (Bb) vs sharps (A#)
                    </label>
                  </div>
                  <div class="toggle">
                    <input id="showLabels" type="checkbox" checked />
                    <label for="showLabels" style="gap:0; font-size:13px; color:var(--muted); flex-direction:row; align-items:center;">
                      Show key labels
                    </label>
                  </div>
                </div>
                <div style="height:12px"></div>
                <div class="hint">
                  Click/tap keys, or play with the keyboard. The trainers listen to what you play.
                </div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="card">
              <div class="cardHeader">
                <h2>Quick Tools</h2>
              </div>
              <div class="cardBody">
                <div class="split">
                  <label>
                    Root
                    <select id="root">
                      <option value="0">C</option>
                      <option value="1">C#/Db</option>
                      <option value="2">D</option>
                      <option value="3">D#/Eb</option>
                      <option value="4">E</option>
                      <option value="5">F</option>
                      <option value="6">F#/Gb</option>
                      <option value="7">G</option>
                      <option value="8">G#/Ab</option>
                      <option value="9">A</option>
                      <option value="10">A#/Bb</option>
                      <option value="11">B</option>
                    </select>
                  </label>
                  <label>
                    Scale
                    <select id="scale">
                      <option value="major" selected>Major</option>
                      <option value="natural_minor">Natural minor</option>
                      <option value="harmonic_minor">Harmonic minor</option>
                      <option value="melodic_minor">Melodic minor</option>
                      <option value="major_pent">Major pentatonic</option>
                      <option value="minor_pent">Minor pentatonic</option>
                      <option value="blues">Blues</option>
                      <option value="dorian">Dorian</option>
                      <option value="mixolydian">Mixolydian</option>
                    </select>
                  </label>
                </div>
                <div style="height:10px"></div>
                <div class="split">
                  <label>
                    Chord
                    <select id="chord">
                      <option value="maj" selected>Major</option>
                      <option value="min">Minor</option>
                      <option value="dim">Diminished</option>
                      <option value="aug">Augmented</option>
                      <option value="sus2">Sus2</option>
                      <option value="sus4">Sus4</option>
                      <option value="7">Dominant 7</option>
                      <option value="maj7">Major 7</option>
                      <option value="min7">Minor 7</option>
                    </select>
                  </label>
                  <label>
                    Playback
                    <select id="playMode">
                      <option value="blocked" selected>Chord (blocked)</option>
                      <option value="arp_up">Arpeggio up</option>
                      <option value="arp_down">Arpeggio down</option>
                      <option value="scale_up">Scale up</option>
                      <option value="scale_down">Scale down</option>
                    </select>
                  </label>
                </div>
                <div style="height:12px"></div>
                <div class="btnRow">
                  <button id="btnShow" class="btn">Show on piano</button>
                  <button id="btnPlay" class="btn primary">Play</button>
                  <button id="btnClearHighlights" class="btn ghost">Clear</button>
                </div>
                <div class="divider"></div>
                <div class="hint">
                  Use this to explore a key. In Lessons, the Circle of Fifths can also set the root.
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div id="view-playground" class="view active">
              <div class="hero">
                <div class="heroCard">
                  <div class="heroTitle">
                    <div>
                      <h3>Playground</h3>
                      <p>Build scales and chords, then hear them instantly. The piano highlights what you’re learning.</p>
                    </div>
                    <div class="miniEq" aria-hidden="true">
                      <span></span><span></span><span></span><span></span><span></span>
                    </div>
                  </div>
                  <div class="bigReadout">
                    <div>
                      <div id="readoutTitle"><span class="badge hot">C</span> <span class="badge">Major</span></div>
                      <div id="readoutNotes" style="margin-top:6px; color:var(--muted)">C • D • E • F • G • A • B</div>
                    </div>
                    <div class="right">
                      <span class="badge" id="readoutFormula">0-2-4-5-7-9-11</span>
                      <span class="badge good" id="readoutTip">Click keys to try it</span>
                    </div>
                  </div>
                  <div class="callouts">
                    <div class="callout">
                      <div class="k">Try this</div>
                      <div class="v">Play <b>I–V–vi–IV</b> in your selected key (common pop progression).</div>
                      <div class="btnRow" style="margin-top:10px">
                        <button id="btnProg" class="btn">Play progression</button>
                      </div>
                    </div>
                    <div class="callout">
                      <div class="k">Challenge</div>
                      <div class="v">Switch to Ear Training and identify notes by sound.</div>
                      <div class="btnRow" style="margin-top:10px">
                        <button id="btnGoEar" class="btn primary">Go to Ear Training</button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="heroCard">
                  <div class="heroTitle">
                    <div>
                      <h3>Live Note</h3>
                      <p>Whatever you play shows up here — with pitch, name, and frequency.</p>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                      <span class="badge" id="kbdHint">kbd: A W S E …</span>
                    </div>
                  </div>

                  <div class="bigReadout">
                    <div>
                      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
                        <span class="badge hot" id="liveName">—</span>
                        <span class="badge" id="liveMidi">midi —</span>
                        <span class="badge" id="liveHz">— Hz</span>
                      </div>
                      <div style="margin-top:8px; color:var(--muted); font-size:12px;">
                        Highlighted: <span class="badge good">scale tones</span> <span class="badge hot">root</span> <span class="badge" style="border-color:rgba(255,209,77,.55); color:rgba(255,209,77,.95)">hint</span>
                      </div>
                    </div>
                    <div class="right">
                      <span class="badge" id="tempoBadge">feel: 90bpm</span>
                    </div>
                  </div>

                  <div class="divider"></div>
                  <div class="hint">
                    <b>Pro move:</b> If a note sounds “off”, check the <b>interval</b> between notes — and train your ears in the games.
                  </div>
                </div>
              </div>
            </div>

            <div id="view-lessons" class="view">
              <div class="heroCard">
                <div class="heroTitle">
                  <div>
                    <h3>Lessons</h3>
                    <p>Explore keys with the Circle of Fifths, then build scales and chords you can hear.</p>
                  </div>
                  <div class="miniEq" aria-hidden="true">
                    <span></span><span></span><span></span><span></span><span></span>
                  </div>
                </div>
              </div>

              <div style="height:12px"></div>

              <div class="grid2">
                <div class="card">
                  <div class="cardHeader">
                    <h2>Circle of Fifths</h2>
                    <span class="badge" id="cofKeySig">C: 0♯ / 0♭</span>
                  </div>
                  <div class="cardBody">
                    <div class="cofWrap">
                      <svg class="cof" viewBox="0 0 100 100" aria-label="Circle of Fifths (click a key)">
                        <defs>
                          <radialGradient id="g0" cx="50%" cy="50%" r="70%">
                            <stop offset="0%" stop-color="rgba(123,240,255,.26)"/>
                            <stop offset="55%" stop-color="rgba(176,129,255,.12)"/>
                            <stop offset="100%" stop-color="rgba(7,10,20,.0)"/>
                          </radialGradient>
                          <linearGradient id="rim" x1="0" x2="1" y1="0" y2="1">
                            <stop offset="0" stop-color="rgba(123,240,255,.35)"/>
                            <stop offset="1" stop-color="rgba(176,129,255,.25)"/>
                          </linearGradient>
                        </defs>
                        <circle cx="50" cy="50" r="48" fill="url(#g0)" />
                        <g id="cofSegs"></g>
                        <circle cx="50" cy="50" r="20" class="center" />
                        <text x="50" y="51" text-anchor="middle" dominant-baseline="middle" style="font-size:12px; fill:rgba(234,241,255,.92)">Key</text>
                        <text id="cofCenter" x="50" y="63" text-anchor="middle" dominant-baseline="middle" style="font-size:14px; fill:rgba(123,240,255,.95)">C</text>
                      </svg>
                    </div>
                    <div style="height:10px"></div>
                    <div class="hint">
                      Click a slice to set the root for the builders. Keys to the right add sharps; keys to the left add flats.
                    </div>
                    <div class="divider"></div>
                    <div class="hint">
                      <b>Relative minor:</b> <span id="relMinor">A minor</span><br />
                      <b>Common chords in key:</b> <span id="diatonicChords">I ii iii IV V vi vii°</span>
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="cardHeader">
                    <h2>Scale & Chord Cheatsheet</h2>
                  </div>
                  <div class="cardBody">
                    <div class="hint">
                      <b>Scale formula</b> = steps from the root (in semitones).<br />
                      <b>Chord quality</b> comes from stacking thirds in the scale.
                    </div>
                    <div class="divider"></div>
                    <div class="hint">
                      <b>Major scale:</b> W W H W W W H (0-2-4-5-7-9-11)<br />
                      <b>Natural minor:</b> W H W W H W W (0-2-3-5-7-8-10)
                    </div>
                    <div class="divider"></div>
                    <div class="hint">
                      <b>Triads:</b> Major (0-4-7), Minor (0-3-7), Dim (0-3-6), Aug (0-4-8)<br />
                      <b>Sevenths:</b> 7 (0-4-7-10), maj7 (0-4-7-11), min7 (0-3-7-10)
                    </div>
                    <div class="divider"></div>
                    <div class="btnRow">
                      <button id="btnLessonScale" class="btn">Show scale tones</button>
                      <button id="btnLessonChord" class="btn">Show chord tones</button>
                      <button id="btnLessonPlayScale" class="btn primary">Play scale</button>
                    </div>
                    <div style="height:10px"></div>
                    <div class="noteList" id="lessonNoteList"></div>
                  </div>
                </div>
              </div>
            </div>

            <div id="view-ear" class="view">
              <div class="heroCard">
                <div class="heroTitle">
                  <div>
                    <h3>Ear Training</h3>
                    <p>Press <b>New</b>, listen, then answer. You can always replay — but your streak loves first-try wins.</p>
                  </div>
                  <div class="miniEq" aria-hidden="true">
                    <span></span><span></span><span></span><span></span><span></span>
                  </div>
                </div>
              </div>

              <div style="height:12px"></div>

              <div class="gameGrid">
                <div class="card">
                  <div class="cardHeader">
                    <h2>Note Ninja</h2>
                    <span class="badge" id="game1Mode">pitch class</span>
                  </div>
                  <div class="cardBody">
                    <div class="hint">
                      Listen to the note, then play it on the piano. Toggle “Octave matters” for hard mode.
                    </div>
                    <div style="height:10px"></div>
                    <div class="btnRow">
                      <button id="g1New" class="btn primary">New</button>
                      <button id="g1Replay" class="btn">Replay</button>
                      <button id="g1Reveal" class="btn ghost">Reveal</button>
                      <span class="badge" id="g1Streak">streak 0</span>
                    </div>
                    <div style="height:10px"></div>
                    <div class="toggle">
                      <input id="g1Octave" type="checkbox" />
                      <label for="g1Octave" style="gap:0; font-size:13px; color:var(--muted); flex-direction:row; align-items:center;">
                        Octave matters (hard)
                      </label>
                    </div>
                    <div class="bigReadout" style="margin-top:12px">
                      <div>
                        <div><span class="badge hot" id="g1Prompt">Press New</span></div>
                        <div style="margin-top:6px; color:var(--muted); font-size:12px;" id="g1Sub">Then play it.</div>
                      </div>
                      <div class="right">
                        <span class="badge" id="g1Last">last —</span>
                      </div>
                    </div>
                    <div class="divider"></div>
                    <div class="hint">
                      <b>Keyboard:</b> You can answer with mouse/touch or keys. Press <span style="font-family:var(--mono)">Enter</span> for next after an answer.
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="cardHeader">
                    <h2>Interval Quest</h2>
                    <span class="badge" id="g2Range">range: C3–B5</span>
                  </div>
                  <div class="cardBody">
                    <div class="hint">
                      You’ll hear two notes. Name the distance between them.
                    </div>
                    <div style="height:10px"></div>
                    <div class="btnRow">
                      <button id="g2New" class="btn primary">New</button>
                      <button id="g2Replay" class="btn">Replay</button>
                      <button id="g2Reveal" class="btn ghost">Reveal</button>
                      <span class="badge" id="g2Streak">streak 0</span>
                    </div>
                    <div class="choices" id="g2Choices"></div>
                    <div class="bigReadout" style="margin-top:12px">
                      <div>
                        <div><span class="badge hot" id="g2Prompt">Press New</span></div>
                        <div style="margin-top:6px; color:var(--muted); font-size:12px;" id="g2Sub">Then answer below.</div>
                      </div>
                      <div class="right">
                        <span class="badge" id="g2Last">last —</span>
                      </div>
                    </div>
                    <div class="divider"></div>
                    <div class="hint">
                      <b>Practice idea:</b> Sing the second note before replaying. That’s how your ear gets strong.
                    </div>
                  </div>
                </div>
              </div>

              <div style="height:12px"></div>

              <div class="card">
                <div class="cardHeader">
                  <h2>Chord Detective</h2>
                  <span class="badge" id="g3Mode">triads</span>
                </div>
                <div class="cardBody">
                  <div class="gameGrid" style="grid-template-columns: 1.1fr .9fr">
                    <div>
                      <div class="hint">
                        Listen to the chord and identify its quality. (Tip: major = “happy”, minor = “moody”.)
                      </div>
                      <div style="height:10px"></div>
                      <div class="btnRow">
                        <button id="g3New" class="btn primary">New</button>
                        <button id="g3Replay" class="btn">Replay</button>
                        <button id="g3Reveal" class="btn ghost">Reveal</button>
                        <span class="badge" id="g3Streak">streak 0</span>
                      </div>
                      <div class="bigReadout" style="margin-top:12px">
                        <div>
                          <div><span class="badge hot" id="g3Prompt">Press New</span></div>
                          <div style="margin-top:6px; color:var(--muted); font-size:12px;" id="g3Sub">Then choose a quality.</div>
                        </div>
                        <div class="right">
                          <span class="badge" id="g3Last">last —</span>
                        </div>
                      </div>
                    </div>
                    <div>
                      <div class="choices" id="g3Choices"></div>
                      <div class="divider"></div>
                      <div class="hint">
                        Want it harder? Switch the chord tool (left) to <b>7ths</b>, play a few, and come back.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="view-progress" class="view">
              <div class="heroCard">
                <div class="heroTitle">
                  <div>
                    <h3>Progress</h3>
                    <p>Track your streaks and unlock small achievements. Practice a little daily — your ear learns fast.</p>
                  </div>
                  <div class="miniEq" aria-hidden="true">
                    <span></span><span></span><span></span><span></span><span></span>
                  </div>
                </div>
              </div>
              <div style="height:12px"></div>
              <div class="card">
                <div class="cardHeader">
                  <h2>Stats</h2>
                  <button id="btnReset" class="btn ghost" style="padding:7px 10px; border-radius:999px;" title="Reset progress (keeps settings)">Reset</button>
                </div>
                <div class="cardBody">
                  <div class="statsGrid">
                    <div class="stat">
                      <div class="k">Total XP</div>
                      <div class="v" id="pXP">0</div>
                    </div>
                    <div class="stat">
                      <div class="k">Best Streak</div>
                      <div class="v" id="pBest">0</div>
                    </div>
                    <div class="stat">
                      <div class="k">Accuracy</div>
                      <div class="v" id="pAcc">—</div>
                    </div>
                  </div>
                  <div class="divider"></div>
                  <div class="hint"><b>Achievements</b></div>
                  <div class="achievements" id="achievements"></div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </main>

      <div class="pianoDock">
        <div class="pianoTop">
          <div class="now">
            <strong>Now:</strong> <span id="nowNote">—</span>
            <span style="opacity:.5">•</span>
            <strong>Game:</strong> <span id="nowGame">—</span>
          </div>
          <div class="btnRow" style="gap:8px">
            <button id="btnAudio" class="btn" title="Enable/disable audio">Toggle audio</button>
            <button id="btnDemo" class="btn ghost" title="Quick demo: C major + chord">Demo</button>
          </div>
        </div>
        <div class="pianoWrap">
          <div class="piano">
            <div class="pianoMeta">
              <span class="badge" id="rangeBadge">C3–B5</span>
              <span class="badge" id="holdBadge">hold: off</span>
            </div>
            <div id="keys" class="keys noSelect" aria-label="Piano keyboard"></div>
          </div>
        </div>
      </div>

      <div id="toast" aria-live="polite" aria-atomic="true"></div>
    </div>

    <script>
      (() => {
        "use strict";

        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
        const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

        const NOTE_NAMES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
        const NOTE_NAMES_FLAT  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
        const WHITE_PCS = new Set([0,2,4,5,7,9,11]);

        const SCALES = {
          major: { name: "Major", steps: [0,2,4,5,7,9,11], hint: "W W H W W W H" },
          natural_minor: { name: "Natural minor", steps: [0,2,3,5,7,8,10], hint: "W H W W H W W" },
          harmonic_minor: { name: "Harmonic minor", steps: [0,2,3,5,7,8,11], hint: "raised 7th" },
          melodic_minor: { name: "Melodic minor", steps: [0,2,3,5,7,9,11], hint: "raised 6th & 7th" },
          major_pent: { name: "Major pentatonic", steps: [0,2,4,7,9], hint: "5-note sparkle" },
          minor_pent: { name: "Minor pentatonic", steps: [0,3,5,7,10], hint: "bluesy backbone" },
          blues: { name: "Blues", steps: [0,3,5,6,7,10], hint: "add blue note (♭5)" },
          dorian: { name: "Dorian", steps: [0,2,3,5,7,9,10], hint: "minor with raised 6th" },
          mixolydian: { name: "Mixolydian", steps: [0,2,4,5,7,9,10], hint: "major with ♭7" },
        };

        const CHORDS = {
          maj:  { name: "Major", steps: [0,4,7] },
          min:  { name: "Minor", steps: [0,3,7] },
          dim:  { name: "Diminished", steps: [0,3,6] },
          aug:  { name: "Augmented", steps: [0,4,8] },
          sus2: { name: "Sus2", steps: [0,2,7] },
          sus4: { name: "Sus4", steps: [0,5,7] },
          "7":  { name: "7", steps: [0,4,7,10] },
          maj7: { name: "maj7", steps: [0,4,7,11] },
          min7: { name: "min7", steps: [0,3,7,10] },
        };

        const INTERVALS = [
          { id:"m2", name:"m2", semis:1 },
          { id:"M2", name:"M2", semis:2 },
          { id:"m3", name:"m3", semis:3 },
          { id:"M3", name:"M3", semis:4 },
          { id:"P4", name:"P4", semis:5 },
          { id:"TT", name:"TT", semis:6 },
          { id:"P5", name:"P5", semis:7 },
          { id:"m6", name:"m6", semis:8 },
          { id:"M6", name:"M6", semis:9 },
          { id:"m7", name:"m7", semis:10 },
          { id:"M7", name:"M7", semis:11 },
          { id:"8ve", name:"8ve", semis:12 },
        ];

        const KEYBOARD_MAP = [
          // White keys: A S D F G H J K (and L as next) + black keys: W E T Y U
          { key: "a", semi: 0 }, // C
          { key: "w", semi: 1 }, // C#
          { key: "s", semi: 2 }, // D
          { key: "e", semi: 3 }, // D#
          { key: "d", semi: 4 }, // E
          { key: "f", semi: 5 }, // F
          { key: "t", semi: 6 }, // F#
          { key: "g", semi: 7 }, // G
          { key: "y", semi: 8 }, // G#
          { key: "h", semi: 9 }, // A
          { key: "u", semi: 10 }, // A#
          { key: "j", semi: 11 }, // B
          { key: "k", semi: 12 }, // C (next octave)
        ];

        const STATE_KEY = "mtt_state_v1";
        const defaultState = () => ({
          settings: {
            wave: "triangle",
            tuning: 440,
            volume: 0.70,
            attackMs: 12,
            releaseMs: 180,
            space: 0.20,
            sustain: false,
            useFlats: false,
            showLabels: true,
            lowOct: 3,
            octaves: 3,
            rootPc: 0,
            scaleId: "major",
            chordId: "maj",
            playMode: "blocked",
          },
          progress: {
            xp: 0,
            bestStreak: 0,
            correct: 0,
            total: 0,
            g1Streak: 0,
            g2Streak: 0,
            g3Streak: 0,
          }
        });

        const loadState = () => {
          try{
            const raw = localStorage.getItem(STATE_KEY);
            if(!raw) return defaultState();
            const parsed = JSON.parse(raw);
            const s = defaultState();
            return {
              settings: { ...s.settings, ...(parsed.settings || {}) },
              progress: { ...s.progress, ...(parsed.progress || {}) },
            };
          }catch{
            return defaultState();
          }
        };

        const saveState = () => {
          try{ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }catch{}
        };

        const state = loadState();

        // Elements
        const boot = $("#boot");
        const btnStart = $("#btnStart");
        const btnSilent = $("#btnSilent");
        const btnAudio = $("#btnAudio");
        const audioDot = $("#audioDot");
        const audioStatus = $("#audioStatus");
        const xpEl = $("#xp");
        const streakEl = $("#streak");
        const nowNoteEl = $("#nowNote");
        const nowGameEl = $("#nowGame");
        const keysEl = $("#keys");
        const rangeBadge = $("#rangeBadge");
        const holdBadge = $("#holdBadge");
        const toastHost = $("#toast");

        const waveSel = $("#wave");
        const tuningSel = $("#tuning");
        const volumeR = $("#volume");
        const volVal = $("#volVal");
        const attackR = $("#attack");
        const atkVal = $("#atkVal");
        const releaseR = $("#release");
        const relVal = $("#relVal");
        const spaceR = $("#space");
        const spaceVal = $("#spaceVal");
        const sustainC = $("#sustain");
        const useFlatsC = $("#useFlats");
        const showLabelsC = $("#showLabels");
        const lowOctSel = $("#lowOct");
        const octavesSel = $("#octaves");

        const rootSel = $("#root");
        const scaleSel = $("#scale");
        const chordSel = $("#chord");
        const playModeSel = $("#playMode");
        const btnShow = $("#btnShow");
        const btnPlay = $("#btnPlay");
        const btnClearHighlights = $("#btnClearHighlights");
        const btnPanic = $("#btnPanic");
        const btnCenterC = $("#btnCenterC");
        const btnDemo = $("#btnDemo");

        const readoutTitle = $("#readoutTitle");
        const readoutNotes = $("#readoutNotes");
        const readoutFormula = $("#readoutFormula");
        const liveName = $("#liveName");
        const liveMidi = $("#liveMidi");
        const liveHz = $("#liveHz");

        const btnProg = $("#btnProg");
        const btnGoEar = $("#btnGoEar");

        const cofSegs = $("#cofSegs");
        const cofCenter = $("#cofCenter");
        const cofKeySig = $("#cofKeySig");
        const relMinor = $("#relMinor");
        const diatonicChords = $("#diatonicChords");
        const btnLessonScale = $("#btnLessonScale");
        const btnLessonChord = $("#btnLessonChord");
        const btnLessonPlayScale = $("#btnLessonPlayScale");
        const lessonNoteList = $("#lessonNoteList");

        const g1New = $("#g1New");
        const g1Replay = $("#g1Replay");
        const g1Reveal = $("#g1Reveal");
        const g1Prompt = $("#g1Prompt");
        const g1Sub = $("#g1Sub");
        const g1Last = $("#g1Last");
        const g1Streak = $("#g1Streak");
        const g1Octave = $("#g1Octave");
        const game1Mode = $("#game1Mode");

        const g2New = $("#g2New");
        const g2Replay = $("#g2Replay");
        const g2Reveal = $("#g2Reveal");
        const g2Prompt = $("#g2Prompt");
        const g2Sub = $("#g2Sub");
        const g2Last = $("#g2Last");
        const g2Streak = $("#g2Streak");
        const g2Choices = $("#g2Choices");
        const g2Range = $("#g2Range");

        const g3New = $("#g3New");
        const g3Replay = $("#g3Replay");
        const g3Reveal = $("#g3Reveal");
        const g3Prompt = $("#g3Prompt");
        const g3Sub = $("#g3Sub");
        const g3Last = $("#g3Last");
        const g3Streak = $("#g3Streak");
        const g3Choices = $("#g3Choices");

        const btnReset = $("#btnReset");
        const pXP = $("#pXP");
        const pBest = $("#pBest");
        const pAcc = $("#pAcc");
        const achievementsEl = $("#achievements");

        // Audio engine
        let audioEnabled = false;
        let audio = null;
        const active = new Map(); // midi -> voice
        let lastAudioOffToastAt = 0;

        const nudgeAudioOff = (context = "") => {
          const now = performance.now ? performance.now() : Date.now();
          if (now - lastAudioOffToastAt < 2200) return;
          lastAudioOffToastAt = now;
          toast("Audio is off", context ? `${context} • Tap “Toggle audio”` : `Tap “Toggle audio”`);
        };

        const toast = (msg, small = "") => {
          const el = document.createElement("div");
          el.className = "toast";
          el.innerHTML = `<div>${escapeHtml(msg)}</div>${small ? `<div class="small">${escapeHtml(small)}</div>` : ""}`;
          toastHost.appendChild(el);
          setTimeout(() => {
            el.style.opacity = "0";
            el.style.transform = "translateY(10px)";
            setTimeout(() => el.remove(), 260);
          }, 2000);
        };

        const escapeHtml = (s) => String(s).replace(/[&<>"']/g, (c) => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));

        const midiToFreq = (midi, a4 = 440) => a4 * Math.pow(2, (midi - 69) / 12);
        const midiToName = (midi, useFlats = false) => {
          const pc = ((midi % 12) + 12) % 12;
          const oct = Math.floor(midi / 12) - 1;
          const names = useFlats ? NOTE_NAMES_FLAT : NOTE_NAMES_SHARP;
          return `${names[pc]}${oct}`;
        };
        const pcToName = (pc, useFlats = false) => (useFlats ? NOTE_NAMES_FLAT : NOTE_NAMES_SHARP)[pc];

        const ensureAudio = async () => {
          if (audio && audio.ctx && audio.ctx.state !== "closed") {
            if (audio.ctx.state === "suspended") await audio.ctx.resume();
            return;
          }
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          if (!AudioContext) throw new Error("Web Audio not supported in this browser.");

          const ctx = new AudioContext();
          const master = ctx.createGain();
          master.gain.value = 0.7;

          const comp = ctx.createDynamicsCompressor();
          comp.threshold.value = -18;
          comp.knee.value = 26;
          comp.ratio.value = 3.8;
          comp.attack.value = 0.006;
          comp.release.value = 0.13;

          const filter = ctx.createBiquadFilter();
          filter.type = "lowpass";
          filter.frequency.value = 11000;
          filter.Q.value = 0.4;

          const delay = ctx.createDelay(1.5);
          delay.delayTime.value = 0.14;
          const feedback = ctx.createGain();
          feedback.gain.value = 0.18;
          const wet = ctx.createGain();
          wet.gain.value = 0.20;
          const dry = ctx.createGain();
          dry.gain.value = 0.85;

          delay.connect(feedback);
          feedback.connect(delay);

          // Routing: synth -> filter -> split dry/wet -> comp -> master -> dest
          filter.connect(dry);
          filter.connect(delay);
          delay.connect(wet);

          const mix = ctx.createGain();
          dry.connect(mix);
          wet.connect(mix);
          mix.connect(comp);
          comp.connect(master);
          master.connect(ctx.destination);

          audio = { ctx, master, filter, delay, feedback, wet, dry, mix };
        };

        const setAudioEnabled = async (on) => {
          audioEnabled = !!on;
          if (audioEnabled) {
            try{
              await ensureAudio();
              await audio.ctx.resume();
              audioDot.classList.add("on");
              audioStatus.textContent = "on";
              toast("Audio on", "Web Audio");
            }catch(e){
              audioEnabled = false;
              audioDot.classList.remove("on");
              audioStatus.textContent = "off";
              toast("Audio unavailable", (e && e.message) ? e.message : "");
            }
          } else {
            panic();
            if (audio && audio.ctx && audio.ctx.state !== "closed") {
              try { await audio.ctx.suspend(); } catch {}
            }
            audioDot.classList.remove("on");
            audioStatus.textContent = "off";
            toast("Audio off");
          }
          holdBadge.textContent = `hold: ${state.settings.sustain ? "on" : "off"}`;
        };

        const panic = () => {
          for (const midi of Array.from(active.keys())) noteOff(midi, true);
        };

        const updateAudioParams = () => {
          const vol = clamp(state.settings.volume, 0, 1);
          if (audio?.master) audio.master.gain.setTargetAtTime(vol, audio.ctx.currentTime, 0.01);
          const s = clamp(state.settings.space, 0, 1);
          if (audio?.wet) audio.wet.gain.setTargetAtTime(0.45 * s, audio.ctx.currentTime, 0.02);
          if (audio?.dry) audio.dry.gain.setTargetAtTime(0.95 - 0.25 * s, audio.ctx.currentTime, 0.02);
          if (audio?.feedback) audio.feedback.gain.setTargetAtTime(0.06 + 0.42 * s, audio.ctx.currentTime, 0.02);
          if (audio?.delay) audio.delay.delayTime.setTargetAtTime(0.10 + 0.20 * s, audio.ctx.currentTime, 0.02);
        };

        const noteOn = (midi, vel = 0.9) => {
          if (!audioEnabled || !audio) return;
          if (active.has(midi)) return;

          const ctx = audio.ctx;
          const now = ctx.currentTime;
          const freq = midiToFreq(midi, Number(state.settings.tuning) || 440);
          const osc = ctx.createOscillator();
          osc.type = state.settings.wave;
          osc.frequency.setValueAtTime(freq, now);

          const vca = ctx.createGain();
          const velGain = clamp(vel, 0, 1);
          const a = clamp(state.settings.attackMs / 1000, 0.001, 0.4);
          const r = clamp(state.settings.releaseMs / 1000, 0.04, 1.6);
          const sustainLevel = 0.72;

          vca.gain.setValueAtTime(0.0001, now);
          vca.gain.exponentialRampToValueAtTime(Math.max(0.0002, velGain), now + a);
          vca.gain.setTargetAtTime(velGain * sustainLevel, now + a + 0.005, 0.07);

          osc.connect(vca);
          vca.connect(audio.filter);
          osc.start(now);

          active.set(midi, { osc, vca, startedAt: now, release: r });
          markKey(midi, true);
        };

        const noteOff = (midi, immediate = false) => {
          const voice = active.get(midi);
          if (!voice || !audio) return;
          if (state.settings.sustain && !immediate) return;

          const now = audio.ctx.currentTime;
          const r = immediate ? 0.03 : voice.release;

          try{
            voice.vca.gain.cancelScheduledValues(now);
            voice.vca.gain.setValueAtTime(Math.max(0.00008, voice.vca.gain.value), now);
            voice.vca.gain.exponentialRampToValueAtTime(0.00008, now + r);
          }catch{}

          try{ voice.osc.stop(now + r + 0.02); }catch{}
          active.delete(midi);
          markKey(midi, false);
        };

        const playOneShot = async (midi, dur = 0.55, vel = 0.9) => {
          if (!audioEnabled) return nudgeAudioOff("Sound");
          await ensureAudio();
          noteOn(midi, vel);
          setTimeout(() => noteOff(midi), Math.max(80, dur * 1000));
        };

        const playChord = async (midis, { mode = "blocked", dur = 0.75 } = {}) => {
          if (!audioEnabled) return nudgeAudioOff("Chord");
          await ensureAudio();
          const unique = Array.from(new Set(midis)).sort((a,b)=>a-b);
          const vel = 0.92;
          if (mode === "blocked") {
            unique.forEach((m, i) => setTimeout(() => noteOn(m, vel - i * 0.06), i * 18));
            setTimeout(() => unique.forEach((m) => noteOff(m)), Math.max(120, dur * 1000));
            return;
          }
          if (mode === "arp_up" || mode === "arp_down") {
            const seq = mode === "arp_down" ? unique.slice().reverse() : unique;
            seq.forEach((m, i) => setTimeout(() => playOneShot(m, 0.35, 0.92 - i * 0.03), i * 180));
          }
        };

        const playScale = async (midis, { direction = "up" } = {}) => {
          if (!audioEnabled) return nudgeAudioOff("Scale");
          await ensureAudio();
          const seq = direction === "down" ? midis.slice().reverse() : midis.slice();
          seq.forEach((m, i) => setTimeout(() => playOneShot(m, 0.35, 0.86), i * 170));
        };

        // Piano rendering & interaction
        let midiLow = 48; // C3
        let midiHigh = 83; // B5
        const midiToEl = new Map();
        const pointerActive = new Map(); // pointerId -> midi

        const clearAllKeyClasses = (cls) => {
          for (const el of midiToEl.values()) el.classList.remove(cls);
        };

        const markKey = (midi, on) => {
          const el = midiToEl.get(midi);
          if (!el) return;
          el.classList.toggle("keyOn", on);
        };

        const markHintKey = (midi, on) => {
          const el = midiToEl.get(midi);
          if (!el) return;
          el.classList.toggle("hintOn", on);
        };

        const computeRange = () => {
          const lowOct = Number(state.settings.lowOct) || 3;
          const octs = Number(state.settings.octaves) || 3;
          midiLow = 12 * (lowOct + 1);
          midiHigh = midiLow + octs * 12 - 1; // inclusive
        };

        const renderPiano = () => {
          computeRange();
          midiToEl.clear();
          keysEl.innerHTML = "";
          const names = state.settings.useFlats ? NOTE_NAMES_FLAT : NOTE_NAMES_SHARP;
          const showLabels = state.settings.showLabels;

          const whiteKeys = [];
          for (let midi = midiLow; midi <= midiHigh; midi++) {
            const pc = midi % 12;
            if (WHITE_PCS.has(pc)) whiteKeys.push(midi);
          }

          for (const midi of whiteKeys) {
            const pc = midi % 12;
            const w = document.createElement("button");
            w.className = "wKey";
            w.type = "button";
            w.dataset.midi = String(midi);
            w.dataset.pc = String(pc);
            w.setAttribute("aria-label", `Piano key ${midiToName(midi, state.settings.useFlats)}`);
            if (showLabels) {
              const lab = document.createElement("div");
              lab.className = "kLabel";
              lab.textContent = names[pc];
              w.appendChild(lab);
            }

            // Add black key (sharp/flat) if exists and within range
            const hasBlack = [0,2,5,7,9].includes(pc);
            if (hasBlack) {
              const bMidi = midi + 1;
              if (bMidi <= midiHigh) {
                const bPc = bMidi % 12;
                const b = document.createElement("button");
                b.className = "bKey";
                b.type = "button";
                b.dataset.midi = String(bMidi);
                b.dataset.pc = String(bPc);
                b.setAttribute("aria-label", `Piano key ${midiToName(bMidi, state.settings.useFlats)}`);
                if (showLabels) {
                  const bl = document.createElement("div");
                  bl.className = "kLabel";
                  bl.textContent = names[bPc];
                  b.appendChild(bl);
                }
                w.appendChild(b);
                midiToEl.set(bMidi, b);
              }
            }

            keysEl.appendChild(w);
            midiToEl.set(midi, w);
          }

          rangeBadge.textContent = `${midiToName(midiLow, state.settings.useFlats)}–${midiToName(midiHigh, state.settings.useFlats)}`;
          g2Range.textContent = `range: ${midiToName(midiLow, state.settings.useFlats)}–${midiToName(midiHigh, state.settings.useFlats)}`;

          // Keep labels consistent after re-render
          updateBuildersReadout();
          saveState();
        };

        const keyFromEventTarget = (t) => {
          if (!(t instanceof Element)) return null;
          const btn = t.closest("button.wKey, button.bKey");
          if (!btn) return null;
          const midi = Number(btn.dataset.midi);
          if (!Number.isFinite(midi)) return null;
          return { midi, el: btn };
        };

        const onPlayMidi = (midi, opts = {}) => {
          const name = midiToName(midi, state.settings.useFlats);
          nowNoteEl.textContent = name;
          liveName.textContent = name;
          liveMidi.textContent = `midi ${midi}`;
          liveHz.textContent = `${midiToFreq(midi, Number(state.settings.tuning) || 440).toFixed(1)} Hz`;

          // Games listen here
          handleGameNote(midi);

          if (opts.oneShot) playOneShot(midi, opts.dur ?? 0.55, opts.vel ?? 0.9);
        };

        const pointerDownOnKey = async (e) => {
          const k = keyFromEventTarget(e.target);
          if (!k) return;
          e.preventDefault();
          if (audioEnabled) await ensureAudio();
          const pointerId = e.pointerId ?? 1;
          pointerActive.set(pointerId, k.midi);
          try{ keysEl.setPointerCapture(pointerId); }catch{}
          noteOn(k.midi, 0.92);
          onPlayMidi(k.midi);
        };

        const pointerMoveOnKey = async (e) => {
          if (!pointerActive.has(e.pointerId)) return;
          const under = document.elementFromPoint(e.clientX, e.clientY);
          const k = keyFromEventTarget(under);
          if (!k) return;
          const prev = pointerActive.get(e.pointerId);
          if (prev === k.midi) return;
          pointerActive.set(e.pointerId, k.midi);
          noteOff(prev);
          if (audioEnabled) await ensureAudio();
          noteOn(k.midi, 0.9);
          onPlayMidi(k.midi);
        };

        const pointerUpOnKey = (e) => {
          const pointerId = e.pointerId ?? 1;
          const midi = pointerActive.get(pointerId);
          if (midi == null) return;
          pointerActive.delete(pointerId);
          noteOff(midi);
        };

        keysEl.addEventListener("pointerdown", pointerDownOnKey);
        keysEl.addEventListener("pointermove", pointerMoveOnKey);
        keysEl.addEventListener("pointerup", pointerUpOnKey);
        keysEl.addEventListener("pointercancel", pointerUpOnKey);
        keysEl.addEventListener("lostpointercapture", pointerUpOnKey);

        // Builders
        const pcsForScale = (rootPc, scaleId) => {
          const sc = SCALES[scaleId] || SCALES.major;
          return sc.steps.map(s => (rootPc + s) % 12);
        };
        const pcsForChord = (rootPc, chordId) => {
          const ch = CHORDS[chordId] || CHORDS.maj;
          return ch.steps.map(s => (rootPc + s) % 12);
        };
        const scaleFormula = (scaleId) => (SCALES[scaleId] || SCALES.major).steps.join("-");
        const chordFormula = (chordId) => (CHORDS[chordId] || CHORDS.maj).steps.join("-");

        const highlightPcs = (pcs, rootPc = null) => {
          clearAllKeyClasses("scaleOn");
          clearAllKeyClasses("rootOn");
          for (let midi = midiLow; midi <= midiHigh; midi++) {
            const pc = midi % 12;
            const el = midiToEl.get(midi);
            if (!el) continue;
            if (pcs.includes(pc)) el.classList.add("scaleOn");
            if (rootPc != null && pc === rootPc) el.classList.add("rootOn");
          }
        };

        const clearHighlights = () => {
          clearAllKeyClasses("scaleOn");
          clearAllKeyClasses("rootOn");
          clearAllKeyClasses("hintOn");
        };

        const pickMidisFromPcs = (pcs, { baseMidi = null, includeOctave = true } = {}) => {
          const out = [];
          const base = baseMidi ?? clamp(60, midiLow, midiHigh); // default around middle C
          let start = base - (base % 12);
          // Try to find a root in range
          while (start < midiLow) start += 12;
          while (start + 12 > midiHigh + 12) start -= 12;
          const rootPc = pcs[0] ?? 0;
          let rootMidi = null;
          for (let m = start; m <= midiHigh; m++) {
            if (m % 12 === rootPc) { rootMidi = m; break; }
          }
          if (rootMidi == null) rootMidi = clamp(base, midiLow, midiHigh);

          pcs.forEach((pc) => {
            let best = null;
            for (let m = midiLow; m <= midiHigh; m++) {
              if (m % 12 !== pc) continue;
              const dist = Math.abs(m - rootMidi);
              if (best == null || dist < Math.abs(best - rootMidi)) best = m;
            }
            if (best != null) out.push(best);
          });
          const sorted = out.slice().sort((a,b) => a-b);
          if (!includeOctave) return sorted;
          const rootAbove = sorted[0] + 12;
          if (rootAbove <= midiHigh) sorted.push(rootAbove);
          return sorted;
        };

        const updateBuildersReadout = () => {
          const rootPc = Number(state.settings.rootPc) || 0;
          const scaleId = state.settings.scaleId;
          const sc = SCALES[scaleId] || SCALES.major;
          const pcs = pcsForScale(rootPc, scaleId);
          const names = pcs.map(pc => pcToName(pc, state.settings.useFlats));

          readoutTitle.innerHTML =
            `<span class="badge hot">${escapeHtml(pcToName(rootPc, state.settings.useFlats))}</span> ` +
            `<span class="badge">${escapeHtml(sc.name)}</span> ` +
            `<span class="badge" style="opacity:.85">${escapeHtml(sc.hint)}</span>`;
          readoutNotes.textContent = names.join(" • ");
          readoutFormula.textContent = scaleFormula(scaleId);

          // Lessons note list
          lessonNoteList.innerHTML = "";
          for (const pc of pcs) {
            const el = document.createElement("div");
            el.className = "chip";
            el.textContent = pcToName(pc, state.settings.useFlats);
            lessonNoteList.appendChild(el);
          }
        };

        // Circle of fifths
        const COF = [
          { label:"C", pc:0, sig:0, kind:"sharp" },
          { label:"G", pc:7, sig:1, kind:"sharp" },
          { label:"D", pc:2, sig:2, kind:"sharp" },
          { label:"A", pc:9, sig:3, kind:"sharp" },
          { label:"E", pc:4, sig:4, kind:"sharp" },
          { label:"B", pc:11, sig:5, kind:"sharp" },
          { label:"F#", pc:6, sig:6, kind:"sharp" },
          { label:"C#", pc:1, sig:7, kind:"sharp" },
          { label:"Ab", pc:8, sig:4, kind:"flat" },
          { label:"Eb", pc:3, sig:3, kind:"flat" },
          { label:"Bb", pc:10, sig:2, kind:"flat" },
          { label:"F", pc:5, sig:1, kind:"flat" },
        ];

        const polarToXY = (cx, cy, r, aRad) => [cx + r * Math.cos(aRad), cy + r * Math.sin(aRad)];
        const arcPath = (cx, cy, r0, r1, a0, a1) => {
          const [x0, y0] = polarToXY(cx, cy, r1, a0);
          const [x1, y1] = polarToXY(cx, cy, r1, a1);
          const [x2, y2] = polarToXY(cx, cy, r0, a1);
          const [x3, y3] = polarToXY(cx, cy, r0, a0);
          const large = (a1 - a0) > Math.PI ? 1 : 0;
          return [
            `M ${x0.toFixed(3)} ${y0.toFixed(3)}`,
            `A ${r1} ${r1} 0 ${large} 1 ${x1.toFixed(3)} ${y1.toFixed(3)}`,
            `L ${x2.toFixed(3)} ${y2.toFixed(3)}`,
            `A ${r0} ${r0} 0 ${large} 0 ${x3.toFixed(3)} ${y3.toFixed(3)}`,
            "Z"
          ].join(" ");
        };

        const renderCOF = () => {
          cofSegs.innerHTML = "";
          const cx = 50, cy = 50;
          const r0 = 22.5, r1 = 47.0;
          const step = (Math.PI * 2) / 12;
          const start = -Math.PI / 2 - step / 2;

          COF.forEach((k, i) => {
            const a0 = start + i * step;
            const a1 = a0 + step;
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", arcPath(cx, cy, r0, r1, a0, a1));
            const tint = i <= 7
              ? `rgba(123,240,255,${0.08 + i * 0.015})`
              : `rgba(176,129,255,${0.08 + (i-7) * 0.02})`;
            path.setAttribute("fill", tint);
            path.setAttribute("stroke", "rgba(34,48,90,.85)");
            path.setAttribute("stroke-width", "0.7");
            path.classList.add("seg");
            path.dataset.pc = String(k.pc);
            path.dataset.label = k.label;
            path.addEventListener("click", () => {
              state.settings.rootPc = k.pc;
              rootSel.value = String(k.pc);
              updateBuildersReadout();
              updateCOFUI();
              saveState();
              toast(`Root set to ${k.label}`, "Circle of Fifths");
            });
            cofSegs.appendChild(path);

            const mid = (a0 + a1) / 2;
            const [tx, ty] = polarToXY(cx, cy, 37.5, mid);
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", tx.toFixed(3));
            text.setAttribute("y", ty.toFixed(3));
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("dominant-baseline", "middle");
            text.textContent = k.label;
            cofSegs.appendChild(text);
          });
        };

        const updateCOFUI = () => {
          const rootPc = Number(state.settings.rootPc) || 0;
          const entry = COF.find(k => k.pc === rootPc) || COF[0];
          cofCenter.textContent = entry.label;
          const sigText = entry.sig === 0 ? "0♯ / 0♭" : (entry.kind === "sharp" ? `${entry.sig}♯` : `${entry.sig}♭`);
          cofKeySig.textContent = `${entry.label}: ${sigText}`;

          // Relative minor is down a minor third (or up 9 semis): major key -> relative minor is scale degree 6
          const relPc = (rootPc + 9) % 12;
          relMinor.textContent = `${pcToName(relPc, true)} minor`;

          // Diatonic chord qualities for major (I ii iii IV V vi vii°)
          diatonicChords.textContent = "I  ii  iii  IV  V  vi  vii°";

          // Highlight current selection ring
          $$(".cof .seg").forEach(seg => seg.classList.toggle("on", Number(seg.dataset.pc) === rootPc));
        };

        // Tabs
        const setView = (id) => {
          $$(".tab").forEach(t => t.setAttribute("aria-selected", String(t.dataset.view === id)));
          $$(".view").forEach(v => v.classList.toggle("active", v.id === `view-${id}`));
          const label = { playground:"Playground", lessons:"Lessons", ear:"Ear Training", progress:"Progress" }[id] || "—";
          nowGameEl.textContent = label;
          if (id === "progress") renderProgress();
        };

        $$(".tab").forEach(tab => tab.addEventListener("click", () => setView(tab.dataset.view)));

        // Games
        const game = {
          g1: { targetMidi: null, targetPc: null, awaiting: false, revealed: false, octaveMatters: false },
          g2: { rootMidi: null, interval: null, awaiting: false, revealed: false },
          g3: { rootMidi: null, quality: null, awaiting: false, revealed: false },
        };

        const award = (xp, goodMsg, small = "") => {
          state.progress.xp += xp;
          xpEl.textContent = String(state.progress.xp);
          pXP.textContent = String(state.progress.xp);
          if (goodMsg) toast(goodMsg, small);
          saveState();
        };

        const recordAttempt = (correct) => {
          state.progress.total += 1;
          if (correct) state.progress.correct += 1;
          const streak = correct ? (Number(streakEl.textContent) + 1) : 0;
          streakEl.textContent = String(streak);
          state.progress.bestStreak = Math.max(state.progress.bestStreak, streak);
          saveState();
          renderProgress();
        };

        const hintTarget = (midi, pitchClassOnly) => {
          clearAllKeyClasses("hintOn");
          if (pitchClassOnly) {
            for (let m = midiLow; m <= midiHigh; m++) if (m % 12 === (midi % 12)) markHintKey(m, true);
          } else {
            markHintKey(midi, true);
          }
        };

        const g1NewQ = async () => {
          clearAllKeyClasses("hintOn");
          game.g1.revealed = false;
          game.g1.awaiting = true;
          game.g1.octaveMatters = !!g1Octave.checked;
          game1Mode.textContent = game.g1.octaveMatters ? "exact pitch" : "pitch class";

          const midi = randInt(midiLow, midiHigh);
          game.g1.targetMidi = midi;
          game.g1.targetPc = midi % 12;
          g1Prompt.textContent = "Listen...";
          g1Sub.textContent = "Play the note you hear.";
          g1Last.textContent = "last —";
          hintTarget(midi, !game.g1.octaveMatters);
          await playOneShot(midi, 0.65, 0.92);
          g1Prompt.textContent = "Your turn";
        };

        const g1ReplayQ = async () => {
          if (game.g1.targetMidi == null) return;
          hintTarget(game.g1.targetMidi, !game.g1.octaveMatters);
          await playOneShot(game.g1.targetMidi, 0.65, 0.92);
        };

        const g1RevealQ = () => {
          if (game.g1.targetMidi == null) return;
          game.g1.revealed = true;
          const name = game.g1.octaveMatters
            ? midiToName(game.g1.targetMidi, state.settings.useFlats)
            : pcToName(game.g1.targetPc, state.settings.useFlats);
          g1Sub.textContent = `Answer: ${name}`;
          toast("Revealed", name);
        };

        const g2BuildChoices = () => {
          g2Choices.innerHTML = "";
          INTERVALS.forEach(it => {
            const b = document.createElement("button");
            b.className = "choice";
            b.type = "button";
            b.textContent = it.name;
            b.addEventListener("click", () => g2Answer(it.id));
            g2Choices.appendChild(b);
          });
        };

        const g2NewQ = async () => {
          clearAllKeyClasses("hintOn");
          game.g2.revealed = false;
          game.g2.awaiting = true;
          const it = INTERVALS[randInt(0, INTERVALS.length - 1)];
          game.g2.interval = it;
          const root = randInt(midiLow, midiHigh - it.semis);
          game.g2.rootMidi = root;
          g2Prompt.textContent = "Listen...";
          g2Sub.textContent = "What interval is it?";
          g2Last.textContent = "last —";
          hintTarget(root, true);
          await playOneShot(root, 0.50, 0.88);
          await sleep(260);
          await playOneShot(root + it.semis, 0.55, 0.92);
          g2Prompt.textContent = "Answer below";
        };

        const g2ReplayQ = async () => {
          if (!game.g2.interval || game.g2.rootMidi == null) return;
          const it = game.g2.interval;
          hintTarget(game.g2.rootMidi, true);
          await playOneShot(game.g2.rootMidi, 0.50, 0.88);
          await sleep(260);
          await playOneShot(game.g2.rootMidi + it.semis, 0.55, 0.92);
        };

        const g2RevealQ = () => {
          if (!game.g2.interval) return;
          game.g2.revealed = true;
          g2Sub.textContent = `Answer: ${game.g2.interval.name}`;
          toast("Revealed", game.g2.interval.name);
        };

        const g2Answer = (id) => {
          if (!game.g2.awaiting || !game.g2.interval) return;
          const correct = id === game.g2.interval.id;
          game.g2.awaiting = false;
          const nodes = $$(".choice", g2Choices);
          nodes.forEach(n => {
            const isThis = n.textContent === id;
            if (n.textContent === game.g2.interval.name) n.classList.add("good");
            else if (isThis) n.classList.add("bad");
          });
          state.progress.g2Streak = correct ? state.progress.g2Streak + 1 : 0;
          g2Streak.textContent = `streak ${state.progress.g2Streak}`;
          g2Last.textContent = `last ${correct ? "✓" : "✗"}`;
          recordAttempt(correct);
          if (correct) award(15, "Nice ear!", `Interval ${game.g2.interval.name}`);
          else toast("Not quite", `It was ${game.g2.interval.name}`);
        };

        const g3BuildChoices = () => {
          const opts = [
            { id:"maj", label:"Major" },
            { id:"min", label:"Minor" },
            { id:"dim", label:"Diminished" },
            { id:"aug", label:"Augmented" },
            { id:"sus2", label:"Sus2" },
            { id:"sus4", label:"Sus4" },
          ];
          g3Choices.innerHTML = "";
          opts.forEach(o => {
            const b = document.createElement("button");
            b.className = "choice";
            b.type = "button";
            b.textContent = o.label;
            b.dataset.id = o.id;
            b.addEventListener("click", () => g3Answer(o.id));
            g3Choices.appendChild(b);
          });
        };

        const g3NewQ = async () => {
          clearAllKeyClasses("hintOn");
          game.g3.revealed = false;
          game.g3.awaiting = true;
          const ids = ["maj","min","dim","aug","sus2","sus4"];
          const id = ids[randInt(0, ids.length - 1)];
          game.g3.quality = id;
          const root = randInt(midiLow, midiHigh - 8);
          game.g3.rootMidi = root;
          g3Prompt.textContent = "Listen...";
          g3Sub.textContent = "What quality is it?";
          g3Last.textContent = "last —";
          hintTarget(root, true);
          const pcs = CHORDS[id].steps.map(s => root + s);
          await playChord(pcs, { mode:"blocked", dur: 0.85 });
          g3Prompt.textContent = "Choose";
        };

        const g3ReplayQ = async () => {
          if (!game.g3.quality || game.g3.rootMidi == null) return;
          hintTarget(game.g3.rootMidi, true);
          const pcs = CHORDS[game.g3.quality].steps.map(s => game.g3.rootMidi + s);
          await playChord(pcs, { mode:"blocked", dur: 0.85 });
        };

        const g3RevealQ = () => {
          if (!game.g3.quality) return;
          game.g3.revealed = true;
          g3Sub.textContent = `Answer: ${CHORDS[game.g3.quality].name}`;
          toast("Revealed", CHORDS[game.g3.quality].name);
        };

        const g3Answer = (id) => {
          if (!game.g3.awaiting || !game.g3.quality) return;
          const correct = id === game.g3.quality;
          game.g3.awaiting = false;
          const nodes = $$(".choice", g3Choices);
          nodes.forEach(n => {
            const nid = n.dataset.id;
            if (nid === game.g3.quality) n.classList.add("good");
            else if (nid === id) n.classList.add("bad");
          });
          state.progress.g3Streak = correct ? state.progress.g3Streak + 1 : 0;
          g3Streak.textContent = `streak ${state.progress.g3Streak}`;
          g3Last.textContent = `last ${correct ? "✓" : "✗"}`;
          recordAttempt(correct);
          if (correct) award(18, "Chord found!", CHORDS[game.g3.quality].name);
          else toast("Close!", `It was ${CHORDS[game.g3.quality].name}`);
        };

        const handleGameNote = (midi) => {
          // Note Ninja listens to piano input
          if (game.g1.awaiting && game.g1.targetMidi != null) {
            const exact = game.g1.octaveMatters;
            const ok = exact ? (midi === game.g1.targetMidi) : ((midi % 12) === game.g1.targetPc);
            game.g1.awaiting = false;
            const ans = exact
              ? midiToName(game.g1.targetMidi, state.settings.useFlats)
              : pcToName(game.g1.targetPc, state.settings.useFlats);

            g1Last.textContent = `last ${ok ? "✓" : "✗"}`;
            g1Sub.textContent = ok ? "Nice!" : `Nope — it was ${ans}`;
            if (ok) award(12, "Got it!", ans);
            else toast("Try again", `Answer: ${ans}`);
            recordAttempt(ok);
            state.progress.g1Streak = ok ? state.progress.g1Streak + 1 : 0;
            g1Streak.textContent = `streak ${state.progress.g1Streak}`;
            clearAllKeyClasses("hintOn");
          }
        };

        const sleep = (ms) => new Promise(r => setTimeout(r, ms));
        const randInt = (a, b) => Math.floor(a + Math.random() * (b - a + 1));

        // Progress screen
        const ACHS = [
          { id:"start", title:"First Steps", desc:"Earn 10 XP", test: s => s.progress.xp >= 10 },
          { id:"streak5", title:"Hot Streak", desc:"Streak of 5", test: s => s.progress.bestStreak >= 5 },
          { id:"streak12", title:"On Fire", desc:"Streak of 12", test: s => s.progress.bestStreak >= 12 },
          { id:"acc80", title:"Sniper Ear", desc:"80% accuracy", test: s => s.progress.total >= 20 && (s.progress.correct / s.progress.total) >= 0.8 },
          { id:"xp200", title:"Theory Apprentice", desc:"Earn 200 XP", test: s => s.progress.xp >= 200 },
          { id:"xp600", title:"Ear Wizard", desc:"Earn 600 XP", test: s => s.progress.xp >= 600 },
        ];

        const renderProgress = () => {
          xpEl.textContent = String(state.progress.xp);
          pXP.textContent = String(state.progress.xp);
          pBest.textContent = String(state.progress.bestStreak);
          const acc = state.progress.total ? (100 * state.progress.correct / state.progress.total) : 0;
          pAcc.textContent = state.progress.total ? `${acc.toFixed(1)}%` : "—";

          achievementsEl.innerHTML = "";
          ACHS.forEach(a => {
            const on = a.test(state);
            const el = document.createElement("div");
            el.className = `ach ${on ? "on" : ""}`;
            el.innerHTML = `<div class="t">${escapeHtml(a.title)}</div><div class="d">${escapeHtml(a.desc)}</div>`;
            achievementsEl.appendChild(el);
          });
        };

        // UI wiring
        const syncControlsFromState = () => {
          waveSel.value = state.settings.wave;
          tuningSel.value = String(state.settings.tuning);
          volumeR.value = String(Math.round(state.settings.volume * 100));
          attackR.value = String(state.settings.attackMs);
          releaseR.value = String(state.settings.releaseMs);
          spaceR.value = String(Math.round(state.settings.space * 100));
          sustainC.checked = !!state.settings.sustain;
          useFlatsC.checked = !!state.settings.useFlats;
          showLabelsC.checked = !!state.settings.showLabels;
          lowOctSel.value = String(state.settings.lowOct);
          octavesSel.value = String(state.settings.octaves);
          rootSel.value = String(state.settings.rootPc);
          scaleSel.value = state.settings.scaleId;
          chordSel.value = state.settings.chordId;
          playModeSel.value = state.settings.playMode;

          volVal.textContent = `${Math.round(state.settings.volume * 100)}%`;
          atkVal.textContent = `${state.settings.attackMs}ms`;
          relVal.textContent = `${state.settings.releaseMs}ms`;
          spaceVal.textContent = `${Math.round(state.settings.space * 100)}%`;
          holdBadge.textContent = `hold: ${state.settings.sustain ? "on" : "off"}`;
          streakEl.textContent = "0";
          g1Streak.textContent = `streak ${state.progress.g1Streak}`;
          g2Streak.textContent = `streak ${state.progress.g2Streak}`;
          g3Streak.textContent = `streak ${state.progress.g3Streak}`;
        };

        const bindControls = () => {
          waveSel.addEventListener("change", () => { state.settings.wave = waveSel.value; saveState(); });
          tuningSel.addEventListener("change", () => { state.settings.tuning = Number(tuningSel.value); saveState(); onTuningChange(); });

          volumeR.addEventListener("input", () => {
            state.settings.volume = Number(volumeR.value) / 100;
            volVal.textContent = `${volumeR.value}%`;
            updateAudioParams();
            saveState();
          });
          attackR.addEventListener("input", () => {
            state.settings.attackMs = Number(attackR.value);
            atkVal.textContent = `${attackR.value}ms`;
            saveState();
          });
          releaseR.addEventListener("input", () => {
            state.settings.releaseMs = Number(releaseR.value);
            relVal.textContent = `${releaseR.value}ms`;
            saveState();
          });
          spaceR.addEventListener("input", () => {
            state.settings.space = Number(spaceR.value) / 100;
            spaceVal.textContent = `${spaceR.value}%`;
            updateAudioParams();
            saveState();
          });

          sustainC.addEventListener("change", () => {
            state.settings.sustain = sustainC.checked;
            holdBadge.textContent = `hold: ${state.settings.sustain ? "on" : "off"}`;
            if (!state.settings.sustain) {
              // release any held notes
              for (const midi of Array.from(active.keys())) noteOff(midi, true);
            }
            saveState();
          });

          useFlatsC.addEventListener("change", () => {
            state.settings.useFlats = useFlatsC.checked;
            renderPiano();
            updateBuildersReadout();
            updateCOFUI();
            saveState();
          });
          showLabelsC.addEventListener("change", () => {
            state.settings.showLabels = showLabelsC.checked;
            renderPiano();
            saveState();
          });
          lowOctSel.addEventListener("change", () => { state.settings.lowOct = Number(lowOctSel.value); renderPiano(); });
          octavesSel.addEventListener("change", () => { state.settings.octaves = Number(octavesSel.value); renderPiano(); });

          rootSel.addEventListener("change", () => {
            state.settings.rootPc = Number(rootSel.value);
            updateBuildersReadout();
            updateCOFUI();
            saveState();
          });
          scaleSel.addEventListener("change", () => { state.settings.scaleId = scaleSel.value; updateBuildersReadout(); saveState(); });
          chordSel.addEventListener("change", () => { state.settings.chordId = chordSel.value; saveState(); });
          playModeSel.addEventListener("change", () => { state.settings.playMode = playModeSel.value; saveState(); });

          btnShow.addEventListener("click", () => {
            const rootPc = Number(state.settings.rootPc) || 0;
            if (state.settings.playMode.startsWith("scale")) highlightPcs(pcsForScale(rootPc, state.settings.scaleId), rootPc);
            else highlightPcs(pcsForChord(rootPc, state.settings.chordId), rootPc);
          });
          btnClearHighlights.addEventListener("click", () => clearHighlights());
          btnPlay.addEventListener("click", async () => {
            const rootPc = Number(state.settings.rootPc) || 0;
            const mode = state.settings.playMode;
            if (mode === "blocked" || mode.startsWith("arp")) {
              const pcs = pcsForChord(rootPc, state.settings.chordId);
              highlightPcs(pcs, rootPc);
              const midis = pickMidisFromPcs(pcs, { includeOctave: false });
              await playChord(midis, { mode, dur: 0.85 });
            } else {
              const pcs = pcsForScale(rootPc, state.settings.scaleId);
              highlightPcs(pcs, rootPc);
              const midis = buildScaleMidis(rootPc, state.settings.scaleId);
              await playScale(midis, { direction: mode.endsWith("down") ? "down" : "up" });
            }
          });

          btnPanic.addEventListener("click", () => panic());
          btnCenterC.addEventListener("click", () => centerMiddleC());
          btnDemo.addEventListener("click", async () => {
            state.settings.rootPc = 0;
            state.settings.scaleId = "major";
            state.settings.chordId = "maj";
            syncControlsFromState();
            updateBuildersReadout();
            updateCOFUI();
            highlightPcs(pcsForScale(0, "major"), 0);
            await playScale(buildScaleMidis(0, "major"), { direction: "up" });
            await sleep(260);
            await playChord(pickMidisFromPcs(pcsForChord(0, "maj"), { includeOctave: false }), { mode:"blocked", dur: 0.85 });
          });

          btnAudio.addEventListener("click", async () => setAudioEnabled(!audioEnabled));
          btnProg.addEventListener("click", async () => playProgression());
          btnGoEar.addEventListener("click", () => setView("ear"));

          btnLessonScale.addEventListener("click", () => {
            const rp = Number(state.settings.rootPc) || 0;
            highlightPcs(pcsForScale(rp, state.settings.scaleId), rp);
          });
          btnLessonChord.addEventListener("click", () => {
            const rp = Number(state.settings.rootPc) || 0;
            highlightPcs(pcsForChord(rp, state.settings.chordId), rp);
          });
          btnLessonPlayScale.addEventListener("click", async () => {
            const rp = Number(state.settings.rootPc) || 0;
            highlightPcs(pcsForScale(rp, state.settings.scaleId), rp);
            await playScale(buildScaleMidis(rp, state.settings.scaleId), { direction: "up" });
          });

          g1New.addEventListener("click", g1NewQ);
          g1Replay.addEventListener("click", g1ReplayQ);
          g1Reveal.addEventListener("click", g1RevealQ);
          g1Octave.addEventListener("change", () => {
            game1Mode.textContent = g1Octave.checked ? "exact pitch" : "pitch class";
          });

          g2New.addEventListener("click", () => { resetChoiceStyles(g2Choices); g2NewQ(); });
          g2Replay.addEventListener("click", g2ReplayQ);
          g2Reveal.addEventListener("click", g2RevealQ);

          g3New.addEventListener("click", () => { resetChoiceStyles(g3Choices); g3NewQ(); });
          g3Replay.addEventListener("click", g3ReplayQ);
          g3Reveal.addEventListener("click", g3RevealQ);

          btnReset.addEventListener("click", () => {
            const keep = { ...state.settings };
            const fresh = defaultState();
            state.progress = { ...fresh.progress };
            state.settings = { ...keep };
            saveState();
            streakEl.textContent = "0";
            g1Streak.textContent = `streak 0`;
            g2Streak.textContent = `streak 0`;
            g3Streak.textContent = `streak 0`;
            renderProgress();
            toast("Progress reset");
          });
        };

        const resetChoiceStyles = (wrap) => {
          $$(".choice", wrap).forEach(c => { c.classList.remove("good"); c.classList.remove("bad"); });
        };

        const onTuningChange = () => {
          // Update live Hz display for currently displayed note if it’s valid
          const txt = liveMidi.textContent || "";
          const m = /midi\s+(\d+)/.exec(txt);
          if (!m) return;
          const midi = Number(m[1]);
          if (!Number.isFinite(midi)) return;
          liveHz.textContent = `${midiToFreq(midi, Number(state.settings.tuning) || 440).toFixed(1)} Hz`;
        };

        const buildScaleMidis = (rootPc, scaleId) => {
          const pcs = pcsForScale(rootPc, scaleId);
          // Find a root midi near middle of range
          const target = clamp(60, midiLow, midiHigh);
          let rootMidi = null;
          for (let m = target; m >= midiLow; m--) if (m % 12 === rootPc) { rootMidi = m; break; }
          if (rootMidi == null) for (let m = target; m <= midiHigh; m++) if (m % 12 === rootPc) { rootMidi = m; break; }
          if (rootMidi == null) rootMidi = midiLow;
          const out = [];
          const base = rootMidi - (rootMidi % 12);
          const steps = (SCALES[scaleId] || SCALES.major).steps;
          steps.forEach(s => {
            const m = base + rootPc + s;
            if (m >= midiLow && m <= midiHigh) out.push(m);
          });
          const upOct = out[0] + 12;
          if (upOct <= midiHigh) out.push(upOct);
          return out;
        };

        const playProgression = async () => {
          const rootPc = Number(state.settings.rootPc) || 0;
          // I–V–vi–IV in the selected major key
          const degs = [0, 7, 9, 5]; // root, fifth, sixth, fourth (as pitch classes offset in major)
          const names = ["I", "V", "vi", "IV"];
          const pcs = degs.map(d => (rootPc + d) % 12);
          highlightPcs(pcsForScale(rootPc, "major"), rootPc);
          toast("Progression", "I–V–vi–IV");

          for (let i = 0; i < pcs.length; i++) {
            const pc = pcs[i];
            const quality = (i === 2) ? "min" : "maj"; // vi is minor in major key
            const chordPcs = pcsForChord(pc, quality);
            const midis = pickMidisFromPcs(chordPcs, { includeOctave: false });
            await playChord(midis, { mode:"blocked", dur: 0.78 });
            await sleep(250);
            // small visual hint
            readoutTipFlash(`${names[i]} chord`);
          }
        };

        const readoutTipFlash = (txt) => {
          const el = $("#readoutTip");
          const old = el.textContent;
          el.textContent = txt;
          el.classList.add("hot");
          setTimeout(() => { el.textContent = old; el.classList.remove("hot"); }, 900);
        };

        const centerMiddleC = () => {
          const dock = $(".pianoWrap");
          const middleC = 60;
          const el = midiToEl.get(middleC);
          if (!dock || !el) return;
          const rect = el.getBoundingClientRect();
          const drect = dock.getBoundingClientRect();
          const delta = (rect.left + rect.width / 2) - (drect.left + drect.width / 2);
          dock.scrollLeft += delta;
        };

        // Keyboard input for piano
        const kbdHeld = new Map(); // key -> midi
        const kbdBaseMidi = () => {
          // Map "A" key to the C closest to middle
          const cNear = clamp(60, midiLow, midiHigh);
          let cMidi = null;
          for (let m = cNear; m >= midiLow; m--) if (m % 12 === 0) { cMidi = m; break; }
          if (cMidi == null) for (let m = cNear; m <= midiHigh; m++) if (m % 12 === 0) { cMidi = m; break; }
          return cMidi ?? midiLow;
        };

        const keyToMidi = (k) => {
          const m = KEYBOARD_MAP.find(x => x.key === k);
          if (!m) return null;
          const base = kbdBaseMidi();
          return base + m.semi;
        };

        const onKeyDown = async (e) => {
          const key = (e.key || "").toLowerCase();
          if (e.repeat) return;

          if (key === "escape") { e.preventDefault(); panic(); return; }
          if (key === " "){
            e.preventDefault();
            state.settings.sustain = !state.settings.sustain;
            sustainC.checked = state.settings.sustain;
            holdBadge.textContent = `hold: ${state.settings.sustain ? "on" : "off"}`;
            if (!state.settings.sustain) panic();
            saveState();
            toast(`Sustain ${state.settings.sustain ? "on" : "off"}`, "spacebar");
            return;
          }
          if (key === "enter") {
            if (document.activeElement && ["INPUT","SELECT","TEXTAREA","BUTTON"].includes(document.activeElement.tagName)) return;
            if (game.g1.targetMidi != null && !game.g1.awaiting) { resetForNext("g1"); g1NewQ(); }
            return;
          }
          if (key === "r") {
            if (document.activeElement && ["INPUT","SELECT","TEXTAREA"].includes(document.activeElement.tagName)) return;
            if (game.g1.targetMidi != null) g1ReplayQ();
            if (game.g2.interval != null) g2ReplayQ();
            if (game.g3.quality != null) g3ReplayQ();
            return;
          }
          if (["1","2","3","4"].includes(key)) {
            const map = { "1":"playground", "2":"lessons", "3":"ear", "4":"progress" };
            setView(map[key]);
            return;
          }

          const midi = keyToMidi(key);
          if (midi == null) return;
          if (midi < midiLow || midi > midiHigh) return;
          if (kbdHeld.has(key)) return;

          e.preventDefault();
          if (audioEnabled) await ensureAudio();
          kbdHeld.set(key, midi);
          noteOn(midi, 0.9);
          onPlayMidi(midi);
        };

        const onKeyUp = (e) => {
          const key = (e.key || "").toLowerCase();
          const midi = kbdHeld.get(key);
          if (midi == null) return;
          kbdHeld.delete(key);
          noteOff(midi);
        };

        const resetForNext = (id) => {
          if (id === "g1") { clearAllKeyClasses("hintOn"); }
          if (id === "g2") { resetChoiceStyles(g2Choices); }
          if (id === "g3") { resetChoiceStyles(g3Choices); }
        };

        // Boot
        btnStart.addEventListener("click", async () => {
          boot.style.display = "none";
          await setAudioEnabled(true);
          updateAudioParams();
          centerMiddleC();
        });
        btnSilent.addEventListener("click", async () => {
          boot.style.display = "none";
          await setAudioEnabled(false);
          centerMiddleC();
        });

        // Init
        const init = async () => {
          syncControlsFromState();
          renderPiano();
          renderCOF();
          updateCOFUI();
          updateBuildersReadout();
          g2BuildChoices();
          g3BuildChoices();
          bindControls();
          renderProgress();
          setView("playground");
          updateAudioParams();

          window.addEventListener("keydown", onKeyDown, { passive:false });
          window.addEventListener("keyup", onKeyUp, { passive:true });

          // If user already enabled audio previously, keep it off until gesture, but show intent
          audioDot.classList.remove("on");
          audioStatus.textContent = "off";

          // Gentle initial live readout
          nowNoteEl.textContent = "—";
          nowGameEl.textContent = "Playground";
          liveName.textContent = "—";
          liveMidi.textContent = "midi —";
          liveHz.textContent = "— Hz";
        };

        init();
      })();
    </script>
  </body>
</html>
