<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light" />
    <title>Target Clicker</title>
    <style>
      :root{
        --bg0:#f6fbff;
        --bg1:#f9f6ff;
        --ink:#0b1220;
        --muted:rgba(11,18,32,.68);
        --glass:rgba(255,255,255,.62);
        --glass2:rgba(255,255,255,.42);
        --stroke:rgba(15,23,42,.12);
        --shadow:0 18px 50px rgba(2,6,23,.14);
        --shadow2:0 8px 28px rgba(2,6,23,.10);
        --radius:18px;
        --ring: rgba(99,102,241,.22);
        --good:#10b981;
        --warn:#f59e0b;
        --bad:#ef4444;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color:var(--ink);
        background:
          radial-gradient(1200px 900px at 16% 18%, rgba(56,189,248,.22), transparent 60%),
          radial-gradient(900px 900px at 78% 14%, rgba(168,85,247,.20), transparent 55%),
          radial-gradient(900px 700px at 65% 78%, rgba(34,197,94,.18), transparent 55%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        overflow:hidden;
        user-select:none;
        -webkit-tap-highlight-color: transparent;
      }
      button, input{font:inherit}
      .sr-only{
        position:absolute;
        width:1px;height:1px;
        padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
      }

      #app{
        position:relative;
        height:100%;
        width:100%;
      }

      .backdrop{
        position:absolute;
        inset:-40px;
        filter: blur(35px);
        opacity:.65;
        pointer-events:none;
      }
      .blob{
        position:absolute;
        width:520px;height:520px;border-radius:999px;
        background: radial-gradient(circle at 30% 30%, rgba(99,102,241,.44), rgba(168,85,247,.24) 45%, transparent 70%);
        animation: floaty 12s ease-in-out infinite;
      }
      .blob.b2{
        width:620px;height:620px;
        left:auto; right:-160px; top:10%;
        background: radial-gradient(circle at 35% 35%, rgba(34,197,94,.36), rgba(56,189,248,.22) 50%, transparent 72%);
        animation-duration: 15s;
        animation-delay: -4s;
      }
      .blob.b1{
        left:-180px; top:-220px;
      }
      .blob.b3{
        width:540px;height:540px;
        left:18%; top:60%;
        background: radial-gradient(circle at 30% 30%, rgba(245,158,11,.28), rgba(236,72,153,.18) 55%, transparent 74%);
        animation-duration: 18s;
        animation-delay: -7s;
      }
      @keyframes floaty{
        0%,100%{transform: translate3d(0,0,0) rotate(0deg) scale(1)}
        50%{transform: translate3d(30px, -18px, 0) rotate(6deg) scale(1.04)}
      }

      .hud{
        position:absolute;
        top:14px; left:14px; right:14px;
        display:flex;
        gap:12px;
        align-items:stretch;
        z-index: 30;
        pointer-events:none;
      }
      .card{
        pointer-events:auto;
        display:flex;
        align-items:center;
        gap:10px;
        padding:10px 12px;
        border-radius: 16px;
        background: linear-gradient(180deg, var(--glass), rgba(255,255,255,.50));
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow2);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        min-height: 48px;
      }
      .card.grow{flex:1}
      .label{
        font-size:12px;
        color:var(--muted);
        letter-spacing:.02em;
      }
      .value{
        font-variant-numeric: tabular-nums;
        font-size:16px;
        font-weight: 760;
        line-height:1.1;
      }
      .chip{
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding:6px 10px;
        border-radius: 999px;
        background: rgba(15,23,42,.06);
        border: 1px solid rgba(15,23,42,.08);
        font-size: 12px;
        color: rgba(15,23,42,.78);
        white-space: nowrap;
      }
      .dot{
        width:8px;height:8px;border-radius:999px;
        background: var(--good);
        box-shadow: 0 0 0 4px rgba(16,185,129,.14);
      }
      .dot.warn{background: var(--warn); box-shadow: 0 0 0 4px rgba(245,158,11,.14);}
      .dot.bad{background: var(--bad); box-shadow: 0 0 0 4px rgba(239,68,68,.14);}

      .progress{
        flex:1;
        height:10px;
        border-radius: 999px;
        background: rgba(15,23,42,.08);
        overflow:hidden;
        position:relative;
      }
      .progress > i{
        position:absolute; inset:0;
        width:100%;
        background: linear-gradient(90deg, rgba(99,102,241,.95), rgba(34,197,94,.92));
        transform-origin: left center;
        transform: scaleX(1);
        transition: transform .08s linear;
      }

      #arena{
        position:absolute;
        inset:0;
        z-index: 10;
        outline:none;
        cursor: crosshair;
      }
      #arena::before{
        content:"";
        position:absolute;
        inset:0;
        background:
          radial-gradient(900px 500px at 50% 0%, rgba(255,255,255,.55), transparent 70%),
          radial-gradient(700px 700px at 0% 50%, rgba(255,255,255,.35), transparent 70%),
          radial-gradient(700px 700px at 100% 70%, rgba(255,255,255,.35), transparent 75%);
        pointer-events:none;
      }

      .overlay{
        position:absolute;
        inset:0;
        display:grid;
        place-items:center;
        z-index: 40;
        padding: 22px;
        pointer-events:auto;
      }
      .overlay.hidden{display:none}
      .panel{
        width:min(720px, 100%);
        border-radius: calc(var(--radius) + 6px);
        background: linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.52));
        border: 1px solid rgba(15,23,42,.12);
        box-shadow: var(--shadow);
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        overflow:hidden;
      }
      .panel .top{
        padding: 18px 18px 10px 18px;
        border-bottom: 1px solid rgba(15,23,42,.08);
        display:flex;
        justify-content: space-between;
        align-items:flex-start;
        gap:14px;
      }
      .title{
        margin:0;
        font-size: 22px;
        letter-spacing:-.02em;
      }
      .subtitle{
        margin:6px 0 0 0;
        color:var(--muted);
        line-height:1.35;
        font-size: 14px;
      }
      .kbd{
        font-size:12px;
        padding:6px 10px;
        border-radius: 12px;
        background: rgba(15,23,42,.06);
        border: 1px solid rgba(15,23,42,.10);
        color: rgba(15,23,42,.80);
        white-space: nowrap;
      }
      .panel .content{
        padding: 14px 18px 18px 18px;
        display:grid;
        gap: 12px;
      }
      .grid{
        display:grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
      }
      .stat{
        border-radius: 16px;
        background: rgba(255,255,255,.55);
        border: 1px solid rgba(15,23,42,.10);
        padding: 12px 12px;
      }
      .stat .k{
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      .stat .v{
        font-size: 18px;
        font-weight: 800;
        font-variant-numeric: tabular-nums;
      }
      .actions{
        display:flex;
        gap:10px;
        align-items:center;
        justify-content: space-between;
        flex-wrap: wrap;
        margin-top: 4px;
      }
      .btn{
        cursor:pointer;
        border: 1px solid rgba(15,23,42,.12);
        background: linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.62));
        padding: 10px 12px;
        border-radius: 14px;
        box-shadow: 0 10px 22px rgba(2,6,23,.10);
        transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
        display:inline-flex;
        align-items:center;
        gap:10px;
      }
      .btn:hover{transform: translateY(-1px); box-shadow: 0 14px 30px rgba(2,6,23,.13);}
      .btn:active{transform: translateY(0px) scale(.99)}
      .btn.primary{
        border-color: rgba(99,102,241,.32);
        background: linear-gradient(180deg, rgba(99,102,241,.18), rgba(255,255,255,.62));
      }
      .btn .icon{
        width:28px;height:28px;border-radius: 10px;
        display:grid; place-items:center;
        background: rgba(99,102,241,.14);
        border: 1px solid rgba(99,102,241,.18);
        color: rgba(67,56,202,.95);
      }
      .btn.secondary .icon{
        background: rgba(16,185,129,.12);
        border-color: rgba(16,185,129,.18);
        color: rgba(5,150,105,.95);
      }
      .btn.ghost{
        background: rgba(255,255,255,.45);
        box-shadow:none;
      }

      .hint{
        display:flex;
        gap: 10px;
        align-items:flex-start;
        padding: 12px;
        border-radius: 16px;
        background: rgba(15,23,42,.04);
        border: 1px dashed rgba(15,23,42,.16);
        color: rgba(15,23,42,.76);
        line-height:1.35;
        font-size: 13px;
      }
      .hint b{color: rgba(15,23,42,.88)}

      .target{
        position:absolute;
        left:0; top:0;
        width: var(--size);
        height: var(--size);
        border-radius: 999px;
        transform: translate3d(var(--x), var(--y), 0) scale(.55) rotate(0deg);
        filter: drop-shadow(0 16px 22px rgba(2,6,23,.12));
        will-change: transform, opacity;
        opacity: 0;
        touch-action: none;
      }
      .target > .core{
        position:absolute; inset:0;
        border-radius: 999px;
        background:
          radial-gradient(circle at 30% 28%, rgba(255,255,255,.92), rgba(255,255,255,.42) 16%, transparent 18%),
          radial-gradient(circle at 68% 34%, rgba(255,255,255,.55), transparent 33%),
          radial-gradient(circle at 40% 60%, rgba(255,255,255,.30), transparent 44%),
          conic-gradient(from 90deg,
            hsl(var(--h) 92% 62%),
            hsl(calc(var(--h) + 44) 92% 62%),
            hsl(calc(var(--h) + 88) 92% 62%),
            hsl(calc(var(--h) + 132) 92% 62%),
            hsl(var(--h) 92% 62%));
        border: 1px solid rgba(255,255,255,.55);
        box-shadow:
          inset 0 0 0 3px rgba(255,255,255,.28),
          inset 0 14px 26px rgba(255,255,255,.35),
          inset 0 -18px 30px rgba(0,0,0,.10);
        animation: wobble 800ms ease-in-out infinite;
      }
      .target > .ring{
        position:absolute;
        inset: -10%;
        border-radius:999px;
        background: radial-gradient(circle, rgba(255,255,255,.0) 55%, rgba(255,255,255,.20) 58%, rgba(255,255,255,0) 70%),
          radial-gradient(circle, rgba(99,102,241,.0) 56%, rgba(99,102,241,.22) 66%, rgba(99,102,241,0) 75%);
        opacity:.9;
        animation: pulse 780ms ease-in-out infinite;
        pointer-events:none;
      }
      .target > .cross{
        position:absolute;
        inset: 28%;
        border-radius: 999px;
        border: 1px solid rgba(15,23,42,.18);
        box-shadow: inset 0 0 0 2px rgba(255,255,255,.14);
        opacity:.95;
        pointer-events:none;
      }
      .target > .cross::before,
      .target > .cross::after{
        content:"";
        position:absolute;
        left:50%; top:50%;
        width: 84%;
        height: 2px;
        background: rgba(15,23,42,.22);
        transform: translate(-50%, -50%);
        border-radius: 999px;
      }
      .target > .cross::after{
        width: 2px;
        height: 84%;
      }
      .target.live{
        opacity: 1;
        animation: popIn 120ms cubic-bezier(.2, .9, .2, 1) forwards;
      }
      .target.exiting{
        opacity:0;
        transition: opacity 110ms ease, transform 110ms ease;
        transform: translate3d(var(--x), var(--y), 0) scale(.85) rotate(9deg);
      }
      .target.hit{
        opacity:0;
        transition: opacity 170ms ease, transform 170ms ease;
        transform: translate3d(var(--x), var(--y), 0) scale(1.22) rotate(-10deg);
      }
      @keyframes popIn{
        0%{transform: translate3d(var(--x), var(--y), 0) scale(.48) rotate(-4deg)}
        70%{transform: translate3d(var(--x), var(--y), 0) scale(1.02) rotate(3deg)}
        100%{transform: translate3d(var(--x), var(--y), 0) scale(.98) rotate(0deg)}
      }
      @keyframes pulse{
        0%,100%{transform: scale(1); opacity:.85}
        50%{transform: scale(1.08); opacity:1}
      }
      @keyframes wobble{
        0%,100%{transform: translate3d(0,0,0) rotate(-1.3deg)}
        50%{transform: translate3d(0,1px,0) rotate(1.2deg)}
      }

      .floaty{
        position:absolute;
        left:0; top:0;
        transform: translate3d(var(--x), var(--y), 0);
        font-weight: 900;
        letter-spacing: -.02em;
        font-variant-numeric: tabular-nums;
        pointer-events:none;
        z-index: 20;
        opacity: 0;
        filter: drop-shadow(0 10px 18px rgba(2,6,23,.10));
      }
      .floaty.show{
        opacity: 1;
        animation: floatUp 720ms ease-out forwards;
      }
      @keyframes floatUp{
        0%{transform: translate3d(var(--x), var(--y), 0) scale(.9)}
        20%{transform: translate3d(var(--x), calc(var(--y) - 8px), 0) scale(1)}
        100%{transform: translate3d(var(--x), calc(var(--y) - 52px), 0) scale(1); opacity:0}
      }

      .ripple{
        position:absolute;
        width: 14px; height: 14px;
        border-radius: 999px;
        border: 2px solid rgba(99,102,241,.22);
        background: rgba(99,102,241,.06);
        transform: translate3d(var(--x), var(--y), 0) translate(-50%,-50%) scale(.6);
        opacity: 0;
        pointer-events:none;
        z-index: 8;
      }
      .ripple.show{animation: ripple 420ms ease-out forwards;}
      @keyframes ripple{
        0%{opacity:0; transform: translate3d(var(--x), var(--y), 0) translate(-50%,-50%) scale(.6)}
        10%{opacity:1}
        100%{opacity:0; transform: translate3d(var(--x), var(--y), 0) translate(-50%,-50%) scale(4.2)}
      }

      #confetti{
        position:absolute;
        inset:0;
        z-index: 25;
        pointer-events:none;
      }

      .footer-tip{
        position:absolute;
        left:14px; bottom:14px;
        z-index: 30;
        pointer-events:none;
        display:flex;
        gap:10px;
        align-items:center;
        color: rgba(15,23,42,.72);
        font-size: 12px;
      }
      .footer-tip .pill{
        pointer-events:auto;
        padding:8px 10px;
        border-radius: 999px;
        background: rgba(255,255,255,.52);
        border: 1px solid rgba(15,23,42,.10);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 10px 18px rgba(2,6,23,.08);
      }

      @media (max-width: 720px){
        .hud{flex-wrap: wrap}
        .card.grow{flex: 1 1 100%}
        .grid{grid-template-columns: repeat(2, minmax(0, 1fr))}
      }
      @media (prefers-reduced-motion: reduce){
        .blob,.target > .core,.target > .ring{animation:none !important}
        .target.live{animation:none !important; opacity:1; transform: translate3d(var(--x), var(--y), 0) scale(.98)}
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="backdrop" aria-hidden="true">
        <div class="blob b1"></div>
        <div class="blob b2"></div>
        <div class="blob b3"></div>
      </div>

      <div class="hud" aria-label="Scoreboard">
        <div class="card">
          <div>
            <div class="label">Time</div>
            <div class="value"><span id="timeLeft">20.0</span>s</div>
          </div>
          <div class="chip" title="Time state">
            <span id="timeDot" class="dot"></span>
            <span id="timeState">Ready</span>
          </div>
        </div>
        <div class="card grow">
          <div style="min-width:128px">
            <div class="label">Score</div>
            <div class="value" id="score">0</div>
          </div>
          <div style="flex:1; display:grid; gap:6px">
            <div class="label" style="display:flex; justify-content:space-between; gap:10px">
              <span>Accuracy</span>
              <span class="value" style="font-size:12px; font-weight:800; color: rgba(15,23,42,.80)">
                <span id="accuracy">â€”</span>
              </span>
            </div>
            <div class="progress" aria-hidden="true">
              <i id="progressBar"></i>
            </div>
          </div>
        </div>
        <div class="card">
          <div>
            <div class="label">Hits</div>
            <div class="value"><span id="hits">0</span>/<span id="spawned">0</span></div>
          </div>
          <div class="chip" title="Streak bonus">
            <span class="dot" style="background: rgba(99,102,241,.88); box-shadow: 0 0 0 4px rgba(99,102,241,.14)"></span>
            <span><span id="streak">0</span>x</span>
          </div>
        </div>
      </div>

      <main id="arena" tabindex="0" aria-label="Target Clicker Arena">
        <div id="startOverlay" class="overlay">
          <div class="panel" role="dialog" aria-modal="true" aria-label="Start game">
            <div class="top">
              <div>
                <h1 class="title">Target Clicker</h1>
                <p class="subtitle">
                  Click the colorful targets before they disappear. You have <b>20 seconds</b>.
                  Aim for speed â€” quick hits earn extra points.
                </p>
              </div>
              <div class="kbd">Space / Enter</div>
            </div>
            <div class="content">
              <div class="hint">
                <div style="width:28px;height:28px;border-radius:10px;display:grid;place-items:center;background:rgba(99,102,241,.12);border:1px solid rgba(99,102,241,.18);color:rgba(67,56,202,.95);font-weight:900;">i</div>
                <div>
                  <b>Accuracy</b> is hits divided by total clicks. Clicking the background counts as a miss.
                  <span style="display:block; margin-top:6px; color: rgba(15,23,42,.62)">Tip: use a steady rhythm and keep your cursor near the center.</span>
                </div>
              </div>
              <div class="actions">
                <button id="startBtn" class="btn primary" type="button">
                  <span class="icon" aria-hidden="true">â–¶</span>
                  <span><b>Start</b> Â· 20s run</span>
                </button>
                <button id="toggleSound" class="btn ghost" type="button" aria-pressed="false" title="Toggle sound effects">
                  <span class="icon" aria-hidden="true">ðŸ”ˆ</span>
                  <span>Sound: <b id="soundLabel">Off</b></span>
                </button>
                <span class="kbd">R to restart</span>
              </div>
            </div>
          </div>
        </div>

        <div id="endOverlay" class="overlay hidden">
          <div class="panel" role="dialog" aria-modal="true" aria-label="Results">
            <div class="top">
              <div>
                <h2 class="title" style="margin:0">Run complete</h2>
                <p class="subtitle" id="summaryLine">Nice work.</p>
              </div>
              <div class="kbd">Space / Enter Â· Replay</div>
            </div>
            <div class="content">
              <div class="grid" aria-label="Results stats">
                <div class="stat">
                  <div class="k">Score</div>
                  <div class="v" id="rScore">0</div>
                </div>
                <div class="stat">
                  <div class="k">Accuracy</div>
                  <div class="v" id="rAccuracy">0%</div>
                </div>
                <div class="stat">
                  <div class="k">Hit rate</div>
                  <div class="v" id="rHitRate">0%</div>
                </div>
                <div class="stat">
                  <div class="k">Targets hit</div>
                  <div class="v"><span id="rHits">0</span>/<span id="rSpawned">0</span></div>
                </div>
                <div class="stat">
                  <div class="k">Miss clicks</div>
                  <div class="v" id="rMisses">0</div>
                </div>
                <div class="stat">
                  <div class="k">Avg reaction</div>
                  <div class="v" id="rReact">â€”</div>
                </div>
              </div>
              <div class="actions">
                <button id="replayBtn" class="btn primary" type="button">
                  <span class="icon" aria-hidden="true">â†»</span>
                  <span><b>Replay</b></span>
                </button>
                <button id="shareBtn" class="btn secondary" type="button" title="Copy results to clipboard">
                  <span class="icon" aria-hidden="true">â§‰</span>
                  <span>Copy results</span>
                </button>
                <button id="closeBtn" class="btn ghost" type="button" title="Back to start screen">
                  <span class="icon" aria-hidden="true">â¤º</span>
                  <span>Home</span>
                </button>
              </div>
              <div class="hint" style="margin-top:2px">
                <div style="width:28px;height:28px;border-radius:10px;display:grid;place-items:center;background:rgba(16,185,129,.10);border:1px solid rgba(16,185,129,.18);color:rgba(5,150,105,.95);font-weight:900;">+</div>
                <div>
                  Scoring: <b>10</b> base + <b>speed bonus</b> (faster clicks) + <b>streak bonus</b>.
                  Try to keep your streak alive by avoiding background clicks.
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <div class="footer-tip" aria-hidden="true">
        <div class="pill">Click targets Â· Avoid background clicks</div>
        <div class="pill">Speed + streak = more points</div>
      </div>

      <canvas id="confetti" aria-hidden="true"></canvas>
    </div>

    <script>
      (() => {
        "use strict";

        const $ = (id) => document.getElementById(id);
        const arena = $("arena");
        const startOverlay = $("startOverlay");
        const endOverlay = $("endOverlay");

        const timeLeftEl = $("timeLeft");
        const timeDot = $("timeDot");
        const timeState = $("timeState");
        const scoreEl = $("score");
        const accuracyEl = $("accuracy");
        const hitsEl = $("hits");
        const spawnedEl = $("spawned");
        const streakEl = $("streak");
        const progressBar = $("progressBar");

        const rScore = $("rScore");
        const rAccuracy = $("rAccuracy");
        const rHitRate = $("rHitRate");
        const rHits = $("rHits");
        const rSpawned = $("rSpawned");
        const rMisses = $("rMisses");
        const rReact = $("rReact");
        const summaryLine = $("summaryLine");

        const startBtn = $("startBtn");
        const replayBtn = $("replayBtn");
        const closeBtn = $("closeBtn");
        const shareBtn = $("shareBtn");
        const toggleSoundBtn = $("toggleSound");
        const soundLabel = $("soundLabel");

        const confettiCanvas = $("confetti");
        const confettiCtx = confettiCanvas.getContext("2d", { alpha: true });

        const GAME_MS = 20_000;
        const TOP_SAFE = 86; // avoid HUD area
        const EDGE_SAFE = 16;

        let rafId = 0;
        let spawnTimer = 0;
        let tickTimer = 0;
        let cleanupTimer = 0;
        let confettiRaf = 0;

        const state = {
          running: false,
          startAt: 0,
          endAt: 0,
          score: 0,
          hits: 0,
          misses: 0,
          spawned: 0,
          totalClicks: 0,
          streak: 0,
          bestStreak: 0,
          reactions: [],
          sound: false,
          summary: "Nice work."
        };

        // ---------- Utilities
        const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
        const fmtPct = (n) => `${Math.round(n)}%`;
        const fmtMs = (ms) => `${Math.round(ms)}ms`;
        const now = () => performance.now();
        const rand = (a, b) => a + Math.random() * (b - a);
        const choose = (arr) => arr[(Math.random() * arr.length) | 0];

        function setTimeState(msLeft){
          const s = msLeft / 1000;
          if (!state.running){
            timeState.textContent = "Ready";
            timeDot.className = "dot";
            return;
          }
          if (s <= 3.2){
            timeState.textContent = "Hurry";
            timeDot.className = "dot bad";
          } else if (s <= 8){
            timeState.textContent = "Go";
            timeDot.className = "dot warn";
          } else {
            timeState.textContent = "Live";
            timeDot.className = "dot";
          }
        }

        function updateHud(){
          scoreEl.textContent = String(state.score);
          hitsEl.textContent = String(state.hits);
          spawnedEl.textContent = String(state.spawned);
          streakEl.textContent = String(state.streak);
          const acc = state.totalClicks ? (state.hits / state.totalClicks) * 100 : NaN;
          accuracyEl.textContent = Number.isFinite(acc) ? fmtPct(acc) : "â€”";
        }

        function setProgress(msLeft){
          const t = clamp(msLeft / GAME_MS, 0, 1);
          progressBar.style.transform = `scaleX(${t.toFixed(4)})`;
        }

        function resizeConfetti(){
          const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
          const { innerWidth: w, innerHeight: h } = window;
          confettiCanvas.width = Math.floor(w * dpr);
          confettiCanvas.height = Math.floor(h * dpr);
          confettiCanvas.style.width = w + "px";
          confettiCanvas.style.height = h + "px";
          confettiCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        // ---------- Sound (no external assets)
        let audioCtx = null;
        function ensureAudio(){
          if (!state.sound) return null;
          if (!audioCtx){
            try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
            catch { audioCtx = null; }
          }
          if (audioCtx && audioCtx.state === "suspended") audioCtx.resume().catch(() => {});
          return audioCtx;
        }
        function beep({ freq = 520, dur = 0.05, type = "sine", gain = 0.03 } = {}){
          const ctx = ensureAudio();
          if (!ctx) return;
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = type;
          o.frequency.value = freq;
          g.gain.value = gain;
          o.connect(g);
          g.connect(ctx.destination);
          const t = ctx.currentTime;
          g.gain.setValueAtTime(gain, t);
          g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
          o.start(t);
          o.stop(t + dur + 0.01);
        }

        // ---------- Visual FX
        function addRipple(x, y){
          const el = document.createElement("div");
          el.className = "ripple";
          el.style.setProperty("--x", `${x}px`);
          el.style.setProperty("--y", `${y}px`);
          arena.appendChild(el);
          requestAnimationFrame(() => el.classList.add("show"));
          setTimeout(() => el.remove(), 520);
        }

        function addFloaty(text, x, y, color){
          const el = document.createElement("div");
          el.className = "floaty";
          el.textContent = text;
          el.style.setProperty("--x", `${x}px`);
          el.style.setProperty("--y", `${y}px`);
          el.style.color = color;
          arena.appendChild(el);
          requestAnimationFrame(() => el.classList.add("show"));
          setTimeout(() => el.remove(), 760);
        }

        function safeRect(){
          const w = window.innerWidth;
          const h = window.innerHeight;
          const top = TOP_SAFE + EDGE_SAFE;
          return {
            left: EDGE_SAFE,
            top,
            right: w - EDGE_SAFE,
            bottom: h - EDGE_SAFE
          };
        }

        function randomTargetPlacement(size){
          const r = safeRect();
          const x = rand(r.left, Math.max(r.left, r.right - size));
          const y = rand(r.top, Math.max(r.top, r.bottom - size));
          return { x, y };
        }

        function scoreForReaction(ms){
          // Base 10, speed bonus up to +10, streak bonus up to +10.
          const speedBonus = clamp(Math.round((700 - ms) / 70), 0, 10);
          const streakBonus = clamp(Math.floor(state.streak / 3), 0, 10);
          return 10 + speedBonus + streakBonus;
        }

        function difficultyFactor(){
          const t = clamp((now() - state.startAt) / GAME_MS, 0, 1);
          // Ramp in the last half: faster spawns, shorter lifetimes, slightly smaller targets.
          return t * t;
        }

        function spawnTarget(){
          if (!state.running) return;

          const df = difficultyFactor();
          const size = Math.round(rand(54 - df * 14, 80 - df * 10));
          const lifetime = Math.round(rand(850 - df * 220, 1280 - df * 260));
          const hue = Math.round(rand(0, 360));
          const { x, y } = randomTargetPlacement(size);

          const t = document.createElement("div");
          t.className = "target live";
          t.setAttribute("role", "button");
          t.setAttribute("aria-label", "Target");
          t.style.setProperty("--size", `${size}px`);
          t.style.setProperty("--x", `${x}px`);
          t.style.setProperty("--y", `${y}px`);
          t.style.setProperty("--h", `${hue}`);
          t.dataset.spawnAt = String(now());
          t.dataset.lifetime = String(lifetime);

          const ring = document.createElement("div");
          ring.className = "ring";
          const core = document.createElement("div");
          core.className = "core";
          const cross = document.createElement("div");
          cross.className = "cross";
          t.appendChild(ring);
          t.appendChild(core);
          t.appendChild(cross);

          t.addEventListener("pointerdown", (e) => {
            if (!state.running) return;
            e.preventDefault();
            e.stopPropagation();
            handleHit(t, e);
          }, { passive: false });

          arena.appendChild(t);
          state.spawned += 1;
          updateHud();

          // Auto-expire
          const expireAt = now() + lifetime;
          t.dataset.expireAt = String(expireAt);
          setTimeout(() => {
            if (!t.isConnected) return;
            if (!state.running) { t.remove(); return; }
            t.classList.remove("live");
            t.classList.add("exiting");
            state.streak = 0;
            updateHud();
            setTimeout(() => t.remove(), 150);
          }, lifetime);
        }

        function scheduleNextSpawn(){
          if (!state.running) return;
          const df = difficultyFactor();
          const delay = Math.round(rand(560 - df * 170, 900 - df * 260));
          spawnTimer = window.setTimeout(() => {
            spawnTarget();
            scheduleNextSpawn();
          }, Math.max(140, delay));
        }

        function handleHit(targetEl, e){
          state.totalClicks += 1;
          state.hits += 1;
          state.streak += 1;
          state.bestStreak = Math.max(state.bestStreak, state.streak);

          const spawnedAt = Number(targetEl.dataset.spawnAt || String(now()));
          const rt = Math.max(0, now() - spawnedAt);
          state.reactions.push(rt);

          const pts = scoreForReaction(rt);
          state.score += pts;

          const rect = arena.getBoundingClientRect();
          const x = (e.clientX ?? 0) - rect.left;
          const y = (e.clientY ?? 0) - rect.top;
          addRipple(x, y);
          const h = Number(targetEl.style.getPropertyValue("--h")) || 210;
          addFloaty(`+${pts}`, x + 12, y - 10, `hsl(${h}, 88%, 46%)`);

          targetEl.classList.remove("live");
          targetEl.classList.add("hit");
          setTimeout(() => targetEl.remove(), 180);

          if (navigator.vibrate && state.sound) navigator.vibrate(8);
          beep({ freq: 520 + Math.min(260, state.streak * 12), type: "triangle", dur: 0.055, gain: 0.028 });
          updateHud();
        }

        function handleMiss(e){
          if (!state.running) return;
          state.totalClicks += 1;
          state.misses += 1;
          state.streak = 0;
          const rect = arena.getBoundingClientRect();
          const x = (e.clientX ?? 0) - rect.left;
          const y = (e.clientY ?? 0) - rect.top;
          addRipple(x, y);
          addFloaty("miss", x + 10, y - 8, "rgba(239,68,68,.92)");
          beep({ freq: 180, type: "sine", dur: 0.06, gain: 0.02 });
          updateHud();
        }

        function clearTargets(){
          arena.querySelectorAll(".target, .floaty, .ripple").forEach((el) => el.remove());
        }

        function tick(){
          if (!state.running) return;
          const t = now();
          const msLeft = Math.max(0, state.endAt - t);
          timeLeftEl.textContent = (msLeft / 1000).toFixed(1);
          setProgress(msLeft);
          setTimeState(msLeft);
          if (msLeft <= 0) endGame();
        }

        // ---------- Confetti
        let confetti = [];
        function startConfetti(intensity){
          cancelAnimationFrame(confettiRaf);
          resizeConfetti();
          const n = Math.round(clamp(intensity, 40, 160));
          confetti = Array.from({ length: n }, () => {
            const x = rand(0, window.innerWidth);
            const y = rand(-30, window.innerHeight * 0.2);
            const vx = rand(-1.4, 1.4);
            const vy = rand(2.0, 4.8);
            const r = rand(2.5, 5.5);
            const hue = rand(0, 360);
            const spin = rand(-0.2, 0.2);
            return { x, y, vx, vy, r, hue, spin, a: rand(0, Math.PI * 2), life: rand(90, 150) };
          });
          const step = () => {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            confettiCtx.globalCompositeOperation = "source-over";
            for (const p of confetti){
              p.x += p.vx;
              p.y += p.vy;
              p.vy += 0.015;
              p.a += p.spin;
              p.life -= 1;
              const wob = Math.cos(p.a) * 0.65;
              confettiCtx.save();
              confettiCtx.translate(p.x, p.y);
              confettiCtx.rotate(p.a);
              confettiCtx.fillStyle = `hsla(${p.hue} 90% 60% / ${clamp(p.life / 90, 0, 1)})`;
              confettiCtx.fillRect(-p.r, -p.r * 0.7, p.r * 2, p.r * 1.4 + wob);
              confettiCtx.restore();
            }
            confetti = confetti.filter((p) => p.life > 0 && p.y < window.innerHeight + 60);
            if (confetti.length){
              confettiRaf = requestAnimationFrame(step);
            } else {
              confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            }
          };
          confettiRaf = requestAnimationFrame(step);
        }

        // ---------- Game flow
        function reset(){
          window.clearTimeout(spawnTimer);
          window.clearInterval(tickTimer);
          window.clearInterval(cleanupTimer);
          cancelAnimationFrame(rafId);
          cancelAnimationFrame(confettiRaf);

          state.running = false;
          state.startAt = 0;
          state.endAt = 0;
          state.score = 0;
          state.hits = 0;
          state.misses = 0;
          state.spawned = 0;
          state.totalClicks = 0;
          state.streak = 0;
          state.bestStreak = 0;
          state.reactions = [];

          timeLeftEl.textContent = "20.0";
          setProgress(GAME_MS);
          setTimeState(GAME_MS);
          updateHud();
          clearTargets();
        }

        function startGame(){
          reset();
          state.running = true;
          state.startAt = now();
          state.endAt = state.startAt + GAME_MS;

          startOverlay.classList.add("hidden");
          endOverlay.classList.add("hidden");
          arena.focus({ preventScroll: true });

          beep({ freq: 660, type: "sine", dur: 0.06, gain: 0.03 });
          window.setTimeout(() => beep({ freq: 880, type: "sine", dur: 0.06, gain: 0.03 }), 85);

          scheduleNextSpawn();
          tickTimer = window.setInterval(tick, 50);
          cleanupTimer = window.setInterval(() => {
            // opportunistic cleanup of any leaked nodes
            const stray = arena.querySelectorAll(".target.exiting, .target.hit");
            stray.forEach((el) => {
              if (el.dataset.expireAt && Number(el.dataset.expireAt) + 400 < now()) el.remove();
            });
          }, 600);
          tick();
        }

        function endGame(){
          if (!state.running) return;
          state.running = false;
          window.clearTimeout(spawnTimer);
          window.clearInterval(tickTimer);
          window.clearInterval(cleanupTimer);
          setProgress(0);
          setTimeState(0);
          timeLeftEl.textContent = "0.0";

          arena.querySelectorAll(".target").forEach((t) => t.remove());

          const acc = state.totalClicks ? (state.hits / state.totalClicks) * 100 : 0;
          const hitRate = state.spawned ? (state.hits / state.spawned) * 100 : 0;
          const avgRt = state.reactions.length
            ? (state.reactions.reduce((a, b) => a + b, 0) / state.reactions.length)
            : NaN;

          rScore.textContent = String(state.score);
          rAccuracy.textContent = fmtPct(acc);
          rHitRate.textContent = fmtPct(hitRate);
          rHits.textContent = String(state.hits);
          rSpawned.textContent = String(state.spawned);
          rMisses.textContent = String(state.misses);
          rReact.textContent = Number.isFinite(avgRt) ? fmtMs(avgRt) : "â€”";

          const tier = (() => {
            if (state.score >= 650) return { name: "Elite", msg: "Precision and speed â€” that was clinical." };
            if (state.score >= 450) return { name: "Sharp", msg: "Great rhythm. Push for a longer streak next run." };
            if (state.score >= 280) return { name: "Solid", msg: "Good foundation â€” aim a bit earlier to chain streaks." };
            return { name: "Warming up", msg: "Youâ€™re dialling it in â€” try hovering near center." };
          })();
          state.summary = `${tier.name} Â· ${tier.msg}`;
          summaryLine.textContent = state.summary;

          endOverlay.classList.remove("hidden");
          const intensity = 40 + Math.min(120, Math.floor(state.score / 6));
          startConfetti(intensity);
          beep({ freq: 520, type: "triangle", dur: 0.08, gain: 0.03 });
          window.setTimeout(() => beep({ freq: 390, type: "triangle", dur: 0.10, gain: 0.03 }), 120);
        }

        // ---------- Events
        arena.addEventListener("pointerdown", (e) => {
          if (!state.running) return;
          const target = e.target && e.target.closest ? e.target.closest(".target") : null;
          if (target) return;
          handleMiss(e);
        }, { passive: true });

        function onKey(e){
          const key = (e.key || "").toLowerCase();
          if (key === "r"){
            e.preventDefault();
            startGame();
            return;
          }
          if (key === " " || key === "enter"){
            e.preventDefault();
            if (endOverlay.classList.contains("hidden") && startOverlay.classList.contains("hidden")) return;
            startGame();
          }
        }
        window.addEventListener("keydown", onKey);
        window.addEventListener("resize", resizeConfetti);

        startBtn.addEventListener("click", startGame);
        replayBtn.addEventListener("click", startGame);
        closeBtn.addEventListener("click", () => {
          endOverlay.classList.add("hidden");
          startOverlay.classList.remove("hidden");
          reset();
        });

        shareBtn.addEventListener("click", async () => {
          const acc = state.totalClicks ? (state.hits / state.totalClicks) * 100 : 0;
          const hitRate = state.spawned ? (state.hits / state.spawned) * 100 : 0;
          const avgRt = state.reactions.length
            ? (state.reactions.reduce((a, b) => a + b, 0) / state.reactions.length)
            : NaN;
          const text =
            `Target Clicker â€” 20s\\n` +
            `Score: ${state.score}\\n` +
            `Accuracy: ${fmtPct(acc)}\\n` +
            `Hit rate: ${fmtPct(hitRate)} (${state.hits}/${state.spawned})\\n` +
            `Miss clicks: ${state.misses}\\n` +
            `Avg reaction: ${Number.isFinite(avgRt) ? fmtMs(avgRt) : "â€”"}\\n` +
            `Best streak: ${state.bestStreak}x`;
          try{
            await navigator.clipboard.writeText(text);
            beep({ freq: 880, type: "sine", dur: 0.05, gain: 0.03 });
            summaryLine.textContent = "Copied results to clipboard. Paste anywhere to share.";
            window.setTimeout(() => {
              if (!state.running) summaryLine.textContent = state.summary || "Nice work.";
            }, 1600);
          } catch {
            summaryLine.textContent = "Clipboard unavailable. (Browser blocked access.)";
          }
        });

        toggleSoundBtn.addEventListener("click", () => {
          const next = !state.sound;
          if (next){
            state.sound = true;
            beep({ freq: 740, type: "sine", dur: 0.05, gain: 0.03 });
          } else {
            beep({ freq: 260, type: "sine", dur: 0.05, gain: 0.03 });
            state.sound = false;
          }
          toggleSoundBtn.setAttribute("aria-pressed", String(state.sound));
          soundLabel.textContent = state.sound ? "On" : "Off";
          toggleSoundBtn.querySelector(".icon").textContent = state.sound ? "ðŸ”Š" : "ðŸ”ˆ";
        });

        // Boot
        reset();
        resizeConfetti();
      })();
    </script>
  </body>
</html>
