<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="#0b1020" />
    <title>Math Practice Drills</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: rgba(255, 255, 255, 0.06);
        --panel2: rgba(255, 255, 255, 0.09);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.66);
        --faint: rgba(255, 255, 255, 0.4);
        --border: rgba(255, 255, 255, 0.12);
        --accent: #7c5cff;
        --accent2: #20e3b2;
        --danger: #ff4d6d;
        --ok: #2ee59d;
        --shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
        --radius: 18px;
        --radius2: 14px;
        --ring: rgba(124, 92, 255, 0.35);
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
      }

      :root[data-theme="light"] {
        --bg: #f6f7fb;
        --panel: rgba(0, 0, 0, 0.045);
        --panel2: rgba(0, 0, 0, 0.065);
        --text: rgba(10, 16, 32, 0.92);
        --muted: rgba(10, 16, 32, 0.66);
        --faint: rgba(10, 16, 32, 0.42);
        --border: rgba(10, 16, 32, 0.12);
        --shadow: 0 18px 40px rgba(10, 16, 32, 0.14);
        --ring: rgba(124, 92, 255, 0.22);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: var(--sans);
        color: var(--text);
        background: radial-gradient(900px 500px at 20% 10%, rgba(124, 92, 255, 0.35), transparent 60%),
          radial-gradient(900px 500px at 80% 0%, rgba(32, 227, 178, 0.22), transparent 62%),
          radial-gradient(900px 700px at 50% 120%, rgba(255, 77, 109, 0.12), transparent 56%), var(--bg);
        line-height: 1.2;
      }
      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 18px 16px 30px;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 14px;
      }
      .brand {
        display: grid;
        gap: 6px;
      }
      .brand h1 {
        font-size: clamp(22px, 3.5vw, 30px);
        margin: 0;
        letter-spacing: -0.02em;
      }
      .brand p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: linear-gradient(to bottom, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
        backdrop-filter: blur(10px);
      }
      .pill .k {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
      }
      .iconbtn {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        color: var(--text);
        border-radius: 999px;
        height: 42px;
        width: 42px;
        display: grid;
        place-items: center;
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      }
      .iconbtn:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
      }
      .iconbtn:active {
        transform: translateY(0px);
      }
      .iconbtn:focus-visible {
        outline: 3px solid var(--ring);
        outline-offset: 2px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }
      @media (min-width: 900px) {
        .grid {
          grid-template-columns: 1.2fr 0.8fr;
        }
      }

      .card {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: linear-gradient(to bottom, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        overflow: hidden;
      }
      .card .hd {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .card .hd h2 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        color: var(--muted);
      }
      .card .bd {
        padding: 14px 16px 16px;
      }

      .row {
        display: grid;
        gap: 10px;
      }
      .row + .row {
        margin-top: 12px;
      }
      .label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        color: var(--muted);
        font-size: 13px;
      }

      .seg {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }
      .seg.four {
        grid-template-columns: repeat(4, 1fr);
      }
      .seg button {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        border-radius: 14px;
        padding: 10px 10px;
        color: var(--text);
        cursor: pointer;
        font-weight: 650;
        letter-spacing: -0.01em;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
        min-height: 44px;
      }
      .seg button:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.06);
      }
      .seg button[aria-pressed="true"] {
        border-color: rgba(124, 92, 255, 0.5);
        background: radial-gradient(400px 120px at 50% 0%, rgba(124, 92, 255, 0.35), rgba(255, 255, 255, 0.05));
      }
      .seg button:focus-visible {
        outline: 3px solid var(--ring);
        outline-offset: 2px;
      }

      .ops {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
      }
      .op {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        border-radius: 14px;
        padding: 10px 10px;
        min-height: 44px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        user-select: none;
        font-weight: 800;
        letter-spacing: -0.01em;
      }
      .op input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }
      .op[data-on="true"] {
        border-color: rgba(32, 227, 178, 0.55);
        background: radial-gradient(400px 120px at 50% 0%, rgba(32, 227, 178, 0.26), rgba(255, 255, 255, 0.05));
      }
      .op:focus-within {
        outline: 3px solid var(--ring);
        outline-offset: 2px;
      }

      .big {
        padding: 18px 16px 16px;
        display: grid;
        gap: 14px;
      }

      .statusbar {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      @media (min-width: 520px) {
        .statusbar {
          grid-template-columns: 1fr 1fr 1fr;
        }
      }
      .stat {
        border: 1px solid var(--border);
        border-radius: var(--radius2);
        background: rgba(255, 255, 255, 0.04);
        padding: 12px 12px;
        display: grid;
        gap: 6px;
        min-height: 76px;
      }
      .stat .t {
        color: var(--muted);
        font-size: 12px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }
      .stat .v {
        font-size: 22px;
        letter-spacing: -0.02em;
        font-weight: 850;
      }
      .stat .s {
        color: var(--muted);
        font-size: 13px;
        display: flex;
        align-items: baseline;
        gap: 10px;
        flex-wrap: wrap;
      }

      .quiz {
        display: grid;
        gap: 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        background: linear-gradient(to bottom, rgba(255, 255, 255, 0.07), rgba(255, 255, 255, 0.03));
      }

      .qtop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .ringwrap {
        display: grid;
        place-items: center;
        height: 64px;
        width: 64px;
      }
      .ringwrap svg {
        overflow: visible;
      }
      .timertext {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
        position: absolute;
        transform: translateY(1px);
      }

      .q {
        text-align: center;
        font-size: clamp(44px, 8vw, 72px);
        font-weight: 950;
        letter-spacing: -0.03em;
        padding: 10px 6px;
        text-wrap: balance;
      }
      .q .opSym {
        color: rgba(124, 92, 255, 0.95);
      }
      .q small {
        display: block;
        font-size: 14px;
        color: var(--muted);
        font-weight: 700;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        margin-top: 8px;
      }

      .answerRow {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      @media (min-width: 520px) {
        .answerRow {
          grid-template-columns: 1fr auto;
          align-items: center;
        }
      }
      .ans {
        width: 100%;
        font-size: 26px;
        padding: 14px 14px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text);
        outline: none;
        font-family: var(--mono);
      }
      .ans:focus {
        border-color: rgba(124, 92, 255, 0.55);
        box-shadow: 0 0 0 4px var(--ring);
      }

      .btn {
        border: 1px solid rgba(124, 92, 255, 0.55);
        background: radial-gradient(700px 200px at 50% 0%, rgba(124, 92, 255, 0.38), rgba(255, 255, 255, 0.03));
        color: var(--text);
        border-radius: 14px;
        padding: 14px 14px;
        font-size: 16px;
        font-weight: 850;
        cursor: pointer;
        min-height: 54px;
        letter-spacing: -0.01em;
        transition: transform 120ms ease, filter 120ms ease, border-color 120ms ease;
        user-select: none;
      }
      .btn:hover {
        transform: translateY(-1px);
        filter: saturate(1.05);
      }
      .btn:active {
        transform: translateY(0px);
      }
      .btn:focus-visible {
        outline: 3px solid var(--ring);
        outline-offset: 2px;
      }
      .btn.secondary {
        border-color: var(--border);
        background: rgba(255, 255, 255, 0.04);
        font-weight: 800;
      }
      .btn.danger {
        border-color: rgba(255, 77, 109, 0.55);
        background: radial-gradient(700px 200px at 50% 0%, rgba(255, 77, 109, 0.26), rgba(255, 255, 255, 0.03));
      }
      .btn:disabled,
      .seg button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none !important;
      }

      .feedback {
        min-height: 22px;
        font-size: 15px;
        text-align: center;
        color: var(--muted);
      }
      .feedback strong {
        color: var(--text);
      }
      .feedback.ok {
        color: rgba(46, 229, 157, 0.95);
      }
      .feedback.bad {
        color: rgba(255, 77, 109, 0.95);
      }

      details {
        border-top: 1px solid var(--border);
      }
      details summary {
        cursor: pointer;
        list-style: none;
        padding: 14px 16px;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        color: var(--muted);
        font-weight: 800;
        letter-spacing: 0.01em;
      }
      details summary::-webkit-details-marker {
        display: none;
      }
      .caret {
        width: 10px;
        height: 10px;
        border-right: 2px solid var(--muted);
        border-bottom: 2px solid var(--muted);
        transform: rotate(45deg);
        transition: transform 150ms ease;
      }
      details[open] .caret {
        transform: rotate(225deg);
      }
      .detailsBody {
        padding: 0 16px 16px;
        display: grid;
        gap: 10px;
      }
      .mini {
        display: grid;
        gap: 10px;
      }
      .mini .line {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: baseline;
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid var(--border);
      }
      .mini .line .k {
        color: var(--muted);
        font-size: 13px;
      }
      .mini .line .v {
        font-family: var(--mono);
        font-weight: 850;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
      }
      th,
      td {
        padding: 8px 8px;
        border-bottom: 1px dashed rgba(255, 255, 255, 0.12);
        text-align: left;
        white-space: nowrap;
      }
      th {
        color: var(--faint);
        font-weight: 900;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        font-size: 11px;
      }
      td strong {
        color: var(--text);
      }
      .tableWrap {
        overflow: auto;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.03);
      }

      dialog {
        border: 1px solid var(--border);
        border-radius: 20px;
        background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.04));
        color: var(--text);
        width: min(680px, calc(100% - 22px));
        box-shadow: 0 26px 80px rgba(0, 0, 0, 0.45);
        padding: 0;
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(5px);
      }
      .modalHd {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .modalHd h3 {
        margin: 0;
        font-size: 14px;
        text-transform: uppercase;
        color: var(--muted);
        letter-spacing: 0.04em;
      }
      .modalBd {
        padding: 16px;
        display: grid;
        gap: 12px;
      }
      .modalBig {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      @media (max-width: 520px) {
        .modalBig {
          grid-template-columns: 1fr;
        }
      }
      .mbox {
        border: 1px solid var(--border);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.04);
        padding: 14px 12px;
        display: grid;
        gap: 8px;
      }
      .mbox .k {
        color: var(--muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .mbox .v {
        font-size: 30px;
        font-weight: 950;
        letter-spacing: -0.02em;
      }
      .mistakes {
        border-radius: 16px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.03);
        overflow: hidden;
      }
      .mistakes .mh {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        color: var(--muted);
        font-weight: 850;
      }
      .mistakes ul {
        list-style: none;
        margin: 0;
        padding: 6px 10px 10px;
        display: grid;
        gap: 6px;
        max-height: 220px;
        overflow: auto;
      }
      .mistakes li {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 10px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        font-family: var(--mono);
        font-size: 13px;
        color: var(--muted);
      }
      .mistakes li strong {
        color: var(--text);
      }

      .shake {
        animation: shake 220ms ease-in-out;
      }
      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-6px);
        }
        50% {
          transform: translateX(6px);
        }
        75% {
          transform: translateX(-4px);
        }
        100% {
          transform: translateX(0);
        }
      }
      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
          scroll-behavior: auto !important;
        }
      }
      .sr {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="brand">
          <h1>Math Practice Drills</h1>
          <p>Timed quizzes to build speed + accuracy. Press <span class="pill"><span class="k">Space</span> start</span>.</p>
        </div>
        <div class="toolbar">
          <div class="pill" title="Keyboard shortcuts">
            <span class="k">Enter</span><span class="k">submit</span> <span class="k">R</span><span class="k">restart</span>
          </div>
          <button class="iconbtn" id="themeBtn" type="button" aria-label="Toggle theme" title="Toggle theme">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path
                d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"
                stroke="currentColor"
                stroke-width="2"
              />
              <path
                d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>
      </header>

      <div class="grid">
        <section class="card" aria-label="Quiz">
          <div class="hd">
            <h2>Quiz</h2>
            <div style="display: flex; gap: 10px; align-items: center">
              <button class="btn secondary" id="startBtn" type="button">Start</button>
              <button class="btn danger" id="stopBtn" type="button" disabled>Stop</button>
            </div>
          </div>
          <div class="big">
            <div class="statusbar" aria-label="Live stats">
              <div class="stat" role="group" aria-label="Time">
                <div class="t">Time</div>
                <div class="v" id="timeLeft">—</div>
                <div class="s">
                  <span><span id="durationLabel">60s</span> quiz</span>
                </div>
              </div>
              <div class="stat" role="group" aria-label="Score">
                <div class="t">Score</div>
                <div class="v"><span id="correct">0</span> <span style="color: var(--muted)">/</span> <span id="total">0</span></div>
                <div class="s">
                  <span><strong id="accuracy">—</strong> accuracy</span>
                  <span>streak <strong id="streak">0</strong></span>
                </div>
              </div>
              <div class="stat" role="group" aria-label="Pace">
                <div class="t">Pace</div>
                <div class="v"><span id="avgTime">—</span></div>
                <div class="s"><span>avg / question</span></div>
              </div>
            </div>

            <div class="quiz" aria-label="Problem">
              <div class="qtop">
                <div class="label" style="margin: 0">
                  <span id="difficultyLabel">Easy</span>
                  <span style="color: var(--faint)" id="opsLabel">+ − ×</span>
                </div>
                <div class="ringwrap" aria-hidden="true">
                  <div class="timertext" id="ringText">—</div>
                  <svg width="64" height="64" viewBox="0 0 64 64">
                    <circle cx="32" cy="32" r="26" stroke="rgba(255,255,255,0.12)" stroke-width="6" fill="none" />
                    <circle
                      id="ring"
                      cx="32"
                      cy="32"
                      r="26"
                      stroke="rgba(124,92,255,0.9)"
                      stroke-width="6"
                      fill="none"
                      stroke-linecap="round"
                      transform="rotate(-90 32 32)"
                      stroke-dasharray="163.36"
                      stroke-dashoffset="163.36"
                    />
                  </svg>
                </div>
              </div>

              <div class="q" id="question" aria-live="polite">
                <span style="color: var(--muted)">Press Start</span>
                <small>Answer fast. Stay accurate.</small>
              </div>

              <div class="answerRow">
                <label class="sr" for="answer">Answer</label>
                <input
                  id="answer"
                  class="ans"
                  type="text"
                  inputmode="numeric"
                  autocomplete="off"
                  autocapitalize="off"
                  spellcheck="false"
                  placeholder="Type answer…"
                  disabled
                />
                <button class="btn" id="submitBtn" type="button" disabled>Submit</button>
              </div>

              <div class="feedback" id="feedback" aria-live="polite"></div>
            </div>
          </div>
        </section>

        <aside class="card" aria-label="Settings and tracker">
          <div class="hd">
            <h2>Settings</h2>
            <span style="color: var(--muted); font-size: 13px" id="lockNote"></span>
          </div>
          <div class="bd">
            <div class="row">
              <div class="label"><span>Difficulty</span><span class="k" style="font-family: var(--mono)">1–3</span></div>
              <div class="seg" id="difficultySeg" role="group" aria-label="Difficulty">
                <button type="button" data-difficulty="easy" aria-pressed="true">Easy</button>
                <button type="button" data-difficulty="medium" aria-pressed="false">Medium</button>
                <button type="button" data-difficulty="hard" aria-pressed="false">Hard</button>
              </div>
            </div>

            <div class="row">
              <div class="label"><span>Timer</span><span class="k" style="font-family: var(--mono)">30–180</span></div>
              <div class="seg four" id="durationSeg" role="group" aria-label="Duration">
                <button type="button" data-seconds="30" aria-pressed="false">30s</button>
                <button type="button" data-seconds="60" aria-pressed="true">60s</button>
                <button type="button" data-seconds="120" aria-pressed="false">120s</button>
                <button type="button" data-seconds="180" aria-pressed="false">180s</button>
              </div>
            </div>

            <div class="row">
              <div class="label"><span>Operations</span><span class="k" style="font-family: var(--mono)">A S M D</span></div>
              <div class="ops" id="ops" role="group" aria-label="Operations">
                <label class="op" data-op="add" data-on="true" title="Addition">
                  <input type="checkbox" checked />
                  <span>+</span>
                </label>
                <label class="op" data-op="sub" data-on="true" title="Subtraction">
                  <input type="checkbox" checked />
                  <span>−</span>
                </label>
                <label class="op" data-op="mul" data-on="true" title="Multiplication">
                  <input type="checkbox" checked />
                  <span>×</span>
                </label>
                <label class="op" data-op="div" data-on="false" title="Division (integer answers)">
                  <input type="checkbox" />
                  <span>÷</span>
                </label>
              </div>
            </div>
          </div>

          <details open>
            <summary>
              <span>Score Tracker</span>
              <span class="caret" aria-hidden="true"></span>
            </summary>
            <div class="detailsBody">
              <div class="mini" aria-label="Personal bests">
                <div class="line">
                  <span class="k">Personal best (accuracy)</span>
                  <span class="v" id="bestAcc">—</span>
                </div>
                <div class="line">
                  <span class="k">Best pace (avg)</span>
                  <span class="v" id="bestPace">—</span>
                </div>
              </div>
              <div style="display: flex; gap: 10px; align-items: center; justify-content: space-between">
                <div style="color: var(--muted); font-size: 13px">Recent attempts</div>
                <button class="btn secondary" id="clearHistoryBtn" type="button" style="min-height: 44px; padding: 10px 12px">
                  Clear
                </button>
              </div>
              <div class="tableWrap" aria-label="Recent attempts table">
                <table>
                  <thead>
                    <tr>
                      <th>When</th>
                      <th>Diff</th>
                      <th>Timer</th>
                      <th>Ops</th>
                      <th>Score</th>
                      <th>Acc</th>
                      <th>Avg</th>
                      <th>Streak</th>
                    </tr>
                  </thead>
                  <tbody id="historyBody">
                    <tr>
                      <td colspan="8">No attempts yet. Start a quiz!</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div style="color: var(--muted); font-size: 12px; line-height: 1.35">
                Tip: focus on <strong>accuracy first</strong> — speed follows. Try 60s on Easy, then move up.
              </div>
            </div>
          </details>
        </aside>
      </div>
    </div>

    <dialog id="summary">
      <form method="dialog">
        <div class="modalHd">
          <h3>Summary</h3>
          <button class="iconbtn" value="close" aria-label="Close summary" title="Close">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path
                d="M18 6 6 18M6 6l12 12"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>
        </div>
        <div class="modalBd">
          <div class="modalBig">
            <div class="mbox">
              <div class="k">Score</div>
              <div class="v" id="sumScore">0/0</div>
            </div>
            <div class="mbox">
              <div class="k">Accuracy</div>
              <div class="v" id="sumAcc">—</div>
            </div>
            <div class="mbox">
              <div class="k">Avg / Q</div>
              <div class="v" id="sumAvg">—</div>
            </div>
          </div>

          <div class="mistakes" id="mistakesBox" style="display: none">
            <div class="mh">
              <span>Mistakes to review</span>
              <span style="font-family: var(--mono); font-size: 12px" id="mistakesCount"></span>
            </div>
            <ul id="mistakesList"></ul>
          </div>

          <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end">
            <button class="btn secondary" id="againBtn" value="close">Try Again</button>
            <button class="btn" id="newBtn" value="close">New Quiz</button>
          </div>
        </div>
      </form>
    </dialog>

    <script>
      (() => {
        "use strict";

        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const els = {
          themeBtn: $("#themeBtn"),
          startBtn: $("#startBtn"),
          stopBtn: $("#stopBtn"),
          submitBtn: $("#submitBtn"),
          answer: $("#answer"),
          question: $("#question"),
          feedback: $("#feedback"),
          timeLeft: $("#timeLeft"),
          ringText: $("#ringText"),
          ring: $("#ring"),
          correct: $("#correct"),
          total: $("#total"),
          accuracy: $("#accuracy"),
          streak: $("#streak"),
          avgTime: $("#avgTime"),
          durationLabel: $("#durationLabel"),
          difficultyLabel: $("#difficultyLabel"),
          opsLabel: $("#opsLabel"),
          lockNote: $("#lockNote"),
          difficultySeg: $("#difficultySeg"),
          durationSeg: $("#durationSeg"),
          ops: $("#ops"),
          bestAcc: $("#bestAcc"),
          bestPace: $("#bestPace"),
          historyBody: $("#historyBody"),
          clearHistoryBtn: $("#clearHistoryBtn"),
          summary: $("#summary"),
          sumScore: $("#sumScore"),
          sumAcc: $("#sumAcc"),
          sumAvg: $("#sumAvg"),
          mistakesBox: $("#mistakesBox"),
          mistakesCount: $("#mistakesCount"),
          mistakesList: $("#mistakesList"),
          againBtn: $("#againBtn"),
          newBtn: $("#newBtn"),
        };

        const STORAGE_KEY = "math_practice_drills_attempts_v1";
        const THEME_KEY = "math_practice_drills_theme_v1";

        const DIFFICULTIES = {
          easy: { label: "Easy", add: [0, 20], sub: [0, 20], mul: [0, 12], div: [2, 12], allowNeg: false },
          medium: { label: "Medium", add: [0, 120], sub: [0, 120], mul: [0, 25], div: [2, 25], allowNeg: true },
          hard: { label: "Hard", add: [0, 1000], sub: [0, 1000], mul: [0, 99], div: [2, 99], allowNeg: true },
        };

        const OP_INFO = {
          add: { sym: "+", label: "Addition" },
          sub: { sym: "−", label: "Subtraction" },
          mul: { sym: "×", label: "Multiplication" },
          div: { sym: "÷", label: "Division" },
        };

        function clamp01(x) {
          return Math.max(0, Math.min(1, x));
        }

        function pad2(n) {
          return String(n).padStart(2, "0");
        }

        function formatTime(ms) {
          const totalSec = Math.max(0, Math.ceil(ms / 1000));
          const m = Math.floor(totalSec / 60);
          const s = totalSec % 60;
          return m > 0 ? `${m}:${pad2(s)}` : `${s}s`;
        }

        function formatAvg(ms) {
          if (!Number.isFinite(ms) || ms <= 0) return "—";
          const s = ms / 1000;
          return s < 10 ? `${s.toFixed(2)}s` : `${s.toFixed(1)}s`;
        }

        function now() {
          return performance.now();
        }

        function randInt(min, max) {
          const lo = Math.ceil(min);
          const hi = Math.floor(max);
          return Math.floor(Math.random() * (hi - lo + 1)) + lo;
        }

        function opsSignature(opsOn) {
          return Object.keys(OP_INFO)
            .filter((k) => opsOn[k])
            .map((k) => OP_INFO[k].sym)
            .join("");
        }

        function settingsSignature(settings) {
          return `${settings.difficulty}|${settings.durationSec}|${opsSignature(settings.opsOn)}`;
        }

        function safeParseInt(text) {
          const t = String(text).trim();
          if (!t) return null;
          if (!/^-?\d+$/.test(t)) return null;
          const n = Number.parseInt(t, 10);
          if (!Number.isFinite(n)) return null;
          return n;
        }

        function pickOp(opsOn) {
          const enabled = Object.keys(OP_INFO).filter((k) => !!opsOn[k]);
          if (!enabled.length) return null;
          return enabled[randInt(0, enabled.length - 1)];
        }

        function genProblem(settings) {
          const cfg = DIFFICULTIES[settings.difficulty];
          const op = pickOp(settings.opsOn) || "add";

          if (op === "add") {
            const [min, max] = cfg.add;
            const a = randInt(min, max);
            const b = randInt(min, max);
            return { op, a, b, answer: a + b, text: `${a} ${OP_INFO.add.sym} ${b}`, sym: OP_INFO.add.sym };
          }

          if (op === "sub") {
            const [min, max] = cfg.sub;
            let a = randInt(min, max);
            let b = randInt(min, max);
            if (!cfg.allowNeg && b > a) [a, b] = [b, a];
            return { op, a, b, answer: a - b, text: `${a} ${OP_INFO.sub.sym} ${b}`, sym: OP_INFO.sub.sym };
          }

          if (op === "mul") {
            const [min, max] = cfg.mul;
            const a = randInt(min, max);
            const b = randInt(min, max);
            return { op, a, b, answer: a * b, text: `${a} ${OP_INFO.mul.sym} ${b}`, sym: OP_INFO.mul.sym };
          }

          // div: ensure integer results
          const [dMin, dMax] = cfg.div;
          const divisor = randInt(dMin, dMax);
          const qMax = settings.difficulty === "hard" ? 25 : settings.difficulty === "medium" ? 18 : 12;
          const quotient = randInt(1, qMax);
          const dividend = divisor * quotient;
          return { op, a: dividend, b: divisor, answer: quotient, text: `${dividend} ${OP_INFO.div.sym} ${divisor}`, sym: OP_INFO.div.sym };
        }

        function tryFocusAnswer() {
          requestAnimationFrame(() => {
            els.answer.focus({ preventScroll: true });
            els.answer.select();
          });
        }

        function setFeedback(kind, msg) {
          els.feedback.classList.remove("ok", "bad");
          if (kind) els.feedback.classList.add(kind);
          els.feedback.textContent = msg || "";
        }

        function bump(el) {
          el.classList.remove("shake");
          // force reflow
          void el.offsetWidth;
          el.classList.add("shake");
        }

        function setSegPressed(container, predicate) {
          $$("button", container).forEach((btn) => {
            btn.setAttribute("aria-pressed", predicate(btn) ? "true" : "false");
          });
        }

        function setLocked(locked) {
          const dis = locked;
          $$("button", els.difficultySeg).forEach((b) => (b.disabled = dis));
          $$("button", els.durationSeg).forEach((b) => (b.disabled = dis));
          $$("input", els.ops).forEach((i) => (i.disabled = dis));
          els.lockNote.textContent = locked ? "Locked during quiz" : "";
        }

        function loadAttempts() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
          } catch {
            return [];
          }
        }

        function saveAttempts(attempts) {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(attempts.slice(0, 50)));
          } catch {
            // ignore
          }
        }

        function computeBests(attempts) {
          let bestAcc = null; // {acc, desc}
          let bestPace = null; // {avgMs, desc}
          for (const a of attempts) {
            if (!a || typeof a !== "object") continue;
            if (Number.isFinite(a.accuracy)) {
              if (!bestAcc || a.accuracy > bestAcc.acc) bestAcc = { acc: a.accuracy, desc: a };
            }
            if (Number.isFinite(a.avgMs) && a.avgMs > 0) {
              if (!bestPace || a.avgMs < bestPace.avgMs) bestPace = { avgMs: a.avgMs, desc: a };
            }
          }
          return { bestAcc, bestPace };
        }

        function formatWhen(ts) {
          const d = new Date(ts);
          const hh = pad2(d.getHours());
          const mm = pad2(d.getMinutes());
          const mo = pad2(d.getMonth() + 1);
          const da = pad2(d.getDate());
          return `${mo}/${da} ${hh}:${mm}`;
        }

        function renderHistory() {
          const attempts = loadAttempts();
          const sig = settingsSignature(state.settings);
          const matching = attempts.filter((a) => a && typeof a === "object" && a.signature === sig);
          const pool = matching.length ? matching : attempts;
          const scope = matching.length ? "setup" : "all";
          const { bestAcc, bestPace } = computeBests(pool);

          els.bestAcc.textContent = bestAcc ? `${bestAcc.acc.toFixed(1)}% • ${scope}` : "—";
          els.bestPace.textContent = bestPace ? `${formatAvg(bestPace.avgMs)} • ${scope}` : "—";

          if (!attempts.length) {
            els.historyBody.innerHTML = `<tr><td colspan="8">No attempts yet. Start a quiz!</td></tr>`;
            return;
          }

          const rows = attempts.slice(0, 10).map((a) => {
            const score = `${a.correct}/${a.total}`;
            const ops = a.ops || "—";
            const acc = Number.isFinite(a.accuracy) ? `${a.accuracy.toFixed(1)}%` : "—";
            const avg = Number.isFinite(a.avgMs) ? formatAvg(a.avgMs) : "—";
            const streak = Number.isFinite(a.bestStreak) ? a.bestStreak : "—";
            return `<tr>
              <td>${formatWhen(a.ts)}</td>
              <td><strong>${String(a.difficulty || "—").slice(0, 1).toUpperCase()}</strong></td>
              <td>${a.durationSec || "—"}s</td>
              <td>${ops}</td>
              <td><strong>${score}</strong></td>
              <td>${acc}</td>
              <td>${avg}</td>
              <td>${streak}</td>
            </tr>`;
          });
          els.historyBody.innerHTML = rows.join("");
        }

        function defaultTheme() {
          const stored = localStorage.getItem(THEME_KEY);
          if (stored === "light" || stored === "dark") return stored;
          return window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";
        }

        function applyTheme(theme) {
          document.documentElement.dataset.theme = theme === "light" ? "light" : "dark";
          try {
            localStorage.setItem(THEME_KEY, theme);
          } catch {
            // ignore
          }
        }

        const state = {
          running: false,
          settings: {
            difficulty: "easy",
            durationSec: 60,
            opsOn: { add: true, sub: true, mul: true, div: false },
          },
          current: null,
          startedAt: 0,
          endsAt: 0,
          lastUiUpdate: 0,
          questionStartedAt: 0,
          stats: {
            correct: 0,
            total: 0,
            streak: 0,
            bestStreak: 0,
            responseTimesMs: [],
            mistakes: [],
          },
          rafId: 0,
        };

        function updateSettingsLabels() {
          els.durationLabel.textContent = `${state.settings.durationSec}s`;
          els.difficultyLabel.textContent = DIFFICULTIES[state.settings.difficulty].label;
          els.opsLabel.textContent = Object.keys(OP_INFO)
            .filter((k) => state.settings.opsOn[k])
            .map((k) => OP_INFO[k].sym)
            .join(" ");
        }

        function renderStats() {
          const { correct, total, streak, responseTimesMs } = state.stats;
          els.correct.textContent = String(correct);
          els.total.textContent = String(total);
          els.streak.textContent = String(streak);
          if (total === 0) els.accuracy.textContent = "—";
          else els.accuracy.textContent = `${((correct / total) * 100).toFixed(1)}%`;
          const avg = responseTimesMs.length ? responseTimesMs.reduce((a, b) => a + b, 0) / responseTimesMs.length : NaN;
          els.avgTime.textContent = formatAvg(avg);
        }

        function renderTimer(msLeft) {
          els.timeLeft.textContent = formatTime(msLeft);
          els.ringText.textContent = formatTime(msLeft);
          const totalMs = state.settings.durationSec * 1000;
          const frac = clamp01(msLeft / totalMs);
          const circumference = 2 * Math.PI * 26;
          const offset = circumference * (1 - frac);
          els.ring.style.strokeDasharray = String(circumference.toFixed(2));
          els.ring.style.strokeDashoffset = String(offset.toFixed(2));
          const danger = frac <= 0.12;
          els.ring.style.stroke = danger ? "rgba(255,77,109,0.95)" : "rgba(124,92,255,0.9)";
        }

        function setRunning(running) {
          state.running = running;
          els.startBtn.textContent = running ? "Running…" : "Start";
          els.startBtn.disabled = running;
          els.stopBtn.disabled = !running;
          els.answer.disabled = !running;
          els.submitBtn.disabled = !running;
          setLocked(running);
          if (running) tryFocusAnswer();
        }

        function renderQuestion(problem) {
          if (!problem) {
            els.question.innerHTML = `<span style="color: var(--muted)">Press Start</span><small>Answer fast. Stay accurate.</small>`;
            return;
          }
          const parts = problem.text.split(" ");
          els.question.innerHTML = `${parts[0]} <span class="opSym">${parts[1]}</span> ${parts[2]} = ?<small>Enter to submit</small>`;
        }

        function resetSession() {
          state.current = null;
          state.startedAt = 0;
          state.endsAt = 0;
          state.lastUiUpdate = 0;
          state.questionStartedAt = 0;
          state.stats = { correct: 0, total: 0, streak: 0, bestStreak: 0, responseTimesMs: [], mistakes: [] };
          els.answer.value = "";
          setFeedback("", "");
          renderStats();
          renderTimer(state.settings.durationSec * 1000);
          renderQuestion(null);
          renderHistory();
        }

        function startQuiz() {
          if (state.running) return;
          const anyOp = Object.keys(OP_INFO).some((k) => state.settings.opsOn[k]);
          if (!anyOp) {
            setFeedback("bad", "Enable at least one operation.");
            bump(els.ops);
            return;
          }

          resetSession();
          setRunning(true);
          state.startedAt = now();
          state.endsAt = state.startedAt + state.settings.durationSec * 1000;
          nextProblem();
          tick();
        }

        function stopQuiz(showSummary) {
          if (!state.running) return;
          setRunning(false);
          cancelAnimationFrame(state.rafId);
          state.rafId = 0;

          const answered = state.stats.total;
          if (answered > 0) {
            const attempt = buildAttempt();
            const attempts = loadAttempts();
            attempts.unshift(attempt);
            saveAttempts(attempts);
            renderHistory();
          }

          if (showSummary) openSummary();
          else setFeedback("", "");
        }

        function buildAttempt() {
          const { correct, total, bestStreak, responseTimesMs } = state.stats;
          const avgMs = responseTimesMs.length ? responseTimesMs.reduce((a, b) => a + b, 0) / responseTimesMs.length : NaN;
          const accuracy = total ? (correct / total) * 100 : NaN;
          return {
            ts: Date.now(),
            difficulty: state.settings.difficulty,
            durationSec: state.settings.durationSec,
            ops: opsSignature(state.settings.opsOn) || "—",
            signature: settingsSignature(state.settings),
            correct,
            total,
            accuracy,
            avgMs,
            bestStreak,
          };
        }

        function nextProblem() {
          state.current = genProblem(state.settings);
          state.questionStartedAt = now();
          renderQuestion(state.current);
          els.answer.value = "";
          tryFocusAnswer();
        }

        function submitAnswer() {
          if (!state.running || !state.current) return;
          const n = safeParseInt(els.answer.value);
          if (n === null) {
            setFeedback("bad", "Type an integer answer.");
            bump(els.answer);
            tryFocusAnswer();
            return;
          }

          const elapsed = Math.max(0, now() - state.questionStartedAt);
          state.stats.responseTimesMs.push(elapsed);
          state.stats.total += 1;

          if (n === state.current.answer) {
            state.stats.correct += 1;
            state.stats.streak += 1;
            state.stats.bestStreak = Math.max(state.stats.bestStreak, state.stats.streak);
            setFeedback("ok", `Correct • ${formatAvg(elapsed)}`);
          } else {
            state.stats.streak = 0;
            state.stats.mistakes.push({
              text: state.current.text,
              your: n,
              correct: state.current.answer,
            });
            setFeedback("bad", `Incorrect • ${state.current.text} = ${state.current.answer}`);
          }

          renderStats();
          nextProblem();
        }

        function tick() {
          if (!state.running) return;
          const t = now();
          const msLeft = state.endsAt - t;

          // update ring smoothly; update text a few times/sec
          renderTimer(msLeft);
          if (t - state.lastUiUpdate > 120) {
            state.lastUiUpdate = t;
            renderStats();
          }

          if (msLeft <= 0) {
            renderTimer(0);
            stopQuiz(true);
            return;
          }
          state.rafId = requestAnimationFrame(tick);
        }

        function openSummary() {
          const { correct, total, bestStreak, responseTimesMs, mistakes } = state.stats;
          const avgMs = responseTimesMs.length ? responseTimesMs.reduce((a, b) => a + b, 0) / responseTimesMs.length : NaN;
          const acc = total ? (correct / total) * 100 : NaN;

          els.sumScore.textContent = `${correct}/${total}`;
          els.sumAcc.textContent = Number.isFinite(acc) ? `${acc.toFixed(1)}%` : "—";
          els.sumAvg.textContent = formatAvg(avgMs);

          if (mistakes.length) {
            els.mistakesBox.style.display = "";
            els.mistakesCount.textContent = `${mistakes.length} item${mistakes.length === 1 ? "" : "s"} • best streak ${bestStreak}`;
            els.mistakesList.innerHTML = mistakes
              .slice(0, 20)
              .map((m) => `<li><span>${m.text} = <strong>${m.correct}</strong></span><span>you: <strong>${m.your}</strong></span></li>`)
              .join("");
          } else {
            els.mistakesBox.style.display = "none";
            els.mistakesList.innerHTML = "";
          }

          if (typeof els.summary.showModal === "function") els.summary.showModal();
          else els.summary.setAttribute("open", "true");
        }

        function initControls() {
          // Theme
          applyTheme(defaultTheme());
          els.themeBtn.addEventListener("click", () => {
            const current = document.documentElement.dataset.theme === "light" ? "light" : "dark";
            applyTheme(current === "light" ? "dark" : "light");
          });

          // Segmented controls
          els.difficultySeg.addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-difficulty]");
            if (!btn || btn.disabled) return;
            state.settings.difficulty = btn.dataset.difficulty;
            setSegPressed(els.difficultySeg, (b) => b.dataset.difficulty === state.settings.difficulty);
            updateSettingsLabels();
            resetSession();
          });
          els.durationSeg.addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-seconds]");
            if (!btn || btn.disabled) return;
            state.settings.durationSec = Number(btn.dataset.seconds) || 60;
            setSegPressed(els.durationSeg, (b) => Number(b.dataset.seconds) === state.settings.durationSec);
            updateSettingsLabels();
            resetSession();
          });

          // Operations
          $$("input", els.ops).forEach((i) =>
            i.addEventListener("change", () => {
              const label = i.closest(".op");
              const op = label.dataset.op;
              if (!i.checked) {
                const othersOn = Object.keys(OP_INFO).some((k) => k !== op && !!state.settings.opsOn[k]);
                if (!othersOn) {
                  i.checked = true;
                  label.dataset.on = "true";
                  state.settings.opsOn[op] = true;
                  setFeedback("bad", "Keep at least one operation enabled.");
                  bump(els.ops);
                  return;
                }
              }
              state.settings.opsOn[op] = !!i.checked;
              label.dataset.on = i.checked ? "true" : "false";
              updateSettingsLabels();
              resetSession();
            })
          );

          // Start/Stop/Submit
          els.startBtn.addEventListener("click", startQuiz);
          els.stopBtn.addEventListener("click", () => stopQuiz(true));
          els.submitBtn.addEventListener("click", submitAnswer);
          els.answer.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              submitAnswer();
            }
          });

          // Summary buttons
          els.againBtn.addEventListener("click", () => {
            // Keep settings
            startQuiz();
          });
          els.newBtn.addEventListener("click", () => {
            resetSession();
            tryFocusAnswer();
          });

          // Clear history
          els.clearHistoryBtn.addEventListener("click", () => {
            const attempts = loadAttempts();
            if (!attempts.length) return;
            const ok = confirm("Clear saved score history?");
            if (!ok) return;
            saveAttempts([]);
            renderHistory();
          });

          // Global shortcuts
          window.addEventListener("keydown", (e) => {
            if (e.defaultPrevented) return;
            const targetTag = (e.target && e.target.tagName) || "";
            const typing = targetTag === "INPUT" || targetTag === "TEXTAREA";

            if (!typing && e.code === "Space") {
              e.preventDefault();
              if (!state.running) startQuiz();
              return;
            }
            if (e.key === "r" || e.key === "R") {
              if (!typing) {
                e.preventDefault();
                stopQuiz(false);
                startQuiz();
              }
            }
            if (e.key === "Escape") {
              if (state.running) {
                e.preventDefault();
                stopQuiz(true);
              }
            }
          });
        }

        function init() {
          // Initialize segments state
          setSegPressed(els.difficultySeg, (b) => b.dataset.difficulty === state.settings.difficulty);
          setSegPressed(els.durationSeg, (b) => Number(b.dataset.seconds) === state.settings.durationSec);
          $$(".op", els.ops).forEach((label) => {
            const op = label.dataset.op;
            const input = $("input", label);
            input.checked = !!state.settings.opsOn[op];
            label.dataset.on = input.checked ? "true" : "false";
            input.setAttribute("aria-label", OP_INFO[op].label);
          });

          updateSettingsLabels();
          setLocked(false);
          resetSession();
          initControls();
        }

        init();
      })();
    </script>
  </body>
</html>
