<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0b1220" />
    <title>Micro Habit Tracker</title>
    <style>
      :root {
        --bg0: #070a13;
        --bg1: #0b1220;
        --card: rgba(255, 255, 255, 0.06);
        --card2: rgba(255, 255, 255, 0.085);
        --stroke: rgba(255, 255, 255, 0.14);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.68);
        --faint: rgba(255, 255, 255, 0.52);
        --shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
        --radius: 18px;
        --radius2: 14px;
        --focus: 0 0 0 3px rgba(100, 210, 255, 0.22);
        --good: #2fe3a7;
        --warn: #ffd166;
        --bad: #ff5f6d;
        --blue: #64d2ff;
        --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          "Apple Color Emoji", "Segoe UI Emoji";
        background:
          radial-gradient(1200px 700px at 20% 0%, rgba(100, 210, 255, 0.18), transparent 55%),
          radial-gradient(900px 600px at 90% 10%, rgba(47, 227, 167, 0.16), transparent 55%),
          radial-gradient(900px 700px at 50% 90%, rgba(255, 95, 109, 0.12), transparent 60%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        color: var(--text);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      a {
        color: inherit;
        text-decoration: none;
      }
      button,
      input,
      textarea {
        font: inherit;
        color: inherit;
      }

      .wrap {
        max-width: 1080px;
        margin: 0 auto;
        padding: 18px 14px 34px;
      }

      .topbar {
        display: flex;
        gap: 12px;
        align-items: flex-start;
        justify-content: space-between;
        padding: 12px 10px;
      }

      .brand {
        display: grid;
        gap: 6px;
      }
      .titleRow {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .appIcon {
        width: 38px;
        height: 38px;
        border-radius: 14px;
        background:
          radial-gradient(18px 18px at 30% 30%, rgba(255, 255, 255, 0.32), transparent 60%),
          linear-gradient(135deg, rgba(100, 210, 255, 0.9), rgba(47, 227, 167, 0.9));
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.32);
        position: relative;
        overflow: hidden;
      }
      .appIcon::after {
        content: "";
        position: absolute;
        inset: -40% -40%;
        background: radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.18), transparent 50%);
        transform: rotate(15deg);
      }

      h1 {
        font-size: 18px;
        margin: 0;
        letter-spacing: 0.2px;
        font-weight: 750;
      }
      .subtitle {
        color: var(--muted);
        font-size: 13px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        padding: 6px 10px;
        backdrop-filter: blur(10px);
      }
      .pill .k {
        font-size: 12px;
        color: var(--muted);
      }
      .pill .v {
        font-size: 12px;
        color: var(--text);
        font-weight: 650;
      }
      .pillDot {
        width: 9px;
        height: 9px;
        border-radius: 99px;
        background: var(--good);
        box-shadow: 0 0 0 3px rgba(47, 227, 167, 0.16);
      }
      .pillDot.warn {
        background: var(--warn);
        box-shadow: 0 0 0 3px rgba(255, 209, 102, 0.16);
      }
      .pillDot.bad {
        background: var(--bad);
        box-shadow: 0 0 0 3px rgba(255, 95, 109, 0.16);
      }

      .actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .btn {
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.07);
        border-radius: 12px;
        padding: 10px 12px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        user-select: none;
        transition: transform 120ms var(--ease), background 120ms var(--ease),
          border-color 120ms var(--ease);
        backdrop-filter: blur(10px);
      }
      .btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn:focus-visible {
        outline: none;
        box-shadow: var(--focus);
      }
      .btnPrimary {
        background: linear-gradient(135deg, rgba(100, 210, 255, 0.22), rgba(47, 227, 167, 0.18));
        border-color: rgba(100, 210, 255, 0.26);
      }
      .btnDanger {
        background: linear-gradient(135deg, rgba(255, 95, 109, 0.18), rgba(255, 95, 109, 0.06));
        border-color: rgba(255, 95, 109, 0.26);
      }
      .btnGhost {
        background: transparent;
      }
      .btnSmall {
        padding: 8px 10px;
        border-radius: 11px;
        gap: 8px;
      }
      .btnIcon {
        width: 36px;
        height: 36px;
        justify-content: center;
        padding: 0;
      }
      .btn[disabled] {
        opacity: 0.52;
        cursor: not-allowed;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }

      .panel {
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.05);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .panelHead {
        padding: 14px 14px 12px;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 14px;
      }
      .panelTitle {
        display: grid;
        gap: 4px;
      }
      .panelTitle h2 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.2px;
        color: var(--text);
      }
      .panelTitle .hint {
        margin: 0;
        font-size: 12px;
        color: var(--muted);
      }

      .panelBody {
        padding: 0 12px 12px;
      }

      .chartWrap {
        padding: 10px 10px 4px;
      }
      .chartCard {
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03));
        border-radius: 16px;
        padding: 10px 10px 12px;
      }
      .chartLegend {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .chartLegend .k {
        font-size: 12px;
        color: var(--muted);
      }
      .chartLegend .v {
        font-size: 12px;
        color: var(--text);
        font-weight: 650;
      }

      canvas {
        width: 100%;
        height: 92px;
        display: block;
      }

      .grid {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr;
      }
      @media (min-width: 720px) {
        .grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      @media (min-width: 980px) {
        .grid {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
      }

      .habit {
        border-radius: var(--radius);
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.05);
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.26);
        overflow: hidden;
        position: relative;
      }
      .habit::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(600px 220px at 20% 0%, rgba(255, 255, 255, 0.07), transparent 60%);
        pointer-events: none;
      }

      .habitInner {
        padding: 12px 12px 12px;
        display: grid;
        gap: 10px;
        position: relative;
      }

      .habitTop {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        justify-content: space-between;
      }
      .habitNameRow {
        display: flex;
        gap: 10px;
        align-items: center;
        min-width: 0;
      }
      .swatch {
        width: 12px;
        height: 12px;
        border-radius: 99px;
        box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.07);
        flex: 0 0 auto;
      }
      .habitName {
        font-weight: 720;
        letter-spacing: 0.2px;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .habitMeta {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 6px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 6px 10px;
        background: rgba(0, 0, 0, 0.16);
      }
      .badge strong {
        font-weight: 740;
      }
      .badge span {
        font-size: 12px;
        color: var(--muted);
      }

      .habitBtns {
        display: flex;
        gap: 8px;
        align-items: center;
        flex: 0 0 auto;
      }

      .todayRow {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .toggle {
        width: 100%;
        justify-content: center;
        gap: 10px;
      }
      .toggleState {
        font-size: 12px;
        color: var(--muted);
      }
      .toggleStrong {
        font-weight: 700;
        color: var(--text);
      }
      .toggleDone.on {
        border-color: rgba(47, 227, 167, 0.34);
        background: linear-gradient(135deg, rgba(47, 227, 167, 0.22), rgba(47, 227, 167, 0.08));
      }
      .toggleSkip.on {
        border-color: rgba(255, 209, 102, 0.34);
        background: linear-gradient(135deg, rgba(255, 209, 102, 0.18), rgba(255, 209, 102, 0.06));
      }

      .history {
        display: grid;
        gap: 8px;
      }
      .historyHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      .historyHeader .label {
        font-size: 12px;
        color: var(--muted);
      }
      .historyHeader .legend {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .key {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        font-size: 12px;
        color: var(--muted);
      }
      .keyBox {
        width: 10px;
        height: 10px;
        border-radius: 3px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
      }
      .keyBox.done {
        background: var(--good);
        border-color: rgba(47, 227, 167, 0.6);
      }
      .keyBox.skip {
        background: rgba(255, 209, 102, 0.12);
        border-color: rgba(255, 209, 102, 0.7);
      }

      .days {
        display: grid;
        grid-template-columns: repeat(14, minmax(0, 1fr));
        gap: 6px;
      }
      .day {
        aspect-ratio: 1 / 1;
        border-radius: 7px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.05);
        cursor: pointer;
        transition: transform 100ms var(--ease), background 120ms var(--ease), border-color 120ms var(--ease);
      }
      .day:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.22);
      }
      .day:focus-visible {
        outline: none;
        box-shadow: var(--focus);
      }
      .day.done {
        background: var(--good);
        border-color: rgba(47, 227, 167, 0.8);
      }
      .day.skip {
        background: rgba(255, 209, 102, 0.12);
        border-color: rgba(255, 209, 102, 0.8);
      }
      .day.future {
        opacity: 0.35;
        cursor: not-allowed;
      }

      .empty {
        padding: 16px;
        border: 1px dashed rgba(255, 255, 255, 0.18);
        border-radius: var(--radius);
        color: var(--muted);
        background: rgba(255, 255, 255, 0.03);
      }
      .empty strong {
        color: var(--text);
      }

      .modalRoot {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        z-index: 50;
      }
      .modalRoot.open {
        display: flex;
      }
      .modal {
        width: min(560px, 100%);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
        box-shadow: 0 30px 90px rgba(0, 0, 0, 0.55);
        overflow: hidden;
      }
      .modalHead {
        padding: 14px 14px 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .modalHead h3 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.2px;
      }
      .modalBody {
        padding: 14px;
        display: grid;
        gap: 12px;
      }
      .field {
        display: grid;
        gap: 8px;
      }
      .field label {
        font-size: 12px;
        color: var(--muted);
      }
      .input,
      textarea {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.2);
        padding: 10px 12px;
        outline: none;
      }
      textarea {
        min-height: 170px;
        resize: vertical;
        line-height: 1.45;
      }
      .input:focus,
      textarea:focus {
        box-shadow: var(--focus);
        border-color: rgba(100, 210, 255, 0.28);
      }
      .palette {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .chip {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(255, 255, 255, 0.06);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform 120ms var(--ease), border-color 120ms var(--ease);
      }
      .chip:hover {
        transform: translateY(-1px);
        border-color: rgba(255, 255, 255, 0.26);
      }
      .chip[aria-checked="true"] {
        border-color: rgba(100, 210, 255, 0.6);
        box-shadow: 0 0 0 4px rgba(100, 210, 255, 0.14);
      }
      .chipDot {
        width: 14px;
        height: 14px;
        border-radius: 99px;
      }
      .modalFoot {
        padding: 12px 14px 14px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        flex-wrap: wrap;
      }
      .help {
        font-size: 12px;
        color: var(--muted);
        line-height: 1.35;
      }

      .toastRoot {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        z-index: 60;
        display: grid;
        gap: 8px;
        pointer-events: none;
      }
      .toast {
        pointer-events: none;
        background: rgba(0, 0, 0, 0.45);
        border: 1px solid rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(12px);
        color: var(--text);
        border-radius: 12px;
        padding: 10px 12px;
        box-shadow: 0 16px 45px rgba(0, 0, 0, 0.35);
        font-size: 13px;
        animation: pop 140ms var(--ease);
      }
      @keyframes pop {
        from {
          transform: translateY(8px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .srOnly {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0, 0, 0, 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header class="topbar">
        <div class="brand">
          <div class="titleRow">
            <div class="appIcon" aria-hidden="true"></div>
            <div>
              <h1>Micro Habit Tracker</h1>
              <div class="subtitle">
                <span id="todayLabel" class="pill"><span class="pillDot" id="statusDot"></span><span id="todayText"></span></span>
                <span class="pill"><span class="k">Today:</span> <span class="v" id="todayProgress">0 / 0</span></span>
                <span class="pill"><span class="k">Streak focus:</span> <span class="v" id="streakFocus">—</span></span>
              </div>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="btn btnPrimary" id="addBtn" type="button" data-action="openAdd">
            <span aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </span>
            Add habit
          </button>
          <button class="btn" id="ieBtn" type="button" data-action="openIE">
            <span aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 3v12m0 0 4-4m-4 4-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 21h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </span>
            Import/Export
          </button>
          <button class="btn btnGhost btnDanger" id="resetBtn" type="button" data-action="reset">
            <span aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M21 12a9 9 0 1 1-3.2-6.9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M21 3v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            Reset
          </button>
        </div>
      </header>

      <main class="row" id="app">
        <section class="panel">
          <div class="panelHead">
            <div class="panelTitle">
              <h2>Momentum (Last 14 days)</h2>
              <p class="hint">Green bars are “done”. Skips are neutral. Tap a day square to edit history.</p>
            </div>
            <div class="pill">
              <span class="k">This week:</span>
              <span class="v" id="weekScore">—</span>
            </div>
          </div>
          <div class="panelBody">
            <div class="chartWrap">
              <div class="chartCard">
                <div class="chartLegend">
                  <div>
                    <div class="k">Total done</div>
                    <div class="v" id="totalDone">—</div>
                  </div>
                  <div>
                    <div class="k">Best day</div>
                    <div class="v" id="bestDay">—</div>
                  </div>
                </div>
                <canvas id="momentum" width="1000" height="220" aria-label="14 day momentum chart" role="img"></canvas>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="panelHead">
            <div class="panelTitle">
              <h2>Habits</h2>
              <p class="hint">Up to 7. Keep it tiny. Keep it daily.</p>
            </div>
            <div class="pill">
              <span class="k">Count:</span>
              <span class="v" id="habitCount">0 / 7</span>
            </div>
          </div>
          <div class="panelBody">
            <div class="grid" id="habitsGrid" aria-live="polite"></div>
            <div id="emptyState" class="empty" style="display: none; margin-top: 12px">
              <strong>No habits yet.</strong> Add one you can do in under 2 minutes.
            </div>
          </div>
        </section>
      </main>
    </div>

    <div class="modalRoot" id="modalRoot" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal" tabindex="-1">
        <div class="modalHead">
          <h3 id="modalTitle">Modal</h3>
          <button class="btn btnIcon btnGhost" type="button" data-action="closeModal" aria-label="Close">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
          </button>
        </div>
        <div class="modalBody" id="modalBody"></div>
        <div class="modalFoot" id="modalFoot"></div>
      </div>
    </div>

    <div class="toastRoot" id="toastRoot" aria-live="polite" aria-atomic="true"></div>

    <script>
      (() => {
        "use strict";

        const STORAGE_KEY = "microHabitTracker.v1";
        const MAX_HABITS = 7;
        const HISTORY_DAYS = 14;
        const COLORS = [
          "#64D2FF",
          "#2FE3A7",
          "#FFD166",
          "#FF5F6D",
          "#B18CFF",
          "#FF9F1C",
          "#4DD9D5",
        ];

        const $ = (sel, el = document) => el.querySelector(sel);
        const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));

        const fmtDay = new Intl.DateTimeFormat(undefined, { weekday: "short" });
        const fmtMonthDay = new Intl.DateTimeFormat(undefined, { month: "short", day: "numeric" });
        const fmtFull = new Intl.DateTimeFormat(undefined, { weekday: "long", month: "long", day: "numeric" });

        const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
        const safeJsonParse = (text) => {
          try {
            return { ok: true, value: JSON.parse(text) };
          } catch (e) {
            return { ok: false, error: e };
          }
        };
        const uid = () => {
          const bytes = new Uint8Array(16);
          crypto.getRandomValues(bytes);
          return Array.from(bytes)
            .map((b, i) => (i === 4 || i === 6 || i === 8 || i === 10 ? "-" : "") + b.toString(16).padStart(2, "0"))
            .join("");
        };
        const escapeHtml = (s) =>
          String(s).replace(/[&<>"']/g, (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c]));

        const dateKeyFromDate = (d) => {
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          return `${y}-${m}-${day}`;
        };
        const dateFromKey = (key) => {
          const [y, m, d] = key.split("-").map((n) => Number(n));
          return new Date(y, m - 1, d);
        };
        const todayKey = () => dateKeyFromDate(new Date());
        const addDaysKey = (key, delta) => {
          const d = dateFromKey(key);
          d.setDate(d.getDate() + delta);
          return dateKeyFromDate(d);
        };
        const lastKeys = (count, endKey = todayKey()) => {
          const keys = [];
          for (let i = count - 1; i >= 0; i--) keys.push(addDaysKey(endKey, -i));
          return keys;
        };
        const isFutureKey = (key) => dateFromKey(key) > new Date(new Date().setHours(23, 59, 59, 999));

        const toastRoot = $("#toastRoot");
        let toastTimer = null;
        const toast = (msg) => {
          if (toastTimer) clearTimeout(toastTimer);
          toastRoot.innerHTML = `<div class="toast">${escapeHtml(msg)}</div>`;
          toastTimer = setTimeout(() => (toastRoot.innerHTML = ""), 2200);
        };

        const defaultState = () => {
          const t = todayKey();
          const k = (d) => addDaysKey(t, d);
          const mk = (name, color, logs) => ({ id: uid(), name, color, createdAt: Date.now(), logs });
          return {
            version: 1,
            habits: [
              mk("Drink water", "#64D2FF", { [k(-4)]: "done", [k(-3)]: "done", [k(-2)]: "done", [k(-1)]: "skip", [k(0)]: "done" }),
              mk("2‑minute stretch", "#2FE3A7", { [k(-4)]: "skip", [k(-3)]: "done", [k(-2)]: "done", [k(-1)]: "done" }),
              mk("Read 10 pages", "#B18CFF", { [k(-4)]: "done", [k(-2)]: "done", [k(-1)]: "skip" }),
            ],
            ui: { lastOpened: Date.now() },
          };
        };

        const load = () => {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return defaultState();
          const parsed = safeJsonParse(raw);
          if (!parsed.ok) return defaultState();
          const st = sanitizeState(parsed.value);
          return st || defaultState();
        };

        const save = () => {
          state.ui.lastOpened = Date.now();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        };

        const sanitizeState = (input) => {
          if (!input || typeof input !== "object") return null;
          const habitsRaw = Array.isArray(input.habits) ? input.habits : [];
          const habits = habitsRaw
            .slice(0, MAX_HABITS)
            .map((h) => sanitizeHabit(h))
            .filter(Boolean);
          return { version: 1, habits, ui: { lastOpened: Date.now() } };
        };

        const sanitizeHabit = (h) => {
          if (!h || typeof h !== "object") return null;
          const id = typeof h.id === "string" && h.id.length > 8 ? h.id : uid();
          const name = String(h.name || "").trim().slice(0, 38);
          if (!name) return null;
          const color = typeof h.color === "string" ? h.color : COLORS[0];
          const logs = {};
          if (h.logs && typeof h.logs === "object") {
            for (const [k, v] of Object.entries(h.logs)) {
              if (!/^\d{4}-\d{2}-\d{2}$/.test(k)) continue;
              if (v === "done" || v === "skip") logs[k] = v;
            }
          }
          const createdAt = typeof h.createdAt === "number" ? h.createdAt : Date.now();
          return { id, name, color, createdAt, logs };
        };

        let state = load();

        const modalRoot = $("#modalRoot");
        const modalBody = $("#modalBody");
        const modalFoot = $("#modalFoot");
        const modalTitle = $("#modalTitle");
        const modalBox = $("#modalRoot .modal");
        let modalMode = null;
        let modalData = null;
        let lastActiveEl = null;

        const openModal = (mode, data) => {
          modalMode = mode;
          modalData = data || null;
          lastActiveEl = document.activeElement;
          modalRoot.classList.add("open");
          renderModal();
          setTimeout(() => modalBox.focus(), 0);
        };
        const closeModal = () => {
          modalRoot.classList.remove("open");
          modalMode = null;
          modalData = null;
          modalBody.innerHTML = "";
          modalFoot.innerHTML = "";
          if (lastActiveEl && lastActiveEl.focus) lastActiveEl.focus();
        };

        const habitById = (id) => state.habits.find((h) => h.id === id) || null;
        const upsertHabit = (habit) => {
          const idx = state.habits.findIndex((h) => h.id === habit.id);
          if (idx >= 0) state.habits[idx] = habit;
          else state.habits.push(habit);
          save();
          render();
        };
        const deleteHabit = (id) => {
          state.habits = state.habits.filter((h) => h.id !== id);
          save();
          render();
        };

        const setStatus = (habitId, key, statusOrNull) => {
          const habit = habitById(habitId);
          if (!habit) return;
          if (isFutureKey(key)) return;
          if (statusOrNull === null) {
            delete habit.logs[key];
          } else if (statusOrNull === "done" || statusOrNull === "skip") {
            habit.logs[key] = statusOrNull;
          } else {
            return;
          }
          save();
          render();
        };

        const cycleStatus = (habitId, key) => {
          const habit = habitById(habitId);
          if (!habit) return;
          if (isFutureKey(key)) return;
          const cur = habit.logs[key] || null;
          const next = cur === null ? "done" : cur === "done" ? "skip" : null;
          setStatus(habitId, key, next);
        };

        const streak = (habit, fromKey = todayKey()) => {
          let count = 0;
          let offset = 0;
          for (let i = 0; i < 1000; i++) {
            const key = addDaysKey(fromKey, -offset);
            const s = habit.logs[key] || null;
            if (s === "done") {
              count++;
              offset++;
              continue;
            }
            if (s === "skip") {
              offset++;
              continue;
            }
            break;
          }
          return count;
        };

        const bestStreak = (habit) => {
          // Compute by scanning backwards across the last year window for a fast, stable value.
          const end = todayKey();
          const keys = lastKeys(366, end);
          let best = 0;
          let current = 0;
          for (const key of keys) {
            const s = habit.logs[key] || null;
            if (s === "done") {
              current++;
              best = Math.max(best, current);
            } else if (s === "skip") {
              // Neutral
            } else {
              current = 0;
            }
          }
          return best;
        };

        const todayStats = () => {
          const t = todayKey();
          const done = state.habits.filter((h) => h.logs[t] === "done").length;
          const skipped = state.habits.filter((h) => h.logs[t] === "skip").length;
          const total = state.habits.length;
          const active = Math.max(0, total - skipped);
          return { done, skipped, total, active };
        };

        const computeMomentum = () => {
          const keys = lastKeys(HISTORY_DAYS, todayKey());
          const totals = keys.map((key) => {
            let done = 0;
            let skip = 0;
            for (const h of state.habits) {
              if (h.logs[key] === "done") done++;
              else if (h.logs[key] === "skip") skip++;
            }
            return { key, done, skip };
          });
          return totals;
        };

        const renderMomentumChart = () => {
          const canvas = $("#momentum");
          const ctx = canvas.getContext("2d");
          const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
          const rect = canvas.getBoundingClientRect();
          const w = Math.max(320, Math.floor(rect.width * dpr));
          const h = Math.max(140, Math.floor(rect.height * dpr));
          if (canvas.width !== w) canvas.width = w;
          if (canvas.height !== h) canvas.height = h;

          ctx.clearRect(0, 0, w, h);

          const data = computeMomentum();
          const max = Math.max(1, ...data.map((d) => d.done));
          const padX = 10 * dpr;
          const padY = 12 * dpr;
          const barW = (w - padX * 2) / data.length;
          const base = h - padY;

          const bgLine = (alpha) => `rgba(255,255,255,${alpha})`;
          ctx.lineWidth = 1 * dpr;
          ctx.strokeStyle = bgLine(0.12);
          for (let i = 0; i <= 3; i++) {
            const y = padY + ((base - padY) * i) / 3;
            ctx.beginPath();
            ctx.moveTo(padX, y);
            ctx.lineTo(w - padX, y);
            ctx.stroke();
          }

          // Bars
          const grad = ctx.createLinearGradient(0, padY, 0, base);
          grad.addColorStop(0, "rgba(47,227,167,0.95)");
          grad.addColorStop(1, "rgba(47,227,167,0.35)");

          ctx.fillStyle = grad;
          for (let i = 0; i < data.length; i++) {
            const v = data[i].done;
            const x = padX + i * barW + barW * 0.18;
            const bw = barW * 0.64;
            const bh = ((base - padY) * v) / max;
            const y = base - bh;
            const r = 8 * dpr;
            roundRect(ctx, x, y, bw, bh, r);
            ctx.fill();

            // Subtle skip indicator dot
            if (data[i].skip > 0) {
              ctx.fillStyle = "rgba(255,209,102,0.75)";
              ctx.beginPath();
              ctx.arc(x + bw / 2, base + 3.5 * dpr, 2.3 * dpr, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = grad;
            }
          }

          // Labels
          ctx.font = `${12 * dpr}px ui-sans-serif, system-ui, -apple-system`;
          ctx.fillStyle = "rgba(255,255,255,0.62)";
          ctx.textAlign = "center";
          for (let i = 0; i < data.length; i++) {
            if (i % 2 === 1) continue;
            const dt = dateFromKey(data[i].key);
            const x = padX + i * barW + barW / 2;
            ctx.fillText(fmtDay.format(dt), x, h - 2 * dpr);
          }
        };

        const roundRect = (ctx, x, y, w, h, r) => {
          const rr = Math.min(r, w / 2, h / 2);
          ctx.beginPath();
          ctx.moveTo(x + rr, y);
          ctx.arcTo(x + w, y, x + w, y + h, rr);
          ctx.arcTo(x + w, y + h, x, y + h, rr);
          ctx.arcTo(x, y + h, x, y, rr);
          ctx.arcTo(x, y, x + w, y, rr);
          ctx.closePath();
        };

        const streakFocus = () => {
          if (!state.habits.length) return "—";
          const scored = state.habits
            .map((h) => ({ id: h.id, name: h.name, streak: streak(h), best: bestStreak(h) }))
            .sort((a, b) => b.streak - a.streak || b.best - a.best);
          const top = scored[0];
          if (!top) return "—";
          return `${top.name} (${top.streak} day${top.streak === 1 ? "" : "s"})`;
        };

        const weekScore = () => {
          const t = todayKey();
          const keys = lastKeys(7, t);
          let done = 0;
          let possible = 0;
          for (const k of keys) {
            for (const h of state.habits) {
              const s = h.logs[k] || null;
              if (s === "skip") continue;
              possible++;
              if (s === "done") done++;
            }
          }
          if (!possible) return "—";
          const pct = Math.round((done / possible) * 100);
          return `${pct}% (${done}/${possible})`;
        };

        const render = () => {
          const t = todayKey();
          $("#todayText").textContent = fmtFull.format(dateFromKey(t));

          const { done, skipped, total, active } = todayStats();
          $("#todayProgress").textContent = `${done} / ${active}`;
          $("#todayProgress").title = skipped ? `${skipped} skipped today` : "";
          $("#habitCount").textContent = `${total} / ${MAX_HABITS}`;
          $("#streakFocus").textContent = streakFocus();
          $("#weekScore").textContent = weekScore();

          const dot = $("#statusDot");
          dot.classList.remove("warn", "bad");
          const ratio = active ? done / active : total ? 0.75 : 0;
          if (total === 0) dot.classList.add("bad");
          else if (active === 0) dot.classList.add("warn");
          else if (ratio < 0.35) dot.classList.add("bad");
          else if (ratio < 0.75) dot.classList.add("warn");

          $("#addBtn").disabled = state.habits.length >= MAX_HABITS;

          const momentum = computeMomentum();
          const totalDone = momentum.reduce((a, d) => a + d.done, 0);
          const best = momentum.reduce((a, d) => (d.done > (a?.done ?? -1) ? d : a), null);
          $("#totalDone").textContent = `${totalDone} check${totalDone === 1 ? "" : "s"}`;
          $("#bestDay").textContent = best ? `${fmtMonthDay.format(dateFromKey(best.key))} (${best.done})` : "—";

          const grid = $("#habitsGrid");
          const empty = $("#emptyState");
          empty.style.display = state.habits.length ? "none" : "block";

          const keys = lastKeys(HISTORY_DAYS, t);
          grid.innerHTML = state.habits
            .slice()
            .sort((a, b) => a.createdAt - b.createdAt)
            .map((h) => habitCardHtml(h, keys))
            .join("");

          renderMomentumChart();
        };

        const habitCardHtml = (habit, keys) => {
          const t = todayKey();
          const todayStatus = habit.logs[t] || null;
          const isDone = todayStatus === "done";
          const isSkip = todayStatus === "skip";
          const s = streak(habit);
          const b = bestStreak(habit);
          const daysHtml = keys
            .map((k) => {
              const st = habit.logs[k] || null;
              const cls = st ? ` ${st}` : "";
              const future = isFutureKey(k) ? " future" : "";
              const label = `${fmtMonthDay.format(dateFromKey(k))}: ${st || "none"}. Click to toggle.`;
              return `<button class="day${cls}${future}" type="button" data-action="toggleDay" data-id="${escapeHtml(
                habit.id
              )}" data-date="${k}" aria-label="${escapeHtml(label)}" ${isFutureKey(k) ? "disabled" : ""}></button>`;
            })
            .join("");

          const doneLabel = isDone ? "Done" : "Mark done";
          const skipLabel = isSkip ? "Skipped" : "Skip day";

          return `
            <article class="habit" data-id="${escapeHtml(habit.id)}">
              <div class="habitInner">
                <div class="habitTop">
                  <div style="min-width:0">
                    <div class="habitNameRow">
                      <span class="swatch" style="background:${escapeHtml(habit.color)}"></span>
                      <div class="habitName" title="${escapeHtml(habit.name)}">${escapeHtml(habit.name)}</div>
                    </div>
                    <div class="habitMeta">
                      <div class="badge" title="Current streak counts consecutive done days. Skips don’t break the streak.">
                        <span aria-hidden="true">${sparkIcon(habit.color)}</span>
                        <div><strong>${s}</strong> <span>streak</span></div>
                      </div>
                      <div class="badge" title="Best streak in the last year">
                        <span aria-hidden="true">${trophyIcon()}</span>
                        <div><strong>${b}</strong> <span>best</span></div>
                      </div>
                    </div>
                  </div>
                  <div class="habitBtns">
                    <button class="btn btnSmall btnGhost" type="button" data-action="editHabit" data-id="${escapeHtml(
                      habit.id
                    )}" aria-label="Edit habit">
                      ${editIcon()}
                    </button>
                    <button class="btn btnSmall btnGhost btnDanger" type="button" data-action="deleteHabit" data-id="${escapeHtml(
                      habit.id
                    )}" aria-label="Delete habit">
                      ${trashIcon()}
                    </button>
                  </div>
                </div>

                <div class="todayRow">
                  <button class="btn toggle toggleDone ${isDone ? "on" : ""}" type="button" data-action="toggleDone" data-id="${escapeHtml(
                    habit.id
                  )}">
                    ${checkIcon()}
                    <span class="toggleStrong">${escapeHtml(doneLabel)}</span>
                    <span class="toggleState">${isDone ? "tap to undo" : "for today"}</span>
                  </button>
                  <button class="btn toggle toggleSkip ${isSkip ? "on" : ""}" type="button" data-action="toggleSkip" data-id="${escapeHtml(
                    habit.id
                  )}">
                    ${skipIcon()}
                    <span class="toggleStrong">${escapeHtml(skipLabel)}</span>
                    <span class="toggleState">${isSkip ? "tap to undo" : "neutral day"}</span>
                  </button>
                </div>

                <div class="history">
                  <div class="historyHeader">
                    <div class="label">History (14 days)</div>
                    <div class="legend" aria-hidden="true">
                      <span class="key"><span class="keyBox done"></span>done</span>
                      <span class="key"><span class="keyBox skip"></span>skip</span>
                      <span class="key"><span class="keyBox"></span>empty</span>
                    </div>
                  </div>
                  <div class="days">${daysHtml}</div>
                </div>
              </div>
            </article>
          `;
        };

        const svg = (path, opts = {}) => {
          const { w = 18, h = 18, sw = 2, cap = "round", join = "round" } = opts;
          return `<svg width="${w}" height="${h}" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="${path}" stroke="currentColor" stroke-width="${sw}" stroke-linecap="${cap}" stroke-linejoin="${join}"></path>
          </svg>`;
        };
        const checkIcon = () => svg("M20 6 9 17l-5-5");
        const skipIcon = () =>
          `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 16l-3-4 3-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 16l3-4-3-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`;
        const editIcon = () => svg("M12 20h9M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z");
        const trashIcon = () =>
          `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M6 6l1 15h10l1-15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`;
        const trophyIcon = () =>
          `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M8 4h8v3a4 4 0 0 1-8 0V4z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M6 6H4a2 2 0 0 0 2 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M18 6h2a2 2 0 0 1-2 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 11v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 21h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 14h4l1 7H9l1-7z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>`;
        const sparkIcon = (color) =>
          `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 2l1.2 4.6L18 8l-4.4 1.2L12 14l-1.6-4.8L6 8l4.8-1.4L12 2z" fill="${escapeHtml(color)}" opacity="0.95"></path>
            <path d="M19 13l.7 2.6L22 16.3l-2.3.7L19 19.6l-.7-2.6L16 16.3l2.3-.7L19 13z" fill="rgba(255,255,255,0.7)"></path>
          </svg>`;

        const renderModal = () => {
          if (!modalMode) return;
          if (modalMode === "add" || modalMode === "edit") return renderHabitModal();
          if (modalMode === "delete") return renderDeleteModal();
          if (modalMode === "ie") return renderIEModal();
          if (modalMode === "reset") return renderResetModal();
        };

        const renderHabitModal = () => {
          const isEdit = modalMode === "edit";
          const habit = isEdit ? habitById(modalData?.id) : null;
          modalTitle.textContent = isEdit ? "Edit habit" : "Add a habit";
          const startName = habit ? habit.name : "";
          const startColor = habit ? habit.color : COLORS[state.habits.length % COLORS.length];
          const id = habit ? habit.id : uid();
          modalBody.innerHTML = `
            <div class="field">
              <label for="habitName">Name</label>
              <input class="input" id="habitName" placeholder="e.g., 2‑minute walk" maxlength="38" value="${escapeHtml(startName)}" />
              <div class="help">Keep it micro. If it takes more than 2 minutes, shrink it.</div>
            </div>
            <div class="field">
              <label>Color</label>
              <div class="palette" role="radiogroup" aria-label="Choose a color">
                ${COLORS.map((c) => {
                  const checked = c.toLowerCase() === String(startColor).toLowerCase();
                  return `<button type="button" class="chip" role="radio" aria-checked="${checked}" data-action="pickColor" data-color="${escapeHtml(
                    c
                  )}" title="${escapeHtml(c)}"><span class="chipDot" style="background:${escapeHtml(c)}"></span></button>`;
                }).join("")}
              </div>
            </div>
            <div class="srOnly" id="pickedColor">${escapeHtml(startColor)}</div>
          `;
          modalFoot.innerHTML = `
            <button class="btn btnGhost" type="button" data-action="closeModal">Cancel</button>
            <button class="btn btnPrimary" type="button" data-action="saveHabit" data-id="${escapeHtml(id)}">${isEdit ? "Save" : "Add"}</button>
          `;
          const nameEl = $("#habitName", modalBody);
          setTimeout(() => nameEl.focus(), 0);
        };

        const renderDeleteModal = () => {
          const habit = habitById(modalData?.id);
          if (!habit) return closeModal();
          modalTitle.textContent = "Delete habit";
          modalBody.innerHTML = `
            <div class="help">
              Delete <strong>${escapeHtml(habit.name)}</strong>? This removes its history from this device.
            </div>
          `;
          modalFoot.innerHTML = `
            <button class="btn btnGhost" type="button" data-action="closeModal">Cancel</button>
            <button class="btn btnDanger" type="button" data-action="confirmDelete" data-id="${escapeHtml(habit.id)}">Delete</button>
          `;
        };

        const renderIEModal = () => {
          modalTitle.textContent = "Import / Export";
          const exported = JSON.stringify(state, null, 2);
          modalBody.innerHTML = `
            <div class="field">
              <label for="exportText">Export (JSON)</label>
              <textarea id="exportText" spellcheck="false" readonly>${escapeHtml(exported)}</textarea>
              <div class="help">Tip: Save a backup occasionally. Import replaces your current habits.</div>
            </div>
            <div class="field">
              <label for="importText">Import (paste JSON)</label>
              <textarea id="importText" spellcheck="false" placeholder='Paste previously exported JSON here...'></textarea>
              <input id="importFile" type="file" accept="application/json" class="srOnly" />
              <div class="help">Only “done” and “skip” are stored. Empty days stay empty.</div>
            </div>
          `;
          modalFoot.innerHTML = `
            <button class="btn" type="button" data-action="copyExport">Copy export</button>
            <button class="btn" type="button" data-action="downloadExport">Download</button>
            <button class="btn" type="button" data-action="pickImportFile">Choose file</button>
            <button class="btn btnPrimary" type="button" data-action="doImport">Import</button>
          `;
        };

        const renderResetModal = () => {
          modalTitle.textContent = "Reset data";
          modalBody.innerHTML = `
            <div class="help">
              Reset restores the built‑in demo data and clears your current habits on this device.
            </div>
          `;
          modalFoot.innerHTML = `
            <button class="btn btnGhost" type="button" data-action="closeModal">Cancel</button>
            <button class="btn btnDanger" type="button" data-action="confirmReset">Reset</button>
          `;
        };

        const download = (filename, text) => {
          const blob = new Blob([text], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 1500);
        };

        const setPickedColor = (color) => {
          $("#pickedColor", modalBody).textContent = color;
          $$(".chip", modalBody).forEach((btn) => btn.setAttribute("aria-checked", btn.dataset.color === color ? "true" : "false"));
        };
        const getPickedColor = () => $("#pickedColor", modalBody)?.textContent || COLORS[0];

        const resetAll = () => {
          localStorage.removeItem(STORAGE_KEY);
          state = defaultState();
          save();
          render();
          toast("Reset to demo data");
        };

        const onAction = async (action, el) => {
          const t = todayKey();
          if (action === "openAdd") return openModal("add");
          if (action === "openIE") return openModal("ie");
          if (action === "closeModal") return closeModal();
          if (action === "reset") return openModal("reset");

          if (action === "toggleDone") {
            const id = el.dataset.id;
            const habit = habitById(id);
            if (!habit) return;
            const cur = habit.logs[t] || null;
            const next = cur === "done" ? null : "done";
            setStatus(id, t, next);
            if (next === "done") {
              const stats = todayStats();
              toast(stats.active > 0 && stats.done === stats.active ? "All set for today" : "Marked done");
            } else {
              toast("Undid for today");
            }
            return;
          }

          if (action === "toggleSkip") {
            const id = el.dataset.id;
            const habit = habitById(id);
            if (!habit) return;
            const cur = habit.logs[t] || null;
            const next = cur === "skip" ? null : "skip";
            setStatus(id, t, next);
            if (next === "skip") {
              const stats = todayStats();
              toast(stats.active === 0 ? "Day off (all skipped)" : "Skipped today");
            } else {
              toast("Undo skip");
            }
            return;
          }

          if (action === "toggleDay") {
            const id = el.dataset.id;
            const key = el.dataset.date;
            cycleStatus(id, key);
            return;
          }

          if (action === "editHabit") return openModal("edit", { id: el.dataset.id });
          if (action === "deleteHabit") return openModal("delete", { id: el.dataset.id });

          if (action === "pickColor") {
            setPickedColor(el.dataset.color);
            return;
          }

          if (action === "saveHabit") {
            const id = el.dataset.id;
            const name = ($("#habitName", modalBody)?.value || "").trim();
            if (!name) return toast("Give it a short name");
            if (!habitById(id) && state.habits.length >= MAX_HABITS) return toast("Max 7 habits");
            const color = getPickedColor();
            const existing = habitById(id);
            const habit = existing
              ? { ...existing, name: name.slice(0, 38), color }
              : { id, name: name.slice(0, 38), color, createdAt: Date.now(), logs: {} };
            upsertHabit(habit);
            closeModal();
            toast(existing ? "Updated" : "Added");
            return;
          }

          if (action === "confirmDelete") {
            deleteHabit(el.dataset.id);
            closeModal();
            toast("Deleted");
            return;
          }

          if (action === "copyExport") {
            const text = $("#exportText", modalBody)?.value || "";
            try {
              await navigator.clipboard.writeText(text);
              toast("Copied");
            } catch {
              toast("Copy failed (try Select All)");
            }
            return;
          }

          if (action === "downloadExport") {
            const text = $("#exportText", modalBody)?.value || "";
            download(`micro-habit-tracker-${todayKey()}.json`, text);
            toast("Downloaded");
            return;
          }

          if (action === "pickImportFile") {
            $("#importFile", modalBody)?.click();
            return;
          }

          if (action === "doImport") {
            const raw = ($("#importText", modalBody)?.value || "").trim();
            if (!raw) return toast("Paste JSON to import");
            const parsed = safeJsonParse(raw);
            if (!parsed.ok) return toast("Invalid JSON");
            const st = sanitizeState(parsed.value);
            if (!st) return toast("Import failed");
            state = st;
            save();
            render();
            closeModal();
            toast("Imported");
            return;
          }

          if (action === "confirmReset") {
            resetAll();
            closeModal();
            return;
          }
        };

        document.addEventListener("click", (e) => {
          const el = e.target.closest("[data-action]");
          if (!el) return;
          onAction(el.dataset.action, el);
        });

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modalRoot.classList.contains("open")) {
            closeModal();
            return;
          }
          if (
            e.key === "Enter" &&
            modalRoot.classList.contains("open") &&
            (modalMode === "add" || modalMode === "edit") &&
            !(document.activeElement && document.activeElement.tagName === "TEXTAREA")
          ) {
            const saveBtn = modalFoot.querySelector('[data-action="saveHabit"]');
            if (saveBtn) {
              e.preventDefault();
              saveBtn.click();
            }
          }
        });

        modalRoot.addEventListener("click", (e) => {
          if (e.target === modalRoot) closeModal();
        });

        modalRoot.addEventListener("change", async (e) => {
          const input = e.target;
          if (!(input instanceof HTMLInputElement)) return;
          if (input.id !== "importFile") return;
          const file = input.files && input.files[0];
          if (!file) return;
          try {
            const text = await file.text();
            $("#importText", modalBody).value = text;
            toast("Loaded file, ready to import");
          } catch {
            toast("Couldn’t read file");
          } finally {
            input.value = "";
          }
        });

        window.addEventListener("resize", () => renderMomentumChart());

        // Small bugfix: avoid accidental "both statuses" leftovers.
        const normalize = () => {
          for (const h of state.habits) {
            for (const [k, v] of Object.entries(h.logs)) {
              if (v !== "done" && v !== "skip") delete h.logs[k];
            }
          }
        };

        normalize();
        save();
        render();
      })();
    </script>
  </body>
</html>
