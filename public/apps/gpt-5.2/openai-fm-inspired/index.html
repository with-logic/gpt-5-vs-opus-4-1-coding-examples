<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark" />
    <title>OpenAI.fm Inspired — Voice Studio (Self‑Contained)</title>
    <style>
      :root {
        --bg0: #07070a;
        --bg1: #0b0b14;
        --panel: rgba(255, 255, 255, 0.06);
        --panel2: rgba(255, 255, 255, 0.09);
        --stroke: rgba(255, 255, 255, 0.12);
        --stroke2: rgba(255, 255, 255, 0.18);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.68);
        --faint: rgba(255, 255, 255, 0.48);
        --danger: #ff4d6d;
        --ok: #4cffbf;
        --brandA: #7c5cff;
        --brandB: #00d4ff;
        --brandC: #ff5c9a;
        --shadow: 0 20px 60px rgba(0, 0, 0, 0.55);
        --shadow2: 0 12px 30px rgba(0, 0, 0, 0.45);
        --r12: 12px;
        --r16: 16px;
        --r20: 20px;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
          monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: var(--sans);
        color: var(--text);
        background: radial-gradient(1200px 700px at 20% 10%, rgba(124, 92, 255, 0.22), transparent 60%),
          radial-gradient(900px 600px at 80% 20%, rgba(0, 212, 255, 0.18), transparent 55%),
          radial-gradient(1100px 700px at 60% 90%, rgba(255, 92, 154, 0.14), transparent 60%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        overflow: hidden;
      }

      /* Subtle grain overlay */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        opacity: 0.10;
        mix-blend-mode: overlay;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      }

      .app {
        position: relative;
        height: 100%;
        display: grid;
        grid-template-rows: auto 1fr;
      }

      canvas#viz {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        opacity: 0.9;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 18px 18px 10px;
        position: relative;
        z-index: 2;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 260px;
      }
      .logo {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.35), transparent 55%),
          linear-gradient(135deg, rgba(124, 92, 255, 1), rgba(0, 212, 255, 1), rgba(255, 92, 154, 1));
        box-shadow: 0 10px 30px rgba(124, 92, 255, 0.25);
        position: relative;
        overflow: hidden;
      }
      .logo::after {
        content: "";
        position: absolute;
        inset: -40%;
        background: conic-gradient(
          from 180deg,
          rgba(255, 255, 255, 0.0),
          rgba(255, 255, 255, 0.30),
          rgba(255, 255, 255, 0.0)
        );
        animation: sheen 3.8s linear infinite;
      }
      @keyframes sheen {
        to {
          transform: rotate(360deg);
        }
      }
      .brand h1 {
        font-size: 14px;
        margin: 0;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.88);
      }
      .brand .sub {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
      }

      .top-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .pill {
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.06);
        border-radius: 999px;
        padding: 8px 12px;
        color: rgba(255, 255, 255, 0.86);
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        user-select: none;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      }
      .pill:hover {
        transform: translateY(-1px);
        border-color: var(--stroke2);
        background: rgba(255, 255, 255, 0.09);
      }
      .pill:active {
        transform: translateY(0px) scale(0.99);
      }
      .pill[aria-pressed="true"] {
        border-color: rgba(124, 92, 255, 0.45);
        background: rgba(124, 92, 255, 0.12);
      }
      .pill svg {
        width: 16px;
        height: 16px;
        opacity: 0.9;
      }

      main {
        padding: 0 18px 18px;
        position: relative;
        z-index: 2;
        overflow: hidden;
      }

      .layout {
        height: calc(100vh - 72px);
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 14px;
      }

      .panel {
        border: 1px solid var(--stroke);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.04));
        border-radius: var(--r20);
        box-shadow: var(--shadow2);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .panel-header {
        padding: 14px 14px 10px;
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .panel-header h2 {
        margin: 0;
        font-size: 13px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.78);
      }
      .panel-header .hint {
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 220px;
      }

      .panel-body {
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 0;
      }

      .search {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .input {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(0, 0, 0, 0.25);
        color: var(--text);
        padding: 10px 12px;
        outline: none;
        transition: border-color 140ms ease, background 140ms ease;
      }
      .input:focus {
        border-color: rgba(0, 212, 255, 0.35);
        background: rgba(0, 0, 0, 0.32);
      }
      .input::placeholder {
        color: rgba(255, 255, 255, 0.45);
      }

      .voice-list {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        overflow: auto;
        padding-right: 2px;
        min-height: 0;
      }
      .voice {
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 12px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
        cursor: pointer;
        transition: border-color 140ms ease, transform 140ms ease, background 140ms ease;
      }
      .voice:hover {
        transform: translateY(-1px);
        border-color: rgba(255, 255, 255, 0.16);
        background: rgba(255, 255, 255, 0.07);
      }
      .voice[aria-selected="true"] {
        border-color: rgba(124, 92, 255, 0.50);
        background: rgba(124, 92, 255, 0.10);
      }
      .voice .name {
        font-size: 13px;
        font-weight: 610;
        letter-spacing: 0.01em;
      }
      .voice .meta {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .tag {
        font-family: var(--mono);
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(0, 0, 0, 0.18);
        color: rgba(255, 255, 255, 0.72);
      }
      .voice .actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .mini {
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(0, 0, 0, 0.18);
        color: rgba(255, 255, 255, 0.86);
        border-radius: 12px;
        padding: 8px 10px;
        font-size: 12px;
        cursor: pointer;
        transition: background 120ms ease, border-color 120ms ease, transform 120ms ease;
      }
      .mini:hover {
        background: rgba(0, 0, 0, 0.26);
        border-color: rgba(255, 255, 255, 0.16);
        transform: translateY(-1px);
      }
      .mini:active {
        transform: translateY(0px) scale(0.99);
      }

      .studio {
        display: grid;
        grid-template-rows: auto auto 1fr auto;
        gap: 12px;
        min-height: 0;
      }

      .chips {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .chip {
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.82);
        border-radius: 999px;
        padding: 8px 10px;
        font-size: 12px;
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      }
      .chip:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.16);
      }
      .chip[aria-pressed="true"] {
        border-color: rgba(0, 212, 255, 0.42);
        background: rgba(0, 212, 255, 0.12);
      }

      textarea#script {
        width: 100%;
        min-height: 210px;
        resize: vertical;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(0, 0, 0, 0.25);
        color: var(--text);
        padding: 12px 12px 12px 12px;
        outline: none;
        line-height: 1.45;
        font-size: 14px;
        transition: border-color 140ms ease, background 140ms ease, transform 120ms ease;
      }
      textarea#script:focus {
        border-color: rgba(124, 92, 255, 0.45);
        background: rgba(0, 0, 0, 0.32);
      }

      .row {
        display: grid;
        grid-template-columns: 1.3fr 0.7fr;
        gap: 12px;
        min-height: 0;
      }

      .card {
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.045);
        border-radius: var(--r16);
        padding: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        min-height: 0;
      }
      .card-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .card-title strong {
        font-size: 13px;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.80);
      }
      .tiny {
        font-size: 12px;
        color: var(--muted);
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
      }
      .control {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .control label {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        gap: 8px;
      }
      .control label span {
        font-family: var(--mono);
        color: rgba(255, 255, 255, 0.72);
        font-size: 11px;
      }
      input[type="range"] {
        width: 100%;
        accent-color: var(--brandB);
      }

      .cta-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
      }
      .btn {
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.90);
        padding: 11px 12px;
        cursor: pointer;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, filter 120ms ease;
        user-select: none;
      }
      .btn:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.09);
        border-color: rgba(255, 255, 255, 0.18);
      }
      .btn:active {
        transform: translateY(0px) scale(0.99);
      }
      .btn.primary {
        border-color: rgba(0, 212, 255, 0.34);
        background: linear-gradient(135deg, rgba(0, 212, 255, 0.18), rgba(124, 92, 255, 0.16));
        box-shadow: 0 14px 40px rgba(0, 212, 255, 0.10);
      }
      .btn.danger {
        border-color: rgba(255, 77, 109, 0.34);
        background: rgba(255, 77, 109, 0.10);
      }
      .btn[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
      }
      .btn svg {
        width: 16px;
        height: 16px;
        opacity: 0.95;
      }

      .statusbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding-top: 6px;
      }
      .status {
        display: flex;
        flex-direction: column;
        gap: 3px;
        min-width: 0;
      }
      .status .line1 {
        display: flex;
        gap: 10px;
        align-items: center;
        min-width: 0;
      }
      .badge {
        font-family: var(--mono);
        font-size: 11px;
        padding: 3px 9px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(0, 0, 0, 0.18);
        color: rgba(255, 255, 255, 0.78);
      }
      .status .title {
        font-size: 13px;
        font-weight: 620;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .status .line2 {
        font-size: 12px;
        color: var(--muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .progress {
        flex: 1;
        min-width: 120px;
        display: grid;
        grid-template-rows: auto auto;
        gap: 6px;
      }
      .bar {
        height: 10px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.10);
        overflow: hidden;
      }
      .bar > div {
        height: 100%;
        width: 0%;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(0, 212, 255, 0.85), rgba(124, 92, 255, 0.85), rgba(255, 92, 154, 0.85));
        box-shadow: 0 0 22px rgba(0, 212, 255, 0.18);
        transition: width 120ms linear;
      }
      .time {
        display: flex;
        justify-content: space-between;
        font-family: var(--mono);
        font-size: 11px;
        color: rgba(255, 255, 255, 0.68);
      }

      .transcript {
        font-family: var(--mono);
        font-size: 12px;
        color: rgba(255, 255, 255, 0.72);
        line-height: 1.5;
        overflow: auto;
        min-height: 0;
      }
      .transcript .cursor {
        display: inline-block;
        width: 8px;
        height: 14px;
        border-radius: 2px;
        margin-left: 2px;
        background: linear-gradient(180deg, rgba(0, 212, 255, 0.85), rgba(124, 92, 255, 0.70));
        animation: blink 900ms ease-in-out infinite;
        vertical-align: -2px;
      }
      @keyframes blink {
        50% {
          opacity: 0.25;
        }
      }
      .hl {
        color: rgba(255, 255, 255, 0.92);
      }
      .dim {
        color: rgba(255, 255, 255, 0.52);
      }

      .history {
        display: flex;
        flex-direction: column;
        gap: 8px;
        overflow: auto;
        min-height: 0;
      }
      .hitem {
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(0, 0, 0, 0.18);
        border-radius: 14px;
        padding: 10px 10px;
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      }
      .hitem:hover {
        transform: translateY(-1px);
        border-color: rgba(255, 255, 255, 0.16);
        background: rgba(0, 0, 0, 0.24);
      }
      .hitem .t {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.86);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .hitem .m {
        margin-top: 3px;
        font-family: var(--mono);
        font-size: 11px;
        color: rgba(255, 255, 255, 0.60);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      dialog {
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 18px;
        background: rgba(16, 16, 24, 0.82);
        color: var(--text);
        width: min(860px, calc(100vw - 24px));
        padding: 0;
        box-shadow: var(--shadow);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.55);
      }
      .modal {
        padding: 14px;
      }
      .modal .mhead {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding: 10px 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.10);
      }
      .modal .mhead h3 {
        margin: 0;
        font-size: 13px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.78);
      }
      .modal .mcontent {
        padding: 12px 10px 10px;
        color: rgba(255, 255, 255, 0.84);
        line-height: 1.5;
        font-size: 14px;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
      }
      .example {
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 12px;
      }
      .example .k {
        font-family: var(--mono);
        font-size: 11px;
        color: rgba(255, 255, 255, 0.70);
      }
      .example .v {
        margin-top: 6px;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.90);
      }
      .example .use {
        margin-top: 10px;
        width: 100%;
      }
      .toast {
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 5;
        background: rgba(0, 0, 0, 0.65);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        padding: 10px 12px;
        color: rgba(255, 255, 255, 0.90);
        font-size: 12px;
        display: none;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.40);
      }
      .toast.show {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        animation: pop 180ms ease-out;
      }
      @keyframes pop {
        from {
          transform: translateX(-50%) translateY(6px);
          opacity: 0;
        }
        to {
          transform: translateX(-50%) translateY(0px);
          opacity: 1;
        }
      }

      .sr {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      /* Responsive */
      @media (max-width: 980px) {
        body {
          overflow: auto;
        }
        main {
          overflow: visible;
        }
        .layout {
          height: auto;
          grid-template-columns: 1fr;
        }
        .brand {
          min-width: 0;
        }
        .row {
          grid-template-columns: 1fr;
        }
        .controls {
          grid-template-columns: 1fr;
        }
        .cta-row {
          grid-template-columns: 1fr;
        }
        dialog {
          width: min(860px, calc(100vw - 18px));
        }
        .grid2 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <canvas id="viz" aria-hidden="true"></canvas>
    <div class="app">
      <header>
        <div class="brand" role="banner">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Voice Studio</h1>
            <div class="sub">OpenAI.fm inspired • runs on your browser’s built‑in voices</div>
          </div>
        </div>
        <div class="top-actions" role="navigation" aria-label="Top actions">
          <button class="pill" id="btnExamples" type="button" title="Load inspiring scripts">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M8 6h13M8 12h13M8 18h13" />
              <path d="M3 6h.01M3 12h.01M3 18h.01" />
            </svg>
            Examples
          </button>
          <button class="pill" id="btnAmbient" type="button" aria-pressed="true" title="Toggle ambient visualizer">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 10a8 8 0 0 1 16 0v7a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-7Z" />
              <path d="M9 14h.01M12 16h.01M15 14h.01" />
            </svg>
            Ambient
          </button>
          <button class="pill" id="btnShare" type="button" title="Copy a shareable link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 8a3 3 0 1 0-6 0v1" />
              <path d="M8 12h8" />
              <path d="M12 3v3" />
              <path d="M6 12v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-7" />
            </svg>
            Share
          </button>
          <button class="pill" id="btnAbout" type="button" title="What is this?">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 18h.01" />
              <path d="M12 14a2 2 0 1 0-2-2" />
              <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Z" />
            </svg>
            About
          </button>
        </div>
      </header>

      <main>
        <div class="layout">
          <section class="panel" aria-label="Voice library">
            <div class="panel-header">
              <h2>Voice Library</h2>
              <div class="hint" id="voicesHint">Loading system voices…</div>
            </div>
            <div class="panel-body">
              <div class="search">
                <label class="sr" for="voiceSearch">Search voices</label>
                <input class="input" id="voiceSearch" placeholder="Search voices (name, language)..." autocomplete="off" />
              </div>
              <div class="chips" aria-label="Voice filters">
                <button class="chip" id="filterAll" type="button" aria-pressed="true">All</button>
                <button class="chip" id="filterLocal" type="button" aria-pressed="false">On‑device</button>
                <button class="chip" id="filterEn" type="button" aria-pressed="false">English</button>
              </div>
              <div class="voice-list" id="voiceList" role="listbox" aria-label="Available voices"></div>
              <div class="tiny" id="supportNote"></div>
            </div>
          </section>

          <section class="panel" aria-label="Studio">
            <div class="panel-header">
              <h2>Studio</h2>
              <div class="hint" id="studioHint">Type a script, then press Speak.</div>
            </div>
            <div class="panel-body studio">
              <div class="chips" aria-label="Performance presets" id="presetChips"></div>
              <div class="row">
                <div class="card">
                  <div class="card-title">
                    <strong>Script</strong>
                    <span class="tiny">Tip: ⌘/Ctrl+Enter to Speak • Esc to Stop</span>
                  </div>
                  <textarea id="script" spellcheck="false"></textarea>
                  <div class="statusbar">
                    <div class="status">
                      <div class="line1">
                        <span class="badge" id="stateBadge">READY</span>
                        <div class="title" id="voiceTitle">Voice: —</div>
                      </div>
                      <div class="line2" id="metaLine">Select a voice to get started.</div>
                    </div>
                    <div class="progress" aria-label="Playback progress">
                      <div class="bar"><div id="progressFill"></div></div>
                      <div class="time">
                        <span id="timeNow">0:00</span>
                        <span id="timeTotal">0:00</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="card">
                  <div class="card-title">
                    <strong>Mix</strong>
                    <span class="tiny"><span id="wpmHint">~0 wpm</span></span>
                  </div>
                  <div class="controls" role="group" aria-label="Voice controls">
                    <div class="control">
                      <label for="rate">Rate <span id="rateVal">1.00×</span></label>
                      <input id="rate" type="range" min="0.5" max="1.6" step="0.01" value="1" />
                    </div>
                    <div class="control">
                      <label for="pitch">Pitch <span id="pitchVal">1.00×</span></label>
                      <input id="pitch" type="range" min="0.5" max="1.6" step="0.01" value="1" />
                    </div>
                    <div class="control">
                      <label for="volume">Volume <span id="volumeVal">1.00×</span></label>
                      <input id="volume" type="range" min="0" max="1" step="0.01" value="1" />
                    </div>
                    <div class="control" style="grid-column: 1 / -1">
                      <label for="energy">Energy <span id="energyVal">0.65</span></label>
                      <input id="energy" type="range" min="0.05" max="1" step="0.01" value="0.65" />
                    </div>
                  </div>
                  <div class="chips" aria-label="Script helpers" style="margin-top: 10px">
                    <button class="chip" id="chipPunct" type="button" aria-pressed="true" title="Add light punctuation for better phrasing">
                      Auto‑punctuate
                    </button>
                    <button class="chip" id="chipBreath" type="button" aria-pressed="false" title="Add subtle pauses between sentences">
                      Add pauses
                    </button>
                    <button class="chip" id="chipDuet" type="button" aria-pressed="false" title="Alternate between two voices each paragraph">
                      Duet mode
                    </button>
                  </div>
                  <div class="cta-row" style="margin-top: 12px">
                    <button class="btn primary" id="btnSpeak" type="button">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 5v14l11-7z" />
                      </svg>
                      Speak
                    </button>
                    <button class="btn" id="btnPause" type="button" disabled>
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 5h4v14H6zM14 5h4v14h-4z" />
                      </svg>
                      Pause
                    </button>
                    <button class="btn danger" id="btnStop" type="button" disabled>
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 6h12v12H6z" />
                      </svg>
                      Stop
                    </button>
                  </div>
                </div>
              </div>

              <div class="row" style="grid-template-columns: 1.1fr 0.9fr">
                <div class="card" style="min-height: 0">
                  <div class="card-title">
                    <strong>Live Transcript</strong>
                    <span class="tiny" id="liveHint">Shows approximate playback position</span>
                  </div>
                  <div class="transcript" id="transcript" aria-live="polite"></div>
                </div>
                <div class="card" style="min-height: 0">
                  <div class="card-title">
                    <strong>History</strong>
                    <span class="tiny">Click to restore</span>
                  </div>
                  <div class="history" id="history"></div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <dialog id="dlgAbout">
      <div class="modal">
        <div class="mhead">
          <h3>About</h3>
          <button class="mini" id="closeAbout" type="button">Close</button>
        </div>
        <div class="mcontent">
          <p style="margin: 0">
            This single‑file app is <span class="hl">inspired by openai.fm</span>—a playful voice playground. Here, the
            “model” is your browser’s built‑in Text‑to‑Speech engine (<span class="tag">SpeechSynthesis</span>).
          </p>
          <div class="grid2">
            <div class="example">
              <div class="k">Shortcuts</div>
              <div class="v">
                <div><span class="tag">Ctrl/⌘</span> + <span class="tag">Enter</span> Speak</div>
                <div><span class="tag">Space</span> Pause/Resume</div>
                <div><span class="tag">Esc</span> Stop</div>
              </div>
            </div>
            <div class="example">
              <div class="k">Notes</div>
              <div class="v">
                Voices vary by OS/browser. If the voice list is empty, try Chrome or Safari and ensure sound is enabled.
              </div>
            </div>
          </div>
          <p style="margin: 12px 0 0; color: rgba(255, 255, 255, 0.72); font-size: 13px">
            Built to be fully self‑contained: all CSS and JS are inline, no assets required.
          </p>
        </div>
      </div>
    </dialog>

    <dialog id="dlgExamples">
      <div class="modal">
        <div class="mhead">
          <h3>Examples</h3>
          <button class="mini" id="closeExamples" type="button">Close</button>
        </div>
        <div class="mcontent">
          <div class="grid2" id="examplesGrid"></div>
        </div>
      </div>
    </dialog>

    <script>
      (() => {
        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const supportsTTS = "speechSynthesis" in window && "SpeechSynthesisUtterance" in window;
        const synth = supportsTTS ? window.speechSynthesis : null;

        const ui = {
          viz: $("#viz"),
          voiceSearch: $("#voiceSearch"),
          voiceList: $("#voiceList"),
          voicesHint: $("#voicesHint"),
          supportNote: $("#supportNote"),
          presetChips: $("#presetChips"),
          script: $("#script"),
          rate: $("#rate"),
          pitch: $("#pitch"),
          volume: $("#volume"),
          energy: $("#energy"),
          rateVal: $("#rateVal"),
          pitchVal: $("#pitchVal"),
          volumeVal: $("#volumeVal"),
          energyVal: $("#energyVal"),
          wpmHint: $("#wpmHint"),
          chipPunct: $("#chipPunct"),
          chipBreath: $("#chipBreath"),
          chipDuet: $("#chipDuet"),
          btnSpeak: $("#btnSpeak"),
          btnPause: $("#btnPause"),
          btnStop: $("#btnStop"),
          btnAmbient: $("#btnAmbient"),
          btnShare: $("#btnShare"),
          btnAbout: $("#btnAbout"),
          btnExamples: $("#btnExamples"),
          dlgAbout: $("#dlgAbout"),
          dlgExamples: $("#dlgExamples"),
          closeAbout: $("#closeAbout"),
          closeExamples: $("#closeExamples"),
          studioHint: $("#studioHint"),
          voiceTitle: $("#voiceTitle"),
          metaLine: $("#metaLine"),
          stateBadge: $("#stateBadge"),
          transcript: $("#transcript"),
          progressFill: $("#progressFill"),
          timeNow: $("#timeNow"),
          timeTotal: $("#timeTotal"),
          history: $("#history"),
          toast: $("#toast"),
          filterAll: $("#filterAll"),
          filterLocal: $("#filterLocal"),
          filterEn: $("#filterEn"),
          examplesGrid: $("#examplesGrid"),
        };

        const DEFAULT_SCRIPT =
          "Welcome to Voice Studio.\n\nTry different voices, tweak the mix, and hit Speak. Then press Share to copy a link that preserves your settings.\n\nNow: read this like a friendly podcast intro—confident, warm, and slightly curious.";

        const PRESETS = [
          { id: "studio", name: "Studio", rate: 1.0, pitch: 1.0, volume: 1.0, punct: true, breath: false, hint: "Balanced and clean." },
          { id: "podcast", name: "Podcast", rate: 0.96, pitch: 0.98, volume: 1.0, punct: true, breath: true, hint: "Slightly slower, natural pauses." },
          { id: "news", name: "News", rate: 1.05, pitch: 1.02, volume: 1.0, punct: true, breath: false, hint: "Crisp and steady." },
          { id: "story", name: "Story", rate: 0.93, pitch: 1.05, volume: 1.0, punct: true, breath: true, hint: "Expressive pacing." },
          { id: "dramatic", name: "Dramatic", rate: 0.86, pitch: 0.95, volume: 1.0, punct: true, breath: true, hint: "Big pauses, cinematic." },
          { id: "bright", name: "Bright", rate: 1.12, pitch: 1.18, volume: 1.0, punct: true, breath: false, hint: "Upbeat and lively." },
          { id: "whisper", name: "Whisper", rate: 0.92, pitch: 0.86, volume: 0.55, punct: true, breath: true, hint: "Soft and intimate." },
        ];

        const EXAMPLES = [
          {
            title: "Product Launch (confident)",
            meta: "Preset: News • Rate 1.05 • Pitch 1.02",
            preset: "news",
            text:
              "Today we’re introducing a new way to build.\n\nIt’s fast, it’s focused, and it stays out of your way. In the next sixty seconds, I’ll show you what’s new—and why it matters.",
          },
          {
            title: "Bedtime Story (cozy)",
            meta: "Preset: Story • Add pauses",
            preset: "story",
            text:
              "In a quiet city made of glass, a small lantern decided it wanted to learn the sound of the ocean.\n\nSo it packed a single spark, took a deep breath… and began to glow its way toward the horizon.",
          },
          {
            title: "Podcast Cold Open (warm)",
            meta: "Preset: Podcast • Duet mode (optional)",
            preset: "podcast",
            text:
              "You’re listening to The Tiny Decisions.\n\nEvery week, we take one small choice—and follow it all the way to an unexpected outcome.\n\nToday: why the best plans feel a little boring at first.",
          },
          {
            title: "Guided Breathing (gentle)",
            meta: "Preset: Whisper • Add pauses",
            preset: "whisper",
            text:
              "Let your shoulders drop.\n\nInhale slowly for four.\n\nHold for two.\n\nExhale for six.\n\nAgain—inhale… and soften your jaw as you breathe out.",
          },
        ];

        const STORAGE_KEY = "openai-fm-inspired.voice-studio.v1";
        const HISTORY_KEY = "openai-fm-inspired.voice-studio.history.v1";

        const state = {
          voices: [],
          selectedVoiceURI: "",
          duetVoiceURI: "",
          presetId: "studio",
          rate: 1,
          pitch: 1,
          volume: 1,
          energy: 0.65,
          autoPunct: true,
          addBreath: false,
          duetMode: false,
          ambient: true,
          speaking: false,
          paused: false,
          current: {
            id: 0,
            text: "",
            segments: [],
            segIndex: 0,
            charIndex: 0,
            startedAt: 0,
            estTotalMs: 0,
          },
          filter: { localOnly: false, englishOnly: false, q: "" },
        };

        function clamp(n, a, b) {
          return Math.max(a, Math.min(b, n));
        }

        function fmtTime(ms) {
          const s = Math.max(0, Math.round(ms / 1000));
          const m = Math.floor(s / 60);
          const r = s % 60;
          return `${m}:${String(r).padStart(2, "0")}`;
        }

        function toast(message) {
          ui.toast.textContent = message;
          ui.toast.classList.add("show");
          clearTimeout(toast._t);
          toast._t = setTimeout(() => ui.toast.classList.remove("show"), 1600);
        }

        function safeJsonParse(s) {
          try {
            return JSON.parse(s);
          } catch {
            return null;
          }
        }

        function encodeStateHash(payload) {
          const json = JSON.stringify(payload);
          const bytes = new TextEncoder().encode(json);
          let bin = "";
          for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
          return btoa(bin).replace(/=+$/g, "");
        }

        function decodeStateHash(hash) {
          if (!hash) return null;
          const clean = hash.replace(/^#/, "").trim();
          if (!clean) return null;
          try {
            const bin = atob(clean);
            const bytes = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
            const json = new TextDecoder().decode(bytes);
            return safeJsonParse(json);
          } catch {
            return null;
          }
        }

        function saveState() {
          const payload = {
            selectedVoiceURI: state.selectedVoiceURI,
            duetVoiceURI: state.duetVoiceURI,
            presetId: state.presetId,
            rate: state.rate,
            pitch: state.pitch,
            volume: state.volume,
            energy: state.energy,
            autoPunct: state.autoPunct,
            addBreath: state.addBreath,
            duetMode: state.duetMode,
            ambient: state.ambient,
            text: ui.script.value,
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        }

        function loadState() {
          const fromHash = decodeStateHash(location.hash);
          const fromStorage = safeJsonParse(localStorage.getItem(STORAGE_KEY) || "");
          const payload = fromHash || fromStorage;
          if (!payload) {
            ui.script.value = DEFAULT_SCRIPT;
            return;
          }
          ui.script.value = typeof payload.text === "string" ? payload.text : DEFAULT_SCRIPT;
          state.selectedVoiceURI = payload.selectedVoiceURI || "";
          state.duetVoiceURI = payload.duetVoiceURI || "";
          state.presetId = payload.presetId || "studio";
          state.rate = Number.isFinite(payload.rate) ? payload.rate : 1;
          state.pitch = Number.isFinite(payload.pitch) ? payload.pitch : 1;
          state.volume = Number.isFinite(payload.volume) ? payload.volume : 1;
          state.energy = Number.isFinite(payload.energy) ? payload.energy : 0.65;
          state.autoPunct = payload.autoPunct !== false;
          state.addBreath = !!payload.addBreath;
          state.duetMode = !!payload.duetMode;
          state.ambient = payload.ambient !== false;
        }

        function getHistory() {
          const arr = safeJsonParse(localStorage.getItem(HISTORY_KEY) || "");
          return Array.isArray(arr) ? arr : [];
        }

        function pushHistory(entry) {
          const history = getHistory();
          history.unshift(entry);
          const trimmed = history.slice(0, 14);
          localStorage.setItem(HISTORY_KEY, JSON.stringify(trimmed));
          renderHistory();
        }

        function renderHistory() {
          const history = getHistory();
          ui.history.innerHTML = "";
          if (history.length === 0) {
            const d = document.createElement("div");
            d.className = "tiny";
            d.textContent = "No history yet. Speak something memorable.";
            ui.history.appendChild(d);
            return;
          }
          for (const h of history) {
            const el = document.createElement("div");
            el.className = "hitem";
            el.tabIndex = 0;
            el.role = "button";
            el.setAttribute("aria-label", "Restore from history");
            el.innerHTML = `<div class="t"></div><div class="m"></div>`;
            $(".t", el).textContent = (h.text || "").replace(/\s+/g, " ").trim().slice(0, 120) || "(empty)";
            $(".m", el).textContent = `${h.presetId || "studio"} • rate ${Number(h.rate || 1).toFixed(2)} • pitch ${Number(
              h.pitch || 1
            ).toFixed(2)} • ${new Date(h.ts || Date.now()).toLocaleString()}`;
            const restore = () => {
              ui.script.value = h.text || "";
              state.selectedVoiceURI = h.selectedVoiceURI || state.selectedVoiceURI;
              state.duetVoiceURI = h.duetVoiceURI || state.duetVoiceURI;
              applyPresetById(h.presetId || state.presetId, { silentToast: true, keepToggles: true });
              state.rate = Number.isFinite(h.rate) ? h.rate : state.rate;
              state.pitch = Number.isFinite(h.pitch) ? h.pitch : state.pitch;
              state.volume = Number.isFinite(h.volume) ? h.volume : state.volume;
              state.energy = Number.isFinite(h.energy) ? h.energy : state.energy;
              state.autoPunct = h.autoPunct !== false;
              state.addBreath = !!h.addBreath;
              state.duetMode = !!h.duetMode;
              syncUIFromState();
              saveState();
              toast("Restored from history");
              renderVoiceList();
              updateStatus();
              renderTranscript();
            };
            el.addEventListener("click", restore);
            el.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                restore();
              }
            });
            ui.history.appendChild(el);
          }
        }

        function renderExamples() {
          ui.examplesGrid.innerHTML = "";
          for (const ex of EXAMPLES) {
            const card = document.createElement("div");
            card.className = "example";
            card.innerHTML = `
              <div class="k">${ex.title}</div>
              <div class="v" style="color: rgba(255,255,255,0.76); font-size: 12px; margin-top: 4px">${ex.meta}</div>
              <div class="v" style="margin-top: 10px; white-space: pre-wrap">${escapeHtml(ex.text)}</div>
              <button class="btn primary use" type="button">Use this</button>
            `;
            $(".use", card).addEventListener("click", () => {
              ui.script.value = ex.text;
              applyPresetById(ex.preset, { silentToast: true });
              renderTranscript();
              saveState();
              toast("Loaded example");
              ui.dlgExamples.close();
            });
            ui.examplesGrid.appendChild(card);
          }
        }

        function escapeHtml(text) {
          return String(text)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function pickDefaultVoice(voices) {
          const langPref = (navigator.language || "en").toLowerCase();
          const byExact = voices.find((v) => (v.lang || "").toLowerCase() === langPref);
          if (byExact) return byExact;
          const byEn = voices.find((v) => (v.lang || "").toLowerCase().startsWith("en"));
          if (byEn) return byEn;
          return voices[0] || null;
        }

        function normalizeVoices(raw) {
          const voices = [...raw];
          voices.sort((a, b) => {
            const la = (a.lang || "").toLowerCase();
            const lb = (b.lang || "").toLowerCase();
            const na = (a.name || "").toLowerCase();
            const nb = (b.name || "").toLowerCase();
            return la === lb ? na.localeCompare(nb) : la.localeCompare(lb);
          });
          return voices;
        }

        function updateVoices() {
          if (!supportsTTS) {
            ui.voicesHint.textContent = "Text-to-Speech not supported in this browser.";
            ui.supportNote.textContent = "Try a modern Chrome/Safari/Edge browser with SpeechSynthesis support.";
            return;
          }
          const voices = normalizeVoices(synth.getVoices());
          state.voices = voices;
          if (voices.length === 0) {
            ui.voicesHint.textContent = "No voices available yet…";
            ui.supportNote.textContent =
              "Some browsers load voices asynchronously. If this persists, try reloading or switching browsers.";
          } else {
            ui.voicesHint.textContent = `${voices.length} voices detected`;
            ui.supportNote.textContent = "";
          }
          if (!state.selectedVoiceURI && voices.length) {
            const v = pickDefaultVoice(voices);
            state.selectedVoiceURI = v ? v.voiceURI : "";
          } else if (state.selectedVoiceURI && voices.length) {
            const exists = voices.some((v) => v.voiceURI === state.selectedVoiceURI);
            if (!exists) state.selectedVoiceURI = pickDefaultVoice(voices)?.voiceURI || "";
          }
          if (state.duetVoiceURI && voices.length) {
            const ok = voices.some((v) => v.voiceURI === state.duetVoiceURI);
            if (!ok) state.duetVoiceURI = "";
          }
          renderVoiceList();
          updateStatus();
        }

        function voiceMatchesFilter(v) {
          const q = (state.filter.q || "").trim().toLowerCase();
          const hay = `${v.name || ""} ${v.lang || ""} ${v.voiceURI || ""}`.toLowerCase();
          if (q && !hay.includes(q)) return false;
          if (state.filter.localOnly && !v.localService) return false;
          if (state.filter.englishOnly && !(v.lang || "").toLowerCase().startsWith("en")) return false;
          return true;
        }

        function renderVoiceList() {
          ui.voiceList.innerHTML = "";
          const voices = state.voices.filter(voiceMatchesFilter);
          if (voices.length === 0) {
            const empty = document.createElement("div");
            empty.className = "tiny";
            empty.textContent = state.voices.length ? "No voices match your filter." : "No voices loaded yet.";
            ui.voiceList.appendChild(empty);
            return;
          }

          const selectedIdx = voices.findIndex((v) => v.voiceURI === state.selectedVoiceURI);
          if (selectedIdx !== -1) {
            // keep selected visible by moving it to top
            const sel = voices[selectedIdx];
            voices.splice(selectedIdx, 1);
            voices.unshift(sel);
          }

          for (const v of voices.slice(0, 80)) {
            const row = document.createElement("div");
            row.className = "voice";
            row.role = "option";
            row.tabIndex = 0;
            row.dataset.uri = v.voiceURI || "";
            row.setAttribute("aria-selected", String(v.voiceURI === state.selectedVoiceURI));
            const lang = (v.lang || "").toUpperCase() || "—";
            const tags = [
              `<span class="tag">${lang}</span>`,
              v.localService ? `<span class="tag">LOCAL</span>` : `<span class="tag">REMOTE</span>`,
              v.default ? `<span class="tag">DEFAULT</span>` : "",
            ].filter(Boolean);

            row.innerHTML = `
              <div>
                <div class="name"></div>
                <div class="meta">${tags.join("")}</div>
              </div>
              <div class="actions">
                <button class="mini" type="button" data-act="preview" title="Preview this voice">Preview</button>
                <button class="mini" type="button" data-act="duet" title="Set as duet partner">Duet</button>
              </div>
            `;
            $(".name", row).textContent = v.name || "Unnamed voice";

            const select = () => {
              state.selectedVoiceURI = v.voiceURI;
              renderVoiceList();
              updateStatus();
              saveState();
              toast("Voice selected");
            };

            row.addEventListener("click", (e) => {
              const act = e.target?.dataset?.act;
              if (act === "preview") return previewVoice(v);
              if (act === "duet") return setDuetVoice(v);
              select();
            });
            row.addEventListener("keydown", (e) => {
              if (e.key === "Enter") select();
              if (e.key === " ") {
                e.preventDefault();
                select();
              }
            });
            ui.voiceList.appendChild(row);
          }
        }

        function setDuetVoice(v) {
          state.duetVoiceURI = v.voiceURI;
          state.duetMode = true;
          ui.chipDuet.setAttribute("aria-pressed", "true");
          saveState();
          toast("Duet partner set");
          updateStatus();
          renderVoiceList();
        }

        function previewVoice(v) {
          if (!supportsTTS) return;
          stop();
          const sample = `Hi—this is ${v.name || "a voice"}.`;
          const u = new SpeechSynthesisUtterance(sample);
          u.voice = v;
          u.rate = clamp(state.rate, 0.5, 1.6);
          u.pitch = clamp(state.pitch, 0.5, 1.6);
          u.volume = clamp(state.volume, 0, 1);
          u.onstart = () => {
            state.speaking = true;
            state.paused = false;
            setBadge("PREVIEW", "rgba(0, 212, 255, 0.18)");
            updateButtons();
            viz.setSpeaking(true);
          };
          u.onend = () => {
            state.speaking = false;
            state.paused = false;
            updateButtons();
            viz.setSpeaking(false);
            setBadge("READY", null);
            renderTranscript();
          };
          synth.speak(u);
          toast("Previewing…");
        }

        function setBadge(text, bg) {
          ui.stateBadge.textContent = text;
          ui.stateBadge.style.background = bg || "rgba(0, 0, 0, 0.18)";
        }

        function updateButtons() {
          const active = state.speaking || synth?.speaking;
          const paused = state.paused || synth?.paused;
          ui.btnStop.disabled = !active;
          ui.btnPause.disabled = !active;
          ui.btnSpeak.disabled = false;
          ui.btnPause.textContent = paused ? "Resume" : "Pause";
          ui.btnPause.innerHTML = paused
            ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 5v14l11-7z"/></svg>Resume`
            : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>Pause`;
        }

        function estimateDurationMs(text, rate) {
          const words = (text.trim().match(/\S+/g) || []).length;
          const baseWpm = 178;
          const wpm = baseWpm * clamp(rate, 0.5, 1.6);
          const minutes = words / Math.max(60, wpm);
          return minutes * 60_000;
        }

        function applyAutoPunct(text) {
          let t = text.trim();
          if (!t) return t;
          // If it already contains punctuation, keep it.
          if (/[.!?…,:;—-]/.test(t)) return t;
          // Lightly segment by line breaks.
          const parts = t.split(/\n+/).map((p) => p.trim()).filter(Boolean);
          return parts.map((p) => (/[.!?…]$/.test(p) ? p : p + ".")).join("\n\n");
        }

        function applyBreath(text) {
          // Add subtle pauses by inserting commas / em dashes between sentences.
          return text
            .replace(/([.!?…])(\s+)([A-Z“"'])/g, "$1 — $3")
            .replace(/\n{2,}/g, "\n\n");
        }

        function applyPresetById(id, opts = {}) {
          const preset = PRESETS.find((p) => p.id === id) || PRESETS[0];
          state.presetId = preset.id;
          state.rate = preset.rate;
          state.pitch = preset.pitch;
          state.volume = preset.volume;
          state.autoPunct = preset.punct;
          state.addBreath = preset.breath;

          if (!opts.keepToggles) {
            ui.chipPunct.setAttribute("aria-pressed", String(state.autoPunct));
            ui.chipBreath.setAttribute("aria-pressed", String(state.addBreath));
          }

          syncUIFromState();
          renderPresetChips();
          updateStatus();
          if (!opts.silentToast) toast(`Preset: ${preset.name}`);
        }

        function renderPresetChips() {
          ui.presetChips.innerHTML = "";
          for (const p of PRESETS) {
            const b = document.createElement("button");
            b.type = "button";
            b.className = "chip";
            b.setAttribute("aria-pressed", String(state.presetId === p.id));
            b.textContent = p.name;
            b.title = p.hint;
            b.addEventListener("click", () => {
              applyPresetById(p.id);
              saveState();
            });
            ui.presetChips.appendChild(b);
          }
        }

        function syncUIFromState() {
          ui.rate.value = String(state.rate);
          ui.pitch.value = String(state.pitch);
          ui.volume.value = String(state.volume);
          ui.energy.value = String(state.energy);
          ui.rateVal.textContent = `${Number(state.rate).toFixed(2)}×`;
          ui.pitchVal.textContent = `${Number(state.pitch).toFixed(2)}×`;
          ui.volumeVal.textContent = `${Number(state.volume).toFixed(2)}×`;
          ui.energyVal.textContent = `${Number(state.energy).toFixed(2)}`;
          ui.chipPunct.setAttribute("aria-pressed", String(state.autoPunct));
          ui.chipBreath.setAttribute("aria-pressed", String(state.addBreath));
          ui.chipDuet.setAttribute("aria-pressed", String(state.duetMode));
          ui.btnAmbient.setAttribute("aria-pressed", String(state.ambient));
          viz.setAmbient(state.ambient);
        }

        function getSelectedVoice(uri) {
          return state.voices.find((v) => v.voiceURI === uri) || null;
        }

        function updateStatus() {
          const v = getSelectedVoice(state.selectedVoiceURI);
          ui.voiceTitle.textContent = `Voice: ${v ? v.name : "—"}`;
          const duet = state.duetMode ? getSelectedVoice(state.duetVoiceURI) : null;
          const preset = PRESETS.find((p) => p.id === state.presetId)?.name || "Studio";
          const flags = [
            `${preset}`,
            `rate ${Number(state.rate).toFixed(2)}`,
            `pitch ${Number(state.pitch).toFixed(2)}`,
            `vol ${Number(state.volume).toFixed(2)}`,
            state.autoPunct ? "auto‑punct" : "raw",
            state.addBreath ? "pauses" : null,
            state.duetMode ? `duet${duet ? `: ${duet.name}` : ""}` : null,
          ].filter(Boolean);

          const txt = ui.script.value.trim();
          const est = estimateDurationMs(txt, state.rate);
          ui.timeTotal.textContent = fmtTime(est);
          ui.metaLine.textContent = flags.join(" • ");
          const baseWpm = 178;
          ui.wpmHint.textContent = `~${Math.round(baseWpm * clamp(state.rate, 0.5, 1.6))} wpm`;
        }

        function renderTranscript() {
          const t = ui.script.value || "";
          const idx = clamp(state.current.charIndex || 0, 0, t.length);
          if (!state.speaking && !synth?.speaking) {
            ui.transcript.innerHTML = `<span class="dim">${escapeHtml(t || "Type something to begin…")}</span>`;
            return;
          }
          const pre = t.slice(0, idx);
          const cur = t.slice(idx, idx + 1) || "";
          const post = t.slice(idx + 1);
          ui.transcript.innerHTML = `<span class="dim">${escapeHtml(pre)}</span><span class="hl">${escapeHtml(
            cur || ""
          )}</span><span class="hl">${escapeHtml(post)}</span><span class="cursor" aria-hidden="true"></span>`;
        }

        function splitSegments(text) {
          const segments = text
            .split(/\n{2,}/g)
            .map((s) => s.trim())
            .filter(Boolean);
          return segments.length ? segments : [text.trim()].filter(Boolean);
        }

        function buildUtterance(text, voice, base = {}) {
          const u = new SpeechSynthesisUtterance(text);
          if (voice) u.voice = voice;
          u.rate = clamp(base.rate, 0.5, 1.6);
          u.pitch = clamp(base.pitch, 0.5, 1.6);
          u.volume = clamp(base.volume, 0, 1);
          return u;
        }

        function speak() {
          if (!supportsTTS) {
            toast("This browser doesn’t support SpeechSynthesis.");
            return;
          }
          if (synth.speaking) synth.cancel();

          let text = ui.script.value || "";
          if (!text.trim()) {
            toast("Type a script first.");
            return;
          }

          if (state.autoPunct) text = applyAutoPunct(text);
          if (state.addBreath) text = applyBreath(text);

          const segments = splitSegments(text);
          const selected = getSelectedVoice(state.selectedVoiceURI) || pickDefaultVoice(state.voices);
          const duet = state.duetMode ? getSelectedVoice(state.duetVoiceURI) : null;
          if (!selected) {
            toast("No voice available yet.");
            return;
          }

          // Keep UI in sync with transformed text if helpers changed it.
          if (text !== ui.script.value) ui.script.value = text;

          const id = (state.current.id = (state.current.id || 0) + 1);
          state.current.text = text;
          state.current.segments = segments;
          state.current.segIndex = 0;
          state.current.charIndex = 0;
          state.current.startedAt = performance.now();
          state.current.estTotalMs = estimateDurationMs(text, state.rate);
          ui.timeTotal.textContent = fmtTime(state.current.estTotalMs);
          ui.timeNow.textContent = "0:00";
          ui.progressFill.style.width = "0%";

          const onStart = () => {
            state.speaking = true;
            state.paused = false;
            setBadge("LIVE", "rgba(124, 92, 255, 0.14)");
            updateButtons();
            viz.setSpeaking(true);
            renderTranscript();
            updateStatus();
          };
          const onEndAll = () => {
            state.speaking = false;
            state.paused = false;
            setBadge("READY", null);
            updateButtons();
            viz.setSpeaking(false);
            state.current.charIndex = 0;
            ui.progressFill.style.width = "0%";
            ui.timeNow.textContent = "0:00";
            renderTranscript();
            pushHistory({
              ts: Date.now(),
              text,
              selectedVoiceURI: state.selectedVoiceURI,
              duetVoiceURI: state.duetVoiceURI,
              presetId: state.presetId,
              rate: state.rate,
              pitch: state.pitch,
              volume: state.volume,
              energy: state.energy,
              autoPunct: state.autoPunct,
              addBreath: state.addBreath,
              duetMode: state.duetMode,
            });
          };

          const offsets = [];
          {
            let acc = 0;
            for (const seg of segments) {
              offsets.push(acc);
              acc += seg.length + 2; // approximate: two newlines between segments
            }
          }

          const queue = segments.map((seg, i) => {
            const useDuet = state.duetMode && duet && i % 2 === 1;
            const voice = useDuet ? duet : selected;
            const u = buildUtterance(seg, voice, { rate: state.rate, pitch: state.pitch, volume: state.volume });
            u.onstart = () => {
              if (state.current.id !== id) return;
              if (i === 0) onStart();
              state.current.segIndex = i;
              viz.pulse(0.8);
              renderTranscript();
            };
            u.onboundary = (ev) => {
              if (state.current.id !== id) return;
              // Many browsers provide charIndex; some provide name="word".
              if (typeof ev.charIndex === "number") {
                const baseOffset = offsets[i] || 0;
                state.current.charIndex = clamp(baseOffset + ev.charIndex, 0, state.current.text.length);
              } else {
                const elapsed = performance.now() - state.current.startedAt;
                const p = clamp(elapsed / Math.max(1, state.current.estTotalMs), 0, 1);
                state.current.charIndex = Math.floor(p * state.current.text.length);
              }
              renderTranscript();
            };
            u.onend = () => {
              if (state.current.id !== id) return;
              viz.pulse(0.5);
              if (i === queue.length - 1) onEndAll();
            };
            u.onerror = () => {
              if (state.current.id !== id) return;
              toast("Speech error (try a different voice).");
              onEndAll();
            };
            return u;
          });

          for (const u of queue) synth.speak(u);
          saveState();
          toast("Speaking…");
        }

        function pauseOrResume() {
          if (!supportsTTS) return;
          if (!synth.speaking) return;
          if (synth.paused) {
            synth.resume();
            state.paused = false;
            setBadge("LIVE", "rgba(124, 92, 255, 0.14)");
            viz.setPaused(false);
          } else {
            synth.pause();
            state.paused = true;
            setBadge("PAUSED", "rgba(255, 255, 255, 0.08)");
            viz.setPaused(true);
          }
          updateButtons();
        }

        function stop() {
          if (!supportsTTS) return;
          if (synth.speaking || synth.paused) synth.cancel();
          state.speaking = false;
          state.paused = false;
          state.current.charIndex = 0;
          ui.progressFill.style.width = "0%";
          ui.timeNow.textContent = "0:00";
          setBadge("READY", null);
          updateButtons();
          viz.setSpeaking(false);
          renderTranscript();
          toast("Stopped");
        }

        function share() {
          const payload = {
            selectedVoiceURI: state.selectedVoiceURI,
            duetVoiceURI: state.duetVoiceURI,
            presetId: state.presetId,
            rate: state.rate,
            pitch: state.pitch,
            volume: state.volume,
            energy: state.energy,
            autoPunct: state.autoPunct,
            addBreath: state.addBreath,
            duetMode: state.duetMode,
            ambient: state.ambient,
            text: ui.script.value,
          };
          const hash = encodeStateHash(payload);
          const url = `${location.origin}${location.pathname}#${hash}`;
          const doCopy = async () => {
            try {
              await navigator.clipboard.writeText(url);
              toast("Link copied");
            } catch {
              prompt("Copy link:", url);
            }
          };
          doCopy();
          history.replaceState(null, "", `#${hash}`);
        }

        // Visualizer: procedural “voice waveform” (not a true audio capture).
        const viz = (() => {
          const canvas = ui.viz;
          const ctx = canvas.getContext("2d", { alpha: true });
          const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
          let w = 0,
            h = 0;
          let raf = 0;
          let t = 0;
          let ambient = true;
          let speaking = false;
          let paused = false;
          let level = 0.0;
          let target = 0.0;
          let burst = 0.0;
          const blobs = [];

          function resize() {
            w = Math.floor(window.innerWidth);
            h = Math.floor(window.innerHeight);
            canvas.width = Math.floor(w * dpr);
            canvas.height = Math.floor(h * dpr);
            canvas.style.width = `${w}px`;
            canvas.style.height = `${h}px`;
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
          }

          function addBlob() {
            const r = 80 + Math.random() * 260;
            blobs.push({
              x: Math.random() * w,
              y: Math.random() * h,
              r,
              vx: (-0.5 + Math.random()) * 0.12,
              vy: (-0.5 + Math.random()) * 0.12,
              a: 0.06 + Math.random() * 0.08,
              hue: 200 + Math.random() * 100,
            });
            if (blobs.length > 10) blobs.shift();
          }

          function setAmbient(on) {
            ambient = !!on;
          }
          function setSpeaking(on) {
            speaking = !!on;
            if (speaking) burst = 1;
          }
          function setPaused(on) {
            paused = !!on;
          }
          function pulse(amt) {
            burst = Math.max(burst, amt || 0.5);
          }

          function draw() {
            raf = requestAnimationFrame(draw);
            t += 0.010;

            if (!ambient && !speaking) {
              ctx.clearRect(0, 0, w, h);
              return;
            }

            // target voice energy:
            const e = clamp(Number(state.energy) || 0.65, 0.05, 1);
            target = speaking && !paused ? e : ambient ? 0.18 : 0.0;

            const jitter = speaking && !paused ? (0.4 + 0.6 * Math.sin(t * 2.1)) : 0.2 + 0.12 * Math.sin(t * 0.8);
            const targetWithJitter = target * (0.7 + 0.3 * jitter) + burst * 0.28;
            level += (targetWithJitter - level) * 0.06;
            burst *= 0.92;

            ctx.clearRect(0, 0, w, h);

            // Soft blobs
            if (Math.random() < 0.018) addBlob();
            for (const b of blobs) {
              b.x += b.vx * (1 + level * 2);
              b.y += b.vy * (1 + level * 2);
              if (b.x < -b.r) b.x = w + b.r;
              if (b.x > w + b.r) b.x = -b.r;
              if (b.y < -b.r) b.y = h + b.r;
              if (b.y > h + b.r) b.y = -b.r;
              const g = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r * (0.9 + level * 0.6));
              g.addColorStop(0, `hsla(${b.hue}, 95%, 60%, ${b.a * (0.7 + level)})`);
              g.addColorStop(1, "hsla(0, 0%, 0%, 0)");
              ctx.fillStyle = g;
              ctx.beginPath();
              ctx.arc(b.x, b.y, b.r * (0.9 + level * 0.6), 0, Math.PI * 2);
              ctx.fill();
            }

            // Central “wave”
            const midY = h * 0.55;
            const pad = 10;
            const span = w - pad * 2;
            const waveCount = 3;
            for (let i = 0; i < waveCount; i++) {
              const p = i / (waveCount - 1);
              const amp = (16 + 34 * level) * (0.65 + 0.45 * Math.sin(t * (1.2 + p)));
              const freq = 1.4 + p * 0.9;
              const yOff = (p - 0.5) * (18 + level * 18);
              const hue = 200 + p * 120;
              ctx.strokeStyle = `rgba(255,255,255,${0.05 + 0.12 * level})`;
              ctx.lineWidth = 1;
              ctx.beginPath();
              for (let x = 0; x <= 200; x++) {
                const xn = x / 200;
                const X = pad + xn * span;
                const wobble = Math.sin(t * 2.2 + xn * 10.0) * (0.15 + level * 0.22);
                const Y =
                  midY +
                  yOff +
                  Math.sin(xn * Math.PI * 2 * freq + t * 2.6) * amp * (0.65 + 0.35 * Math.sin(t + xn * 2)) +
                  wobble * 30 * level;
                if (x === 0) ctx.moveTo(X, Y);
                else ctx.lineTo(X, Y);
              }
              ctx.stroke();

              // Glow line
              ctx.strokeStyle = `hsla(${hue}, 95%, 62%, ${0.10 + 0.22 * level})`;
              ctx.lineWidth = 2;
              ctx.shadowColor = `hsla(${hue}, 95%, 62%, ${0.35 * level})`;
              ctx.shadowBlur = 22 * level;
              ctx.beginPath();
              for (let x = 0; x <= 200; x++) {
                const xn = x / 200;
                const X = pad + xn * span;
                const Y = midY + yOff + Math.sin(xn * Math.PI * 2 * freq + t * 2.6) * amp;
                if (x === 0) ctx.moveTo(X, Y);
                else ctx.lineTo(X, Y);
              }
              ctx.stroke();
              ctx.shadowBlur = 0;
            }

            // Top subtle vignette
            const vg = ctx.createLinearGradient(0, 0, 0, h);
            vg.addColorStop(0, "rgba(0,0,0,0.55)");
            vg.addColorStop(0.35, "rgba(0,0,0,0)");
            vg.addColorStop(1, "rgba(0,0,0,0.45)");
            ctx.fillStyle = vg;
            ctx.fillRect(0, 0, w, h);
          }

          window.addEventListener("resize", resize, { passive: true });
          resize();
          addBlob();
          addBlob();
          draw();

          return { setAmbient, setSpeaking, setPaused, pulse };
        })();

        function tick() {
          if (!supportsTTS) return;
          const active = synth.speaking || state.speaking;
          if (active) {
            const elapsed = performance.now() - state.current.startedAt;
            const total = Math.max(1, state.current.estTotalMs || estimateDurationMs(ui.script.value || "", state.rate));
            const p = clamp(elapsed / total, 0, 1);
            ui.progressFill.style.width = `${Math.round(p * 1000) / 10}%`;
            ui.timeNow.textContent = fmtTime(elapsed);
          }
          updateButtons();
          requestAnimationFrame(tick);
        }

        // Events
        ui.voiceSearch.addEventListener("input", () => {
          state.filter.q = ui.voiceSearch.value;
          renderVoiceList();
        });

        const setFilterChip = (chip, pressed) => chip.setAttribute("aria-pressed", pressed ? "true" : "false");
        const refreshChips = () => {
          setFilterChip(ui.filterAll, !state.filter.localOnly && !state.filter.englishOnly);
          setFilterChip(ui.filterLocal, state.filter.localOnly);
          setFilterChip(ui.filterEn, state.filter.englishOnly);
        };

        ui.filterAll.addEventListener("click", () => {
          state.filter.localOnly = false;
          state.filter.englishOnly = false;
          refreshChips();
          renderVoiceList();
        });
        ui.filterLocal.addEventListener("click", () => {
          state.filter.localOnly = !state.filter.localOnly;
          if (state.filter.localOnly && state.filter.englishOnly) state.filter.englishOnly = false;
          refreshChips();
          renderVoiceList();
        });
        ui.filterEn.addEventListener("click", () => {
          state.filter.englishOnly = !state.filter.englishOnly;
          if (state.filter.localOnly && state.filter.englishOnly) state.filter.localOnly = false;
          refreshChips();
          renderVoiceList();
        });

        ui.rate.addEventListener("input", () => {
          state.rate = Number(ui.rate.value);
          ui.rateVal.textContent = `${Number(state.rate).toFixed(2)}×`;
          updateStatus();
          saveState();
        });
        ui.pitch.addEventListener("input", () => {
          state.pitch = Number(ui.pitch.value);
          ui.pitchVal.textContent = `${Number(state.pitch).toFixed(2)}×`;
          updateStatus();
          saveState();
        });
        ui.volume.addEventListener("input", () => {
          state.volume = Number(ui.volume.value);
          ui.volumeVal.textContent = `${Number(state.volume).toFixed(2)}×`;
          saveState();
        });
        ui.energy.addEventListener("input", () => {
          state.energy = Number(ui.energy.value);
          ui.energyVal.textContent = `${Number(state.energy).toFixed(2)}`;
          saveState();
        });

        ui.chipPunct.addEventListener("click", () => {
          state.autoPunct = !state.autoPunct;
          ui.chipPunct.setAttribute("aria-pressed", String(state.autoPunct));
          saveState();
          toast(state.autoPunct ? "Auto‑punctuate on" : "Auto‑punctuate off");
        });
        ui.chipBreath.addEventListener("click", () => {
          state.addBreath = !state.addBreath;
          ui.chipBreath.setAttribute("aria-pressed", String(state.addBreath));
          saveState();
          toast(state.addBreath ? "Pauses on" : "Pauses off");
        });
        ui.chipDuet.addEventListener("click", () => {
          state.duetMode = !state.duetMode;
          ui.chipDuet.setAttribute("aria-pressed", String(state.duetMode));
          saveState();
          toast(state.duetMode ? "Duet mode on" : "Duet mode off");
          updateStatus();
        });

        ui.script.addEventListener("input", () => {
          saveState();
          updateStatus();
          if (!state.speaking) renderTranscript();
        });

        ui.btnSpeak.addEventListener("click", speak);
        ui.btnPause.addEventListener("click", pauseOrResume);
        ui.btnStop.addEventListener("click", stop);
        ui.btnAmbient.addEventListener("click", () => {
          state.ambient = !state.ambient;
          ui.btnAmbient.setAttribute("aria-pressed", String(state.ambient));
          viz.setAmbient(state.ambient);
          saveState();
          toast(state.ambient ? "Ambient on" : "Ambient off");
        });
        ui.btnShare.addEventListener("click", share);

        ui.btnAbout.addEventListener("click", () => ui.dlgAbout.showModal());
        ui.closeAbout.addEventListener("click", () => ui.dlgAbout.close());
        ui.btnExamples.addEventListener("click", () => ui.dlgExamples.showModal());
        ui.closeExamples.addEventListener("click", () => ui.dlgExamples.close());

        document.addEventListener("keydown", (e) => {
          if (e.target && ["INPUT", "TEXTAREA"].includes(e.target.tagName)) {
            if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
              e.preventDefault();
              speak();
              return;
            }
          }
          if (e.key === "Escape") {
            if (ui.dlgAbout.open) ui.dlgAbout.close();
            else if (ui.dlgExamples.open) ui.dlgExamples.close();
            else stop();
            return;
          }
          if (e.key === " " && !e.repeat && !["INPUT", "TEXTAREA"].includes(e.target?.tagName || "")) {
            e.preventDefault();
            pauseOrResume();
            return;
          }
        });

        // Init
        loadState();
        renderPresetChips();
        renderExamples();
        renderHistory();
        syncUIFromState();
        refreshChips();
        updateStatus();
        renderTranscript();

        if (supportsTTS) {
          synth.addEventListener?.("voiceschanged", updateVoices);
          updateVoices();
          // Extra attempts: some browsers need a moment.
          setTimeout(updateVoices, 250);
          setTimeout(updateVoices, 1200);
          tick();
        } else {
          ui.supportNote.textContent =
            "SpeechSynthesis is unavailable. Try Chrome/Safari/Edge on desktop or mobile with system voices installed.";
          ui.btnSpeak.disabled = true;
          ui.btnPause.disabled = true;
          ui.btnStop.disabled = true;
          setBadge("UNSUPPORTED", "rgba(255, 77, 109, 0.12)");
        }
      })();
    </script>
  </body>
</html>
