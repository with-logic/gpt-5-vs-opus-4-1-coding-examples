<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="color-scheme" content="dark light" />
    <title>Pomodoro</title>
    <style>
      :root {
        --bg0: #070a12;
        --bg1: #0b1024;
        --card: rgba(255, 255, 255, 0.06);
        --card2: rgba(255, 255, 255, 0.08);
        --border: rgba(255, 255, 255, 0.12);
        --shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        --txt: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.65);
        --faint: rgba(255, 255, 255, 0.45);
        --accent: #7c5cff;
        --accent2: #00d4ff;
        --good: #2ee59d;
        --warn: #ffb020;
        --bad: #ff4d6d;
        --ringTrack: rgba(255, 255, 255, 0.14);
        --focus: #7c5cff;
        --short: #00d4ff;
        --long: #2ee59d;
        --radius: 18px;
        --font:
          ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial,
          "Apple Color Emoji", "Segoe UI Emoji";
      }
      :root[data-theme="light"] {
        --bg0: #f5f7ff;
        --bg1: #eaf2ff;
        --card: rgba(255, 255, 255, 0.7);
        --card2: rgba(255, 255, 255, 0.85);
        --border: rgba(20, 32, 58, 0.12);
        --shadow: 0 16px 42px rgba(30, 50, 90, 0.18);
        --txt: rgba(12, 16, 26, 0.92);
        --muted: rgba(12, 16, 26, 0.68);
        --faint: rgba(12, 16, 26, 0.5);
        --ringTrack: rgba(12, 16, 26, 0.12);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: var(--font);
        color: var(--txt);
        background:
          radial-gradient(1200px 900px at 20% 10%, rgba(124, 92, 255, 0.26), transparent 55%),
          radial-gradient(1000px 700px at 85% 25%, rgba(0, 212, 255, 0.2), transparent 55%),
          radial-gradient(1200px 800px at 55% 100%, rgba(46, 229, 157, 0.16), transparent 55%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        overflow-x: hidden;
      }
      a {
        color: inherit;
      }

      .app {
        min-height: 100%;
        display: flex;
        flex-direction: column;
      }

      .topbar {
        position: sticky;
        top: 0;
        z-index: 50;
        padding: max(14px, env(safe-area-inset-top)) 16px 12px;
        backdrop-filter: blur(16px);
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.24), rgba(0, 0, 0, 0));
      }
      :root[data-theme="light"] .topbar {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.82), rgba(255, 255, 255, 0));
      }
      .topbar-inner {
        max-width: 1120px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        user-select: none;
      }
      .logo {
        width: 38px;
        height: 38px;
        border-radius: 14px;
        background:
          radial-gradient(14px 14px at 25% 35%, rgba(255, 255, 255, 0.55), transparent 55%),
          linear-gradient(135deg, rgba(124, 92, 255, 1), rgba(0, 212, 255, 1));
        box-shadow: 0 14px 34px rgba(124, 92, 255, 0.25);
        position: relative;
        overflow: hidden;
      }
      .logo:after {
        content: "";
        position: absolute;
        inset: -20%;
        background: conic-gradient(
          from 180deg,
          rgba(255, 255, 255, 0.0),
          rgba(255, 255, 255, 0.28),
          rgba(255, 255, 255, 0.0)
        );
        animation: spin 5.4s linear infinite;
        opacity: 0.8;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .brand h1 {
        margin: 0;
        font-size: 16px;
        letter-spacing: 0.2px;
        font-weight: 700;
      }
      .brand .tag {
        font-size: 12px;
        color: var(--muted);
        margin-top: 1px;
      }
      .top-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
        color: var(--txt);
        border-radius: 999px;
        padding: 9px 12px;
        font-size: 13px;
        font-weight: 650;
        letter-spacing: 0.1px;
        display: inline-flex;
        gap: 8px;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        user-select: none;
        transition:
          transform 0.08s ease,
          background 0.15s ease,
          border-color 0.15s ease,
          box-shadow 0.15s ease;
      }
      .btn:hover {
        border-color: rgba(255, 255, 255, 0.22);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.16);
      }
      :root[data-theme="light"] .btn:hover {
        border-color: rgba(20, 32, 58, 0.2);
        box-shadow: 0 12px 24px rgba(30, 50, 90, 0.14);
      }
      .btn:active {
        transform: translateY(1px) scale(0.99);
      }
      .btn.primary {
        border-color: rgba(124, 92, 255, 0.45);
        background: linear-gradient(180deg, rgba(124, 92, 255, 0.9), rgba(124, 92, 255, 0.55));
        box-shadow: 0 18px 40px rgba(124, 92, 255, 0.22);
      }
      .btn.primary:hover {
        border-color: rgba(124, 92, 255, 0.65);
        box-shadow: 0 22px 52px rgba(124, 92, 255, 0.27);
      }
      .btn.danger {
        border-color: rgba(255, 77, 109, 0.35);
        background: linear-gradient(180deg, rgba(255, 77, 109, 0.25), rgba(255, 77, 109, 0.12));
      }
      .btn.ghost {
        background: transparent;
      }
      .btn.small {
        padding: 7px 10px;
        font-size: 12px;
      }
      .btn.icon {
        padding: 9px;
        width: 40px;
        height: 40px;
        border-radius: 14px;
      }
      .btn[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .wrap {
        max-width: 1120px;
        margin: 0 auto;
        padding: 6px 16px 22px;
        width: 100%;
      }

      .grid {
        display: grid;
        grid-template-columns: 1.25fr 0.95fr;
        gap: 14px;
        align-items: start;
      }
      @media (max-width: 960px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: linear-gradient(180deg, var(--card2), var(--card));
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .card-header {
        padding: 14px 14px 10px;
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }
      .card-header h2 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.2px;
        font-weight: 750;
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
      }
      .card-body {
        padding: 14px;
      }

      .timer-card {
        position: relative;
      }
      .phase-pills {
        display: flex;
        gap: 8px;
        padding: 14px 14px 0;
        flex-wrap: wrap;
      }
      .pill {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--muted);
        border-radius: 999px;
        padding: 7px 10px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        user-select: none;
        display: inline-flex;
        gap: 8px;
        align-items: center;
        transition:
          background 0.15s ease,
          border-color 0.15s ease,
          transform 0.08s ease;
      }
      .pill:active {
        transform: translateY(1px);
      }
      .pill[data-active="true"] {
        color: var(--txt);
        border-color: rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.12);
      }
      .dot {
        width: 9px;
        height: 9px;
        border-radius: 99px;
        background: currentColor;
        opacity: 0.9;
        box-shadow: 0 0 0 6px rgba(255, 255, 255, 0.02);
      }
      .dot.focus {
        color: var(--focus);
      }
      .dot.short {
        color: var(--short);
      }
      .dot.long {
        color: var(--long);
      }

      .timer-core {
        padding: 18px 14px 14px;
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 14px;
        align-items: center;
      }
      @media (max-width: 720px) {
        .timer-core {
          grid-template-columns: 1fr;
        }
      }
      .ring-wrap {
        display: grid;
        place-items: center;
        padding: 6px 0;
      }
      .ring {
        width: min(340px, 82vw);
        aspect-ratio: 1;
        position: relative;
      }
      .ring svg {
        width: 100%;
        height: 100%;
        display: block;
        transform: rotate(-90deg);
      }
      .ring .center {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        pointer-events: none;
      }
      .time {
        font-variant-numeric: tabular-nums;
        letter-spacing: -0.8px;
        font-weight: 860;
        font-size: clamp(46px, 6vw, 66px);
        line-height: 1;
        margin: 0;
        text-shadow: 0 22px 48px rgba(0, 0, 0, 0.25);
      }
      :root[data-theme="light"] .time {
        text-shadow: 0 18px 46px rgba(30, 50, 90, 0.18);
      }
      .subtitle {
        margin-top: 10px;
        font-size: 13px;
        color: var(--muted);
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
      }
      .badge {
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 5px 10px;
        font-size: 12px;
        color: var(--muted);
        background: rgba(255, 255, 255, 0.06);
      }
      .badge strong {
        color: var(--txt);
        font-weight: 780;
      }

      .controls {
        display: grid;
        gap: 10px;
        padding: 10px 0;
      }
      .controls .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-start;
      }
      .controls .row.actions {
        gap: 10px;
      }
      .controls .row.actions .btn {
        flex: 1 1 auto;
        min-width: 120px;
      }
      @media (max-width: 720px) {
        .controls .row.actions .btn {
          flex: 1 1 160px;
        }
      }
      .toggles {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .toggle {
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 7px 10px;
        background: rgba(255, 255, 255, 0.06);
        display: inline-flex;
        align-items: center;
        gap: 10px;
        user-select: none;
      }
      .toggle span {
        font-size: 12px;
        color: var(--muted);
        font-weight: 700;
      }
      .switch {
        width: 44px;
        height: 26px;
        border-radius: 999px;
        position: relative;
        background: rgba(255, 255, 255, 0.13);
        border: 1px solid rgba(255, 255, 255, 0.16);
        cursor: pointer;
        transition: background 0.15s ease, border-color 0.15s ease;
      }
      :root[data-theme="light"] .switch {
        background: rgba(12, 16, 26, 0.08);
        border-color: rgba(12, 16, 26, 0.1);
      }
      .switch::after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        top: 50%;
        left: 3px;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.88);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.22);
        transition: left 0.18s ease;
      }
      :root[data-theme="light"] .switch::after {
        background: rgba(12, 16, 26, 0.88);
        box-shadow: 0 12px 20px rgba(30, 50, 90, 0.2);
      }
      .switch[data-on="true"] {
        background: rgba(124, 92, 255, 0.5);
        border-color: rgba(124, 92, 255, 0.55);
      }
      .switch[data-on="true"]::after {
        left: 21px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      @media (max-width: 520px) {
        .stats-grid {
          grid-template-columns: 1fr;
        }
      }
      .stat {
        border: 1px solid var(--border);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.06);
        padding: 12px;
        min-height: 132px;
      }
      .stat h3 {
        margin: 0 0 6px;
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.2px;
        font-weight: 780;
        text-transform: uppercase;
      }
      .big {
        font-size: 28px;
        font-weight: 860;
        letter-spacing: -0.4px;
      }
      .mini {
        font-size: 12px;
        color: var(--muted);
        margin-top: 4px;
      }

      .chart {
        width: 100%;
        display: block;
      }
      .legend {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .legend .item {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        font-size: 12px;
        color: var(--muted);
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        border-radius: 999px;
        padding: 6px 10px;
      }
      .swatch {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--accent);
      }

      .log-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 10px;
      }
      .log-item {
        border: 1px solid var(--border);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.06);
        padding: 10px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .log-left {
        display: flex;
        gap: 10px;
        align-items: center;
        min-width: 0;
      }
      .icon-bubble {
        width: 34px;
        height: 34px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        flex: 0 0 auto;
      }
      .log-main {
        min-width: 0;
      }
      .log-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 780;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .log-meta {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
      }
      .chip {
        font-size: 11px;
        font-weight: 800;
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 4px 8px;
        color: var(--muted);
        background: rgba(255, 255, 255, 0.06);
        flex: 0 0 auto;
      }
      .chip.ok {
        border-color: rgba(46, 229, 157, 0.35);
        color: rgba(46, 229, 157, 0.95);
        background: rgba(46, 229, 157, 0.08);
      }
      .chip.skip {
        border-color: rgba(255, 176, 32, 0.35);
        color: rgba(255, 176, 32, 0.95);
        background: rgba(255, 176, 32, 0.08);
      }
      .chip.stop {
        border-color: rgba(255, 77, 109, 0.35);
        color: rgba(255, 77, 109, 0.95);
        background: rgba(255, 77, 109, 0.08);
      }
      .log-actions {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        flex: 0 0 auto;
      }

      .empty {
        padding: 12px;
        border: 1px dashed var(--border);
        border-radius: 16px;
        color: var(--muted);
        background: rgba(255, 255, 255, 0.04);
        font-size: 13px;
      }

      .drawer {
        position: fixed;
        inset: 0;
        z-index: 80;
        pointer-events: none;
      }
      .drawer[data-open="true"] {
        pointer-events: auto;
      }
      .drawer .overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        opacity: 0;
        transition: opacity 0.18s ease;
      }
      .drawer[data-open="true"] .overlay {
        opacity: 1;
      }
      .drawer .panel {
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        width: min(520px, 92vw);
        background: linear-gradient(180deg, var(--card2), var(--card));
        border-left: 1px solid var(--border);
        transform: translateX(105%);
        transition: transform 0.18s ease;
        box-shadow: 0 30px 90px rgba(0, 0, 0, 0.35);
        display: flex;
        flex-direction: column;
      }
      .drawer[data-open="true"] .panel {
        transform: translateX(0);
      }
      .panel-header {
        padding: max(14px, env(safe-area-inset-top)) 14px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        border-bottom: 1px solid var(--border);
      }
      .panel-header h2 {
        margin: 0;
        font-size: 14px;
        font-weight: 850;
        letter-spacing: 0.2px;
      }
      .panel-body {
        padding: 14px;
        overflow: auto;
      }
      .form {
        display: grid;
        gap: 12px;
      }
      .field {
        display: grid;
        gap: 8px;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.06);
      }
      .field label {
        font-size: 12px;
        color: var(--muted);
        font-weight: 780;
        letter-spacing: 0.2px;
      }
      .field .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      @media (max-width: 420px) {
        .field .row {
          grid-template-columns: 1fr;
        }
      }
      .input {
        display: flex;
        gap: 10px;
        align-items: center;
        border: 1px solid var(--border);
        border-radius: 14px;
        background: rgba(0, 0, 0, 0.18);
        padding: 10px 12px;
      }
      :root[data-theme="light"] .input {
        background: rgba(255, 255, 255, 0.65);
      }
      .input input,
      .input select {
        width: 100%;
        border: 0;
        outline: 0;
        background: transparent;
        color: var(--txt);
        font-size: 13px;
        font-weight: 700;
      }
      .input small {
        color: var(--muted);
        font-size: 12px;
        font-weight: 750;
      }
      .help {
        font-size: 12px;
        color: var(--muted);
        line-height: 1.35;
      }

      .kbd {
        font-variant-numeric: tabular-nums;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        border-radius: 10px;
        padding: 4px 8px;
        font-size: 11px;
        color: var(--muted);
      }

      .toast-wrap {
        position: fixed;
        left: 50%;
        bottom: max(18px, env(safe-area-inset-bottom));
        transform: translateX(-50%);
        z-index: 90;
        display: grid;
        gap: 10px;
        pointer-events: none;
        width: min(560px, calc(100vw - 24px));
      }
      .toast {
        pointer-events: none;
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.06));
        border-radius: 16px;
        padding: 12px 12px;
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.28);
        display: flex;
        gap: 10px;
        align-items: flex-start;
        opacity: 0;
        transform: translateY(10px);
        transition:
          opacity 0.18s ease,
          transform 0.18s ease;
      }
      .toast[data-show="true"] {
        opacity: 1;
        transform: translateY(0);
      }
      .toast b {
        font-weight: 860;
      }
      .toast p {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
        line-height: 1.35;
      }

      .sr {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
          scroll-behavior: auto !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="topbar-inner">
          <div class="brand" title="Pomodoro ‚Ä¢ Timer + sessions log">
            <div class="logo" aria-hidden="true"></div>
            <div>
              <h1>Pomodoro</h1>
              <div class="tag">Timer + sessions log</div>
            </div>
          </div>
          <div class="top-actions">
            <button class="btn small ghost" id="btnShortcuts" type="button" title="Shortcuts">
              <span aria-hidden="true">‚åò</span> Shortcuts
            </button>
            <button class="btn icon" id="btnTheme" type="button" title="Toggle theme">
              <span id="themeIcon" aria-hidden="true">‚óê</span>
              <span class="sr">Toggle theme</span>
            </button>
            <button class="btn primary" id="btnSettings" type="button" title="Settings">
              <span aria-hidden="true">‚öô</span> Settings
            </button>
          </div>
        </div>
      </header>

      <main class="wrap">
        <div class="grid">
          <section class="card timer-card" aria-label="Timer">
            <div class="phase-pills" role="tablist" aria-label="Session type">
              <button class="pill" id="pillFocus" type="button" role="tab" aria-selected="true">
                <span class="dot focus" aria-hidden="true"></span> Focus
              </button>
              <button class="pill" id="pillShort" type="button" role="tab" aria-selected="false">
                <span class="dot short" aria-hidden="true"></span> Short break
              </button>
              <button class="pill" id="pillLong" type="button" role="tab" aria-selected="false">
                <span class="dot long" aria-hidden="true"></span> Long break
              </button>
            </div>

            <div class="timer-core">
              <div class="ring-wrap">
                <div class="ring" aria-label="Progress">
                  <svg viewBox="0 0 120 120" role="img" aria-label="Timer progress ring">
                    <circle
                      cx="60"
                      cy="60"
                      r="48"
                      fill="none"
                      stroke="var(--ringTrack)"
                      stroke-width="10"
                      stroke-linecap="round"
                    />
                    <circle
                      id="ringProgress"
                      cx="60"
                      cy="60"
                      r="48"
                      fill="none"
                      stroke="var(--accent)"
                      stroke-width="10"
                      stroke-linecap="round"
                      stroke-dasharray="301.59"
                      stroke-dashoffset="0"
                      style="filter: drop-shadow(0 12px 22px rgba(0, 0, 0, 0.25))"
                    />
                  </svg>
                  <div class="center">
                    <div>
                      <p class="time" id="timeDisplay" aria-live="polite">25:00</p>
                      <div class="subtitle">
                        <span class="badge" id="phaseBadge"><strong>Focus</strong></span>
                        <span class="badge" id="cycleBadge">Cycle <strong>1</strong> of <strong>4</strong></span>
                        <span class="badge" id="goalBadge">Today <strong>0</strong>/<strong>120</strong> min</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="controls" aria-label="Controls">
                <div class="row actions">
                  <button class="btn primary" id="btnStartPause" type="button">
                    <span id="startPauseIcon" aria-hidden="true">‚ñ∂</span>
                    <span id="startPauseLabel">Start</span>
                    <span class="kbd" aria-hidden="true">Space</span>
                  </button>
                  <button class="btn" id="btnSkip" type="button" title="Skip to next">
                    <span aria-hidden="true">‚è≠</span> Skip <span class="kbd" aria-hidden="true">N</span>
                  </button>
                  <button class="btn danger" id="btnReset" type="button" title="Reset current">
                    <span aria-hidden="true">‚Ü∫</span> Reset <span class="kbd" aria-hidden="true">R</span>
                  </button>
                </div>

                <div class="row toggles">
                  <div class="toggle" title="Automatically start the next session when one ends">
                    <span>Auto‚Äëstart next</span>
                    <div class="switch" id="swAuto" role="switch" aria-checked="false" tabindex="0"></div>
                  </div>
                  <div class="toggle" title="Play a short beep when a session ends">
                    <span>Sound</span>
                    <div class="switch" id="swSound" role="switch" aria-checked="true" tabindex="0"></div>
                  </div>
                </div>

                <div class="row" style="gap: 8px; justify-content: space-between">
                  <span class="hint" id="statusLine"
                    >Tip: hit <span class="kbd">Space</span> to start/pause.</span
                  >
                  <button class="btn small ghost" id="btnAddMinute" type="button" title="Add 60 seconds">
                    +1 min
                  </button>
                </div>
              </div>
            </div>
          </section>

          <section class="card" aria-label="Stats and charts">
            <div class="card-header">
              <div>
                <h2>Momentum</h2>
                <div class="hint">Daily energy, at a glance</div>
              </div>
              <div class="top-actions" style="gap: 8px">
                <button class="btn small" id="btnExport" type="button" title="Export sessions as CSV">
                  <span aria-hidden="true">‚§ì</span> Export CSV
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="stats-grid">
                <div class="stat">
                  <h3>Today</h3>
                  <div class="big" id="todayBig">0 min</div>
                  <div class="mini" id="todayMini">0 focus sessions ‚Ä¢ 0 breaks</div>
                  <svg
                    class="chart"
                    id="donut"
                    viewBox="0 0 120 120"
                    aria-label="Today goal donut chart"
                    role="img"
                    style="margin-top: 10px"
                  >
                    <circle
                      cx="60"
                      cy="60"
                      r="44"
                      fill="none"
                      stroke="var(--ringTrack)"
                      stroke-width="12"
                      stroke-linecap="round"
                    />
                    <circle
                      id="donutProg"
                      cx="60"
                      cy="60"
                      r="44"
                      fill="none"
                      stroke="var(--good)"
                      stroke-width="12"
                      stroke-linecap="round"
                      stroke-dasharray="276.46"
                      stroke-dashoffset="276.46"
                      transform="rotate(-90 60 60)"
                    />
                    <text
                      x="60"
                      y="57"
                      text-anchor="middle"
                      font-size="18"
                      font-weight="900"
                      fill="currentColor"
                      id="donutPct"
                    >
                      0%
                    </text>
                    <text
                      x="60"
                      y="76"
                      text-anchor="middle"
                      font-size="11"
                      font-weight="700"
                      fill="currentColor"
                      opacity="0.65"
                      id="donutLabel"
                    >
                      of goal
                    </text>
                  </svg>
                </div>

                <div class="stat">
                  <h3>Last 7 days</h3>
                  <svg class="chart" id="bars" viewBox="0 0 360 150" role="img" aria-label="7 day focus bar chart">
                    <rect x="0" y="0" width="360" height="150" fill="transparent"></rect>
                    <g id="barsG"></g>
                  </svg>
                  <div class="legend">
                    <div class="item"><span class="swatch" style="background: var(--focus)"></span> Focus</div>
                    <div class="item"><span class="swatch" style="background: var(--short)"></span> Breaks</div>
                  </div>
                </div>
              </div>
              <div class="hint" style="margin-top: 12px">
                Keyboard: <span class="kbd">1</span> Focus <span class="kbd">2</span> Short
                <span class="kbd">3</span> Long ‚Ä¢ <span class="kbd">N</span> Skip ‚Ä¢
                <span class="kbd">R</span> Reset
              </div>
            </div>
          </section>

          <section class="card" aria-label="Sessions log" style="grid-column: 1 / -1">
            <div class="card-header">
              <div>
                <h2>Sessions</h2>
                <div class="hint">A clean log you can trust</div>
              </div>
              <div class="top-actions" style="gap: 8px; flex-wrap: wrap; justify-content: flex-end">
                <button class="btn small" id="btnFilterAll" type="button" title="Show all sessions">
                  All
                </button>
                <button class="btn small" id="btnFilterToday" type="button" title="Show today only">
                  Today
                </button>
                <button class="btn small danger" id="btnClear" type="button" title="Clear history">
                  Clear
                </button>
              </div>
            </div>
            <div class="card-body">
              <div id="logEmpty" class="empty" style="display: none">
                No sessions yet. Start a focus sprint and stack wins.
              </div>
              <ul class="log-list" id="logList" aria-label="Session list"></ul>
            </div>
          </section>
        </div>
      </main>

      <div class="drawer" id="drawer" data-open="false" aria-hidden="true">
        <div class="overlay" id="drawerOverlay"></div>
        <div class="panel" role="dialog" aria-modal="true" aria-label="Settings panel">
          <div class="panel-header">
            <h2>Settings</h2>
            <button class="btn icon" id="btnCloseSettings" type="button" title="Close settings">
              <span aria-hidden="true">‚úï</span>
              <span class="sr">Close</span>
            </button>
          </div>
          <div class="panel-body">
            <div class="form">
              <div class="field">
                <label>Durations</label>
                <div class="row">
                  <div class="input">
                    <input id="setFocus" type="number" min="1" max="180" step="1" inputmode="numeric" />
                    <small>min focus</small>
                  </div>
                  <div class="input">
                    <input id="setShort" type="number" min="1" max="60" step="1" inputmode="numeric" />
                    <small>min short</small>
                  </div>
                  <div class="input">
                    <input id="setLong" type="number" min="1" max="120" step="1" inputmode="numeric" />
                    <small>min long</small>
                  </div>
                  <div class="input">
                    <input id="setEvery" type="number" min="2" max="12" step="1" inputmode="numeric" />
                    <small>long every</small>
                  </div>
                </div>
                <div class="help">
                  After every <b id="everyPreview">4</b> focus sessions, Pomodoro switches to a long break.
                </div>
              </div>

              <div class="field">
                <label>Daily goal</label>
                <div class="row">
                  <div class="input">
                    <input id="setGoal" type="number" min="10" max="600" step="5" inputmode="numeric" />
                    <small>min focus</small>
                  </div>
                  <div class="input">
                    <select id="setTheme">
                      <option value="system">System</option>
                      <option value="dark">Dark</option>
                      <option value="light">Light</option>
                    </select>
                    <small>theme</small>
                  </div>
                </div>
                <div class="help">Goal updates charts and the badge under the timer.</div>
              </div>

              <div class="field">
                <label>Sound</label>
                <div class="row">
                  <div class="input">
                    <input id="setVolume" type="number" min="0" max="100" step="5" inputmode="numeric" />
                    <small>volume</small>
                  </div>
                  <div class="input">
                    <select id="setBeepStyle">
                      <option value="triple">Triple beep</option>
                      <option value="single">Single beep</option>
                      <option value="chime">Soft chime</option>
                    </select>
                    <small>alert</small>
                  </div>
                </div>
                <div class="help">
                  Browsers require a user gesture to allow audio. Starting the timer once ‚Äúunlocks‚Äù sound.
                </div>
              </div>

              <div class="field">
                <label>Behavior</label>
                <div class="row">
                  <div class="toggle">
                    <span>Auto‚Äëstart next</span>
                    <div class="switch" id="swAuto2" role="switch" aria-checked="false" tabindex="0"></div>
                  </div>
                  <div class="toggle">
                    <span>Sound</span>
                    <div class="switch" id="swSound2" role="switch" aria-checked="true" tabindex="0"></div>
                  </div>
                </div>
                <div class="help">These mirror the quick toggles on the timer.</div>
              </div>

              <div class="field">
                <label>Data</label>
                <div class="row">
                  <button class="btn" id="btnExportJson" type="button">
                    <span aria-hidden="true">‚§ì</span> Export JSON
                  </button>
                  <button class="btn danger" id="btnResetAll" type="button">
                    <span aria-hidden="true">üß®</span> Reset all
                  </button>
                </div>
                <div class="help">
                  Export makes a local file. Reset clears settings + history on this device.
                </div>
              </div>

              <div class="field">
                <label>Shortcuts</label>
                <div class="help">
                  <span class="kbd">Space</span> start/pause ‚Ä¢ <span class="kbd">1</span>/<span class="kbd"
                    >2</span
                  >/<span class="kbd">3</span> session type ‚Ä¢ <span class="kbd">N</span> skip ‚Ä¢
                  <span class="kbd">R</span> reset ‚Ä¢ <span class="kbd">Esc</span> close settings
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="toast-wrap" id="toasts" aria-live="polite" aria-relevant="additions"></div>
    </div>

    <script>
      (() => {
        "use strict";

        const STORAGE_KEY = "pomodoro.v1";
        const MAX_LOG = 600;

        /** @typedef {"focus"|"short"|"long"} Phase */
        const PhaseLabel = {
          focus: "Focus",
          short: "Short break",
          long: "Long break",
        };
        const PhaseColorVar = {
          focus: "--focus",
          short: "--short",
          long: "--long",
        };

        const els = {
          // header
          btnTheme: document.getElementById("btnTheme"),
          themeIcon: document.getElementById("themeIcon"),
          btnSettings: document.getElementById("btnSettings"),
          btnShortcuts: document.getElementById("btnShortcuts"),

          // pills
          pillFocus: document.getElementById("pillFocus"),
          pillShort: document.getElementById("pillShort"),
          pillLong: document.getElementById("pillLong"),

          // timer
          ringProgress: document.getElementById("ringProgress"),
          timeDisplay: document.getElementById("timeDisplay"),
          phaseBadge: document.getElementById("phaseBadge"),
          cycleBadge: document.getElementById("cycleBadge"),
          goalBadge: document.getElementById("goalBadge"),
          btnStartPause: document.getElementById("btnStartPause"),
          startPauseIcon: document.getElementById("startPauseIcon"),
          startPauseLabel: document.getElementById("startPauseLabel"),
          btnSkip: document.getElementById("btnSkip"),
          btnReset: document.getElementById("btnReset"),
          btnAddMinute: document.getElementById("btnAddMinute"),
          swAuto: document.getElementById("swAuto"),
          swSound: document.getElementById("swSound"),
          statusLine: document.getElementById("statusLine"),

          // stats
          todayBig: document.getElementById("todayBig"),
          todayMini: document.getElementById("todayMini"),
          donutProg: document.getElementById("donutProg"),
          donutPct: document.getElementById("donutPct"),
          barsG: document.getElementById("barsG"),
          btnExport: document.getElementById("btnExport"),

          // log
          logEmpty: document.getElementById("logEmpty"),
          logList: document.getElementById("logList"),
          btnFilterAll: document.getElementById("btnFilterAll"),
          btnFilterToday: document.getElementById("btnFilterToday"),
          btnClear: document.getElementById("btnClear"),

          // drawer
          drawer: document.getElementById("drawer"),
          drawerOverlay: document.getElementById("drawerOverlay"),
          btnCloseSettings: document.getElementById("btnCloseSettings"),
          setFocus: document.getElementById("setFocus"),
          setShort: document.getElementById("setShort"),
          setLong: document.getElementById("setLong"),
          setEvery: document.getElementById("setEvery"),
          setGoal: document.getElementById("setGoal"),
          setTheme: document.getElementById("setTheme"),
          setVolume: document.getElementById("setVolume"),
          setBeepStyle: document.getElementById("setBeepStyle"),
          swAuto2: document.getElementById("swAuto2"),
          swSound2: document.getElementById("swSound2"),
          everyPreview: document.getElementById("everyPreview"),
          btnExportJson: document.getElementById("btnExportJson"),
          btnResetAll: document.getElementById("btnResetAll"),

          // toasts
          toasts: document.getElementById("toasts"),
        };

        const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
        const pad2 = (n) => String(n).padStart(2, "0");
        const nowMs = () => Date.now();

        function dayKey(d = new Date()) {
          const yyyy = d.getFullYear();
          const mm = pad2(d.getMonth() + 1);
          const dd = pad2(d.getDate());
          return `${yyyy}-${mm}-${dd}`;
        }

        function fmtTime(seconds) {
          const s = Math.max(0, Math.ceil(seconds));
          const m = Math.floor(s / 60);
          const r = s % 60;
          return `${pad2(m)}:${pad2(r)}`;
        }

        function fmtShortDateTime(ms) {
          const d = new Date(ms);
          const time = d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
          const date = d.toLocaleDateString([], { month: "short", day: "numeric" });
          return `${date} ‚Ä¢ ${time}`;
        }

        function safeJsonParse(s) {
          try {
            return JSON.parse(s);
          } catch {
            return null;
          }
        }

        function downloadText(filename, text, mime = "text/plain") {
          const blob = new Blob([text], { type: mime });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
        }

        function toast(title, body, tone = "neutral") {
          const el = document.createElement("div");
          el.className = "toast";
          el.innerHTML = `
            <div style="width: 12px; height: 12px; border-radius: 999px; margin-top: 4px; background: ${
              tone === "good"
                ? "var(--good)"
                : tone === "warn"
                  ? "var(--warn)"
                  : tone === "bad"
                    ? "var(--bad)"
                    : "var(--accent2)"
            }; box-shadow: 0 0 0 8px rgba(255,255,255,0.03)"></div>
            <div style="min-width: 0">
              <div style="font-size: 13px; font-weight: 860; letter-spacing: 0.1px;">${escapeHtml(
                title,
              )}</div>
              <p>${escapeHtml(body)}</p>
            </div>
          `;
          els.toasts.prepend(el);
          requestAnimationFrame(() => el.setAttribute("data-show", "true"));
          setTimeout(() => {
            el.setAttribute("data-show", "false");
            setTimeout(() => el.remove(), 220);
          }, 3200);
        }

        function escapeHtml(s) {
          return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function setSwitch(sw, on) {
          sw.dataset.on = on ? "true" : "false";
          sw.setAttribute("aria-checked", on ? "true" : "false");
        }

        function toggleSwitch(sw) {
          const on = sw.dataset.on === "true";
          setSwitch(sw, !on);
          return !on;
        }

        const defaultState = () => ({
          version: 1,
          settings: {
            focusMin: 25,
            shortMin: 5,
            longMin: 15,
            longEvery: 4,
            goalMin: 120,
            autoStartNext: false,
            soundOn: true,
            volume: 70,
            beepStyle: "triple", // triple | single | chime
            theme: "system", // system | dark | light
          },
          history: [],
          timer: {
            phase: /** @type {Phase} */ ("focus"),
            running: false,
            remainingMs: 25 * 60 * 1000,
            endAtMs: null,
            startedAtMs: null,
            plannedMs: 25 * 60 * 1000,
            focusStreakSinceLong: 0,
          },
          ui: {
            logFilter: "all", // all | today
          },
        });

        let state = defaultState();

        function load() {
          const raw = localStorage.getItem(STORAGE_KEY);
          const parsed = raw ? safeJsonParse(raw) : null;
          if (!parsed || typeof parsed !== "object") return;

          const base = defaultState();
          state = {
            ...base,
            ...parsed,
            settings: { ...base.settings, ...(parsed.settings || {}) },
            timer: { ...base.timer, ...(parsed.timer || {}) },
            ui: { ...base.ui, ...(parsed.ui || {}) },
            history: Array.isArray(parsed.history) ? parsed.history.slice(0, MAX_LOG) : [],
          };

          // ensure invariants
          state.settings.focusMin = clamp(Number(state.settings.focusMin) || 25, 1, 180);
          state.settings.shortMin = clamp(Number(state.settings.shortMin) || 5, 1, 60);
          state.settings.longMin = clamp(Number(state.settings.longMin) || 15, 1, 120);
          state.settings.longEvery = clamp(Number(state.settings.longEvery) || 4, 2, 12);
          state.settings.goalMin = clamp(Number(state.settings.goalMin) || 120, 10, 600);
          state.settings.volume = clamp(Number(state.settings.volume) || 70, 0, 100);
          state.settings.beepStyle =
            state.settings.beepStyle === "single" || state.settings.beepStyle === "chime"
              ? state.settings.beepStyle
              : "triple";
          state.settings.theme =
            state.settings.theme === "dark" || state.settings.theme === "light" ? state.settings.theme : "system";

          if (!["focus", "short", "long"].includes(state.timer.phase)) state.timer.phase = "focus";
          if (typeof state.timer.remainingMs !== "number" || !Number.isFinite(state.timer.remainingMs))
            state.timer.remainingMs = state.settings.focusMin * 60 * 1000;

          {
            const n = state.settings.longEvery;
            let c = Number(state.timer.focusStreakSinceLong) || 0;
            if (!Number.isFinite(c)) c = 0;
            if (state.timer.phase === "long") c = 0;
            c = ((c % n) + n) % n; // normalize to 0..n-1
            state.timer.focusStreakSinceLong = c;
          }

          if (state.timer.running && typeof state.timer.endAtMs === "number") {
            const remain = state.timer.endAtMs - nowMs();
            if (remain > 0) {
              state.timer.remainingMs = remain;
            } else {
              // session ended while away ‚Äî don't auto-advance silently.
              state.timer.running = false;
              state.timer.endAtMs = null;
              state.timer.remainingMs = 0;
              toast("Session finished", "Looks like your timer ended while you were away.", "warn");
            }
          } else {
            state.timer.running = false;
            state.timer.endAtMs = null;
          }
        }

        function save() {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          } catch {
            // If storage is full/blocked, keep running without persistence.
          }
        }

        function desiredMsForPhase(phase) {
          if (phase === "focus") return state.settings.focusMin * 60 * 1000;
          if (phase === "short") return state.settings.shortMin * 60 * 1000;
          return state.settings.longMin * 60 * 1000;
        }

        function applyTheme() {
          const pref = state.settings.theme;
          if (pref === "dark") {
            document.documentElement.dataset.theme = "dark";
            els.themeIcon.textContent = "‚òæ";
            return;
          }
          if (pref === "light") {
            document.documentElement.dataset.theme = "light";
            els.themeIcon.textContent = "‚òÄ";
            return;
          }
          const mq = window.matchMedia?.("(prefers-color-scheme: dark)");
          const isDark = mq ? mq.matches : true;
          document.documentElement.dataset.theme = isDark ? "dark" : "light";
          els.themeIcon.textContent = "‚óê";
        }

        let tickHandle = null;
        let audio = {
          ctx: null,
          unlocked: false,
        };

        function ensureAudio() {
          if (audio.ctx) return;
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          audio.ctx = new Ctx();
        }

        async function unlockAudio() {
          ensureAudio();
          if (!audio.ctx) return false;
          if (audio.ctx.state === "suspended") {
            try {
              await audio.ctx.resume();
            } catch {
              // ignore
            }
          }
          audio.unlocked = audio.ctx.state === "running";
          return audio.unlocked;
        }

        function playBeep(style = state.settings.beepStyle) {
          if (!state.settings.soundOn) return;
          ensureAudio();
          if (!audio.ctx || !audio.unlocked) return;
          const ctx = audio.ctx;
          const master = ctx.createGain();
          master.gain.value = (state.settings.volume / 100) * 0.18; // keep it gentle
          master.connect(ctx.destination);

          const now = ctx.currentTime;
          const scheduleTone = (t, freq, dur, type = "sine") => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.0001, t);
            gain.gain.exponentialRampToValueAtTime(1.0, t + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.0001, t + dur);
            osc.connect(gain);
            gain.connect(master);
            osc.start(t);
            osc.stop(t + dur + 0.02);
          };

          if (style === "single") {
            scheduleTone(now, 880, 0.14, "sine");
            return;
          }
          if (style === "chime") {
            scheduleTone(now, 740, 0.18, "sine");
            scheduleTone(now + 0.03, 988, 0.22, "sine");
            return;
          }
          // triple
          scheduleTone(now, 880, 0.12, "sine");
          scheduleTone(now + 0.18, 880, 0.12, "sine");
          scheduleTone(now + 0.36, 1046.5, 0.14, "sine");
        }

        function stopTick() {
          if (tickHandle) {
            clearInterval(tickHandle);
            tickHandle = null;
          }
        }

        function startTick() {
          stopTick();
          tickHandle = setInterval(onTick, 200);
          onTick();
        }

        function setPhase(phase, { reset = true } = {}) {
          const running = state.timer.running;
          if (running) {
            toast("Paused", "Switching session type stops the timer.", "warn");
            pause();
          }
          state.timer.phase = phase;
          state.timer.plannedMs = desiredMsForPhase(phase);
          if (reset) state.timer.remainingMs = state.timer.plannedMs;
          state.timer.startedAtMs = null;
          state.timer.endAtMs = null;
          renderAll();
          save();
        }

        function start() {
          if (state.timer.running) return;
          if (state.timer.remainingMs <= 0) state.timer.remainingMs = desiredMsForPhase(state.timer.phase);
          state.timer.running = true;
          state.timer.startedAtMs = nowMs();
          state.timer.plannedMs = desiredMsForPhase(state.timer.phase);
          state.timer.endAtMs = nowMs() + state.timer.remainingMs;
          startTick();
          renderTimerControls();
          save();
        }

        function pause() {
          if (!state.timer.running) return;
          state.timer.running = false;
          if (typeof state.timer.endAtMs === "number") {
            state.timer.remainingMs = Math.max(0, state.timer.endAtMs - nowMs());
          }
          state.timer.endAtMs = null;
          stopTick();
          renderTimerControls();
          renderTimer();
          save();
        }

        function resetCurrent() {
          pause();
          state.timer.plannedMs = desiredMsForPhase(state.timer.phase);
          state.timer.remainingMs = state.timer.plannedMs;
          state.timer.startedAtMs = null;
          state.timer.endAtMs = null;
          toast("Reset", `${PhaseLabel[state.timer.phase]} reset to default duration.`, "neutral");
          renderAll();
          save();
        }

        function addMinute() {
          state.timer.remainingMs += 60 * 1000;
          state.timer.remainingMs = clamp(state.timer.remainingMs, 0, 6 * 60 * 60 * 1000);
          if (state.timer.running && typeof state.timer.endAtMs === "number") state.timer.endAtMs += 60 * 1000;
          toast("Added time", "+1 minute", "good");
          renderTimer();
          save();
        }

        function nextPhase(afterPhase, skipped) {
          if (afterPhase === "focus") {
            if (!skipped) {
              const nextCount = (state.timer.focusStreakSinceLong || 0) + 1;
              if (nextCount >= state.settings.longEvery) {
                // Reset the block counter as soon as we enter the long break,
                // so skipping the long break still starts a fresh cycle.
                state.timer.focusStreakSinceLong = 0;
                return "long";
              }
              state.timer.focusStreakSinceLong = nextCount;
            }
            return "short";
          }
          return "focus";
        }

        function logSession({ status, actualMsOverride = null }) {
          const endedAtMs = nowMs();
          const startedAtMs = state.timer.startedAtMs ?? endedAtMs;
          const plannedMs = desiredMsForPhase(state.timer.phase);
          const computedActualMs = state.timer.running
            ? Math.max(0, endedAtMs - startedAtMs)
            : Math.max(0, plannedMs - (state.timer.remainingMs || 0));
          const actualMs =
            typeof actualMsOverride === "number" && Number.isFinite(actualMsOverride)
              ? clamp(actualMsOverride, 0, plannedMs)
              : computedActualMs;

          const item = {
            id: crypto?.randomUUID ? crypto.randomUUID() : `${endedAtMs}-${Math.random().toString(16).slice(2)}`,
            phase: state.timer.phase,
            status,
            startedAtMs,
            endedAtMs,
            plannedMs,
            actualMs: status === "completed" ? plannedMs : actualMs,
            day: dayKey(new Date(endedAtMs)),
          };
          state.history.unshift(item);
          state.history = state.history.slice(0, MAX_LOG);
        }

        function finish({ skipped = false } = {}) {
          const phase = state.timer.phase;

          const plannedMs = desiredMsForPhase(phase);
          const remainingBefore =
            state.timer.running && typeof state.timer.endAtMs === "number"
              ? Math.max(0, state.timer.endAtMs - nowMs())
              : Math.max(0, state.timer.remainingMs || 0);

          pause();

          const looksUnstarted = state.timer.startedAtMs == null && Math.abs(remainingBefore - plannedMs) < 1200;
          const shouldLog = !skipped || !looksUnstarted;
          if (shouldLog) {
            const status = skipped ? "skipped" : "completed";
            const actualMs = skipped ? clamp(plannedMs - remainingBefore, 0, plannedMs) : plannedMs;
            logSession({ status, actualMsOverride: actualMs });
          }

          const nxt = nextPhase(phase, skipped);
          state.timer.phase = nxt;
          state.timer.plannedMs = desiredMsForPhase(nxt);
          state.timer.remainingMs = state.timer.plannedMs;
          state.timer.startedAtMs = null;
          state.timer.endAtMs = null;

          const title = skipped ? "Skipped" : "Done";
          const body = skipped
            ? `Moved on to ${PhaseLabel[nxt]}.`
            : `${PhaseLabel[phase]} complete ‚Äî now ${PhaseLabel[nxt]}.`;
          toast(title, body, skipped ? "warn" : "good");

          if (!skipped) {
            playBeep();
            try {
              navigator.vibrate?.([60, 50, 60]);
            } catch {
              // ignore
            }
          }

          renderAll();
          save();

          if (state.settings.autoStartNext) {
            setTimeout(() => {
              if (!state.timer.running) start();
            }, 700);
          }
        }

        function onTick() {
          if (!state.timer.running || typeof state.timer.endAtMs !== "number") return;
          const remain = state.timer.endAtMs - nowMs();
          state.timer.remainingMs = Math.max(0, remain);
          renderTimer();
          if (remain <= 0) finish({ skipped: false });
        }

        function cycleText() {
          const n = state.settings.longEvery;
          const done = clamp(state.timer.focusStreakSinceLong || 0, 0, n);
          const phase = state.timer.phase;
          const cur = phase === "focus" ? clamp(done + 1, 1, n) : phase === "short" ? done : n;
          return { cur, total: n };
        }

        function setAccentForPhase(phase) {
          const cssVar = PhaseColorVar[phase] || "--accent";
          const val = getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
          els.ringProgress.setAttribute("stroke", val || "var(--accent)");
        }

        function renderTimer() {
          const total = desiredMsForPhase(state.timer.phase);
          const remaining = clamp(state.timer.remainingMs || 0, 0, total);
          const ratio = total > 0 ? remaining / total : 0;
          const circumference = 2 * Math.PI * 48;
          const offset = circumference * (1 - ratio);
          els.ringProgress.style.strokeDasharray = String(circumference.toFixed(2));
          els.ringProgress.style.strokeDashoffset = String(offset.toFixed(2));

          els.timeDisplay.textContent = fmtTime(remaining / 1000);
          const phase = state.timer.phase;
          els.phaseBadge.innerHTML = `<strong>${PhaseLabel[phase]}</strong>`;
          setAccentForPhase(phase);

          const { cur, total: tot } = cycleText();
          els.cycleBadge.innerHTML = `Cycle <strong>${cur}</strong> of <strong>${tot}</strong>`;

          const today = computeToday();
          els.goalBadge.innerHTML = `Today <strong>${today.focusMin}</strong>/<strong>${state.settings.goalMin}</strong> min`;

          document.title = `${fmtTime(remaining / 1000)} ‚Ä¢ ${PhaseLabel[phase]} ‚Äî Pomodoro`;
        }

        function renderTimerControls() {
          const running = state.timer.running;
          els.startPauseIcon.textContent = running ? "‚è∏" : "‚ñ∂";
          els.startPauseLabel.textContent = running ? "Pause" : "Start";
          els.btnSkip.disabled = false;
          els.btnReset.disabled = false;
          els.btnAddMinute.disabled = false;
          els.statusLine.textContent = running
            ? "You‚Äôve got this. One thing at a time."
            : "Tip: hit Space to start/pause.";
        }

        function computeToday() {
          const todayKey = dayKey();
          let focusMs = 0;
          let focusCount = 0;
          let breakCount = 0;
          for (const s of state.history) {
            if (s.day !== todayKey) continue;
            if (s.status !== "completed") continue;
            if (s.phase === "focus") {
              focusMs += s.actualMs || 0;
              focusCount += 1;
            } else {
              breakCount += 1;
            }
          }
          const focusMin = Math.round(focusMs / 60000);
          return { focusMin, focusCount, breakCount };
        }

        function computeWeek() {
          const days = [];
          const now = new Date();
          for (let i = 6; i >= 0; i--) {
            const d = new Date(now);
            d.setDate(now.getDate() - i);
            days.push(dayKey(d));
          }
          const map = new Map(days.map((k) => [k, { focusMin: 0, breakMin: 0 }]));
          for (const s of state.history) {
            if (!map.has(s.day)) continue;
            if (s.status !== "completed") continue;
            const entry = map.get(s.day);
            const min = (s.actualMs || 0) / 60000;
            if (s.phase === "focus") entry.focusMin += min;
            else entry.breakMin += min;
          }
          return days.map((k) => ({ day: k, ...map.get(k) }));
        }

        function renderStats() {
          const today = computeToday();
          els.todayBig.textContent = `${today.focusMin} min`;
          els.todayMini.textContent = `${today.focusCount} focus sessions ‚Ä¢ ${today.breakCount} breaks`;

          const goal = Math.max(1, state.settings.goalMin);
          const pct = clamp(today.focusMin / goal, 0, 1);
          const circumference = 2 * Math.PI * 44;
          els.donutProg.style.strokeDasharray = String(circumference.toFixed(2));
          els.donutProg.style.strokeDashoffset = String((circumference * (1 - pct)).toFixed(2));
          els.donutPct.textContent = `${Math.round(pct * 100)}%`;

          renderBars();
        }

        function renderBars() {
          const week = computeWeek();
          const maxVal = Math.max(
            30,
            ...week.map((d) => Math.max(d.focusMin, d.breakMin)),
            state.settings.goalMin / 4,
          );
          const W = 360;
          const H = 150;
          const padL = 10;
          const padR = 10;
          const padT = 10;
          const padB = 24;
          const innerW = W - padL - padR;
          const innerH = H - padT - padB;
          const barW = innerW / week.length;

          const focusColor = getComputedStyle(document.documentElement).getPropertyValue("--focus").trim();
          const breakColor = getComputedStyle(document.documentElement).getPropertyValue("--short").trim();

          const mkRect = (x, y, w, h, fill, r = 8) =>
            `<rect x="${x.toFixed(2)}" y="${y.toFixed(2)}" width="${w.toFixed(2)}" height="${h.toFixed(
              2,
            )}" rx="${r}" ry="${r}" fill="${fill}"></rect>`;
          const mkText = (x, y, txt, opacity = 0.65) =>
            `<text x="${x.toFixed(2)}" y="${y.toFixed(2)}" text-anchor="middle" font-size="10" font-weight="800" fill="currentColor" opacity="${opacity}">${escapeHtml(
              txt,
            )}</text>`;

          let svg = "";
          week.forEach((d, idx) => {
            const x0 = padL + idx * barW + 6;
            const w = Math.max(8, barW - 12);
            const focusH = (clamp(d.focusMin, 0, maxVal) / maxVal) * innerH;
            const breakH = (clamp(d.breakMin, 0, maxVal) / maxVal) * innerH;
            const yFocus = padT + (innerH - focusH);
            const yBreak = padT + (innerH - breakH);

            // break bar behind (so both are visible)
            svg += mkRect(x0, yBreak, w, breakH, withAlpha(breakColor, 0.45), 10);
            svg += mkRect(x0, yFocus, w, focusH, withAlpha(focusColor, 0.95), 10);

            const dt = new Date(d.day + "T00:00:00");
            const label = dt.toLocaleDateString([], { weekday: "short" });
            svg += mkText(x0 + w / 2, H - 8, label, 0.6);
          });

          // baseline
          svg += `<line x1="${padL}" y1="${padT + innerH}" x2="${W - padR}" y2="${padT + innerH}" stroke="currentColor" opacity="0.12" />`;
          els.barsG.innerHTML = svg;
        }

        function withAlpha(color, a) {
          // accepts rgb/rgba or hex. fall back to CSS var itself.
          const c = color.trim();
          if (!c) return `rgba(255,255,255,${a})`;
          if (c.startsWith("rgb(")) return c.replace("rgb(", "rgba(").replace(")", `, ${a})`);
          if (c.startsWith("rgba(")) {
            return c.replace(/rgba\(([^)]+)\)/, (m, inner) => {
              const parts = inner.split(",").map((p) => p.trim());
              return `rgba(${parts[0]}, ${parts[1]}, ${parts[2]}, ${a})`;
            });
          }
          if (c.startsWith("#")) {
            const hex = c.slice(1);
            const n = hex.length === 3 ? hex.split("").map((ch) => ch + ch).join("") : hex;
            const r = parseInt(n.slice(0, 2), 16);
            const g = parseInt(n.slice(2, 4), 16);
            const b = parseInt(n.slice(4, 6), 16);
            return `rgba(${r}, ${g}, ${b}, ${a})`;
          }
          return c;
        }

        function renderLog() {
          const filter = state.ui.logFilter;
          const today = dayKey();
          const items =
            filter === "today" ? state.history.filter((s) => s.day === today) : state.history.slice();

          els.btnFilterAll.classList.toggle("primary", filter === "all");
          els.btnFilterToday.classList.toggle("primary", filter === "today");

          if (items.length === 0) {
            els.logEmpty.style.display = "block";
            els.logList.innerHTML = "";
            return;
          }
          els.logEmpty.style.display = "none";

          const iconFor = (phase) => (phase === "focus" ? "‚ö°" : phase === "short" ? "‚òï" : "üåø");
          const chipFor = (status) =>
            status === "completed"
              ? `<span class="chip ok">DONE</span>`
              : status === "skipped"
                ? `<span class="chip skip">SKIP</span>`
                : `<span class="chip stop">STOP</span>`;

          els.logList.innerHTML = items
            .map((s) => {
              const mins = Math.round((s.actualMs || s.plannedMs || 0) / 60000);
              const when = fmtShortDateTime(s.endedAtMs || s.startedAtMs);
              return `
              <li class="log-item">
                <div class="log-left">
                  <div class="icon-bubble" aria-hidden="true">${iconFor(s.phase)}</div>
                  <div class="log-main">
                    <div class="log-title">${escapeHtml(PhaseLabel[s.phase] || s.phase)} ¬∑ ${mins} min</div>
                    <div class="log-meta">${escapeHtml(when)}</div>
                  </div>
                </div>
                <div class="log-actions">
                  ${chipFor(s.status)}
                  <button class="btn small ghost" data-del="${escapeHtml(s.id)}" type="button" title="Remove">
                    ‚úï
                  </button>
                </div>
              </li>
            `;
            })
            .join("");
        }

        function renderPills() {
          const phase = state.timer.phase;
          const set = (el, active) => {
            el.dataset.active = active ? "true" : "false";
            el.setAttribute("aria-selected", active ? "true" : "false");
          };
          set(els.pillFocus, phase === "focus");
          set(els.pillShort, phase === "short");
          set(els.pillLong, phase === "long");
        }

        function renderSettings() {
          els.setFocus.value = String(state.settings.focusMin);
          els.setShort.value = String(state.settings.shortMin);
          els.setLong.value = String(state.settings.longMin);
          els.setEvery.value = String(state.settings.longEvery);
          els.setGoal.value = String(state.settings.goalMin);
          els.setTheme.value = state.settings.theme;
          els.setVolume.value = String(state.settings.volume);
          els.setBeepStyle.value = state.settings.beepStyle;
          els.everyPreview.textContent = String(state.settings.longEvery);

          setSwitch(els.swAuto, state.settings.autoStartNext);
          setSwitch(els.swAuto2, state.settings.autoStartNext);
          setSwitch(els.swSound, state.settings.soundOn);
          setSwitch(els.swSound2, state.settings.soundOn);
        }

        function renderAll() {
          applyTheme();
          renderPills();
          renderTimer();
          renderTimerControls();
          renderStats();
          renderLog();
          renderSettings();
        }

        function openDrawer() {
          els.drawer.dataset.open = "true";
          els.drawer.setAttribute("aria-hidden", "false");
          // focus first input for keyboard flow
          setTimeout(() => els.setFocus.focus(), 0);
        }

        function closeDrawer() {
          els.drawer.dataset.open = "false";
          els.drawer.setAttribute("aria-hidden", "true");
          els.btnSettings.focus();
        }

        function bindSwitch(sw, onChange) {
          const handle = () => {
            const on = toggleSwitch(sw);
            onChange(on);
            save();
          };
          sw.addEventListener("click", handle);
          sw.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              handle();
            }
          });
        }

        function applySettingsToTimerIfIdle() {
          if (state.timer.running) return;
          const desired = desiredMsForPhase(state.timer.phase);
          // If user hasn't custom-modified remaining time, snap to new defaults.
          if (Math.abs((state.timer.plannedMs || desired) - (state.timer.remainingMs || 0)) < 1500) {
            state.timer.plannedMs = desired;
            state.timer.remainingMs = desired;
          } else {
            state.timer.plannedMs = desired;
          }
        }

        function exportCsv() {
          const rows = [["ended_at", "phase", "status", "planned_min", "actual_min"]];
          for (const s of state.history.slice().reverse()) {
            const ended = new Date(s.endedAtMs || s.startedAtMs).toISOString();
            const plannedMin = Math.round((s.plannedMs || 0) / 60000);
            const actualMin = Math.round((s.actualMs || 0) / 60000);
            rows.push([ended, s.phase, s.status, String(plannedMin), String(actualMin)]);
          }
          const csv = rows.map((r) => r.map(csvEscape).join(",")).join("\n");
          downloadText(`pomodoro-sessions-${dayKey()}.csv`, csv, "text/csv");
          toast("Exported", "Saved CSV with your sessions.", "good");
        }

        function csvEscape(s) {
          const v = String(s);
          if (/[",\n]/.test(v)) return `"${v.replaceAll('"', '""')}"`;
          return v;
        }

        function exportJson() {
          const payload = {
            exportedAt: new Date().toISOString(),
            app: "Pomodoro",
            data: state,
          };
          downloadText(`pomodoro-backup-${dayKey()}.json`, JSON.stringify(payload, null, 2), "application/json");
          toast("Exported", "Saved a JSON backup.", "good");
        }

        function clearAll() {
          const ok = confirm("Reset all settings and clear all history on this device?");
          if (!ok) return;
          stopTick();
          state = defaultState();
          save();
          renderAll();
          toast("Reset", "Fresh start. Let‚Äôs go.", "good");
        }

        function clearHistory() {
          const ok = confirm("Clear session history? This cannot be undone.");
          if (!ok) return;
          state.history = [];
          save();
          renderStats();
          renderLog();
          toast("Cleared", "History cleared.", "neutral");
        }

        // ---- events
        els.pillFocus.addEventListener("click", () => setPhase("focus"));
        els.pillShort.addEventListener("click", () => setPhase("short"));
        els.pillLong.addEventListener("click", () => setPhase("long"));

        els.btnStartPause.addEventListener("click", async () => {
          await unlockAudio();
          if (state.timer.running) pause();
          else start();
          renderTimerControls();
        });

        els.btnSkip.addEventListener("click", () => finish({ skipped: true }));
        els.btnReset.addEventListener("click", () => resetCurrent());
        els.btnAddMinute.addEventListener("click", () => addMinute());

        bindSwitch(els.swAuto, (on) => {
          state.settings.autoStartNext = on;
          setSwitch(els.swAuto2, on);
        });
        bindSwitch(els.swAuto2, (on) => {
          state.settings.autoStartNext = on;
          setSwitch(els.swAuto, on);
        });
        bindSwitch(els.swSound, (on) => {
          state.settings.soundOn = on;
          setSwitch(els.swSound2, on);
        });
        bindSwitch(els.swSound2, (on) => {
          state.settings.soundOn = on;
          setSwitch(els.swSound, on);
        });

        els.btnSettings.addEventListener("click", () => openDrawer());
        els.btnCloseSettings.addEventListener("click", () => closeDrawer());
        els.drawerOverlay.addEventListener("click", () => closeDrawer());

        els.btnTheme.addEventListener("click", () => {
          const cur = state.settings.theme;
          const next = cur === "system" ? "dark" : cur === "dark" ? "light" : "system";
          state.settings.theme = next;
          applyTheme();
          renderSettings();
          save();
          toast("Theme", next === "system" ? "Following system theme." : `Switched to ${next}.`, "neutral");
        });

        els.btnShortcuts.addEventListener("click", () => {
          toast(
            "Shortcuts",
            "Space start/pause ‚Ä¢ 1/2/3 type ‚Ä¢ N skip ‚Ä¢ R reset ‚Ä¢ Esc close settings",
            "neutral",
          );
        });

        els.btnFilterAll.addEventListener("click", () => {
          state.ui.logFilter = "all";
          save();
          renderLog();
        });
        els.btnFilterToday.addEventListener("click", () => {
          state.ui.logFilter = "today";
          save();
          renderLog();
        });

        els.btnClear.addEventListener("click", () => clearHistory());
        els.btnExport.addEventListener("click", () => exportCsv());
        els.btnExportJson.addEventListener("click", () => exportJson());
        els.btnResetAll.addEventListener("click", () => clearAll());

        els.logList.addEventListener("click", (e) => {
          const t = e.target;
          if (!(t instanceof HTMLElement)) return;
          const id = t.getAttribute("data-del");
          if (!id) return;
          state.history = state.history.filter((x) => x.id !== id);
          save();
          renderStats();
          renderLog();
          toast("Removed", "Session removed from history.", "neutral");
        });

        // Settings inputs
        const numBind = (input, key, min, max, step = 1) => {
          const handler = () => {
            const raw = Number(input.value);
            const val = clamp(Number.isFinite(raw) ? raw : min, min, max);
            input.value = String(val);
            state.settings[key] = val;
            if (key === "longEvery") els.everyPreview.textContent = String(val);
            applySettingsToTimerIfIdle();
            renderTimer();
            renderStats();
            save();
          };
          input.addEventListener("change", handler);
          input.addEventListener("blur", handler);
          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") input.blur();
          });
          // nudge with wheel on desktop
          input.addEventListener(
            "wheel",
            (e) => {
              if (document.activeElement !== input) return;
              e.preventDefault();
              const dir = Math.sign(e.deltaY);
              const next = clamp((Number(input.value) || 0) + (dir < 0 ? step : -step), min, max);
              input.value = String(next);
              handler();
            },
            { passive: false },
          );
        };

        numBind(els.setFocus, "focusMin", 1, 180, 1);
        numBind(els.setShort, "shortMin", 1, 60, 1);
        numBind(els.setLong, "longMin", 1, 120, 1);
        numBind(els.setEvery, "longEvery", 2, 12, 1);
        numBind(els.setGoal, "goalMin", 10, 600, 5);
        numBind(els.setVolume, "volume", 0, 100, 5);

        els.setBeepStyle.addEventListener("change", () => {
          const v = els.setBeepStyle.value;
          state.settings.beepStyle = v === "single" || v === "chime" ? v : "triple";
          save();
          toast("Sound", `Alert set to ${state.settings.beepStyle}.`, "neutral");
        });

        els.setTheme.addEventListener("change", () => {
          const v = els.setTheme.value;
          state.settings.theme = v === "dark" || v === "light" ? v : "system";
          applyTheme();
          save();
        });

        // Keyboard shortcuts
        window.addEventListener("keydown", async (e) => {
          const tag = (e.target && e.target.tagName) || "";
          const typing = tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT";

          if (e.key === "Escape") {
            if (els.drawer.dataset.open === "true") {
              e.preventDefault();
              closeDrawer();
            }
            return;
          }
          if (typing) return;

          if (e.code === "Space") {
            e.preventDefault();
            await unlockAudio();
            if (state.timer.running) pause();
            else start();
            renderTimerControls();
            return;
          }
          if (e.key === "n" || e.key === "N") {
            e.preventDefault();
            finish({ skipped: true });
            return;
          }
          if (e.key === "r" || e.key === "R") {
            e.preventDefault();
            resetCurrent();
            return;
          }
          if (e.key === "1") {
            e.preventDefault();
            setPhase("focus");
            return;
          }
          if (e.key === "2") {
            e.preventDefault();
            setPhase("short");
            return;
          }
          if (e.key === "3") {
            e.preventDefault();
            setPhase("long");
            return;
          }
          if (e.key === "s" || e.key === "S") {
            // quick sound toggle
            e.preventDefault();
            const on = !state.settings.soundOn;
            state.settings.soundOn = on;
            setSwitch(els.swSound, on);
            setSwitch(els.swSound2, on);
            save();
            toast("Sound", on ? "On" : "Off", "neutral");
          }
        });

        // Keep theme synced in system mode
        window.matchMedia?.("(prefers-color-scheme: dark)")?.addEventListener("change", () => {
          if (state.settings.theme !== "system") return;
          applyTheme();
          renderStats();
          renderTimer();
        });

        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "hidden") save();
          if (document.visibilityState === "visible") renderAll();
        });

        // Boot
        load();
        // Ensure plannedMs matches settings on first render
        state.timer.plannedMs = desiredMsForPhase(state.timer.phase);
        if (!state.timer.running && (state.timer.remainingMs == null || state.timer.remainingMs <= 0)) {
          state.timer.remainingMs = state.timer.plannedMs;
        }
        applyTheme();
        renderAll();
        if (state.timer.running) startTick();

        // UX: initial nudge
        setTimeout(() => {
          if (state.history.length === 0) toast("Welcome", "Set your durations, then hit Start.", "neutral");
        }, 650);
      })();
    </script>
  </body>
</html>
