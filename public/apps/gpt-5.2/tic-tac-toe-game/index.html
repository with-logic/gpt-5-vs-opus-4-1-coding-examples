<!doctype html>
<html lang="en" data-theme="day">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>Tic Tac Toe • SPQR Edition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --font-sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        --font-display: Cinzel, ui-serif, Georgia, serif;

        --radius-lg: 20px;
        --radius-md: 14px;
        --radius-sm: 12px;
        --shadow-soft: 0 14px 40px rgba(0, 0, 0, 0.16);
        --shadow-tight: 0 8px 22px rgba(0, 0, 0, 0.16);
        --stroke: rgba(255, 255, 255, 0.12);

        --gold-1: #f9e07a;
        --gold-2: #d3a73a;
        --gold-3: #8f6b13;

        --board-size: min(88vmin, 560px);
        --cell-gap: clamp(10px, 1.6vmin, 16px);
        --cell-radius: clamp(14px, 2vmin, 22px);

        --ease-out: cubic-bezier(0.2, 0.9, 0.2, 1);
        --ease-smooth: cubic-bezier(0.2, 0.8, 0.2, 1);
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: var(--font-sans);
        color: var(--ink);
        background: var(--bg);
        overflow-x: hidden;
      }

      /* Theme variables */
      html[data-theme="day"] {
        --bg: radial-gradient(1200px 800px at 20% 10%, rgba(255, 246, 220, 0.75), transparent 60%),
          radial-gradient(900px 700px at 80% 20%, rgba(255, 219, 120, 0.22), transparent 60%),
          linear-gradient(180deg, #fbf7ee, #f3ede0 55%, #efe6d7);
        --ink: #1c1a16;
        --muted: rgba(28, 26, 22, 0.66);
        --panel: rgba(255, 255, 255, 0.62);
        --panel-2: rgba(255, 255, 255, 0.42);
        --tile: rgba(255, 255, 255, 0.62);
        --tile-pressed: rgba(248, 241, 223, 0.8);
        --line: rgba(28, 26, 22, 0.12);
        --stroke: rgba(28, 26, 22, 0.12);
        --focus: rgba(211, 167, 58, 0.44);
      }

      html[data-theme="night"] {
        --bg: radial-gradient(1100px 900px at 15% 10%, rgba(170, 140, 90, 0.22), transparent 60%),
          radial-gradient(900px 700px at 80% 25%, rgba(255, 209, 120, 0.16), transparent 60%),
          linear-gradient(180deg, #0f1217, #121722 55%, #0b0f16);
        --ink: #edf0f6;
        --muted: rgba(237, 240, 246, 0.7);
        --panel: rgba(18, 22, 31, 0.68);
        --panel-2: rgba(18, 22, 31, 0.44);
        --tile: rgba(22, 28, 41, 0.68);
        --tile-pressed: rgba(28, 36, 54, 0.74);
        --line: rgba(237, 240, 246, 0.12);
        --stroke: rgba(255, 255, 255, 0.12);
        --focus: rgba(249, 224, 122, 0.34);
      }

      /* Marble + subtle Colosseum arches */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background:
          radial-gradient(1100px 900px at 30% 25%, rgba(255, 255, 255, 0.10), transparent 55%),
          radial-gradient(1000px 800px at 75% 35%, rgba(255, 255, 255, 0.08), transparent 55%),
          repeating-linear-gradient(115deg, rgba(255, 255, 255, 0.12) 0 2px, transparent 2px 20px),
          repeating-linear-gradient(35deg, rgba(0, 0, 0, 0.06) 0 1px, transparent 1px 18px);
        mix-blend-mode: soft-light;
        opacity: 0.22;
        pointer-events: none;
        z-index: -2;
      }

      body::after {
        content: "";
        position: fixed;
        inset: -2px -2px 0 -2px;
        pointer-events: none;
        z-index: -1;
        opacity: 0.38;
        background:
          radial-gradient(160px 120px at 12% 90%, rgba(249, 224, 122, 0.18), transparent 70%),
          radial-gradient(180px 140px at 88% 92%, rgba(211, 167, 58, 0.10), transparent 70%),
          linear-gradient(180deg, transparent 0 72%, rgba(0, 0, 0, 0.08) 100%),
          repeating-linear-gradient(
            90deg,
            transparent 0 14px,
            rgba(255, 255, 255, 0.08) 14px 16px,
            transparent 16px 36px
          );
        mask-image: linear-gradient(180deg, transparent 0 70%, #000 92%),
          radial-gradient(60% 45% at 50% 95%, #000 0 70%, transparent 71%);
        mask-composite: intersect;
      }

      .app {
        min-height: 100svh;
        display: grid;
        grid-template-rows: auto auto 1fr;
      }

      header {
        position: sticky;
        top: 0;
        z-index: 20;
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        background: linear-gradient(180deg, var(--panel), transparent);
        border-bottom: 1px solid var(--stroke);
      }

      .topbar {
        max-width: 1120px;
        margin: 0 auto;
        padding: clamp(12px, 2.2vmin, 18px) clamp(12px, 3.6vmin, 26px);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }

      .crest {
        width: 42px;
        height: 42px;
        flex: 0 0 auto;
        filter: drop-shadow(0 10px 18px rgba(0, 0, 0, 0.25));
      }

      .brandText {
        display: grid;
        gap: 2px;
        min-width: 0;
      }

      .brandText .title {
        font-family: var(--font-display);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        font-size: clamp(14px, 2.2vmin, 16px);
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .brandText .subtitle {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .btn {
        appearance: none;
        border: 1px solid var(--stroke);
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        color: var(--ink);
        border-radius: 999px;
        padding: 10px 14px;
        font-weight: 600;
        font-size: 13px;
        letter-spacing: 0.02em;
        cursor: pointer;
        transition: transform 160ms var(--ease-out), box-shadow 160ms var(--ease-out), background 160ms var(--ease-out);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.14);
        user-select: none;
        touch-action: manipulation;
        white-space: nowrap;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.18);
      }

      .btn:active {
        transform: translateY(0px) scale(0.99);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.14);
        background: linear-gradient(180deg, var(--panel-2), var(--panel));
      }

      .btn:focus-visible {
        outline: 3px solid var(--focus);
        outline-offset: 2px;
      }

      .btn.primary {
        border-color: rgba(211, 167, 58, 0.55);
        background: linear-gradient(180deg, rgba(249, 224, 122, 0.26), rgba(211, 167, 58, 0.18));
      }

      .btn.danger {
        border-color: rgba(255, 140, 140, 0.25);
      }

      .bannerSlot {
        max-width: 1120px;
        margin: 0 auto;
        padding: 0 clamp(12px, 3.6vmin, 26px);
      }

      .banner {
        min-height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .bannerInner {
        width: 100%;
        max-width: 920px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.06), transparent);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 10px 14px;
        box-shadow: var(--shadow-tight);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        opacity: 0;
        transform: translateY(-6px);
        transition: opacity 220ms var(--ease-out), transform 220ms var(--ease-out);
      }

      .bannerInner[data-visible="true"] {
        opacity: 1;
        transform: translateY(0px);
      }

      .bannerInner .badge {
        font-family: var(--font-display);
        letter-spacing: 0.12em;
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        background: linear-gradient(180deg, rgba(249, 224, 122, 0.28), rgba(211, 167, 58, 0.16));
        border: 1px solid rgba(211, 167, 58, 0.45);
        color: var(--ink);
        flex: 0 0 auto;
      }

      .bannerInner .text {
        color: var(--ink);
        font-weight: 600;
        letter-spacing: 0.01em;
        text-align: center;
      }

      .main {
        max-width: 1120px;
        width: 100%;
        margin: 0 auto;
        padding: clamp(12px, 3.6vmin, 26px);
        display: grid;
        gap: clamp(12px, 2.6vmin, 20px);
        align-items: start;
        grid-template-columns: 1fr;
      }

      @media (min-width: 940px) {
        .main {
          grid-template-columns: 360px 1fr;
          align-items: center;
        }
      }

      .card {
        border-radius: var(--radius-lg);
        border: 1px solid var(--stroke);
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        box-shadow: var(--shadow-soft);
        overflow: hidden;
      }

      .cardHeader {
        padding: 16px 18px 12px;
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        border-bottom: 1px solid var(--stroke);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), transparent);
      }

      .cardHeader h2 {
        margin: 0;
        font-size: 13px;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--muted);
        font-family: var(--font-display);
      }

      .smallNote {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.02em;
      }

      .scoreGrid {
        padding: 14px 18px 18px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }

      .score {
        border-radius: 16px;
        border: 1px solid var(--stroke);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), transparent);
        padding: 12px 12px 10px;
        display: grid;
        gap: 8px;
        min-height: 78px;
      }

      .score .label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .pill {
        font-size: 11px;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .tokenChip {
        font-family: var(--font-display);
        letter-spacing: 0.12em;
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(211, 167, 58, 0.45);
        background: linear-gradient(180deg, rgba(249, 224, 122, 0.24), rgba(211, 167, 58, 0.12));
        color: var(--ink);
      }

      .score .value {
        font-size: clamp(22px, 3.8vmin, 30px);
        font-weight: 700;
        letter-spacing: 0.02em;
        font-variant-numeric: tabular-nums;
      }

      .statusBox {
        padding: 14px 18px 18px;
        border-top: 1px solid var(--stroke);
        display: grid;
        gap: 8px;
      }

      .statusLine {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .statusText {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .subText {
        margin: 0;
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.01em;
      }

      .boardCard {
        padding: clamp(14px, 2.6vmin, 18px);
        display: grid;
        justify-items: center;
        gap: 12px;
      }

      .boardWrap {
        width: var(--board-size);
        max-width: 100%;
        aspect-ratio: 1;
        position: relative;
      }

      .board {
        width: 100%;
        height: 100%;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--cell-gap);
        padding: var(--cell-gap);
        border-radius: calc(var(--radius-lg) + 10px);
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.08), transparent);
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow-soft);
      }

      .cell {
        width: 100%;
        height: 100%;
        border-radius: var(--cell-radius);
        border: 1px solid var(--stroke);
        background: radial-gradient(140% 140% at 30% 20%, rgba(255, 255, 255, 0.10), transparent 55%),
          linear-gradient(180deg, var(--tile), transparent);
        color: var(--ink);
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: transform 140ms var(--ease-out), box-shadow 140ms var(--ease-out), background 160ms var(--ease-out),
          border-color 160ms var(--ease-out);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.16);
        user-select: none;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }

      .cell:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 26px rgba(0, 0, 0, 0.18);
      }

      .cell:active {
        transform: translateY(0px) scale(0.99);
        background: linear-gradient(180deg, var(--tile-pressed), transparent);
      }

      .cell:focus-visible {
        outline: 3px solid var(--focus);
        outline-offset: 2px;
      }

      .cell[aria-disabled="true"] {
        cursor: not-allowed;
        opacity: 0.92;
      }

      .mark {
        display: grid;
        place-items: center;
        width: min(18vmin, 120px);
        height: min(18vmin, 120px);
      }

      .mark svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      .markText {
        font-family: var(--font-display);
        font-size: clamp(46px, 12vmin, 92px);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        line-height: 1;
        transform: translateX(0.03em);
        filter: drop-shadow(0 10px 18px rgba(0, 0, 0, 0.25));
      }

      .cell.win {
        border-color: rgba(249, 224, 122, 0.78);
        box-shadow: 0 0 0 3px rgba(249, 224, 122, 0.20), 0 18px 40px rgba(0, 0, 0, 0.22);
        background: radial-gradient(120% 120% at 30% 20%, rgba(249, 224, 122, 0.24), transparent 60%),
          linear-gradient(180deg, rgba(249, 224, 122, 0.10), transparent);
      }

      .hintBar {
        width: min(var(--board-size), 560px);
        max-width: 100%;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.06), transparent);
        padding: 10px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .hintBar .left {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }

      .turnMedal {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        border: 1px solid rgba(211, 167, 58, 0.5);
        background: radial-gradient(circle at 30% 30%, rgba(249, 224, 122, 0.32), rgba(211, 167, 58, 0.12));
        box-shadow: 0 12px 22px rgba(0, 0, 0, 0.16);
        flex: 0 0 auto;
      }

      .hintTitle {
        font-size: 13px;
        font-weight: 700;
        letter-spacing: 0.02em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .kbdHint {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.02em;
        white-space: nowrap;
      }

      .srOnly {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      /* Dialog */
      dialog {
        width: min(720px, calc(100vw - 24px));
        border: 1px solid var(--stroke);
        border-radius: 22px;
        padding: 0;
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        color: var(--ink);
        box-shadow: 0 26px 80px rgba(0, 0, 0, 0.45);
      }

      dialog::backdrop {
        background: radial-gradient(900px 650px at 50% 10%, rgba(249, 224, 122, 0.14), transparent 60%),
          rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(6px);
      }

      .dialogHeader {
        padding: 16px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        border-bottom: 1px solid var(--stroke);
      }

      .dialogHeader h3 {
        margin: 0;
        font-family: var(--font-display);
        letter-spacing: 0.14em;
        text-transform: uppercase;
        font-size: 14px;
      }

      .iconBtn {
        appearance: none;
        border: 1px solid var(--stroke);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), transparent);
        color: var(--ink);
        border-radius: 999px;
        width: 40px;
        height: 40px;
        display: grid;
        place-items: center;
        cursor: pointer;
        transition: transform 160ms var(--ease-out), box-shadow 160ms var(--ease-out);
      }

      .iconBtn:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 26px rgba(0, 0, 0, 0.18);
      }

      .iconBtn:active {
        transform: translateY(0px) scale(0.99);
      }

      .iconBtn:focus-visible {
        outline: 3px solid var(--focus);
        outline-offset: 2px;
      }

      .dialogBody {
        padding: 14px 18px 18px;
        display: grid;
        gap: 14px;
      }

      .fieldset {
        border: 1px solid var(--stroke);
        border-radius: 18px;
        padding: 12px 12px 10px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), transparent);
      }

      .legend {
        font-size: 12px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--muted);
        font-family: var(--font-display);
        margin: 0 0 10px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .options {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }

      @media (min-width: 620px) {
        .options {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .opt {
        display: flex;
        align-items: center;
        gap: 10px;
        border-radius: 14px;
        padding: 10px 10px;
        border: 1px solid var(--stroke);
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.06), transparent);
        cursor: pointer;
        user-select: none;
      }

      .opt input {
        accent-color: var(--gold-2);
      }

      .optText {
        display: grid;
        gap: 2px;
      }

      .optText .name {
        font-weight: 700;
        letter-spacing: 0.01em;
      }

      .optText .desc {
        font-size: 12px;
        color: var(--muted);
      }

      .row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }

      @media (min-width: 620px) {
        .row {
          grid-template-columns: 1fr 1fr;
        }
      }

      .selectWrap {
        display: grid;
        gap: 6px;
      }

      label.small {
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      select {
        width: 100%;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), transparent);
        color: var(--ink);
        padding: 10px 12px;
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      select:focus-visible {
        outline: 3px solid var(--focus);
        outline-offset: 2px;
      }

      .dialogFooter {
        padding: 14px 18px 18px;
        border-top: 1px solid var(--stroke);
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .dialogFooter .btn {
        box-shadow: none;
      }

      .dialogFooter .btn:hover {
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.22);
      }

      /* Confetti canvas */
      #confetti {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 25;
      }

      @media (prefers-reduced-motion: reduce) {
        .btn,
        .cell,
        .bannerInner {
          transition: none !important;
        }
        .btn:hover,
        .cell:hover {
          transform: none !important;
        }
      }
    </style>
  </head>
  <body>
    <canvas id="confetti" aria-hidden="true"></canvas>

    <div class="app">
      <header>
        <div class="topbar">
          <div class="brand" aria-label="SPQR Tic Tac Toe">
            <svg class="crest" viewBox="0 0 64 64" aria-hidden="true">
              <defs>
                <linearGradient id="gGold" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0" stop-color="#f9e07a" stop-opacity="0.95" />
                  <stop offset="0.55" stop-color="#d3a73a" stop-opacity="0.9" />
                  <stop offset="1" stop-color="#8f6b13" stop-opacity="0.9" />
                </linearGradient>
                <linearGradient id="gRed" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0" stop-color="#8b1d22" stop-opacity="0.92" />
                  <stop offset="1" stop-color="#4d0f12" stop-opacity="0.92" />
                </linearGradient>
              </defs>
              <path
                d="M32 3c10 6 20 7 27 8v20c0 15-10.5 26.5-27 30C15.5 57.5 5 46 5 31V11c7-1 17-2 27-8Z"
                fill="url(#gRed)"
                stroke="url(#gGold)"
                stroke-width="2"
              />
              <path d="M13 16h38v4H13zM13 24h38v4H13zM13 32h38v4H13z" fill="rgba(255,255,255,0.12)" />
              <text
                x="32"
                y="45"
                text-anchor="middle"
                font-family="Cinzel, serif"
                font-size="18"
                letter-spacing="2"
                fill="url(#gGold)"
              >
                SPQR
              </text>
            </svg>
            <div class="brandText">
              <div class="title">Tic Tac Toe</div>
              <div class="subtitle">Arena Round • No Quarter</div>
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" id="newRoundBtn" type="button">New Round</button>
            <button class="btn" id="customizeBtn" type="button">Customize</button>
            <button class="btn danger" id="resetScoresBtn" type="button">Reset Scores</button>
          </div>
        </div>
      </header>

      <div class="bannerSlot" aria-live="polite" aria-atomic="true">
        <div class="banner">
          <div class="bannerInner" id="bannerInner" data-visible="false">
            <span class="badge" id="bannerBadge">Edict</span>
            <span class="text" id="bannerText">Choose your discipline in Customize, then begin.</span>
          </div>
        </div>
      </div>

      <main class="main">
        <section class="card" aria-label="Scoreboard">
          <div class="cardHeader">
            <h2>Scoreboard</h2>
            <div class="smallNote" id="modeNote">Mode: 2-Player</div>
          </div>
          <div class="scoreGrid">
            <div class="score" aria-label="X wins">
              <div class="label">
                <span class="pill">Wins</span>
                <span class="tokenChip" id="chipX">X</span>
              </div>
              <div class="value" id="scoreX">0</div>
            </div>
            <div class="score" aria-label="O wins">
              <div class="label">
                <span class="pill">Wins</span>
                <span class="tokenChip" id="chipO">O</span>
              </div>
              <div class="value" id="scoreO">0</div>
            </div>
            <div class="score" aria-label="Draws">
              <div class="label">
                <span class="pill">Draws</span>
                <span class="tokenChip">Ⅲ</span>
              </div>
              <div class="value" id="scoreD">0</div>
            </div>
          </div>
          <div class="statusBox">
            <div class="statusLine">
              <p class="statusText" id="statusText">Turn: X</p>
              <p class="kbdHint" id="kbdHint">Arrows • Enter</p>
            </div>
            <p class="subText" id="subText">Claim three in a row to win the laurel.</p>
            <div class="srOnly" id="liveStatus" role="status" aria-live="polite" aria-atomic="true"></div>
          </div>
        </section>

        <section class="boardCard" aria-label="Game board">
          <div class="boardWrap">
            <div
              id="board"
              class="board"
              role="grid"
              aria-label="Tic tac toe"
              aria-rowcount="3"
              aria-colcount="3"
            ></div>
          </div>
          <div class="hintBar" aria-label="Turn and help">
            <div class="left">
              <span class="turnMedal" aria-hidden="true"></span>
              <div class="hintTitle" id="hintTitle">Round in progress</div>
            </div>
            <div class="kbdHint" id="hintRight">Tap a tile • Or use keyboard</div>
          </div>
        </section>
      </main>
    </div>

    <dialog id="customizeDialog" aria-labelledby="customizeTitle">
      <div class="dialogHeader">
        <h3 id="customizeTitle">Customize</h3>
        <button class="iconBtn" id="closeDialogBtn" type="button" aria-label="Close dialog">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M18 6 6 18M6 6l12 12"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
            />
          </svg>
        </button>
      </div>
      <div class="dialogBody">
        <div class="fieldset" role="group" aria-label="Theme options">
          <div class="legend">Theme</div>
          <div class="options">
            <label class="opt">
              <input type="radio" name="theme" value="day" />
              <span class="optText">
                <span class="name">Marble Day</span>
                <span class="desc">Bright atrium stone, warm gold.</span>
              </span>
            </label>
            <label class="opt">
              <input type="radio" name="theme" value="night" />
              <span class="optText">
                <span class="name">Night Legion</span>
                <span class="desc">Midnight basalt, torchlit accents.</span>
              </span>
            </label>
          </div>
        </div>

        <div class="fieldset" role="group" aria-label="Glyph options">
          <div class="legend">Glyphs</div>
          <div class="options">
            <label class="opt">
              <input type="radio" name="glyphs" value="xo" />
              <span class="optText">
                <span class="name">Standard X / O</span>
                <span class="desc">Classic marks, imperial polish.</span>
              </span>
            </label>
            <label class="opt">
              <input type="radio" name="glyphs" value="roman" />
              <span class="optText">
                <span class="name">Gladius / Laurel</span>
                <span class="desc">Steel versus wreath.</span>
              </span>
            </label>
          </div>
        </div>

        <div class="fieldset" role="group" aria-label="Mode options">
          <div class="legend">Mode</div>
          <div class="options">
            <label class="opt">
              <input type="radio" name="mode" value="pvp" />
              <span class="optText">
                <span class="name">2-Player</span>
                <span class="desc">Hot-seat duel on one device.</span>
              </span>
            </label>
            <label class="opt">
              <input type="radio" name="mode" value="ai" />
              <span class="optText">
                <span class="name">Vs AI</span>
                <span class="desc">Face the legion's discipline.</span>
              </span>
            </label>
          </div>
        </div>

        <div class="row">
          <div class="fieldset" role="group" aria-label="First move options">
            <div class="legend">First Move</div>
            <div class="options">
              <label class="opt">
                <input type="radio" name="first" value="X" />
                <span class="optText">
                  <span class="name">X opens</span>
                  <span class="desc">Seize initiative.</span>
                </span>
              </label>
              <label class="opt">
                <input type="radio" name="first" value="O" />
                <span class="optText">
                  <span class="name">O opens</span>
                  <span class="desc">Counter with patience.</span>
                </span>
              </label>
            </div>
          </div>

          <div class="fieldset" role="group" aria-label="AI discipline options">
            <div class="legend">AI Discipline <span class="pill" id="aiHint">vs AI only</span></div>
            <div class="selectWrap">
              <label class="small" for="aiDiscipline">Choose</label>
              <select id="aiDiscipline" name="aiDiscipline">
                <option value="perfect">Perfect (Minimax)</option>
                <option value="pragmatic">Pragmatic (Handicapped)</option>
                <option value="reckless">Reckless (Chaotic)</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="dialogFooter">
        <button class="btn" id="cancelDialogBtn" type="button">Cancel</button>
        <button class="btn primary" id="applyDialogBtn" type="button">Apply</button>
      </div>
    </dialog>

    <script>
      (() => {
        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const STORAGE_KEY = "spqr_ttt_v1";

        const prefersReducedMotion = window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches ?? false;

        const LINES = [
          [0, 1, 2],
          [3, 4, 5],
          [6, 7, 8],
          [0, 3, 6],
          [1, 4, 7],
          [2, 5, 8],
          [0, 4, 8],
          [2, 4, 6],
        ];

        const state = {
          settings: {
            theme: "day",
            glyphs: "roman",
            mode: "pvp", // pvp | ai
            first: "X", // X | O
            aiDiscipline: "perfect", // perfect | pragmatic | reckless
          },
          scores: { X: 0, O: 0, D: 0 },
          board: Array(9).fill(null),
          turn: "X",
          gameOver: false,
          winner: null, // "X" | "O" | "D" | null
          winLine: null, // number[] | null
          focusIndex: 4,
          aiThinking: false,
          openingNoteShown: false,
        };

        // ---- Icons (Roman glyphs) ----
        const svgGladius = `
          <svg viewBox="0 0 64 64" role="img" aria-hidden="true" focusable="false">
            <defs>
              <linearGradient id="blade" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="rgba(255,255,255,0.95)"/>
                <stop offset="1" stop-color="rgba(185,195,210,0.85)"/>
              </linearGradient>
              <linearGradient id="hilt" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="#f9e07a" stop-opacity="0.95"/>
                <stop offset="1" stop-color="#d3a73a" stop-opacity="0.9"/>
              </linearGradient>
            </defs>
            <path d="M32 6c6 7 9 15 9 23 0 9-4 18-9 30-5-12-9-21-9-30 0-8 3-16 9-23Z" fill="url(#blade)" opacity="0.95"/>
            <path d="M23 29h18v4H23z" fill="url(#hilt)"/>
            <path d="M28 33h8v12h-8z" fill="rgba(120,80,18,0.92)"/>
            <path d="M26 45h12v6H26z" fill="url(#hilt)"/>
            <path d="M32 6c6 7 9 15 9 23 0 9-4 18-9 30-5-12-9-21-9-30 0-8 3-16 9-23Z" fill="none" stroke="rgba(0,0,0,0.25)" stroke-width="1.2"/>
          </svg>
        `;

        const svgLaurel = `
          <svg viewBox="0 0 64 64" role="img" aria-hidden="true" focusable="false">
            <defs>
              <linearGradient id="leaf" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="#f9e07a" stop-opacity="0.95"/>
                <stop offset="1" stop-color="#d3a73a" stop-opacity="0.85"/>
              </linearGradient>
            </defs>
            <path d="M18 46c-6-9-6-19 2-28 5 10 5 18-2 28Z" fill="url(#leaf)"/>
            <path d="M46 46c6-9 6-19-2-28-5 10-5 18 2 28Z" fill="url(#leaf)"/>
            <path d="M21 44c4-3 7-6 10-9-2 5-5 9-10 9Z" fill="rgba(255,255,255,0.18)"/>
            <path d="M43 44c-4-3-7-6-10-9 2 5 5 9 10 9Z" fill="rgba(255,255,255,0.18)"/>
            <path d="M24 50c3 4 7 6 8 7 1-1 5-3 8-7" fill="none" stroke="rgba(249,224,122,0.9)" stroke-width="3" stroke-linecap="round"/>
            <path d="M24 50c3 4 7 6 8 7 1-1 5-3 8-7" fill="none" stroke="rgba(0,0,0,0.25)" stroke-width="1.2" stroke-linecap="round"/>
          </svg>
        `;

        const ui = {
          boardEl: $("#board"),
          statusText: $("#statusText"),
          subText: $("#subText"),
          liveStatus: $("#liveStatus"),
          hintTitle: $("#hintTitle"),
          hintRight: $("#hintRight"),
          kbdHint: $("#kbdHint"),
          modeNote: $("#modeNote"),
          scoreX: $("#scoreX"),
          scoreO: $("#scoreO"),
          scoreD: $("#scoreD"),
          chipX: $("#chipX"),
          chipO: $("#chipO"),
          bannerInner: $("#bannerInner"),
          bannerBadge: $("#bannerBadge"),
          bannerText: $("#bannerText"),
          newRoundBtn: $("#newRoundBtn"),
          resetScoresBtn: $("#resetScoresBtn"),
          customizeBtn: $("#customizeBtn"),
          dialog: $("#customizeDialog"),
          closeDialogBtn: $("#closeDialogBtn"),
          cancelDialogBtn: $("#cancelDialogBtn"),
          applyDialogBtn: $("#applyDialogBtn"),
          aiDiscipline: $("#aiDiscipline"),
          confetti: $("#confetti"),
        };

        let bannerTimer = null;
        let aiTimer = null;

        function safeSetBanner(badge, text, { autoHideMs = 2200 } = {}) {
          ui.bannerBadge.textContent = badge;
          ui.bannerText.textContent = text;
          ui.bannerInner.dataset.visible = "true";
          if (bannerTimer) window.clearTimeout(bannerTimer);
          if (autoHideMs > 0) {
            bannerTimer = window.setTimeout(() => (ui.bannerInner.dataset.visible = "false"), autoHideMs);
          }
        }

        function save() {
          try {
            localStorage.setItem(
              STORAGE_KEY,
              JSON.stringify({
                settings: state.settings,
                scores: state.scores,
              }),
            );
          } catch {
            // ignore
          }
        }

        function load() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed?.settings) Object.assign(state.settings, parsed.settings);
            if (parsed?.scores) Object.assign(state.scores, parsed.scores);
          } catch {
            // ignore
          }
        }

        function setTheme(theme) {
          document.documentElement.dataset.theme = theme;
        }

        function tokenLabel(token) {
          if (state.settings.glyphs === "xo") return token;
          return token === "X" ? "Gladius" : "Laurel";
        }

        function markHTML(token) {
          if (!token) return "";
          if (state.settings.glyphs === "xo") {
            return `<span class="markText" aria-hidden="true">${token}</span>`;
          }
          return `<span class="mark" aria-hidden="true">${token === "X" ? svgGladius : svgLaurel}</span>`;
        }

        function announce(text) {
          ui.liveStatus.textContent = text;
        }

        function other(token) {
          return token === "X" ? "O" : "X";
        }

        function emptyIndices(board) {
          const out = [];
          for (let i = 0; i < 9; i++) if (!board[i]) out.push(i);
          return out;
        }

        function checkWinner(board) {
          for (const line of LINES) {
            const [a, b, c] = line;
            if (board[a] && board[a] === board[b] && board[a] === board[c]) {
              return { winner: board[a], line };
            }
          }
          return null;
        }

        function isDraw(board) {
          return board.every(Boolean) && !checkWinner(board);
        }

        function boardKey(board, turn) {
          return board.map((v) => v ?? "-").join("") + "|" + turn;
        }

        function minimax(board, turn, aiToken, humanToken, depth, memo) {
          const win = checkWinner(board);
          if (win) {
            if (win.winner === aiToken) return 10 - depth;
            return depth - 10;
          }
          if (isDraw(board)) return 0;

          const key = boardKey(board, turn);
          if (memo.has(key)) return memo.get(key);

          const moves = emptyIndices(board);
          let best = turn === aiToken ? -Infinity : Infinity;
          for (const idx of moves) {
            board[idx] = turn;
            const score = minimax(board, other(turn), aiToken, humanToken, depth + 1, memo);
            board[idx] = null;
            if (turn === aiToken) best = Math.max(best, score);
            else best = Math.min(best, score);
          }

          memo.set(key, best);
          return best;
        }

        function findImmediateTactics(board, aiToken, humanToken) {
          const moves = emptyIndices(board);
          // Win now
          for (const idx of moves) {
            board[idx] = aiToken;
            const win = checkWinner(board);
            board[idx] = null;
            if (win?.winner === aiToken) return { type: "win", idx };
          }
          // Block human win
          for (const idx of moves) {
            board[idx] = humanToken;
            const win = checkWinner(board);
            board[idx] = null;
            if (win?.winner === humanToken) return { type: "block", idx };
          }
          return null;
        }

        function chooseAIMove(board) {
          const aiToken = "O";
          const humanToken = "X";
          const moves = emptyIndices(board);
          if (moves.length === 0) return null;

          const tactics = findImmediateTactics(board, aiToken, humanToken);
          if (tactics) return tactics.idx;

          const memo = new Map();
          const scored = moves.map((idx) => {
            board[idx] = aiToken;
            const score = minimax(board, humanToken, aiToken, humanToken, 0, memo);
            board[idx] = null;
            return { idx, score };
          });
          scored.sort((a, b) => b.score - a.score);

          const discipline = state.settings.aiDiscipline;
          if (discipline === "perfect") return scored[0].idx;

          const rand = Math.random();
          if (discipline === "pragmatic") {
            const top = scored.slice(0, Math.min(3, scored.length));
            const weights = top.map((_, i) => (i === 0 ? 0.68 : i === 1 ? 0.22 : 0.1));
            const pick = weightedPick(top, weights, rand);
            return pick.idx;
          }

          // reckless
          if (rand < 0.12) return scored[0].idx;
          if (rand < 0.42) return moves[(Math.random() * moves.length) | 0];
          const half = scored.slice(Math.floor(scored.length / 2));
          const bucket = half.length ? half : scored;
          return bucket[(Math.random() * bucket.length) | 0].idx;
        }

        function weightedPick(items, weights, r) {
          const sum = weights.reduce((a, b) => a + b, 0);
          let t = (r ?? Math.random()) * sum;
          for (let i = 0; i < items.length; i++) {
            t -= weights[i];
            if (t <= 0) return items[i];
          }
          return items[items.length - 1];
        }

        function setGameOver(result) {
          state.gameOver = true;
          state.winner = result;
          state.aiThinking = false;
          if (aiTimer) window.clearTimeout(aiTimer);
          aiTimer = null;
        }

        function finishRoundWin(winner, line) {
          setGameOver(winner);
          state.winLine = line;
          state.scores[winner] += 1;
          save();
          const headline = winner === "X" ? "Victory for X" : "Victory for O";
          safeSetBanner("Triumph", `${headline} — ${tokenLabel(winner)} claims the laurel.`, { autoHideMs: 0 });
          announce(`${headline}.`);
          startConfetti();
        }

        function finishRoundDraw() {
          setGameOver("D");
          state.winLine = null;
          state.scores.D += 1;
          save();
          safeSetBanner("Stalemate", "No victor — the arena awaits another round.", { autoHideMs: 0 });
          announce("Draw.");
        }

        function startNewRound({ announceIt = true } = {}) {
          state.board = Array(9).fill(null);
          state.turn = state.settings.first;
          state.gameOver = false;
          state.winner = null;
          state.winLine = null;
          state.aiThinking = false;
          state.openingNoteShown = false;
          if (aiTimer) window.clearTimeout(aiTimer);
          aiTimer = null;
          stopConfetti();
          if (announceIt) {
            safeSetBanner("Edict", `New round — ${state.turn} moves first.`, { autoHideMs: 2200 });
            announce(`New round. ${state.turn} to move.`);
          }
          render();
          maybeAIMove();
        }

        function resetScores() {
          state.scores = { X: 0, O: 0, D: 0 };
          save();
          safeSetBanner("Decree", "Scores reset — the annals begin anew.", { autoHideMs: 2600 });
          announce("Scores reset.");
          renderScores();
        }

        function canInteract() {
          if (state.gameOver) return false;
          if (state.aiThinking) return false;
          if (state.settings.mode !== "ai") return true;
          // Human is always X in vs AI mode.
          return state.turn === "X";
        }

        function place(idx) {
          if (!canInteract()) return;
          if (state.board[idx]) return;

          state.board[idx] = state.turn;
          const win = checkWinner(state.board);
          if (win) {
            finishRoundWin(win.winner, win.line);
            render();
            return;
          }
          if (isDraw(state.board)) {
            finishRoundDraw();
            render();
            return;
          }

          state.turn = other(state.turn);
          announce(`${state.turn} to move.`);
          render();
          maybeAIMove();
        }

        function maybeAIMove() {
          if (state.settings.mode !== "ai") return;
          if (state.gameOver) return;
          if (state.turn !== "O") return;

          state.aiThinking = true;
          announce("AI thinking.");
          render();

          const delay = state.settings.aiDiscipline === "perfect" ? 260 : state.settings.aiDiscipline === "pragmatic" ? 340 : 420;
          aiTimer = window.setTimeout(() => {
            aiTimer = null;
            const idx = chooseAIMove(state.board.slice());
            state.aiThinking = false;
            if (idx == null) return;
            if (state.gameOver) return;
            if (state.turn !== "O") return;
            if (state.board[idx]) return;

            state.board[idx] = "O";
            const win = checkWinner(state.board);
            if (win) {
              finishRoundWin(win.winner, win.line);
              render();
              return;
            }
            if (isDraw(state.board)) {
              finishRoundDraw();
              render();
              return;
            }
            state.turn = "X";
            announce("Your turn.");
            render();
          }, delay);
        }

        function renderScores() {
          ui.scoreX.textContent = String(state.scores.X);
          ui.scoreO.textContent = String(state.scores.O);
          ui.scoreD.textContent = String(state.scores.D);
        }

        function renderModeNote() {
          const { mode, aiDiscipline, first } = state.settings;
          if (mode === "pvp") {
            ui.modeNote.textContent = `Mode: 2-Player • First: ${first}`;
            return;
          }
          const label = aiDiscipline === "perfect" ? "Perfect" : aiDiscipline === "pragmatic" ? "Pragmatic" : "Reckless";
          ui.modeNote.textContent = `Mode: vs AI (${label}) • First: ${first}`;
        }

        function cellAriaLabel(idx) {
          const r = Math.floor(idx / 3) + 1;
          const c = (idx % 3) + 1;
          const v = state.board[idx];
          const occupant = v ? (state.settings.glyphs === "xo" ? v : tokenLabel(v)) : "Empty";
          return `Row ${r}, column ${c}. ${occupant}.`;
        }

        function render() {
          setTheme(state.settings.theme);

          renderScores();
          renderModeNote();

          ui.chipX.textContent = state.settings.glyphs === "xo" ? "X" : "⚔";
          ui.chipO.textContent = state.settings.glyphs === "xo" ? "O" : "❧";

          const status =
            state.gameOver && state.winner === "D"
              ? "Draw"
              : state.gameOver
                ? `Winner: ${state.winner}`
                : state.aiThinking
                  ? "AI: Thinking…"
                  : `Turn: ${state.turn}`;

          ui.statusText.textContent = status;
          ui.subText.textContent =
            state.settings.mode === "ai"
              ? "You are X. The legion plays as O."
              : "Two players — alternate turns with honor.";

          ui.hintTitle.textContent =
            state.gameOver && state.winner === "D"
              ? "Stalemate — no victor"
              : state.gameOver
                ? `Triumph — ${state.winner} wins`
                : state.aiThinking
                  ? "The legion considers…"
                  : `${state.turn} to move`;
          ui.hintRight.textContent =
            state.gameOver ? "New Round to continue" : state.settings.mode === "ai" ? "Tap a tile • You are X" : "Tap a tile • Or use keyboard";
          ui.kbdHint.textContent = "Arrows • Enter";

          const disabled = !canInteract();
          const winSet = new Set(state.winLine ?? []);

          const cells = $$(".cell", ui.boardEl);
          for (let i = 0; i < cells.length; i++) {
            const btn = cells[i];
            const v = state.board[i];
            btn.innerHTML = v ? markHTML(v) : "";
            btn.setAttribute("aria-label", cellAriaLabel(i));
            btn.setAttribute("aria-disabled", String(!!(state.board[i] || disabled || state.gameOver)));
            btn.classList.toggle("win", winSet.has(i));
          }

          const focusable = state.focusIndex;
          for (let i = 0; i < cells.length; i++) {
            cells[i].tabIndex = i === focusable ? 0 : -1;
          }

          if (
            state.settings.mode === "ai" &&
            state.settings.first === "O" &&
            !state.gameOver &&
            !state.aiThinking &&
            !state.openingNoteShown &&
            state.board.every((x) => !x)
          ) {
            state.openingNoteShown = true;
            safeSetBanner("Edict", "The legion opens. Brace yourself.", { autoHideMs: 2600 });
          }
        }

        function buildBoard() {
          ui.boardEl.innerHTML = "";
          for (let i = 0; i < 9; i++) {
            const r = Math.floor(i / 3) + 1;
            const c = (i % 3) + 1;
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "cell";
            btn.dataset.idx = String(i);
            btn.setAttribute("role", "gridcell");
            btn.setAttribute("aria-rowindex", String(r));
            btn.setAttribute("aria-colindex", String(c));
            btn.setAttribute("aria-label", cellAriaLabel(i));
            btn.tabIndex = i === state.focusIndex ? 0 : -1;
            btn.addEventListener("click", () => {
              state.focusIndex = i;
              place(i);
              render();
            });
            ui.boardEl.appendChild(btn);
          }
          ui.boardEl.addEventListener("keydown", onBoardKeyDown);
        }

        function onBoardKeyDown(e) {
          const cells = $$(".cell", ui.boardEl);
          if (!cells.length) return;

          const key = e.key;
          const i = state.focusIndex;
          const row = Math.floor(i / 3);
          const col = i % 3;

          let next = i;
          if (key === "ArrowUp") next = ((row + 2) % 3) * 3 + col;
          else if (key === "ArrowDown") next = ((row + 1) % 3) * 3 + col;
          else if (key === "ArrowLeft") next = row * 3 + ((col + 2) % 3);
          else if (key === "ArrowRight") next = row * 3 + ((col + 1) % 3);
          else if (key === "Home") next = 0;
          else if (key === "End") next = 8;
          else if (key === "Enter" || key === " ") {
            e.preventDefault();
            place(i);
            render();
            return;
          } else return;

          e.preventDefault();
          state.focusIndex = next;
          render();
          cells[next]?.focus?.();
        }

        // ---- Customize dialog ----
        function openDialog() {
          syncDialogFromState();
          ui.dialog.showModal();
          ui.aiDiscipline.disabled = state.settings.mode !== "ai";
          safeSetBanner("Edict", "Customize the arena: theme, glyphs, discipline.", { autoHideMs: 1800 });
        }

        function closeDialog() {
          if (ui.dialog.open) ui.dialog.close();
        }

        function syncDialogFromState() {
          $$('input[name="theme"]').forEach((el) => (el.checked = el.value === state.settings.theme));
          $$('input[name="glyphs"]').forEach((el) => (el.checked = el.value === state.settings.glyphs));
          $$('input[name="mode"]').forEach((el) => (el.checked = el.value === state.settings.mode));
          $$('input[name="first"]').forEach((el) => (el.checked = el.value === state.settings.first));
          ui.aiDiscipline.value = state.settings.aiDiscipline;
          ui.aiDiscipline.disabled = state.settings.mode !== "ai";
        }

        function readDialogToState() {
          const theme = $('input[name="theme"]:checked')?.value ?? "day";
          const glyphs = $('input[name="glyphs"]:checked')?.value ?? "roman";
          const mode = $('input[name="mode"]:checked')?.value ?? "pvp";
          const first = $('input[name="first"]:checked')?.value ?? "X";
          const aiDiscipline = ui.aiDiscipline.value ?? "perfect";

          state.settings.theme = theme;
          state.settings.glyphs = glyphs;
          state.settings.mode = mode;
          state.settings.first = first;
          state.settings.aiDiscipline = aiDiscipline;
          save();
        }

        function wireDialog() {
          ui.customizeBtn.addEventListener("click", openDialog);
          ui.closeDialogBtn.addEventListener("click", closeDialog);
          ui.cancelDialogBtn.addEventListener("click", () => {
            closeDialog();
            safeSetBanner("Edict", "No changes made.", { autoHideMs: 1400 });
          });
          ui.applyDialogBtn.addEventListener("click", () => {
            readDialogToState();
            closeDialog();
            safeSetBanner("Edict", "Customizations applied.", { autoHideMs: 1600 });
            startNewRound({ announceIt: false });
          });

          $$('input[name="mode"]').forEach((el) =>
            el.addEventListener("change", () => {
              const mode = $('input[name="mode"]:checked')?.value ?? "pvp";
              ui.aiDiscipline.disabled = mode !== "ai";
            }),
          );

          ui.dialog.addEventListener("cancel", (e) => {
            e.preventDefault();
            closeDialog();
          });
        }

        // ---- Buttons ----
        function wireButtons() {
          ui.newRoundBtn.addEventListener("click", () => startNewRound());
          ui.resetScoresBtn.addEventListener("click", () => resetScores());
        }

        // ---- Confetti (canvas) ----
        let confettiRun = null;
        let confettiParticles = [];
        let confettiStart = 0;

        function resizeCanvas() {
          const c = ui.confetti;
          const dpr = Math.min(window.devicePixelRatio || 1, 2);
          const w = Math.floor(window.innerWidth * dpr);
          const h = Math.floor(window.innerHeight * dpr);
          if (c.width !== w || c.height !== h) {
            c.width = w;
            c.height = h;
          }
          c.style.width = "100%";
          c.style.height = "100%";
          return { dpr, w, h };
        }

        function stopConfetti() {
          if (confettiRun) cancelAnimationFrame(confettiRun);
          confettiRun = null;
          confettiParticles = [];
          const ctx = ui.confetti.getContext("2d");
          ctx?.clearRect(0, 0, ui.confetti.width, ui.confetti.height);
        }

        function startConfetti() {
          if (prefersReducedMotion) return;
          stopConfetti();
          const ctx = ui.confetti.getContext("2d");
          if (!ctx) return;

          const { w, h } = resizeCanvas();
          const max = Math.min(160, Math.floor((w * h) / 42000));
          const palette =
            document.documentElement.dataset.theme === "night"
              ? ["#f9e07a", "#d3a73a", "#c9d2e3", "#8b1d22", "#ffffff"]
              : ["#f9e07a", "#d3a73a", "#8f6b13", "#8b1d22", "#ffffff"];

          confettiParticles = Array.from({ length: max }, () => {
            const size = rand(6, 12);
            return {
              x: rand(0, w),
              y: rand(-h * 0.2, h * 0.25),
              vx: rand(-0.8, 0.8),
              vy: rand(1.6, 3.6),
              rot: rand(0, Math.PI * 2),
              vr: rand(-0.12, 0.12),
              size,
              hue: palette[(Math.random() * palette.length) | 0],
              flip: rand(0, 1),
              w: size * rand(0.7, 1.2),
              h: size * rand(0.35, 0.8),
            };
          });

          confettiStart = performance.now();
          const duration = 2400;

          const tick = (t) => {
            const age = t - confettiStart;
            const { w, h } = resizeCanvas();
            ctx.clearRect(0, 0, w, h);
            const fade = clamp(1 - age / duration, 0, 1);
            for (const p of confettiParticles) {
              p.x += p.vx * 2;
              p.y += p.vy * 2;
              p.vy += 0.02;
              p.rot += p.vr;
              p.flip += 0.14;
              if (p.y > h + 80) p.y = rand(-120, -20);
              if (p.x < -80) p.x = w + 80;
              if (p.x > w + 80) p.x = -80;

              const s = Math.sin(p.flip);
              const alpha = 0.95 * fade * (0.45 + 0.55 * Math.abs(s));
              ctx.save();
              ctx.translate(p.x, p.y);
              ctx.rotate(p.rot);
              ctx.globalAlpha = alpha;
              ctx.fillStyle = p.hue;
              ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
              ctx.restore();
            }

            if (age < duration) confettiRun = requestAnimationFrame(tick);
            else stopConfetti();
          };
          confettiRun = requestAnimationFrame(tick);
        }

        function rand(a, b) {
          return a + Math.random() * (b - a);
        }

        function clamp(v, a, b) {
          return Math.max(a, Math.min(b, v));
        }

        window.addEventListener("resize", () => {
          resizeCanvas();
        });

        // ---- Init ----
        function init() {
          load();
          buildBoard();
          wireButtons();
          wireDialog();
          setTheme(state.settings.theme);

          // Reasonable defaults if no storage:
          if (!localStorage.getItem(STORAGE_KEY)) {
            state.settings.glyphs = "roman";
            state.settings.theme = "day";
          }

          safeSetBanner("Edict", "New round awaits. Customize the arena if you wish.", { autoHideMs: 2600 });
          startNewRound({ announceIt: false });

          // Ensure correct dialog radio values on first open
          syncDialogFromState();
        }

        init();
      })();
    </script>
  </body>
</html>
