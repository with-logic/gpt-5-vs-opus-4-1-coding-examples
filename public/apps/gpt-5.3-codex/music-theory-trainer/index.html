<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Music Theory Trainer</title>
  <style>
    :root {
      --bg-1: #081c2d;
      --bg-2: #12344f;
      --panel: rgba(9, 28, 44, 0.72);
      --panel-border: rgba(151, 203, 255, 0.22);
      --text: #edf8ff;
      --muted: #a7c9e6;
      --accent: #12d6b5;
      --accent-2: #ffcd57;
      --danger: #ff6b6b;
      --good: #74e49f;
      --shadow: 0 14px 40px rgba(0, 0, 0, 0.32);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Trebuchet MS", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at -10% -20%, #1a6082 0%, transparent 65%),
        radial-gradient(900px 600px at 110% -10%, #2b7aa8 0%, transparent 72%),
        linear-gradient(160deg, var(--bg-1), var(--bg-2));
      min-height: 100vh;
      padding: 24px;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
    }

    body::before {
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.06) 0,
          rgba(255, 255, 255, 0.06) 2px,
          transparent 2px,
          transparent 32px
        );
      opacity: 0.14;
      transform: translateY(-8px);
      animation: drift 12s linear infinite;
    }

    body::after {
      background: radial-gradient(circle at 50% 120%, rgba(255, 224, 130, 0.25), transparent 62%);
      opacity: 0.55;
    }

    @keyframes drift {
      0% { transform: translateY(-8px); }
      100% { transform: translateY(24px); }
    }

    .app {
      max-width: 1180px;
      margin: 0 auto;
      display: grid;
      gap: 18px;
      grid-template-columns: 320px 1fr;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .left {
      padding: 18px;
      align-self: start;
      position: sticky;
      top: 16px;
    }

    h1 {
      margin: 2px 0 6px;
      font-size: 1.8rem;
      letter-spacing: 0.4px;
    }

    .sub {
      margin: 0 0 16px;
      color: var(--muted);
      line-height: 1.35;
      font-size: 0.95rem;
    }

    .section-title {
      font-size: 0.88rem;
      text-transform: uppercase;
      letter-spacing: 1.1px;
      color: #88b8db;
      margin: 18px 0 10px;
      font-weight: 700;
    }

    .btn-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    button,
    select {
      border: 0;
      border-radius: var(--radius-sm);
      background: #1b4f72;
      color: var(--text);
      padding: 10px 12px;
      font-size: 0.93rem;
      transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
      cursor: pointer;
    }

    select {
      width: 100%;
      background: #1b4f72;
      outline: none;
    }

    button:hover,
    select:hover {
      filter: brightness(1.08);
    }

    button:active {
      transform: translateY(1px);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 7px 12px;
      background: rgba(31, 88, 125, 0.55);
      border: 1px solid rgba(138, 198, 239, 0.3);
      margin: 4px 4px 0 0;
      font-size: 0.85rem;
    }

    .chip.active {
      background: rgba(18, 214, 181, 0.2);
      border-color: rgba(18, 214, 181, 0.45);
    }

    .chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .main {
      padding: 18px;
      display: grid;
      gap: 16px;
    }

    .status {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .stat {
      background: rgba(20, 67, 98, 0.62);
      border: 1px solid rgba(143, 203, 245, 0.25);
      border-radius: var(--radius-md);
      padding: 10px 12px;
    }

    .stat label {
      display: block;
      font-size: 0.76rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94c4e5;
    }

    .stat strong {
      display: block;
      margin-top: 4px;
      font-size: 1.12rem;
    }

    .exercise {
      background: rgba(13, 49, 74, 0.58);
      border-radius: var(--radius-md);
      border: 1px solid rgba(145, 201, 239, 0.2);
      padding: 16px;
    }

    .exercise h2 {
      margin: 0 0 6px;
      font-size: 1.18rem;
    }

    .exercise p {
      margin: 0;
      color: var(--muted);
      line-height: 1.4;
      font-size: 0.95rem;
    }

    .choices {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .choices button {
      background: #205f88;
      font-weight: 700;
    }

    .choices button.correct {
      background: #1f7751;
    }

    .choices button.wrong {
      background: #8a3948;
    }

    .feedback {
      margin-top: 10px;
      min-height: 22px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .feedback.good { color: var(--good); }
    .feedback.bad { color: var(--danger); }

    .keyboard-wrap {
      position: relative;
      overflow-x: auto;
      padding: 10px 0 4px;
    }

    .keyboard {
      position: relative;
      min-width: 770px;
      height: 230px;
      user-select: none;
      margin-right: 6px;
    }

    .white-keys {
      display: flex;
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      gap: 2px;
      height: 100%;
    }

    .white-key {
      flex: 1;
      border: 1px solid #5e7d96;
      border-radius: 0 0 8px 8px;
      background: linear-gradient(180deg, #f8fbff 0%, #dce8f2 95%);
      position: relative;
      color: #23465f;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 10px;
      font-size: 0.79rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.08s ease, transform 0.08s ease;
    }

    .white-key.active {
      background: linear-gradient(180deg, #fffec2 0%, #f4dc7d 100%);
      transform: translateY(2px);
    }

    .white-key.marked {
      box-shadow: inset 0 0 0 3px rgba(18, 214, 181, 0.36);
    }

    .black-key {
      position: absolute;
      width: calc((100% / 14) * 0.63);
      height: 62%;
      top: 0;
      background: linear-gradient(180deg, #1c232c 0%, #0d1116 100%);
      border: 1px solid #526678;
      border-radius: 0 0 6px 6px;
      color: #d8efff;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 9px;
      font-size: 0.72rem;
      font-weight: 700;
      cursor: pointer;
      z-index: 2;
      transition: background 0.08s ease, transform 0.08s ease;
    }

    .black-key.active {
      background: linear-gradient(180deg, #4d5865 0%, #242d36 100%);
      transform: translateY(1px);
    }

    .black-key.marked {
      box-shadow: inset 0 0 0 2px rgba(255, 205, 87, 0.8);
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
      color: var(--muted);
      font-size: 0.86rem;
    }

    .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      transform: translateY(1px);
    }

    .dot.scale { background: var(--accent); }
    .dot.chord { background: var(--accent-2); }

    .footer {
      color: #9fcae7;
      opacity: 0.9;
      font-size: 0.84rem;
      margin-top: 6px;
    }

    .small {
      font-size: 0.84rem;
      color: var(--muted);
    }

    .stack {
      display: grid;
      gap: 8px;
    }

    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
      .left { position: static; }
      .choices { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .status { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="left panel">
      <h1>Music Theory Trainer</h1>
      <p class="sub">Learn notes, scales, and chords with a playful piano and ear training challenges.</p>

      <div class="section-title">Mode</div>
      <div class="btn-grid" id="modeButtons">
        <button data-mode="notes">Notes</button>
        <button data-mode="scales">Scales</button>
        <button data-mode="chords">Chords</button>
        <button data-mode="ear">Ear Training</button>
      </div>

      <div class="section-title">Root Note</div>
      <select id="rootSelect"></select>

      <div class="section-title">Scale</div>
      <select id="scaleSelect"></select>

      <div class="section-title">Chord</div>
      <select id="chordSelect"></select>

      <div class="section-title">Current Tones</div>
      <div id="toneChips" class="chip-list"></div>

      <div class="section-title">Controls</div>
      <div class="stack">
        <button id="playPatternBtn">Play Pattern</button>
        <button id="clearMarksBtn">Clear Highlights</button>
      </div>

      <p class="footer">Tip: Use your keyboard. White keys: <strong>A S D F G H J K L ;</strong> Black keys: <strong>W E T Y U O P</strong></p>
    </aside>

    <main class="main panel">
      <div class="status">
        <div class="stat"><label>Mode</label><strong id="modeStat">Notes</strong></div>
        <div class="stat"><label>Score</label><strong id="scoreStat">0</strong></div>
        <div class="stat"><label>Streak</label><strong id="streakStat">0</strong></div>
      </div>

      <section class="exercise" id="exerciseBox">
        <h2>Interactive Piano</h2>
        <p id="exercisePrompt">Click keys to hear notes and see theory highlights. Choose a root and scale/chord, then press Play Pattern.</p>
        <div class="choices" id="choices"></div>
        <div id="feedback" class="feedback"></div>
      </section>

      <section>
        <div class="keyboard-wrap">
          <div class="keyboard" id="keyboard">
            <div class="white-keys" id="whiteKeys"></div>
            <div id="blackKeys"></div>
          </div>
        </div>
        <div class="legend">
          <span><span class="dot scale"></span>Scale tones</span>
          <span><span class="dot chord"></span>Chord tones</span>
        </div>
      </section>

      <div class="small">Ear training modes include note, interval, and chord quality drills. Use "Replay" when needed.</div>
    </main>
  </div>

  <script>
    const NOTES_SHARP = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const SCALE_PATTERNS = {
      "Major": [0, 2, 4, 5, 7, 9, 11],
      "Natural Minor": [0, 2, 3, 5, 7, 8, 10],
      "Dorian": [0, 2, 3, 5, 7, 9, 10],
      "Mixolydian": [0, 2, 4, 5, 7, 9, 10],
      "Pentatonic Major": [0, 2, 4, 7, 9],
      "Pentatonic Minor": [0, 3, 5, 7, 10]
    };
    const CHORD_PATTERNS = {
      "Major": [0, 4, 7],
      "Minor": [0, 3, 7],
      "Diminished": [0, 3, 6],
      "Augmented": [0, 4, 8],
      "Major 7": [0, 4, 7, 11],
      "Minor 7": [0, 3, 7, 10],
      "Dominant 7": [0, 4, 7, 10],
      "Sus4": [0, 5, 7]
    };

    const state = {
      mode: "notes",
      root: "C",
      scale: "Major",
      chord: "Major",
      score: 0,
      streak: 0,
      activeNotes: [],
      exercise: null,
      keyboardMap: {
        "a": 0, "w": 1, "s": 2, "e": 3, "d": 4,
        "f": 5, "t": 6, "g": 7, "y": 8, "h": 9,
        "u": 10, "j": 11, "k": 12, "o": 13, "l": 14,
        "p": 15, ";": 16, "'": 17
      }
    };

    const rootSelect = document.getElementById("rootSelect");
    const scaleSelect = document.getElementById("scaleSelect");
    const chordSelect = document.getElementById("chordSelect");
    const toneChips = document.getElementById("toneChips");
    const whiteKeysEl = document.getElementById("whiteKeys");
    const blackKeysEl = document.getElementById("blackKeys");
    const modeStat = document.getElementById("modeStat");
    const scoreStat = document.getElementById("scoreStat");
    const streakStat = document.getElementById("streakStat");
    const feedback = document.getElementById("feedback");
    const choices = document.getElementById("choices");
    const exercisePrompt = document.getElementById("exercisePrompt");

    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContextClass();

    function midiToFreq(midi) {
      return 440 * Math.pow(2, (midi - 69) / 12);
    }

    function playTone(midi, duration = 0.6, gainVal = 0.2, type = "triangle") {
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.value = midiToFreq(midi);
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(gainVal, now + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now + duration + 0.02);
    }

    function playSequence(midiList, spacing = 0.22) {
      if (audioCtx.state === "suspended") audioCtx.resume();
      const start = audioCtx.currentTime + 0.03;
      midiList.forEach((m, i) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "triangle";
        osc.frequency.value = midiToFreq(m);
        const t = start + i * spacing;
        gain.gain.setValueAtTime(0.0001, t);
        gain.gain.exponentialRampToValueAtTime(0.18, t + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.2);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(t);
        osc.stop(t + 0.23);
      });
    }

    function optionElements(selectEl, arr) {
      arr.forEach((item) => {
        const o = document.createElement("option");
        o.value = item;
        o.textContent = item;
        selectEl.appendChild(o);
      });
    }

    optionElements(rootSelect, NOTES_SHARP);
    optionElements(scaleSelect, Object.keys(SCALE_PATTERNS));
    optionElements(chordSelect, Object.keys(CHORD_PATTERNS));

    function buildKeyboard() {
      whiteKeysEl.innerHTML = "";
      blackKeysEl.innerHTML = "";
      const whiteSemitones = [0, 2, 4, 5, 7, 9, 11, 12, 14, 16, 17, 19, 21, 23];
      const blackPositions = [1, 3, 6, 8, 10, 13, 15, 18, 20, 22];
      const baseMidi = 60;

      whiteSemitones.forEach((semi, idx) => {
        const midi = baseMidi + semi;
        const noteName = NOTES_SHARP[midi % 12];
        const key = document.createElement("button");
        key.className = "white-key";
        key.dataset.midi = midi;
        key.dataset.note = noteName;
        key.textContent = noteName;
        key.addEventListener("mousedown", () => hitKey(key));
        whiteKeysEl.appendChild(key);
      });

      blackPositions.forEach((semi) => {
        const midi = baseMidi + semi;
        const noteName = NOTES_SHARP[midi % 12];
        const key = document.createElement("button");
        key.className = "black-key";
        key.dataset.midi = midi;
        key.dataset.note = noteName;

        const whiteIndexBefore = whiteSemitones.filter((w) => w < semi).length - 1;
        const whiteWidthPercent = 100 / whiteSemitones.length;
        key.style.left = `calc(${(whiteIndexBefore + 1) * whiteWidthPercent}% - (${whiteWidthPercent / 2}%))`;

        key.textContent = noteName;
        key.addEventListener("mousedown", () => hitKey(key));
        blackKeysEl.appendChild(key);
      });
    }

    function allKeys() {
      return [...document.querySelectorAll(".white-key"), ...document.querySelectorAll(".black-key")];
    }

    function hitKey(el) {
      if (audioCtx.state === "suspended") audioCtx.resume();
      const midi = Number(el.dataset.midi);
      playTone(midi, 0.5, 0.22, el.classList.contains("black-key") ? "square" : "triangle");
      el.classList.add("active");
      setTimeout(() => el.classList.remove("active"), 120);
      if (state.mode === "ear" && state.exercise && state.exercise.type === "note") {
        checkAnswer(el.dataset.note);
      }
    }

    function semitoneForRoot(root) {
      return NOTES_SHARP.indexOf(root);
    }

    function degreeNotes(pattern, root) {
      const r = semitoneForRoot(root);
      return pattern.map((p) => NOTES_SHARP[(r + p) % 12]);
    }

    function updateToneChips(list = []) {
      toneChips.innerHTML = "";
      list.forEach((n) => {
        const chip = document.createElement("span");
        chip.className = "chip active";
        chip.textContent = n;
        toneChips.appendChild(chip);
      });
      if (!list.length) {
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = "No highlights";
        toneChips.appendChild(chip);
      }
    }

    function clearMarks() {
      allKeys().forEach((k) => k.classList.remove("marked", "active"));
      state.activeNotes = [];
      updateToneChips([]);
    }

    function markNotes(scaleNotes, chordNotes) {
      const keyEls = allKeys();
      keyEls.forEach((k) => {
        const note = k.dataset.note;
        k.classList.remove("marked");
        if (scaleNotes.includes(note) || chordNotes.includes(note)) {
          k.classList.add("marked");
          if (chordNotes.includes(note) && !scaleNotes.includes(note)) {
            k.style.boxShadow = "inset 0 0 0 2px rgba(255, 205, 87, 0.95)";
          } else if (chordNotes.includes(note)) {
            k.style.boxShadow = "inset 0 0 0 2px rgba(255, 205, 87, 0.8)";
          } else {
            k.style.boxShadow = "inset 0 0 0 3px rgba(18, 214, 181, 0.36)";
          }
        } else {
          k.style.boxShadow = "";
        }
      });
      updateToneChips([...new Set([...scaleNotes, ...chordNotes])]);
      state.activeNotes = [...new Set([...scaleNotes, ...chordNotes])];
    }

    function modeTitle(mode) {
      if (mode === "ear") return "Ear Training";
      return mode.charAt(0).toUpperCase() + mode.slice(1);
    }

    function setMode(mode) {
      state.mode = mode;
      modeStat.textContent = modeTitle(mode);
      [...document.querySelectorAll("#modeButtons button")].forEach((b) => {
        b.style.outline = b.dataset.mode === mode ? "2px solid rgba(18,214,181,.6)" : "none";
      });
      feedback.textContent = "";
      feedback.className = "feedback";
      choices.innerHTML = "";

      if (mode === "notes") {
        exercisePrompt.textContent = "Click any key to hear it. Learn note names across octaves. Highlights show your selected scale/chord context.";
      } else if (mode === "scales") {
        exercisePrompt.textContent = "Select root + scale, then press Play Pattern to hear ascending notes. Highlighted keys show the scale degrees.";
      } else if (mode === "chords") {
        exercisePrompt.textContent = "Select root + chord and press Play Pattern. Chord tones are highlighted in gold.";
      } else {
        exercisePrompt.textContent = "Train your ear: identify notes, intervals, and chord quality. Listen first, then answer.";
        startEarRound();
      }
      syncMarks();
    }

    function syncMarks() {
      const scaleNotes = state.mode === "scales" || state.mode === "notes" || state.mode === "ear"
        ? degreeNotes(SCALE_PATTERNS[state.scale], state.root)
        : [];
      const chordNotes = state.mode === "chords" || state.mode === "ear"
        ? degreeNotes(CHORD_PATTERNS[state.chord], state.root)
        : [];
      markNotes(scaleNotes, chordNotes);
    }

    function semitoneName(distance) {
      const map = {
        0: "Unison",
        1: "m2",
        2: "M2",
        3: "m3",
        4: "M3",
        5: "P4",
        7: "P5",
        8: "m6",
        9: "M6",
        10: "m7",
        11: "M7",
        12: "Octave"
      };
      return map[distance] || `${distance} st`;
    }

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function ask(question, options, answer, replayFn) {
      choices.innerHTML = "";
      exercisePrompt.textContent = question;
      feedback.textContent = "";
      feedback.className = "feedback";

      options.forEach((opt) => {
        const b = document.createElement("button");
        b.textContent = opt;
        b.addEventListener("click", () => checkAnswer(opt, b));
        choices.appendChild(b);
      });

      const replay = document.createElement("button");
      replay.textContent = "Replay";
      replay.style.background = "#1e7f75";
      replay.addEventListener("click", replayFn);
      choices.appendChild(replay);

      const next = document.createElement("button");
      next.textContent = "Next";
      next.style.background = "#825e17";
      next.addEventListener("click", startEarRound);
      choices.appendChild(next);

      state.exercise = { answer, type: "quiz" };
    }

    function checkAnswer(value, button) {
      if (!state.exercise) return;
      const correct = value === state.exercise.answer;
      if (correct) {
        state.score += 10;
        state.streak += 1;
        feedback.textContent = "Correct. Great ears.";
        feedback.className = "feedback good";
      } else {
        state.score = Math.max(0, state.score - 2);
        state.streak = 0;
        feedback.textContent = `Not quite. Answer: ${state.exercise.answer}`;
        feedback.className = "feedback bad";
      }
      scoreStat.textContent = String(state.score);
      streakStat.textContent = String(state.streak);

      if (button) {
        [...choices.querySelectorAll("button")].forEach((b) => {
          if (b.textContent === state.exercise.answer) b.classList.add("correct");
          else if (b === button) b.classList.add("wrong");
        });
      }
    }

    function startEarRound() {
      const modeRoll = Math.random();
      const base = 60 + Math.floor(Math.random() * 12);

      if (modeRoll < 0.34) {
        const answer = NOTES_SHARP[base % 12];
        const pool = shuffle([...new Set([answer, ...shuffle(NOTES_SHARP).slice(0, 5)])]).slice(0, 4);
        ask(
          "Identify the note you hear.",
          shuffle(pool),
          answer,
          () => playTone(base, 0.75, 0.23, "triangle")
        );
        playTone(base, 0.75, 0.23, "triangle");
      } else if (modeRoll < 0.67) {
        const intervals = [2, 3, 4, 5, 7, 9, 12];
        const iv = intervals[Math.floor(Math.random() * intervals.length)];
        const answer = semitoneName(iv);
        const intervalChoices = shuffle([answer, "m2", "M3", "P4", "P5", "m7", "Octave"]).slice(0, 4);
        if (!intervalChoices.includes(answer)) intervalChoices[0] = answer;

        ask(
          "Identify the interval between the two notes.",
          shuffle(intervalChoices),
          answer,
          () => playSequence([base, base + iv], 0.45)
        );
        playSequence([base, base + iv], 0.45);
      } else {
        const types = [
          ["Major", [0, 4, 7]],
          ["Minor", [0, 3, 7]],
          ["Diminished", [0, 3, 6]],
          ["Augmented", [0, 4, 8]]
        ];
        const [answer, pattern] = types[Math.floor(Math.random() * types.length)];
        const options = shuffle(["Major", "Minor", "Diminished", "Augmented"]);

        ask(
          "Identify the chord quality.",
          options,
          answer,
          () => {
            const notes = pattern.map((s) => base + s);
            playSequence(notes, 0.04);
          }
        );
        playSequence(pattern.map((s) => base + s), 0.04);
      }
    }

    function patternMidis(kind) {
      const rootMidi = 60 + semitoneForRoot(state.root);
      if (kind === "scale") {
        return SCALE_PATTERNS[state.scale].map((s) => rootMidi + s);
      }
      return CHORD_PATTERNS[state.chord].map((s) => rootMidi + s);
    }

    document.getElementById("playPatternBtn").addEventListener("click", () => {
      if (state.mode === "chords") {
        playSequence(patternMidis("chord"), 0.05);
      } else {
        playSequence(patternMidis("scale"), 0.24);
      }
    });

    document.getElementById("clearMarksBtn").addEventListener("click", clearMarks);

    rootSelect.addEventListener("change", (e) => {
      state.root = e.target.value;
      syncMarks();
    });

    scaleSelect.addEventListener("change", (e) => {
      state.scale = e.target.value;
      syncMarks();
    });

    chordSelect.addEventListener("change", (e) => {
      state.chord = e.target.value;
      syncMarks();
    });

    document.getElementById("modeButtons").addEventListener("click", (e) => {
      if (e.target.tagName !== "BUTTON") return;
      setMode(e.target.dataset.mode);
    });

    document.addEventListener("keydown", (e) => {
      const key = e.key.toLowerCase();
      if (!(key in state.keyboardMap)) return;
      const idx = state.keyboardMap[key];
      const all = allKeys().sort((a, b) => Number(a.dataset.midi) - Number(b.dataset.midi));
      if (idx < all.length) {
        hitKey(all[idx]);
      }
    });

    buildKeyboard();
    rootSelect.value = state.root;
    scaleSelect.value = state.scale;
    chordSelect.value = state.chord;
    setMode("notes");
  </script>
</body>
</html>
