<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Micro Habit Tracker</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap');

    :root {
      --bg: #f6f8fb;
      --surface: #ffffff;
      --ink: #102038;
      --muted: #5f6c82;
      --line: #dce3ef;
      --done: #20b47b;
      --skip: #f5a623;
      --miss: #e8edf6;
      --accent-a: #ff7a59;
      --accent-b: #2e8bff;
      --accent-c: #ffd166;
      --shadow: 0 14px 35px rgba(22, 35, 67, 0.12);
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 400px at -10% -20%, rgba(255, 122, 89, 0.2), transparent 70%),
        radial-gradient(1000px 500px at 120% -10%, rgba(46, 139, 255, 0.18), transparent 70%),
        linear-gradient(180deg, #f7f9fd 0%, #f0f5fd 100%);
      min-height: 100vh;
    }

    .app {
      max-width: 980px;
      margin: 0 auto;
      padding: 18px;
    }

    .hero {
      background: linear-gradient(120deg, #0f2848, #144078 55%, #0f5ea7);
      color: #fff;
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
      padding: 20px;
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .hero::before,
    .hero::after {
      content: "";
      position: absolute;
      border-radius: 999px;
      filter: blur(2px);
      z-index: -1;
    }

    .hero::before {
      width: 220px;
      height: 220px;
      background: rgba(255, 209, 102, 0.26);
      top: -90px;
      right: -30px;
    }

    .hero::after {
      width: 180px;
      height: 180px;
      background: rgba(255, 122, 89, 0.23);
      bottom: -90px;
      left: -40px;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(1.4rem, 4vw, 2rem);
      letter-spacing: 0.2px;
    }

    .hero p {
      margin: 6px 0 0;
      color: rgba(255,255,255,0.88);
      font-size: 0.97rem;
    }

    .hero-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .date-chip {
      background: rgba(255,255,255,0.16);
      border: 1px solid rgba(255,255,255,0.28);
      color: #fff;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 0.88rem;
      font-weight: 600;
      backdrop-filter: blur(3px);
    }

    .stats {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .stat {
      background: rgba(255,255,255,0.13);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 12px;
      padding: 10px;
    }

    .stat strong {
      display: block;
      font-size: 1.25rem;
      line-height: 1.05;
    }

    .stat span {
      font-size: 0.76rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: rgba(255,255,255,0.78);
    }

    .toolbar {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    button,
    .btn {
      border: none;
      border-radius: 11px;
      padding: 10px 14px;
      font: inherit;
      font-size: 0.92rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform .16s ease, box-shadow .16s ease, background .16s ease, opacity .16s ease;
    }

    button:active,
    .btn:active { transform: translateY(1px); }

    .btn-primary {
      color: #fff;
      background: linear-gradient(110deg, var(--accent-a), #ff9866);
      box-shadow: 0 8px 18px rgba(255,122,89,0.35);
    }

    .btn-secondary {
      color: #133056;
      background: #e7eefb;
    }

    .btn-ghost {
      color: #334e72;
      background: #f2f5fb;
      border: 1px solid var(--line);
    }

    .btn-danger {
      background: #ffe8e9;
      color: #9f2e39;
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .hint {
      margin-top: 9px;
      color: #53627a;
      font-size: 0.84rem;
    }

    .habit-list {
      margin-top: 16px;
      display: grid;
      gap: 12px;
    }

    .habit {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 6px 20px rgba(20, 48, 90, 0.07);
      padding: 14px;
    }

    .habit-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .habit-name {
      display: flex;
      align-items: center;
      gap: 9px;
      flex-wrap: wrap;
      min-width: 0;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 1px solid rgba(16,32,56,0.22);
      flex-shrink: 0;
    }

    .habit-title {
      margin: 0;
      font-size: 1.02rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
    }

    .streak-badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: #eef4ff;
      color: #254b7f;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .habit-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tiny {
      padding: 7px 10px;
      font-size: 0.78rem;
      border-radius: 9px;
    }

    .tiny.done {
      color: #fff;
      background: var(--done);
    }

    .tiny.skip {
      color: #5f3a00;
      background: #ffd889;
    }

    .tiny.clear {
      color: #385073;
      background: #edf2fb;
    }

    .chart {
      margin: 10px 0 12px;
      height: 52px;
      display: grid;
      grid-template-columns: repeat(14, minmax(0, 1fr));
      gap: 6px;
      align-items: end;
    }

    .bar {
      border-radius: 5px 5px 3px 3px;
      border: 1px solid rgba(20, 48, 90, 0.08);
      min-height: 8px;
    }

    .bar.done { background: linear-gradient(180deg, #39ca95, #1aa86f); }
    .bar.skip { background: linear-gradient(180deg, #ffcc6a, #f5a623); }
    .bar.miss { background: #edf1f8; }

    .history {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 6px;
    }

    .day-cell {
      border: 1px solid var(--line);
      border-radius: 10px;
      min-height: 58px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 5px;
      background: #fbfdff;
      padding: 5px 3px;
      cursor: pointer;
      user-select: none;
      transition: transform .12s ease, border-color .12s ease;
    }

    .day-cell:hover { transform: translateY(-1px); border-color: #b9c9e2; }

    .day-cell .label {
      font-size: 0.66rem;
      color: #61718b;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .day-cell .mark {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      font-size: 0.84rem;
      display: grid;
      place-items: center;
      font-weight: 700;
      border: 1px solid transparent;
    }

    .day-cell.done .mark {
      background: #dbf7ec;
      color: #137a53;
      border-color: #8bd9b8;
    }

    .day-cell.skip .mark {
      background: #ffecc0;
      color: #8a5900;
      border-color: #f2c66f;
    }

    .day-cell.miss .mark {
      background: #eef2f8;
      color: #8090a8;
      border-color: #d7dfec;
    }

    .empty {
      background: #ffffff;
      border: 2px dashed #c9d5e8;
      color: #4b5f7f;
      padding: 24px;
      text-align: center;
      border-radius: var(--radius);
    }

    .legend {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      color: #5a6a84;
      font-size: 0.83rem;
    }

    .pill {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 9px;
      display: inline-flex;
      align-items: center;
      gap: 7px;
    }

    .pill i {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(8, 18, 33, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 20;
    }

    .modal.open { display: flex; }

    .modal-card {
      width: min(520px, 100%);
      background: #fff;
      border-radius: 16px;
      border: 1px solid #d2dbea;
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .modal-card h2 {
      margin: 0 0 10px;
      font-size: 1.1rem;
    }

    .field {
      display: grid;
      gap: 7px;
      margin-bottom: 12px;
    }

    label {
      font-size: 0.83rem;
      color: #405371;
      font-weight: 600;
    }

    input[type="text"], textarea, select {
      width: 100%;
      border: 1px solid #cdd8ea;
      border-radius: 10px;
      padding: 10px;
      font: inherit;
      color: var(--ink);
      background: #fbfdff;
    }

    textarea {
      min-height: 160px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 0.83rem;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 9px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      clip-path: inset(50%);
    }

    @media (max-width: 720px) {
      .stats { grid-template-columns: 1fr; }
      .chart { gap: 4px; height: 48px; }
      .habit-title { max-width: 70vw; }
      .day-cell { min-height: 54px; }
      .toolbar button { flex: 1 1 44%; }
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="hero">
      <div class="hero-top">
        <div>
          <h1>Micro Habit Tracker</h1>
          <p>Small wins, daily rhythm, steady momentum.</p>
        </div>
        <div class="date-chip" id="todayChip"></div>
      </div>
      <div class="stats" id="stats"></div>
    </section>

    <div class="toolbar">
      <button class="btn-primary" id="addHabitBtn">+ Add Habit</button>
      <button class="btn-secondary" id="exportBtn">Export JSON</button>
      <button class="btn-ghost" id="importBtn">Import JSON</button>
      <input type="file" id="fileInput" accept="application/json" class="sr-only" />
    </div>
    <div class="hint" id="limitHint"></div>

    <section class="habit-list" id="habitList"></section>

    <div class="legend">
      <span class="pill"><i style="background:#20b47b"></i>Done</span>
      <span class="pill"><i style="background:#f5a623"></i>Skip</span>
      <span class="pill"><i style="background:#dde5f3"></i>Miss</span>
      <span class="pill">Tip: tap a day to cycle status.</span>
    </div>
  </main>

  <div class="modal" id="habitModal" aria-hidden="true">
    <div class="modal-card">
      <h2 id="habitModalTitle">Add Habit</h2>
      <div class="field">
        <label for="habitNameInput">Habit Name</label>
        <input type="text" id="habitNameInput" maxlength="34" placeholder="e.g., 10-min walk" />
      </div>
      <div class="field">
        <label for="habitColorInput">Accent</label>
        <select id="habitColorInput">
          <option value="#ff7a59">Coral</option>
          <option value="#2e8bff">Blue</option>
          <option value="#20b47b">Mint</option>
          <option value="#f5a623">Amber</option>
          <option value="#8f66ff">Violet</option>
          <option value="#eb4d7e">Rose</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost" id="cancelHabitModal">Cancel</button>
        <button class="btn-primary" id="saveHabitModal">Save</button>
      </div>
    </div>
  </div>

  <div class="modal" id="importModal" aria-hidden="true">
    <div class="modal-card">
      <h2>Import Habit Data (JSON)</h2>
      <div class="field">
        <label for="importTextarea">Paste exported JSON</label>
        <textarea id="importTextarea" placeholder='{"habits": [...]} or {"app":"micro-habit-tracker", "data": {...}}'></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost" id="cancelImportModal">Cancel</button>
        <button class="btn-secondary" id="openFileBtn">Choose File</button>
        <button class="btn-primary" id="confirmImportBtn">Import</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var MAX_HABITS = 7;
      var STORAGE_KEY = "microHabitTracker.v1";
      var state = loadState();
      var editHabitId = null;

      var todayChip = document.getElementById("todayChip");
      var statsEl = document.getElementById("stats");
      var habitListEl = document.getElementById("habitList");
      var limitHint = document.getElementById("limitHint");
      var addHabitBtn = document.getElementById("addHabitBtn");
      var exportBtn = document.getElementById("exportBtn");
      var importBtn = document.getElementById("importBtn");
      var fileInput = document.getElementById("fileInput");

      var habitModal = document.getElementById("habitModal");
      var habitModalTitle = document.getElementById("habitModalTitle");
      var habitNameInput = document.getElementById("habitNameInput");
      var habitColorInput = document.getElementById("habitColorInput");
      var saveHabitModalBtn = document.getElementById("saveHabitModal");
      var cancelHabitModalBtn = document.getElementById("cancelHabitModal");

      var importModal = document.getElementById("importModal");
      var importTextarea = document.getElementById("importTextarea");
      var cancelImportModalBtn = document.getElementById("cancelImportModal");
      var confirmImportBtn = document.getElementById("confirmImportBtn");
      var openFileBtn = document.getElementById("openFileBtn");

      function isoDate(date) {
        var y = date.getFullYear();
        var m = String(date.getMonth() + 1).padStart(2, "0");
        var d = String(date.getDate()).padStart(2, "0");
        return y + "-" + m + "-" + d;
      }

      function parseISO(iso) {
        var p = iso.split("-").map(Number);
        return new Date(p[0], p[1] - 1, p[2]);
      }

      function addDays(date, delta) {
        var d = new Date(date);
        d.setDate(d.getDate() + delta);
        return d;
      }

      function daysBack(count) {
        var arr = [];
        var today = new Date();
        for (var i = count - 1; i >= 0; i--) {
          arr.push(isoDate(addDays(today, -i)));
        }
        return arr;
      }

      function shortDay(iso) {
        return ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][parseISO(iso).getDay()];
      }

      function shortDate(iso) {
        var d = parseISO(iso);
        return (d.getMonth() + 1) + "/" + d.getDate();
      }

      function escapeHTML(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function uniqueId() {
        return "h_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
      }

      function demoState() {
        var today = new Date();
        var d0 = isoDate(addDays(today, -4));
        var d1 = isoDate(addDays(today, -3));
        var d2 = isoDate(addDays(today, -2));
        var d3 = isoDate(addDays(today, -1));
        var d4 = isoDate(today);

        return {
          habits: [
            {
              id: uniqueId(),
              name: "Hydrate before coffee",
              color: "#2e8bff",
              entries: (function () { var o = {}; o[d0] = "done"; o[d1] = "done"; o[d2] = "skip"; o[d3] = "done"; o[d4] = "done"; return o; })()
            },
            {
              id: uniqueId(),
              name: "10-minute walk",
              color: "#20b47b",
              entries: (function () { var o = {}; o[d0] = "done"; o[d1] = "miss"; o[d2] = "done"; o[d3] = "done"; o[d4] = "skip"; return o; })()
            },
            {
              id: uniqueId(),
              name: "Read 5 pages",
              color: "#ff7a59",
              entries: (function () { var o = {}; o[d0] = "skip"; o[d1] = "done"; o[d2] = "done"; o[d3] = "done"; o[d4] = "done"; return o; })()
            }
          ]
        };
      }

      function normalizeState(raw) {
        var habits = Array.isArray(raw && raw.habits) ? raw.habits.slice(0, MAX_HABITS) : [];
        habits = habits
          .map(function (h) {
            if (!h || typeof h !== "object") return null;
            var name = String(h.name || "").trim();
            if (!name) return null;
            var cleanEntries = {};
            if (h.entries && typeof h.entries === "object") {
              Object.keys(h.entries).forEach(function (k) {
                var v = h.entries[k];
                if (/^\d{4}-\d{2}-\d{2}$/.test(k) && (v === "done" || v === "skip" || v === "miss")) {
                  cleanEntries[k] = v;
                }
              });
            }
            return {
              id: String(h.id || uniqueId()),
              name: name.slice(0, 34),
              color: /^#[0-9a-fA-F]{6}$/.test(String(h.color || "")) ? h.color : "#2e8bff",
              entries: cleanEntries
            };
          })
          .filter(Boolean);

        return { habits: habits };
      }

      function loadState() {
        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return demoState();
          var parsed = JSON.parse(raw);
          var root = parsed && parsed.app === "micro-habit-tracker" ? parsed.data : parsed;
          var normalized = normalizeState(root || {});
          return normalized.habits.length ? normalized : demoState();
        } catch (_err) {
          return demoState();
        }
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ app: "micro-habit-tracker", data: state }));
      }

      function currentStatus(habit, dateIso) {
        return habit.entries[dateIso] || "miss";
      }

      function setStatus(habitId, dateIso, status) {
        var habit = state.habits.find(function (h) { return h.id === habitId; });
        if (!habit) return;
        if (status === "miss") {
          habit.entries[dateIso] = "miss";
        } else {
          habit.entries[dateIso] = status;
        }
        saveState();
        render();
      }

      function cycleStatus(habitId, dateIso) {
        var habit = state.habits.find(function (h) { return h.id === habitId; });
        if (!habit) return;
        var now = currentStatus(habit, dateIso);
        var next = now === "miss" ? "done" : now === "done" ? "skip" : "miss";
        setStatus(habitId, dateIso, next);
      }

      function streak(habit) {
        var count = 0;
        var day = new Date();
        for (var i = 0; i < 3650; i++) {
          var status = currentStatus(habit, isoDate(day));
          if (status === "done" || status === "skip") {
            count += 1;
            day = addDays(day, -1);
            continue;
          }
          break;
        }
        return count;
      }

      function totals() {
        var today = isoDate(new Date());
        var doneToday = 0;
        var skippedToday = 0;
        var longest = 0;
        state.habits.forEach(function (h) {
          var s = currentStatus(h, today);
          if (s === "done") doneToday += 1;
          if (s === "skip") skippedToday += 1;
          longest = Math.max(longest, streak(h));
        });
        return {
          habits: state.habits.length,
          doneToday: doneToday,
          skippedToday: skippedToday,
          longest: longest
        };
      }

      function openModal(modal) {
        modal.classList.add("open");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeModal(modal) {
        modal.classList.remove("open");
        modal.setAttribute("aria-hidden", "true");
      }

      function renderStats() {
        var t = totals();
        statsEl.innerHTML = ""
          + '<div class="stat"><strong>' + t.habits + '</strong><span>Active Habits</span></div>'
          + '<div class="stat"><strong>' + t.doneToday + '</strong><span>Done Today</span></div>'
          + '<div class="stat"><strong>' + t.longest + 'd</strong><span>Best Live Streak</span></div>';
      }

      function renderHabits() {
        if (!state.habits.length) {
          habitListEl.innerHTML = '<div class="empty">Start with one tiny daily action. Add your first habit to begin the streak.</div>';
          return;
        }

        var week = daysBack(7);
        var bars = daysBack(14);

        habitListEl.innerHTML = state.habits.map(function (habit) {
          var st = streak(habit);
          var chart = bars.map(function (d) {
            var s = currentStatus(habit, d);
            var height = s === "done" ? 100 : s === "skip" ? 65 : 30;
            return '<div class="bar ' + s + '" title="' + shortDate(d) + ': ' + s + '" style="height:' + height + '%"></div>';
          }).join("");

          var history = week.map(function (d) {
            var s = currentStatus(habit, d);
            var mark = s === "done" ? "✓" : s === "skip" ? "⤼" : "·";
            return ''
              + '<button class="day-cell ' + s + '" data-action="cycle" data-id="' + habit.id + '" data-date="' + d + '" title="' + shortDate(d) + ': ' + s + '">'
              + '<span class="label">' + shortDay(d) + '</span>'
              + '<span class="mark">' + mark + '</span>'
              + '</button>';
          }).join("");

          return ''
            + '<article class="habit">'
            + '  <div class="habit-head">'
            + '    <div class="habit-name">'
            + '      <i class="dot" style="background:' + habit.color + '"></i>'
            + '      <h3 class="habit-title">' + escapeHTML(habit.name) + '</h3>'
            + '      <span class="streak-badge">' + st + '-day streak</span>'
            + '    </div>'
            + '    <div class="habit-actions">'
            + '      <button class="tiny done" data-action="todayDone" data-id="' + habit.id + '">Done Today</button>'
            + '      <button class="tiny skip" data-action="todaySkip" data-id="' + habit.id + '">Skip Day</button>'
            + '      <button class="tiny clear" data-action="todayClear" data-id="' + habit.id + '">Clear</button>'
            + '      <button class="tiny" data-action="edit" data-id="' + habit.id + '">Edit</button>'
            + '      <button class="tiny btn-danger" data-action="delete" data-id="' + habit.id + '">Delete</button>'
            + '    </div>'
            + '  </div>'
            + '  <div class="chart" aria-hidden="true">' + chart + '</div>'
            + '  <div class="history">' + history + '</div>'
            + '</article>';
        }).join("");
      }

      function renderHeader() {
        var now = new Date();
        todayChip.textContent = now.toLocaleDateString(undefined, {
          weekday: "short",
          month: "short",
          day: "numeric"
        });
      }

      function renderLimitHint() {
        var left = MAX_HABITS - state.habits.length;
        if (left > 0) {
          limitHint.textContent = left + " habit slot" + (left > 1 ? "s" : "") + " remaining (max 7).";
        } else {
          limitHint.textContent = "Habit limit reached. Delete one to add another.";
        }
        addHabitBtn.disabled = left <= 0;
      }

      function render() {
        renderHeader();
        renderStats();
        renderHabits();
        renderLimitHint();
      }

      function openHabitEditor(mode, habit) {
        editHabitId = mode === "edit" && habit ? habit.id : null;
        habitModalTitle.textContent = mode === "edit" ? "Edit Habit" : "Add Habit";
        habitNameInput.value = habit ? habit.name : "";
        habitColorInput.value = habit ? habit.color : "#ff7a59";
        openModal(habitModal);
        setTimeout(function () { habitNameInput.focus(); }, 20);
      }

      function saveHabitEditor() {
        var name = habitNameInput.value.trim();
        var color = habitColorInput.value;

        if (!name) {
          alert("Please enter a habit name.");
          habitNameInput.focus();
          return;
        }

        if (editHabitId) {
          var existing = state.habits.find(function (h) { return h.id === editHabitId; });
          if (existing) {
            existing.name = name.slice(0, 34);
            existing.color = color;
          }
        } else {
          if (state.habits.length >= MAX_HABITS) {
            alert("You can track up to 7 habits.");
            return;
          }
          state.habits.push({ id: uniqueId(), name: name.slice(0, 34), color: color, entries: {} });
        }

        saveState();
        closeModal(habitModal);
        render();
      }

      function onHabitListClick(e) {
        var el = e.target.closest("[data-action]");
        if (!el) return;

        var action = el.getAttribute("data-action");
        var habitId = el.getAttribute("data-id");
        var dateIso = el.getAttribute("data-date");
        var today = isoDate(new Date());
        var habit = state.habits.find(function (h) { return h.id === habitId; });
        if (!habit) return;

        if (action === "cycle" && dateIso) {
          cycleStatus(habitId, dateIso);
        } else if (action === "todayDone") {
          setStatus(habitId, today, "done");
        } else if (action === "todaySkip") {
          setStatus(habitId, today, "skip");
        } else if (action === "todayClear") {
          setStatus(habitId, today, "miss");
        } else if (action === "delete") {
          var ok = confirm('Delete habit "' + habit.name + '"?');
          if (!ok) return;
          state.habits = state.habits.filter(function (h) { return h.id !== habitId; });
          saveState();
          render();
        } else if (action === "edit") {
          openHabitEditor("edit", habit);
        }
      }

      function exportJSON() {
        var payload = {
          app: "micro-habit-tracker",
          version: 1,
          exportedAt: new Date().toISOString(),
          data: state
        };
        var json = JSON.stringify(payload, null, 2);
        var blob = new Blob([json], { type: "application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = "micro-habit-tracker-export.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function importFromText(text) {
        try {
          var parsed = JSON.parse(text);
          var root = parsed && parsed.app === "micro-habit-tracker" ? parsed.data : parsed;
          var normalized = normalizeState(root || {});
          if (!normalized.habits.length) {
            alert("Imported JSON is valid but contains no habits.");
            return;
          }
          state = normalized;
          saveState();
          render();
          closeModal(importModal);
          importTextarea.value = "";
        } catch (_err) {
          alert("Import failed. Please use a valid JSON export.");
        }
      }

      addHabitBtn.addEventListener("click", function () {
        openHabitEditor("add");
      });
      saveHabitModalBtn.addEventListener("click", saveHabitEditor);
      cancelHabitModalBtn.addEventListener("click", function () { closeModal(habitModal); });

      exportBtn.addEventListener("click", exportJSON);
      importBtn.addEventListener("click", function () { openModal(importModal); });
      cancelImportModalBtn.addEventListener("click", function () { closeModal(importModal); });
      confirmImportBtn.addEventListener("click", function () {
        var text = importTextarea.value.trim();
        if (!text) {
          alert("Paste JSON first or choose a file.");
          return;
        }
        importFromText(text);
      });

      openFileBtn.addEventListener("click", function () { fileInput.click(); });
      fileInput.addEventListener("change", function (ev) {
        var file = ev.target.files && ev.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function () {
          importTextarea.value = String(reader.result || "");
        };
        reader.readAsText(file);
      });

      habitListEl.addEventListener("click", onHabitListClick);

      [habitModal, importModal].forEach(function (modal) {
        modal.addEventListener("click", function (e) {
          if (e.target === modal) closeModal(modal);
        });
      });

      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeModal(habitModal);
          closeModal(importModal);
        }
      });

      render();
    })();
  </script>
</body>
</html>
