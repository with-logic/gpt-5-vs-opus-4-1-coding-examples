<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Journey Flow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Instrument+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f4f8f5;
      --panel: #ffffff;
      --panel-2: #eef3ef;
      --ink: #122019;
      --muted: #5b6f63;
      --line: #b9c8be;
      --accent: #1f9a63;
      --accent-2: #157147;
      --warm: #f2aa63;
      --danger: #b83a2f;
      --shadow: 0 14px 34px rgba(24, 52, 38, 0.12);
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: "Instrument Sans", "Segoe UI", sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at 8% 6%, #ffffff 0%, #f4f8f5 42%, #e6eee7 100%);
      overflow: hidden;
    }

    body {
      display: flex;
      align-items: stretch;
      justify-content: stretch;
    }

    .app {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 12px;
      padding: 16px;
    }

    .toolbar {
      background: linear-gradient(140deg, #ffffff 0%, #f5faf7 100%);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 12px 14px;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .headline {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 220px;
    }

    .headline h1 {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      letter-spacing: -0.02em;
      font-size: clamp(1.1rem, 2.1vw, 1.55rem);
      line-height: 1.1;
      font-weight: 700;
    }

    .headline p {
      margin: 0;
      color: var(--muted);
      font-size: 0.88rem;
    }

    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    button {
      border: 1px solid transparent;
      border-radius: 999px;
      padding: 8px 13px;
      font: 500 0.86rem "Space Grotesk", sans-serif;
      cursor: pointer;
      transition: 120ms ease;
      color: #10361f;
      background: #ebf5ef;
    }

    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(31, 154, 99, 0.25);
    }

    .btn-primary:hover { background: var(--accent-2); }

    .btn-soft {
      border-color: #cfddd3;
      background: #fff;
      color: #2a4b39;
    }

    .btn-warn {
      border-color: #efc39f;
      background: #fff6ef;
      color: #75411a;
    }

    .btn-danger {
      border-color: #efb5ae;
      background: #fff3f2;
      color: var(--danger);
    }

    .stage-count {
      font: 500 0.8rem "Space Grotesk", sans-serif;
      color: var(--muted);
      background: #eef4f0;
      border-radius: 999px;
      padding: 6px 11px;
      border: 1px solid #d4dfd8;
    }

    .board-wrap {
      position: relative;
      min-height: 0;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--line);
      background:
        linear-gradient(90deg, rgba(50, 90, 69, 0.06) 1px, transparent 1px),
        linear-gradient(0deg, rgba(50, 90, 69, 0.06) 1px, transparent 1px),
        radial-gradient(circle at 25% -10%, #fafffc 0%, #f1f8f3 50%, #e7f0e9 100%);
      background-size: 32px 32px, 32px 32px, auto;
      box-shadow: var(--shadow);
    }

    .board {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      touch-action: none;
    }

    #connections {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: visible;
    }

    .connection {
      fill: none;
      stroke: #5d806a;
      stroke-width: 2.3;
      opacity: 0.94;
      pointer-events: auto;
      cursor: pointer;
      transition: 120ms ease;
    }

    .connection:hover {
      stroke-width: 3.1;
      stroke: #2f6746;
    }

    .connection.selected {
      stroke: #dc6f2f;
      stroke-width: 3.4;
      filter: drop-shadow(0 0 4px rgba(220, 111, 47, 0.4));
    }

    .ghost-line {
      fill: none;
      stroke: #1f9a63;
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke-dasharray: 6 6;
      pointer-events: none;
      opacity: 0.9;
    }

    .stage {
      position: absolute;
      width: 240px;
      min-height: 130px;
      border-radius: 15px;
      background: linear-gradient(165deg, #ffffff 0%, #f4f8f5 100%);
      border: 1px solid #bfd1c4;
      box-shadow: 0 14px 28px rgba(21, 55, 36, 0.14);
      display: grid;
      grid-template-rows: auto 1fr auto;
      user-select: none;
    }

    .stage.dragging {
      box-shadow: 0 14px 35px rgba(22, 72, 44, 0.28);
      border-color: #6db58d;
    }

    .stage-header {
      padding: 9px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #d8e4dd;
      background: linear-gradient(180deg, rgba(229, 243, 233, 0.55), rgba(242, 249, 245, 0));
      cursor: grab;
      border-radius: 15px 15px 0 0;
      min-height: 38px;
    }

    .stage-header:active { cursor: grabbing; }

    .stage-index {
      font: 600 0.71rem "Space Grotesk", sans-serif;
      color: #3f5d4a;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #bdd2c4;
      background: #edf6f0;
      flex: none;
    }

    .title {
      font: 600 0.92rem "Space Grotesk", sans-serif;
      color: #173326;
      border: none;
      outline: none;
      background: transparent;
      width: 100%;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .title[contenteditable="true"]:focus,
    .desc[contenteditable="true"]:focus {
      box-shadow: inset 0 -2px 0 #8ec8a9;
    }

    .desc {
      margin: 0;
      padding: 10px 12px 8px;
      color: #365746;
      font-size: 0.83rem;
      line-height: 1.37;
      border: none;
      outline: none;
      min-height: 48px;
      user-select: text;
    }

    .stage-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border-top: 1px solid #d8e4dd;
      padding: 7px 10px;
      border-radius: 0 0 15px 15px;
      background: #fbfdfb;
    }

    .dot {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid #4d7f63;
      background: #fff;
      position: relative;
      flex: none;
    }

    .dot::before {
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: inherit;
      background: #8fb6a0;
    }

    .dot.input {
      border-color: #4f7d68;
    }

    .dot.output {
      border-color: #2f8c5c;
      cursor: crosshair;
    }

    .dot.output::before { background: var(--accent); }
    .dot.output:hover { transform: scale(1.08); }

    .chip {
      font: 600 0.66rem "Space Grotesk", sans-serif;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e0d2c0;
      color: #704a22;
      background: #fff6ee;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .hint {
      position: absolute;
      right: 12px;
      bottom: 10px;
      z-index: 20;
      font: 500 0.72rem "Space Grotesk", sans-serif;
      color: #446a55;
      background: rgba(255, 255, 255, 0.88);
      border: 1px solid #cadbce;
      border-radius: 10px;
      padding: 7px 10px;
      backdrop-filter: blur(4px);
      pointer-events: none;
    }

    .empty {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      font: 600 0.9rem "Space Grotesk", sans-serif;
      color: #4f6f5d;
      letter-spacing: 0.02em;
      background: rgba(247, 251, 248, 0.7);
    }

    .empty.show { display: flex; }

    @media (max-width: 860px) {
      .app { padding: 10px; gap: 8px; }
      .toolbar { border-radius: 12px; padding: 10px; }
      .actions { gap: 6px; }
      button { padding: 7px 11px; }
      .stage { width: 215px; }
      .hint { display: none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="toolbar">
      <div class="headline">
        <h1>Customer Journey Flow</h1>
        <p>Visualize each stage from awareness to purchase with editable nodes and drag connections.</p>
      </div>
      <div class="actions">
        <span class="stage-count" id="stageCount">0 stages</span>
        <button id="addStage" class="btn-primary" type="button">Add Stage</button>
        <button id="autoLayout" class="btn-soft" type="button">Auto Layout</button>
        <button id="deleteConnection" class="btn-warn" type="button">Delete Selected Link</button>
        <button id="reset" class="btn-danger" type="button">Reset Flow</button>
      </div>
    </div>

    <div class="board-wrap">
      <div class="board" id="board">
        <svg id="connections" aria-hidden="true">
          <defs>
            <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto" markerUnits="strokeWidth">
              <path d="M0,0 L10,5 L0,10 z" fill="#45775e"></path>
            </marker>
          </defs>
        </svg>
        <div id="empty" class="empty">Add a stage to start mapping the journey.</div>
      </div>
      <div class="hint">Drag cards. Drag from right dot to left dot to connect. Click link to select.</div>
    </div>
  </div>

  <script>
    const board = document.getElementById("board");
    const svg = document.getElementById("connections");
    const emptyState = document.getElementById("empty");
    const stageCountEl = document.getElementById("stageCount");

    const btnAddStage = document.getElementById("addStage");
    const btnDeleteConnection = document.getElementById("deleteConnection");
    const btnAutoLayout = document.getElementById("autoLayout");
    const btnReset = document.getElementById("reset");

    const state = {
      stages: [],
      links: [],
      selectedLinkId: null,
      dragStageId: null,
      dragOffset: { x: 0, y: 0 },
      tempLink: null,
      pointerId: null
    };

    function uid(prefix) {
      return `${prefix}_${Math.random().toString(36).slice(2, 8)}${Date.now().toString(36).slice(-4)}`;
    }

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function boardPointFromEvent(evt) {
      const rect = board.getBoundingClientRect();
      return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
      };
    }

    function createStage(data) {
      const stage = {
        id: data.id || uid("stage"),
        title: data.title || "New Stage",
        desc: data.desc || "Describe customer behavior and signals in this phase.",
        x: data.x || 60,
        y: data.y || 80,
        tag: data.tag || "touchpoint"
      };
      state.stages.push(stage);
      render();
    }

    function updateStage(id, patch) {
      const stage = state.stages.find((s) => s.id === id);
      if (!stage) return;
      Object.assign(stage, patch);
      render();
    }

    function removeInvalidLinks() {
      const ids = new Set(state.stages.map((s) => s.id));
      state.links = state.links.filter((l) => ids.has(l.from) && ids.has(l.to));
      if (state.selectedLinkId && !state.links.some((l) => l.id === state.selectedLinkId)) {
        state.selectedLinkId = null;
      }
    }

    function getStageCenter(id, side) {
      const stageEl = board.querySelector(`.stage[data-id="${id}"]`);
      if (!stageEl) return { x: 0, y: 0 };
      const dot = stageEl.querySelector(`.dot.${side}`);
      if (!dot) return { x: 0, y: 0 };

      const rect = dot.getBoundingClientRect();
      const boardRect = board.getBoundingClientRect();
      return {
        x: rect.left - boardRect.left + rect.width / 2,
        y: rect.top - boardRect.top + rect.height / 2
      };
    }

    function pathD(from, to) {
      const dx = Math.max(60, Math.abs(to.x - from.x) * 0.45);
      const c1x = from.x + dx;
      const c2x = to.x - dx;
      return `M ${from.x} ${from.y} C ${c1x} ${from.y}, ${c2x} ${to.y}, ${to.x} ${to.y}`;
    }

    function drawLinks() {
      const defs = svg.querySelector("defs");
      svg.innerHTML = "";
      svg.appendChild(defs);

      state.links.forEach((link) => {
        const from = getStageCenter(link.from, "output");
        const to = getStageCenter(link.to, "input");
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", pathD(from, to));
        path.setAttribute("class", `connection${link.id === state.selectedLinkId ? " selected" : ""}`);
        path.setAttribute("marker-end", "url(#arrow)");
        path.dataset.id = link.id;
        path.addEventListener("click", (evt) => {
          evt.stopPropagation();
          state.selectedLinkId = link.id;
          drawLinks();
        });
        svg.appendChild(path);
      });

      if (state.tempLink) {
        const gPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        gPath.setAttribute("class", "ghost-line");
        gPath.setAttribute("d", pathD(state.tempLink.from, state.tempLink.to));
        svg.appendChild(gPath);
      }
    }

    function updateStageCount() {
      const count = state.stages.length;
      stageCountEl.textContent = `${count} stage${count === 1 ? "" : "s"}`;
      emptyState.classList.toggle("show", count === 0);
    }

    function createStageElement(stage, index) {
      const el = document.createElement("div");
      el.className = "stage";
      el.dataset.id = stage.id;
      el.style.left = `${stage.x}px`;
      el.style.top = `${stage.y}px`;

      const header = document.createElement("div");
      header.className = "stage-header";

      const stageIndex = document.createElement("span");
      stageIndex.className = "stage-index";
      stageIndex.textContent = `Stage ${index + 1}`;

      const title = document.createElement("div");
      title.className = "title";
      title.contentEditable = "true";
      title.spellcheck = false;
      title.textContent = stage.title;
      title.addEventListener("input", () => {
        stage.title = title.textContent.trim() || "Untitled Stage";
      });
      title.addEventListener("pointerdown", (evt) => evt.stopPropagation());

      const desc = document.createElement("p");
      desc.className = "desc";
      desc.contentEditable = "true";
      desc.spellcheck = false;
      desc.textContent = stage.desc;
      desc.addEventListener("input", () => {
        stage.desc = desc.textContent.trim() || "Add details for this stage.";
      });
      desc.addEventListener("pointerdown", (evt) => evt.stopPropagation());

      const footer = document.createElement("div");
      footer.className = "stage-footer";

      const inputDot = document.createElement("div");
      inputDot.className = "dot input";
      inputDot.title = "Incoming connection";

      const tag = document.createElement("span");
      tag.className = "chip";
      tag.textContent = stage.tag;

      const outputDot = document.createElement("div");
      outputDot.className = "dot output";
      outputDot.title = "Drag to connect";
      outputDot.addEventListener("pointerdown", (evt) => {
        evt.stopPropagation();
        evt.preventDefault();
        startTempLink(evt, stage.id);
      });

      inputDot.addEventListener("pointerup", (evt) => {
        if (!state.tempLink) return;
        evt.preventDefault();
        evt.stopPropagation();
        finalizeTempLink(stage.id);
      });

      header.append(stageIndex, title);
      footer.append(inputDot, tag, outputDot);
      el.append(header, desc, footer);

      header.addEventListener("pointerdown", (evt) => {
        if (evt.button !== 0) return;
        if (evt.target === title || evt.target === desc) return;
        startDragStage(evt, stage.id, el);
      });

      return el;
    }

    function render() {
      const existing = Array.from(board.querySelectorAll(".stage"));
      existing.forEach((n) => n.remove());

      removeInvalidLinks();
      state.stages.forEach((stage, index) => {
        board.appendChild(createStageElement(stage, index));
      });

      updateStageCount();
      drawLinks();
    }

    function startDragStage(evt, stageId, el) {
      const stage = state.stages.find((s) => s.id === stageId);
      if (!stage) return;

      const point = boardPointFromEvent(evt);
      state.dragStageId = stageId;
      state.pointerId = evt.pointerId;
      state.dragOffset.x = point.x - stage.x;
      state.dragOffset.y = point.y - stage.y;
      el.classList.add("dragging");

      const move = (moveEvt) => {
        if (state.dragStageId !== stageId) return;
        const pos = boardPointFromEvent(moveEvt);
        const boardRect = board.getBoundingClientRect();
        const maxX = boardRect.width - 250;
        const maxY = boardRect.height - 150;
        stage.x = clamp(pos.x - state.dragOffset.x, 8, maxX);
        stage.y = clamp(pos.y - state.dragOffset.y, 8, maxY);
        el.style.left = `${stage.x}px`;
        el.style.top = `${stage.y}px`;
        drawLinks();
      };

      const end = () => {
        state.dragStageId = null;
        state.pointerId = null;
        el.classList.remove("dragging");
        window.removeEventListener("pointermove", move);
        window.removeEventListener("pointerup", end);
      };

      window.addEventListener("pointermove", move);
      window.addEventListener("pointerup", end, { once: true });
    }

    function startTempLink(evt, fromStageId) {
      const from = getStageCenter(fromStageId, "output");
      const point = boardPointFromEvent(evt);
      state.tempLink = {
        fromStageId,
        from,
        to: point
      };

      const move = (moveEvt) => {
        if (!state.tempLink) return;
        state.tempLink.to = boardPointFromEvent(moveEvt);
        drawLinks();
      };

      const end = () => {
        state.tempLink = null;
        window.removeEventListener("pointermove", move);
        window.removeEventListener("pointerup", end);
        drawLinks();
      };

      window.addEventListener("pointermove", move);
      window.addEventListener("pointerup", end, { once: true });
      drawLinks();
    }

    function finalizeTempLink(targetStageId) {
      if (!state.tempLink) return;
      const fromStageId = state.tempLink.fromStageId;
      state.tempLink = null;

      if (fromStageId === targetStageId) {
        drawLinks();
        return;
      }

      const duplicate = state.links.some((l) => l.from === fromStageId && l.to === targetStageId);
      if (!duplicate) {
        state.links.push({ id: uid("link"), from: fromStageId, to: targetStageId });
      }
      drawLinks();
    }

    function deleteSelectedLink() {
      if (!state.selectedLinkId) return;
      state.links = state.links.filter((l) => l.id !== state.selectedLinkId);
      state.selectedLinkId = null;
      drawLinks();
    }

    function autoLayout() {
      if (!state.stages.length) return;
      const rect = board.getBoundingClientRect();
      const gap = Math.min(280, Math.max(220, (rect.width - 70) / Math.max(1, state.stages.length)));
      const startX = 30;
      const baseline = clamp(rect.height / 2 - 80, 20, rect.height - 180);

      state.stages.forEach((stage, index) => {
        stage.x = clamp(startX + gap * index, 8, rect.width - 250);
        stage.y = baseline + ((index % 2) * 40 - 20);
      });
      render();
    }

    function loadSample() {
      state.stages = [];
      state.links = [];
      state.selectedLinkId = null;

      const sample = [
        { title: "Awareness", desc: "Prospect first discovers your brand through content, ads, or referrals.", x: 38, y: 120, tag: "discover" },
        { title: "Consideration", desc: "They compare options, browse reviews, and evaluate value propositions.", x: 315, y: 90, tag: "evaluate" },
        { title: "Intent", desc: "Customer signals purchase intent by requesting demos, pricing, or cart actions.", x: 598, y: 140, tag: "engage" },
        { title: "Purchase", desc: "Final commitment is made and onboarding begins with post-sale nurturing.", x: 882, y: 110, tag: "convert" }
      ];

      sample.forEach((item) => createStage(item));
      state.links.push(
        { id: uid("link"), from: state.stages[0].id, to: state.stages[1].id },
        { id: uid("link"), from: state.stages[1].id, to: state.stages[2].id },
        { id: uid("link"), from: state.stages[2].id, to: state.stages[3].id }
      );
      render();
    }

    function addStageAtGoodPosition() {
      const rect = board.getBoundingClientRect();
      const count = state.stages.length;
      const stageW = 240;
      const stageH = 140;
      const x = clamp(40 + (count % 4) * 260, 8, rect.width - stageW - 8);
      const y = clamp(42 + Math.floor(count / 4) * 170, 8, rect.height - stageH - 8);
      createStage({ x, y, title: `Stage ${count + 1}`, desc: "Define this part of the customer journey.", tag: "touchpoint" });
    }

    btnAddStage.addEventListener("click", addStageAtGoodPosition);
    btnDeleteConnection.addEventListener("click", deleteSelectedLink);
    btnAutoLayout.addEventListener("click", autoLayout);
    btnReset.addEventListener("click", loadSample);

    board.addEventListener("click", () => {
      if (state.selectedLinkId) {
        state.selectedLinkId = null;
        drawLinks();
      }
    });

    window.addEventListener("keydown", (evt) => {
      if ((evt.key === "Delete" || evt.key === "Backspace") && state.selectedLinkId) {
        evt.preventDefault();
        deleteSelectedLink();
      }
    });

    window.addEventListener("resize", () => {
      drawLinks();
    });

    loadSample();
  </script>
</body>
</html>
