<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SPQR Tic Tac Toe</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;800&family=Marcellus&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg0: #ece6db;
      --bg1: #d7ccb9;
      --panel: rgba(255, 251, 241, 0.82);
      --panel-border: rgba(88, 67, 34, 0.25);
      --text: #2f2417;
      --muted: #6e5a3e;
      --gold: #b3882d;
      --gold-bright: #d8b65a;
      --accent: #7b5632;
      --x-color: #7b5632;
      --o-color: #2f3f4a;
      --shadow: 0 16px 38px rgba(41, 30, 18, 0.18);
      --board-size: min(84vmin, 94vw, 640px);
      --radius: 18px;
      --anim-fast: 150ms;
      --anim-mid: 240ms;
    }

    [data-theme="night"] {
      --bg0: #10131b;
      --bg1: #242f3a;
      --panel: rgba(22, 27, 36, 0.78);
      --panel-border: rgba(193, 156, 72, 0.35);
      --text: #efe3c4;
      --muted: #b8a883;
      --gold: #c89f43;
      --gold-bright: #f1cb72;
      --accent: #a67f4d;
      --x-color: #d8b18a;
      --o-color: #b8d2e3;
      --shadow: 0 20px 48px rgba(0, 0, 0, 0.38);
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      color: var(--text);
      font-family: "Marcellus", serif;
      background:
        radial-gradient(120% 130% at 12% 10%, rgba(255,255,255,0.32) 0%, transparent 50%),
        radial-gradient(120% 160% at 90% 0%, rgba(183,140,63,0.14) 0%, transparent 55%),
        linear-gradient(140deg, var(--bg0), var(--bg1));
      overflow: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.2;
      background-image:
        repeating-linear-gradient(35deg, rgba(80,56,30,0.05) 0 2px, transparent 2px 20px),
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.45), transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(0,0,0,0.08), transparent 45%);
      mix-blend-mode: multiply;
    }

    .app {
      position: relative;
      display: grid;
      grid-template-rows: auto auto 1fr;
      min-height: 100dvh;
      padding: clamp(10px, 2.2vw, 22px);
      gap: clamp(10px, 1.4vw, 16px);
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadow);
      padding: clamp(8px, 1.6vw, 16px);
      backdrop-filter: blur(4px);
      min-height: 68px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .crest {
      width: clamp(38px, 5.4vw, 52px);
      height: clamp(38px, 5.4vw, 52px);
      border-radius: 50%;
      border: 2px solid var(--gold);
      display: grid;
      place-items: center;
      color: var(--gold);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), rgba(0,0,0,0.06));
      font-family: "Cinzel", serif;
      font-size: clamp(11px, 1.8vw, 14px);
      letter-spacing: 1px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.15);
      flex-shrink: 0;
    }

    .title-wrap {
      display: grid;
      line-height: 1.05;
      min-width: 0;
    }

    .title {
      font-family: "Cinzel", serif;
      font-weight: 800;
      letter-spacing: 0.04em;
      font-size: clamp(15px, 2.2vw, 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .subtitle {
      color: var(--muted);
      font-size: clamp(10px, 1.5vw, 13px);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .actions {
      display: flex;
      gap: clamp(6px, 1vw, 10px);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    button {
      font: inherit;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: transform var(--anim-fast) ease, box-shadow var(--anim-fast) ease, background var(--anim-mid) ease;
    }

    .btn {
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(240,227,203,0.88));
      color: #3a2a17;
      border: 1px solid rgba(140,100,35,0.25);
      padding: 10px 14px;
      font-size: clamp(12px, 1.5vw, 14px);
      box-shadow: 0 8px 20px rgba(50,30,10,0.12);
      white-space: nowrap;
    }

    [data-theme="night"] .btn {
      background: linear-gradient(180deg, rgba(61,72,88,0.95), rgba(36,45,58,0.95));
      color: var(--text);
      border-color: rgba(192,157,80,0.45);
    }

    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(1px) scale(0.99); }
    .btn:focus-visible,
    .cell:focus-visible,
    select:focus-visible,
    input:focus-visible,
    .dialog-actions button:focus-visible {
      outline: 3px solid color-mix(in oklab, var(--gold-bright), white 20%);
      outline-offset: 2px;
    }

    .banner {
      min-height: 42px;
      border-radius: 12px;
      border: 1px solid transparent;
      display: grid;
      place-items: center;
      padding: 8px 12px;
      text-align: center;
      font-size: clamp(14px, 2vw, 18px);
      transition: background var(--anim-mid) ease, color var(--anim-mid) ease, border-color var(--anim-mid) ease;
    }

    .banner.active {
      background: linear-gradient(135deg, rgba(199,157,63,0.2), rgba(255,235,180,0.38));
      border-color: rgba(179,136,45,0.42);
      color: color-mix(in oklab, var(--text), #4d3300 25%);
      box-shadow: 0 10px 26px rgba(125,84,20,0.17);
    }

    .main {
      display: grid;
      align-content: center;
      justify-items: center;
      gap: clamp(10px, 1.8vmin, 18px);
      min-height: 0;
      padding-bottom: 4px;
    }

    .scoreboard {
      display: grid;
      grid-template-columns: repeat(3, minmax(90px, 1fr));
      gap: clamp(8px, 1.2vw, 12px);
      width: min(96vw, 560px);
    }

    .scorecard {
      border: 1px solid var(--panel-border);
      background: var(--panel);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 8px 20px rgba(50,30,10,0.1);
      text-align: center;
    }

    .score-label {
      display: block;
      color: var(--muted);
      font-size: clamp(11px, 1.5vw, 13px);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .score-value {
      display: block;
      font-family: "Cinzel", serif;
      font-size: clamp(21px, 3.4vw, 28px);
      font-weight: 700;
      color: var(--text);
    }

    .board-wrap {
      width: var(--board-size);
      max-width: 100%;
      aspect-ratio: 1;
      border-radius: calc(var(--radius) + 6px);
      border: 1px solid var(--panel-border);
      background: linear-gradient(145deg, color-mix(in oklab, var(--panel), white 14%), color-mix(in oklab, var(--panel), #d6c19d 22%));
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      padding: clamp(8px, 1.2vmin, 12px);
    }

    .board-wrap::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(100% 100% at 0% 0%, rgba(255,255,255,0.35), transparent 55%),
        linear-gradient(160deg, rgba(0,0,0,0.03), transparent 40%);
    }

    .grid {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: clamp(6px, 1.2vmin, 10px);
      width: 100%;
      height: 100%;
    }

    .cell {
      display: grid;
      place-items: center;
      width: 100%;
      height: 100%;
      border-radius: 14px;
      border: 1px solid color-mix(in oklab, var(--panel-border), transparent 30%);
      background: color-mix(in oklab, var(--panel), white 24%);
      box-shadow: inset 0 -8px 16px rgba(0,0,0,0.06), inset 0 2px 8px rgba(255,255,255,0.25);
      font-size: clamp(34px, 11vmin, 88px);
      line-height: 1;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      position: relative;
    }

    [data-theme="night"] .cell {
      background: color-mix(in oklab, var(--panel), #3a4a5b 16%);
      box-shadow: inset 0 -8px 16px rgba(0,0,0,0.25), inset 0 2px 8px rgba(255,255,255,0.06);
    }

    .cell:hover:not([disabled]) {
      transform: translateY(-1px);
      filter: brightness(1.02);
    }

    .cell:active:not([disabled]) { transform: scale(0.98); }

    .cell[disabled] { cursor: default; }

    .cell.mark-x { color: var(--x-color); }
    .cell.mark-o { color: var(--o-color); }

    .cell.win {
      border-color: rgba(201,155,54,0.75);
      background: linear-gradient(180deg, rgba(255,239,193,0.96), rgba(227,198,128,0.82));
      color: #3c2b10;
      text-shadow: 0 1px 0 rgba(255,255,255,0.25);
      animation: pulseWin 1.1s ease-in-out infinite;
    }

    @keyframes pulseWin {
      0%, 100% { box-shadow: inset 0 -8px 16px rgba(0,0,0,0.08), 0 0 0 0 rgba(214,170,82,0.28); }
      50% { box-shadow: inset 0 -8px 16px rgba(0,0,0,0.08), 0 0 0 10px rgba(214,170,82,0); }
    }

    dialog {
      border: 1px solid var(--panel-border);
      border-radius: 18px;
      background: color-mix(in oklab, var(--panel), white 14%);
      color: var(--text);
      width: min(94vw, 560px);
      box-shadow: 0 22px 58px rgba(0,0,0,0.3);
      padding: 0;
    }

    dialog::backdrop {
      background: rgba(14, 10, 7, 0.5);
      backdrop-filter: blur(2px);
    }

    .dialog-inner {
      padding: clamp(16px, 3vw, 22px);
      display: grid;
      gap: 14px;
    }

    .dialog-title {
      margin: 0;
      font-family: "Cinzel", serif;
      letter-spacing: 0.04em;
      font-size: clamp(20px, 3.4vw, 28px);
    }

    .fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
    }

    .field {
      display: grid;
      gap: 7px;
    }

    label {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    select {
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      padding: 10px;
      font: inherit;
      color: var(--text);
      background: color-mix(in oklab, var(--panel), white 30%);
    }

    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 6px;
    }

    .btn-primary {
      background: linear-gradient(180deg, var(--gold-bright), var(--gold));
      color: #1f1407;
      border: 1px solid color-mix(in oklab, var(--gold), black 15%);
      font-weight: 700;
      padding: 10px 16px;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--panel-border);
      color: var(--text);
      padding: 10px 16px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
      white-space: nowrap;
    }

    #confetti {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 20;
    }

    @media (max-width: 760px) {
      .topbar {
        flex-direction: column;
        align-items: stretch;
      }

      .actions {
        justify-content: stretch;
      }

      .actions .btn {
        flex: 1 1 auto;
      }

      .scoreboard {
        width: min(96vw, 540px);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>
<body data-theme="day">
  <canvas id="confetti" aria-hidden="true"></canvas>

  <div class="app">
    <header class="topbar">
      <div class="brand" aria-label="SPQR crest and title">
        <div class="crest" aria-hidden="true">SPQR</div>
        <div class="title-wrap">
          <div class="title">Tic Tac Toe Imperium</div>
          <div class="subtitle">Colosseum Circuit</div>
        </div>
      </div>

      <div class="actions" aria-label="Game controls">
        <button id="newRoundBtn" class="btn" type="button">New Round</button>
        <button id="customizeBtn" class="btn" type="button">Customize</button>
        <button id="resetScoresBtn" class="btn" type="button">Reset Scores</button>
      </div>
    </header>

    <div id="victoryBanner" class="banner" aria-live="polite" aria-atomic="true"></div>

    <main class="main">
      <section class="scoreboard" aria-label="Scoreboard">
        <article class="scorecard"><span class="score-label" id="labelX">X</span><span id="scoreX" class="score-value">0</span></article>
        <article class="scorecard"><span class="score-label" id="labelDraw">Draws</span><span id="scoreD" class="score-value">0</span></article>
        <article class="scorecard"><span class="score-label" id="labelO">O</span><span id="scoreO" class="score-value">0</span></article>
      </section>

      <section class="board-wrap" aria-label="Tic Tac Toe board panel">
        <div id="board" class="grid" role="grid" aria-label="Tic Tac Toe board"></div>
      </section>
    </main>
  </div>

  <p id="liveStatus" class="sr-only" aria-live="polite" aria-atomic="true"></p>

  <dialog id="customizeDialog" aria-labelledby="customizeTitle">
    <form class="dialog-inner" method="dialog">
      <h2 id="customizeTitle" class="dialog-title">Customize Match</h2>
      <div class="fields">
        <div class="field">
          <label for="themeSelect">Theme</label>
          <select id="themeSelect" name="theme">
            <option value="day">Marble Day</option>
            <option value="night">Night Legion</option>
          </select>
        </div>
        <div class="field">
          <label for="glyphSelect">Glyphs</label>
          <select id="glyphSelect" name="glyphs">
            <option value="standard">Standard X/O</option>
            <option value="roman">Gladius / Laurel</option>
          </select>
        </div>
        <div class="field">
          <label for="modeSelect">Mode</label>
          <select id="modeSelect" name="mode">
            <option value="ai">Vs AI</option>
            <option value="pvp">2-player</option>
          </select>
        </div>
        <div class="field">
          <label for="firstMoveSelect">First move</label>
          <select id="firstMoveSelect" name="firstMove">
            <option value="X">X</option>
            <option value="O">O</option>
          </select>
        </div>
        <div class="field">
          <label for="disciplineSelect">AI discipline</label>
          <select id="disciplineSelect" name="discipline">
            <option value="perfect">Perfect</option>
            <option value="pragmatic">Pragmatic</option>
            <option value="reckless">Reckless</option>
          </select>
        </div>
      </div>

      <div class="dialog-actions">
        <button class="btn-ghost" type="button" id="cancelCustomize">Cancel</button>
        <button class="btn-primary" value="default" id="applyCustomize">Apply</button>
      </div>
    </form>
  </dialog>

  <script>
    (() => {
      const winningLines = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8],
        [0, 3, 6], [1, 4, 7], [2, 5, 8],
        [0, 4, 8], [2, 4, 6]
      ];

      const glyphSets = {
        standard: { X: "X", O: "O" },
        roman: { X: "üó°", O: "‚ù¶" }
      };

      const state = {
        board: Array(9).fill(null),
        current: "X",
        firstMove: "X",
        mode: "ai",
        aiDiscipline: "perfect",
        glyphs: "standard",
        theme: "day",
        human: "X",
        ai: "O",
        gameOver: false,
        scores: { X: 0, O: 0, D: 0 },
        winningLine: null
      };

      const els = {
        body: document.body,
        board: document.getElementById("board"),
        liveStatus: document.getElementById("liveStatus"),
        banner: document.getElementById("victoryBanner"),
        scoreX: document.getElementById("scoreX"),
        scoreO: document.getElementById("scoreO"),
        scoreD: document.getElementById("scoreD"),
        labelX: document.getElementById("labelX"),
        labelO: document.getElementById("labelO"),
        newRoundBtn: document.getElementById("newRoundBtn"),
        resetScoresBtn: document.getElementById("resetScoresBtn"),
        customizeBtn: document.getElementById("customizeBtn"),
        dialog: document.getElementById("customizeDialog"),
        themeSelect: document.getElementById("themeSelect"),
        glyphSelect: document.getElementById("glyphSelect"),
        modeSelect: document.getElementById("modeSelect"),
        firstMoveSelect: document.getElementById("firstMoveSelect"),
        disciplineSelect: document.getElementById("disciplineSelect"),
        applyCustomize: document.getElementById("applyCustomize"),
        cancelCustomize: document.getElementById("cancelCustomize"),
        confetti: document.getElementById("confetti")
      };

      const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      const cellButtons = [];

      function createBoard() {
        const frag = document.createDocumentFragment();
        for (let i = 0; i < 9; i += 1) {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "cell";
          button.dataset.index = String(i);
          button.setAttribute("role", "gridcell");
          button.setAttribute("aria-label", `Cell ${i + 1}, empty`);
          button.addEventListener("click", () => handleMove(i));
          button.addEventListener("keydown", handleCellKeyNav);
          cellButtons.push(button);
          frag.appendChild(button);
        }
        els.board.appendChild(frag);
      }

      function handleCellKeyNav(event) {
        const key = event.key;
        const idx = Number(event.currentTarget.dataset.index);
        const row = Math.floor(idx / 3);
        const col = idx % 3;
        let next = idx;

        if (key === "ArrowRight") next = row * 3 + ((col + 1) % 3);
        else if (key === "ArrowLeft") next = row * 3 + ((col + 2) % 3);
        else if (key === "ArrowDown") next = ((row + 1) % 3) * 3 + col;
        else if (key === "ArrowUp") next = ((row + 2) % 3) * 3 + col;
        else if (key === "Enter" || key === " ") {
          event.preventDefault();
          handleMove(idx);
          return;
        } else {
          return;
        }

        event.preventDefault();
        cellButtons[next].focus();
      }

      function getDisplayMark(mark) {
        return glyphSets[state.glyphs][mark] || mark;
      }

      function applyTheme(theme) {
        state.theme = theme;
        els.body.setAttribute("data-theme", theme);
      }

      function refreshScoreLabels() {
        els.labelX.textContent = `X (${getDisplayMark("X")})`;
        els.labelO.textContent = `O (${getDisplayMark("O")})`;
      }

      function renderBoard() {
        for (let i = 0; i < 9; i += 1) {
          const mark = state.board[i];
          const cell = cellButtons[i];
          cell.classList.remove("mark-x", "mark-o", "win");
          if (mark) {
            cell.textContent = getDisplayMark(mark);
            cell.classList.add(mark === "X" ? "mark-x" : "mark-o");
            cell.setAttribute("aria-label", `Cell ${i + 1}, ${mark}`);
          } else {
            cell.textContent = "";
            cell.setAttribute("aria-label", `Cell ${i + 1}, empty`);
          }

          const blockedByAiTurn = state.mode === "ai" && state.current === state.ai && !state.gameOver;
          const disabled = state.gameOver || !!mark || blockedByAiTurn;
          cell.disabled = disabled;
        }

        if (state.winningLine) {
          state.winningLine.forEach((idx) => cellButtons[idx].classList.add("win"));
        }
      }

      function setBanner(text, active = false) {
        els.banner.textContent = text;
        els.banner.classList.toggle("active", active);
      }

      function announce(text) {
        els.liveStatus.textContent = "";
        requestAnimationFrame(() => {
          els.liveStatus.textContent = text;
        });
      }

      function renderScores() {
        els.scoreX.textContent = state.scores.X;
        els.scoreO.textContent = state.scores.O;
        els.scoreD.textContent = state.scores.D;
      }

      function availableMoves(board) {
        const out = [];
        for (let i = 0; i < board.length; i += 1) {
          if (!board[i]) out.push(i);
        }
        return out;
      }

      function checkWinner(board) {
        for (const line of winningLines) {
          const [a, b, c] = line;
          if (board[a] && board[a] === board[b] && board[a] === board[c]) {
            return { winner: board[a], line };
          }
        }
        if (!board.includes(null)) return { winner: "D", line: null };
        return null;
      }

      function evaluateBoard(board) {
        let score = 0;
        for (const [a, b, c] of winningLines) {
          const line = [board[a], board[b], board[c]];
          const oCount = line.filter((m) => m === "O").length;
          const xCount = line.filter((m) => m === "X").length;
          if (oCount && xCount) continue;
          if (oCount) score += oCount === 2 ? 6 : 2;
          if (xCount) score -= xCount === 2 ? 6 : 2;
        }
        return score;
      }

      function minimax(board, depth, isMax, alpha, beta, depthLimit) {
        const result = checkWinner(board);
        if (result) {
          if (result.winner === "O") return 10 - depth;
          if (result.winner === "X") return depth - 10;
          return 0;
        }

        if (depth >= depthLimit) {
          return evaluateBoard(board);
        }

        if (isMax) {
          let best = -Infinity;
          for (const idx of availableMoves(board)) {
            board[idx] = "O";
            const val = minimax(board, depth + 1, false, alpha, beta, depthLimit);
            board[idx] = null;
            best = Math.max(best, val);
            alpha = Math.max(alpha, val);
            if (beta <= alpha) break;
          }
          return best;
        }

        let best = Infinity;
        for (const idx of availableMoves(board)) {
          board[idx] = "X";
          const val = minimax(board, depth + 1, true, alpha, beta, depthLimit);
          board[idx] = null;
          best = Math.min(best, val);
          beta = Math.min(beta, val);
          if (beta <= alpha) break;
        }
        return best;
      }

      function aiPickMove() {
        const moves = availableMoves(state.board);
        if (!moves.length) return null;

        const discipline = state.aiDiscipline;
        let depthLimit = 9;
        let noise = 0;

        if (discipline === "pragmatic") {
          depthLimit = 5;
          noise = 0.22;
        } else if (discipline === "reckless") {
          depthLimit = 2;
          noise = 0.62;
        }

        const scoredMoves = moves.map((idx) => {
          state.board[idx] = "O";
          const score = minimax(state.board, 0, false, -Infinity, Infinity, depthLimit);
          state.board[idx] = null;
          return { idx, score };
        });

        scoredMoves.sort((a, b) => b.score - a.score);

        if (Math.random() < noise) {
          const candidates = discipline === "reckless"
            ? scoredMoves.slice(-Math.max(1, Math.floor(scoredMoves.length * 0.65)))
            : scoredMoves.slice(0, Math.min(3, scoredMoves.length));
          return candidates[Math.floor(Math.random() * candidates.length)].idx;
        }

        const bestScore = scoredMoves[0].score;
        const bestMoves = scoredMoves.filter((m) => m.score === bestScore);
        return bestMoves[Math.floor(Math.random() * bestMoves.length)].idx;
      }

      function endRound(result) {
        state.gameOver = true;
        if (result.winner === "D") {
          state.scores.D += 1;
          setBanner("A Roman stalemate. The Senate records a draw.", true);
          announce("Draw.");
        } else {
          state.scores[result.winner] += 1;
          state.winningLine = result.line;
          const displayWinner = getDisplayMark(result.winner);
          setBanner(`Victory for ${result.winner} ${displayWinner}. Ave!`, true);
          announce(`Player ${result.winner} wins.`);
          fireConfetti();
        }
        renderScores();
        renderBoard();
      }

      function nextTurn() {
        state.current = state.current === "X" ? "O" : "X";
        const display = getDisplayMark(state.current);
        setBanner(`Turn: ${state.current} ${display}`, false);
        announce(`Turn for ${state.current}.`);
        renderBoard();

        if (!state.gameOver && state.mode === "ai" && state.current === state.ai) {
          window.setTimeout(() => {
            if (state.gameOver || state.current !== state.ai) return;
            const move = aiPickMove();
            if (move !== null) handleMove(move, true);
          }, 340);
        }
      }

      function handleMove(index, fromAi = false) {
        if (state.gameOver || state.board[index]) return;
        if (state.mode === "ai" && state.current === state.ai && !fromAi) return;

        state.board[index] = state.current;
        const result = checkWinner(state.board);
        if (result) {
          endRound(result);
          return;
        }
        nextTurn();
      }

      function startRound(announceRound = true) {
        state.board.fill(null);
        state.current = state.firstMove;
        state.gameOver = false;
        state.winningLine = null;
        refreshScoreLabels();
        renderBoard();
        const display = getDisplayMark(state.current);
        setBanner(`Turn: ${state.current} ${display}`, false);
        if (announceRound) announce(`New round. ${state.current} starts.`);

        if (state.mode === "ai" && state.current === state.ai) {
          window.setTimeout(() => {
            if (state.gameOver || state.current !== state.ai) return;
            const move = aiPickMove();
            if (move !== null) handleMove(move, true);
          }, 320);
        }
      }

      function resetScores() {
        state.scores = { X: 0, O: 0, D: 0 };
        renderScores();
        startRound(false);
        announce("Scores reset.");
      }

      function openCustomize() {
        els.themeSelect.value = state.theme;
        els.glyphSelect.value = state.glyphs;
        els.modeSelect.value = state.mode;
        els.firstMoveSelect.value = state.firstMove;
        els.disciplineSelect.value = state.aiDiscipline;
        els.disciplineSelect.disabled = els.modeSelect.value !== "ai";

        if (typeof els.dialog.showModal === "function") {
          els.dialog.showModal();
        }
      }

      function applyCustomize() {
        state.theme = els.themeSelect.value;
        state.glyphs = els.glyphSelect.value;
        state.mode = els.modeSelect.value;
        state.firstMove = els.firstMoveSelect.value;
        state.aiDiscipline = els.disciplineSelect.value;
        applyTheme(state.theme);
        startRound();
      }

      function closeCustomize() {
        if (els.dialog.open) els.dialog.close();
      }

      function setupDialog() {
        els.customizeBtn.addEventListener("click", openCustomize);
        els.cancelCustomize.addEventListener("click", closeCustomize);
        els.applyCustomize.addEventListener("click", (event) => {
          event.preventDefault();
          applyCustomize();
          closeCustomize();
        });
        els.modeSelect.addEventListener("change", () => {
          els.disciplineSelect.disabled = els.modeSelect.value !== "ai";
        });
      }

      function setupControls() {
        els.newRoundBtn.addEventListener("click", () => startRound());
        els.resetScoresBtn.addEventListener("click", resetScores);
      }

      function resizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        els.confetti.width = Math.floor(window.innerWidth * dpr);
        els.confetti.height = Math.floor(window.innerHeight * dpr);
      }

      let confettiFrame = null;
      let particles = [];

      function fireConfetti() {
        if (prefersReducedMotion) return;

        resizeCanvas();
        const ctx = els.confetti.getContext("2d");
        const dpr = window.devicePixelRatio || 1;
        const w = els.confetti.width / dpr;
        const h = els.confetti.height / dpr;

        particles = Array.from({ length: 140 }, () => {
          const angle = Math.random() * Math.PI - (Math.PI / 2);
          const speed = 2 + Math.random() * 4;
          return {
            x: w / 2 + (Math.random() - 0.5) * 80,
            y: h * 0.26 + (Math.random() - 0.5) * 30,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed - 1.5,
            gravity: 0.06 + Math.random() * 0.04,
            drag: 0.992,
            life: 70 + Math.random() * 35,
            size: 4 + Math.random() * 6,
            rot: Math.random() * Math.PI,
            rotVel: (Math.random() - 0.5) * 0.25,
            color: Math.random() > 0.5 ? "#d9b55f" : "#f1e0b3"
          };
        });

        if (confettiFrame) cancelAnimationFrame(confettiFrame);

        const draw = () => {
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
          ctx.clearRect(0, 0, w, h);

          particles.forEach((p) => {
            p.vx *= p.drag;
            p.vy = p.vy * p.drag + p.gravity;
            p.x += p.vx;
            p.y += p.vy;
            p.rot += p.rotVel;
            p.life -= 1;

            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.7);
            ctx.restore();
          });

          particles = particles.filter((p) => p.life > 0 && p.y < h + 20);
          if (particles.length) {
            confettiFrame = requestAnimationFrame(draw);
          } else {
            ctx.clearRect(0, 0, w, h);
            confettiFrame = null;
          }
        };

        draw();
      }

      function init() {
        createBoard();
        setupControls();
        setupDialog();
        applyTheme(state.theme);
        renderScores();
        startRound(false);
        announce("Game ready. New round started.");
        window.addEventListener("resize", resizeCanvas);
      }

      init();
    })();
  </script>
</body>
</html>
