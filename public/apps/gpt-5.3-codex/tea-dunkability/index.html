<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tea Dunkability Simulator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      :root {
        --bg-1: #0b1020;
        --bg-2: #11182e;
        --text: #ecf2ff;
        --muted: #a6b0cb;
        --glass: rgba(255, 255, 255, 0.11);
        --glass-border: rgba(255, 255, 255, 0.2);
        --accent: #7ad7ff;
        --accent-2: #ffbf66;
        --danger: #ff6a6a;
        --ok: #86f0ad;
      }

      body.light {
        --bg-1: #f6f8ff;
        --bg-2: #dce7ff;
        --text: #1a2444;
        --muted: #4c5a82;
        --glass: rgba(255, 255, 255, 0.55);
        --glass-border: rgba(255, 255, 255, 0.65);
        --accent: #006dcf;
        --accent-2: #c57a00;
        --danger: #d83333;
        --ok: #168f49;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
        font-family: "Trebuchet MS", "Avenir Next", "Segoe UI", sans-serif;
        color: var(--text);
        background:
          radial-gradient(900px 500px at 10% -10%, rgba(122, 215, 255, 0.2), transparent),
          radial-gradient(900px 500px at 90% 110%, rgba(255, 191, 102, 0.18), transparent),
          linear-gradient(160deg, var(--bg-1), var(--bg-2));
        transition: background 0.5s ease, color 0.3s ease;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background-image: radial-gradient(rgba(255, 255, 255, 0.08) 0.75px, transparent 0.75px);
        background-size: 24px 24px;
        opacity: 0.45;
        mix-blend-mode: overlay;
      }

      #root {
        width: 100%;
      }

      .app-shell {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 18px;
      }

      .title {
        margin: 0;
        font-size: clamp(1.6rem, 3.5vw, 2.45rem);
        letter-spacing: 0.02em;
      }

      .subtitle {
        margin: 6px 0 0;
        color: var(--muted);
        font-size: 0.96rem;
      }

      .kbd-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: flex-end;
      }

      .keycap {
        padding: 5px 10px;
        border-radius: 10px;
        border: 1px solid var(--glass-border);
        background: var(--glass);
        backdrop-filter: blur(8px);
        font-size: 0.78rem;
        color: var(--text);
      }

      .layout {
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        gap: 18px;
      }

      .card {
        background: var(--glass);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        backdrop-filter: blur(14px);
        box-shadow: 0 16px 36px rgba(0, 0, 0, 0.2);
      }

      .panel {
        padding: 18px;
      }

      .control {
        margin-bottom: 14px;
      }

      .control label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.93rem;
        color: var(--text);
      }

      .value {
        color: var(--accent);
        font-weight: 700;
      }

      input[type="range"] {
        width: 100%;
        -webkit-appearance: none;
        appearance: none;
        height: 8px;
        border-radius: 999px;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        outline: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.9);
        background: #fff;
        cursor: pointer;
      }

      select {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--glass-border);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        padding: 10px;
        font-size: 0.95rem;
      }

      select option {
        color: #111;
      }

      .metrics {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
        margin-top: 16px;
      }

      .metric {
        padding: 12px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      .metric .k {
        color: var(--muted);
        font-size: 0.78rem;
        margin-bottom: 6px;
      }

      .metric .v {
        font-weight: 700;
        font-size: 1.1rem;
      }

      .sim {
        position: relative;
        overflow: hidden;
        min-height: 520px;
      }

      .sim-inner {
        position: relative;
        padding: 18px;
      }

      .cup-wrap {
        position: relative;
        width: 290px;
        margin: 0 auto;
        padding-top: 30px;
        animation: bob 4.2s ease-in-out infinite;
      }

      @keyframes bob {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-8px); }
      }

      .steam {
        position: absolute;
        top: 12px;
        width: 18px;
        height: 65px;
        border-radius: 999px;
        background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0));
        filter: blur(1px);
        opacity: 0.55;
        animation: steam 2.7s linear infinite;
      }

      .steam.s1 { left: 105px; animation-delay: 0s; }
      .steam.s2 { left: 138px; animation-delay: 0.9s; }
      .steam.s3 { left: 168px; animation-delay: 1.6s; }

      @keyframes steam {
        0% { transform: translateY(0) scaleX(1); opacity: 0; }
        20% { opacity: 0.5; }
        70% { opacity: 0.35; }
        100% { transform: translateY(-38px) scaleX(1.3); opacity: 0; }
      }

      .cup {
        position: relative;
        width: 240px;
        height: 150px;
        margin: 0 auto;
        border-radius: 0 0 80px 80px;
        background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(245,247,252,0.76));
        border: 2px solid rgba(255,255,255,0.9);
        box-shadow: 0 15px 24px rgba(0,0,0,0.25);
      }

      .cup::before {
        content: "";
        position: absolute;
        top: -20px;
        left: 10px;
        width: 220px;
        height: 38px;
        border-radius: 50%;
        background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(240, 225, 200, 0.9));
        border: 2px solid rgba(255,255,255,0.9);
      }

      .tea-surface {
        position: absolute;
        top: 6px;
        left: 17px;
        width: 205px;
        height: 26px;
        border-radius: 50%;
        opacity: 0.9;
        background: radial-gradient(circle at 40% 32%, rgba(255,255,255,0.35), transparent 40%), var(--tea-color, #c77d33);
        animation: swirl 3.6s ease-in-out infinite;
      }

      @keyframes swirl {
        0%, 100% { transform: scaleX(1); }
        50% { transform: scaleX(0.96); }
      }

      .handle {
        position: absolute;
        right: -30px;
        top: 46px;
        width: 52px;
        height: 58px;
        border-radius: 50%;
        border: 8px solid rgba(255,255,255,0.92);
      }

      .saucer {
        width: 280px;
        height: 24px;
        margin: -2px auto 0;
        border-radius: 50%;
        background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(220,225,240,0.7));
      }

      .biscuit {
        position: absolute;
        left: 50%;
        top: 84px;
        width: 72px;
        height: 16px;
        border-radius: 8px;
        transform-origin: left center;
        transform: translateX(-50%) rotate(var(--b-rot, -20deg)) translateY(var(--b-depth, -66px));
        background:
          radial-gradient(circle at 16% 50%, rgba(90, 50, 20, 0.22), transparent 24%),
          radial-gradient(circle at 38% 50%, rgba(90, 50, 20, 0.22), transparent 24%),
          radial-gradient(circle at 60% 50%, rgba(90, 50, 20, 0.22), transparent 24%),
          linear-gradient(90deg, #d8a66d, #cb8a4d);
        box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        transition: transform 0.25s ease, filter 0.25s ease;
        z-index: 10;
      }

      .crumb {
        position: absolute;
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: #d7a06a;
        pointer-events: none;
        animation: drop 1.4s ease-out forwards;
      }

      @keyframes drop {
        0% { opacity: 1; transform: translateY(0) scale(1); }
        100% { opacity: 0; transform: translateY(120px) translateX(var(--xdrift, 0px)) scale(0.4); }
      }

      .legend {
        margin-top: 12px;
        color: var(--muted);
        font-size: 0.85rem;
        line-height: 1.45;
      }

      .status {
        margin-top: 16px;
        font-size: 1.04rem;
        font-weight: 700;
      }

      .status.ok { color: var(--ok); }
      .status.warn { color: var(--accent-2); }
      .status.danger { color: var(--danger); }

      .graph-wrap {
        margin-top: 12px;
        border-radius: 14px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.14);
        border: 1px solid rgba(255, 255, 255, 0.16);
      }

      canvas {
        width: 100%;
        height: 160px;
        display: block;
      }

      .footer {
        margin-top: 10px;
        color: var(--muted);
        font-size: 0.82rem;
      }

      @media (max-width: 920px) {
        .layout {
          grid-template-columns: 1fr;
        }

        .sim {
          min-height: 460px;
        }

        .kbd-row {
          justify-content: flex-start;
        }

        .topbar {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState, useEffect, useRef } = React;

      const BISCUITS = {
        Digestive: { absorb: 0.96, strength: 0.88, flavor: 0.74, tea: "#b67a3b" },
        RichTea: { absorb: 1.2, strength: 0.62, flavor: 0.68, tea: "#be7f40" },
        Hobnob: { absorb: 0.78, strength: 1.06, flavor: 0.9, tea: "#b47133" },
        Bourbon: { absorb: 0.86, strength: 0.94, flavor: 0.93, tea: "#9b5527" },
        Shortbread: { absorb: 1.1, strength: 0.58, flavor: 1.02, tea: "#c4853f" },
      };

      function clamp(n, min, max) {
        return Math.max(min, Math.min(max, n));
      }

      function App() {
        const [dark, setDark] = useState(true);
        const [teaTemp, setTeaTemp] = useState(78);
        const [dunkTime, setDunkTime] = useState(4.2);
        const [integrity, setIntegrity] = useState(76);
        const [biscuit, setBiscuit] = useState("Digestive");
        const [crumbs, setCrumbs] = useState([]);
        const [history, setHistory] = useState(Array.from({ length: 22 }, () => 92));

        const canvasRef = useRef(null);

        const model = useMemo(() => {
          const b = BISCUITS[biscuit];
          const tempFactor = teaTemp / 100;
          const soakStress = dunkTime * b.absorb * (0.75 + tempFactor * 0.8);
          const structure = (integrity / 100) * b.strength;
          const crumbleRisk = clamp((soakStress * 18 - structure * 42 + 34), 0, 100);
          const flavorBoost = clamp((dunkTime * 11 + tempFactor * 35) * b.flavor, 0, 100);
          const sweetSpot = 42 - Math.abs(crumbleRisk - 36);
          const dunkability = clamp((100 - crumbleRisk) * 0.55 + flavorBoost * 0.45 + sweetSpot * 0.2, 0, 100);
          return { crumbleRisk, flavorBoost, dunkability, teaColor: b.tea };
        }, [teaTemp, dunkTime, integrity, biscuit]);

        useEffect(() => {
          document.body.classList.toggle("light", !dark);
        }, [dark]);

        useEffect(() => {
          setHistory((prev) => {
            const next = [...prev, model.crumbleRisk].slice(-40);
            return next;
          });
        }, [model.crumbleRisk]);

        useEffect(() => {
          const canvas = canvasRef.current;
          if (!canvas) return;
          const ctx = canvas.getContext("2d");
          const dpr = window.devicePixelRatio || 1;
          const w = canvas.clientWidth;
          const h = canvas.clientHeight;
          canvas.width = Math.floor(w * dpr);
          canvas.height = Math.floor(h * dpr);
          ctx.scale(dpr, dpr);

          ctx.clearRect(0, 0, w, h);

          ctx.strokeStyle = dark ? "rgba(255,255,255,0.15)" : "rgba(0,0,0,0.12)";
          ctx.lineWidth = 1;
          for (let i = 0; i <= 4; i++) {
            const y = (h / 4) * i;
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(w, y);
            ctx.stroke();
          }

          const grad = ctx.createLinearGradient(0, 0, 0, h);
          grad.addColorStop(0, "rgba(255,106,106,0.85)");
          grad.addColorStop(0.5, "rgba(255,191,102,0.85)");
          grad.addColorStop(1, "rgba(122,215,255,0.9)");

          ctx.strokeStyle = grad;
          ctx.lineWidth = 2.5;
          ctx.beginPath();
          history.forEach((v, i) => {
            const x = (i / (history.length - 1 || 1)) * (w - 8) + 4;
            const y = h - (v / 100) * (h - 8) - 4;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          });
          ctx.stroke();

          const last = history[history.length - 1] || 0;
          const lx = w - 4;
          const ly = h - (last / 100) * (h - 8) - 4;
          ctx.fillStyle = "#ffffff";
          ctx.beginPath();
          ctx.arc(lx, ly, 3.5, 0, Math.PI * 2);
          ctx.fill();
        }, [history, dark]);

        useEffect(() => {
          const shouldCrumble = model.crumbleRisk > 72 && dunkTime > 4.8;
          if (!shouldCrumble) return;
          const burst = Array.from({ length: 9 }).map((_, i) => ({
            id: Date.now() + i + Math.random(),
            left: 120 + Math.random() * 70,
            top: 132 + Math.random() * 18,
            drift: (Math.random() - 0.5) * 46,
            delay: Math.random() * 0.25,
          }));
          setCrumbs((c) => [...c, ...burst].slice(-130));
          const t = setTimeout(() => {
            setCrumbs((c) => c.slice(9));
          }, 1500);
          return () => clearTimeout(t);
        }, [model.crumbleRisk, dunkTime]);

        useEffect(() => {
          const onKey = (e) => {
            const tag = (e.target && e.target.tagName) || "";
            if (tag === "INPUT" || tag === "SELECT") return;
            if (e.key.toLowerCase() === "d") setDark((v) => !v);
            if (e.key.toLowerCase() === "r") {
              setTeaTemp(55 + Math.round(Math.random() * 40));
              setDunkTime(Number((1 + Math.random() * 7).toFixed(1)));
              setIntegrity(40 + Math.round(Math.random() * 58));
              const names = Object.keys(BISCUITS);
              setBiscuit(names[Math.floor(Math.random() * names.length)]);
            }
            if (e.key === "ArrowUp") setDunkTime((v) => Number(clamp(v + 0.2, 0.5, 9).toFixed(1)));
            if (e.key === "ArrowDown") setDunkTime((v) => Number(clamp(v - 0.2, 0.5, 9).toFixed(1)));
            if (e.key === "ArrowRight") setTeaTemp((v) => clamp(v + 1, 40, 100));
            if (e.key === "ArrowLeft") setTeaTemp((v) => clamp(v - 1, 40, 100));
          };
          window.addEventListener("keydown", onKey);
          return () => window.removeEventListener("keydown", onKey);
        }, []);

        let status = "Excellent dunk window";
        let statusClass = "ok";
        if (model.crumbleRisk > 45) {
          status = "Risky dunking territory";
          statusClass = "warn";
        }
        if (model.crumbleRisk > 70) {
          status = "Structural failure imminent";
          statusClass = "danger";
        }

        const biscuitDepth = clamp((dunkTime / 9) * 76, 2, 76);
        const biscuitShade = `saturate(${120 - model.crumbleRisk * 0.5}%) brightness(${102 - model.crumbleRisk * 0.35}%)`;

        return (
          <div className="app-shell">
            <div className="topbar">
              <div>
                <h1 className="title">Tea Dunkability Simulator</h1>
                <p className="subtitle">Tune your dunk and save the biscuit before the collapse.</p>
              </div>
              <div className="kbd-row">
                <div className="keycap">D: Dark/Light</div>
                <div className="keycap">R: Randomize</div>
                <div className="keycap">Arrows: Temp & Time</div>
              </div>
            </div>

            <div className="layout">
              <section className="card panel">
                <div className="control">
                  <label>
                    <span>Biscuit Type</span>
                    <span className="value">{biscuit}</span>
                  </label>
                  <select value={biscuit} onChange={(e) => setBiscuit(e.target.value)}>
                    {Object.keys(BISCUITS).map((name) => (
                      <option key={name} value={name}>{name}</option>
                    ))}
                  </select>
                </div>

                <div className="control">
                  <label>
                    <span>Tea Temperature</span>
                    <span className="value">{teaTemp}°C</span>
                  </label>
                  <input type="range" min="40" max="100" value={teaTemp} onChange={(e) => setTeaTemp(Number(e.target.value))} />
                </div>

                <div className="control">
                  <label>
                    <span>Dunk Time</span>
                    <span className="value">{dunkTime.toFixed(1)}s</span>
                  </label>
                  <input type="range" min="0.5" max="9" step="0.1" value={dunkTime} onChange={(e) => setDunkTime(Number(e.target.value))} />
                </div>

                <div className="control">
                  <label>
                    <span>Structural Integrity</span>
                    <span className="value">{integrity}%</span>
                  </label>
                  <input type="range" min="20" max="100" value={integrity} onChange={(e) => setIntegrity(Number(e.target.value))} />
                </div>

                <div className="metrics">
                  <div className="metric">
                    <div className="k">Dunkability</div>
                    <div className="v">{model.dunkability.toFixed(0)}%</div>
                  </div>
                  <div className="metric">
                    <div className="k">Flavor Lift</div>
                    <div className="v">{model.flavorBoost.toFixed(0)}%</div>
                  </div>
                  <div className="metric">
                    <div className="k">Crumble Risk</div>
                    <div className="v">{model.crumbleRisk.toFixed(0)}%</div>
                  </div>
                </div>

                <div className={`status ${statusClass}`}>{status}</div>

                <div className="graph-wrap">
                  <canvas ref={canvasRef} aria-label="Crumble-o-meter graph" />
                </div>
                <div className="legend">Crumble-o-meter tracks live collapse pressure. Keep it below 45% for clean dunk retrieval.</div>
              </section>

              <section className="card sim">
                <div className="sim-inner">
                  <div className="cup-wrap">
                    <div className="steam s1" />
                    <div className="steam s2" />
                    <div className="steam s3" />

                    <div
                      className="biscuit"
                      style={{
                        filter: biscuitShade,
                        "--b-depth": `${-66 + biscuitDepth}px`,
                        "--b-rot": `${-18 - model.crumbleRisk * 0.08}deg`,
                      }}
                    />

                    <div className="cup">
                      <div className="tea-surface" style={{ "--tea-color": model.teaColor }} />
                      <div className="handle" />
                    </div>
                    <div className="saucer" />

                    {crumbs.map((c) => (
                      <span
                        key={c.id}
                        className="crumb"
                        style={{
                          left: `${c.left}px`,
                          top: `${c.top}px`,
                          animationDelay: `${c.delay}s`,
                          "--xdrift": `${c.drift}px`,
                        }}
                      />
                    ))}
                  </div>

                  <div className="footer">
                    Tip: For classic Rich Tea, try ~64°C and 2.6s. Beyond 5s, expect dramatic crumble showers.
                  </div>
                </div>
              </section>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
