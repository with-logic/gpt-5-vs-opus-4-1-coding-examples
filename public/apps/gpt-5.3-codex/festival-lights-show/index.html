<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Festival Lights Show</title>
  <style>
    :root {
      --bg-1: #08182f;
      --bg-2: #1d0f3a;
      --bg-3: #320d2b;
      --panel: rgba(10, 15, 36, 0.72);
      --panel-border: rgba(255, 255, 255, 0.16);
      --text: #f4f8ff;
      --muted: #b9c3da;
      --accent: #ff8a00;
      --glow: #00f0ff;
    }

    * { box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      font-family: "Trebuchet MS", "Segoe UI", sans-serif;
      color: var(--text);
      background: linear-gradient(130deg, var(--bg-1), var(--bg-2), var(--bg-3));
      background-size: 220% 220%;
      animation: bgShift 12s ease infinite;
      overflow: hidden;
    }

    @keyframes bgShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .backdrop {
      position: fixed;
      inset: -20%;
      pointer-events: none;
      background:
        radial-gradient(circle at 20% 20%, rgba(255, 190, 80, 0.25), transparent 35%),
        radial-gradient(circle at 80% 30%, rgba(75, 155, 255, 0.24), transparent 35%),
        radial-gradient(circle at 50% 80%, rgba(255, 70, 180, 0.2), transparent 38%);
      filter: blur(18px) saturate(1.2);
      animation: floatGlow 16s ease-in-out infinite alternate;
      z-index: 0;
    }

    @keyframes floatGlow {
      from { transform: translate(-2%, -1%) scale(1); }
      to { transform: translate(2%, 2%) scale(1.06); }
    }

    .app {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: minmax(300px, 340px) 1fr;
      gap: 1rem;
      width: min(1200px, 96vw);
      height: min(92vh, 860px);
      margin: 2.5vh auto;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      backdrop-filter: blur(12px) saturate(1.1);
      border-radius: 18px;
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.35);
    }

    .controls {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      overflow: auto;
    }

    .title {
      margin: 0;
      line-height: 1.05;
      font-size: 1.75rem;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: #fff6d5;
      text-shadow: 0 0 14px rgba(255, 184, 71, 0.35);
    }

    .subtitle {
      margin: 0.25rem 0 0.3rem;
      color: var(--muted);
      font-size: 0.94rem;
    }

    .group {
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 14px;
      padding: 0.8rem;
      background: linear-gradient(160deg, rgba(255,255,255,0.09), rgba(255,255,255,0.03));
    }

    .group h3 {
      margin: 0 0 0.65rem;
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #f8d995;
    }

    .control {
      margin-bottom: 0.65rem;
      display: grid;
      gap: 0.35rem;
    }

    .control:last-child { margin-bottom: 0; }

    label {
      font-size: 0.8rem;
      color: #d8e2ff;
      display: flex;
      justify-content: space-between;
      gap: 0.6rem;
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
      cursor: pointer;
    }

    input[type="color"] {
      border: none;
      width: 100%;
      height: 2rem;
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
    }

    select, button {
      width: 100%;
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 10px;
      padding: 0.55rem 0.65rem;
      color: var(--text);
      font-size: 0.9rem;
      background: rgba(6, 10, 30, 0.65);
    }

    button {
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(130deg, rgba(255, 130, 0, 0.9), rgba(255, 52, 128, 0.85));
      border: none;
      box-shadow: 0 0 12px rgba(255, 100, 46, 0.38);
      transition: transform .2s ease, filter .2s ease;
    }

    button:hover { transform: translateY(-1px); filter: brightness(1.08); }
    button:active { transform: translateY(0); }

    .toggle-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }

    .btn-alt {
      background: linear-gradient(130deg, rgba(30, 175, 255, 0.85), rgba(0, 214, 156, 0.85));
      box-shadow: 0 0 12px rgba(0, 214, 176, 0.28);
    }

    .status {
      font-size: 0.78rem;
      color: #cde7ff;
      padding: 0.45rem 0.55rem;
      border: 1px dashed rgba(255,255,255,0.26);
      border-radius: 8px;
      background: rgba(255,255,255,0.06);
      min-height: 2rem;
    }

    .stage-wrap {
      position: relative;
      padding: 0.7rem;
      display: grid;
      grid-template-rows: 1fr auto;
      gap: 0.65rem;
      min-height: 0;
    }

    .stage {
      width: 100%;
      height: 100%;
      min-height: 380px;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.13);
      background:
        radial-gradient(circle at center, rgba(255,255,255,0.08), rgba(0,0,0,0.35)),
        linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.45));
      position: relative;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .meter {
      height: 58px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(2, 6, 20, 0.7);
      position: relative;
    }

    .bars {
      position: absolute;
      inset: 0;
      display: grid;
      grid-template-columns: repeat(48, 1fr);
      align-items: end;
      gap: 2px;
      padding: 4px;
    }

    .bar {
      width: 100%;
      background: linear-gradient(180deg, #fff6af, #ff6a00 55%, #ff2277);
      border-radius: 2px 2px 0 0;
      transform-origin: bottom;
      transform: scaleY(0.08);
      opacity: 0.82;
      transition: transform 80ms linear;
    }

    .hud {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      pointer-events: none;
    }

    .pill {
      padding: 0.32rem 0.55rem;
      border-radius: 999px;
      background: rgba(0,0,0,0.42);
      border: 1px solid rgba(255,255,255,0.18);
      font-size: 0.72rem;
      color: #e8f2ff;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      backdrop-filter: blur(4px);
    }

    @media (max-width: 960px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        height: 96vh;
      }

      .controls {
        max-height: 42vh;
      }

      .stage {
        min-height: 42vh;
      }
    }
  </style>
</head>
<body>
  <div class="backdrop"></div>

  <main class="app">
    <section class="panel controls">
      <div>
        <h1 class="title">Festival Lights Show</h1>
        <p class="subtitle">Control a vibrant virtual stage with live patterns and music sync.</p>
      </div>

      <div class="group">
        <h3>Light Controls</h3>
        <div class="control">
          <label for="colorA">Primary Color</label>
          <input id="colorA" type="color" value="#ff7a18" />
        </div>
        <div class="control">
          <label for="colorB">Secondary Color</label>
          <input id="colorB" type="color" value="#00e5ff" />
        </div>
        <div class="control">
          <label for="intensity">Intensity <span id="intensityVal">75%</span></label>
          <input id="intensity" type="range" min="20" max="140" value="75" />
        </div>
        <div class="control">
          <label for="speed">Pattern Speed <span id="speedVal">65%</span></label>
          <input id="speed" type="range" min="10" max="160" value="65" />
        </div>
      </div>

      <div class="group">
        <h3>Patterns</h3>
        <div class="control">
          <label for="pattern">Pattern Type</label>
          <select id="pattern">
            <option value="wave">Neon Wave</option>
            <option value="chase">Pulse Chase</option>
            <option value="spiral">Solar Spiral</option>
            <option value="strobe">Turbo Strobe</option>
            <option value="aurora">Aurora Bloom</option>
          </select>
        </div>
        <div class="toggle-row">
          <button id="randomizeBtn" type="button">Randomize Look</button>
          <button id="burstBtn" type="button" class="btn-alt">Energy Burst</button>
        </div>
      </div>

      <div class="group">
        <h3>Music Sync</h3>
        <div class="toggle-row">
          <button id="musicBtn" type="button">Play Music</button>
          <button id="syncBtn" type="button" class="btn-alt">Sync: ON</button>
        </div>
        <div class="control" style="margin-top: 0.6rem;">
          <label for="volume">Music Volume <span id="volumeVal">45%</span></label>
          <input id="volume" type="range" min="0" max="100" value="45" />
        </div>
        <div class="status" id="status">Ready. Press <strong>Play Music</strong> to enable reactive syncing.</div>
      </div>
    </section>

    <section class="panel stage-wrap">
      <div class="stage">
        <div class="hud">
          <span class="pill" id="hudPattern">Pattern: Neon Wave</span>
          <span class="pill" id="hudBeat">Beat: 0%</span>
        </div>
        <canvas id="stageCanvas"></canvas>
      </div>
      <div class="meter">
        <div class="bars" id="bars"></div>
      </div>
    </section>
  </main>

  <script>
    (() => {
      const canvas = document.getElementById('stageCanvas');
      const ctx = canvas.getContext('2d');
      const barsEl = document.getElementById('bars');
      const statusEl = document.getElementById('status');
      const hudBeat = document.getElementById('hudBeat');
      const hudPattern = document.getElementById('hudPattern');

      const controls = {
        colorA: document.getElementById('colorA'),
        colorB: document.getElementById('colorB'),
        intensity: document.getElementById('intensity'),
        speed: document.getElementById('speed'),
        pattern: document.getElementById('pattern'),
        volume: document.getElementById('volume'),
        intensityVal: document.getElementById('intensityVal'),
        speedVal: document.getElementById('speedVal'),
        volumeVal: document.getElementById('volumeVal'),
        randomizeBtn: document.getElementById('randomizeBtn'),
        burstBtn: document.getElementById('burstBtn'),
        musicBtn: document.getElementById('musicBtn'),
        syncBtn: document.getElementById('syncBtn')
      };

      const BAR_COUNT = 48;
      const bars = Array.from({ length: BAR_COUNT }, () => {
        const bar = document.createElement('div');
        bar.className = 'bar';
        barsEl.appendChild(bar);
        return bar;
      });

      let w = 0;
      let h = 0;
      let time = 0;
      let beatLevel = 0;
      let syncEnabled = true;
      let burstPower = 0;

      let audioCtx = null;
      let analyser = null;
      let masterGain = null;
      let musicPlaying = false;
      let audioData = new Uint8Array(256);
      let oscillators = [];
      let beatInterval = null;

      const state = {
        colorA: controls.colorA.value,
        colorB: controls.colorB.value,
        intensity: Number(controls.intensity.value) / 100,
        speed: Number(controls.speed.value) / 100,
        pattern: controls.pattern.value,
        volume: Number(controls.volume.value) / 100
      };

      const patternNames = {
        wave: 'Neon Wave',
        chase: 'Pulse Chase',
        spiral: 'Solar Spiral',
        strobe: 'Turbo Strobe',
        aurora: 'Aurora Bloom'
      };

      function resize() {
        const ratio = Math.min(window.devicePixelRatio || 1, 2);
        const rect = canvas.getBoundingClientRect();
        w = Math.floor(rect.width);
        h = Math.floor(rect.height);
        canvas.width = Math.floor(w * ratio);
        canvas.height = Math.floor(h * ratio);
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      }

      function hexToRgb(hex) {
        const c = hex.replace('#', '');
        const full = c.length === 3 ? c.split('').map(x => x + x).join('') : c;
        const n = Number.parseInt(full, 16);
        return {
          r: (n >> 16) & 255,
          g: (n >> 8) & 255,
          b: n & 255
        };
      }

      function mix(a, b, t) {
        return a + (b - a) * t;
      }

      function colorMix(c1, c2, t, alpha = 1) {
        const a = hexToRgb(c1);
        const b = hexToRgb(c2);
        const r = Math.round(mix(a.r, b.r, t));
        const g = Math.round(mix(a.g, b.g, t));
        const b2 = Math.round(mix(a.b, b.b, t));
        return `rgba(${r}, ${g}, ${b2}, ${alpha})`;
      }

      function updateLabels() {
        controls.intensityVal.textContent = `${Math.round(state.intensity * 100)}%`;
        controls.speedVal.textContent = `${Math.round(state.speed * 100)}%`;
        controls.volumeVal.textContent = `${Math.round(state.volume * 100)}%`;
        hudPattern.textContent = `Pattern: ${patternNames[state.pattern]}`;
      }

      function setStatus(msg) {
        statusEl.innerHTML = msg;
      }

      function updateAudioData() {
        if (analyser && musicPlaying) {
          if (audioData.length !== analyser.frequencyBinCount) {
            audioData = new Uint8Array(analyser.frequencyBinCount);
          }
          analyser.getByteFrequencyData(audioData);
          let low = 0;
          const bassBins = Math.max(4, Math.floor(audioData.length * 0.08));
          for (let i = 0; i < bassBins; i++) low += audioData[i];
          low /= bassBins * 255;
          beatLevel = syncEnabled ? mix(beatLevel, low * 1.15, 0.35) : mix(beatLevel, 0, 0.15);

          for (let i = 0; i < BAR_COUNT; i++) {
            const idx = Math.floor((i / BAR_COUNT) * audioData.length);
            const v = (audioData[idx] || 0) / 255;
            bars[i].style.transform = `scaleY(${Math.max(0.06, v * 1.2)})`;
            bars[i].style.opacity = `${0.35 + v * 0.85}`;
          }
        } else {
          beatLevel = mix(beatLevel, 0.06 + burstPower * 0.5, 0.08);
          for (let i = 0; i < BAR_COUNT; i++) {
            const v = 0.1 + Math.sin(time * 1.9 + i * 0.42) * 0.08 + beatLevel * 0.6;
            bars[i].style.transform = `scaleY(${Math.max(0.05, v)})`;
            bars[i].style.opacity = `${0.35 + v}`;
          }
        }

        hudBeat.textContent = `Beat: ${Math.round(Math.min(1, beatLevel) * 100)}%`;
      }

      function drawWave(energy) {
        const cols = 18;
        const rows = 9;
        const spacingX = w / (cols + 1);
        const spacingY = h / (rows + 1);

        for (let y = 1; y <= rows; y++) {
          for (let x = 1; x <= cols; x++) {
            const px = x * spacingX;
            const py = y * spacingY;
            const t = (Math.sin(time * 2.8 * state.speed + x * 0.55 + y * 0.2) + 1) / 2;
            const pulse = 0.4 + t * 0.7 + energy * 1.2;
            const radius = (4 + t * 9) * (0.9 + state.intensity * 0.8 + energy * 0.7);

            const grad = ctx.createRadialGradient(px, py, 0, px, py, radius * 2.6);
            grad.addColorStop(0, colorMix(state.colorA, state.colorB, t, 0.95 * pulse));
            grad.addColorStop(1, colorMix(state.colorB, '#000000', 0.5, 0));
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(px, py, radius * 1.6, 0, Math.PI * 2);
            ctx.fill();
          }
        }
      }

      function drawChase(energy) {
        const lanes = 14;
        const laneH = h / lanes;
        for (let i = 0; i < lanes; i++) {
          const prog = (time * state.speed * 0.35 + i / lanes) % 1;
          const x = prog * (w + 180) - 90;
          const y = laneH * (i + 0.5) + Math.sin(time + i * 0.4) * 4;
          const trailCount = 4;

          for (let t = 0; t < trailCount; t++) {
            const tt = t / trailCount;
            const px = x - tt * 140;
            const rad = (16 - t * 3) * (1 + energy * 0.9 + state.intensity * 0.4);
            const c = colorMix(state.colorA, state.colorB, (i / lanes + tt + time * 0.05) % 1, 0.35 - tt * 0.08 + energy * 0.28);
            const g = ctx.createRadialGradient(px, y, 0, px, y, rad * 2.3);
            g.addColorStop(0, c);
            g.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = g;
            ctx.beginPath();
            ctx.arc(px, y, rad * 1.8, 0, Math.PI * 2);
            ctx.fill();
          }
        }
      }

      function drawSpiral(energy) {
        const cx = w * 0.5;
        const cy = h * 0.5;
        const turns = 140;
        const maxR = Math.min(w, h) * 0.48;
        for (let i = 0; i < turns; i++) {
          const p = i / turns;
          const angle = p * Math.PI * 10 + time * state.speed * 1.7;
          const r = p * maxR * (0.85 + Math.sin(time * 1.3 + p * 9) * 0.08);
          const x = cx + Math.cos(angle) * r;
          const y = cy + Math.sin(angle) * r;
          const tw = (Math.sin(time * 2.2 + p * 16) + 1) / 2;
          const radius = (2 + tw * 8) * (0.8 + state.intensity * 0.8 + energy);

          ctx.fillStyle = colorMix(state.colorA, state.colorB, (p + time * 0.08) % 1, 0.26 + tw * 0.58 + energy * 0.2);
          ctx.beginPath();
          ctx.arc(x, y, radius, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      function drawStrobe(energy) {
        const flicker = (Math.sin(time * (16 + state.speed * 20)) + 1) / 2;
        const brightness = Math.min(1, flicker * 1.25 + energy * 1.6);

        const stripes = 12;
        for (let i = 0; i < stripes; i++) {
          const t = i / (stripes - 1);
          const x = t * w;
          const wStripe = w / stripes + 3;
          ctx.fillStyle = colorMix(state.colorA, state.colorB, (t + time * 0.12) % 1, 0.04 + brightness * 0.5);
          ctx.fillRect(x - wStripe / 2, 0, wStripe, h);
        }

        if (brightness > 0.7) {
          ctx.fillStyle = `rgba(255,255,255,${(brightness - 0.68) * 0.65})`;
          ctx.fillRect(0, 0, w, h);
        }
      }

      function drawAurora(energy) {
        for (let i = 0; i < 5; i++) {
          const yBase = h * (0.16 + i * 0.17);
          const amp = 40 + i * 14 + energy * 85;
          const width = 20 + i * 7;
          const phase = time * (0.7 + i * 0.2) * state.speed;

          ctx.beginPath();
          ctx.moveTo(0, yBase);
          for (let x = 0; x <= w; x += 18) {
            const y = yBase + Math.sin(x * 0.01 + phase + i) * amp * 0.35 + Math.cos(x * 0.006 - phase * 1.3) * amp * 0.2;
            ctx.lineTo(x, y);
          }

          const grad = ctx.createLinearGradient(0, yBase - amp, 0, yBase + amp);
          grad.addColorStop(0, colorMix(state.colorA, state.colorB, i / 5, 0));
          grad.addColorStop(0.5, colorMix(state.colorA, state.colorB, (i / 5 + 0.3) % 1, 0.28 + energy * 0.45));
          grad.addColorStop(1, colorMix(state.colorB, '#000000', 0.65, 0));

          ctx.strokeStyle = grad;
          ctx.lineWidth = width;
          ctx.lineCap = 'round';
          ctx.stroke();
        }
      }

      function drawFrame(ts) {
        time = ts * 0.001;
        updateAudioData();

        burstPower *= 0.94;
        const energy = Math.min(1.4, beatLevel * 1.35 + burstPower);

        ctx.clearRect(0, 0, w, h);

        const bg = ctx.createRadialGradient(w * 0.5, h * 0.5, Math.min(w, h) * 0.02, w * 0.5, h * 0.5, Math.max(w, h) * 0.78);
        bg.addColorStop(0, colorMix(state.colorB, '#ffffff', 0.08, 0.1 + energy * 0.12));
        bg.addColorStop(1, 'rgba(0,0,0,0.45)');
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, w, h);

        switch (state.pattern) {
          case 'chase':
            drawChase(energy);
            break;
          case 'spiral':
            drawSpiral(energy);
            break;
          case 'strobe':
            drawStrobe(energy);
            break;
          case 'aurora':
            drawAurora(energy);
            break;
          default:
            drawWave(energy);
        }

        const vignette = ctx.createRadialGradient(w * 0.5, h * 0.45, Math.min(w, h) * 0.2, w * 0.5, h * 0.5, Math.max(w, h) * 0.7);
        vignette.addColorStop(0, 'rgba(0,0,0,0)');
        vignette.addColorStop(1, 'rgba(0,0,0,0.46)');
        ctx.fillStyle = vignette;
        ctx.fillRect(0, 0, w, h);

        requestAnimationFrame(drawFrame);
      }

      function randColor() {
        const hue = Math.floor(Math.random() * 360);
        return `hsl(${hue}, 98%, 58%)`;
      }

      function randomizeLook() {
        controls.colorA.value = hslToHex(Math.random() * 360, 95, 56);
        controls.colorB.value = hslToHex(Math.random() * 360, 95, 60);
        state.colorA = controls.colorA.value;
        state.colorB = controls.colorB.value;

        const patternKeys = Object.keys(patternNames);
        state.pattern = patternKeys[Math.floor(Math.random() * patternKeys.length)];
        controls.pattern.value = state.pattern;

        state.speed = 0.35 + Math.random() * 0.95;
        state.intensity = 0.45 + Math.random() * 0.8;
        controls.speed.value = Math.round(state.speed * 100);
        controls.intensity.value = Math.round(state.intensity * 100);

        updateLabels();
        burstPower = Math.max(burstPower, 0.55);
      }

      function hslToHex(h, s, l) {
        l /= 100;
        const a = (s * Math.min(l, 1 - l)) / 100;
        const f = n => {
          const k = (n + h / 30) % 12;
          const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
          return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`;
      }

      function createMusic() {
        if (audioCtx) return;

        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 512;
        analyser.smoothingTimeConstant = 0.82;

        masterGain = audioCtx.createGain();
        masterGain.gain.value = state.volume;

        const comp = audioCtx.createDynamicsCompressor();
        comp.threshold.value = -28;
        comp.knee.value = 18;
        comp.ratio.value = 8;
        comp.attack.value = 0.003;
        comp.release.value = 0.23;

        masterGain.connect(comp);
        comp.connect(analyser);
        analyser.connect(audioCtx.destination);
      }

      function clearMusic() {
        if (beatInterval) {
          clearInterval(beatInterval);
          beatInterval = null;
        }

        oscillators.forEach(osc => {
          try {
            osc.stop();
            osc.disconnect();
          } catch (e) {}
        });
        oscillators = [];
      }

      function startMusic() {
        createMusic();
        if (!audioCtx || !masterGain) return;

        clearMusic();

        const now = audioCtx.currentTime;

        const pad = audioCtx.createOscillator();
        pad.type = 'triangle';
        pad.frequency.value = 110;
        const padGain = audioCtx.createGain();
        padGain.gain.value = 0.12;
        pad.connect(padGain).connect(masterGain);
        pad.start(now);

        const bass = audioCtx.createOscillator();
        bass.type = 'sawtooth';
        bass.frequency.value = 55;
        const bassGain = audioCtx.createGain();
        bassGain.gain.value = 0.11;
        bass.connect(bassGain).connect(masterGain);
        bass.start(now);

        const lead = audioCtx.createOscillator();
        lead.type = 'square';
        lead.frequency.value = 220;
        const leadGain = audioCtx.createGain();
        leadGain.gain.value = 0.05;
        lead.connect(leadGain).connect(masterGain);
        lead.start(now);

        oscillators.push(pad, bass, lead);

        const bpm = 122;
        const beatMs = (60 / bpm) * 1000;
        const bassNotes = [55, 55, 82.41, 65.41, 55, 98, 82.41, 73.42];
        const leadNotes = [220, 246.94, 261.63, 329.63, 293.66, 261.63, 246.94, 196];
        let step = 0;

        beatInterval = setInterval(() => {
          if (!audioCtx || !musicPlaying) return;
          const t = audioCtx.currentTime;

          const bassF = bassNotes[step % bassNotes.length];
          const leadF = leadNotes[step % leadNotes.length];

          bass.frequency.cancelScheduledValues(t);
          bass.frequency.setTargetAtTime(bassF, t, 0.02);

          lead.frequency.cancelScheduledValues(t);
          lead.frequency.setTargetAtTime(leadF, t, 0.015);

          pad.frequency.cancelScheduledValues(t);
          pad.frequency.setTargetAtTime(bassF * 2, t, 0.03);

          // Kick-like pulse
          bassGain.gain.cancelScheduledValues(t);
          bassGain.gain.setValueAtTime(0.12, t);
          bassGain.gain.exponentialRampToValueAtTime(0.04, t + 0.18);

          // Lead gate
          leadGain.gain.cancelScheduledValues(t);
          leadGain.gain.setValueAtTime(0.01, t);
          leadGain.gain.linearRampToValueAtTime(0.08, t + 0.04);
          leadGain.gain.linearRampToValueAtTime(0.02, t + 0.2);

          burstPower = Math.max(burstPower, 0.16);
          step++;
        }, beatMs / 2);

        musicPlaying = true;
        controls.musicBtn.textContent = 'Pause Music';
        setStatus('Music generator active. Lights are syncing to frequency energy.');
      }

      function stopMusic() {
        musicPlaying = false;
        clearMusic();
        controls.musicBtn.textContent = 'Play Music';
        setStatus('Music paused. Patterns still animate with ambient motion.');
      }

      controls.colorA.addEventListener('input', () => {
        state.colorA = controls.colorA.value;
      });

      controls.colorB.addEventListener('input', () => {
        state.colorB = controls.colorB.value;
      });

      controls.intensity.addEventListener('input', () => {
        state.intensity = Number(controls.intensity.value) / 100;
        updateLabels();
      });

      controls.speed.addEventListener('input', () => {
        state.speed = Number(controls.speed.value) / 100;
        updateLabels();
      });

      controls.pattern.addEventListener('change', () => {
        state.pattern = controls.pattern.value;
        updateLabels();
      });

      controls.volume.addEventListener('input', () => {
        state.volume = Number(controls.volume.value) / 100;
        if (masterGain) masterGain.gain.setTargetAtTime(state.volume, audioCtx.currentTime, 0.02);
        updateLabels();
      });

      controls.randomizeBtn.addEventListener('click', randomizeLook);

      controls.burstBtn.addEventListener('click', () => {
        burstPower = 1.1;
        setStatus('Energy burst fired. Stage brightness boosted.');
      });

      controls.syncBtn.addEventListener('click', () => {
        syncEnabled = !syncEnabled;
        controls.syncBtn.textContent = `Sync: ${syncEnabled ? 'ON' : 'OFF'}`;
        setStatus(syncEnabled ? 'Music sync enabled. Beat intensity controls the lights.' : 'Music sync disabled. Lights run on manual pattern settings.');
      });

      controls.musicBtn.addEventListener('click', async () => {
        if (!audioCtx) createMusic();
        if (audioCtx && audioCtx.state === 'suspended') {
          await audioCtx.resume();
        }

        if (musicPlaying) {
          stopMusic();
        } else {
          startMusic();
        }
      });

      window.addEventListener('resize', resize);

      updateLabels();
      resize();
      requestAnimationFrame(drawFrame);

      // Subtle auto pulse for first impression.
      setInterval(() => {
        burstPower = Math.max(burstPower, 0.05 + Math.random() * 0.08);
      }, 1200);
    })();
  </script>
</body>
</html>
