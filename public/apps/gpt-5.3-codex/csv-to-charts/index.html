<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Visualization Playground</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg-1: #0b1220;
      --bg-2: #1c2942;
      --card: rgba(14, 24, 42, 0.72);
      --card-border: rgba(255, 255, 255, 0.14);
      --text: #ecf3ff;
      --muted: #aac2e6;
      --accent: #22d3ee;
      --accent-2: #60a5fa;
      --good: #34d399;
      --danger: #fb7185;
      --shadow: 0 18px 40px rgba(3, 8, 20, 0.4);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      min-height: 100%;
      color: var(--text);
      font-family: "Plus Jakarta Sans", system-ui, sans-serif;
      background: radial-gradient(circle at 10% 10%, #1f3b75 0%, rgba(31, 59, 117, 0) 30%),
                  radial-gradient(circle at 90% 90%, #0ea5b2 0%, rgba(14, 165, 178, 0) 35%),
                  linear-gradient(140deg, var(--bg-1), var(--bg-2));
      background-attachment: fixed;
    }

    .grid-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.2;
      background-image:
        linear-gradient(rgba(255,255,255,0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.08) 1px, transparent 1px);
      background-size: 32px 32px;
      mask-image: radial-gradient(circle at 50% 50%, black 35%, transparent 80%);
    }

    .shell {
      max-width: 1240px;
      margin: 0 auto;
      padding: 28px 18px 28px;
      position: relative;
      z-index: 1;
    }

    .hero {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: flex-end;
      margin-bottom: 18px;
    }

    .title {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      font-size: clamp(1.7rem, 3vw, 2.7rem);
      letter-spacing: -0.02em;
      font-weight: 700;
    }

    .subtitle {
      margin-top: 6px;
      color: var(--muted);
      font-size: 0.96rem;
    }

    .chip {
      align-self: flex-start;
      background: rgba(34, 211, 238, 0.16);
      border: 1px solid rgba(103, 232, 249, 0.35);
      color: #cffafe;
      font-family: "Space Grotesk", sans-serif;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .app {
      display: grid;
      grid-template-columns: 330px 1fr;
      gap: 18px;
    }

    .panel,
    .chart-wrap {
      border-radius: 22px;
      border: 1px solid var(--card-border);
      background: var(--card);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .panel {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .section {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 12px;
    }

    .section h3 {
      margin: 0 0 10px;
      font-size: 0.95rem;
      font-weight: 600;
      font-family: "Space Grotesk", sans-serif;
      letter-spacing: 0.02em;
    }

    label {
      font-size: 0.8rem;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    input,
    select,
    button {
      width: 100%;
      border-radius: 11px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(12, 18, 30, 0.7);
      color: var(--text);
      font-family: inherit;
      font-size: 0.92rem;
      padding: 10px 11px;
      outline: none;
      transition: border-color 140ms ease, box-shadow 140ms ease, transform 140ms ease;
    }

    input:focus,
    select:focus,
    button:focus-visible {
      border-color: rgba(34, 211, 238, 0.7);
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.22);
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .actions {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr 1fr;
    }

    button {
      cursor: pointer;
      font-weight: 600;
    }

    .primary {
      background: linear-gradient(135deg, #06b6d4, #3b82f6);
      border: none;
      color: #f8fdff;
    }

    .primary:hover {
      transform: translateY(-1px);
    }

    .ghost:hover {
      background: rgba(255,255,255,0.08);
    }

    .upload {
      border: 1px dashed rgba(167, 243, 208, 0.45);
      background: rgba(16, 185, 129, 0.06);
      border-radius: 13px;
      padding: 12px;
      text-align: center;
    }

    #csvFile {
      border: none;
      background: transparent;
      padding: 0;
      font-size: 0.84rem;
    }

    .help {
      margin-top: 8px;
      color: #c5d7f5;
      font-size: 0.78rem;
      line-height: 1.4;
    }

    .dataset-list {
      display: grid;
      gap: 8px;
      max-height: 220px;
      overflow: auto;
      padding-right: 4px;
    }

    .dataset-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border-radius: 11px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(10, 18, 31, 0.7);
    }

    .dataset-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
      margin: 0;
      padding: 0;
    }

    .dataset-item .name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.86rem;
    }

    .dataset-item input[type="color"] {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 0;
      background: none;
    }

    .status {
      font-size: 0.82rem;
      line-height: 1.4;
      color: #d3e5ff;
      padding: 10px 12px;
      border-radius: 11px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(12, 18, 30, 0.7);
      min-height: 40px;
    }

    .chart-wrap {
      padding: 14px;
      display: flex;
      flex-direction: column;
      min-height: 620px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .chart-title {
      font-family: "Space Grotesk", sans-serif;
      font-size: 1.02rem;
      font-weight: 600;
      margin: 0;
    }

    .metrics {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .metric {
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      font-size: 0.75rem;
      color: #d9ebff;
    }

    .canvas-wrap {
      position: relative;
      flex: 1;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      overflow: hidden;
      background: linear-gradient(180deg, rgba(3, 10, 22, 0.55), rgba(3, 10, 22, 0.22));
      min-height: 480px;
      padding: 12px;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
      border-radius: 10px;
    }

    .empty {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: #bfd2f4;
      text-align: center;
      padding: 20px;
      pointer-events: none;
      font-size: 0.96rem;
      line-height: 1.5;
    }

    @media (max-width: 1024px) {
      .app {
        grid-template-columns: 1fr;
      }

      .chart-wrap {
        min-height: 560px;
      }
    }

    @media (max-width: 560px) {
      .row,
      .actions {
        grid-template-columns: 1fr;
      }

      .shell {
        padding: 16px 12px 22px;
      }

      .chart-wrap {
        min-height: 500px;
      }
    }
  </style>
</head>
<body>
  <div class="grid-bg" aria-hidden="true"></div>
  <main class="shell">
    <header class="hero">
      <div>
        <h1 class="title">Data Visualization Playground</h1>
        <div class="subtitle">Upload CSV data and instantly shape it into compelling charts.</div>
      </div>
      <div class="chip">CSV to Charts</div>
    </header>

    <section class="app">
      <aside class="panel" aria-label="Controls">
        <div class="section">
          <h3>1. Upload Data</h3>
          <div class="upload">
            <input id="csvFile" type="file" accept=".csv,text/csv" />
            <div class="help">First row should contain headers. Include one label column and one or more numeric columns.</div>
          </div>
        </div>

        <div class="section">
          <h3>2. Configure Chart</h3>
          <div class="row" style="margin-bottom: 10px;">
            <div>
              <label for="chartType">Chart type</label>
              <select id="chartType">
                <option value="bar">Bar</option>
                <option value="line">Line</option>
                <option value="radar">Radar</option>
                <option value="pie">Pie</option>
                <option value="doughnut">Doughnut</option>
                <option value="polarArea">Polar Area</option>
              </select>
            </div>
            <div>
              <label for="labelColumn">Label column</label>
              <select id="labelColumn" disabled></select>
            </div>
          </div>

          <div>
            <label>Numeric series (toggle + color)</label>
            <div id="datasetList" class="dataset-list"></div>
          </div>
        </div>

        <div class="section">
          <h3>3. Export</h3>
          <div class="actions">
            <button id="renderBtn" class="primary">Render Chart</button>
            <button id="saveBtn" class="ghost">Save as PNG</button>
          </div>
        </div>

        <div id="status" class="status" role="status" aria-live="polite">Upload a CSV file to get started.</div>
      </aside>

      <section class="chart-wrap" aria-label="Chart preview">
        <div class="chart-header">
          <h2 class="chart-title">Visualization Preview</h2>
          <div class="metrics">
            <span id="rowsMetric" class="metric">Rows: 0</span>
            <span id="seriesMetric" class="metric">Series: 0</span>
            <span id="typeMetric" class="metric">Type: Bar</span>
          </div>
        </div>
        <div class="canvas-wrap">
          <canvas id="chartCanvas"></canvas>
          <div id="emptyState" class="empty">Your chart will appear here.<br />Upload a CSV, select fields, then click <strong>Render Chart</strong>.</div>
        </div>
      </section>
    </section>
  </main>

  <script>
    (() => {
      const csvFile = document.getElementById('csvFile');
      const chartType = document.getElementById('chartType');
      const labelColumn = document.getElementById('labelColumn');
      const datasetList = document.getElementById('datasetList');
      const renderBtn = document.getElementById('renderBtn');
      const saveBtn = document.getElementById('saveBtn');
      const status = document.getElementById('status');
      const rowsMetric = document.getElementById('rowsMetric');
      const seriesMetric = document.getElementById('seriesMetric');
      const typeMetric = document.getElementById('typeMetric');
      const emptyState = document.getElementById('emptyState');
      const canvas = document.getElementById('chartCanvas');

      const palette = ['#22d3ee', '#60a5fa', '#34d399', '#f59e0b', '#fb7185', '#a78bfa', '#f97316', '#2dd4bf'];

      let chart;
      let parsed = { headers: [], rows: [] };
      let datasetConfig = [];

      const setStatus = (message, tone = 'info') => {
        status.textContent = message;
        status.style.borderColor = tone === 'error' ? 'rgba(251, 113, 133, 0.55)' : 'rgba(255,255,255,0.12)';
        status.style.background = tone === 'error' ? 'rgba(251, 113, 133, 0.08)' : 'rgba(12, 18, 30, 0.7)';
      };

      const csvSplit = (line) => {
        const out = [];
        let curr = '';
        let quote = false;
        for (let i = 0; i < line.length; i += 1) {
          const ch = line[i];
          if (ch === '"') {
            if (quote && line[i + 1] === '"') {
              curr += '"';
              i += 1;
            } else {
              quote = !quote;
            }
          } else if (ch === ',' && !quote) {
            out.push(curr.trim());
            curr = '';
          } else {
            curr += ch;
          }
        }
        out.push(curr.trim());
        return out;
      };

      const parseCSV = (text) => {
        const lines = text
          .replace(/^\uFEFF/, '')
          .split(/\r?\n/)
          .map((line) => line.trim())
          .filter((line) => line.length > 0);

        if (lines.length < 2) {
          throw new Error('CSV needs a header row and at least one data row.');
        }

        const headers = csvSplit(lines[0]).map((h, i) => h || `Column ${i + 1}`);
        const rows = lines.slice(1).map((line) => {
          const parts = csvSplit(line);
          return headers.map((_, idx) => (parts[idx] ?? '').trim());
        });

        return { headers, rows };
      };

      const toNumber = (value) => {
        if (value === null || value === undefined) return null;
        const normalized = String(value).replace(/\s+/g, '').replace(/,/g, '');
        if (!normalized.length) return null;
        const num = Number(normalized);
        return Number.isFinite(num) ? num : null;
      };

      const detectNumericColumns = ({ headers, rows }) => {
        return headers
          .map((name, index) => {
            const numericValues = rows.map((row) => toNumber(row[index])).filter((n) => n !== null);
            return {
              index,
              name,
              numericValues,
              ratio: rows.length ? numericValues.length / rows.length : 0
            };
          })
          .filter((col) => col.ratio >= 0.6 && col.numericValues.length > 0);
      };

      const makeAlpha = (hex, alpha) => {
        const v = hex.replace('#', '');
        if (v.length !== 6) return `rgba(96,165,250,${alpha})`;
        const r = parseInt(v.slice(0, 2), 16);
        const g = parseInt(v.slice(2, 4), 16);
        const b = parseInt(v.slice(4, 6), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      };

      const createDatasetControls = () => {
        datasetList.innerHTML = '';
        datasetConfig.forEach((entry) => {
          const card = document.createElement('label');
          card.className = 'dataset-item';

          const check = document.createElement('input');
          check.type = 'checkbox';
          check.checked = entry.enabled;
          check.addEventListener('change', () => {
            entry.enabled = check.checked;
            updateMetrics();
          });

          const name = document.createElement('span');
          name.className = 'name';
          name.textContent = entry.name;

          const color = document.createElement('input');
          color.type = 'color';
          color.value = entry.color;
          color.addEventListener('input', () => {
            entry.color = color.value;
            if (chart) renderChart();
          });

          card.append(check, name, color);
          datasetList.appendChild(card);
        });
      };

      const updateMetrics = () => {
        const activeSeries = datasetConfig.filter((d) => d.enabled).length;
        rowsMetric.textContent = `Rows: ${parsed.rows.length || 0}`;
        seriesMetric.textContent = `Series: ${activeSeries}`;
        typeMetric.textContent = `Type: ${chartType.options[chartType.selectedIndex].text}`;
      };

      const renderChart = () => {
        if (!parsed.rows.length || !parsed.headers.length) {
          setStatus('Upload and parse CSV data before rendering.', 'error');
          return;
        }

        const labelIdx = Number(labelColumn.value);
        const labels = parsed.rows.map((row, i) => row[labelIdx] || `Row ${i + 1}`);
        const selected = datasetConfig.filter((d) => d.enabled);

        if (!selected.length) {
          setStatus('Enable at least one numeric series.', 'error');
          return;
        }

        const type = chartType.value;

        const datasets = selected.map((series, seriesIdx) => {
          const data = parsed.rows.map((row) => toNumber(row[series.index]) ?? 0);
          const base = series.color;
          const fill = makeAlpha(base, 0.2);
          const common = {
            label: series.name,
            data,
            borderColor: base,
            backgroundColor: ['pie', 'doughnut', 'polarArea'].includes(type)
              ? data.map((_, idx) => makeAlpha(selected[idx % selected.length]?.color || palette[idx % palette.length], 0.75))
              : fill,
            pointBackgroundColor: base,
            pointBorderColor: '#e2edff',
            pointRadius: type === 'line' ? 3 : 2,
            borderWidth: 2,
            tension: 0.32,
            fill: type === 'line' || type === 'radar'
          };

          if (['pie', 'doughnut', 'polarArea'].includes(type)) {
            if (seriesIdx > 0) return null;
            return {
              label: series.name,
              data,
              borderColor: '#0b1325',
              backgroundColor: data.map((_, idx) => makeAlpha(palette[idx % palette.length], 0.84)),
              borderWidth: 1
            };
          }

          return common;
        }).filter(Boolean);

        if (!datasets.length) {
          setStatus('The selected chart type supports one series at a time. Keep one enabled.', 'error');
          return;
        }

        const config = {
          type,
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              duration: 850,
              easing: 'easeOutQuart'
            },
            plugins: {
              legend: {
                labels: { color: '#e8f2ff', usePointStyle: true }
              },
              tooltip: {
                backgroundColor: 'rgba(5, 10, 21, 0.95)',
                borderColor: 'rgba(96, 165, 250, 0.5)',
                borderWidth: 1,
                titleColor: '#ebf5ff',
                bodyColor: '#d0e4ff'
              }
            },
            scales: ['pie', 'doughnut', 'polarArea'].includes(type)
              ? {}
              : {
                  x: {
                    ticks: { color: '#d8e9ff' },
                    grid: { color: 'rgba(168, 193, 230, 0.13)' }
                  },
                  y: {
                    beginAtZero: true,
                    ticks: { color: '#d8e9ff' },
                    grid: { color: 'rgba(168, 193, 230, 0.13)' }
                  }
                }
          }
        };

        if (chart) chart.destroy();
        chart = new Chart(canvas.getContext('2d'), config);
        emptyState.style.display = 'none';

        setStatus(`Rendered ${type} chart with ${datasets.length} series and ${labels.length} rows.`);
        updateMetrics();
      };

      const populateControls = () => {
        const numericColumns = detectNumericColumns(parsed);

        labelColumn.innerHTML = parsed.headers
          .map((name, idx) => `<option value="${idx}">${name}</option>`)
          .join('');

        const firstNonNumeric = parsed.headers.findIndex((_, idx) => !numericColumns.some((n) => n.index === idx));
        labelColumn.value = String(firstNonNumeric >= 0 ? firstNonNumeric : 0);
        labelColumn.disabled = false;

        datasetConfig = numericColumns.map((col, idx) => ({
          index: col.index,
          name: col.name,
          enabled: idx < 4,
          color: palette[idx % palette.length]
        }));

        createDatasetControls();

        if (!datasetConfig.length) {
          setStatus('No numeric columns detected. Ensure your CSV has number-based columns.', 'error');
        } else {
          setStatus(`Parsed CSV successfully: ${parsed.rows.length} rows, ${datasetConfig.length} numeric series.`);
        }

        updateMetrics();
      };

      csvFile.addEventListener('change', (e) => {
        const [file] = e.target.files;
        if (!file) return;
        const reader = new FileReader();

        reader.onload = () => {
          try {
            parsed = parseCSV(String(reader.result));
            if (chart) {
              chart.destroy();
              chart = null;
            }
            emptyState.style.display = 'grid';
            populateControls();
          } catch (err) {
            setStatus(err.message || 'Could not parse CSV file.', 'error');
          }
        };

        reader.onerror = () => {
          setStatus('Failed to read file.', 'error');
        };

        reader.readAsText(file);
      });

      chartType.addEventListener('change', () => {
        updateMetrics();
        if (chart) renderChart();
      });

      labelColumn.addEventListener('change', () => {
        if (chart) renderChart();
      });

      renderBtn.addEventListener('click', renderChart);

      saveBtn.addEventListener('click', () => {
        if (!chart) {
          setStatus('Render a chart before saving.', 'error');
          return;
        }

        const a = document.createElement('a');
        a.href = chart.toBase64Image('image/png', 1);
        const stamp = new Date().toISOString().replace(/[:.]/g, '-');
        a.download = `data-visualization-${stamp}.png`;
        a.click();
        setStatus('Chart exported as PNG.');
      });

      updateMetrics();
    })();
  </script>
</body>
</html>
