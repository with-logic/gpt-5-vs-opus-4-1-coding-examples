<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Music Theory Trainer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Interactive Music Theory Trainer with piano, scales, chords, and ear training exercises."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: radial-gradient(circle at top left, #17192b 0, #050611 45%, #020308 100%);
        --accent: #ff6f61;
        --accent-soft: rgba(255, 111, 97, 0.25);
        --accent-strong: #ffb347;
        --panel: rgba(10, 13, 36, 0.92);
        --panel-soft: rgba(15, 18, 54, 0.86);
        --border-subtle: rgba(255, 255, 255, 0.08);
        --shadow-soft: 0 18px 60px rgba(0, 0, 0, 0.72);
        --text-main: #f8fafc;
        --text-muted: #9ca3af;
        --key-white: #f9fafb;
        --key-black: #020617;
        --key-border: #0f172a;
        --good: #4ade80;
        --bad: #f97373;
        --info: #38bdf8;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        color: var(--text-main);
        background: var(--bg);
      }

      body {
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: 16px;
        overflow: hidden;
      }

      .app-shell {
        position: relative;
        width: 100%;
        max-width: 1180px;
        height: 100%;
        max-height: 760px;
        background: radial-gradient(circle at 0% 0%, rgba(248, 250, 252, 0.04), transparent 55%),
          radial-gradient(circle at 100% 100%, rgba(248, 250, 252, 0.05), transparent 45%),
          linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
        border-radius: 32px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        box-shadow: var(--shadow-soft);
        padding: 22px 24px 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .app-shell::before {
        content: "";
        position: absolute;
        inset: -80px;
        opacity: 0.65;
        background-image: radial-gradient(circle at 20% 10%, rgba(129, 140, 248, 0.25), transparent 40%),
          radial-gradient(circle at 80% 85%, rgba(248, 113, 113, 0.18), transparent 40%);
        mix-blend-mode: screen;
        pointer-events: none;
        z-index: -1;
      }

      header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-subtle);
        margin-bottom: 12px;
      }

      .logo-lockup {
        position: relative;
        width: 56px;
        height: 56px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #fecaca 0, #fb7185 32%, #4f46e5 72%, #020617 100%);
        box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9), 0 14px 40px rgba(15, 23, 42, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .logo-inner {
        position: relative;
        width: 70%;
        height: 70%;
        border-radius: 32px;
        border: 2px solid rgba(248, 250, 252, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.6));
        backdrop-filter: blur(12px);
        overflow: hidden;
      }

      .logo-staff {
        position: absolute;
        width: 120%;
        height: 1px;
        background: rgba(148, 163, 184, 0.7);
        box-shadow: 0 -6px 0 rgba(148, 163, 184, 0.65), 0 -12px 0 rgba(148, 163, 184, 0.45),
          0 6px 0 rgba(148, 163, 184, 0.65), 0 12px 0 rgba(148, 163, 184, 0.45);
      }

      .logo-note {
        position: relative;
        width: 12px;
        height: 30px;
        border-radius: 999px;
        border: 2px solid rgba(248, 250, 252, 0.95);
        border-left-width: 3px;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        transform: translateX(8px) rotate(-8deg);
        transform-origin: bottom left;
      }

      .logo-note::before {
        content: "";
        position: absolute;
        bottom: -10px;
        left: -6px;
        width: 16px;
        height: 16px;
        border-radius: 999px;
        background: rgba(248, 250, 252, 0.9);
        box-shadow: 0 0 12px rgba(248, 250, 252, 0.85);
      }

      .logo-glow {
        position: absolute;
        inset: -10px;
        background: radial-gradient(circle at 30% 10%, rgba(248, 250, 252, 0.4), transparent 55%);
        opacity: 0.9;
        mix-blend-mode: screen;
        pointer-events: none;
      }

      .header-text {
        flex: 1;
        min-width: 0;
      }

      .title {
        display: flex;
        align-items: baseline;
        gap: 10px;
      }

      .title h1 {
        font-size: 1.55rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        margin: 0;
        font-weight: 600;
      }

      .title-badge {
        font-size: 0.7rem;
        font-weight: 500;
        padding: 2px 9px;
        border-radius: 999px;
        border: 1px solid rgba(248, 250, 252, 0.3);
        color: rgba(248, 250, 252, 0.9);
        background: linear-gradient(135deg, rgba(234, 179, 8, 0.22), rgba(245, 158, 11, 0.08));
        box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
      }

      .subtitle {
        margin: 4px 0 0;
        font-size: 0.84rem;
        color: var(--text-muted);
      }

      .header-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }

      .pill-group {
        display: inline-flex;
        gap: 4px;
        padding: 3px;
        border-radius: 999px;
        background: radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.25), transparent 60%),
          linear-gradient(90deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.95));
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      .pill {
        font-size: 0.72rem;
        padding: 3px 8px;
        border-radius: 999px;
        color: rgba(248, 250, 252, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: radial-gradient(circle at 0 0, rgba(251, 113, 133, 0.12), transparent 60%),
          rgba(15, 23, 42, 0.96);
      }

      .pill.accent {
        border-color: rgba(248, 250, 252, 0.6);
        background: radial-gradient(circle at 10% 0, rgba(251, 113, 133, 0.85), transparent 55%),
          radial-gradient(circle at 90% 100%, rgba(234, 179, 8, 0.85), transparent 55%),
          rgba(15, 23, 42, 0.96);
      }

      .header-meta {
        font-size: 0.7rem;
        color: rgba(148, 163, 184, 0.9);
      }

      .header-meta strong {
        color: rgba(248, 250, 252, 0.9);
        font-weight: 600;
      }

      main {
        display: grid;
        grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.95fr);
        gap: 16px;
        flex: 1;
        overflow: hidden;
        padding: 4px 0 10px;
      }

      .panel {
        border-radius: 20px;
        background: radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.25), transparent 55%),
          radial-gradient(circle at 100% 100%, rgba(248, 113, 113, 0.18), transparent 40%),
          linear-gradient(145deg, var(--panel), var(--panel-soft));
        border: 1px solid rgba(148, 163, 184, 0.26);
        box-shadow: 0 16px 50px rgba(15, 23, 42, 0.9);
        padding: 12px 14px 12px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
        gap: 8px;
      }

      .panel-title {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: rgba(148, 163, 184, 0.9);
        display: flex;
        align-items: center;
        gap: 7px;
      }

      .panel-title-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: radial-gradient(circle, #f97316 0, #fb7185 40%, #7c3aed 100%);
        box-shadow: 0 0 12px rgba(251, 113, 133, 0.75);
      }

      .panel-subtitle {
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .panel-tabs {
        display: inline-flex;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        padding: 3px;
        gap: 2px;
        border: 1px solid rgba(148, 163, 184, 0.5);
      }

      .panel-tab {
        font-size: 0.76rem;
        padding: 4px 10px;
        border-radius: 999px;
        border: none;
        background: transparent;
        color: rgba(148, 163, 184, 0.92);
        cursor: pointer;
        transition: all 0.14s ease-out;
        white-space: nowrap;
      }

      .panel-tab.active {
        background: radial-gradient(circle at 10% 0, rgba(251, 113, 133, 0.9), transparent 50%),
          radial-gradient(circle at 90% 100%, rgba(234, 179, 8, 0.9), transparent 55%);
        color: rgba(15, 23, 42, 0.95);
        font-weight: 600;
        box-shadow: 0 0 0 1px rgba(248, 250, 252, 0.8), 0 6px 18px rgba(248, 250, 252, 0.3);
      }

      .panel-body {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }

      .panel-scroll {
        flex: 1;
        min-height: 0;
        overflow: hidden auto;
        padding-right: 4px;
        scrollbar-width: thin;
        scrollbar-color: rgba(148, 163, 184, 0.55) transparent;
      }

      .panel-scroll::-webkit-scrollbar {
        width: 6px;
      }

      .panel-scroll::-webkit-scrollbar-track {
        background: transparent;
      }

      .panel-scroll::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.55);
        border-radius: 999px;
      }

      /* Piano */
      .piano-wrapper {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 6px;
      }

      .piano-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        padding: 7px 10px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.25), transparent 55%),
          linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.95));
      }

      .piano-status {
        display: flex;
        flex-direction: column;
        gap: 1px;
        font-size: 0.76rem;
      }

      .piano-status-line {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .status-pill {
        padding: 2px 7px;
        border-radius: 999px;
        font-size: 0.7rem;
        border: 1px solid rgba(148, 163, 184, 0.8);
        color: rgba(248, 250, 252, 0.9);
        background: rgba(15, 23, 42, 0.9);
      }

      .status-pill span {
        opacity: 0.8;
      }

      .piano-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .select {
        appearance: none;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.8);
        background: rgba(15, 23, 42, 0.95);
        color: var(--text-main);
        padding: 3px 22px 3px 9px;
        font-size: 0.76rem;
        position: relative;
        cursor: pointer;
        background-image: linear-gradient(45deg, transparent 50%, rgba(148, 163, 184, 0.9) 50%),
          linear-gradient(135deg, rgba(148, 163, 184, 0.9) 50%, transparent 50%);
        background-position: calc(100% - 13px) 9px, calc(100% - 9px) 9px;
        background-size: 4px 4px, 4px 4px;
        background-repeat: no-repeat;
      }

      .toggle-button {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.8);
        background: rgba(15, 23, 42, 0.95);
        padding: 3px 8px;
        font-size: 0.76rem;
        color: var(--text-muted);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }

      .toggle-button-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.8);
        background: rgba(15, 23, 42, 1);
      }

      .toggle-button.on {
        color: rgba(248, 250, 252, 0.98);
        border-color: rgba(248, 250, 252, 0.9);
        background: radial-gradient(circle at 0 0, rgba(251, 113, 133, 0.7), transparent 50%),
          radial-gradient(circle at 100% 100%, rgba(251, 191, 36, 0.7), transparent 50%);
        box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9), 0 0 18px rgba(251, 191, 36, 0.45);
      }

      .toggle-button.on .toggle-button-dot {
        background: #fbbf24;
        box-shadow: 0 0 10px rgba(251, 191, 36, 0.8);
      }

      .piano-keyboard-shell {
        position: relative;
        border-radius: 14px;
        padding: 10px 10px 12px;
        background: linear-gradient(180deg, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.94));
        border: 1px solid rgba(148, 163, 184, 0.55);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
      }

      .piano-keyboard-shell::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        border-top: 1px solid rgba(148, 163, 184, 0.6);
        border-bottom: 1px solid rgba(0, 0, 0, 0.7);
        opacity: 0.9;
        pointer-events: none;
      }

      .piano-keyboard {
        position: relative;
        height: 170px;
        display: flex;
        align-items: stretch;
        justify-content: center;
        user-select: none;
      }

      .piano-key-white {
        position: relative;
        flex: 1;
        margin: 0 1px;
        border-radius: 0 0 10px 10px;
        background: linear-gradient(180deg, #f9fafb, #e5e7eb);
        border: 1px solid var(--key-border);
        box-shadow: inset 0 -2px 0 rgba(148, 163, 184, 0.9), 0 8px 12px rgba(15, 23, 42, 0.8);
        cursor: pointer;
        transition: transform 0.03s ease-out, box-shadow 0.05s ease-out, background 0.12s ease-out;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        padding-bottom: 22px;
        z-index: 1;
      }

      .piano-key-white::before {
        content: attr(data-label);
        position: absolute;
        bottom: 4px;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 0.68rem;
        color: rgba(15, 23, 42, 0.9);
        background: rgba(209, 213, 219, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.8);
        box-shadow: 0 1px 0 rgba(148, 163, 184, 0.8);
        opacity: 0.85;
        transition: opacity 0.12s ease-out;
      }

      .piano-key-white.no-label::before {
        opacity: 0;
      }

      .piano-key-white.active {
        transform: translateY(2px);
        box-shadow: inset 0 -1px 0 rgba(148, 163, 184, 0.7), 0 4px 8px rgba(15, 23, 42, 0.9);
        background: linear-gradient(180deg, #e5e7eb, #d4d4d8);
      }

      .piano-key-white.scale-note::after,
      .piano-key-white.chord-note::after {
        content: "";
        position: absolute;
        top: 10px;
        width: 16px;
        height: 16px;
        border-radius: 999px;
        border: 2px solid rgba(15, 23, 42, 0.96);
        box-shadow: 0 0 0 1px rgba(248, 250, 252, 1);
      }

      .piano-key-white.scale-note::after {
        background: radial-gradient(circle at 30% 20%, rgba(59, 130, 246, 0.21), transparent 60%),
          linear-gradient(135deg, #22c55e, #22c55e);
      }

      .piano-key-white.chord-root::after {
        background: radial-gradient(circle at 30% 20%, rgba(249, 115, 22, 0.24), transparent 55%),
          linear-gradient(135deg, #fb923c, #f97316);
      }

      .piano-key-white.chord-note:not(.chord-root)::after {
        background: radial-gradient(circle at 30% 20%, rgba(251, 113, 133, 0.24), transparent 55%),
          linear-gradient(135deg, #f472b6, #fb7185);
      }

      .piano-key-black {
        position: absolute;
        top: 0;
        width: 34px;
        height: 100px;
        border-radius: 0 0 10px 10px;
        background: radial-gradient(circle at 20% 0, #4b5563, transparent 45%),
          radial-gradient(circle at 80% 0, rgba(148, 163, 184, 0.7), transparent 55%),
          linear-gradient(180deg, #020617, #020617);
        border: 1px solid rgba(15, 23, 42, 0.98);
        box-shadow: inset 0 -2px 0 rgba(15, 23, 42, 0.95), 0 8px 12px rgba(15, 23, 42, 0.86);
        transform-origin: top center;
        cursor: pointer;
        transition: transform 0.03s ease-out, box-shadow 0.05s ease-out, background 0.12s ease-out;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding-bottom: 18px;
        z-index: 3;
      }

      .piano-key-black::before {
        content: attr(data-label);
        position: absolute;
        bottom: 3px;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 0.68rem;
        color: #e5e7eb;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.7);
        opacity: 0.92;
        transition: opacity 0.12s ease-out;
      }

      .piano-key-black.no-label::before {
        opacity: 0;
      }

      .piano-key-black.active {
        transform: translateY(2px);
        box-shadow: inset 0 -1px 0 rgba(15, 23, 42, 0.9), 0 4px 8px rgba(15, 23, 42, 0.95);
        background: radial-gradient(circle at 10% 0, #6b7280, transparent 45%),
          radial-gradient(circle at 80% 0, rgba(148, 163, 184, 0.9), transparent 55%),
          linear-gradient(180deg, #020617, #020617);
      }

      .piano-key-black.scale-note::after,
      .piano-key-black.chord-note::after {
        content: "";
        position: absolute;
        top: 9px;
        width: 16px;
        height: 16px;
        border-radius: 999px;
        border: 2px solid rgba(248, 250, 252, 0.98);
        box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.96);
      }

      .piano-key-black.scale-note::after {
        background: radial-gradient(circle at 30% 20%, rgba(56, 189, 248, 0.22), transparent 60%),
          linear-gradient(135deg, #22c55e, #22c55e);
      }

      .piano-key-black.chord-root::after {
        background: radial-gradient(circle at 30% 20%, rgba(249, 115, 22, 0.25), transparent 55%),
          linear-gradient(135deg, #fb923c, #f97316);
      }

      .piano-key-black.chord-note:not(.chord-root)::after {
        background: radial-gradient(circle at 30% 20%, rgba(251, 113, 133, 0.25), transparent 55%),
          linear-gradient(135deg, #f472b6, #fb7185);
      }

      .piano-keyboard-footer {
        margin-top: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.74rem;
        color: var(--text-muted);
      }

      .waveform-pills {
        display: inline-flex;
        gap: 4px;
        background: rgba(15, 23, 42, 0.96);
        border-radius: 999px;
        padding: 2px;
        border: 1px solid rgba(148, 163, 184, 0.55);
      }

      .wave-pill {
        padding: 2px 7px;
        border-radius: 999px;
        border: none;
        background: transparent;
        color: rgba(148, 163, 184, 0.9);
        font-size: 0.7rem;
        cursor: pointer;
      }

      .wave-pill.active {
        background: radial-gradient(circle at 10% 0, rgba(56, 189, 248, 0.9), transparent 60%),
          radial-gradient(circle at 90% 100%, rgba(59, 130, 246, 0.95), transparent 55%);
        color: rgba(15, 23, 42, 0.98);
        font-weight: 600;
        box-shadow: 0 0 0 1px rgba(248, 250, 252, 0.9);
      }

      .piano-led {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .piano-led-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: radial-gradient(circle, #22c55e 0, #16a34a 45%, #166534 100%);
        box-shadow: 0 0 10px rgba(22, 163, 74, 0.95);
      }

      .piano-led-label {
        letter-spacing: 0.16em;
        text-transform: uppercase;
      }

      /* Theory / explorer */
      .theory-tabs {
        display: inline-flex;
        gap: 4px;
        padding: 0;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.98);
        border: 1px solid rgba(148, 163, 184, 0.7);
      }

      .theory-tab {
        padding: 4px 10px;
        font-size: 0.76rem;
        color: rgba(148, 163, 184, 0.9);
        border-radius: 999px;
        cursor: pointer;
        border: none;
        background: transparent;
        white-space: nowrap;
      }

      .theory-tab.active {
        background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.95), transparent 60%),
          radial-gradient(circle at 100% 100%, rgba(129, 140, 248, 0.95), transparent 60%);
        color: rgba(15, 23, 42, 0.96);
        font-weight: 600;
        box-shadow: 0 0 0 1px rgba(248, 250, 252, 0.9);
      }

      .theory-grid {
        display: grid;
        grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.1fr);
        gap: 10px;
        margin-top: 4px;
      }

      .theory-selects {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 6px 8px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(15, 23, 42, 0.9);
      }

      .field-label {
        font-size: 0.74rem;
        color: var(--text-muted);
        margin-bottom: 1px;
      }

      .field-row {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .field-row .select {
        flex: 1;
      }

      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 4px;
      }

      .chip {
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 0.7rem;
        border: 1px solid rgba(148, 163, 184, 0.8);
        color: rgba(248, 250, 252, 0.95);
        background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.4), transparent 55%),
          rgba(15, 23, 42, 1);
        white-space: nowrap;
      }

      .chip.secondary {
        background: radial-gradient(circle at 0 0, rgba(167, 139, 250, 0.55), transparent 55%),
          rgba(15, 23, 42, 1);
      }

      .chip.muted {
        background: rgba(15, 23, 42, 0.9);
        color: rgba(148, 163, 184, 0.96);
      }

      .bullet-list {
        list-style: none;
        padding: 0;
        margin: 4px 0 0;
        font-size: 0.78rem;
        color: rgba(209, 213, 219, 0.96);
      }

      .bullet-list li {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 3px;
      }

      .bullet-dot {
        width: 4px;
        height: 4px;
        border-radius: 999px;
        margin-top: 6px;
        background: rgba(148, 163, 184, 0.9);
        flex-shrink: 0;
      }

      .bullet-label {
        font-weight: 500;
        color: rgba(248, 250, 252, 0.96);
      }

      .note-row {
        margin-top: 6px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }

      .note-pill {
        border-radius: 999px;
        padding: 3px 7px;
        font-size: 0.72rem;
        border: 1px solid rgba(148, 163, 184, 0.75);
        background: rgba(15, 23, 42, 0.9);
        color: rgba(248, 250, 252, 0.96);
      }

      .note-pill.degree {
        border-color: rgba(56, 189, 248, 0.9);
        background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.8), transparent 60%),
          rgba(15, 23, 42, 1);
      }

      .note-pill.root {
        border-color: rgba(251, 146, 60, 0.98);
        background: radial-gradient(circle at 0 0, rgba(251, 146, 60, 0.9), transparent 60%),
          rgba(15, 23, 42, 1);
      }

      .meter {
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.7rem;
        color: rgba(148, 163, 184, 0.95);
      }

      .meter-bar {
        flex: 1;
        height: 5px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 1);
        overflow: hidden;
        position: relative;
      }

      .meter-bar-fill {
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, #22c55e, #a3e635, #fbbf24, #f97316);
        transform-origin: left;
        transform: scaleX(0.5);
      }

      .callout {
        margin-top: 6px;
        padding: 6px 8px;
        border-radius: 10px;
        font-size: 0.72rem;
        background: rgba(15, 23, 42, 0.98);
        border: 1px solid rgba(148, 163, 184, 0.7);
        color: rgba(209, 213, 219, 0.96);
        display: flex;
        align-items: flex-start;
        gap: 6px;
      }

      .callout-icon {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, rgba(56, 189, 248, 0.9), transparent 65%);
        border: 1px solid rgba(248, 250, 252, 0.9);
        box-shadow: 0 0 10px rgba(56, 189, 248, 0.9);
        flex-shrink: 0;
        position: relative;
      }

      .callout-icon::before {
        content: "";
        position: absolute;
        top: 4px;
        left: 5px;
        width: 6px;
        height: 6px;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.9);
      }

      .callout-strong {
        font-weight: 600;
        color: rgba(248, 250, 252, 0.96);
      }

      /* Ear training */
      .ear-layout {
        display: flex;
        flex-direction: column;
        gap: 8px;
        height: 100%;
      }

      .ear-modes {
        display: inline-flex;
        gap: 4px;
        padding: 3px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.96);
        border: 1px solid rgba(148, 163, 184, 0.7);
      }

      .ear-mode {
        border-radius: 999px;
        padding: 3px 10px;
        border: none;
        background: transparent;
        color: rgba(148, 163, 184, 0.96);
        font-size: 0.76rem;
        cursor: pointer;
        white-space: nowrap;
      }

      .ear-mode.active {
        background: radial-gradient(circle at 0 0, rgba(251, 113, 133, 0.95), transparent 60%),
          radial-gradient(circle at 100% 100%, rgba(234, 179, 8, 0.95), transparent 60%);
        color: rgba(15, 23, 42, 0.98);
        font-weight: 600;
        box-shadow: 0 0 0 1px rgba(248, 250, 252, 0.9);
      }

      .ear-top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .ear-score {
        font-size: 0.78rem;
        color: rgba(209, 213, 219, 0.96);
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .ear-score-row {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .ear-badge {
        border-radius: 999px;
        padding: 2px 7px;
        font-size: 0.7rem;
        border: 1px solid rgba(148, 163, 184, 0.8);
        background: rgba(15, 23, 42, 0.96);
      }

      .ear-streak {
        width: 40px;
        height: 6px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 1);
        overflow: hidden;
        position: relative;
      }

      .ear-streak-fill {
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, #22c55e, #a3e635, #f97316);
        transform-origin: left;
        transform: scaleX(0);
      }

      .ear-main {
        flex: 1;
        min-height: 0;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.9));
        padding: 8px 10px 10px;
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 6px;
      }

      .ear-main-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .ear-prompt {
        font-size: 0.78rem;
        color: rgba(209, 213, 219, 0.96);
      }

      .ear-prompt strong {
        color: rgba(248, 250, 252, 0.98);
      }

      .ear-controls {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.9);
        background: rgba(15, 23, 42, 1);
        color: rgba(248, 250, 252, 0.98);
        padding: 4px 12px;
        font-size: 0.78rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: transform 0.06s ease-out, box-shadow 0.08s ease-out,
          background 0.12s ease-out, border-color 0.12s ease-out;
        white-space: nowrap;
      }

      .btn-primary {
        background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.95), transparent 60%),
          radial-gradient(circle at 100% 100%, rgba(59, 130, 246, 0.95), transparent 55%);
        border-color: rgba(248, 250, 252, 0.95);
        color: rgba(15, 23, 42, 0.98);
        font-weight: 600;
        box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.85), 0 8px 20px rgba(37, 99, 235, 0.7);
      }

      .btn-ghost {
        border-style: dashed;
        color: rgba(148, 163, 184, 0.96);
      }

      .btn-disabled {
        opacity: 0.45;
        cursor: not-allowed;
        box-shadow: none;
      }

      .btn:not(.btn-disabled):active {
        transform: translateY(1px);
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.9);
      }

      .btn-icon-pulse {
        width: 9px;
        height: 9px;
        border-radius: 999px;
        background: radial-gradient(circle, var(--accent) 0, #fb7185 40%, #7c3aed 100%);
        box-shadow: 0 0 10px rgba(251, 113, 133, 0.9);
      }

      .btn-icon-wave {
        width: 13px;
        height: 9px;
        border-radius: 999px;
        border: 1px solid rgba(248, 250, 252, 0.9);
        border-left-color: transparent;
        border-right-color: transparent;
      }

      .ear-options {
        border-radius: 10px;
        border: 1px dashed rgba(148, 163, 184, 0.75);
        padding: 7px 7px 5px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-content: flex-start;
      }

      .ear-option {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.9);
        padding: 3px 9px;
        font-size: 0.74rem;
        background: rgba(15, 23, 42, 1);
        color: rgba(248, 250, 252, 0.96);
        cursor: pointer;
      }

      .ear-option.correct {
        border-color: rgba(34, 197, 94, 0.98);
        background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.9), transparent 60%),
          rgba(15, 23, 42, 1);
      }

      .ear-option.incorrect {
        border-color: rgba(248, 113, 113, 0.98);
        background: radial-gradient(circle at 0 0, rgba(248, 113, 113, 0.9), transparent 60%),
          rgba(15, 23, 42, 1);
      }

      .ear-feedback {
        margin-top: 5px;
        border-radius: 10px;
        padding: 6px 7px;
        font-size: 0.74rem;
        display: flex;
        align-items: flex-start;
        gap: 6px;
        border: 1px solid rgba(148, 163, 184, 0.7);
        background: rgba(15, 23, 42, 0.96);
        color: rgba(209, 213, 219, 0.98);
      }

      .ear-feedback.good {
        border-color: rgba(22, 163, 74, 0.98);
        background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.35), transparent 65%),
          rgba(15, 23, 42, 0.98);
      }

      .ear-feedback.bad {
        border-color: rgba(248, 113, 113, 0.98);
        background: radial-gradient(circle at 0 0, rgba(248, 113, 113, 0.3), transparent 65%),
          rgba(15, 23, 42, 0.98);
      }

      .ear-feedback-icon {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        flex-shrink: 0;
        border: 1px solid rgba(248, 250, 252, 0.95);
        box-shadow: 0 0 10px rgba(248, 250, 252, 0.85);
      }

      .ear-feedback.good .ear-feedback-icon {
        background: radial-gradient(circle, #22c55e 0, #4ade80 45%, #bbf7d0 100%);
      }

      .ear-feedback.bad .ear-feedback-icon {
        background: radial-gradient(circle, #f97373 0, #fecaca 45%, #fee2e2 100%);
      }

      .ear-feedback-body strong {
        color: rgba(248, 250, 252, 0.98);
      }

      .ear-mini-tips {
        margin-top: 4px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }

      .ear-mini-tip {
        border-radius: 999px;
        border: 1px dashed rgba(148, 163, 184, 0.65);
        padding: 2px 7px;
        font-size: 0.7rem;
        color: rgba(148, 163, 184, 0.96);
      }

      footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.7rem;
        color: rgba(148, 163, 184, 0.96);
        padding-top: 7px;
        border-top: 1px solid var(--border-subtle);
        margin-top: 6px;
      }

      .footer-left {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .footer-led {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: radial-gradient(circle, #22c55e 0, #16a34a 45%, #166534 100%);
        box-shadow: 0 0 12px rgba(16, 185, 129, 0.9);
      }

      .footer-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .footer-tag {
        padding: 2px 7px;
        border-radius: 999px;
        border: 1px dashed rgba(148, 163, 184, 0.75);
      }

      .footer-marks {
        display: flex;
        gap: 3px;
      }

      .footer-mark {
        width: 3px;
        height: 9px;
        border-radius: 999px;
        background: linear-gradient(to top, #f97316, #fb7185, #6366f1);
      }

      @media (max-width: 980px) {
        .app-shell {
          max-height: none;
        }
        main {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto;
        }
      }

      @media (max-width: 720px) {
        body {
          padding: 12px;
        }
        .app-shell {
          border-radius: 20px;
          padding: 16px 14px 14px;
        }
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        .header-right {
          align-items: flex-start;
        }
        .piano-keyboard {
          height: 150px;
        }
      }

      @media (max-width: 520px) {
        .piano-top {
          flex-direction: column;
          align-items: flex-start;
        }
        .ear-top-row {
          flex-direction: column;
          align-items: flex-start;
        }
        .ear-main-top {
          flex-direction: column;
          align-items: flex-start;
        }
        .theory-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header>
        <div class="logo-lockup">
          <div class="logo-inner">
            <div class="logo-staff"></div>
            <div class="logo-note"></div>
            <div class="logo-glow"></div>
          </div>
        </div>
        <div class="header-text">
          <div class="title">
            <h1>Music Theory Trainer</h1>
            <span class="title-badge">Interactive Ear &amp; Keyboard Lab</span>
          </div>
          <p class="subtitle">
            Explore notes, build scales &amp; chords, and sharpen your ear on a responsive virtual piano.
          </p>
        </div>
        <div class="header-right">
          <div class="pill-group">
            <div class="pill accent">Ear Training</div>
            <div class="pill">Scales</div>
            <div class="pill">Chords</div>
          </div>
          <div class="header-meta">
            Session difficulty:
            <strong id="difficulty-label">Smart adaptive</strong>
          </div>
        </div>
      </header>

      <main>
        <section class="panel" aria-label="Interactive piano and theory explorer">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                <span class="panel-title-dot"></span>
                <span>Interactive Piano</span>
              </div>
              <div class="panel-subtitle">Tap keys, visualize scales &amp; chords in real time.</div>
            </div>
            <div class="panel-tabs" aria-label="Theory view">
              <button class="panel-tab active" data-view="scale">Scales</button>
              <button class="panel-tab" data-view="chord">Chords</button>
              <button class="panel-tab" data-view="interval">Intervals</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="piano-wrapper">
              <div class="piano-top">
                <div class="piano-status">
                  <div class="piano-status-line">
                    <span class="status-pill">
                      Live note:
                      <span id="current-note-label">–</span>
                    </span>
                    <span class="status-pill">
                      Frequency:
                      <span id="current-frequency-label">–</span>
                    </span>
                  </div>
                  <div class="piano-status-line" style="font-size: 0.72rem; color: var(--text-muted)">
                    Click or use your computer keyboard (A–K, W–E) to play notes.
                  </div>
                </div>
                <div class="piano-controls">
                  <select id="octave-select" class="select" aria-label="Piano octave">
                    <option value="3">Octave 3</option>
                    <option value="4" selected>Octave 4</option>
                    <option value="5">Octave 5</option>
                  </select>
                  <button
                    id="note-label-toggle"
                    class="toggle-button on"
                    type="button"
                    aria-pressed="true"
                  >
                    <span class="toggle-button-dot"></span>
                    Key labels
                  </button>
                </div>
              </div>

              <div class="piano-keyboard-shell">
                <div id="piano" class="piano-keyboard" aria-label="Virtual piano"></div>
                <div class="piano-keyboard-footer">
                  <div class="piano-led">
                    <span class="piano-led-dot"></span>
                    <span class="piano-led-label">Audio Engine Ready</span>
                  </div>
                  <div class="waveform-pills" aria-label="Waveform">
                    <button class="wave-pill active" data-wave="sine">Sine</button>
                    <button class="wave-pill" data-wave="triangle">Triangle</button>
                    <button class="wave-pill" data-wave="square">Square</button>
                    <button class="wave-pill" data-wave="sawtooth">Saw</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="panel-scroll">
              <div class="theory-grid" aria-label="Music theory explorer">
                <div class="theory-selects">
                  <div class="field-row">
                    <div style="flex: 1">
                      <div class="field-label">Root note</div>
                      <select id="root-select" class="select">
                        <option value="C">C</option>
                        <option value="C#">C♯ / D♭</option>
                        <option value="D">D</option>
                        <option value="D#">D♯ / E♭</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="F#">F♯ / G♭</option>
                        <option value="G">G</option>
                        <option value="G#">G♯ / A♭</option>
                        <option value="A">A</option>
                        <option value="A#">A♯ / B♭</option>
                        <option value="B">B</option>
                      </select>
                    </div>
                    <div style="flex: 1">
                      <div class="field-label">Scale</div>
                      <select id="scale-select" class="select">
                        <option value="major">Major (Ionian)</option>
                        <option value="naturalMinor">Natural minor (Aeolian)</option>
                        <option value="harmonicMinor">Harmonic minor</option>
                        <option value="melodicMinor">Melodic minor</option>
                        <option value="majorPentatonic">Major pentatonic</option>
                        <option value="minorPentatonic">Minor pentatonic</option>
                        <option value="dorian">Dorian</option>
                        <option value="mixolydian">Mixolydian</option>
                        <option value="lydian">Lydian</option>
                      </select>
                    </div>
                  </div>
                  <div class="field-row">
                    <div style="flex: 1">
                      <div class="field-label">Chord quality</div>
                      <select id="chord-select" class="select">
                        <option value="major">Major triad</option>
                        <option value="minor">Minor triad</option>
                        <option value="diminished">Diminished</option>
                        <option value="augmented">Augmented</option>
                        <option value="maj7">Major 7</option>
                        <option value="min7">Minor 7</option>
                        <option value="dom7">Dominant 7</option>
                        <option value="sus2">Sus2</option>
                        <option value="sus4">Sus4</option>
                      </select>
                    </div>
                    <button id="play-voicing-btn" type="button" class="btn btn-ghost">
                      <span class="btn-icon-wave"></span>
                      Play voicing
                    </button>
                  </div>
                  <div class="chip-row" id="scale-chips-row"></div>
                </div>

                <div>
                  <ul class="bullet-list" id="theory-facts-list"></ul>
                  <div class="note-row" id="degrees-row"></div>
                  <div class="meter" aria-label="Tension meter">
                    <span>Color:</span>
                    <div class="meter-bar">
                      <div id="tension-meter" class="meter-bar-fill"></div>
                    </div>
                    <span id="tension-label">Balanced</span>
                  </div>
                  <div class="callout" id="teaching-callout">
                    <div class="callout-icon"></div>
                    <div>
                      <div class="callout-strong" id="callout-title">Welcome to your theory cockpit.</div>
                      <div id="callout-body">
                        Choose a root, scale, and chord quality to highlight notes on the keyboard and see how
                        everything fits together.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="panel" aria-label="Ear training trainer">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                <span class="panel-title-dot"></span>
                <span>Ear Training Lab</span>
              </div>
              <div class="panel-subtitle">
                Listen, guess, and learn with adaptive single-note, interval, and chord drills.
              </div>
            </div>
            <div class="ear-modes" aria-label="Training mode">
              <button class="ear-mode active" data-mode="note">Single notes</button>
              <button class="ear-mode" data-mode="interval">Intervals</button>
              <button class="ear-mode" data-mode="chord">Chords</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="ear-layout">
              <div class="ear-top-row">
                <div class="ear-score">
                  <div class="ear-score-row">
                    <span class="ear-badge">
                      Score:
                      <span id="score-correct">0</span>/<span id="score-total">0</span>
                    </span>
                    <span class="ear-badge">
                      Accuracy:
                      <span id="score-accuracy">–</span>
                    </span>
                  </div>
                  <div class="ear-score-row">
                    <span style="font-size: 0.7rem; color: rgba(148, 163, 184, 0.96)">
                      Streak:
                      <strong id="streak-count">0</strong>
                    </span>
                    <div class="ear-streak">
                      <div id="streak-bar" class="ear-streak-fill"></div>
                    </div>
                  </div>
                </div>
                <div class="ear-controls">
                  <select id="difficulty-select" class="select" aria-label="Difficulty">
                    <option value="easy">Easy</option>
                    <option value="medium" selected>Medium</option>
                    <option value="hard">Hard</option>
                  </select>
                  <button id="repeat-question-btn" class="btn btn-ghost btn-disabled" type="button">
                    <span class="btn-icon-wave"></span>
                    Repeat
                  </button>
                  <button id="new-question-btn" class="btn btn-primary" type="button">
                    <span class="btn-icon-pulse"></span>
                    New question
                  </button>
                </div>
              </div>

              <div class="ear-main">
                <div class="ear-main-top">
                  <div class="ear-prompt" id="ear-prompt">
                    Press “New question” to start a listening challenge.
                  </div>
                  <div class="ear-mini-tips" id="ear-mini-tips">
                    <span class="ear-mini-tip">Tip: Hum along before answering.</span>
                    <span class="ear-mini-tip">Use the piano to check your guess.</span>
                  </div>
                </div>

                <div>
                  <div class="ear-options" id="ear-options" aria-label="Answer choices"></div>
                  <div class="ear-feedback" id="ear-feedback" style="display: none">
                    <div class="ear-feedback-icon"></div>
                    <div class="ear-feedback-body">
                      <strong id="ear-feedback-title"></strong>
                      <span id="ear-feedback-body"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>

      <footer>
        <div class="footer-left">
          <span class="footer-led"></span>
          <span>Web Audio engine: <strong>On</strong> · Best wearing headphones.</span>
        </div>
        <div class="footer-right">
          <span class="footer-tag">Practice path: <strong id="footer-path-label">Balanced</strong></span>
          <div class="footer-marks" aria-hidden="true">
            <div class="footer-mark"></div>
            <div class="footer-mark"></div>
            <div class="footer-mark"></div>
          </div>
        </div>
      </footer>
    </div>

    <script>
      (function () {
        const NOTE_NAMES = [
          "C",
          "C#",
          "D",
          "D#",
          "E",
          "F",
          "F#",
          "G",
          "G#",
          "A",
          "A#",
          "B"
        ];

        const SCALES = {
          major: {
            name: "Major scale",
            intervals: [0, 2, 4, 5, 7, 9, 11],
            degrees: ["I", "II", "III", "IV", "V", "VI", "VII"],
            flavor: "bright",
            description: "The foundation of tonal music. Bright, stable, and singable."
          },
          naturalMinor: {
            name: "Natural minor",
            intervals: [0, 2, 3, 5, 7, 8, 10],
            degrees: ["i", "ii°", "III", "iv", "v", "VI", "VII"],
            flavor: "dark",
            description: "A moodier cousin of the major scale with a flattened 3rd, 6th, and 7th."
          },
          harmonicMinor: {
            name: "Harmonic minor",
            intervals: [0, 2, 3, 5, 7, 8, 11],
            degrees: ["i", "ii°", "III+", "iv", "V", "VI", "vii°"],
            flavor: "dramatic",
            description: "Raises the 7th degree to create a strong pull back to the tonic."
          },
          melodicMinor: {
            name: "Melodic minor (ascending)",
            intervals: [0, 2, 3, 5, 7, 9, 11],
            degrees: ["i", "ii", "III+", "IV", "V", "vi°", "vii°"],
            flavor: "sophisticated",
            description: "Minor with a smoother melodic shape — key to jazz harmony."
          },
          majorPentatonic: {
            name: "Major pentatonic",
            intervals: [0, 2, 4, 7, 9],
            degrees: ["1", "2", "3", "5", "6"],
            flavor: "open",
            description: "A five-note scale with no half-steps — nearly impossible to sound wrong."
          },
          minorPentatonic: {
            name: "Minor pentatonic",
            intervals: [0, 3, 5, 7, 10],
            degrees: ["1", "♭3", "4", "5", "♭7"],
            flavor: "bluesy",
            description: "The go-to scale for rock and blues solos."
          },
          dorian: {
            name: "Dorian mode",
            intervals: [0, 2, 3, 5, 7, 9, 10],
            degrees: ["1", "2", "♭3", "4", "5", "6", "♭7"],
            flavor: "cool",
            description: "Minor with a raised 6th — a favorite in jazz and funk."
          },
          mixolydian: {
            name: "Mixolydian mode",
            intervals: [0, 2, 4, 5, 7, 9, 10],
            degrees: ["1", "2", "3", "4", "5", "6", "♭7"],
            flavor: "dominant",
            description: "Major with a flattened 7th — perfect for dominant chords and riffs."
          },
          lydian: {
            name: "Lydian mode",
            intervals: [0, 2, 4, 6, 7, 9, 11],
            degrees: ["1", "2", "3", "#4", "5", "6", "7"],
            flavor: "floating",
            description: "Major with a raised 4th — dreamy and expansive."
          }
        };

        const CHORDS = {
          major: {
            name: "Major triad",
            intervals: [0, 4, 7],
            description: "Built from root, major 3rd, and perfect 5th. Sounds stable and resolved."
          },
          minor: {
            name: "Minor triad",
            intervals: [0, 3, 7],
            description: "Root, minor 3rd, and perfect 5th. Darker but still consonant."
          },
          diminished: {
            name: "Diminished triad",
            intervals: [0, 3, 6],
            description: "Stacked minor 3rds. Tense and unstable, usually wants to resolve."
          },
          augmented: {
            name: "Augmented triad",
            intervals: [0, 4, 8],
            description: "Two major 3rds. Mysterious and open-ended."
          },
          maj7: {
            name: "Major 7",
            intervals: [0, 4, 7, 11],
            description: "Major triad + major 7th. Lush and dreamy."
          },
          min7: {
            name: "Minor 7",
            intervals: [0, 3, 7, 10],
            description: "Minor triad + minor 7th. Relaxed and soulful."
          },
          dom7: {
            name: "Dominant 7",
            intervals: [0, 4, 7, 10],
            description: "Major triad + minor 7th. Full of forward motion and tension."
          },
          sus2: {
            name: "Sus2",
            intervals: [0, 2, 7],
            description: "Replaces the 3rd with the 2nd. Open and unresolved."
          },
          sus4: {
            name: "Sus4",
            intervals: [0, 5, 7],
            description: "Replaces the 3rd with the 4th. Wants to fall back to a major triad."
          }
        };

        const INTERVALS = [
          { semitones: 0, name: "Unison" },
          { semitones: 1, name: "Minor 2nd" },
          { semitones: 2, name: "Major 2nd" },
          { semitones: 3, name: "Minor 3rd" },
          { semitones: 4, name: "Major 3rd" },
          { semitones: 5, name: "Perfect 4th" },
          { semitones: 6, name: "Tritone" },
          { semitones: 7, name: "Perfect 5th" },
          { semitones: 8, name: "Minor 6th" },
          { semitones: 9, name: "Major 6th" },
          { semitones: 10, name: "Minor 7th" },
          { semitones: 11, name: "Major 7th" },
          { semitones: 12, name: "Octave" }
        ];

        function noteNameToIndex(name) {
          const simple = name.replace("♯", "#").replace("♭", "b");
          let idx = NOTE_NAMES.indexOf(simple);
          if (idx !== -1) return idx;
          if (simple.endsWith("b")) {
            const base = simple[0];
            const sharp = base + "#";
            const sharpIndex = NOTE_NAMES.indexOf(sharp);
            if (sharpIndex !== -1) return (sharpIndex + 11) % 12;
          }
          return 0;
        }

        function midiToFreq(midi) {
          return 440 * Math.pow(2, (midi - 69) / 12);
        }

        function pitchToLabel(midi) {
          const note = NOTE_NAMES[midi % 12];
          const octave = Math.floor(midi / 12) - 1;
          return note + octave;
        }

        let audioContext = null;
        let currentWave = "sine";

        function ensureAudioContext() {
          if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
          } else if (audioContext.state === "suspended" && audioContext.resume) {
            audioContext.resume();
          }
        }

        function playTone(frequency, durationMs, options) {
          ensureAudioContext();
          const ctx = audioContext;
          if (!ctx) return;
          const now = ctx.currentTime;
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          osc.type = options && options.wave ? options.wave : currentWave;
          osc.frequency.value = frequency;

          const attack = (options && options.attack) || 0.01;
          const decay = (options && options.decay) || 0.18;
          const sustain = options && typeof options.sustain === "number" ? options.sustain : 0.7;
          const release = (options && options.release) || 0.18;
          const totalTime = durationMs / 1000;
          const maxGain = (options && options.volume) || 0.18;

          gain.gain.cancelScheduledValues(now);
          gain.gain.setValueAtTime(0.0001, now);
          gain.gain.exponentialRampToValueAtTime(maxGain, now + attack);
          gain.gain.exponentialRampToValueAtTime(maxGain * sustain, now + attack + decay);
          gain.gain.exponentialRampToValueAtTime(
            0.0001,
            now + Math.max(totalTime - release, attack + decay + 0.02)
          );

          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start(now);
          osc.stop(now + totalTime + release + 0.05);
        }

        function playChord(frequencies, options) {
          const baseDuration = (options && options.durationMs) || 1200;
          const wave = (options && options.wave) || currentWave;
          const spread = (options && options.spread) || 0;
          const delayStep = spread > 0 ? spread / frequencies.length : 0;
          frequencies.forEach((freq, i) => {
            setTimeout(() => {
              playTone(freq, baseDuration, {
                wave,
                attack: 0.02,
                decay: 0.24,
                sustain: 0.6,
                release: 0.32,
                volume: 0.12 + i * 0.02
              });
            }, delayStep * i);
          });
        }

        const pianoEl = document.getElementById("piano");
        const octaveSelect = document.getElementById("octave-select");
        const noteLabelToggleBtn = document.getElementById("note-label-toggle");
        const currentNoteLabel = document.getElementById("current-note-label");
        const currentFrequencyLabel = document.getElementById("current-frequency-label");
        const wavePills = Array.from(document.querySelectorAll(".wave-pill"));

        const rootSelect = document.getElementById("root-select");
        const scaleSelect = document.getElementById("scale-select");
        const chordSelect = document.getElementById("chord-select");
        const playVoicingBtn = document.getElementById("play-voicing-btn");
        const scaleChipsRow = document.getElementById("scale-chips-row");
        const theoryFactsList = document.getElementById("theory-facts-list");
        const degreesRow = document.getElementById("degrees-row");
        const tensionMeter = document.getElementById("tension-meter");
        const tensionLabel = document.getElementById("tension-label");
        const teachingCallout = document.getElementById("teaching-callout");
        const calloutTitle = document.getElementById("callout-title");
        const calloutBody = document.getElementById("callout-body");

        const panelTabs = Array.from(document.querySelectorAll(".panel-tab"));

        const earModes = Array.from(document.querySelectorAll(".ear-mode"));
        const difficultySelect = document.getElementById("difficulty-select");
        const difficultyLabel = document.getElementById("difficulty-label");
        const newQuestionBtn = document.getElementById("new-question-btn");
        const repeatQuestionBtn = document.getElementById("repeat-question-btn");
        const earPrompt = document.getElementById("ear-prompt");
        const earOptions = document.getElementById("ear-options");
        const earFeedback = document.getElementById("ear-feedback");
        const earFeedbackTitle = document.getElementById("ear-feedback-title");
        const earFeedbackBody = document.getElementById("ear-feedback-body");
        const earMiniTips = document.getElementById("ear-mini-tips");
        const scoreCorrectEl = document.getElementById("score-correct");
        const scoreTotalEl = document.getElementById("score-total");
        const scoreAccuracyEl = document.getElementById("score-accuracy");
        const streakCountEl = document.getElementById("streak-count");
        const streakBarEl = document.getElementById("streak-bar");
        const footerPathLabel = document.getElementById("footer-path-label");

        const KEYBOARD_MAP = {
          a: 0,
          w: 1,
          s: 2,
          e: 3,
          d: 4,
          f: 5,
          t: 6,
          g: 7,
          y: 8,
          h: 9,
          u: 10,
          j: 11,
          k: 12
        };

        let pianoKeys = [];
        let labelsVisible = true;

        function buildKeyboard() {
          pianoEl.innerHTML = "";
          pianoKeys = [];

          const whiteKeyPositions = [0, 2, 4, 5, 7, 9, 11];
          const keyWidthPercent = 100 / whiteKeyPositions.length;

          whiteKeyPositions.forEach((noteOffset, whiteIndex) => {
            const whiteKey = document.createElement("button");
            whiteKey.className = "piano-key-white";
            whiteKey.dataset.noteOffset = String(noteOffset);
            whiteKey.dataset.whiteIndex = String(whiteIndex);
            whiteKey.dataset.label = NOTE_NAMES[noteOffset];
            whiteKey.setAttribute("aria-label", NOTE_NAMES[noteOffset]);
            pianoEl.appendChild(whiteKey);
            whiteKey.style.width = keyWidthPercent + "%";

            whiteKey.addEventListener("mousedown", () =>
              triggerNoteFromOffset(noteOffset + getOctaveBaseOffset())
            );
            whiteKey.addEventListener("mouseup", () => setKeyActive(whiteKey, false));
            whiteKey.addEventListener("mouseleave", () => setKeyActive(whiteKey, false));

            pianoKeys.push({ element: whiteKey, noteOffset, isBlack: false });
          });

          const blackOffsets = [1, 3, 6, 8, 10];
          const positions = [0.65, 1.65, 3.7, 4.75, 5.75];

          blackOffsets.forEach((noteOffset, idx) => {
            const blackKey = document.createElement("button");
            blackKey.className = "piano-key-black";
            blackKey.dataset.noteOffset = String(noteOffset);
            blackKey.dataset.label = NOTE_NAMES[noteOffset];
            blackKey.setAttribute("aria-label", NOTE_NAMES[noteOffset]);

            const whiteKeyWidth = pianoEl.clientWidth / whiteKeyPositions.length || 1;
            const leftPercent = (positions[idx] * whiteKeyWidth * 100) / pianoEl.clientWidth;
            blackKey.style.left = leftPercent + "%";

            pianoEl.appendChild(blackKey);

            blackKey.addEventListener("mousedown", () =>
              triggerNoteFromOffset(noteOffset + getOctaveBaseOffset())
            );
            blackKey.addEventListener("mouseup", () => setKeyActive(blackKey, false));
            blackKey.addEventListener("mouseleave", () => setKeyActive(blackKey, false));

            pianoKeys.push({ element: blackKey, noteOffset, isBlack: true });
          });
        }

        function getOctaveBaseOffset() {
          const octave = parseInt(octaveSelect.value, 10);
          return (octave + 1) * 12;
        }

        function triggerNoteFromOffset(midi) {
          const freq = midiToFreq(midi);
          const label = pitchToLabel(midi);
          currentNoteLabel.textContent = label;
          currentFrequencyLabel.textContent = freq.toFixed(1) + " Hz";

          const noteIndex = midi % 12;
          const localOffset = noteIndex;

          pianoKeys.forEach((key) => {
            const noteOffsetAbs = key.noteOffset + getOctaveBaseOffset();
            const isTarget = noteOffsetAbs === midi;
            setKeyActive(key.element, isTarget);
          });

          playTone(freq, 700, { wave: currentWave });

          setTimeout(() => {
            pianoKeys.forEach((key) => setKeyActive(key.element, false));
          }, 160);
        }

        function setKeyActive(el, active) {
          if (!el) return;
          if (active) el.classList.add("active");
          else el.classList.remove("active");
        }

        function setLabelsVisible(visible) {
          labelsVisible = visible;
          pianoKeys.forEach((key) => {
            if (key.isBlack) {
              key.element.classList.toggle("no-label", !visible);
            } else {
              key.element.classList.toggle("no-label", !visible);
            }
          });
        }

        window.addEventListener("keydown", (e) => {
          if (e.repeat) return;
          const key = e.key.toLowerCase();
          if (!Object.prototype.hasOwnProperty.call(KEYBOARD_MAP, key)) return;
          e.preventDefault();
          const offset = KEYBOARD_MAP[key];
          triggerNoteFromOffset(offset + getOctaveBaseOffset());
        });

        noteLabelToggleBtn.addEventListener("click", () => {
          const willBeOn = !labelsVisible;
          setLabelsVisible(willBeOn);
          noteLabelToggleBtn.classList.toggle("on", willBeOn);
          noteLabelToggleBtn.setAttribute("aria-pressed", String(willBeOn));
        });

        wavePills.forEach((pill) => {
          pill.addEventListener("click", () => {
            wavePills.forEach((p) => p.classList.remove("active"));
            pill.classList.add("active");
            currentWave = pill.dataset.wave || "sine";
          });
        });

        octaveSelect.addEventListener("change", () => {
          highlightScaleAndChord();
        });

        rootSelect.addEventListener("change", () => {
          highlightScaleAndChord();
          updateTheorySidebar();
        });

        scaleSelect.addEventListener("change", () => {
          highlightScaleAndChord();
          updateTheorySidebar();
        });

        chordSelect.addEventListener("change", () => {
          highlightScaleAndChord();
          updateTheorySidebar();
        });

        playVoicingBtn.addEventListener("click", () => {
          const rootName = rootSelect.value;
          const chordId = chordSelect.value;
          const chord = CHORDS[chordId];
          const rootIndex = noteNameToIndex(rootName);
          const baseMidi = getOctaveBaseOffset() + rootIndex;
          const freqs = chord.intervals.map((st, i) => midiToFreq(baseMidi + st + (i >= 3 ? 12 : 0)));
          playChord(freqs, { durationMs: 1400, spread: 90 });
        });

        panelTabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            panelTabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            updateTheorySidebar();
          });
        });

        function highlightScaleAndChord() {
          pianoKeys.forEach((key) => {
            key.element.classList.remove(
              "scale-note",
              "chord-note",
              "chord-root"
            );
          });

          const rootIndex = noteNameToIndex(rootSelect.value);
          const scaleDef = SCALES[scaleSelect.value];
          const chordDef = CHORDS[chordSelect.value];
          const octaveBase = getOctaveBaseOffset();

          if (scaleDef) {
            const scaleSet = new Set(
              scaleDef.intervals.map((st) => (rootIndex + st + 12) % 12)
            );
            pianoKeys.forEach((key) => {
              const absIdx = (key.noteOffset + 12) % 12;
              if (scaleSet.has(absIdx)) {
                key.element.classList.add("scale-note");
              }
            });
          }

          if (chordDef) {
            const chordNotes = chordDef.intervals.map((st) => (rootIndex + st + 12) % 12);
            pianoKeys.forEach((key) => {
              const absIdx = (key.noteOffset + 12) % 12;
              const isRoot = absIdx === rootIndex;
              if (chordNotes.includes(absIdx)) {
                key.element.classList.add("chord-note");
                if (isRoot) key.element.classList.add("chord-root");
              }
            });
          }
        }

        function describeFlavor(flavor) {
          if (flavor === "bright") return "Bright & settled";
          if (flavor === "dark") return "Darker & introspective";
          if (flavor === "dramatic") return "Dramatic & tense";
          if (flavor === "sophisticated") return "Sophisticated & jazzy";
          if (flavor === "open") return "Open & spacious";
          if (flavor === "bluesy") return "Bluesy & expressive";
          if (flavor === "cool") return "Cool & grooving";
          if (flavor === "dominant") return "Dominant & driving";
          if (flavor === "floating") return "Floating & colorful";
          return "Balanced";
        }

        function tensionLevel(scaleId, chordId) {
          let level = 0.5;
          const highTensionScales = ["harmonicMinor", "melodicMinor", "dorian", "mixolydian", "lydian"];
          const lowTensionScales = ["major", "majorPentatonic", "minorPentatonic"];
          const highTensionChords = ["diminished", "augmented", "dom7"];
          const lowTensionChords = ["major", "minor", "maj7", "min7"];

          if (highTensionScales.includes(scaleId)) level += 0.12;
          if (lowTensionScales.includes(scaleId)) level -= 0.08;
          if (highTensionChords.includes(chordId)) level += 0.18;
          if (lowTensionChords.includes(chordId)) level -= 0.1;

          return Math.max(0.05, Math.min(0.98, level));
        }

        function updateTheorySidebar() {
          const view = panelTabs.find((t) => t.classList.contains("active"))?.dataset.view || "scale";
          const rootName = rootSelect.value;
          const scaleId = scaleSelect.value;
          const chordId = chordSelect.value;
          const scaleDef = SCALES[scaleId];
          const chordDef = CHORDS[chordId];
          const rootIdx = noteNameToIndex(rootName);

          scaleChipsRow.innerHTML = "";
          theoryFactsList.innerHTML = "";
          degreesRow.innerHTML = "";

          const scaleNotes = (scaleDef?.intervals || []).map((st) => NOTE_NAMES[(rootIdx + st + 12) % 12]);
          const chordNotes = (chordDef?.intervals || []).map((st) => NOTE_NAMES[(rootIdx + st + 12) % 12]);

          const scaleChip = document.createElement("div");
          scaleChip.className = "chip";
          scaleChip.textContent = rootName + " " + (scaleDef ? scaleDef.name : "");
          scaleChipsRow.appendChild(scaleChip);

          const chordChip = document.createElement("div");
          chordChip.className = "chip secondary";
          chordChip.textContent = rootName + " " + (chordDef ? chordDef.name : "");
          scaleChipsRow.appendChild(chordChip);

          const flavorChip = document.createElement("div");
          flavorChip.className = "chip muted";
          flavorChip.textContent = describeFlavor(scaleDef?.flavor);
          scaleChipsRow.appendChild(flavorChip);

          function addFact(label, text) {
            const li = document.createElement("li");
            const dot = document.createElement("div");
            dot.className = "bullet-dot";
            const body = document.createElement("div");
            const strong = document.createElement("span");
            strong.className = "bullet-label";
            strong.textContent = label + ": ";
            body.appendChild(strong);
            body.appendChild(document.createTextNode(text));
            li.appendChild(dot);
            li.appendChild(body);
            theoryFactsList.appendChild(li);
          }

          if (view === "scale") {
            addFact(
              "Scale degrees",
              scaleNotes
                .map((note, i) => (scaleDef?.degrees?.[i] || i + 1) + " → " + note)
                .join(" · ")
            );
            addFact(
              "Color",
              describeFlavor(scaleDef?.flavor) +
                " – listen for the 3rd and 7th to hear its personality."
            );
            addFact("Tip", "Play the root, then step through the scale slowly, singing along.");
          } else if (view === "chord") {
            addFact(
              "Chord tones",
              chordNotes.map((n, i) => (i === 0 ? "Root " + n : n)).join(" · ")
            );
            addFact(
              "Function",
              chordDef
                ? chordDef.description
                : "Use this chord to support melodies built from the current scale."
            );
            addFact(
              "Voicing idea",
              "Try arpeggiating the chord from the lowest note to highest, then playing it as a block."
            );
          } else if (view === "interval") {
            const thirdInterval = INTERVALS.find((i) => i.semitones === (scaleDef?.intervals?.[2] || 4));
            const seventhInterval = INTERVALS.find(
              (i) => i.semitones === (scaleDef?.intervals?.[6] || 11)
            );
            addFact(
              "Key intervals",
              (thirdInterval ? thirdInterval.name : "3rd") +
                " & " +
                (seventhInterval ? seventhInterval.name : "7th") +
                " define the scale's character."
            );
            addFact(
              "Ear focus",
              "Practice hearing the distance from the root to the 3rd and 7th – they tell your ear if it's major, minor, or modal."
            );
            addFact(
              "Interval trick",
              "Anchor on familiar songs: perfect 5th for a 'Twinkle' opening, tritone for tension in film scores."
            );
          }

          scaleNotes.forEach((note, i) => {
            const pill = document.createElement("div");
            pill.className = "note-pill degree";
            pill.textContent = (scaleDef?.degrees?.[i] || i + 1) + " · " + note;
            if (i === 0) pill.classList.add("root");
            degreesRow.appendChild(pill);
          });

          const tension = tensionLevel(scaleId, chordId);
          tensionMeter.style.transform = "scaleX(" + tension.toFixed(2) + ")";
          let label = "Balanced";
          if (tension < 0.4) label = "Relaxed";
          else if (tension > 0.75) label = "High tension";
          else if (tension > 0.55) label = "Forward-moving";
          tensionLabel.textContent = label;
          footerPathLabel.textContent = label;

          if (view === "scale") {
            calloutTitle.textContent = "Hear how the scale frames the melody.";
            calloutBody.textContent =
              "Play the root, then walk through each degree. Notice which notes feel like 'home' and which want to move.";
          } else if (view === "chord") {
            calloutTitle.textContent = "Stacked thirds build chords from scales.";
            calloutBody.textContent =
              "If you take every other note from the scale starting on the root, you get this chord. Try it across the keyboard.";
          } else {
            calloutTitle.textContent = "Intervals are the DNA of melody.";
            calloutBody.textContent =
              "Train your ear to recognise the distance between two notes. The same intervals appear inside scales and chords.";
          }
        }

        const earState = {
          mode: "note",
          difficulty: "medium",
          question: null,
          canAnswer: false,
          scoreCorrect: 0,
          scoreTotal: 0,
          streak: 0
        };

        function setMode(mode) {
          earState.mode = mode;
          earModes.forEach((btn) => btn.classList.toggle("active", btn.dataset.mode === mode));
          let prompt = "";
          let tips = [];
          if (mode === "note") {
            prompt = "I’ll play a single note. Identify it by name.";
            tips = [
              "Use the keyboard to find the pitch.",
              "Compare up or down from a reference like C."
            ];
          } else if (mode === "interval") {
            prompt = "I’ll play two notes. Identify the interval between them.";
            tips = ["Listen for familiar songs using each interval.", "Notice how wide or narrow the jump feels."];
          } else {
            prompt = "I’ll play a chord. Identify its quality.";
            tips = [
              "Listen for major (happy), minor (sad), or tense qualities.",
              "Focus on how the 3rd and 7th sound."
            ];
          }
          earPrompt.textContent = prompt;
          earMiniTips.innerHTML = "";
          tips.forEach((t) => {
            const tipEl = document.createElement("span");
            tipEl.className = "ear-mini-tip";
            tipEl.textContent = t;
            earMiniTips.appendChild(tipEl);
          });
          clearQuestionFeedback();
        }

        difficultySelect.addEventListener("change", () => {
          earState.difficulty = difficultySelect.value;
          const label =
            earState.difficulty === "easy"
              ? "Gentle"
              : earState.difficulty === "hard"
              ? "Challenge"
              : "Smart adaptive";
          difficultyLabel.textContent = label;
          clearQuestionFeedback();
        });

        earModes.forEach((btn) => {
          btn.addEventListener("click", () => {
            const mode = btn.dataset.mode || "note";
            setMode(mode);
          });
        });

        function difficultyPool() {
          const rootIdx = noteNameToIndex(rootSelect.value);
          let notes = [];
          if (earState.mode === "note") {
            if (earState.difficulty === "easy") {
              notes = ["C", "D", "E", "G", "A"];
            } else if (earState.difficulty === "hard") {
              notes = NOTE_NAMES.slice();
            } else {
              const scaleDef = SCALES[scaleSelect.value];
              if (scaleDef) {
                notes = scaleDef.intervals
                  .map((st) => NOTE_NAMES[(rootIdx + st + 12) % 12])
                  .slice(0, 7);
              } else {
                notes = NOTE_NAMES.slice();
              }
            }
          } else if (earState.mode === "interval") {
            if (earState.difficulty === "easy") {
              notes = INTERVALS.filter((i) =>
                [2, 4, 5, 7, 12].includes(i.semitones)
              );
            } else if (earState.difficulty === "hard") {
              notes = INTERVALS;
            } else {
              notes = INTERVALS.filter((i) =>
                [0, 2, 3, 4, 5, 7, 10, 12].includes(i.semitones)
              );
            }
          } else {
            const chordEntries = Object.entries(CHORDS);
            if (earState.difficulty === "easy") {
              notes = chordEntries.filter(([id]) => ["major", "minor"].includes(id));
            } else if (earState.difficulty === "hard") {
              notes = chordEntries;
            } else {
              notes = chordEntries.filter(([id]) =>
                ["major", "minor", "dom7", "maj7", "min7"].includes(id)
              );
            }
          }
          return notes;
        }

        function randomChoice(list) {
          return list[Math.floor(Math.random() * list.length)];
        }

        function generateQuestion() {
          const pool = difficultyPool();
          const octaveBase = getOctaveBaseOffset();
          if (earState.mode === "note") {
            const answerNote = randomChoice(pool);
            const noteIdx = noteNameToIndex(answerNote);
            const midi = octaveBase + noteIdx;
            const allChoices = new Set([answerNote]);
            while (allChoices.size < 6) {
              allChoices.add(randomChoice(NOTE_NAMES));
            }
            const options = Array.from(allChoices).sort();
            earState.question = {
              kind: "note",
              answer: answerNote,
              midi,
              options
            };
          } else if (earState.mode === "interval") {
            const interval = randomChoice(pool);
            const rootMidi = octaveBase + randomChoice([0, 2, 4, 5, 7, 9]);
            const secondMidi = rootMidi + interval.semitones;
            const allChoices = new Set([interval.name]);
            while (allChoices.size < 6) {
              allChoices.add(randomChoice(INTERVALS).name);
            }
            const options = Array.from(allChoices).sort();
            earState.question = {
              kind: "interval",
              answer: interval.name,
              rootMidi,
              secondMidi,
              options
            };
          } else {
            const [chordId, chordDef] = randomChoice(pool);
            const rootNote = randomChoice(["C", "D", "E", "F", "G", "A"]);
            const rootIdx = noteNameToIndex(rootNote);
            const baseMidi = octaveBase + rootIdx;
            const freqs = chordDef.intervals.map((st, i) => midiToFreq(baseMidi + st + (i >= 3 ? 12 : 0)));
            const allChoices = new Set([chordDef.name]);
            Object.entries(CHORDS).forEach(([id, def]) => {
              if (
                ["major", "minor", "dom7", "maj7", "min7", "diminished", "augmented"].includes(id)
              ) {
                allChoices.add(def.name);
              }
            });
            const options = Array.from(allChoices).sort();
            earState.question = {
              kind: "chord",
              answer: chordDef.name,
              chordId,
              rootNote,
              freqs,
              options
            };
          }

          renderQuestion();
          playCurrentQuestion();
        }

        function renderQuestion() {
          earOptions.innerHTML = "";
          earFeedback.style.display = "none";
          earState.canAnswer = true;
          repeatQuestionBtn.classList.remove("btn-disabled");

          if (!earState.question) return;
          earState.question.options.forEach((label) => {
            const btn = document.createElement("button");
            btn.className = "ear-option";
            btn.textContent = label;
            btn.addEventListener("click", () => handleAnswer(label, btn));
            earOptions.appendChild(btn);
          });

          if (earState.mode === "note") {
            earPrompt.innerHTML =
              "<strong>Question:</strong> Which note did you hear?";
          } else if (earState.mode === "interval") {
            earPrompt.innerHTML =
              "<strong>Question:</strong> What is the interval between the two notes?";
          } else {
            earPrompt.innerHTML =
              "<strong>Question:</strong> What is the chord quality?";
          }
        }

        function playCurrentQuestion() {
          ensureAudioContext();
          if (!earState.question) return;
          const q = earState.question;
          if (q.kind === "note") {
            playTone(midiToFreq(q.midi), 900, { wave: currentWave });
          } else if (q.kind === "interval") {
            playTone(midiToFreq(q.rootMidi), 700, { wave: currentWave });
            setTimeout(
              () => playTone(midiToFreq(q.secondMidi), 700, { wave: currentWave }),
              720
            );
          } else if (q.kind === "chord") {
            playChord(q.freqs, { durationMs: 1500, spread: 80 });
          }
        }

        function handleAnswer(answerLabel, buttonEl) {
          if (!earState.canAnswer || !earState.question) return;
          earState.canAnswer = false;
          earState.scoreTotal += 1;

          const correct = answerLabel === earState.question.answer;
          if (correct) {
            earState.scoreCorrect += 1;
            earState.streak += 1;
          } else {
            earState.streak = 0;
          }

          updateScoreUI();

          const optionButtons = Array.from(
            earOptions.querySelectorAll(".ear-option")
          );
          optionButtons.forEach((btn) => {
            btn.disabled = true;
            if (btn.textContent === earState.question.answer) btn.classList.add("correct");
            if (btn === buttonEl && !correct) btn.classList.add("incorrect");
          });

          earFeedback.style.display = "flex";
          earFeedback.classList.toggle("good", correct);
          earFeedback.classList.toggle("bad", !correct);

          if (correct) {
            earFeedbackTitle.textContent = "Nice! Your ear locked on.";
          } else {
            earFeedbackTitle.textContent = "Good try — let’s listen closer.";
          }

          if (earState.question.kind === "note") {
            earFeedbackBody.textContent =
              " The note was " +
              earState.question.answer +
              ". Try to remember its color and how it sits against the current key.";
          } else if (earState.question.kind === "interval") {
            const interval = INTERVALS.find(
              (i) => i.name === earState.question.answer
            );
            const semitones = interval ? interval.semitones : null;
            earFeedbackBody.textContent =
              " You heard a " +
              earState.question.answer +
              (semitones !== null ? " (" + semitones + " semitones)." : ".") +
              " Sing both notes slowly, then play them on the keyboard to reinforce the distance.";
          } else {
            earFeedbackBody.textContent =
              " The chord was a " +
              earState.question.answer +
              ". Listen again and notice how the inner notes (3rd and 7th) shape its emotion.";
          }

          setTimeout(() => playCurrentQuestion(), 220);
        }

        function updateScoreUI() {
          scoreCorrectEl.textContent = String(earState.scoreCorrect);
          scoreTotalEl.textContent = String(earState.scoreTotal);
          const accuracy =
            earState.scoreTotal > 0
              ? Math.round((earState.scoreCorrect / earState.scoreTotal) * 100)
              : null;
          scoreAccuracyEl.textContent = accuracy === null ? "–" : accuracy + "%";
          streakCountEl.textContent = String(earState.streak);
          const streakNormalized = Math.max(0, Math.min(1, earState.streak / 6));
          streakBarEl.style.transform = "scaleX(" + streakNormalized.toFixed(2) + ")";
        }

        function clearQuestionFeedback() {
          earOptions.innerHTML = "";
          earFeedback.style.display = "none";
          repeatQuestionBtn.classList.add("btn-disabled");
          earState.canAnswer = false;
          earState.question = null;
        }

        newQuestionBtn.addEventListener("click", () => {
          generateQuestion();
        });

        repeatQuestionBtn.addEventListener("click", () => {
          if (earState.question) playCurrentQuestion();
        });

        buildKeyboard();
        setLabelsVisible(true);
        highlightScaleAndChord();
        updateTheorySidebar();
        setMode("note");
      })();
    </script>
  </body>
</html>

