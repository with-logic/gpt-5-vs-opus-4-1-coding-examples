<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Camping Gear Checklist</title>
  <style>
    :root {
      --bg: #02120f;
      --bg-elevated: rgba(7, 33, 30, 0.96);
      --bg-elevated-soft: rgba(8, 40, 36, 0.94);
      --bg-chip: rgba(18, 61, 55, 0.9);
      --border-subtle: rgba(255, 255, 255, 0.06);
      --accent: #37c977;
      --accent-soft: rgba(55, 201, 119, 0.12);
      --accent-strong: #52e08c;
      --accent-warn: #f5b554;
      --accent-danger: #ff6b6b;
      --text-main: #f4faf8;
      --text-muted: #b7ccc4;
      --text-soft: #8aa59a;
      --input-bg: rgba(10, 46, 41, 0.96);
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.65);
      --radius-lg: 18px;
      --radius-md: 10px;
      --radius-pill: 999px;
      --transition-fast: 160ms ease-out;
      --transition-med: 220ms ease-out;
    }

    body[data-theme="day"] {
      --bg: #ebf6ff;
      --bg-elevated: rgba(255, 255, 255, 0.96);
      --bg-elevated-soft: rgba(255, 255, 255, 0.98);
      --bg-chip: rgba(230, 243, 255, 0.92);
      --border-subtle: rgba(13, 40, 64, 0.08);
      --accent: #1c8f4f;
      --accent-soft: rgba(28, 143, 79, 0.08);
      --accent-strong: #21a65e;
      --accent-warn: #e19b30;
      --accent-danger: #e15353;
      --text-main: #0f1c20;
      --text-muted: #5f707a;
      --text-soft: #7b8b94;
      --input-bg: rgba(242, 248, 255, 0.96);
      --shadow-soft: 0 14px 35px rgba(10, 37, 64, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
      "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at 20% 0%, #12364a 0, #02120f 42%, #000 100%);
      background-attachment: fixed;
    }

    body[data-theme="day"] {
      background: radial-gradient(circle at 10% -10%, #fdf9e3 0, #e7f3ff 35%, #a4c9e9 60%, #5a89b8 85%);
      background-attachment: fixed;
    }

    .sky-gradient-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 80% 0%, rgba(255, 189, 111, 0.18) 0, transparent 50%),
        radial-gradient(circle at 10% 15%, rgba(163, 213, 252, 0.2) 0, transparent 40%);
      opacity: 0.9;
      mix-blend-mode: screen;
    }

    body[data-theme="day"] .sky-gradient-overlay {
      opacity: 0.7;
      mix-blend-mode: soft-light;
    }

    .mountain-layer {
      position: fixed;
      inset: auto 0 0 0;
      height: 32vh;
      pointer-events: none;
      background:
        linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent 55%),
        url("data:image/svg+xml,%3Csvg width='1440' height='360' viewBox='0 0 1440 360' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='g1' x1='0' y1='1' x2='0' y2='0'%3E%3Cstop stop-color='%23020908'/%3E%3Cstop offset='1' stop-color='%230d2f2a'/%3E%3C/linearGradient%3E%3ClinearGradient id='g2' x1='0' y1='1' x2='0' y2='0'%3E%3Cstop stop-color='%23040c09'/%3E%3Cstop offset='1' stop-color='%230c2521'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M0,260 L160,180 L280,220 L420,120 L620,260 L780,160 L1040,260 L1240,140 L1440,240 L1440,360 L0,360 Z' fill='url(%23g1)' opacity='0.9'/%3E%3Cpath d='M0,280 L140,200 L260,240 L420,150 L630,270 L780,190 L1040,280 L1240,180 L1440,260 L1440,360 L0,360 Z' fill='url(%23g2)' opacity='0.8'/%3E%3C/svg%3E");
      background-repeat: repeat-x;
      background-size: cover;
      opacity: 0.85;
      transform: translate3d(0, 0, 0);
    }

    body[data-theme="day"] .mountain-layer {
      height: 26vh;
      background:
        linear-gradient(to top, rgba(20, 64, 36, 0.92), transparent 55%),
        url("data:image/svg+xml,%3Csvg width='1440' height='360' viewBox='0 0 1440 360' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='g3' x1='0' y1='1' x2='0' y2='0'%3E%3Cstop stop-color='%23163a26'/%3E%3Cstop offset='1' stop-color='%233f7a4a'/%3E%3C/linearGradient%3E%3ClinearGradient id='g4' x1='0' y1='1' x2='0' y2='0'%3E%3Cstop stop-color='%23113820'/%3E%3Cstop offset='1' stop-color='%232f6c3d'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M0,250 L160,170 L280,210 L420,110 L620,250 L780,150 L1040,250 L1240,130 L1440,230 L1440,360 L0,360 Z' fill='url(%23g3)' opacity='0.95'/%3E%3Cpath d='M0,270 L140,190 L260,230 L420,140 L630,260 L780,180 L1040,270 L1240,170 L1440,250 L1440,360 L0,360 Z' fill='url(%23g4)' opacity='0.9'/%3E%3C/svg%3E");
      opacity: 0.9;
    }

    .campfire-orbit {
      position: fixed;
      right: 3.8rem;
      bottom: 4.1rem;
      width: 72px;
      height: 72px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 15%, rgba(255, 255, 255, 0.9), rgba(255, 182, 120, 0.2), transparent 80%);
      opacity: 0.9;
      pointer-events: none;
      filter: blur(0.5px);
    }

    body[data-theme="day"] .campfire-orbit {
      opacity: 0.4;
      filter: blur(1px);
    }

    #app-root {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 24px 16px 28px;
    }

    .app-shell {
      width: 100%;
      max-width: 1120px;
      background: radial-gradient(circle at 0 0, rgba(80, 194, 143, 0.22), transparent 40%),
                  radial-gradient(circle at 100% 0, rgba(69, 140, 255, 0.18), transparent 45%),
                  var(--bg-elevated);
      border-radius: 26px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 16px;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(22px) saturate(135%);
      -webkit-backdrop-filter: blur(22px) saturate(135%);
    }

    .app-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid rgba(255, 255, 255, 0.04);
      pointer-events: none;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 4px 8px 10px;
      border-bottom: 1px solid var(--border-subtle);
      margin: 0 4px 4px;
    }

    .title-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .badge-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 25%, #ffe9b6 0, #ff9b4a 32%, #f15a24 60%, #58220f 100%);
      position: relative;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.28), 0 12px 24px rgba(0, 0, 0, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .badge-icon svg {
      width: 26px;
      height: 26px;
      transform: translateY(1px);
    }

    .badge-icon-glow {
      position: absolute;
      inset: auto -28px -38px;
      height: 68px;
      background: radial-gradient(circle at 50% 0, rgba(255, 240, 201, 0.9), rgba(255, 140, 61, 0.0) 70%);
      mix-blend-mode: screen;
      opacity: 0.9;
    }

    .title-text h1 {
      font-size: 1.22rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin: 0 0 2px;
      color: var(--text-main);
    }

    .title-text p {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: var(--bg-chip);
      border: 1px solid rgba(255, 255, 255, 0.04);
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, var(--accent));
      box-shadow: 0 0 8px rgba(55, 201, 119, 0.8);
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-elevated-soft);
    }

    .theme-toggle button {
      border: none;
      margin: 0;
      padding: 5px 9px;
      border-radius: 999px;
      background: transparent;
      color: var(--text-soft);
      font-size: 0.72rem;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), transform 120ms ease-out;
    }

    .theme-toggle button[data-active="true"] {
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .theme-toggle button:active {
      transform: scale(0.96);
    }

    .theme-toggle span {
      font-size: 0.88rem;
      display: inline-flex;
      align-items: center;
    }

    .app-main {
      display: grid;
      grid-template-columns: minmax(0, 1.65fr) minmax(0, 1.1fr);
      gap: 14px;
      padding: 10px 4px 6px;
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 880px) {
      .app-main {
        grid-template-columns: 1fr;
      }
      #app-root {
        padding: 16px 10px 22px;
      }
      .app-shell {
        padding: 14px 10px 10px;
      }
      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-controls {
        width: 100%;
        justify-content: space-between;
      }
    }

    .panel {
      background: var(--bg-elevated-soft);
      border-radius: 22px;
      border: 1px solid var(--border-subtle);
      padding: 10px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.38);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 2px 2px 4px;
    }

    .panel-title {
      font-size: 0.85rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .panel-title-pill {
      width: 26px;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.9), rgba(55, 201, 119, 0.1));
      border: 1px solid rgba(255, 255, 255, 0.16);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--accent-strong);
    }

    .panel-subtitle {
      margin: 0;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .panel-subtitle strong {
      color: var(--accent-strong);
      font-weight: 600;
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .field label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
    }

    .field-input,
    select {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 6px 10px;
      font-size: 0.82rem;
      background: var(--input-bg);
      color: var(--text-main);
      outline: none;
      min-width: 0;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform 140ms ease-out;
    }

    .field-input::placeholder {
      color: var(--text-soft);
      opacity: 0.82;
    }

    .field-input:focus,
    select:focus {
      border-color: rgba(81, 231, 150, 0.9);
      box-shadow: 0 0 0 1px rgba(81, 231, 150, 0.65), 0 0 0 9px rgba(30, 148, 93, 0.15);
      transform: translateY(-0.5px);
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, rgba(255, 255, 255, 0.65) 50%),
                        linear-gradient(135deg, rgba(255, 255, 255, 0.65) 50%, transparent 50%);
      background-position: calc(100% - 13px) 50%, calc(100% - 9px) 50%;
      background-size: 7px 7px, 7px 7px;
      background-repeat: no-repeat;
      padding-right: 26px;
      cursor: pointer;
    }

    .btn {
      border-radius: var(--radius-pill);
      border: none;
      padding: 7px 12px;
      font-size: 0.78rem;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #04120b;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.62), 0 0 0 1px rgba(0, 0, 0, 0.85);
      transition: transform var(--transition-med), box-shadow var(--transition-med), filter 140ms ease-out, background 140ms ease-out;
    }

    .btn span {
      font-size: 0.86rem;
    }

    .btn-secondary {
      background: linear-gradient(135deg, rgba(10, 90, 66, 0.95), rgba(9, 71, 52, 0.95));
      color: var(--text-main);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.55);
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: transparent;
      color: var(--text-muted);
      box-shadow: none;
      padding: 4px 9px;
      font-size: 0.74rem;
    }

    .btn-ghost-danger {
      border-color: rgba(255, 107, 107, 0.45);
      color: var(--accent-danger);
    }

    .btn:hover {
      transform: translateY(-0.8px);
      filter: brightness(1.02);
      box-shadow: 0 18px 28px rgba(0, 0, 0, 0.72);
    }

    .btn:active {
      transform: translateY(0.5px) scale(0.97);
      box-shadow: 0 10px 18px rgba(0, 0, 0, 0.65);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-icon {
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.2);
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.7rem;
    }

    .gear-layout {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .gear-controls-line {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    .gear-controls-line .field {
      flex: 1;
      min-width: 0;
    }

    .gear-controls-line .field.weight-field {
      max-width: 120px;
      flex: 0 0 auto;
    }

    .gear-controls-line .field.qty-field {
      max-width: 88px;
      flex: 0 0 auto;
    }

    .gear-controls-line .field.category-field {
      max-width: 144px;
      flex: 0 0 auto;
    }

    .gear-controls-line .actions {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .gear-secondary-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .gear-secondary-row .field {
      flex: 1;
      min-width: 0;
    }

    .pill-toggle-group {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      background: rgba(0, 0, 0, 0.12);
    }

    .pill-toggle-group button {
      border: none;
      padding: 4px 9px;
      font-size: 0.72rem;
      background: transparent;
      color: var(--text-soft);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      transition: background var(--transition-fast), color var(--transition-fast);
    }

    .pill-toggle-group button[data-active="true"] {
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 4px 4px 4px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(9, 56, 46, 0.9), rgba(13, 38, 34, 0.9));
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06);
    }

    body[data-theme="day"] .toolbar {
      background: linear-gradient(90deg, rgba(226, 240, 255, 0.95), rgba(215, 234, 247, 0.98));
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .toolbar-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
    }

    .toolbar-search {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(2, 18, 15, 0.7);
    }

    body[data-theme="day"] .toolbar-search {
      background: rgba(248, 253, 255, 0.9);
    }

    .toolbar-search input {
      border: none;
      outline: none;
      background: transparent;
      font-size: 0.8rem;
      color: var(--text-main);
      min-width: 0;
    }

    .toolbar-search input::placeholder {
      color: var(--text-soft);
    }

    .toolbar-chip {
      font-size: 0.74rem;
      color: var(--text-muted);
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.22);
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    body[data-theme="day"] .toolbar-chip {
      background: rgba(255, 255, 255, 0.9);
    }

    .toolbar-chip strong {
      color: var(--accent-strong);
    }

    .gear-table-shell {
      border-radius: 16px;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.45), rgba(0, 0, 0, 0.22));
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    body[data-theme="day"] .gear-table-shell {
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.95), rgba(244, 249, 255, 0.98));
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.83rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: linear-gradient(to bottom, rgba(6, 40, 33, 0.98), rgba(6, 41, 33, 0.98));
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.07);
    }

    body[data-theme="day"] thead {
      background: linear-gradient(to bottom, rgba(240, 249, 255, 0.98), rgba(224, 238, 251, 0.98));
      box-shadow: 0 1px 0 rgba(13, 40, 64, 0.08);
    }

    thead th {
      text-align: left;
      padding: 7px 10px;
      font-weight: 600;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
      white-space: nowrap;
    }

    tbody {
      display: block;
      max-height: 310px;
      overflow: auto;
    }

    thead tr,
    tbody tr {
      display: grid;
      grid-template-columns: 32px minmax(130px, 2.5fr) minmax(90px, 1.3fr) 58px 82px minmax(80px, 1.2fr) 44px;
      align-items: center;
      column-gap: 6px;
    }

    @media (max-width: 720px) {
      thead tr,
      tbody tr {
        grid-template-columns: 28px minmax(110px, 2.5fr) minmax(82px, 1.4fr) 54px 70px 42px;
      }
      thead th.notes-col,
      tbody td.notes-col {
        display: none;
      }
    }

    tbody tr:nth-child(odd) {
      background: rgba(255, 255, 255, 0.01);
    }

    body[data-theme="day"] tbody tr:nth-child(odd) {
      background: rgba(255, 255, 255, 0.85);
    }

    tbody tr:nth-child(even) {
      background: rgba(0, 0, 0, 0.18);
    }

    body[data-theme="day"] tbody tr:nth-child(even) {
      background: rgba(233, 243, 253, 0.98);
    }

    tbody tr {
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    body[data-theme="day"] tbody tr {
      border-bottom: 1px solid rgba(13, 40, 64, 0.06);
    }

    tbody td {
      padding: 6px 8px;
      color: var(--text-main);
      min-width: 0;
    }

    .cell-label {
      font-weight: 500;
      color: var(--text-main);
    }

    .cell-sub {
      font-size: 0.72rem;
      color: var(--text-soft);
      margin-top: 1px;
    }

    .cell-total,
    .cell-weight {
      font-variant-numeric: tabular-nums;
    }

    .cell-total span {
      display: inline-block;
    }

    .cell-total span.packed {
      color: var(--accent-strong);
    }

    .cell-total span.remaining {
      color: var(--text-soft);
    }

    .cell-category-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.72rem;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.16);
      color: var(--text-muted);
      white-space: nowrap;
    }

    body[data-theme="day"] .cell-category-badge {
      background: rgba(255, 255, 255, 0.95);
    }

    .cell-category-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(55, 201, 119, 0.7);
    }

    .notes-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.24);
      color: var(--text-soft);
      font-size: 0.7rem;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border: 1px dashed rgba(255, 255, 255, 0.12);
    }

    body[data-theme="day"] .notes-pill {
      background: rgba(255, 255, 255, 0.9);
      border-style: solid;
    }

    .notes-pill span:first-child {
      opacity: 0.7;
    }

    .tag-pill {
      font-size: 0.72rem;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.24);
      border: 1px solid rgba(255, 255, 255, 0.14);
      color: var(--accent-warn);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tag-pill span:first-child {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fff8dd, var(--accent-warn));
      box-shadow: 0 0 8px rgba(245, 181, 84, 0.8);
    }

    .checkbox-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      padding-left: 6px;
    }

    .checkbox-input {
      position: relative;
      width: 16px;
      height: 16px;
      border-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3), rgba(3, 17, 13, 0.95));
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.85), 0 3px 6px rgba(0, 0, 0, 0.7);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background var(--transition-fast), border-color var(--transition-fast), box-shadow var(--transition-fast), transform 120ms ease-out;
    }

    body[data-theme="day"] .checkbox-input {
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.9), rgba(233, 244, 255, 0.95));
      border-color: rgba(13, 40, 64, 0.45);
    }

    .checkbox-input[data-checked="true"] {
      background: radial-gradient(circle at 30% 30%, #e9fff3, var(--accent-strong));
      border-color: rgba(0, 0, 0, 0.8);
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.75), 0 0 12px rgba(81, 231, 150, 0.65);
      transform: translateY(0.3px);
    }

    .checkbox-input svg {
      width: 11px;
      height: 11px;
      opacity: 0;
      transform: scale(0.6) translateY(1px);
      transition: opacity 160ms ease-out, transform 160ms ease-out;
      pointer-events: none;
    }

    .checkbox-input[data-checked="true"] svg {
      opacity: 1;
      transform: scale(1) translateY(1px);
    }

    .checkbox-input:active {
      transform: scale(0.9);
    }

    .delete-btn {
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.4);
      cursor: pointer;
      padding: 3px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: color var(--transition-fast), background var(--transition-fast), transform 120ms ease-out;
    }

    .delete-btn:hover {
      color: var(--accent-danger);
      background: rgba(0, 0, 0, 0.2);
    }

    .delete-btn:active {
      transform: scale(0.85);
    }

    .empty-state {
      padding: 16px 18px 14px;
      text-align: left;
      color: var(--text-soft);
      font-size: 0.82rem;
    }

    .empty-state strong {
      color: var(--accent-strong);
    }

    .empty-state p {
      margin: 4px 0;
    }

    .summary-layout {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }

    .summary-top {
      display: grid;
      grid-template-columns: 1.4fr 1.2fr;
      gap: 8px;
    }

    @media (max-width: 880px) {
      .summary-top {
        grid-template-columns: 1fr 1fr;
      }
    }

    .summary-card {
      border-radius: 18px;
      background: radial-gradient(circle at 20% 0, rgba(55, 201, 119, 0.22), transparent 55%),
                  radial-gradient(circle at 100% 0, rgba(109, 167, 255, 0.16), transparent 45%),
                  rgba(3, 20, 18, 0.95);
      padding: 10px 12px 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      position: relative;
      overflow: hidden;
    }

    body[data-theme="day"] .summary-card {
      background: radial-gradient(circle at 20% 0, rgba(68, 179, 115, 0.25), transparent 55%),
                  rgba(236, 247, 255, 0.98);
      border-color: rgba(13, 40, 64, 0.1);
    }

    .summary-heading {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 6px;
    }

    .summary-heading h2 {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
      margin: 0;
    }

    .summary-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .summary-badge {
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 0.72rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.16);
      color: var(--text-muted);
      display: inline-flex;
      align-items: baseline;
      gap: 4px;
    }

    body[data-theme="day"] .summary-badge {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(13, 40, 64, 0.06);
    }

    .summary-badge strong {
      color: var(--accent-strong);
    }

    .progress-ring {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .progress-ring-visual {
      position: relative;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: conic-gradient(
        from -90deg,
        var(--accent-strong) 0deg,
        var(--accent-strong) var(--progress-deg, 0deg),
        rgba(0, 0, 0, 0.45) var(--progress-deg, 0deg),
        rgba(0, 0, 0, 0.45) 360deg
      );
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.9), 0 0 30px rgba(55, 201, 119, 0.55);
    }

    body[data-theme="day"] .progress-ring-visual {
      box-shadow: 0 0 0 1px rgba(13, 40, 64, 0.16), 0 0 18px rgba(90, 195, 132, 0.65);
    }

    .progress-ring-inner {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 10%, rgba(255, 255, 255, 0.92), rgba(0, 0, 0, 0.88));
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
      font-variant-numeric: tabular-nums;
      font-size: 0.8rem;
    }

    body[data-theme="day"] .progress-ring-inner {
      background: radial-gradient(circle at 30% 10%, rgba(255, 255, 255, 1), rgba(229, 239, 248, 1));
    }

    .progress-ring-inner span {
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    .summary-text {
      flex: 1;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .summary-text p {
      margin: 2px 0;
    }

    .summary-text strong {
      color: var(--accent-strong);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 4px 8px;
      margin-top: 4px;
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .summary-grid span {
      font-variant-numeric: tabular-nums;
    }

    .summary-grid .label {
      color: var(--text-soft);
    }

    .summary-grid .value-strong {
      color: var(--accent-strong);
    }

    .summary-grid .value-warn {
      color: var(--accent-warn);
    }

    .summary-grid .value-danger {
      color: var(--accent-danger);
    }

    .trip-card {
      border-radius: 18px;
      background: rgba(2, 18, 15, 0.92);
      padding: 10px 12px 8px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }

    body[data-theme="day"] .trip-card {
      background: rgba(241, 249, 255, 0.98);
      border-color: rgba(13, 40, 64, 0.1);
    }

    .trip-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .trip-title-group {
      display: flex;
      align-items: center;
      gap: 7px;
      min-width: 0;
    }

    .trip-dot {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fff, #37c977);
      box-shadow: 0 0 11px rgba(55, 201, 119, 0.85);
    }

    .trip-title-group .field-input {
      padding: 6px 9px;
      border-radius: 999px;
      font-size: 0.82rem;
      background: rgba(0, 0, 0, 0.45);
    }

    body[data-theme="day"] .trip-title-group .field-input {
      background: rgba(255, 255, 255, 0.96);
    }

    .trip-meta {
      font-size: 0.72rem;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .trip-meta span {
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .trip-meta span strong {
      color: var(--text-muted);
    }

    .trip-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .trip-select {
      min-width: 0;
      max-width: 200px;
    }

    .footnote {
      font-size: 0.7rem;
      color: var(--text-soft);
      text-align: right;
      padding: 0 2px;
    }

    .footnote span {
      color: var(--accent-strong);
    }

    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 0.78rem;
      color: #03110a;
      background: radial-gradient(circle at 0 0, #ffffff, #f5fdf8);
      border: 1px solid rgba(0, 0, 0, 0.75);
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 14px 32px rgba(0, 0, 0, 0.7);
      opacity: 0;
      transform: translateY(12px);
      pointer-events: none;
      transition: opacity 200ms ease-out, transform 200ms ease-out;
      z-index: 50;
    }

    .toast[data-visible="true"] {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .toast-badge {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle, #fff, #37c977);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.78rem;
      color: #032316;
      box-shadow: 0 0 9px rgba(55, 201, 119, 0.7);
    }

    .toast-close {
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      font-size: 0.86rem;
      color: rgba(0, 0, 0, 0.6);
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="sky-gradient-overlay"></div>
  <div class="mountain-layer"></div>
  <div class="campfire-orbit"></div>

  <div id="app-root">
    <div class="app-shell" aria-label="Camping Gear Checklist App">
      <header class="app-header">
        <div class="title-group">
          <div class="badge-icon" aria-hidden="true">
            <div class="badge-icon-glow"></div>
            <svg viewBox="0 0 40 40">
              <defs>
                <linearGradient id="flameGradient" x1="0" y1="1" x2="0" y2="0">
                  <stop offset="0" stop-color="#ffb347" />
                  <stop offset="0.5" stop-color="#ff6b3d" />
                  <stop offset="1" stop-color="#fff4c4" />
                </linearGradient>
              </defs>
              <g transform="translate(8,6)">
                <path d="M8.5 0C6 5.5 5.5 8.2 6.4 10.2c.8 1.8 2.7 2.4 2.7 4.8 0 1.7-1.2 3-3 3-1.9 0-3.6-1.6-3.6-4.4 0-2.9 1.6-5.4 3-7.2C6.2 7.6 7.2 9.3 8.5 10c.2-1.9.4-4.4 0-10Z" fill="url(#flameGradient)" />
                <path d="M13.4 3.5c1.4 2.5 2.3 4.5 2.3 6.7 0 3.6-2.4 6-5.3 6s-4.8-2.1-4.8-4.8c0-1.7.8-3.2 1.6-4.4.1 1.3.6 2.3 1.5 3 .7.6 1.6.9 2.5.9.3-2.4.6-4.7.7-7.4Z" fill="#ffe8c8" opacity="0.92"/>
                <ellipse cx="8.8" cy="19.6" rx="4.8" ry="2.2" fill="#4b2914" />
                <rect x="4.7" y="18.8" width="8.2" height="1.2" rx="0.6" fill="#c98a53" />
                <rect x="4.2" y="19.8" width="9" height="1.1" rx="0.55" fill="#8c5a31" />
              </g>
            </svg>
          </div>
          <div class="title-text">
            <h1>Camping Gear Checklist</h1>
            <p>Dial in your pack weight and never forget the essentials again.</p>
          </div>
        </div>
        <div class="header-controls">
          <div class="chip" aria-label="Trip status">
            <span class="chip-dot"></span>
            <span id="chip-trip-label">Weekend overnighter</span>
          </div>
          <div class="chip" aria-label="Auto-save indicator">
            <span class="chip-dot" style="background: radial-gradient(circle at 30% 30%, #fff6e3, var(--accent-warn)); box-shadow: 0 0 10px rgba(245, 181, 84, 0.8)"></span>
            <span id="chip-save-label">Changes auto-saved</span>
          </div>
          <div class="theme-toggle" aria-label="Toggle between day and night themes">
            <button type="button" id="theme-night-btn" data-active="true">
              <span>Night at camp</span>
            </button>
            <button type="button" id="theme-day-btn" data-active="false">
              <span>Golden hour</span>
            </button>
          </div>
        </div>
      </header>

      <main class="app-main">
        <section class="panel" aria-label="Gear checklist builder">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                <span class="panel-title-pill">Gear</span>
                Checklist
              </div>
              <p class="panel-subtitle">
                Add items, track weight, and mark what’s <strong>packed</strong>.
              </p>
            </div>
          </div>

          <div class="gear-layout">
            <form id="add-item-form" autocomplete="off">
              <div class="gear-controls-line">
                <div class="field">
                  <label for="item-name-input">Item</label>
                  <input
                    id="item-name-input"
                    class="field-input"
                    type="text"
                    placeholder="e.g. Tent, headlamp, stove"
                    required
                  />
                </div>
                <div class="field category-field">
                  <label for="item-category-input">Category</label>
                  <select id="item-category-input">
                    <option value="Shelter">Shelter</option>
                    <option value="Sleep System">Sleep system</option>
                    <option value="Clothing">Clothing</option>
                    <option value="Kitchen">Kitchen</option>
                    <option value="Hydration">Hydration</option>
                    <option value="Food">Food</option>
                    <option value="Safety">Safety</option>
                    <option value="Navigation">Navigation</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Misc">Misc</option>
                  </select>
                </div>
                <div class="field qty-field">
                  <label for="item-qty-input">Qty</label>
                  <input
                    id="item-qty-input"
                    class="field-input"
                    type="number"
                    min="1"
                    step="1"
                    value="1"
                  />
                </div>
                <div class="field weight-field">
                  <label for="item-weight-input">Weight (g)</label>
                  <input
                    id="item-weight-input"
                    class="field-input"
                    type="number"
                    min="0"
                    step="1"
                    placeholder="g"
                  />
                </div>
                <div class="actions">
                  <button type="submit" class="btn btn-secondary">
                    <span class="btn-icon">+</span>
                    <span>Add gear</span>
                  </button>
                </div>
              </div>

              <div class="gear-secondary-row">
                <div class="field">
                  <label for="item-notes-input">Notes</label>
                  <input
                    id="item-notes-input"
                    class="field-input"
                    type="text"
                    placeholder="Optional: brand, warmth rating, fuel type…"
                  />
                </div>
                <div class="controls-row" style="justify-content: flex-end; gap: 4px;">
                  <span class="toolbar-label" style="font-size: 0.7rem;">Preset</span>
                  <div class="pill-toggle-group" aria-label="Preset load level">
                    <button type="button" id="preset-core" data-active="true">Core</button>
                    <button type="button" id="preset-full" data-active="false">Full kit</button>
                  </div>
                </div>
              </div>
            </form>

            <div class="toolbar" aria-label="Checklist controls">
              <div class="toolbar-left">
                <div class="toolbar-search">
                  <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true">
                    <circle cx="7" cy="7" r="4.2" stroke="rgba(255,255,255,0.5)" stroke-width="1.4" fill="none" />
                    <line x1="9.8" y1="9.8" x2="13" y2="13" stroke="rgba(255,255,255,0.5)" stroke-width="1.4" stroke-linecap="round" />
                  </svg>
                  <input
                    id="search-input"
                    type="search"
                    placeholder="Filter by item or category"
                    aria-label="Filter checklist items"
                  />
                </div>
                <button type="button" id="toggle-packed-filter-btn" class="btn-ghost" aria-pressed="false">
                  Hide packed
                </button>
              </div>
              <div class="toolbar-right">
                <div class="toolbar-chip">
                  <span>Shortcuts:</span>
                  <span><strong>Enter</strong> add</span>
                  <span><strong>Space</strong> toggle</span>
                </div>
                <button type="button" id="mark-all-packed-btn" class="btn-ghost">
                  Mark all packed
                </button>
                <button type="button" id="clear-checked-btn" class="btn-ghost btn-ghost-danger">
                  Remove packed
                </button>
              </div>
            </div>

            <div class="gear-table-shell" aria-label="Checklist table">
              <table>
                <thead>
                  <tr>
                    <th scope="col" aria-label="Packed column"></th>
                    <th scope="col">Item</th>
                    <th scope="col">Category</th>
                    <th scope="col">Qty</th>
                    <th scope="col">Total (g)</th>
                    <th scope="col" class="notes-col">Notes</th>
                    <th scope="col" aria-label="Delete column"></th>
                  </tr>
                </thead>
                <tbody id="items-tbody">
                  <!-- Rows injected by JavaScript -->
                </tbody>
              </table>
              <div id="empty-state" class="empty-state hidden">
                <p><strong>No gear yet.</strong> Start by adding your tent, sleep system, and the “10 essentials”—or load a preset kit on the right.</p>
                <p>Use categories to cluster items (shelter, kitchen, safety…) and the weight field to keep your base weight honest.</p>
              </div>
            </div>
          </div>
        </section>

        <aside class="panel" aria-label="Trip summary and list manager">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                <span class="panel-title-pill">Trip</span>
                Summary
              </div>
              <p class="panel-subtitle">
                Watch your base weight as you swap items in and out.
              </p>
            </div>
          </div>

          <div class="summary-layout">
            <div class="summary-top">
              <div class="summary-card" aria-label="Pack weight and progress">
                <div class="summary-heading">
                  <h2>Pack Weight</h2>
                  <div class="summary-badges">
                    <div class="summary-badge">
                      Total: <strong id="summary-total-kg">0.0 kg</strong>
                    </div>
                    <div class="summary-badge">
                      Packed: <strong id="summary-packed-kg">0.0 kg</strong>
                    </div>
                  </div>
                </div>
                <div class="progress-ring">
                  <div class="progress-ring-visual" id="progress-ring">
                    <div class="progress-ring-inner">
                      <div id="summary-pct">0%</div>
                      <span>Packed</span>
                    </div>
                  </div>
                  <div class="summary-text">
                    <p id="summary-target-text">
                      Set a target pack weight to see how dialed this kit is.
                    </p>
                    <div class="summary-grid">
                      <div class="label">Items</div>
                      <span id="summary-count" class="value-strong">0 / 0</span>
                      <span></span>
                      <div class="label">Base weight</div>
                      <span id="summary-total-g">0 g</span>
                      <span></span>
                      <div class="label">Packed now</div>
                      <span id="summary-packed-g">0 g</span>
                      <span></span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="summary-card" aria-label="Target weight and categories">
                <div class="summary-heading">
                  <h2>Dial It In</h2>
                  <div class="summary-badges">
                    <div class="summary-badge" id="summary-intensity">
                      <span>Trip style: <strong id="summary-style-label">Balanced</strong></span>
                    </div>
                  </div>
                </div>
                <div class="summary-text">
                  <div class="field">
                    <label for="target-weight-input">Target pack weight</label>
                    <div class="controls-row">
                      <input
                        id="target-weight-input"
                        class="field-input"
                        type="number"
                        min="0"
                        step="0.1"
                        placeholder="e.g. 12"
                        style="max-width: 100px;"
                      />
                      <span style="font-size: 0.78rem; color: var(--text-soft); margin-right: auto;">kg</span>
                      <button type="button" id="target-reset-btn" class="btn-ghost">
                        Reset
                      </button>
                    </div>
                  </div>
                  <div class="summary-grid" style="margin-top: 6px;">
                    <div class="label">Vs. target</div>
                    <span id="summary-vs-target" class="value-strong">–</span>
                    <span></span>
                    <div class="label">Shelter + sleep</div>
                    <span id="summary-shelter" class="value-strong">0 g</span>
                    <span></span>
                    <div class="label">Food + water</div>
                    <span id="summary-food" class="value-strong">0 g</span>
                    <span></span>
                  </div>
                </div>
              </div>
            </div>

            <div class="trip-card" aria-label="Trip list manager">
              <div class="trip-header">
                <div class="trip-title-group">
                  <div class="trip-dot" aria-hidden="true"></div>
                  <div class="field" style="flex: 1;">
                    <label for="trip-name-input" style="font-size: 0.7rem;">Trip name</label>
                    <input
                      id="trip-name-input"
                      class="field-input"
                      type="text"
                      placeholder="e.g. Alpine overnighter, Family camp"
                    />
                  </div>
                </div>
                <div class="trip-actions">
                  <select id="trip-select" class="field-input trip-select" aria-label="Saved trips"></select>
                  <button type="button" id="new-trip-btn" class="btn-ghost">
                    New trip
                  </button>
                  <button type="button" id="duplicate-trip-btn" class="btn-ghost">
                    Duplicate
                  </button>
                  <button type="button" id="delete-trip-btn" class="btn-ghost btn-ghost-danger">
                    Delete
                  </button>
                </div>
              </div>

              <div class="trip-meta">
                <span>
                  <strong>Saved as:</strong>
                  <span id="trip-meta-name">–</span>
                </span>
                <span>
                  <strong>Last saved:</strong>
                  <span id="trip-meta-updated">Not yet</span>
                </span>
              </div>
            </div>

            <p class="footnote">
              Pro tip: <span>hover over the campfire, then start thinking about s’mores.</span> Your kit will be safe here between trips.
            </p>
          </div>
        </aside>
      </main>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <div class="toast-badge">✓</div>
    <span id="toast-text">Trip saved</span>
    <button type="button" id="toast-close-btn" class="toast-close" aria-label="Dismiss notification">×</button>
  </div>

  <script>
    (function () {
      const storageKey = "camping-gear-checklist-v1";

      function generateId() {
        return (
          Date.now().toString(36) +
          "-" +
          Math.random().toString(36).slice(2, 8)
        );
      }

      function formatDateTime(d) {
        const pad = (n) => n.toString().padStart(2, "0");
        const hours24 = d.getHours();
        const hour = ((hours24 + 11) % 12) + 1;
        const ampm = hours24 >= 12 ? "pm" : "am";
        return (
          d.getFullYear() +
          "-" +
          pad(d.getMonth() + 1) +
          "-" +
          pad(d.getDate()) +
          " " +
          hour +
          ":" +
          pad(d.getMinutes()) +
          ampm
        );
      }

      function deepClone(obj) {
        return JSON.parse(JSON.stringify(obj));
      }

      const defaultCoreItems = [
        {
          name: "Tent (2-person, 3-season)",
          category: "Shelter",
          qty: 1,
          grams: 2100,
          notes: "Poles + stakes + footprint",
          packed: false,
        },
        {
          name: "Sleeping bag (down)",
          category: "Sleep System",
          qty: 1,
          grams: 980,
          notes: "Comfort 20°F / -6°C",
          packed: false,
        },
        {
          name: "Sleeping pad",
          category: "Sleep System",
          qty: 1,
          grams: 520,
          notes: "Insulated, R 4.5",
          packed: false,
        },
        {
          name: "Backpack",
          category: "Misc",
          qty: 1,
          grams: 1400,
          notes: "50–60 L",
          packed: false,
        },
        {
          name: "Headlamp",
          category: "Electronics",
          qty: 1,
          grams: 90,
          notes: "Fully charged + spare batteries",
          packed: false,
        },
        {
          name: "Stove + fuel",
          category: "Kitchen",
          qty: 1,
          grams: 420,
          notes: "Canister + lighter",
          packed: false,
        },
        {
          name: "Cook pot + mug + spoon",
          category: "Kitchen",
          qty: 1,
          grams: 310,
          notes: "Titanium set",
          packed: false,
        },
        {
          name: "Water filter / treatment",
          category: "Hydration",
          qty: 1,
          grams: 120,
          notes: "Filter + backup tabs",
          packed: false,
        },
        {
          name: "Insulating layer (puffy)",
          category: "Clothing",
          qty: 1,
          grams: 420,
          notes: "Synthetic or down jacket",
          packed: false,
        },
        {
          name: "Rain jacket",
          category: "Clothing",
          qty: 1,
          grams: 310,
          notes: "Waterproof / breathable shell",
          packed: false,
        },
        {
          name: "First aid kit",
          category: "Safety",
          qty: 1,
          grams: 230,
          notes: "Blister kit + meds",
          packed: false,
        },
        {
          name: "Map + compass",
          category: "Navigation",
          qty: 1,
          grams: 110,
          notes: "Paper map stays dry",
          packed: false,
        },
        {
          name: "Food (per day)",
          category: "Food",
          qty: 2,
          grams: 700,
          notes: "~700–800 g per day",
          packed: false,
        },
        {
          name: "Water (carried)",
          category: "Hydration",
          qty: 2,
          grams: 1000,
          notes: "1L bottles or bladder",
          packed: false,
        },
      ];

      const defaultFullExtras = [
        {
          name: "Camp chair",
          category: "Misc",
          qty: 1,
          grams: 960,
          notes: "Optional comfort",
          packed: false,
        },
        {
          name: "Camp shoes / sandals",
          category: "Clothing",
          qty: 1,
          grams: 420,
          notes: "Let boots dry",
          packed: false,
        },
        {
          name: "Trekking poles",
          category: "Misc",
          qty: 2,
          grams: 260,
          notes: "Carbon or aluminum",
          packed: false,
        },
        {
          name: "Knife / multitool",
          category: "Misc",
          qty: 1,
          grams: 140,
          notes: "",
          packed: false,
        },
        {
          name: "Backup power bank",
          category: "Electronics",
          qty: 1,
          grams: 220,
          notes: "Phone + headlamp top‑up",
          packed: false,
        },
      ];

      function mapWithIds(source) {
        return source.map((item) => ({
          id: generateId(),
          name: item.name,
          category: item.category,
          qty: item.qty,
          grams: item.grams,
          notes: item.notes || "",
          packed: !!item.packed,
        }));
      }

      const elements = {
        themeNightBtn: document.getElementById("theme-night-btn"),
        themeDayBtn: document.getElementById("theme-day-btn"),
        chipTripLabel: document.getElementById("chip-trip-label"),
        chipSaveLabel: document.getElementById("chip-save-label"),

        addItemForm: document.getElementById("add-item-form"),
        itemNameInput: document.getElementById("item-name-input"),
        itemCategoryInput: document.getElementById("item-category-input"),
        itemQtyInput: document.getElementById("item-qty-input"),
        itemWeightInput: document.getElementById("item-weight-input"),
        itemNotesInput: document.getElementById("item-notes-input"),
        presetCoreBtn: document.getElementById("preset-core"),
        presetFullBtn: document.getElementById("preset-full"),

        searchInput: document.getElementById("search-input"),
        togglePackedFilterBtn: document.getElementById("toggle-packed-filter-btn"),
        markAllPackedBtn: document.getElementById("mark-all-packed-btn"),
        clearCheckedBtn: document.getElementById("clear-checked-btn"),
        itemsTbody: document.getElementById("items-tbody"),
        emptyState: document.getElementById("empty-state"),

        summaryTotalKg: document.getElementById("summary-total-kg"),
        summaryPackedKg: document.getElementById("summary-packed-kg"),
        summaryCount: document.getElementById("summary-count"),
        summaryTotalG: document.getElementById("summary-total-g"),
        summaryPackedG: document.getElementById("summary-packed-g"),
        summaryShelter: document.getElementById("summary-shelter"),
        summaryFood: document.getElementById("summary-food"),
        summaryVsTarget: document.getElementById("summary-vs-target"),
        summaryStyleLabel: document.getElementById("summary-style-label"),
        summaryTargetText: document.getElementById("summary-target-text"),
        progressRing: document.getElementById("progress-ring"),
        summaryPct: document.getElementById("summary-pct"),
        targetWeightInput: document.getElementById("target-weight-input"),
        targetResetBtn: document.getElementById("target-reset-btn"),

        tripNameInput: document.getElementById("trip-name-input"),
        tripMetaName: document.getElementById("trip-meta-name"),
        tripMetaUpdated: document.getElementById("trip-meta-updated"),
        tripSelect: document.getElementById("trip-select"),
        newTripBtn: document.getElementById("new-trip-btn"),
        duplicateTripBtn: document.getElementById("duplicate-trip-btn"),
        deleteTripBtn: document.getElementById("delete-trip-btn"),

        toast: document.getElementById("toast"),
        toastText: document.getElementById("toast-text"),
        toastCloseBtn: document.getElementById("toast-close-btn"),
      };

      function loadState() {
        try {
          const raw = window.localStorage.getItem(storageKey);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") return null;
          if (!Array.isArray(parsed.trips) || !parsed.trips.length) return null;
          return parsed;
        } catch {
          return null;
        }
      }

      function createInitialState() {
        const tripId = generateId();
        const createdAt = new Date().toISOString();
        const items = mapWithIds(defaultCoreItems);
        return {
          version: 1,
          theme: "night",
          filterPackedHidden: false,
          filterQuery: "",
          trips: [
            {
              id: tripId,
              name: "Weekend overnighter",
              preset: "core",
              targetKg: 12,
              items,
              createdAt,
              updatedAt: createdAt,
            },
          ],
          activeTripId: tripId,
        };
      }

      let appState = loadState() || createInitialState();

      function persistState(options) {
        const now = new Date().toISOString();
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (activeTrip && options && options.touchUpdated !== false) {
          activeTrip.updatedAt = now;
        }
        try {
          const serializable = deepClone(appState);
          window.localStorage.setItem(storageKey, JSON.stringify(serializable));
          setChipSaved(true);
          if (options && options.toast) {
            showToast(options.toast);
          }
          updateTripMeta();
        } catch {
          // ignore
        }
      }

      let saveDirtyTimeout = null;

      function markDirtySave() {
        setChipSaved(false);
        if (saveDirtyTimeout) {
          window.clearTimeout(saveDirtyTimeout);
        }
        saveDirtyTimeout = window.setTimeout(() => {
          persistState({ toast: "Changes auto-saved" });
        }, 1000);
      }

      function gramToKg(grams) {
        return grams / 1000;
      }

      function formatKg(kg) {
        if (!kg || kg === 0) return "0.0 kg";
        const rounded = Math.round(kg * 10) / 10;
        return rounded.toFixed(1) + " kg";
      }

      function formatGrams(g) {
        return Math.round(g) + " g";
      }

      function computeTotals(items) {
        let totalItems = items.length;
        let packedItems = 0;
        let totalGrams = 0;
        let packedGrams = 0;
        let shelterGrams = 0;
        let foodHydrationGrams = 0;

        for (const item of items) {
          const qty = Number.isFinite(item.qty) ? item.qty : 1;
          const grams = Number.isFinite(item.grams) ? item.grams : 0;
          const subtotal = qty * grams;
          totalGrams += subtotal;
          if (item.packed) {
            packedItems += 1;
            packedGrams += subtotal;
          }
          const cat = (item.category || "").toLowerCase();
          if (cat === "shelter" || cat === "sleep system") {
            shelterGrams += subtotal;
          } else if (cat === "food" || cat === "hydration") {
            foodHydrationGrams += subtotal;
          }
        }
        const ratio = totalGrams > 0 ? packedGrams / totalGrams : 0;

        return {
          totalItems,
          packedItems,
          totalGrams,
          packedGrams,
          shelterGrams,
          foodHydrationGrams,
          ratio,
        };
      }

      function updateSummary() {
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (!activeTrip) return;

        const totals = computeTotals(activeTrip.items);
        const totalKg = gramToKg(totals.totalGrams);
        const packedKg = gramToKg(totals.packedGrams);

        elements.summaryTotalKg.textContent = formatKg(totalKg);
        elements.summaryPackedKg.textContent = formatKg(packedKg);
        elements.summaryCount.textContent =
          totals.packedItems + " / " + totals.totalItems;
        elements.summaryTotalG.textContent = formatGrams(totals.totalGrams);
        elements.summaryPackedG.textContent = formatGrams(totals.packedGrams);
        elements.summaryShelter.textContent = formatGrams(totals.shelterGrams);
        elements.summaryFood.textContent = formatGrams(
          totals.foodHydrationGrams
        );

        const pct = totals.ratio > 0 ? Math.round(totals.ratio * 100) : 0;
        const clampedPct = Math.max(0, Math.min(100, pct));
        const deg = (360 * clampedPct) / 100;
        elements.progressRing.style.setProperty(
          "--progress-deg",
          deg.toFixed(1) + "deg"
        );
        elements.summaryPct.textContent = clampedPct + "%";

        if (totals.totalItems === 0) {
          elements.summaryTargetText.textContent =
            "Set a target pack weight to see how dialed this kit is.";
        } else if (totals.packedItems === 0) {
          elements.summaryTargetText.textContent =
            "Nothing packed yet. Use this space to keep an eye on base weight as your list fills in.";
        } else if (totals.packedItems === totals.totalItems) {
          elements.summaryTargetText.textContent =
            "Everything is packed—time to hit the trail. Double‑check food, water, and weather layers.";
        } else {
          elements.summaryTargetText.textContent =
            "You’re part way there. Aim to keep your heaviest items close to your back and mid‑pack.";
        }

        const targetKg = Number(activeTrip.targetKg) || 0;
        if (targetKg > 0) {
          const diff = packedKg - targetKg;
          const sign = diff > 0 ? "+" : "";
          const diffDisplay = sign + formatKg(diff).replace(" kg", "") + " kg";

          let cls = "value-strong";
          let styleLabel = "Balanced";
          if (diff > 2) {
            cls = "value-danger";
            styleLabel = "Luxury camp";
          } else if (diff > 0.8) {
            cls = "value-warn";
            styleLabel = "Comfort‑heavy";
          } else if (diff < -3) {
            cls = "value-warn";
            styleLabel = "Ultralight";
          } else if (diff < -1.2) {
            cls = "value-strong";
            styleLabel = "Light & fast";
          }

          elements.summaryVsTarget.textContent = diffDisplay;
          elements.summaryVsTarget.className = cls;
          elements.summaryStyleLabel.textContent = styleLabel;
        } else {
          elements.summaryVsTarget.textContent = "–";
          elements.summaryVsTarget.className = "value-strong";
          elements.summaryStyleLabel.textContent = "Balanced";
        }
      }

      function renderTripSelect() {
        const { trips, activeTripId } = appState;
        elements.tripSelect.innerHTML = "";
        for (const trip of trips) {
          const opt = document.createElement("option");
          opt.value = trip.id;
          opt.textContent = trip.name || "Untitled trip";
          if (trip.id === activeTripId) {
            opt.selected = true;
          }
          elements.tripSelect.appendChild(opt);
        }
      }

      function updateTripMeta() {
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (!activeTrip) return;
        const name = activeTrip.name || "Untitled trip";
        elements.tripNameInput.value = name;
        elements.tripMetaName.textContent = name;
        elements.chipTripLabel.textContent = name;
        if (activeTrip.updatedAt) {
          const parsed = new Date(activeTrip.updatedAt);
          if (!Number.isNaN(parsed.getTime())) {
            elements.tripMetaUpdated.textContent = formatDateTime(parsed);
          } else {
            elements.tripMetaUpdated.textContent = "Recently";
          }
        } else {
          elements.tripMetaUpdated.textContent = "Not yet";
        }
        if (typeof activeTrip.targetKg === "number") {
          elements.targetWeightInput.value =
            activeTrip.targetKg === 0 ? "" : String(activeTrip.targetKg);
        } else {
          elements.targetWeightInput.value = "";
        }
      }

      function renderItems() {
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (!activeTrip) return;

        const filterQuery = (appState.filterQuery || "").trim().toLowerCase();
        const hidePacked = !!appState.filterPackedHidden;

        const filtered = activeTrip.items.filter((item) => {
          if (hidePacked && item.packed) return false;
          if (!filterQuery) return true;
          const haystack =
            (item.name || "") +
            " " +
            (item.category || "") +
            " " +
            (item.notes || "");
          return haystack.toLowerCase().includes(filterQuery);
        });

        elements.itemsTbody.innerHTML = "";

        if (!filtered.length) {
          elements.emptyState.classList.remove("hidden");
          updateSummary();
          return;
        }
        elements.emptyState.classList.add("hidden");

        for (const item of filtered) {
          const tr = document.createElement("tr");
          tr.dataset.itemId = item.id;

          const checkboxTd = document.createElement("td");
          checkboxTd.className = "checkbox-wrap";
          const cbWrapper = document.createElement("button");
          cbWrapper.type = "button";
          cbWrapper.className = "checkbox-input";
          cbWrapper.dataset.checked = item.packed ? "true" : "false";
          cbWrapper.setAttribute(
            "aria-label",
            (item.packed ? "Unmark " : "Mark ") +
              (item.name || "item") +
              " as packed"
          );
          cbWrapper.innerHTML =
            '<svg viewBox="0 0 16 16"><polyline points="3.5 8.5 6.7 11.5 12.5 4.5" fill="none" stroke="#03150b" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          checkboxTd.appendChild(cbWrapper);

          const nameTd = document.createElement("td");
          const nameDiv = document.createElement("div");
          nameDiv.className = "cell-label";
          nameDiv.textContent = item.name;
          const subDiv = document.createElement("div");
          subDiv.className = "cell-sub";
          subDiv.textContent =
            item.category + (item.qty > 1 ? " · x" + item.qty : "");
          nameTd.appendChild(nameDiv);
          nameTd.appendChild(subDiv);

          const catTd = document.createElement("td");
          const catBadge = document.createElement("span");
          catBadge.className = "cell-category-badge";
          const catDot = document.createElement("span");
          catDot.className = "cell-category-dot";
          const catLabel = document.createElement("span");
          catLabel.textContent = item.category;
          catBadge.appendChild(catDot);
          catBadge.appendChild(catLabel);
          catTd.appendChild(catBadge);

          const qtyTd = document.createElement("td");
          qtyTd.className = "cell-weight";
          qtyTd.textContent = item.qty;

          const totalTd = document.createElement("td");
          totalTd.className = "cell-total";
          const grams = (item.qty || 1) * (item.grams || 0);
          const spanPacked = document.createElement("span");
          spanPacked.className = "packed";
          spanPacked.textContent = formatGrams(grams);
          totalTd.appendChild(spanPacked);

          const notesTd = document.createElement("td");
          notesTd.className = "notes-col";
          if (item.notes) {
            const notesPill = document.createElement("span");
            notesPill.className = "notes-pill";
            const dot = document.createElement("span");
            dot.textContent = "✎";
            const noteText = document.createElement("span");
            noteText.textContent = item.notes;
            notesPill.appendChild(dot);
            notesPill.appendChild(noteText);
            notesTd.appendChild(notesPill);
          } else {
            const tag = document.createElement("span");
            tag.className = "tag-pill";
            tag.innerHTML = "<span></span><span>Describe it</span>";
            notesTd.appendChild(tag);
          }

          const deleteTd = document.createElement("td");
          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "delete-btn";
          delBtn.setAttribute(
            "aria-label",
            "Remove " + (item.name || "item") + " from checklist"
          );
          delBtn.innerHTML =
            '<svg width="12" height="12" viewBox="0 0 16 16"><line x1="4" y1="4" x2="12" y2="12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><line x1="12" y1="4" x2="4" y2="12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>';
          deleteTd.appendChild(delBtn);

          tr.appendChild(checkboxTd);
          tr.appendChild(nameTd);
          tr.appendChild(catTd);
          tr.appendChild(qtyTd);
          tr.appendChild(totalTd);
          tr.appendChild(notesTd);
          tr.appendChild(deleteTd);

          if (item.packed) {
            tr.style.opacity = "0.65";
          }

          elements.itemsTbody.appendChild(tr);
        }

        updateSummary();
      }

      function setTheme(theme, save) {
        const normalized = theme === "day" ? "day" : "night";
        document.body.setAttribute("data-theme", normalized);
        elements.themeNightBtn.dataset.active = normalized === "night";
        elements.themeDayBtn.dataset.active = normalized === "day";
        appState.theme = normalized;
        if (save) {
          persistState({ touchUpdated: false });
        }
      }

      function setChipSaved(isSaved) {
        if (isSaved) {
          elements.chipSaveLabel.textContent = "Changes auto-saved";
        } else {
          elements.chipSaveLabel.textContent = "Unsaved changes…";
        }
      }

      let toastTimeout = null;
      function showToast(message) {
        if (!message) return;
        elements.toastText.textContent = message;
        elements.toast.dataset.visible = "true";
        if (toastTimeout) {
          window.clearTimeout(toastTimeout);
        }
        toastTimeout = window.setTimeout(() => {
          elements.toast.dataset.visible = "false";
        }, 3000);
      }

      function hideToast() {
        elements.toast.dataset.visible = "false";
        if (toastTimeout) {
          window.clearTimeout(toastTimeout);
        }
      }

      function applyPreset(preset) {
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (!activeTrip) return;
        let items;
        if (preset === "full") {
          items = mapWithIds([...defaultCoreItems, ...defaultFullExtras]);
        } else {
          items = mapWithIds(defaultCoreItems);
        }
        activeTrip.items = items;
        activeTrip.preset = preset;
        markDirtySave();
        elements.presetCoreBtn.dataset.active = preset === "core";
        elements.presetFullBtn.dataset.active = preset === "full";
        renderItems();
      }

      function onAddItemSubmit(event) {
        event.preventDefault();
        const name = elements.itemNameInput.value.trim();
        if (!name) return;
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (!activeTrip) return;
        const category = elements.itemCategoryInput.value || "Misc";
        const qtyRaw = Number(elements.itemQtyInput.value || "1");
        const qty = Number.isFinite(qtyRaw) && qtyRaw > 0 ? qtyRaw : 1;
        const gramsRaw = Number(elements.itemWeightInput.value || "0");
        const grams = Number.isFinite(gramsRaw) && gramsRaw >= 0 ? gramsRaw : 0;
        const notes = elements.itemNotesInput.value.trim();

        activeTrip.items.push({
          id: generateId(),
          name,
          category,
          qty,
          grams,
          notes,
          packed: false,
        });
        markDirtySave();

        elements.itemNameInput.value = "";
        elements.itemWeightInput.value = "";
        elements.itemNotesInput.value = "";
        elements.itemQtyInput.value = "1";
        elements.itemNameInput.focus();
        renderItems();
      }

      function onItemsTbodyClick(event) {
        const target = event.target;
        const btn =
          target.closest(".checkbox-input") || target.closest(".delete-btn");
        if (!btn) return;
        const tr = btn.closest("tr");
        if (!tr) return;
        const itemId = tr.dataset.itemId;
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (!activeTrip) return;
        const idx = activeTrip.items.findIndex((i) => i.id === itemId);
        if (idx === -1) return;
        const item = activeTrip.items[idx];

        if (btn.classList.contains("checkbox-input")) {
          item.packed = !item.packed;
          markDirtySave();
          renderItems();
        } else if (btn.classList.contains("delete-btn")) {
          activeTrip.items.splice(idx, 1);
          markDirtySave();
          renderItems();
        }
      }

      function onSearchInputChange() {
        appState.filterQuery = elements.searchInput.value || "";
        renderItems();
      }

      function onTogglePackedFilter() {
        appState.filterPackedHidden = !appState.filterPackedHidden;
        const active = appState.filterPackedHidden;
        elements.togglePackedFilterBtn.setAttribute("aria-pressed", active);
        elements.togglePackedFilterBtn.textContent = active
          ? "Show packed"
          : "Hide packed";
        renderItems();
      }

      function onMarkAllPacked() {
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (!activeTrip) return;
        if (!activeTrip.items.length) return;
        for (const item of activeTrip.items) {
          item.packed = true;
        }
        markDirtySave();
        renderItems();
      }

      function onClearChecked() {
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (!activeTrip) return;
        if (!activeTrip.items.length) return;
        activeTrip.items = activeTrip.items.filter((item) => !item.packed);
        markDirtySave();
        renderItems();
      }

      function onTripNameInput() {
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (!activeTrip) return;
        activeTrip.name = elements.tripNameInput.value.trim() || "Untitled trip";
        markDirtySave();
        renderTripSelect();
        updateTripMeta();
      }

      function onTargetWeightChange() {
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (!activeTrip) return;
        const raw = Number(elements.targetWeightInput.value || "0");
        activeTrip.targetKg =
          Number.isFinite(raw) && raw >= 0 ? raw : activeTrip.targetKg || 0;
        markDirtySave();
        updateSummary();
      }

      function onTargetReset() {
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (!activeTrip) return;
        activeTrip.targetKg = 0;
        elements.targetWeightInput.value = "";
        markDirtySave();
        updateSummary();
      }

      function onTripSelectChange() {
        const selectedId = elements.tripSelect.value;
        if (!selectedId) return;
        if (!appState.trips.some((t) => t.id === selectedId)) return;
        appState.activeTripId = selectedId;
        markDirtySave();
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        elements.presetCoreBtn.dataset.active =
          (activeTrip && activeTrip.preset) === "core";
        elements.presetFullBtn.dataset.active =
          (activeTrip && activeTrip.preset) === "full";
        renderTripSelect();
        updateTripMeta();
        renderItems();
      }

      function createNewTrip() {
        const id = generateId();
        const now = new Date().toISOString();
        const baseName = "New trip";
        const existingNames = appState.trips.map((t) => t.name || "");
        let name = baseName;
        let counter = 2;
        while (existingNames.includes(name)) {
          name = baseName + " " + counter;
          counter += 1;
        }
        const trip = {
          id,
          name,
          preset: "core",
          targetKg: 0,
          items: mapWithIds(defaultCoreItems),
          createdAt: now,
          updatedAt: now,
        };
        appState.trips.push(trip);
        appState.activeTripId = id;
        markDirtySave();
        renderTripSelect();
        updateTripMeta();
        renderItems();
      }

      function duplicateTrip() {
        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (!activeTrip) return;
        const now = new Date().toISOString();
        const clonedItems = activeTrip.items.map((item) => ({
          id: generateId(),
          name: item.name,
          category: item.category,
          qty: item.qty,
          grams: item.grams,
          notes: item.notes,
          packed: item.packed,
        }));
        const cloneName = activeTrip.name
          ? activeTrip.name + " (copy)"
          : "Trip copy";
        const newTrip = {
          id: generateId(),
          name: cloneName,
          preset: activeTrip.preset || "core",
          targetKg: activeTrip.targetKg || 0,
          items: clonedItems,
          createdAt: now,
          updatedAt: now,
        };
        appState.trips.push(newTrip);
        appState.activeTripId = newTrip.id;
        markDirtySave();
        renderTripSelect();
        updateTripMeta();
        renderItems();
        showToast("Trip duplicated");
      }

      function deleteCurrentTrip() {
        if (appState.trips.length <= 1) {
          showToast("Keep at least one trip");
          return;
        }
        const index = appState.trips.findIndex(
          (trip) => trip.id === appState.activeTripId
        );
        if (index === -1) return;
        const [removed] = appState.trips.splice(index, 1);
        const nextIndex = index > 0 ? index - 1 : 0;
        appState.activeTripId = appState.trips[nextIndex].id;
        markDirtySave();
        renderTripSelect();
        updateTripMeta();
        renderItems();
        showToast("Deleted \"" + (removed.name || "trip") + '"');
      }

      function onKeyDown(event) {
        if (
          event.target &&
          (event.target.tagName === "INPUT" || event.target.tagName === "TEXTAREA")
        ) {
          return;
        }
        if (event.code === "Space") {
          const firstRow = elements.itemsTbody.querySelector("tr");
          if (firstRow) {
            const cb = firstRow.querySelector(".checkbox-input");
            if (cb) {
              cb.click();
              event.preventDefault();
            }
          }
        }
      }

      elements.themeNightBtn.addEventListener("click", function () {
        setTheme("night", true);
      });
      elements.themeDayBtn.addEventListener("click", function () {
        setTheme("day", true);
      });

      elements.addItemForm.addEventListener("submit", onAddItemSubmit);
      elements.itemsTbody.addEventListener("click", onItemsTbodyClick);
      elements.searchInput.addEventListener("input", onSearchInputChange);
      elements.togglePackedFilterBtn.addEventListener(
        "click",
        onTogglePackedFilter
      );
      elements.markAllPackedBtn.addEventListener("click", onMarkAllPacked);
      elements.clearCheckedBtn.addEventListener("click", onClearChecked);
      elements.tripNameInput.addEventListener("input", onTripNameInput);
      elements.tripSelect.addEventListener("change", onTripSelectChange);
      elements.newTripBtn.addEventListener("click", createNewTrip);
      elements.duplicateTripBtn.addEventListener("click", duplicateTrip);
      elements.deleteTripBtn.addEventListener("click", deleteCurrentTrip);
      elements.targetWeightInput.addEventListener("input", onTargetWeightChange);
      elements.targetResetBtn.addEventListener("click", onTargetReset);

      elements.presetCoreBtn.addEventListener("click", function () {
        applyPreset("core");
      });
      elements.presetFullBtn.addEventListener("click", function () {
        applyPreset("full");
      });

      elements.toastCloseBtn.addEventListener("click", hideToast);

      document.addEventListener("keydown", onKeyDown);

      function initialRender() {
        setTheme(appState.theme || "night", false);
        renderTripSelect();
        updateTripMeta();
        elements.searchInput.value = appState.filterQuery || "";
        elements.togglePackedFilterBtn.setAttribute(
          "aria-pressed",
          appState.filterPackedHidden
        );
        elements.togglePackedFilterBtn.textContent = appState.filterPackedHidden
          ? "Show packed"
          : "Hide packed";

        const activeTrip = appState.trips.find(
          (trip) => trip.id === appState.activeTripId
        );
        if (activeTrip && activeTrip.preset === "full") {
          elements.presetCoreBtn.dataset.active = "false";
          elements.presetFullBtn.dataset.active = "true";
        } else {
          elements.presetCoreBtn.dataset.active = "true";
          elements.presetFullBtn.dataset.active = "false";
        }

        renderItems();
        updateSummary();
        setChipSaved(true);
      }

      initialRender();
    })();
  </script>
</body>
</html>

