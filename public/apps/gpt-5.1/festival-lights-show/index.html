<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Festival Lights Show</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Space+Grotesk:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
        --bg: #05010b;
        --panel-bg: rgba(10, 7, 28, 0.94);
        --panel-soft-bg: rgba(14, 10, 38, 0.9);
        --panel-border: rgba(255, 255, 255, 0.05);
        --panel-border-strong: rgba(255, 255, 255, 0.09);
        --text-main: #f9f5ff;
        --text-muted: #b8b4d4;
        --text-soft: #8f8aab;
        --accent-primary-hue: 220;
        --accent-secondary-hue: 25;
        --accent-gradient: linear-gradient(
          135deg,
          hsl(var(--accent-primary-hue) 95% 62%),
          hsl(var(--accent-secondary-hue) 95% 58%)
        );
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Space Grotesk", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        color: var(--text-main);
        background: radial-gradient(circle at top, #2c1655 0, #05010b 45%, #000 100%);
        -webkit-font-smoothing: antialiased;
        position: relative;
        overflow-x: hidden;
      }

      .bg-layer {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
      }

      .bg-orb {
        position: absolute;
        border-radius: 999px;
        filter: blur(40px);
        opacity: 0.8;
        mix-blend-mode: screen;
        animation: floatOrb 28s ease-in-out infinite alternate;
      }

      .bg-orb.orb-1 {
        width: 32rem;
        height: 32rem;
        background: radial-gradient(circle at 30% 20%, #ff8ff5, transparent 60%);
        top: -18%;
        left: -10%;
        animation-delay: -4s;
      }

      .bg-orb.orb-2 {
        width: 26rem;
        height: 26rem;
        background: radial-gradient(circle at 10% 10%, #60a5ff, transparent 65%);
        bottom: -22%;
        right: -8%;
        animation-delay: -11s;
      }

      .bg-orb.orb-3 {
        width: 30rem;
        height: 30rem;
        background: radial-gradient(circle at 40% 60%, #4ade80, transparent 60%);
        top: 40%;
        left: 45%;
        opacity: 0.55;
        animation-delay: -18s;
      }

      @keyframes floatOrb {
        0% {
          transform: translate3d(0, 0, 0) scale(1);
        }
        50% {
          transform: translate3d(2rem, -1.5rem, 0) scale(1.05);
        }
        100% {
          transform: translate3d(-1.5rem, 1.5rem, 0) scale(1.02);
        }
      }

      .app-shell {
        position: relative;
        z-index: 1;
        max-width: 1200px;
        margin: 0 auto;
        padding: 2.5rem 1.6rem 2.9rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1.75rem;
      }

      .title-block {
        display: flex;
        align-items: center;
        gap: 1.1rem;
      }

      .logo-mark {
        width: 2.7rem;
        height: 2.7rem;
        border-radius: 1.4rem;
        background-image: var(--accent-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Rajdhani", system-ui, sans-serif;
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        box-shadow:
          0 0 0 1px rgba(255, 255, 255, 0.12),
          0 0 22px rgba(167, 139, 250, 0.9),
          0 0 44px rgba(248, 113, 113, 0.7);
      }

      .title-block h1 {
        margin: 0;
        font-family: "Rajdhani", system-ui, sans-serif;
        font-size: clamp(1.8rem, 3vw, 2.2rem);
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      .title-block p {
        margin: 0.2rem 0 0;
        color: var(--text-muted);
        font-size: 0.95rem;
        max-width: 30rem;
      }

      .header-status {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-end;
        gap: 0.55rem;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        border-radius: 999px;
        padding: 0.18rem 0.7rem;
        font-size: 0.72rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: radial-gradient(circle at 10% 0, rgba(255, 255, 255, 0.18), transparent 55%),
          rgba(9, 9, 30, 0.85);
        color: var(--text-soft);
      }

      .badge-live {
        border-color: rgba(252, 165, 165, 0.9);
        background: radial-gradient(circle at 0 50%, rgba(248, 113, 113, 0.45), transparent 55%),
          rgba(24, 6, 24, 0.95);
        color: #fee2e2;
        box-shadow:
          0 0 15px rgba(248, 113, 113, 0.75),
          0 0 42px rgba(190, 24, 93, 0.9);
        position: relative;
      }

      .badge-live::before {
        content: "";
        width: 0.46rem;
        height: 0.46rem;
        border-radius: 999px;
        background: radial-gradient(circle, #fecaca, #f97373);
        box-shadow:
          0 0 10px rgba(248, 113, 113, 0.9),
          0 0 22px rgba(252, 165, 165, 0.95);
      }

      .badge-accent {
        border-color: rgba(129, 140, 248, 0.9);
        background: radial-gradient(circle at 10% 0, rgba(129, 140, 248, 0.4), transparent 60%),
          rgba(15, 23, 75, 0.95);
        color: #e0e7ff;
      }

      .badge-muted {
        border-color: rgba(148, 163, 184, 0.8);
        background: rgba(15, 23, 42, 0.9);
        color: #cbd5f5;
      }

      .main-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.55fr) minmax(0, 1fr);
        gap: 1.75rem;
        align-items: stretch;
      }

      .stage-card,
      .controls-card {
        border-radius: 1.5rem;
        background:
          linear-gradient(135deg, rgba(29, 22, 68, 0.95), rgba(5, 5, 25, 0.97));
        border: 1px solid var(--panel-border-strong);
        box-shadow:
          0 28px 80px rgba(0, 0, 0, 0.9),
          0 0 0 1px rgba(255, 255, 255, 0.02);
        position: relative;
        overflow: hidden;
      }

      .stage-card::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(circle at 10% -10%, rgba(248, 113, 255, 0.15), transparent 60%),
          radial-gradient(circle at 90% 110%, rgba(56, 189, 248, 0.13), transparent 55%);
        opacity: 0.9;
        pointer-events: none;
      }

      .stage-card-inner {
        position: relative;
        padding: 1.25rem 1.4rem 1.4rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        z-index: 1;
      }

      .stage-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1.2rem;
      }

      .stage-header h2 {
        margin: 0;
        font-family: "Rajdhani", system-ui, sans-serif;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        font-size: 0.96rem;
        color: #e5e7eb;
      }

      .stage-subtitle {
        margin: 0.25rem 0 0;
        font-size: 0.85rem;
        color: var(--text-muted);
        max-width: 20rem;
      }

      .stage-metrics {
        display: flex;
        gap: 0.9rem;
        align-items: center;
      }

      .metric {
        min-width: 4.4rem;
        padding: 0.4rem 0.7rem;
        border-radius: 0.85rem;
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.4);
      }

      .metric-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: #9ca3af;
      }

      .metric-value {
        font-size: 0.95rem;
        margin-top: 0.1rem;
      }

      .stage-frame {
        border-radius: 1.1rem;
        background:
          radial-gradient(circle at 10% 0, rgba(248, 250, 252, 0.08), transparent 55%),
          radial-gradient(circle at 90% 120%, rgba(8, 47, 73, 0.55), transparent 55%),
          linear-gradient(145deg, rgba(17, 24, 39, 0.95), rgba(2, 6, 23, 0.98));
        padding: 0.75rem;
        box-shadow:
          inset 0 0 0 1px rgba(255, 255, 255, 0.05),
          0 32px 80px rgba(15, 23, 42, 1);
      }

      .stage-inner {
        position: relative;
        border-radius: 0.9rem;
        overflow: hidden;
        aspect-ratio: 16 / 9;
        background:
          radial-gradient(circle at 50% 110%, rgba(15, 23, 42, 1), #020617 60%);
      }

      .stage-lasers {
        position: absolute;
        left: -10%;
        right: -10%;
        height: 26%;
        pointer-events: none;
        opacity: 0.85;
        mix-blend-mode: screen;
      }

      .stage-lasers-top {
        top: 0;
        background:
          repeating-linear-gradient(
            110deg,
            rgba(56, 189, 248, 0.75),
            rgba(56, 189, 248, 0.75) 4px,
            transparent 4px,
            transparent 8px
          ),
          repeating-linear-gradient(
            70deg,
            rgba(251, 113, 133, 0.85),
            rgba(251, 113, 133, 0.85) 3px,
            transparent 3px,
            transparent 7px
          );
        transform-origin: top;
        transform: translateY(-30%) scaleY(0.8);
        filter: blur(7px);
        animation: sweepLasers 12s linear infinite;
      }

      .stage-lasers-bottom {
        bottom: -5%;
        background:
          repeating-linear-gradient(
            95deg,
            rgba(167, 139, 250, 0.8),
            rgba(167, 139, 250, 0.8) 4px,
            transparent 4px,
            transparent 9px
          );
        transform-origin: bottom;
        transform: translateY(35%) scaleY(0.85);
        filter: blur(8px);
        opacity: 0.7;
        animation: sweepLasersBottom 18s linear infinite;
      }

      @keyframes sweepLasers {
        0% {
          transform: translateY(-30%) scaleY(0.8) translateX(0);
        }
        50% {
          transform: translateY(-32%) scaleY(0.86) translateX(-6%);
        }
        100% {
          transform: translateY(-30%) scaleY(0.8) translateX(4%);
        }
      }

      @keyframes sweepLasersBottom {
        0% {
          transform: translateY(35%) scaleY(0.85) translateX(0);
        }
        50% {
          transform: translateY(32%) scaleY(0.9) translateX(5%);
        }
        100% {
          transform: translateY(35%) scaleY(0.85) translateX(-4%);
        }
      }

      .light-grid-wrapper {
        position: absolute;
        inset: 10% 7% 15%;
        border-radius: 0.95rem;
        background:
          radial-gradient(circle at 10% 0, rgba(255, 255, 255, 0.14), transparent 65%),
          radial-gradient(circle at 90% 100%, rgba(255, 255, 255, 0.2), transparent 70%),
          linear-gradient(135deg, rgba(17, 24, 39, 0.96), rgba(5, 7, 31, 0.98));
        box-shadow:
          inset 0 0 35px rgba(0, 0, 0, 0.85),
          0 0 0 1px rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: stretch;
      }

      .light-grid {
        --cols: 18;
        width: 100%;
        display: grid;
        grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
        gap: clamp(0.22rem, 0.4vw, 0.3rem);
        padding: clamp(0.45rem, 0.9vw, 0.7rem);
        align-content: stretch;
        justify-content: stretch;
      }

      .light {
        --h: 220;
        --l: 40;
        --a: 0.7;
        position: relative;
        border-radius: 999px;
        background:
          radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.92), transparent 52%),
          radial-gradient(circle at 80% 100%, rgba(255, 255, 255, 0.45), transparent 65%),
          hsl(var(--h) 88% calc(var(--l) * 1%));
        box-shadow:
          0 0 10px hsla(var(--h) 100% 60% / calc(var(--a) * 0.7)),
          0 0 24px hsla(var(--h) 100% 65% / var(--a)),
          0 0 52px hsla(var(--h) 100% 72% / calc(var(--a) * 0.9));
        opacity: calc(0.28 + var(--a) * 0.72);
        transition: opacity 80ms linear, box-shadow 80ms linear;
      }

      .stage-footer {
        margin-top: 0.85rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        font-size: 0.78rem;
        color: var(--text-soft);
      }

      .stage-footer-left {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }

      .stage-dot {
        width: 0.4rem;
        height: 0.4rem;
        border-radius: 999px;
        background: #4ade80;
        box-shadow: 0 0 15px rgba(74, 222, 128, 0.9);
      }

      .stage-dot--secondary {
        background: #60a5fa;
        box-shadow: 0 0 15px rgba(96, 165, 250, 0.9);
      }

      .stage-label {
        text-transform: uppercase;
        letter-spacing: 0.16em;
      }

      .stage-footer-right {
        text-align: right;
      }

      .hint {
        opacity: 0.9;
      }

      .controls-card {
        background:
          radial-gradient(circle at 0 0, rgba(148, 163, 255, 0.22), transparent 60%),
          radial-gradient(circle at 60% 140%, rgba(52, 211, 153, 0.25), transparent 58%),
          linear-gradient(145deg, rgba(8, 8, 28, 0.96), rgba(6, 6, 26, 0.98));
      }

      .controls-inner {
        padding: 1.2rem 1.25rem 1.35rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .control-group {
        padding: 0.7rem 0.8rem 0.9rem;
        border-radius: 1rem;
        background: rgba(12, 10, 40, 0.93);
        border: 1px solid rgba(148, 163, 184, 0.34);
        box-shadow:
          0 14px 40px rgba(15, 23, 42, 0.8),
          0 0 0 1px rgba(15, 23, 42, 0.95);
      }

      .control-group-header {
        margin-bottom: 0.5rem;
      }

      .control-group-header h3 {
        margin: 0;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
      }

      .control-group-header p {
        margin: 0.25rem 0 0;
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .field {
        margin-top: 0.65rem;
      }

      .field label {
        display: block;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: #9ca3af;
        margin-bottom: 0.35rem;
      }

      .field-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }

      .field-value {
        font-size: 0.82rem;
        color: var(--text-soft);
      }

      .select-wrapper {
        position: relative;
      }

      select {
        width: 100%;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        border-radius: 0.7rem;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background:
          radial-gradient(circle at 0 0, rgba(148, 163, 255, 0.18), transparent 55%),
          rgba(15, 23, 42, 0.96);
        color: var(--text-main);
        padding: 0.48rem 2.1rem 0.48rem 0.7rem;
        font-size: 0.86rem;
        cursor: pointer;
      }

      .select-chevron {
        position: absolute;
        right: 0.7rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.7rem;
        pointer-events: none;
        color: #9ca3af;
      }

      .field--range input[type="range"] {
        width: 100%;
      }

      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        height: 0.28rem;
        border-radius: 999px;
        background: linear-gradient(
          90deg,
          rgba(59, 130, 246, 0.85),
          rgba(236, 72, 153, 0.95)
        );
        outline: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #f9fafb, #d4d4ff);
        border: 2px solid #0f172a;
        box-shadow:
          0 0 0 1px rgba(255, 255, 255, 0.75),
          0 0 12px rgba(129, 140, 248, 0.95),
          0 0 26px rgba(236, 72, 153, 0.95);
        cursor: pointer;
        margin-top: -6px;
      }

      input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #f9fafb, #d4d4ff);
        border: 2px solid #0f172a;
        box-shadow:
          0 0 0 1px rgba(255, 255, 255, 0.75),
          0 0 12px rgba(129, 140, 248, 0.95),
          0 0 26px rgba(236, 72, 153, 0.95);
        cursor: pointer;
      }

      input[type="range"]::-moz-range-track {
        height: 0.28rem;
        border-radius: 999px;
        background: linear-gradient(
          90deg,
          rgba(59, 130, 246, 0.85),
          rgba(236, 72, 153, 0.95)
        );
      }

      .control-actions {
        margin-top: 0.9rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
      }

      .btn {
        position: relative;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: rgba(15, 23, 42, 0.9);
        color: var(--text-main);
        padding: 0.45rem 0.9rem;
        font-size: 0.82rem;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        cursor: pointer;
        white-space: nowrap;
      }

      .btn-primary {
        border-color: transparent;
        background-image: var(--accent-gradient);
        box-shadow:
          0 14px 30px rgba(129, 140, 248, 0.8),
          0 0 0 1px rgba(248, 250, 252, 0.45);
      }

      .btn-ghost {
        background: rgba(15, 23, 42, 0.92);
        border-color: rgba(148, 163, 184, 0.8);
      }

      .btn-outline {
        background: rgba(15, 23, 42, 0.94);
        border-color: rgba(96, 165, 250, 0.9);
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.4);
      }

      .btn:hover {
        filter: brightness(1.05);
      }

      .btn-primary:hover {
        box-shadow:
          0 18px 40px rgba(129, 140, 248, 1),
          0 0 42px rgba(236, 72, 153, 0.95);
      }

      .btn-indicator {
        width: 0.52rem;
        height: 0.52rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.95);
        box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.9);
        transition: background 140ms ease, box-shadow 140ms ease;
      }

      .btn-indicator--on {
        background: radial-gradient(circle, #bbf7d0, #4ade80);
        box-shadow:
          0 0 0 1px rgba(34, 197, 94, 0.95),
          0 0 12px rgba(74, 222, 128, 0.95);
      }

      .btn-on {
        transform: translateY(-1px);
      }

      .field--split {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.7rem;
      }

      .color-input-row {
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      input[type="color"] {
        appearance: none;
        -webkit-appearance: none;
        border-radius: 999px;
        width: 1.8rem;
        height: 1.8rem;
        padding: 0;
        border: 2px solid rgba(15, 23, 42, 1);
        box-shadow:
          0 0 0 1px rgba(248, 250, 252, 0.75),
          0 0 16px rgba(148, 163, 255, 0.8);
        background: transparent;
        cursor: pointer;
      }

      input[type="color"]::-webkit-color-swatch-wrapper {
        padding: 0;
        border-radius: inherit;
      }

      input[type="color"]::-webkit-color-swatch {
        border-radius: inherit;
        border: none;
      }

      .color-label {
        font-size: 0.78rem;
        color: var(--text-soft);
      }

      .preset-row {
        margin-top: 0.7rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
      }

      .chip {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        padding: 0.28rem 0.7rem;
        font-size: 0.78rem;
        background: rgba(15, 23, 42, 0.92);
        color: var(--text-soft);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }

      .chip:hover {
        border-color: rgba(129, 140, 248, 0.9);
        color: #e0e7ff;
        box-shadow:
          0 0 0 1px rgba(129, 140, 248, 0.7),
          0 0 20px rgba(79, 70, 229, 0.7);
      }

      .music-actions {
        margin-top: 0.55rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.55rem;
      }

      .music-status-row {
        margin-top: 0.7rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .status-line {
        flex: 1;
      }

      .status-label {
        display: block;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: #9ca3af;
      }

      .status-value {
        display: block;
        margin-top: 0.1rem;
        font-size: 0.82rem;
        color: var(--text-main);
      }

      .level-meter {
        min-width: 6rem;
      }

      .level-rail {
        position: relative;
        width: 100%;
        height: 0.42rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.95);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.95);
        overflow: hidden;
      }

      .level-fill {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 12%;
        background: linear-gradient(
          90deg,
          rgba(96, 165, 250, 1),
          rgba(236, 72, 153, 1),
          rgba(244, 63, 94, 1)
        );
        box-shadow:
          0 0 12px rgba(129, 140, 248, 0.9),
          0 0 26px rgba(236, 72, 153, 0.95);
        transition: width 120ms ease-out;
      }

      .toggle {
        margin-top: 0.7rem;
        position: relative;
        width: 100%;
        border-radius: 999px;
        padding: 0.28rem 0.35rem;
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.6);
        cursor: pointer;
      }

      .toggle-knob {
        width: 1.3rem;
        height: 1.3rem;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #f9fafb, #e0e7ff);
        box-shadow:
          0 0 0 1px rgba(248, 250, 252, 0.9),
          0 0 16px rgba(129, 140, 248, 0.95);
        transform: translateX(0);
        transition: transform 160ms ease-out, box-shadow 160ms ease-out;
      }

      .toggle-label {
        font-size: 0.8rem;
        color: var(--text-soft);
      }

      .toggle.toggle--on {
        border-color: rgba(74, 222, 128, 0.95);
        box-shadow:
          0 0 0 1px rgba(22, 163, 74, 0.9),
          0 0 22px rgba(74, 222, 128, 0.95);
        background: radial-gradient(circle at 0 0, rgba(74, 222, 128, 0.3), transparent 55%),
          rgba(5, 46, 22, 0.96);
      }

      .toggle.toggle--on .toggle-knob {
        transform: translateX(1.3rem);
        box-shadow:
          0 0 0 1px rgba(187, 247, 208, 0.9),
          0 0 20px rgba(22, 163, 74, 0.95);
      }

      .tiny-hint {
        margin: 0.5rem 0 0;
        font-size: 0.72rem;
        color: var(--text-soft);
      }

      .app-footer {
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-soft);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }

      .app-footer span {
        opacity: 0.9;
      }

      @media (max-width: 960px) {
        .main-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      @media (max-width: 720px) {
        .app-shell {
          padding-inline: 1.1rem;
        }

        .app-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .header-status {
          justify-content: flex-start;
        }

        .stage-card-inner {
          padding-inline: 1rem;
        }

        .controls-inner {
          padding-inline: 1.05rem;
        }
      }

      @media (max-width: 520px) {
        .stage-footer {
          flex-direction: column;
          align-items: flex-start;
        }

        .music-status-row {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div class="bg-layer">
      <div class="bg-orb orb-1"></div>
      <div class="bg-orb orb-2"></div>
      <div class="bg-orb orb-3"></div>
    </div>

    <div class="app-shell">
      <header class="app-header">
        <div class="title-block">
          <div class="logo-mark">FS</div>
          <div>
            <h1>Festival Lights Show</h1>
            <p>Design, remix, and sync a virtual festival rig to your music.</p>
          </div>
        </div>
        <div class="header-status">
          <span class="badge badge-live">Live Show</span>
          <span class="badge badge-accent" id="audio-reactive-badge">Audio-reactive</span>
        </div>
      </header>

      <main class="main-grid">
        <section class="stage-card" aria-label="Light show preview">
          <div class="stage-card-inner">
            <header class="stage-header">
              <div>
                <h2 id="pattern-label">Rainbow Wave</h2>
                <p class="stage-subtitle" id="pattern-description">
                  A rolling rainbow wave across the festival wall.
                </p>
              </div>
              <div class="stage-metrics">
                <div class="metric">
                  <div class="metric-label">Energy</div>
                  <div class="metric-value" id="energy-label">Chill</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Tempo</div>
                  <div class="metric-value" id="tempo-label">1×</div>
                </div>
              </div>
            </header>

            <div class="stage-frame">
              <div class="stage-inner">
                <div class="stage-lasers stage-lasers-top"></div>
                <div class="stage-lasers stage-lasers-bottom"></div>
                <div class="light-grid-wrapper">
                  <div
                    class="light-grid"
                    id="light-grid"
                    role="img"
                    aria-label="Animated festival light wall"
                  ></div>
                </div>
              </div>
            </div>

            <footer class="stage-footer">
              <div class="stage-footer-left">
                <span class="stage-dot stage-dot--primary"></span>
                <span class="stage-dot stage-dot--secondary"></span>
                <span class="stage-label">Viewport</span>
              </div>
              <div class="stage-footer-right">
                <span class="hint">
                  Tip: Enable music sync and watch the wall react in time.
                </span>
              </div>
            </footer>
          </div>
        </section>

        <section class="controls-card" aria-label="Light show controls">
          <div class="controls-inner">
            <div class="control-group">
              <div class="control-group-header">
                <h3>Show Controls</h3>
                <p>Choose a pattern and tune tempo and brightness.</p>
              </div>
              <div class="field">
                <label for="pattern-select">Pattern</label>
                <div class="select-wrapper">
                  <select id="pattern-select"></select>
                  <span class="select-chevron">▾</span>
                </div>
              </div>
              <div class="field field--range">
                <div class="field-row">
                  <label for="speed-slider">Tempo</label>
                  <span class="field-value" id="speed-value">1×</span>
                </div>
                <input
                  type="range"
                  id="speed-slider"
                  min="0.3"
                  max="2.5"
                  step="0.05"
                  value="1.0"
                />
              </div>
              <div class="field field--range">
                <div class="field-row">
                  <label for="intensity-slider">Brightness</label>
                  <span class="field-value" id="intensity-value">85%</span>
                </div>
                <input
                  type="range"
                  id="intensity-slider"
                  min="0.25"
                  max="1.25"
                  step="0.05"
                  value="0.85"
                />
              </div>
              <div class="control-actions">
                <button type="button" class="btn btn-primary" data-action="toggle-play">
                  <span class="btn-indicator" id="play-indicator"></span>
                  <span id="play-label">Pause show</span>
                </button>
                <button type="button" class="btn btn-ghost" data-action="randomize">
                  Shuffle scene
                </button>
              </div>
            </div>

            <div class="control-group">
              <div class="control-group-header">
                <h3>Color &amp; Mood</h3>
                <p>Dial in the palette or jump to a preset scene.</p>
              </div>
              <div class="field field--split">
                <div>
                  <label for="primary-color">Primary color</label>
                  <div class="color-input-row">
                    <input type="color" id="primary-color" value="#3b82f6" />
                    <span class="color-label">Beams</span>
                  </div>
                </div>
                <div>
                  <label for="accent-color">Accent color</label>
                  <div class="color-input-row">
                    <input type="color" id="accent-color" value="#f97316" />
                    <span class="color-label">Flares</span>
                  </div>
                </div>
              </div>
              <div class="preset-row">
                <button type="button" class="chip" data-preset="midnight">Midnight Neon</button>
                <button type="button" class="chip" data-preset="sunset">Sunset Stage</button>
                <button type="button" class="chip" data-preset="aurora">Aurora Dreams</button>
              </div>
            </div>

            <div class="control-group">
              <div class="control-group-header">
                <h3>Music Sync</h3>
                <p>Connect a music source to drive the lights in real time.</p>
              </div>
              <div class="music-actions">
                <button type="button" class="btn btn-outline" data-action="mic">
                  Use microphone
                </button>
                <button type="button" class="btn btn-outline" data-action="file">
                  Load audio file
                </button>
                <input type="file" id="audio-file-input" accept="audio/*" hidden />
                <audio id="audio-player" crossorigin="anonymous"></audio>
              </div>
              <div class="music-status-row">
                <div class="status-line">
                  <span class="status-label">Music source</span>
                  <span class="status-value" id="music-status">Idle</span>
                </div>
                <div class="level-meter" aria-hidden="true">
                  <div class="level-rail">
                    <div class="level-fill" id="level-fill"></div>
                  </div>
                </div>
              </div>
              <button type="button" class="toggle" id="audio-reactive-toggle">
                <span class="toggle-knob"></span>
                <span class="toggle-label">Audio‑reactive mode</span>
              </button>
              <p class="tiny-hint">
                Tip: For best results, use headphones when enabling the microphone to avoid
                feedback.
              </p>
            </div>
          </div>
        </section>
      </main>

      <footer class="app-footer">
        <span>
          Built with Web Audio and dynamic light patterns — all in a single file.
        </span>
      </footer>
    </div>

    <script>
      (() => {
        "use strict";

        const GRID_COLS = 18;
        const GRID_ROWS = 10;

        const lights = [];

        const state = {
          time: 0,
          isRunning: true,
          patternKey: "rainbowWave",
          baseHue: 220,
          accentHue: 25,
          intensity: 0.85,
          speed: 1.0,
          audioLevel: 0,
          audioReactive: true
        };

        const audio = {
          context: null,
          analyser: null,
          dataArray: null,
          source: null,
          isActive: false,
          usingMic: false,
          usingFile: false
        };

        const patternLabelEl = document.getElementById("pattern-label");
        const patternDescriptionEl = document.getElementById("pattern-description");
        const energyLabelEl = document.getElementById("energy-label");
        const tempoLabelEl = document.getElementById("tempo-label");
        const speedSlider = document.getElementById("speed-slider");
        const speedValueEl = document.getElementById("speed-value");
        const intensitySlider = document.getElementById("intensity-slider");
        const intensityValueEl = document.getElementById("intensity-value");
        const stageEl = document.getElementById("light-grid");
        const playBtn = document.querySelector('[data-action="toggle-play"]');
        const playLabel = document.getElementById("play-label");
        const playIndicator = document.getElementById("play-indicator");
        const randomizeBtn = document.querySelector('[data-action="randomize"]');
        const primaryColorInput = document.getElementById("primary-color");
        const accentColorInput = document.getElementById("accent-color");
        const presetButtons = document.querySelectorAll(".chip[data-preset]");
        const micBtn = document.querySelector('[data-action="mic"]');
        const fileBtn = document.querySelector('[data-action="file"]');
        const fileInput = document.getElementById("audio-file-input");
        const musicStatusEl = document.getElementById("music-status");
        const levelFillEl = document.getElementById("level-fill");
        const audioPlayer = document.getElementById("audio-player");
        const patternSelect = document.getElementById("pattern-select");
        const audioReactiveToggle = document.getElementById("audio-reactive-toggle");
        const audioReactiveBadge = document.getElementById("audio-reactive-badge");

        if (!stageEl) return;

        const patterns = {
          rainbowWave: {
            name: "Rainbow Wave",
            description: "Rolling rainbow beams sweeping across the rig.",
            render(lights, localState) {
              const { time, baseHue, intensity, audioLevel } = localState;
              const cols = GRID_COLS;
              const rows = GRID_ROWS;
              const energy = 0.35 + audioLevel * 0.85;
              const speed = 0.9 + audioLevel * 1.5;
              for (let i = 0; i < lights.length; i++) {
                const light = lights[i];
                const x = light.x;
                const y = light.y;
                const nx = cols > 1 ? x / (cols - 1) : 0;
                const ny = rows > 1 ? y / (rows - 1) : 0;
                const wave =
                  Math.sin(time * speed * 2 + nx * Math.PI * 4 + ny * Math.PI * 1.5);
                const brightness = clamp(
                  ((wave + 1) / 2) * (0.35 + energy * 0.8) * intensity,
                  0,
                  1
                );
                const hue = (baseHue + nx * 220 + ny * 60 + time * 12) % 360;
                const sat = 90;
                const lightness = 12 + brightness * 68;
                const alpha = 0.25 + brightness * 0.75;
                applyLightStyle(light, hue, sat, lightness, alpha);
              }
            }
          },
          bassPulse: {
            name: "Bass Pulse",
            description: "Big, breathing beams that punch with the beat.",
            render(lights, localState) {
              const { time, baseHue, intensity, audioLevel } = localState;
              const cols = GRID_COLS;
              const rows = GRID_ROWS;
              const bass = Math.pow(audioLevel, 0.7);
              const baseBright = 0.2 + bass * 1.4;
              const pulse = 0.5 + 0.5 * Math.sin(time * 2.2);
              for (let i = 0; i < lights.length; i++) {
                const light = lights[i];
                const x = light.x;
                const y = light.y;
                const nx = cols ? (x - cols / 2) / (cols / 2) : 0;
                const ny = rows ? (y - rows) / rows : 0;
                const dist = Math.sqrt(nx * nx + ny * ny);
                const wave = Math.sin(time * 1.8 - dist * 3);
                const local = 0.4 + wave * 0.4 + bass * 0.6;
                const brightness = clamp(local * baseBright * intensity, 0, 1);
                const hue = (baseHue + pulse * 40 + bass * 60) % 360;
                const sat = 85;
                const lightness = 10 + brightness * 70;
                const alpha = 0.35 + brightness * 0.65;
                applyLightStyle(light, hue, sat, lightness, alpha);
              }
            }
          },
          sparkleStrobe: {
            name: "Sparkle Strobe",
            description: "Fast strobes with glittering sparkles across the rig.",
            render(lights, localState) {
              const { time, baseHue, accentHue, intensity, audioLevel } = localState;
              const speed = 3.5 + audioLevel * 8;
              const strobePhase = Math.sin(time * speed);
              const strobe = strobePhase > 0.4 ? 1 : 0;
              for (let i = 0; i < lights.length; i++) {
                const light = lights[i];
                const nx = GRID_COLS > 1 ? light.x / (GRID_COLS - 1) : 0;
                const ny = GRID_ROWS > 1 ? light.y / (GRID_ROWS - 1) : 0;
                const randomSeed =
                  pseudoRandom(light.seed + Math.floor(time * 20) + i * 11) * 1.1;
                const sparkle = randomSeed > 0.8 ? randomSeed : 0;
                const brightnessBase =
                  0.15 +
                  (strobe * 0.8 + sparkle) * (0.4 + audioLevel * 0.9) * intensity;
                const brightness = clamp(brightnessBase, 0, 1);
                const hue = strobe ? accentHue : baseHue + nx * 40 + ny * 30;
                const sat = strobe ? 98 : 88;
                const lightness = 18 + brightness * 70;
                const alpha = 0.2 + brightness * 0.8;
                applyLightStyle(light, hue, sat, lightness, alpha);
              }
            }
          },
          auroraCurtains: {
            name: "Aurora Curtains",
            description: "Soft vertical curtains drifting like aurora.",
            render(lights, localState) {
              const { time, baseHue, accentHue, intensity, audioLevel } = localState;
              const cols = GRID_COLS;
              const rows = GRID_ROWS;
              const energy = 0.2 + audioLevel * 0.9;
              for (let i = 0; i < lights.length; i++) {
                const light = lights[i];
                const x = light.x;
                const y = light.y;
                const nx = cols > 1 ? x / (cols - 1) : 0;
                const ny = rows > 1 ? y / (rows - 1) : 0;
                const band1 = Math.sin(time * 0.75 + nx * Math.PI * 3);
                const band2 = Math.sin(
                  -time * 0.55 + (1 - nx) * Math.PI * 4 + ny * Math.PI
                );
                const mix = 0.5 + 0.5 * band1;
                const wave = band1 * 0.65 + band2 * 0.35;
                const brightness = clamp(
                  ((wave + 1) / 2) *
                    (0.3 + energy * 0.9) *
                    intensity *
                    (0.7 + ny * 0.6),
                  0,
                  1
                );
                const hue = mix * baseHue + (1 - mix) * accentHue;
                const sat = 85;
                const lightness = 14 + brightness * 68;
                const alpha = 0.3 + brightness * 0.7;
                applyLightStyle(light, hue, sat, lightness, alpha);
              }
            }
          },
          cometTrails: {
            name: "Comet Trails",
            description: "Comets streak across the grid leaving glowing trails.",
            render(lights, localState) {
              const { time, baseHue, accentHue, intensity, audioLevel } = localState;
              const cols = GRID_COLS;
              const rows = GRID_ROWS;
              const trailLength = 6 + Math.floor(audioLevel * 10);
              const cometCount = 3;
              const globalFade = 0.25 + audioLevel * 0.4;
              for (let i = 0; i < lights.length; i++) {
                lights[i].tempBrightness = 0;
              }
              for (let c = 0; c < cometCount; c++) {
                const lane =
                  (c * 2 + Math.floor((time * 1.2 + c) % Math.max(rows - 2, 1))) %
                  rows;
                const basePos =
                  (time * (4 + c * 0.7 + audioLevel * 3) + c * 3) %
                  (cols + trailLength);
                for (let t = 0; t < trailLength; t++) {
                  const pos = Math.floor(basePos - t);
                  if (pos < 0 || pos >= cols) continue;
                  const idx = lane * cols + pos;
                  const light = lights[idx];
                  if (!light) continue;
                  const falloff = 1 - t / trailLength;
                  const sparkle = pseudoRandom(
                    c * 9187 + t * 17 + Math.floor(time * 20)
                  );
                  const brightness =
                    (0.35 + audioLevel * 1.1) *
                    falloff *
                    (0.8 + sparkle * 0.4) *
                    intensity;
                  light.tempBrightness = Math.max(light.tempBrightness || 0, brightness);
                }
              }
              for (let i = 0; i < lights.length; i++) {
                const light = lights[i];
                const nx = cols > 1 ? light.x / (cols - 1) : 0;
                const base =
                  (light.tempBrightness || 0) *
                  (0.8 + nx * 0.4) *
                  (0.6 + globalFade);
                const brightness = clamp(base, 0, 1);
                const active = light.tempBrightness && light.tempBrightness > 0.02;
                const hue = active
                  ? accentHue
                  : (baseHue + nx * 40) % 360;
                const sat = 92;
                const lightness = 10 + brightness * 72;
                const alpha = 0.25 + brightness * 0.75;
                applyLightStyle(light, hue, sat, lightness, alpha);
              }
            }
          }
        };

        function applyLightStyle(light, hue, sat, lightness, alpha) {
          const el = light.el;
          el.style.setProperty("--h", hue.toFixed(1));
          el.style.setProperty("--l", lightness.toFixed(1));
          el.style.setProperty("--a", alpha.toFixed(3));
        }

        function clamp(v, min, max) {
          return v < min ? min : v > max ? max : v;
        }

        function pseudoRandom(seed) {
          const x = Math.sin(seed * 12.9898) * 43758.5453;
          return x - Math.floor(x);
        }

        function hexToHue(hex, fallback) {
          if (!hex || typeof hex !== "string") return fallback;
          let clean = hex.trim();
          if (clean[0] === "#") clean = clean.slice(1);
          if (clean.length === 3) {
            clean = clean
              .split("")
              .map((c) => c + c)
              .join("");
          }
          if (clean.length !== 6) return fallback;
          const r = parseInt(clean.slice(0, 2), 16) / 255;
          const g = parseInt(clean.slice(2, 4), 16) / 255;
          const b = parseInt(clean.slice(4, 6), 16) / 255;
          const max = Math.max(r, g, b);
          const min = Math.min(r, g, b);
          const delta = max - min;
          if (delta === 0) return fallback;
          let h;
          if (max === r) {
            h = ((g - b) / delta) % 6;
          } else if (max === g) {
            h = (b - r) / delta + 2;
          } else {
            h = (r - g) / delta + 4;
          }
          h = Math.round(h * 60);
          if (h < 0) h += 360;
          return h;
        }

        function hslToHex(h, s, l) {
          s /= 100;
          l /= 100;
          const k = (n) => (n + h / 30) % 12;
          const a = s * Math.min(l, 1 - l);
          const f = (n) =>
            l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
          const toHex = (x) => {
            const v = Math.round(255 * x)
              .toString(16)
              .padStart(2, "0");
            return v;
          };
          return "#" + toHex(f(0)) + toHex(f(8)) + toHex(f(4));
        }

        function setMusicStatus(text) {
          if (musicStatusEl) musicStatusEl.textContent = text;
        }

        function initGrid() {
          stageEl.style.setProperty("--cols", String(GRID_COLS));
          for (let y = 0; y < GRID_ROWS; y++) {
            for (let x = 0; x < GRID_COLS; x++) {
              const el = document.createElement("div");
              el.className = "light";
              stageEl.appendChild(el);
              lights.push({
                el,
                x,
                y,
                seed: x * 97 + y * 57
              });
            }
          }
        }

        function initPatternsUI() {
          Object.entries(patterns).forEach(([key, pattern]) => {
            const opt = document.createElement("option");
            opt.value = key;
            opt.textContent = pattern.name;
            if (key === state.patternKey) opt.selected = true;
            patternSelect.appendChild(opt);
          });
          updatePatternInfo();
          patternSelect.addEventListener("change", () => {
            state.patternKey = patternSelect.value;
            updatePatternInfo();
          });
        }

        function updatePatternInfo() {
          const pattern = patterns[state.patternKey];
          if (!pattern) return;
          patternLabelEl.textContent = pattern.name;
          patternDescriptionEl.textContent = pattern.description;
        }

        function initSliders() {
          speedSlider.value = String(state.speed);
          intensitySlider.value = String(state.intensity);
          updateSliderLabels();
          speedSlider.addEventListener("input", () => {
            state.speed = parseFloat(speedSlider.value) || 1;
            updateSliderLabels();
          });
          intensitySlider.addEventListener("input", () => {
            state.intensity = parseFloat(intensitySlider.value) || 0.85;
            updateSliderLabels();
          });
        }

        function updateSliderLabels() {
          const tempo = state.speed.toFixed(2).replace(/\.00$/, "");
          speedValueEl.textContent = tempo + "×";
          tempoLabelEl.textContent = tempo + "×";
          const pct = Math.round(state.intensity * 100);
          intensityValueEl.textContent = pct + "%";
        }

        function initPlaybackControls() {
          updatePlayButton();
          playBtn.addEventListener("click", () => {
            state.isRunning = !state.isRunning;
            updatePlayButton();
          });
          randomizeBtn.addEventListener("click", () => {
            randomizeScene();
          });
        }

        function updatePlayButton() {
          if (state.isRunning) {
            playLabel.textContent = "Pause show";
            playBtn.classList.add("btn-on");
            playIndicator.classList.add("btn-indicator--on");
          } else {
            playLabel.textContent = "Play show";
            playBtn.classList.remove("btn-on");
            playIndicator.classList.remove("btn-indicator--on");
          }
        }

        function randomizeScene() {
          const keys = Object.keys(patterns);
          const nextKey = keys[Math.floor(Math.random() * keys.length)];
          state.patternKey = nextKey;
          patternSelect.value = nextKey;
          updatePatternInfo();
          const baseH = Math.floor(Math.random() * 360);
          const accentH = (baseH + 120 + Math.random() * 60) % 360;
          state.baseHue = baseH;
          state.accentHue = accentH;
          primaryColorInput.value = hslToHex(baseH, 80, 55);
          accentColorInput.value = hslToHex(accentH, 85, 60);
          state.speed = 0.5 + Math.random() * 2;
          state.intensity = 0.55 + Math.random() * 0.5;
          speedSlider.value = String(state.speed.toFixed(2));
          intensitySlider.value = String(state.intensity.toFixed(2));
          updateSliderLabels();
          syncAccentVariables();
        }

        function syncAccentVariables() {
          document.documentElement.style.setProperty(
            "--accent-primary-hue",
            String(state.baseHue)
          );
          document.documentElement.style.setProperty(
            "--accent-secondary-hue",
            String(state.accentHue)
          );
        }

        function initColorControls() {
          primaryColorInput.addEventListener("input", () => {
            state.baseHue = hexToHue(primaryColorInput.value, state.baseHue);
            syncAccentVariables();
          });
          accentColorInput.addEventListener("input", () => {
            state.accentHue = hexToHue(accentColorInput.value, state.accentHue);
            syncAccentVariables();
          });
          presetButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
              const key = btn.getAttribute("data-preset");
              applyPreset(key);
            });
          });
          syncAccentVariables();
        }

        function applyPreset(key) {
          if (key === "midnight") {
            state.baseHue = 220;
            state.accentHue = 305;
            state.patternKey = "rainbowWave";
            state.speed = 1.0;
            state.intensity = 0.9;
          } else if (key === "sunset") {
            state.baseHue = 32;
            state.accentHue = 345;
            state.patternKey = "bassPulse";
            state.speed = 0.9;
            state.intensity = 0.95;
          } else if (key === "aurora") {
            state.baseHue = 150;
            state.accentHue = 210;
            state.patternKey = "auroraCurtains";
            state.speed = 0.7;
            state.intensity = 0.8;
          } else {
            return;
          }
          primaryColorInput.value = hslToHex(state.baseHue, 80, 55);
          accentColorInput.value = hslToHex(state.accentHue, 80, 60);
          patternSelect.value = state.patternKey;
          speedSlider.value = String(state.speed);
          intensitySlider.value = String(state.intensity);
          updatePatternInfo();
          updateSliderLabels();
          syncAccentVariables();
        }

        function initMusicControls() {
          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            micBtn.disabled = true;
            micBtn.textContent = "Mic not available";
          }
          micBtn.addEventListener("click", () => {
            startMic();
          });
          fileBtn.addEventListener("click", () => {
            fileInput.click();
          });
          fileInput.addEventListener("change", () => {
            if (!fileInput.files || !fileInput.files[0]) return;
            const file = fileInput.files[0];
            startFileSource(file);
          });
          audioReactiveToggle.addEventListener("click", () => {
            state.audioReactive = !state.audioReactive;
            updateAudioReactiveUI();
          });
          updateAudioReactiveUI();
        }

        function updateAudioReactiveUI() {
          if (state.audioReactive) {
            audioReactiveToggle.classList.add("toggle--on");
            audioReactiveBadge.textContent = "Audio-reactive";
            audioReactiveBadge.classList.remove("badge-muted");
            audioReactiveBadge.classList.add("badge-accent");
          } else {
            audioReactiveToggle.classList.remove("toggle--on");
            audioReactiveBadge.textContent = "Free-run";
            audioReactiveBadge.classList.add("badge-muted");
            audioReactiveBadge.classList.remove("badge-accent");
          }
        }

        function ensureAudioContext() {
          if (!audio.context) {
            const Ctx = window.AudioContext || window.webkitAudioContext;
            if (!Ctx) {
              setMusicStatus("AudioContext unavailable");
              return null;
            }
            audio.context = new Ctx();
          }
          return audio.context;
        }

        function setupAnalyser() {
          if (!audio.context || !audio.source) return;
          if (!audio.analyser) {
            audio.analyser = audio.context.createAnalyser();
            audio.analyser.fftSize = 1024;
            audio.dataArray = new Uint8Array(audio.analyser.frequencyBinCount);
          }
          try {
            audio.source.disconnect();
          } catch (e) {}
          audio.source.connect(audio.analyser);
        }

        function startMic() {
          const ctx = ensureAudioContext();
          if (!ctx || !navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            return;
          }
          if (ctx.state === "suspended" && ctx.resume) ctx.resume();
          navigator.mediaDevices
            .getUserMedia({ audio: true })
            .then((stream) => {
              if (audio.source && audio.source.mediaStream) {
                const tracks = audio.source.mediaStream.getTracks();
                tracks.forEach((t) => t.stop());
              }
              audio.source = ctx.createMediaStreamSource(stream);
              setupAnalyser();
              audio.isActive = true;
              audio.usingMic = true;
              audio.usingFile = false;
              setMusicStatus("Microphone connected");
            })
            .catch(() => {
              setMusicStatus("Microphone blocked");
            });
        }

        function startFileSource(file) {
          const ctx = ensureAudioContext();
          if (!ctx) return;
          const url = URL.createObjectURL(file);
          audioPlayer.src = url;
          audioPlayer.loop = true;
          audioPlayer
            .play()
            .catch(() => {
              // Autoplay blocked; will start when user interacts with controls.
            });
          if (audio.source) {
            try {
              audio.source.disconnect();
            } catch (e) {}
          }
          audio.source = ctx.createMediaElementSource(audioPlayer);
          setupAnalyser();
          if (ctx.state === "suspended" && ctx.resume) ctx.resume();
          audio.isActive = true;
          audio.usingMic = false;
          audio.usingFile = true;
          setMusicStatus("Local track playing");
        }

        function updateAudioLevel() {
          if (!audio.analyser || !audio.dataArray || !audio.isActive) {
            const idlePulse = ((Math.sin(state.time * 1.5) + 1) / 2) * 0.12;
            state.audioLevel = state.audioLevel * 0.9 + idlePulse * 0.1;
            updateAudioMeter();
            return;
          }
          audio.analyser.getByteFrequencyData(audio.dataArray);
          let sum = 0;
          const len = audio.dataArray.length;
          for (let i = 0; i < len; i++) {
            sum += audio.dataArray[i];
          }
          const avg = len ? sum / len : 0;
          const level = avg / 255;
          state.audioLevel = state.audioLevel * 0.8 + level * 0.2;
          updateAudioMeter();
        }

        function updateAudioMeter() {
          const level = clamp(state.audioLevel, 0, 1);
          const percent = Math.round(level * 100);
          levelFillEl.style.setProperty("width", percent + "%");
          if (percent < 25) {
            energyLabelEl.textContent = "Chill";
          } else if (percent < 60) {
            energyLabelEl.textContent = "Grooving";
          } else {
            energyLabelEl.textContent = "Wild";
          }
        }

        function animateFrame(timestamp) {
          requestAnimationFrame(animateFrame);
          const last = animateFrame.lastTime || timestamp || performance.now();
          const delta = (timestamp || performance.now()) - last;
          animateFrame.lastTime = timestamp || performance.now();
          const stepSeconds = (delta || 16) / 1000;
          const timeScale = state.speed || 1;
          state.time += stepSeconds * (0.75 + timeScale * 1.25);
          updateAudioLevel();
          if (!state.isRunning) return;
          const pattern = patterns[state.patternKey] || patterns.rainbowWave;
          const effectiveState = state.audioReactive
            ? state
            : { ...state, audioLevel: 0.18 };
          pattern.render(lights, effectiveState);
        }

        initGrid();
        initPatternsUI();
        initSliders();
        initPlaybackControls();
        initColorControls();
        initMusicControls();
        requestAnimationFrame(animateFrame);
      })();
    </script>
  </body>
</html>

