<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Customer Journey Flow</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <style>
      :root {
        color-scheme: light dark;
        --bg: #050816;
        --bg-elevated: #0b1020;
        --bg-softer: #101524;
        --accent: #4f46e5;
        --accent-soft: rgba(79, 70, 229, 0.18);
        --accent-strong: #6366f1;
        --accent-secondary: #22c55e;
        --border-subtle: rgba(148, 163, 184, 0.25);
        --border-strong: rgba(148, 163, 184, 0.5);
        --text: #e5e7eb;
        --text-soft: #9ca3af;
        --danger: #f97373;
        --danger-soft: rgba(248, 113, 113, 0.12);
        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
        --radius-lg: 16px;
        --radius-full: 999px;
        --transition-fast: 160ms ease-out;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #0b1120 0, #020617 48%, #02010a 100%);
        color: var(--text);
        -webkit-font-smoothing: antialiased;
      }

      body {
        display: flex;
        align-items: stretch;
        justify-content: center;
      }

      .app-shell {
        position: relative;
        display: flex;
        flex-direction: column;
        width: min(1180px, 100%);
        height: 100vh;
        padding: 16px 18px 18px;
        gap: 14px;
      }

      .app-shell::before {
        content: "";
        position: fixed;
        inset: 0;
        background:
          radial-gradient(circle at 10% 0%, rgba(56, 189, 248, 0.22), transparent 55%),
          radial-gradient(circle at 90% 0%, rgba(129, 140, 248, 0.22), transparent 55%);
        opacity: 0.45;
        pointer-events: none;
        mix-blend-mode: screen;
        z-index: -1;
      }

      .app-card {
        position: relative;
        display: flex;
        flex-direction: column;
        flex: 1 1 auto;
        border-radius: 24px;
        background: radial-gradient(circle at top left, #020617 0, #020617 12%, #020617 40%, #020617 65%, #020617 100%);
        background-color: rgba(15, 23, 42, 0.96);
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(148, 163, 184, 0.28);
        overflow: hidden;
      }

      .app-card::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        mix-blend-mode: soft-light;
        background:
          radial-gradient(circle at 10% 0%, rgba(94, 234, 212, 0.12), transparent 55%),
          radial-gradient(circle at 80% 10%, rgba(129, 140, 248, 0.16), transparent 55%);
        opacity: 0.8;
      }

      .app-inner {
        position: relative;
        display: flex;
        flex-direction: column;
        height: 100%;
        z-index: 1;
      }

      .app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 20px 12px;
        border-bottom: 1px solid rgba(30, 64, 175, 0.55);
        background: linear-gradient(
          to right,
          rgba(15, 23, 42, 0.98),
          rgba(17, 24, 39, 0.98)
        );
      }

      .app-title-block {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
      }

      .app-title-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .logo-pill {
        width: 26px;
        height: 26px;
        border-radius: 10px;
        background: conic-gradient(
          from 210deg,
          #4f46e5,
          #22c55e,
          #06b6d4,
          #4f46e5
        );
        padding: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.55);
      }

      .logo-inner {
        width: 100%;
        height: 100%;
        border-radius: 8px;
        background: radial-gradient(circle at 30% 20%, #e5e7eb, #020617 70%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 650;
        color: #020617;
      }

      .app-title {
        font-size: 18px;
        letter-spacing: 0.02em;
        font-weight: 600;
        color: #e5e7eb;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 9px;
        border-radius: 999px;
        background: rgba(15, 118, 110, 0.22);
        color: #a5f3fc;
        font-size: 11px;
        border: 1px solid rgba(34, 211, 238, 0.45);
      }

      .badge-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #f9fafb, #22c55e);
        box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.3);
      }

      .app-subtitle {
        font-size: 13px;
        color: var(--text-soft);
        max-width: 460px;
      }

      .app-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 9px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.96);
        border: 1px solid rgba(148, 163, 184, 0.4);
        font-size: 11px;
        color: var(--text-soft);
      }

      .pill strong {
        color: #e5e7eb;
      }

      .primary-btn {
        border: none;
        outline: none;
        border-radius: 999px;
        padding: 7px 14px;
        font-size: 12px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        background: linear-gradient(135deg, #4f46e5, #22c55e);
        color: #f9fafb;
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.7);
        transition: transform var(--transition-fast), box-shadow var(--transition-fast),
          filter var(--transition-fast);
      }

      .primary-btn span.icon {
        font-size: 14px;
      }

      .primary-btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.03);
        box-shadow: 0 14px 35px rgba(79, 70, 229, 0.85);
      }

      .primary-btn:active {
        transform: translateY(0);
        box-shadow: 0 8px 18px rgba(79, 70, 229, 0.6);
      }

      .primary-btn.secondary {
        background: transparent;
        padding-inline: 11px;
        color: var(--text-soft);
        box-shadow: none;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.55);
      }

      .primary-btn.secondary:hover {
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.9);
        background: rgba(15, 23, 42, 0.9);
        color: #e5e7eb;
      }

      .app-main {
        display: grid;
        grid-template-columns: minmax(240px, 260px) minmax(0, 1fr);
        flex: 1 1 auto;
        min-height: 0;
      }

      .sidebar {
        border-right: 1px solid rgba(30, 64, 175, 0.55);
        background: radial-gradient(circle at top left, #020617, #020617 65%, #000 100%);
        padding: 14px 14px 12px 16px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .sidebar-section-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: rgba(148, 163, 184, 0.85);
      }

      .sidebar-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .sidebar-row + .sidebar-row {
        margin-top: 4px;
      }

      .summary-metrics {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        font-size: 11px;
      }

      .metric-card {
        border-radius: 11px;
        padding: 7px 8px;
        background: radial-gradient(circle at 0 0, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.96));
        border: 1px solid rgba(51, 65, 85, 0.9);
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      .metric-label {
        color: rgba(148, 163, 184, 0.9);
      }

      .metric-value {
        font-size: 13px;
        font-weight: 600;
        color: #e5e7eb;
      }

      .metric-pill {
        font-size: 10px;
        padding: 1px 6px;
        border-radius: 999px;
        background: rgba(22, 163, 74, 0.2);
        color: #bbf7d0;
      }

      .metric-pill.neutral {
        background: rgba(30, 64, 175, 0.35);
        color: #bfdbfe;
      }

      .sidebar-divider {
        border: none;
        border-top: 1px dashed rgba(51, 65, 85, 0.8);
        margin: 2px 0 4px;
      }

      .stage-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(148, 163, 184, 0.4) transparent;
      }

      .stage-list::-webkit-scrollbar {
        width: 6px;
      }

      .stage-list::-webkit-scrollbar-track {
        background: transparent;
      }

      .stage-list::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.35);
        border-radius: 999px;
      }

      .stage-item {
        position: relative;
        border-radius: 999px;
        padding: 6px 9px 6px 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 12px;
        color: var(--text-soft);
        transition: background var(--transition-fast), border-color var(--transition-fast),
          color var(--transition-fast), transform var(--transition-fast);
      }

      .stage-item::before {
        content: "";
        width: 7px;
        height: 7px;
        border-radius: 999px;
        flex-shrink: 0;
        background: radial-gradient(circle at 30% 30%, #f9fafb, #4f46e5);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
      }

      .stage-item span.label {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .stage-item-stage-index {
        font-size: 11px;
        padding: 1px 6px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        color: rgba(148, 163, 184, 0.96);
      }

      .stage-item.selected {
        background: linear-gradient(to right, rgba(79, 70, 229, 0.34), rgba(59, 130, 246, 0.2));
        color: #e5e7eb;
        border-color: rgba(129, 140, 248, 0.9);
        transform: translateY(-1px);
      }

      .stage-item.selected::before {
        background: radial-gradient(circle at 30% 30%, #f9fafb, #22c55e);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.4);
      }

      .stage-item:hover:not(.selected) {
        background: rgba(15, 23, 42, 0.95);
        border-color: rgba(148, 163, 184, 0.45);
      }

      .stage-item button {
        border: none;
        background: transparent;
        color: rgba(148, 163, 184, 0.8);
        padding: 0;
        cursor: pointer;
        font-size: 14px;
      }

      .stage-item button:hover {
        color: #f97373;
      }

      .stage-actions {
        display: flex;
        gap: 6px;
        margin-top: 2px;
      }

      .hint-text {
        font-size: 11px;
        color: rgba(148, 163, 184, 0.9);
      }

      .hint-em {
        color: #e5e7eb;
      }

      .hint-shortcuts {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 4px;
      }

      .kbd {
        padding: 1px 5px;
        border-radius: 6px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 10px;
        color: rgba(148, 163, 184, 0.9);
        background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
      }

      .canvas-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
        background: radial-gradient(circle at 0 0, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
      }

      .canvas-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px 8px;
        border-bottom: 1px dashed rgba(30, 64, 175, 0.55);
        font-size: 11px;
        color: rgba(148, 163, 184, 0.9);
      }

      .canvas-toolbar-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .legend-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #f9fafb, #22c55e);
        box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.4);
      }

      .legend-line {
        width: 26px;
        height: 2px;
        border-radius: 999px;
        background: linear-gradient(to right, #4f46e5, #22c55e);
      }

      .canvas-toolbar-actions {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .micro-btn {
        border-radius: 999px;
        padding: 3px 8px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.95);
        color: rgba(148, 163, 184, 0.95);
        font-size: 10px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        transition: background var(--transition-fast), border-color var(--transition-fast),
          color var(--transition-fast), transform var(--transition-fast);
      }

      .micro-btn:hover {
        background: rgba(17, 24, 39, 1);
        color: #e5e7eb;
        border-color: rgba(148, 163, 184, 0.7);
        transform: translateY(-0.5px);
      }

      .micro-btn:active {
        transform: translateY(0);
      }

      .micro-btn[data-variant="ghost"] {
        background: transparent;
        border-style: dashed;
      }

      .micro-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 7px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(30, 64, 175, 0.8);
        font-size: 10px;
      }

      .micro-indicator-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #f9fafb, #4f46e5);
      }

      .canvas {
        position: relative;
        flex: 1 1 auto;
        min-height: 0;
        overflow: hidden;
        background-image: linear-gradient(
            rgba(15, 23, 42, 0.98),
            rgba(15, 23, 42, 0.98)
          ),
          radial-gradient(circle at 0 0, rgba(30, 64, 175, 0.4), transparent 55%),
          radial-gradient(circle at 100% 0, rgba(45, 212, 191, 0.35), transparent 55%);
        background-blend-mode: normal, screen, screen;
      }

      .canvas-grid {
        position: absolute;
        inset: 0;
        background-image: linear-gradient(
            to right,
            rgba(15, 23, 42, 0.8) 1px,
            transparent 1px
          ),
          linear-gradient(
            to bottom,
            rgba(15, 23, 42, 0.8) 1px,
            transparent 1px
          );
        background-size: 28px 28px;
        opacity: 0.62;
        pointer-events: none;
      }

      .canvas-grid::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: linear-gradient(
            to right,
            rgba(55, 65, 81, 0.38) 1px,
            transparent 1px
          ),
          linear-gradient(
            to bottom,
            rgba(55, 65, 81, 0.4) 1px,
            transparent 1px
          );
        background-size: 112px 112px;
        mix-blend-mode: overlay;
      }

      .canvas-inner {
        position: relative;
        width: 100%;
        height: 100%;
      }

      .connections-layer {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: visible;
      }

      .connections-layer svg {
        width: 100%;
        height: 100%;
        overflow: visible;
      }

      .node-layer {
        position: absolute;
        inset: 0;
        padding: 20px 24px 26px;
      }

      .journey-node {
        position: absolute;
        min-width: 110px;
        max-width: 210px;
        border-radius: 14px;
        padding: 8px 10px 9px;
        background: radial-gradient(circle at top, #020617, #020617 40%, #020617 100%);
        border: 1px solid rgba(148, 163, 184, 0.5);
        box-shadow: 0 14px 35px rgba(15, 23, 42, 0.95);
        cursor: grab;
        user-select: none;
        transform-origin: center;
        transition: box-shadow var(--transition-fast), border-color var(--transition-fast),
          background var(--transition-fast), transform 90ms ease-out;
      }

      .journey-node:hover {
        border-color: rgba(129, 140, 248, 0.85);
        box-shadow: 0 18px 45px rgba(37, 99, 235, 0.7);
      }

      .journey-node[data-selected="true"] {
        border-width: 1.5px;
        border-color: rgba(129, 140, 248, 1);
        background: radial-gradient(circle at top, rgba(30, 64, 175, 0.9), #020617 52%);
        box-shadow: 0 20px 60px rgba(30, 64, 175, 0.95);
      }

      .journey-node[data-dragging="true"] {
        cursor: grabbing;
        transform: scale(1.02);
        box-shadow: 0 24px 70px rgba(15, 23, 42, 1);
      }

      .journey-node-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
        margin-bottom: 4px;
      }

      .journey-node-index {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.75);
        color: rgba(148, 163, 184, 0.98);
        background: rgba(15, 23, 42, 0.96);
      }

      .journey-node-actions {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .icon-btn {
        border: none;
        background: transparent;
        color: rgba(148, 163, 184, 0.9);
        padding: 0;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
      }

      .icon-btn:hover {
        color: #f97373;
      }

      .journey-node-title {
        font-size: 13px;
        font-weight: 500;
        color: #e5e7eb;
        padding: 3px 6px 3px 6px;
        border-radius: 8px;
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(51, 65, 85, 0.9);
        cursor: text;
        min-height: 20px;
        line-height: 1.3;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .journey-node-title[contenteditable="true"]:focus {
        outline: none;
        border-color: rgba(129, 140, 248, 0.95);
        box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.5);
        background: rgba(15, 23, 42, 1);
      }

      .journey-node-subtitle {
        font-size: 11px;
        margin-top: 3px;
        color: rgba(148, 163, 184, 0.9);
      }

      .journey-node-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 5px;
      }

      .journey-node-badge {
        font-size: 10px;
        border-radius: 999px;
        padding: 1px 6px;
        border: 1px solid rgba(51, 65, 85, 0.9);
        background: rgba(15, 23, 42, 0.96);
        color: rgba(148, 163, 184, 0.95);
      }

      .journey-node-badge[data-variant="primary"] {
        border-color: rgba(79, 70, 229, 0.8);
        background: rgba(30, 64, 175, 0.26);
        color: #e5e7eb;
      }

      .journey-node-footer {
        margin-top: 7px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
      }

      .node-metric {
        font-size: 10px;
        color: rgba(148, 163, 184, 0.95);
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .node-metric strong {
        color: #e5e7eb;
      }

      .node-handles {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .handle {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.8);
        background: radial-gradient(circle at 30% 30%, #f9fafb, #4f46e5);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.4);
        position: relative;
        cursor: crosshair;
      }

      .handle::after {
        content: "";
        position: absolute;
        inset: -8px;
        border-radius: inherit;
      }

      .handle[data-direction="in"] {
        background: radial-gradient(circle at 30% 30%, #f9fafb, #22c55e);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.4);
      }

      .handle:hover {
        transform: scale(1.12);
      }

      .handle[data-active="true"] {
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.7);
      }

      .flow-connection {
        fill: none;
        stroke-width: 1.8;
        stroke-linecap: round;
        stroke-linejoin: round;
        stroke: url(#flow-gradient);
        filter: drop-shadow(0 0 11px rgba(56, 189, 248, 0.7));
        opacity: 0.9;
      }

      .flow-connection[data-muted="true"] {
        opacity: 0.25;
        filter: none;
      }

      .flow-connection-temp {
        stroke: rgba(148, 163, 184, 0.8);
        stroke-dasharray: 4 4;
        filter: none;
      }

      .app-footer {
        padding: 7px 18px 10px;
        font-size: 11px;
        color: rgba(148, 163, 184, 0.9);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border-top: 1px solid rgba(30, 64, 175, 0.55);
        background: linear-gradient(
          to right,
          rgba(15, 23, 42, 0.98),
          rgba(17, 24, 39, 0.98)
        );
      }

      .app-footer span.highlight {
        color: #e5e7eb;
      }

      .app-footer-right {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #f9fafb, #22c55e);
        box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.5);
      }

      .fade-in {
        animation: fadeIn 320ms ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(3px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 960px) {
        .app-shell {
          padding-inline: 10px;
        }

        .app-card {
          border-radius: 20px;
        }

        .app-main {
          grid-template-columns: minmax(0, 1fr);
          grid-template-rows: auto minmax(0, 1fr);
        }

        .sidebar {
          border-right: none;
          border-bottom: 1px solid rgba(30, 64, 175, 0.55);
          padding-inline: 14px;
        }

        .node-layer {
          padding: 16px 16px 20px;
        }
      }

      @media (max-width: 720px) {
        .app-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .app-controls {
          align-self: stretch;
          justify-content: space-between;
        }

        .summary-metrics {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (max-width: 520px) {
        .summary-metrics {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .app-footer {
          flex-direction: column;
          align-items: flex-start;
        }

        .canvas-toolbar {
          flex-direction: column;
          align-items: flex-start;
          gap: 6px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <section class="app-card">
        <div class="app-inner">
          <header class="app-header">
            <div class="app-title-block">
              <div class="app-title-row">
                <div class="logo-pill">
                  <div class="logo-inner">CJ</div>
                </div>
                <div class="app-title">Customer Journey Flow</div>
                <div class="badge">
                  <span class="badge-dot"></span>
                  Live diagram
                </div>
              </div>
              <p class="app-subtitle">
                Map how customers move from first touch to purchase. Drag stages,
                connect paths, and capture the story of your funnel.
              </p>
            </div>
            <div class="app-controls">
              <div class="pill">
                <span>From</span>
                <strong>Awareness</strong>
                <span>to</span>
                <strong>Purchase</strong>
              </div>
              <button class="primary-btn secondary" type="button" id="reset-flow-btn">
                <span class="icon">↺</span>
                Reset
              </button>
              <button class="primary-btn" type="button" id="add-stage-btn">
                <span class="icon">＋</span>
                New stage
              </button>
            </div>
          </header>

          <main class="app-main">
            <aside class="sidebar">
              <div class="sidebar-row">
                <div>
                  <div class="sidebar-section-title">Journey snapshot</div>
                  <div class="hint-text">
                    One screen to explore your funnel health.
                  </div>
                </div>
              </div>

              <div class="summary-metrics" id="summary-metrics">
                <div class="metric-card">
                  <div class="metric-label">Stages</div>
                  <div class="metric-value" id="metric-stages-count">–</div>
                  <div class="metric-pill neutral" id="metric-entry-stage">
                    Entry: —
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Paths</div>
                  <div class="metric-value" id="metric-paths-count">–</div>
                  <div class="metric-pill" id="metric-density">
                    Density: —
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Purchase-ready</div>
                  <div class="metric-value" id="metric-purchase-index">–</div>
                  <div class="metric-pill neutral" id="metric-exit-stage">
                    Exit: —
                  </div>
                </div>
              </div>

              <hr class="sidebar-divider" />

              <div class="sidebar-row">
                <div class="sidebar-section-title">Stages</div>
                <div class="stage-actions">
                  <button class="micro-btn" type="button" id="auto-layout-btn">
                    ⤢ Auto layout
                  </button>
                  <button
                    class="micro-btn"
                    data-variant="ghost"
                    type="button"
                    id="clear-connections-btn"
                  >
                    ⊝ Clear paths
                  </button>
                </div>
              </div>

              <ul class="stage-list" id="stage-list"></ul>

              <div>
                <div class="sidebar-section-title">Tips</div>
                <div class="hint-text">
                  Drag cards to reposition. Drag from the
                  <span class="hint-em">blue node</span> on the right of a stage
                  into the <span class="hint-em">green node</span> of the next
                  stage to create a path.
                </div>
                <div class="hint-shortcuts">
                  <span class="kbd">Double‑click node</span>
                  <span class="hint-text">edit label</span>
                  <span class="kbd">⌘ / Ctrl + S</span>
                  <span class="hint-text">save layout</span>
                </div>
              </div>
            </aside>

            <section class="canvas-wrapper">
              <div class="canvas-toolbar">
                <div class="canvas-toolbar-left">
                  <div class="legend-dot"></div>
                  <span>Entry / exit points</span>
                  <span>·</span>
                  <div class="legend-line"></div>
                  <span>Customer paths</span>
                </div>
                <div class="canvas-toolbar-actions">
                  <div class="micro-indicator" id="persistence-indicator">
                    <span class="micro-indicator-dot"></span>
                    Changes saved
                  </div>
                </div>
              </div>
              <div class="canvas">
                <div class="canvas-grid"></div>
                <div class="canvas-inner" id="canvas-inner">
                  <div class="connections-layer" aria-hidden="true">
                    <svg id="connection-svg">
                      <defs>
                        <linearGradient
                          id="flow-gradient"
                          x1="0%"
                          y1="0%"
                          x2="100%"
                          y2="0%"
                        >
                          <stop offset="0%" stop-color="#4f46e5" />
                          <stop offset="50%" stop-color="#22c55e" />
                          <stop offset="100%" stop-color="#06b6d4" />
                        </linearGradient>
                        <marker
                          id="arrow-end"
                          markerWidth="10"
                          markerHeight="10"
                          refX="9"
                          refY="3"
                          orient="auto"
                          markerUnits="strokeWidth"
                        >
                          <path
                            d="M0,0 L9,3 L0,6 Z"
                            fill="url(#flow-gradient)"
                            opacity="0.95"
                          ></path>
                        </marker>
                      </defs>
                    </svg>
                  </div>
                  <div class="node-layer" id="node-layer"></div>
                </div>
              </div>
            </section>
          </main>

          <footer class="app-footer">
            <div>
              <span class="highlight">Diagram‑like</span> layout. Stages and connections
              stay on screen as you explore your funnel.
            </div>
            <div class="app-footer-right">
              <div class="status-dot"></div>
              <span id="status-label">Idle — drag a stage to get started.</span>
            </div>
          </footer>
        </div>
      </section>
    </div>

    <script>
      (function () {
        const SVG_NS = "http://www.w3.org/2000/svg";
        const STORAGE_KEY = "customer-journey-flow-state-v1";

        const nodeLayer = document.getElementById("node-layer");
        const stageListEl = document.getElementById("stage-list");
        const canvasInner = document.getElementById("canvas-inner");
        const connectionSvg = document.getElementById("connection-svg");
        const addStageBtn = document.getElementById("add-stage-btn");
        const autoLayoutBtn = document.getElementById("auto-layout-btn");
        const resetFlowBtn = document.getElementById("reset-flow-btn");
        const clearConnectionsBtn =
          document.getElementById("clear-connections-btn");
        const statusLabel = document.getElementById("status-label");
        const persistenceIndicator = document.getElementById(
          "persistence-indicator"
        );

        const metricStagesCount = document.getElementById(
          "metric-stages-count"
        );
        const metricEntryStage = document.getElementById("metric-entry-stage");
        const metricPathsCount = document.getElementById("metric-paths-count");
        const metricDensity = document.getElementById("metric-density");
        const metricPurchaseIndex =
          document.getElementById("metric-purchase-index");
        const metricExitStage = document.getElementById("metric-exit-stage");

        const state = {
          nodes: [],
          links: [],
          nextNodeId: 1,
          nextLinkId: 1,
          selectedNodeId: null,
          isDraggingNodeId: null,
          dragOffset: { x: 0, y: 0 },
          connecting: null,
          connectionPathsMap: new Map(),
          tempConnectionPath: null,
          justRestored: false,
        };

        function loadState() {
          try {
            const raw = window.localStorage.getItem(STORAGE_KEY);
            if (!raw) {
              seedDefault();
              return;
            }
            const parsed = JSON.parse(raw);
            if (!parsed || !Array.isArray(parsed.nodes) || !Array.isArray(parsed.links)) {
              seedDefault();
              return;
            }
            state.nodes = parsed.nodes;
            state.links = parsed.links;
            state.nextNodeId = parsed.nextNodeId || (state.nodes.length + 1);
            state.nextLinkId = parsed.nextLinkId || (state.links.length + 1);
            state.selectedNodeId = parsed.selectedNodeId || null;
            state.justRestored = true;
            setStatus("Restored previous customer journey.");
          } catch {
            seedDefault();
          }
        }

        function seedDefault() {
          const defaults = [
            {
              title: "Awareness",
              description: "First touch — ads, social, or word of mouth.",
              badge: "Top of funnel",
            },
            {
              title: "Interest",
              description: "Customer explores your brand & content.",
              badge: "Engagement",
            },
            {
              title: "Consideration",
              description: "Comparing options, reading reviews, revisiting.",
              badge: "Middle of funnel",
            },
            {
              title: "Intent",
              description: "Signals of buying intent — demo, trial, cart.",
              badge: "Hot lead",
            },
            {
              title: "Evaluation",
              description: "Final objections and internal approvals.",
              badge: "Decision",
            },
            {
              title: "Purchase",
              description: "Conversion event — payment, contract, or signup.",
              badge: "Revenue",
            },
          ];

          const canvasRect = canvasInner.getBoundingClientRect();
          const width = canvasRect.width || 800;
          const startX = 80;
          const spacing =
            defaults.length > 1
              ? (width - startX * 2) / (defaults.length - 1)
              : 0;
          const centerY = canvasRect.height
            ? canvasRect.height / 2
            : 170;

          state.nodes = defaults.map((item, idx) => ({
            id: idx + 1,
            title: item.title,
            description: item.description,
            badge: item.badge,
            x: startX + spacing * idx,
            y: centerY - 60,
          }));
          state.links = [];
          for (let i = 0; i < state.nodes.length - 1; i++) {
            state.links.push({
              id: i + 1,
              fromId: state.nodes[i].id,
              toId: state.nodes[i + 1].id,
            });
          }
          state.nextNodeId = state.nodes.length + 1;
          state.nextLinkId = state.links.length + 1;
          state.selectedNodeId = state.nodes[0]?.id ?? null;
          setStatus("Initialized with a standard marketing funnel.");
        }

        function saveState(debounce) {
          try {
            const payload = {
              nodes: state.nodes,
              links: state.links,
              nextNodeId: state.nextNodeId,
              nextLinkId: state.nextLinkId,
              selectedNodeId: state.selectedNodeId,
            };
            window.localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
            flashPersistence(debounce);
          } catch {
            // ignore storage errors
          }
        }

        let persistenceTimeout;
        function flashPersistence(isSoft) {
          if (!persistenceIndicator) return;
          persistenceIndicator.textContent = "";
          const dot = document.createElement("span");
          dot.className = "micro-indicator-dot";
          const label = document.createElement("span");
          label.textContent = isSoft ? "Saved" : "Changes saved";
          persistenceIndicator.appendChild(dot);
          persistenceIndicator.appendChild(label);
          persistenceIndicator.classList.add("fade-in");
          clearTimeout(persistenceTimeout);
          persistenceTimeout = setTimeout(() => {
            persistenceIndicator.classList.remove("fade-in");
          }, 400);
        }

        function setStatus(text) {
          if (!statusLabel) return;
          statusLabel.textContent = text;
        }

        function clearNodeLayer() {
          while (nodeLayer.firstChild) {
            nodeLayer.removeChild(nodeLayer.firstChild);
          }
        }

        function clampPosition(x, y) {
          const rect = canvasInner.getBoundingClientRect();
          const padding = 60;
          const minX = padding;
          const maxX = rect.width - padding;
          const minY = padding;
          const maxY = rect.height - padding * 1.2;
          return {
            x: Math.min(Math.max(x, minX), maxX),
            y: Math.min(Math.max(y, minY), maxY),
          };
        }

        function renderNodes() {
          clearNodeLayer();
          const selectedId = state.selectedNodeId;

          state.nodes.forEach((node, index) => {
            const el = document.createElement("article");
            el.className = "journey-node fade-in";
            el.dataset.id = String(node.id);
            el.dataset.selected = selectedId === node.id ? "true" : "false";

            const { x, y } = clampPosition(node.x, node.y);
            node.x = x;
            node.y = y;
            el.style.left = x + "px";
            el.style.top = y + "px";

            const header = document.createElement("div");
            header.className = "journey-node-header";
            const indexPill = document.createElement("div");
            indexPill.className = "journey-node-index";
            indexPill.textContent = String(index + 1).padStart(2, "0");
            header.appendChild(indexPill);

            const actions = document.createElement("div");
            actions.className = "journey-node-actions";
            const deleteBtn = document.createElement("button");
            deleteBtn.type = "button";
            deleteBtn.className = "icon-btn";
            deleteBtn.title = "Delete stage";
            deleteBtn.textContent = "✕";
            actions.appendChild(deleteBtn);
            header.appendChild(actions);

            const title = document.createElement("div");
            title.className = "journey-node-title";
            title.textContent = node.title || "Untitled stage";
            title.setAttribute("contenteditable", "true");

            const subtitle = document.createElement("div");
            subtitle.className = "journey-node-subtitle";
            subtitle.textContent =
              node.description ||
              "Describe what customers are doing here.";

            const badges = document.createElement("div");
            badges.className = "journey-node-badges";

            const badgePrimary = document.createElement("span");
            badgePrimary.className =
              "journey-node-badge";
            badgePrimary.dataset.variant = "primary";
            badgePrimary.textContent = node.badge || "Stage";
            badges.appendChild(badgePrimary);

            const badgeSecondary = document.createElement("span");
            badgeSecondary.className = "journey-node-badge";
            badgeSecondary.textContent =
              index === 0
                ? "Entry"
                : index === state.nodes.length - 1
                ? "Exit"
                : "Mid‑journey";
            badges.appendChild(badgeSecondary);

            const footer = document.createElement("div");
            footer.className = "journey-node-footer";

            const metric = document.createElement("div");
            metric.className = "node-metric";
            metric.innerHTML =
              '<span>Drop‑off est.</span> <strong>' +
              (10 + index * 6) +
              "%</strong>";
            footer.appendChild(metric);

            const handles = document.createElement("div");
            handles.className = "node-handles";

            const inHandle = document.createElement("div");
            inHandle.className = "handle";
            inHandle.dataset.direction = "in";
            inHandle.title = "Drop paths here to connect to this stage";

            const outHandle = document.createElement("div");
            outHandle.className = "handle";
            outHandle.dataset.direction = "out";
            outHandle.title = "Drag from here to connect to another stage";

            handles.appendChild(inHandle);
            handles.appendChild(outHandle);
            footer.appendChild(handles);

            el.appendChild(header);
            el.appendChild(title);
            el.appendChild(subtitle);
            el.appendChild(badges);
            el.appendChild(footer);

            nodeLayer.appendChild(el);

            attachNodeListeners(el, node);
          });
        }

        function attachNodeListeners(el, node) {
          const header = el.querySelector(".journey-node-header");
          const title = el.querySelector(".journey-node-title");
          const deleteBtn = el.querySelector(".icon-btn");
          const inHandle = el.querySelector('.handle[data-direction="in"]');
          const outHandle = el.querySelector('.handle[data-direction="out"]');

          header.addEventListener("pointerdown", (event) =>
            onNodePointerDown(event, node, el)
          );
          el.addEventListener("pointerdown", (event) => {
            if (
              event.target === title ||
              event.target === deleteBtn ||
              event.target === inHandle ||
              event.target === outHandle
            ) {
              return;
            }
            onNodePointerDown(event, node, el);
          });

          el.addEventListener("click", () => {
            selectNode(node.id);
          });

          title.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
              event.preventDefault();
              title.blur();
            }
          });

          title.addEventListener("input", () => {
            node.title = title.textContent.trim() || "Untitled stage";
            updateStageList();
          });

          title.addEventListener("blur", () => {
            node.title = title.textContent.trim() || "Untitled stage";
            saveState(true);
          });

          deleteBtn.addEventListener("click", (event) => {
            event.stopPropagation();
            deleteNode(node.id);
          });

          if (outHandle) {
            outHandle.addEventListener("pointerdown", (event) => {
              event.stopPropagation();
              startConnectionDrag(event, node.id, outHandle);
            });
          }

          if (inHandle) {
            inHandle.addEventListener("pointerup", (event) => {
              if (!state.connecting) return;
              finishConnectionDrag(event, node.id, inHandle);
            });
          }
        }

        function selectNode(nodeId) {
          state.selectedNodeId = nodeId;
          renderNodes();
          updateStageList();
          updateConnectionsHighlight();
        }

        function deleteNode(nodeId) {
          if (state.nodes.length <= 1) {
            setStatus("You need at least one stage in the journey.");
            return;
          }
          state.nodes = state.nodes.filter((n) => n.id !== nodeId);
          state.links = state.links.filter(
            (l) => l.fromId !== nodeId && l.toId !== nodeId
          );
          if (state.selectedNodeId === nodeId) {
            state.selectedNodeId = state.nodes[0]?.id ?? null;
          }
          setStatus("Removed stage and any connected paths.");
          renderNodes();
          renderConnections();
          updateStageList();
          updateMetrics();
          saveState();
        }

        function onNodePointerDown(event, node, el) {
          if (event.button !== 0) return;
          event.preventDefault();
          const rect = el.getBoundingClientRect();
          const canvasRect = canvasInner.getBoundingClientRect();
          state.isDraggingNodeId = node.id;
          state.dragOffset.x = event.clientX - rect.left;
          state.dragOffset.y = event.clientY - rect.top;
          el.dataset.dragging = "true";

          const onMove = (moveEvent) => {
            if (state.isDraggingNodeId !== node.id) return;
            const x = moveEvent.clientX - canvasRect.left - state.dragOffset.x;
            const y = moveEvent.clientY - canvasRect.top - state.dragOffset.y;
            const clamped = clampPosition(x, y);
            node.x = clamped.x;
            node.y = clamped.y;
            el.style.left = clamped.x + "px";
            el.style.top = clamped.y + "px";
            renderConnections();
            setStatus("Dragging \"" + node.title + "\".");
          };

          const onUp = () => {
            state.isDraggingNodeId = null;
            el.dataset.dragging = "false";
            window.removeEventListener("pointermove", onMove);
            window.removeEventListener("pointerup", onUp);
            renderConnections();
            updateStageList();
            updateMetrics();
            saveState(true);
            setStatus("Stage position updated.");
          };

          window.addEventListener("pointermove", onMove);
          window.addEventListener("pointerup", onUp);
        }

        function clearConnectionsSvg() {
          state.connectionPathsMap.clear();
          const toRemove = [];
          connectionSvg.childNodes.forEach((child) => {
            if (
              child.nodeType === Node.ELEMENT_NODE &&
              child.tagName.toLowerCase() === "path"
            ) {
              toRemove.push(child);
            }
          });
          toRemove.forEach((node) => node.remove());
        }

        function renderConnections() {
          const rect = canvasInner.getBoundingClientRect();
          if (!rect.width || !rect.height) {
            return;
          }
          clearConnectionsSvg();

          state.links.forEach((link) => {
            const from = getHandleCenter(link.fromId, "out");
            const to = getHandleCenter(link.toId, "in");
            if (!from || !to) return;

            const path = document.createElementNS(SVG_NS, "path");
            path.classList.add("flow-connection");
            path.dataset.id = String(link.id);
            path.setAttribute("marker-end", "url(#arrow-end)");

            const d = buildCurvePath(rect, from, to);
            path.setAttribute("d", d);
            connectionSvg.appendChild(path);
            state.connectionPathsMap.set(link.id, path);
          });

          updateConnectionsHighlight();
        }

        function buildCurvePath(canvasRect, from, to) {
          const startX = from.x - canvasRect.left;
          const startY = from.y - canvasRect.top;
          const endX = to.x - canvasRect.left;
          const endY = to.y - canvasRect.top;
          const dx = Math.max(40, Math.abs(endX - startX) * 0.5);
          const c1X = startX + dx;
          const c1Y = startY;
          const c2X = endX - dx;
          const c2Y = endY;
          return (
            "M " +
            startX +
            " " +
            startY +
            " C " +
            c1X +
            " " +
            c1Y +
            ", " +
            c2X +
            " " +
            c2Y +
            ", " +
            endX +
            " " +
            endY
          );
        }

        function getHandleCenter(nodeId, direction) {
          const nodeEl = nodeLayer.querySelector(
            '.journey-node[data-id="' + nodeId + '"]'
          );
          if (!nodeEl) return null;
          const selector =
            '.handle[data-direction="' + (direction === "out" ? "out" : "in") + '"]';
          const handle = nodeEl.querySelector(selector);
          if (!handle) return null;
          const rect = handle.getBoundingClientRect();
          return {
            x: rect.left + rect.width / 2,
            y: rect.top + rect.height / 2,
          };
        }

        function startConnectionDrag(event, fromId, handleEl) {
          const rect = canvasInner.getBoundingClientRect();
          const from = getHandleCenter(fromId, "out");
          if (!from) return;

          state.connecting = {
            fromId,
            pointerId: event.pointerId,
          };

          handleEl.dataset.active = "true";

          const temp = document.createElementNS(SVG_NS, "path");
          temp.classList.add("flow-connection", "flow-connection-temp");
          connectionSvg.appendChild(temp);
          state.tempConnectionPath = temp;

          const onMove = (moveEvent) => {
            if (!state.connecting || moveEvent.pointerId !== event.pointerId) return;
            const to = {
              x: moveEvent.clientX,
              y: moveEvent.clientY,
            };
            const d = buildCurvePath(rect, from, to);
            temp.setAttribute("d", d);
          };

          const onUp = (upEvent) => {
            if (!state.connecting || upEvent.pointerId !== event.pointerId) return;

            const target = upEvent.target;
            if (
              target &&
              target.classList &&
              target.classList.contains("handle") &&
              target.dataset.direction === "in"
            ) {
              const nodeEl = target.closest(".journey-node");
              if (nodeEl) {
                const toId = Number(nodeEl.dataset.id);
                finishConnectionDrag(upEvent, toId, target);
              }
            }

            cleanup();
          };

          function cleanup() {
            handleEl.dataset.active = "false";
            if (state.tempConnectionPath) {
              state.tempConnectionPath.remove();
            }
            state.tempConnectionPath = null;
            state.connecting = null;
            window.removeEventListener("pointermove", onMove);
            window.removeEventListener("pointerup", onUp);
          }

          window.addEventListener("pointermove", onMove);
          window.addEventListener("pointerup", onUp);

          setStatus("Drag to another stage to create a path.");
        }

        function finishConnectionDrag(event, toId, handleEl) {
          event.stopPropagation();
          if (!state.connecting) return;
          const { fromId } = state.connecting;
          if (fromId === toId) {
            setStatus("A stage cannot connect to itself.");
            return;
          }

          const exists = state.links.some(
            (link) => link.fromId === fromId && link.toId === toId
          );
          if (exists) {
            setStatus("This connection already exists.");
            return;
          }

          const link = {
            id: state.nextLinkId++,
            fromId,
            toId,
          };
          state.links.push(link);
          saveState();
          renderConnections();
          updateMetrics();
          setStatus("Connected stages with a new path.");

          if (handleEl) {
            handleEl.dataset.active = "false";
          }
        }

        function updateConnectionsHighlight() {
          const selectedId = state.selectedNodeId;
          const anySelected = typeof selectedId === "number";
          state.links.forEach((link) => {
            const path = state.connectionPathsMap.get(link.id);
            if (!path) return;
            if (!anySelected) {
              path.dataset.muted = "false";
            } else {
              const related =
                link.fromId === selectedId || link.toId === selectedId;
              path.dataset.muted = related ? "false" : "true";
            }
          });
        }

        function updateStageList() {
          stageListEl.innerHTML = "";

          const nodesSorted = [...state.nodes].sort((a, b) => a.x - b.x);
          nodesSorted.forEach((node, index) => {
            const li = document.createElement("li");
            li.className = "stage-item";
            li.dataset.id = String(node.id);
            if (state.selectedNodeId === node.id) {
              li.classList.add("selected");
            }

            const label = document.createElement("span");
            label.className = "label";
            label.textContent = node.title || "Untitled stage";
            li.appendChild(label);

            const indexBadge = document.createElement("span");
            indexBadge.className = "stage-item-stage-index";
            indexBadge.textContent = index === 0
              ? "Entry"
              : index === nodesSorted.length - 1
              ? "Exit"
              : "Step " + (index + 1);
            li.appendChild(indexBadge);

            const deleteBtn = document.createElement("button");
            deleteBtn.type = "button";
            deleteBtn.title = "Delete stage";
            deleteBtn.textContent = "✕";
            li.appendChild(deleteBtn);

            li.addEventListener("click", (event) => {
              if (event.target === deleteBtn) return;
              selectNode(node.id);
              const nodeEl = nodeLayer.querySelector(
                '.journey-node[data-id="' + node.id + '"]'
              );
              if (nodeEl) {
                nodeEl.scrollIntoView({ behavior: "smooth", block: "center" });
              }
            });

            deleteBtn.addEventListener("click", (event) => {
              event.stopPropagation();
              deleteNode(node.id);
            });

            stageListEl.appendChild(li);
          });
        }

        function updateMetrics() {
          const nodes = state.nodes;
          const links = state.links;
          metricStagesCount.textContent = nodes.length.toString();
          metricPathsCount.textContent = links.length.toString();

          if (nodes.length) {
            const entry = nodes[0];
            const exit = nodes[nodes.length - 1];
            metricEntryStage.textContent = "Entry: " + (entry.title || "–");
            metricExitStage.textContent = "Exit: " + (exit.title || "–");
          } else {
            metricEntryStage.textContent = "Entry: —";
            metricExitStage.textContent = "Exit: —";
          }

          const possibleConnections =
            nodes.length > 1 ? nodes.length * (nodes.length - 1) : 1;
          const density = Math.min(
            100,
            Math.round((links.length / possibleConnections) * 100)
          );
          metricDensity.textContent =
            "Density: " + (isFinite(density) ? density : 0) + "%";

          const purchaseIndex =
            nodes.length > 1 ? Math.round((nodes.length / 6) * 100) : 20;
          metricPurchaseIndex.textContent = purchaseIndex + "%";
        }

        function createStage() {
          const canvasRect = canvasInner.getBoundingClientRect();
          const x =
            canvasRect.width / 2 +
            (Math.random() > 0.5 ? 80 : -80) * Math.random();
          const y = canvasRect.height / 2 + (Math.random() - 0.5) * 40;
          const clamped = clampPosition(x, y);

          const node = {
            id: state.nextNodeId++,
            title: "New stage",
            description: "Describe this step in the journey.",
            badge: "Custom",
            x: clamped.x,
            y: clamped.y,
          };
          state.nodes.push(node);
          state.selectedNodeId = node.id;
          renderNodes();
          renderConnections();
          updateStageList();
          updateMetrics();
          saveState();
          setStatus("Added a new stage — drag to position it.");
        }

        function autoLayout() {
          const canvasRect = canvasInner.getBoundingClientRect();
          const width = canvasRect.width || 900;
          const startX = 80;
          const spacing =
            state.nodes.length > 1
              ? (width - startX * 2) / (state.nodes.length - 1)
              : 0;
          const centerY = canvasRect.height
            ? canvasRect.height / 2
            : 170;

          state.nodes.forEach((node, idx) => {
            const clamped = clampPosition(
              startX + spacing * idx,
              centerY - 60
            );
            node.x = clamped.x;
            node.y = clamped.y;
          });
          renderNodes();
          renderConnections();
          updateStageList();
          updateMetrics();
          saveState();
          setStatus("Auto‑laid out stages across the canvas.");
        }

        function clearConnections() {
          state.links = [];
          renderConnections();
          updateMetrics();
          saveState();
          setStatus("Cleared all paths between stages.");
        }

        function resetFlow() {
          seedDefault();
          renderNodes();
          renderConnections();
          updateStageList();
          updateMetrics();
          saveState();
          setStatus("Reset to the default funnel.");
        }

        function handleResize() {
          renderNodes();
          renderConnections();
        }

        function bindGlobalShortcuts() {
          window.addEventListener("keydown", (event) => {
            const isMeta = event.metaKey || event.ctrlKey;
            if (isMeta && (event.key === "s" || event.key === "S")) {
              event.preventDefault();
              saveState();
              setStatus("Layout saved.");
            }
          });
        }

        function init() {
          loadState();
          renderNodes();
          renderConnections();
          updateStageList();
          updateMetrics();

          if (state.justRestored) {
            setStatus("Restored your previous journey. Drag to adjust.");
          }

          addStageBtn.addEventListener("click", createStage);
          autoLayoutBtn.addEventListener("click", autoLayout);
          clearConnectionsBtn.addEventListener("click", clearConnections);
          resetFlowBtn.addEventListener("click", resetFlow);
          window.addEventListener("resize", handleResize);
          bindGlobalShortcuts();
        }

        document.addEventListener("DOMContentLoaded", init);
      })();
    </script>
  </body>
</html>

