<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kinetic Typography Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:wght@400;700&family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
      --background: #020617;
      --background-elevated: #020617;
      --surface: #020617;
      --surface-soft: #020617;
      --outline-subtle: #1f2937;
      --outline-strong: #4b5563;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.2);
      --accent-strong: #0ea5e9;
      --text-main: #f9fafb;
      --text-soft: #9ca3af;
      --danger: #fb7185;
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --shadow-soft: 0 24px 80px rgba(15, 23, 42, 0.9);
      --shadow-subtle: 0 18px 45px rgba(15, 23, 42, 0.75);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 100%);
      color: var(--text-main);
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    body {
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .app-shell {
      position: relative;
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 1440px;
      height: 100vh;
      max-height: 900px;
      margin: auto;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 100%);
      border-radius: 32px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9), 0 40px 120px rgba(15, 23, 42, 0.95);
      overflow: hidden;
    }

    .app-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.14), transparent 60%),
        radial-gradient(circle at 100% 100%, rgba(139, 92, 246, 0.16), transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.9;
    }

    .app-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 22px 10px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.7);
      background: linear-gradient(to right, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.88)), radial-gradient(circle at top left, rgba(56, 189, 248, 0.3), transparent 60%);
      backdrop-filter: blur(32px) saturate(140%);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background:
        conic-gradient(from 220deg, rgba(56, 189, 248, 0.15), rgba(129, 140, 248, 0.4), rgba(56, 189, 248, 0.15));
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.5),
        0 0 24px rgba(59, 130, 246, 0.9);
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e0f2fe;
    }

    .brand-text-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5f6ff;
    }

    .brand-text-subtitle {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
    }

    .transport-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.8), rgba(15, 23, 42, 0.9));
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.9);
      font-size: 11px;
      color: #e5f3ff;
    }

    .pill span.key {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
      font-family: "Space Grotesk", system-ui, sans-serif;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(226, 232, 240, 0.95);
    }

    .transport-buttons {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px;
      border-radius: 999px;
      border: 1px solid rgba(51, 65, 85, 0.8);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      box-shadow: 0 15px 40px rgba(15, 23, 42, 0.95);
    }

    .btn-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-main);
      cursor: pointer;
      transition: background 150ms ease, transform 120ms ease, box-shadow 150ms ease, color 150ms ease;
      font-size: 16px;
    }

    .btn-icon.primary {
      background: radial-gradient(circle at top, #0ea5e9, #0369a1);
      box-shadow:
        0 0 0 1px rgba(56, 189, 248, 0.5),
        0 12px 32px rgba(56, 189, 248, 0.7);
      color: #0b1120;
    }

    .btn-icon.secondary {
      color: #e5e7eb;
      border-radius: 12px;
    }

    .btn-icon:hover {
      transform: translateY(-0.5px);
      background: rgba(15, 23, 42, 0.85);
    }

    .btn-icon.primary:hover {
      background: radial-gradient(circle at top, #38bdf8, #0ea5e9);
      transform: translateY(-1px) scale(1.02);
    }

    .btn-icon:active {
      transform: translateY(0) scale(0.98);
      box-shadow: none;
    }

    .export-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .export-group {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.8);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      box-shadow: 0 14px 36px rgba(15, 23, 42, 0.9);
    }

    .export-group label {
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
    }

    .export-select {
      appearance: none;
      border: none;
      outline: none;
      padding: 3px 18px 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      color: #e5f3ff;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background-image: linear-gradient(45deg, transparent 50%, rgba(148, 163, 184, 0.9) 50%), linear-gradient(135deg, rgba(148, 163, 184, 0.9) 50%, transparent 50%);
      background-position: calc(100% - 10px) 9px, calc(100% - 6px) 9px;
      background-size: 4px 4px, 4px 4px;
      background-repeat: no-repeat;
    }

    .btn-export {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      cursor: pointer;
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.3), rgba(59, 130, 246, 1));
      color: #e0f2fe;
      box-shadow:
        0 0 0 1px rgba(56, 189, 248, 0.8),
        0 16px 40px rgba(56, 189, 248, 0.85);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-export span.icon {
      font-size: 13px;
    }

    .btn-export:hover {
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.6), rgba(59, 130, 246, 1));
      transform: translateY(-1px);
    }

    .btn-export:active {
      transform: translateY(0) scale(0.98);
      box-shadow: none;
    }

    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: 310px minmax(0, 1.35fr) 320px;
      grid-template-rows: minmax(0, 1fr) auto;
      gap: 10px;
      padding: 10px 14px 14px;
    }

    .panel {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 10px 10px 12px;
      border-radius: var(--radius-md);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.94), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(30, 64, 175, 0.6);
      box-shadow: var(--shadow-subtle);
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        linear-gradient(120deg, rgba(56, 189, 248, 0.18), transparent 40%, transparent 60%, rgba(129, 140, 248, 0.16));
      opacity: 0.5;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .panel-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      margin-bottom: 2px;
    }

    .panel-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(209, 213, 219, 0.98);
    }

    .panel-subtitle {
      font-size: 10px;
      color: var(--text-soft);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(156, 163, 175, 0.95);
      background: rgba(15, 23, 42, 0.96);
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }

    .sidebar-scroll {
      flex: 1;
      min-height: 0;
      overflow: auto;
      padding-right: 2px;
      scroll-behavior: smooth;
    }

    .sidebar-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-scroll::-webkit-scrollbar-thumb {
      background: rgba(30, 64, 175, 0.8);
      border-radius: 999px;
    }

    .form-row {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      align-items: center;
      gap: 8px;
    }

    .form-label {
      font-size: 11px;
      color: rgba(209, 213, 219, 0.98);
    }

    .form-label span.hint {
      display: block;
      font-size: 10px;
      color: rgba(148, 163, 184, 0.95);
      margin-top: 1px;
    }

    .field {
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input, .select, .textarea, .slider-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(51, 65, 85, 0.95);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      color: #e5f3ff;
      font-size: 11px;
      padding: 6px 9px;
      outline: none;
      transition: border 140ms ease, box-shadow 140ms ease, background 140ms ease;
    }

    .input:focus, .select:focus, .textarea:focus, .slider-input:focus {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.8);
    }

    .textarea {
      border-radius: 10px;
      min-height: 80px;
      resize: vertical;
      font-size: 12px;
      line-height: 1.4;
    }

    .select {
      appearance: none;
      padding-right: 20px;
      background-image: linear-gradient(45deg, transparent 50%, rgba(148, 163, 184, 0.9) 50%), linear-gradient(135deg, rgba(148, 163, 184, 0.9) 50%, transparent 50%);
      background-position: calc(100% - 12px) 10px, calc(100% - 8px) 10px;
      background-size: 4px 4px, 4px 4px;
      background-repeat: no-repeat;
    }

    .input-number {
      max-width: 72px;
      text-align: right;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.96);
      padding: 3px 8px;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(156, 163, 175, 0.98);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chip.active {
      border-color: rgba(56, 189, 248, 0.95);
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.25), rgba(15, 23, 42, 0.96));
      color: #e0f2fe;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.8);
    }

    .chip span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 1);
    }

    .chip.active span.dot {
      background: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.4);
    }

    .preview-shell {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .preview-stage {
      position: relative;
      flex: 1;
      min-height: 0;
      border-radius: var(--radius-lg);
      background:
        radial-gradient(circle at top left, rgba(8, 47, 73, 0.9), rgba(15, 23, 42, 0.98)),
        radial-gradient(circle at bottom right, rgba(30, 64, 175, 0.9), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(30, 64, 175, 0.9);
      box-shadow:
        0 28px 80px rgba(15, 23, 42, 0.98),
        0 0 0 1px rgba(15, 23, 42, 0.96);
      overflow: hidden;
      padding: 16px;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .preview-frame-wrapper {
      position: relative;
      margin: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 1)),
        repeating-linear-gradient(45deg, rgba(15, 23, 42, 0.6), rgba(15, 23, 42, 0.6) 1px, rgba(15, 23, 42, 0.8) 1px, rgba(15, 23, 42, 0.8) 3px);
      border-radius: 26px;
      padding: 16px;
      box-shadow: 0 40px 100px rgba(15, 23, 42, 0.98);
    }

    .preview-frame-mask {
      position: relative;
      border-radius: 24px;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.96),
        0 0 0 2px rgba(51, 65, 85, 0.9),
        0 0 0 3px rgba(15, 23, 42, 0.98);
      overflow: hidden;
      background: #020617;
    }

    canvas#previewCanvas {
      display: block;
      max-width: 100%;
      max-height: 100%;
      background: #020617;
    }

    .safe-badge {
      position: absolute;
      top: 10px;
      left: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.8);
      background: rgba(15, 23, 42, 0.9);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: rgba(191, 219, 254, 0.95);
      backdrop-filter: blur(10px);
      pointer-events: none;
    }

    .preview-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .preview-meta-left {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: rgba(148, 163, 184, 0.98);
    }

    .preview-meta-left span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.35);
    }

    .preview-meta-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .preview-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 3px 7px;
      font-size: 10px;
      color: rgba(209, 213, 219, 0.94);
      background: rgba(15, 23, 42, 0.96);
    }

    .preview-pill span.indicator {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #38bdf8, #0ea5e9);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.8);
    }

    .timeline {
      grid-column: 1 / span 3;
      border-radius: 18px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 1));
      border: 1px solid rgba(30, 64, 175, 0.9);
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.98),
        0 0 0 1px rgba(15, 23, 42, 0.96);
      padding: 8px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 0;
    }

    .timeline-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .timeline-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .timeline-title {
      font-size: 11px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: rgba(209, 213, 219, 0.96);
    }

    .time-label {
      font-family: "Space Grotesk", system-ui, sans-serif;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.98);
    }

    .timeline-main {
      display: grid;
      grid-template-columns: 130px minmax(0, 1fr);
      gap: 10px;
      align-items: stretch;
      min-height: 0;
    }

    .timeline-lane-labels {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 10px;
      color: rgba(148, 163, 184, 0.98);
    }

    .timeline-lane-labels span {
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.96);
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .timeline-lane-labels span .lane-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 1);
    }

    .timeline-track-shell {
      position: relative;
      border-radius: 12px;
      background:
        linear-gradient(to bottom, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98)),
        linear-gradient(to right, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(31, 41, 55, 0.95);
      box-shadow: inset 0 1px 0 rgba(148, 163, 184, 0.12);
      overflow: hidden;
      padding: 6px 8px 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 0;
    }

    .timeline-grid {
      position: relative;
      flex: 1;
      min-height: 0;
      border-radius: 8px;
      background-image: linear-gradient(to right, rgba(30, 64, 175, 0.6) 1px, transparent 1px), linear-gradient(to bottom, rgba(30, 64, 175, 0.6) 1px, transparent 1px);
      background-size: 36px 100%, 100% 16px;
      background-position: -1px 0, 0 0;
      overflow: hidden;
    }

    .timeline-keyframes {
      position: absolute;
      inset: 0;
    }

    .keyframe-marker {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 2px;
      transform: translate(-50%, -50%) rotate(45deg);
      background: radial-gradient(circle at top, rgba(56, 189, 248, 1), rgba(37, 99, 235, 1));
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.96),
        0 0 0 2px rgba(56, 189, 248, 0.85);
      cursor: pointer;
    }

    .keyframe-marker.secondary {
      background: radial-gradient(circle at top, rgba(129, 140, 248, 1), rgba(79, 70, 229, 1));
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.96),
        0 0 0 2px rgba(129, 140, 248, 0.9);
    }

    .playhead {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 1px;
      background: linear-gradient(to bottom, rgba(248, 250, 252, 0.96), rgba(56, 189, 248, 0.98));
      pointer-events: none;
    }

    .playhead-handle {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #38bdf8, #0ea5e9);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.96),
        0 0 0 2px rgba(56, 189, 248, 0.9);
    }

    .timeline-scrub {
      position: relative;
      margin-top: 4px;
      padding: 4px 0 0;
    }

    .timeline-range {
      width: 100%;
      appearance: none;
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(to right, rgba(30, 64, 175, 0.9), rgba(37, 99, 235, 0.95));
      outline: none;
    }

    .timeline-range::-webkit-slider-thumb {
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(15, 23, 42, 1);
      background: radial-gradient(circle at top, #38bdf8, #0ea5e9);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.8);
      cursor: pointer;
      margin-top: -5px;
    }

    .timeline-range::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(15, 23, 42, 1);
      background: radial-gradient(circle at top, #38bdf8, #0ea5e9);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.8);
      cursor: pointer;
    }

    .timeline-range::-moz-range-track {
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(to right, rgba(30, 64, 175, 0.9), rgba(37, 99, 235, 0.95));
    }

    .timeline-shortcuts {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      font-size: 9px;
      color: rgba(148, 163, 184, 0.98);
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .timeline-shortcuts span.key {
      padding: 2px 5px;
      border-radius: 6px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.96);
      font-family: "Space Grotesk", system-ui, sans-serif;
    }

    .keyframe-list {
      max-height: 140px;
      overflow: auto;
      padding-right: 2px;
    }

    .keyframe-row {
      display: grid;
      grid-template-columns: 60px 1fr auto;
      align-items: center;
      gap: 4px;
      padding: 4px 6px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(31, 41, 55, 0.95);
      font-size: 10px;
      margin-bottom: 3px;
    }

    .keyframe-row.active {
      border-color: rgba(56, 189, 248, 0.95);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.7);
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.25), rgba(15, 23, 42, 0.98));
    }

    .keyframe-row button {
      border-radius: 999px;
      border: none;
      padding: 3px 7px;
      font-size: 9px;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.96);
      color: rgba(209, 213, 219, 0.96);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .keyframe-row button:hover {
      border-color: rgba(56, 189, 248, 0.9);
      color: #e0f2fe;
    }

    .badge-soft {
      padding: 2px 5px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 9px;
      color: rgba(148, 163, 184, 0.98);
      background: rgba(15, 23, 42, 0.96);
    }

    .field-inline {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: rgba(148, 163, 184, 0.98);
    }

    .field-inline input[type="checkbox"] {
      width: 12px;
      height: 12px;
      accent-color: #38bdf8;
    }

    .field-inline input[type="color"] {
      width: 24px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(51, 65, 85, 0.98);
      padding: 0;
      background: transparent;
    }

    input[type="range"].slider {
      width: 100%;
      appearance: none;
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(to right, rgba(30, 64, 175, 0.9), rgba(37, 99, 235, 0.95));
      outline: none;
    }

    input[type="range"].slider::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #e0f2fe;
      border: 2px solid rgba(15, 23, 42, 1);
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 1);
      cursor: pointer;
      margin-top: -4px;
    }

    input[type="range"].slider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #e0f2fe;
      border: 2px solid rgba(15, 23, 42, 1);
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 1);
      cursor: pointer;
    }

    input[type="range"].slider::-moz-range-track {
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(to right, rgba(30, 64, 175, 0.9), rgba(37, 99, 235, 0.95));
    }

    .easing-preview {
      width: 100%;
      height: 70px;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background:
        linear-gradient(to right, rgba(31, 41, 55, 0.96), rgba(15, 23, 42, 0.98)),
        repeating-linear-gradient(90deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.96) 1px, rgba(15, 23, 42, 0.98) 1px, rgba(15, 23, 42, 0.98) 8px);
    }

    .status-line {
      font-size: 10px;
      color: rgba(148, 163, 184, 0.96);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .status-line strong {
      color: rgba(226, 232, 240, 0.98);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #facc15;
      box-shadow: 0 0 0 4px rgba(234, 179, 8, 0.4);
    }

    footer.app-footer {
      padding: 8px 18px 10px;
      border-top: 1px solid rgba(15, 23, 42, 0.98);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 1));
      font-size: 10px;
      color: rgba(148, 163, 184, 0.96);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    footer.app-footer code {
      font-family: "Space Grotesk", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(226, 232, 240, 0.98);
    }

    footer.app-footer span.kbd {
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.96);
      font-family: "Space Grotesk", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 10px;
      color: rgba(226, 232, 240, 0.98);
    }

    .hidden-visually {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media (max-width: 1100px) {
      .layout {
        grid-template-columns: 280px minmax(0, 1.4fr) 280px;
      }
    }

    @media (max-width: 980px) {
      .app-shell {
        max-height: none;
        border-radius: 0;
      }

      .layout {
        grid-template-columns: minmax(0, 1fr);
        grid-template-rows: auto minmax(0, 1fr) auto;
      }

      .timeline {
        grid-column: auto;
      }
    }

    @media (max-width: 720px) {
      header.app-header {
        flex-wrap: wrap;
        row-gap: 8px;
      }

      .export-controls {
        width: 100%;
        justify-content: flex-end;
      }

      .export-group {
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .sidebar-scroll {
        max-height: 230px;
      }

      footer.app-footer {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell" role="application" aria-label="Kinetic Typography Studio">
    <div class="app-inner">
      <header class="app-header">
        <div class="brand" aria-label="Kinetic Typography Studio identity">
          <div class="brand-mark">KT</div>
          <div>
            <div class="brand-text-title">Kinetic Typography Studio</div>
            <div class="brand-text-subtitle">Motion type, beat‑aware</div>
          </div>
        </div>
        <div class="transport-toolbar" role="toolbar" aria-label="Transport and keyframe controls">
          <div class="pill" aria-hidden="true">
            <span class="key">Space</span>
            <span>Play / Pause</span>
          </div>
          <div class="transport-buttons">
            <button class="btn-icon secondary" type="button" id="jumpBackButton" aria-label="Jump backward">
              &#9664;
            </button>
            <button class="btn-icon primary" type="button" id="playPauseButton" aria-label="Play or pause animation">
              &#9658;
            </button>
            <button class="btn-icon secondary" type="button" id="jumpForwardButton" aria-label="Jump forward">
              &#9654;
            </button>
          </div>
          <button class="btn-icon secondary" type="button" id="addKeyframeButton" aria-label="Add keyframe at playhead">
            &#9673;
          </button>
          <div class="pill" aria-hidden="true">
            <span class="key">A</span>
            <span>Add keyframe</span>
          </div>
        </div>
        <div class="export-controls" aria-label="Export and output settings">
          <div class="export-group" aria-label="Aspect, resolution and frame rate">
            <label for="aspectSelect">Aspect</label>
            <select id="aspectSelect" class="export-select" aria-label="Aspect ratio">
              <option value="9:16">9 : 16</option>
              <option value="1:1">1 : 1</option>
              <option value="16:9">16 : 9</option>
            </select>
            <label for="resolutionSelect">Res</label>
            <select id="resolutionSelect" class="export-select" aria-label="Resolution">
              <option value="1080x1920">1080 × 1920</option>
              <option value="720x1280">720 × 1280</option>
              <option value="1080x1080">1080 × 1080</option>
              <option value="1920x1080">1920 × 1080</option>
            </select>
            <label for="fpsSelect">FPS</label>
            <select id="fpsSelect" class="export-select" aria-label="Frame rate">
              <option value="24">24</option>
              <option value="30" selected>30</option>
              <option value="60">60</option>
            </select>
            <label for="durationSelect">Dur</label>
            <select id="durationSelect" class="export-select" aria-label="Duration in seconds">
              <option value="3">3s</option>
              <option value="5" selected>5s</option>
              <option value="8">8s</option>
              <option value="10">10s</option>
            </select>
          </div>
          <button type="button" id="exportVideoButton" class="btn-export" aria-label="Export WebM video">
            <span class="icon">&#11015;</span>
            <span>WebM</span>
          </button>
          <button type="button" id="exportGifButton" class="btn-export" aria-label="Export animated GIF">
            <span class="icon">&#11015;</span>
            <span>GIF</span>
          </button>
          <button type="button" id="exportPngButton" class="btn-export" aria-label="Export PNG sequence">
            <span class="icon">&#11015;</span>
            <span>PNG</span>
          </button>
        </div>
      </header>
      <main class="layout">
        <section class="sidebar" aria-label="Text and style controls">
          <div class="sidebar-scroll">
            <section class="panel" aria-label="Text content and preset animation">
              <div class="panel-inner">
                <div class="panel-header">
                  <div>
                    <div class="panel-title">Text</div>
                    <div class="panel-subtitle">Copy, chunks, and presets</div>
                  </div>
                  <span class="tag">Layer 01</span>
                </div>
                <div class="form-row">
                  <label class="form-label" for="textInput">
                    Content
                    <span class="hint">Supports multiple lines</span>
                  </label>
                  <div class="field">
                    <textarea id="textInput" class="textarea" aria-label="Text content">Kinetic
Typography
Studio</textarea>
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="presetSelect">
                    Animation preset
                    <span class="hint">Seed the timeline</span>
                  </label>
                  <div class="field">
                    <select id="presetSelect" class="select" aria-label="Animation preset">
                      <option value="none">None</option>
                      <option value="typewriter">Typewriter</option>
                      <option value="fadeUp">Fade up</option>
                      <option value="bounce">Bounce</option>
                      <option value="liquid">Liquid</option>
                      <option value="glitch">Glitch</option>
                      <option value="cascadeLetters">Cascade – letters</option>
                      <option value="cascadeWords">Cascade – words</option>
                      <option value="cascadeLines">Cascade – lines</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <span class="form-label">
                    Cascade units
                    <span class="hint">Stagger within text</span>
                  </span>
                  <div class="chip-row" id="cascadeChips" aria-label="Cascade by letters, words or lines">
                    <button type="button" class="chip active" data-cascade="letters">
                      <span class="dot"></span>
                      Letters
                    </button>
                    <button type="button" class="chip" data-cascade="words">
                      <span class="dot"></span>
                      Words
                    </button>
                    <button type="button" class="chip" data-cascade="lines">
                      <span class="dot"></span>
                      Lines
                    </button>
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="staggerRange">
                    Stagger
                    <span class="hint">Delay per glyph (s)</span>
                  </label>
                  <div class="field">
                    <input id="staggerRange" type="range" min="0" max="0.2" step="0.005" value="0.04" class="slider" aria-label="Per-glyph stagger">
                    <input id="staggerValue" type="number" min="0" max="0.2" step="0.005" value="0.04" class="input input-number" aria-label="Stagger value">
                  </div>
                </div>
              </div>
            </section>

            <section class="panel" aria-label="Typography settings">
              <div class="panel-inner">
                <div class="panel-header">
                  <div>
                    <div class="panel-title">Typography</div>
                    <div class="panel-subtitle">Font, weight, and tracking</div>
                  </div>
                  <span class="tag">Glyphs</span>
                </div>
                <div class="form-row">
                  <label class="form-label" for="fontFamilySelect">
                    Font
                    <span class="hint">Mix system and display</span>
                  </label>
                  <div class="field">
                    <select id="fontFamilySelect" class="select" aria-label="Font family">
                      <option value="Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif">Inter</option>
                      <option value="'Space Grotesk', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif">Space Grotesk</option>
                      <option value="'Playfair Display', 'Times New Roman', serif">Playfair Display</option>
                      <option value="'SF Pro Text', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif">SF Pro (system)</option>
                      <option value="'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif">Segoe UI (system)</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="fontWeightSelect">
                    Weight
                    <span class="hint">Tone of voice</span>
                  </label>
                  <div class="field">
                    <select id="fontWeightSelect" class="select" aria-label="Font weight">
                      <option value="300">Light</option>
                      <option value="400" selected>Regular</option>
                      <option value="600">Semi-bold</option>
                      <option value="700">Bold</option>
                    </select>
                    <label class="field-inline" for="italicToggle">
                      <input id="italicToggle" type="checkbox" aria-label="Italic">
                      <span>Italic</span>
                    </label>
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="fontSizeRange">
                    Size
                    <span class="hint">Relative scale</span>
                  </label>
                  <div class="field">
                    <input id="fontSizeRange" type="range" min="24" max="160" step="2" value="96" class="slider" aria-label="Font size">
                    <input id="fontSizeValue" type="number" min="24" max="160" step="2" value="96" class="input input-number" aria-label="Font size value">
                  </div>
                </div>
                <div class="form-row">
                  <span class="form-label">
                    Align
                    <span class="hint">Text anchor</span>
                  </span>
                  <div class="chip-row" id="alignChips" aria-label="Text alignment">
                    <button type="button" class="chip active" data-align="center">
                      <span class="dot"></span>
                      Center
                    </button>
                    <button type="button" class="chip" data-align="left">
                      <span class="dot"></span>
                      Left
                    </button>
                    <button type="button" class="chip" data-align="right">
                      <span class="dot"></span>
                      Right
                    </button>
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="trackingRange">
                    Tracking
                    <span class="hint">Letter spacing</span>
                  </label>
                  <div class="field">
                    <input id="trackingRange" type="range" min="-80" max="120" step="2" value="0" class="slider" aria-label="Tracking">
                    <input id="trackingValue" type="number" min="-80" max="120" step="2" value="0" class="input input-number" aria-label="Tracking value">
                  </div>
                </div>
              </div>
            </section>

            <section class="panel" aria-label="Fill, outline, gradients and depth">
              <div class="panel-inner">
                <div class="panel-header">
                  <div>
                    <div class="panel-title">Surface</div>
                    <div class="panel-subtitle">Fill, outline, gradients</div>
                  </div>
                  <span class="tag">Style</span>
                </div>
                <div class="form-row">
                  <span class="form-label">
                    Fill mode
                    <span class="hint">Solid or dual gradient</span>
                  </span>
                  <div class="chip-row" id="fillModeChips" aria-label="Fill mode">
                    <button type="button" class="chip active" data-fill-mode="solid">
                      <span class="dot"></span>
                      Solid
                    </button>
                    <button type="button" class="chip" data-fill-mode="gradient">
                      <span class="dot"></span>
                      Gradient
                    </button>
                    <button type="button" class="chip" data-fill-mode="outline">
                      <span class="dot"></span>
                      Outline
                    </button>
                  </div>
                </div>
                <div class="form-row">
                  <span class="form-label">
                    Palette
                    <span class="hint">Fill, gradient, outline</span>
                  </span>
                  <div class="field">
                    <label class="field-inline" for="fillColorInput">
                      <input id="fillColorInput" type="color" value="#f9fafb" aria-label="Fill color">
                      <span>Fill</span>
                    </label>
                    <label class="field-inline" for="gradientColorInput">
                      <input id="gradientColorInput" type="color" value="#38bdf8" aria-label="Gradient color">
                      <span>Accent</span>
                    </label>
                    <label class="field-inline" for="outlineColorInput">
                      <input id="outlineColorInput" type="color" value="#0ea5e9" aria-label="Outline color">
                      <span>Edge</span>
                    </label>
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="outlineWidthRange">
                    Outline width
                    <span class="hint">Stroke strength</span>
                  </label>
                  <div class="field">
                    <input id="outlineWidthRange" type="range" min="0" max="12" step="1" value="0" class="slider" aria-label="Outline width">
                    <input id="outlineWidthValue" type="number" min="0" max="12" step="1" value="0" class="input input-number" aria-label="Outline width value">
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="shadowBlurRange">
                    Shadow and depth
                    <span class="hint">Glow and separation</span>
                  </label>
                  <div class="field">
                    <input id="shadowBlurRange" type="range" min="0" max="42" step="2" value="18" class="slider" aria-label="Shadow blur">
                    <input id="shadowBlurValue" type="number" min="0" max="42" step="2" value="18" class="input input-number" aria-label="Shadow blur value">
                  </div>
                </div>
                <div class="form-row">
                  <span class="form-label">
                    Motion blur
                    <span class="hint">Preview only</span>
                  </span>
                  <div class="field">
                    <label class="field-inline" for="motionBlurToggle">
                      <input id="motionBlurToggle" type="checkbox" aria-label="Toggle motion blur">
                      <span>Simulate smear</span>
                    </label>
                    <span class="badge-soft" id="reducedMotionBadge" aria-live="polite"></span>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </section>

        <section class="preview-shell" aria-label="Preview and viewport">
          <div class="preview-stage" id="previewStage">
            <div class="preview-frame-wrapper" id="previewFrameWrapper">
              <div class="preview-frame-mask">
                <div class="safe-badge" id="safeBadge">Safe · Motion</div>
                <canvas id="previewCanvas" width="1080" height="1920" role="img" aria-label="Animated typography preview"></canvas>
              </div>
            </div>
          </div>
          <div class="preview-meta" aria-label="Preview status">
            <div class="preview-meta-left">
              <span class="dot"></span>
              <span id="previewDescriptor">9:16 · 1080 × 1920 · 5s @ 30fps</span>
            </div>
            <div class="preview-meta-right">
              <div class="preview-pill">
                <span class="indicator"></span>
                <span id="audioStatusText">Audio reactive idle</span>
              </div>
              <div class="preview-pill">
                <span id="presetStatusText">Preset: None</span>
              </div>
            </div>
          </div>
        </section>

        <section class="sidebar" aria-label="Transform, easing and audio">
          <div class="sidebar-scroll">
            <section class="panel" aria-label="Transform properties">
              <div class="panel-inner">
                <div class="panel-header">
                  <div>
                    <div class="panel-title">Transform</div>
                    <div class="panel-subtitle">Position, scale, rotation, opacity</div>
                  </div>
                  <span class="tag">Keyframed</span>
                </div>
                <div class="form-row">
                  <label class="form-label" for="positionXRange">
                    Position X
                    <span class="hint">Horizontal offset</span>
                  </label>
                  <div class="field">
                    <input id="positionXRange" type="range" min="-300" max="300" step="2" value="0" class="slider" aria-label="Horizontal position">
                    <input id="positionXValue" type="number" min="-300" max="300" step="2" value="0" class="input input-number" aria-label="Horizontal position value">
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="positionYRange">
                    Position Y
                    <span class="hint">Vertical offset</span>
                  </label>
                  <div class="field">
                    <input id="positionYRange" type="range" min="-300" max="300" step="2" value="0" class="slider" aria-label="Vertical position">
                    <input id="positionYValue" type="number" min="-300" max="300" step="2" value="0" class="input input-number" aria-label="Vertical position value">
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="scaleRange">
                    Scale
                    <span class="hint">Overall size</span>
                  </label>
                  <div class="field">
                    <input id="scaleRange" type="range" min="0.4" max="2.4" step="0.02" value="1" class="slider" aria-label="Scale">
                    <input id="scaleValue" type="number" min="0.4" max="2.4" step="0.02" value="1" class="input input-number" aria-label="Scale value">
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="rotationRange">
                    Rotation
                    <span class="hint">Degrees</span>
                  </label>
                  <div class="field">
                    <input id="rotationRange" type="range" min="-45" max="45" step="1" value="0" class="slider" aria-label="Rotation">
                    <input id="rotationValue" type="number" min="-45" max="45" step="1" value="0" class="input input-number" aria-label="Rotation value">
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="opacityRange">
                    Opacity
                    <span class="hint">Visibility</span>
                  </label>
                  <div class="field">
                    <input id="opacityRange" type="range" min="0" max="1" step="0.02" value="1" class="slider" aria-label="Opacity">
                    <input id="opacityValue" type="number" min="0" max="1" step="0.02" value="1" class="input input-number" aria-label="Opacity value">
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="letterOffsetRange">
                    Letter offset
                    <span class="hint">Per glyph travel</span>
                  </label>
                  <div class="field">
                    <input id="letterOffsetRange" type="range" min="-80" max="80" step="2" value="24" class="slider" aria-label="Letter offset">
                    <input id="letterOffsetValue" type="number" min="-80" max="80" step="2" value="24" class="input input-number" aria-label="Letter offset value">
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="wordOffsetRange">
                    Word offset
                    <span class="hint">Chunk spacing</span>
                  </label>
                  <div class="field">
                    <input id="wordOffsetRange" type="range" min="-160" max="160" step="4" value="0" class="slider" aria-label="Word offset">
                    <input id="wordOffsetValue" type="number" min="-160" max="160" step="4" value="0" class="input input-number" aria-label="Word offset value">
                  </div>
                </div>
              </div>
            </section>

            <section class="panel" aria-label="Easing and interpolation">
              <div class="panel-inner">
                <div class="panel-header">
                  <div>
                    <div class="panel-title">Easing</div>
                    <div class="panel-subtitle">Curves and custom Bézier</div>
                  </div>
                  <span class="tag">Timing</span>
                </div>
                <div class="form-row">
                  <label class="form-label" for="easingSelect">
                    Preset
                    <span class="hint">Global keyframe easing</span>
                  </label>
                  <div class="field">
                    <select id="easingSelect" class="select" aria-label="Easing preset">
                      <option value="linear">Linear</option>
                      <option value="easeIn">Ease in</option>
                      <option value="easeOut">Ease out</option>
                      <option value="easeInOut" selected>Ease in-out</option>
                      <option value="back">Back</option>
                      <option value="elastic">Elastic</option>
                      <option value="custom">Custom Bézier</option>
                    </select>
                  </div>
                </div>
                <div class="form-row" id="bezierRow" style="display: none;">
                  <span class="form-label">
                    Bézier
                    <span class="hint">x1 y1 x2 y2</span>
                  </span>
                  <div class="field">
                    <input id="bezierP1X" type="number" step="0.05" value="0.25" class="input input-number" aria-label="Bézier p1 x">
                    <input id="bezierP1Y" type="number" step="0.05" value="0.1" class="input input-number" aria-label="Bézier p1 y">
                    <input id="bezierP2X" type="number" step="0.05" value="0.25" class="input input-number" aria-label="Bézier p2 x">
                    <input id="bezierP2Y" type="number" step="0.05" value="1" class="input input-number" aria-label="Bézier p2 y">
                  </div>
                </div>
                <div class="easing-preview">
                  <canvas id="easingCanvas" width="260" height="70" aria-hidden="true"></canvas>
                </div>
                <div class="status-line">
                  <span>
                    <strong>Interpolation</strong>
                    <span id="easingLabel">Ease in-out</span>
                  </span>
                  <span class="status-dot" id="easingDynamicDot"></span>
                </div>
              </div>
            </section>

            <section class="panel" aria-label="Audio reactive mode">
              <div class="panel-inner">
                <div class="panel-header">
                  <div>
                    <div class="panel-title">Audio</div>
                    <div class="panel-subtitle">Beat snap and reaction</div>
                  </div>
                  <span class="tag">Rhythm</span>
                </div>
                <div class="form-row">
                  <label class="form-label" for="audioFileInput">
                    Source
                    <span class="hint">Local audio file</span>
                  </label>
                  <div class="field">
                    <input id="audioFileInput" type="file" accept="audio/*" class="input" aria-label="Audio file">
                  </div>
                </div>
                <div class="form-row">
                  <span class="form-label">
                    Beats
                    <span class="hint">Detection and snapping</span>
                  </span>
                  <div class="field">
                    <button type="button" id="detectBeatsButton">Detect</button>
                    <button type="button" id="snapToBeatsButton">Snap keyframes</button>
                  </div>
                </div>
                <div class="form-row">
                  <span class="form-label">
                    Reactive
                    <span class="hint">Drive motion with audio</span>
                  </span>
                  <div class="field">
                    <label class="field-inline" for="audioReactiveToggle">
                      <input id="audioReactiveToggle" type="checkbox" aria-label="Toggle audio reactive mode">
                      <span>Enable</span>
                    </label>
                    <label class="field-inline" for="audioIntensityRange">
                      <span>Intensity</span>
                      <input id="audioIntensityRange" type="range" min="0" max="1.4" step="0.05" value="0.9" class="slider" aria-label="Audio reactive intensity">
                    </label>
                  </div>
                </div>
                <div class="status-line" id="audioStatusLine">
                  <span id="audioAnalysisLabel">No audio loaded</span>
                  <span id="audioBeatCountLabel"></span>
                </div>
              </div>
            </section>

            <section class="panel" aria-label="Layout and guides">
              <div class="panel-inner">
                <div class="panel-header">
                  <div>
                    <div class="panel-title">Layout</div>
                    <div class="panel-subtitle">Safe area, grid, backgrounds</div>
                  </div>
                  <span class="tag">Frame</span>
                </div>
                <div class="form-row">
                  <span class="form-label">
                    Guides
                    <span class="hint">Safe and grid overlays</span>
                  </span>
                  <div class="field">
                    <label class="field-inline" for="safeAreaToggle">
                      <input id="safeAreaToggle" type="checkbox" checked aria-label="Toggle safe area guides">
                      <span>Safe</span>
                    </label>
                    <label class="field-inline" for="gridToggle">
                      <input id="gridToggle" type="checkbox" checked aria-label="Toggle grid">
                      <span>Grid</span>
                    </label>
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label" for="safeMarginRange">
                    Safe margin
                    <span class="hint">Percent of frame</span>
                  </label>
                  <div class="field">
                    <input id="safeMarginRange" type="range" min="0" max="18" step="1" value="8" class="slider" aria-label="Safe area margin">
                    <input id="safeMarginValue" type="number" min="0" max="18" step="1" value="8" class="input input-number" aria-label="Safe margin value">
                  </div>
                </div>
                <div class="form-row">
                  <span class="form-label">
                    Background
                    <span class="hint">Color or image</span>
                  </span>
                  <div class="field">
                    <label class="field-inline" for="backgroundColorInput">
                      <input id="backgroundColorInput" type="color" value="#020617" aria-label="Background color">
                      <span>Fill</span>
                    </label>
                    <input id="backgroundImageInput" type="file" accept="image/*" class="input" aria-label="Background image file">
                  </div>
                </div>
              </div>
            </section>

            <section class="panel" aria-label="Keyframes list">
              <div class="panel-inner">
                <div class="panel-header">
                  <div>
                    <div class="panel-title">Keyframes</div>
                    <div class="panel-subtitle">Timeline snapshots</div>
                  </div>
                  <span class="tag">Timeline</span>
                </div>
                <div class="keyframe-list" id="keyframeList" aria-label="Keyframe list"></div>
              </div>
            </section>
          </div>
        </section>

        <section class="timeline" aria-label="Timeline editor">
          <div class="timeline-header">
            <div class="timeline-header-left">
              <div class="timeline-title">Timeline</div>
              <span class="badge-soft">J / K / L · Scrub</span>
            </div>
            <div class="time-label" id="timeLabel">00.00 s</div>
          </div>
          <div class="timeline-main">
            <div class="timeline-lane-labels" aria-hidden="true">
              <span>
                <span>Transform</span>
                <span class="lane-dot"></span>
              </span>
              <span>
                <span>Opacity</span>
                <span class="lane-dot"></span>
              </span>
              <span>
                <span>Offsets</span>
                <span class="lane-dot"></span>
              </span>
            </div>
            <div class="timeline-track-shell" id="timelineTrackShell">
              <div class="timeline-grid" id="timelineGrid">
                <div class="timeline-keyframes" id="timelineKeyframes"></div>
                <div class="playhead" id="timelinePlayhead">
                  <div class="playhead-handle"></div>
                </div>
              </div>
              <div class="timeline-scrub">
                <input id="timelineRange" class="timeline-range" type="range" min="0" max="1000" value="0" aria-label="Timeline scrub">
              </div>
            </div>
          </div>
          <div class="timeline-shortcuts" aria-hidden="true">
            <span><span class="key">Space</span> Play</span>
            <span><span class="key">J</span> Back</span>
            <span><span class="key">K</span> Pause</span>
            <span><span class="key">L</span> Forward</span>
            <span><span class="key">A</span> Keyframe</span>
          </div>
        </section>
      </main>
      <footer class="app-footer" aria-label="Keyboard shortcuts and accessibility">
        <div>
          Keyboard: <span class="kbd">Space</span> play · <span class="kbd">J</span>/<span class="kbd">L</span> scrub · <span class="kbd">A</span> keyframe · <span class="kbd">R</span> toggle audio reactive
        </div>
        <div>
          Motion: respects <code>prefers-reduced-motion</code>. Heavy effects are softened when enabled.
        </div>
      </footer>
    </div>
  </div>

  <script src="https://unpkg.com/gif.js.optimized/dist/gif.js"></script>
  <script>
    (function () {
      var previewCanvasElement = document.getElementById("previewCanvas");
      var previewCanvasContext = previewCanvasElement.getContext("2d");
      var easingCanvasElement = document.getElementById("easingCanvas");
      var easingCanvasContext = easingCanvasElement.getContext("2d");
      var timelineGridElement = document.getElementById("timelineGrid");
      var timelineKeyframesElement = document.getElementById("timelineKeyframes");
      var timelinePlayheadElement = document.getElementById("timelinePlayhead");
      var timelineRangeElement = document.getElementById("timelineRange");
      var timeLabelElement = document.getElementById("timeLabel");
      var textInputElement = document.getElementById("textInput");
      var presetSelectElement = document.getElementById("presetSelect");
      var cascadeChipsElement = document.getElementById("cascadeChips");
      var staggerRangeElement = document.getElementById("staggerRange");
      var staggerValueElement = document.getElementById("staggerValue");
      var fontFamilySelectElement = document.getElementById("fontFamilySelect");
      var fontWeightSelectElement = document.getElementById("fontWeightSelect");
      var italicToggleElement = document.getElementById("italicToggle");
      var fontSizeRangeElement = document.getElementById("fontSizeRange");
      var fontSizeValueElement = document.getElementById("fontSizeValue");
      var alignChipsElement = document.getElementById("alignChips");
      var trackingRangeElement = document.getElementById("trackingRange");
      var trackingValueElement = document.getElementById("trackingValue");
      var fillModeChipsElement = document.getElementById("fillModeChips");
      var fillColorInputElement = document.getElementById("fillColorInput");
      var gradientColorInputElement = document.getElementById("gradientColorInput");
      var outlineColorInputElement = document.getElementById("outlineColorInput");
      var outlineWidthRangeElement = document.getElementById("outlineWidthRange");
      var outlineWidthValueElement = document.getElementById("outlineWidthValue");
      var shadowBlurRangeElement = document.getElementById("shadowBlurRange");
      var shadowBlurValueElement = document.getElementById("shadowBlurValue");
      var motionBlurToggleElement = document.getElementById("motionBlurToggle");
      var reducedMotionBadgeElement = document.getElementById("reducedMotionBadge");
      var positionXRangeElement = document.getElementById("positionXRange");
      var positionXValueElement = document.getElementById("positionXValue");
      var positionYRangeElement = document.getElementById("positionYRange");
      var positionYValueElement = document.getElementById("positionYValue");
      var scaleRangeElement = document.getElementById("scaleRange");
      var scaleValueElement = document.getElementById("scaleValue");
      var rotationRangeElement = document.getElementById("rotationRange");
      var rotationValueElement = document.getElementById("rotationValue");
      var opacityRangeElement = document.getElementById("opacityRange");
      var opacityValueElement = document.getElementById("opacityValue");
      var letterOffsetRangeElement = document.getElementById("letterOffsetRange");
      var letterOffsetValueElement = document.getElementById("letterOffsetValue");
      var wordOffsetRangeElement = document.getElementById("wordOffsetRange");
      var wordOffsetValueElement = document.getElementById("wordOffsetValue");
      var easingSelectElement = document.getElementById("easingSelect");
      var bezierRowElement = document.getElementById("bezierRow");
      var bezierP1XElement = document.getElementById("bezierP1X");
      var bezierP1YElement = document.getElementById("bezierP1Y");
      var bezierP2XElement = document.getElementById("bezierP2X");
      var bezierP2YElement = document.getElementById("bezierP2Y");
      var easingLabelElement = document.getElementById("easingLabel");
      var easingDynamicDotElement = document.getElementById("easingDynamicDot");
      var audioFileInputElement = document.getElementById("audioFileInput");
      var detectBeatsButtonElement = document.getElementById("detectBeatsButton");
      var snapToBeatsButtonElement = document.getElementById("snapToBeatsButton");
      var audioReactiveToggleElement = document.getElementById("audioReactiveToggle");
      var audioIntensityRangeElement = document.getElementById("audioIntensityRange");
      var audioStatusTextElement = document.getElementById("audioStatusText");
      var audioAnalysisLabelElement = document.getElementById("audioAnalysisLabel");
      var audioBeatCountLabelElement = document.getElementById("audioBeatCountLabel");
      var safeAreaToggleElement = document.getElementById("safeAreaToggle");
      var gridToggleElement = document.getElementById("gridToggle");
      var safeMarginRangeElement = document.getElementById("safeMarginRange");
      var safeMarginValueElement = document.getElementById("safeMarginValue");
      var backgroundColorInputElement = document.getElementById("backgroundColorInput");
      var backgroundImageInputElement = document.getElementById("backgroundImageInput");
      var safeBadgeElement = document.getElementById("safeBadge");
      var keyframeListElement = document.getElementById("keyframeList");
      var playPauseButtonElement = document.getElementById("playPauseButton");
      var jumpBackButtonElement = document.getElementById("jumpBackButton");
      var jumpForwardButtonElement = document.getElementById("jumpForwardButton");
      var addKeyframeButtonElement = document.getElementById("addKeyframeButton");
      var exportVideoButtonElement = document.getElementById("exportVideoButton");
      var exportGifButtonElement = document.getElementById("exportGifButton");
      var exportPngButtonElement = document.getElementById("exportPngButton");
      var aspectSelectElement = document.getElementById("aspectSelect");
      var resolutionSelectElement = document.getElementById("resolutionSelect");
      var fpsSelectElement = document.getElementById("fpsSelect");
      var durationSelectElement = document.getElementById("durationSelect");
      var previewDescriptorElement = document.getElementById("previewDescriptor");
      var presetStatusTextElement = document.getElementById("presetStatusText");

      var appState = {
        textContent: textInputElement.value,
        preset: "none",
        cascadeMode: "letters",
        staggerSeconds: 0.04,
        fontFamily: fontFamilySelectElement.value,
        fontWeight: parseInt(fontWeightSelectElement.value, 10),
        isItalic: italicToggleElement.checked,
        fontSize: parseInt(fontSizeRangeElement.value, 10),
        textAlign: "center",
        tracking: 0,
        fillMode: "solid",
        fillColor: fillColorInputElement.value,
        gradientColor: gradientColorInputElement.value,
        outlineColor: outlineColorInputElement.value,
        outlineWidth: 0,
        shadowBlur: parseInt(shadowBlurRangeElement.value, 10),
        motionBlurEnabled: false,
        positionX: 0,
        positionY: 0,
        scale: 1,
        rotation: 0,
        opacity: 1,
        letterOffset: 24,
        wordOffset: 0,
        easingPreset: "easeInOut",
        customBezier: { p1x: 0.25, p1y: 0.1, p2x: 0.25, p2y: 1 },
        duration: parseFloat(durationSelectElement.value),
        currentTime: 0,
        framesPerSecond: parseInt(fpsSelectElement.value, 10),
        isPlaying: false,
        lastFrameTimestamp: 0,
        aspect: "9:16",
        renderWidth: 1080,
        renderHeight: 1920,
        safeAreaVisible: true,
        gridVisible: true,
        safeMarginPercent: 8,
        backgroundColor: backgroundColorInputElement.value,
        backgroundImage: null,
        keyframes: [],
        selectedKeyframeIndex: null,
        reducedMotionPreferred: false,
        audioReactiveEnabled: false,
        audioIntensity: parseFloat(audioIntensityRangeElement.value),
        audio: {
          context: null,
          element: null,
          analyser: null,
          dataArray: null,
          beatTimes: [],
          decodedBuffer: null
        }
      };

      var animationFrameRequestId = null;
      var exportInProgress = false;

      function updatePreviewDescriptor() {
        var descriptorText = appState.aspect + " · " + appState.renderWidth + " × " + appState.renderHeight + " · " + appState.duration.toFixed(1) + "s @ " + appState.framesPerSecond + "fps";
        previewDescriptorElement.textContent = descriptorText;
      }

      function syncNumberAndRange(rangeElement, numberElement, onChange) {
        function handleRangeChange() {
          numberElement.value = rangeElement.value;
          onChange(parseFloat(rangeElement.value));
        }
        function handleNumberChange() {
          rangeElement.value = numberElement.value;
          onChange(parseFloat(numberElement.value));
        }
        rangeElement.addEventListener("input", handleRangeChange);
        numberElement.addEventListener("change", handleNumberChange);
      }

      function setChipGroupActive(element, value, attributeName) {
        var chipElements = element.querySelectorAll(".chip");
        for (var index = 0; index < chipElements.length; index += 1) {
          var chipElement = chipElements[index];
          if (chipElement.getAttribute(attributeName) === value) {
            chipElement.classList.add("active");
          } else {
            chipElement.classList.remove("active");
          }
        }
      }

      function getCascadeChipValue(chipElement) {
        return chipElement.getAttribute("data-cascade");
      }

      function getAlignChipValue(chipElement) {
        return chipElement.getAttribute("data-align");
      }

      function getFillModeChipValue(chipElement) {
        return chipElement.getAttribute("data-fill-mode");
      }

      function setupChips(chipContainerElement, attributeName, onValueChange) {
        chipContainerElement.addEventListener("click", function (event) {
          var targetElement = event.target;
          if (targetElement.classList.contains("chip") === false) {
            var parentElement = targetElement.closest(".chip");
            if (parentElement) {
              targetElement = parentElement;
            }
          }
          if (targetElement.classList.contains("chip")) {
            var chipElements = chipContainerElement.querySelectorAll(".chip");
            for (var index = 0; index < chipElements.length; index += 1) {
              chipElements[index].classList.remove("active");
            }
            targetElement.classList.add("active");
            var value = targetElement.getAttribute(attributeName);
            onValueChange(value);
          }
        });
      }

      function resizeCanvasToAspect() {
        var aspectValue = aspectSelectElement.value;
        var resolutionValue = resolutionSelectElement.value;
        appState.aspect = aspectValue;
        var resolutionParts = resolutionValue.split("x");
        var widthValue = parseInt(resolutionParts[0], 10);
        var heightValue = parseInt(resolutionParts[1], 10);
        if (aspectValue === "9:16") {
          appState.renderWidth = widthValue;
          appState.renderHeight = heightValue;
        } else if (aspectValue === "16:9") {
          appState.renderWidth = heightValue;
          appState.renderHeight = widthValue;
        } else {
          var minValue = Math.min(widthValue, heightValue);
          appState.renderWidth = minValue;
          appState.renderHeight = minValue;
        }
        previewCanvasElement.width = appState.renderWidth;
        previewCanvasElement.height = appState.renderHeight;
        var previewFrameWrapperElement = document.getElementById("previewFrameWrapper");
        var maxPreviewWidth = previewFrameWrapperElement.clientWidth - 32;
        var maxPreviewHeight = previewFrameWrapperElement.clientHeight - 32;
        if (maxPreviewWidth < 0) {
          maxPreviewWidth = appState.renderWidth;
        }
        if (maxPreviewHeight < 0) {
          maxPreviewHeight = appState.renderHeight;
        }
        var widthScale = maxPreviewWidth / appState.renderWidth;
        var heightScale = maxPreviewHeight / appState.renderHeight;
        var scaleFactor = Math.min(widthScale, heightScale, 1.2);
        previewCanvasElement.style.width = appState.renderWidth * scaleFactor + "px";
        previewCanvasElement.style.height = appState.renderHeight * scaleFactor + "px";
        updatePreviewDescriptor();
        renderCurrentFrame();
      }

      function syncTimelineRange() {
        var proportion = appState.currentTime / appState.duration;
        if (proportion < 0) {
          proportion = 0;
        }
        if (proportion > 1) {
          proportion = 1;
        }
        timelineRangeElement.value = String(Math.round(proportion * 1000));
        var gridRect = timelineGridElement.getBoundingClientRect();
        var playheadPosition = gridRect.width * proportion;
        timelinePlayheadElement.style.left = playheadPosition + "px";
        timeLabelElement.textContent = appState.currentTime.toFixed(2) + " s";
      }

      function sampleEase(presetName, tValue) {
        if (presetName === "linear") {
          return tValue;
        }
        if (presetName === "easeIn") {
          return tValue * tValue;
        }
        if (presetName === "easeOut") {
          var reverse = 1 - tValue;
          return 1 - reverse * reverse;
        }
        if (presetName === "easeInOut") {
          if (tValue < 0.5) {
            var t2 = tValue * 2;
            return 0.5 * t2 * t2;
          }
          var reversed = (tValue - 0.5) * 2;
          var easedReversed = 1 - (1 - reversed) * (1 - reversed);
          return 0.5 + 0.5 * easedReversed;
        }
        if (presetName === "back") {
          var overshoot = 1.4;
          return tValue * tValue * ((overshoot + 1) * tValue - overshoot);
        }
        if (presetName === "elastic") {
          if (tValue === 0 || tValue === 1) {
            return tValue;
          }
          var factor = Math.pow(2, -10 * tValue);
          var oscillation = Math.sin((tValue - 0.075) * (2 * Math.PI) / 0.3);
          return factor * oscillation + 1;
        }
        if (presetName === "custom") {
          var p1x = appState.customBezier.p1x;
          var p1y = appState.customBezier.p1y;
          var p2x = appState.customBezier.p2x;
          var p2y = appState.customBezier.p2y;
          var cX = 3 * p1x;
          var bX = 3 * (p2x - p1x) - cX;
          var aX = 1 - cX - bX;
          var cY = 3 * p1y;
          var bY = 3 * (p2y - p1y) - cY;
          var aY = 1 - cY - bY;
          var param = tValue;
          var yValue = ((aY * param + bY) * param + cY) * param;
          var xValue = ((aX * param + bX) * param + cX) * param;
          if (xValue !== 0) {
            return yValue;
          }
          return tValue;
        }
        return tValue;
      }

      function drawEasingPreview() {
        var width = easingCanvasElement.width;
        var height = easingCanvasElement.height;
        easingCanvasContext.clearRect(0, 0, width, height);
        easingCanvasContext.fillStyle = "rgba(15, 23, 42, 1)";
        easingCanvasContext.fillRect(0, 0, width, height);
        easingCanvasContext.strokeStyle = "rgba(55, 65, 81, 1)";
        easingCanvasContext.lineWidth = 1;
        easingCanvasContext.setLineDash([4, 4]);
        easingCanvasContext.beginPath();
        easingCanvasContext.moveTo(0, height - 1);
        easingCanvasContext.lineTo(width, 1);
        easingCanvasContext.stroke();
        easingCanvasContext.setLineDash([]);
        easingCanvasContext.strokeStyle = "rgba(56, 189, 248, 1)";
        easingCanvasContext.lineWidth = 2;
        easingCanvasContext.beginPath();
        var steps = 80;
        for (var index = 0; index <= steps; index += 1) {
          var position = index / steps;
          var eased = sampleEase(appState.easingPreset, position);
          var xValue = 6 + (width - 12) * position;
          var yValue = height - 4 - (height - 10) * eased;
          if (index === 0) {
            easingCanvasContext.moveTo(xValue, yValue);
          } else {
            easingCanvasContext.lineTo(xValue, yValue);
          }
        }
        easingCanvasContext.stroke();
        easingDynamicDotElement.style.background = appState.easingPreset === "linear" ? "#facc15" : "#22c55e";
      }

      function getCurrentAudioLevel() {
        if (!appState.audio.analyser || !appState.audio.dataArray) {
          return 0;
        }
        var analyser = appState.audio.analyser;
        analyser.getByteFrequencyData(appState.audio.dataArray);
        var sum = 0;
        for (var index = 0; index < appState.audio.dataArray.length; index += 1) {
          sum += appState.audio.dataArray[index];
        }
        if (appState.audio.dataArray.length === 0) {
          return 0;
        }
        var average = sum / appState.audio.dataArray.length;
        var normalized = average / 255;
        return Math.max(0, Math.min(1, normalized));
      }

      function detectBeats(buffer) {
        var sampleRate = buffer.sampleRate;
        var channelData = buffer.getChannelData(0);
        var windowDuration = 0.12;
        var windowSize = Math.floor(sampleRate * windowDuration);
        var energyValues = [];
        var energyTimes = [];
        var index = 0;
        while (index < channelData.length) {
          var windowSum = 0;
          var count = 0;
          var sampleIndex = 0;
          while (sampleIndex < windowSize && index + sampleIndex < channelData.length) {
            var sample = channelData[index + sampleIndex];
            windowSum += sample * sample;
            count += 1;
            sampleIndex += 1;
          }
          if (count > 0) {
            var rms = Math.sqrt(windowSum / count);
            energyValues.push(rms);
            energyTimes.push(index / sampleRate);
          }
          index += windowSize;
        }
        var beatTimes = [];
        var historySize = 43;
        for (var energyIndex = 0; energyIndex < energyValues.length; energyIndex += 1) {
          var start = Math.max(0, energyIndex - historySize);
          var historySum = 0;
          var historyCount = 0;
          var historyIndex = start;
          while (historyIndex < energyIndex) {
            historySum += energyValues[historyIndex];
            historyCount += 1;
            historyIndex += 1;
          }
          var localAverage = historyCount > 0 ? historySum / historyCount : energyValues[energyIndex];
          if (energyValues[energyIndex] > localAverage * 1.4 && energyValues[energyIndex] > 0.02) {
            beatTimes.push(energyTimes[energyIndex]);
          }
        }
        appState.audio.beatTimes = beatTimes;
        if (beatTimes.length > 0) {
          audioBeatCountLabelElement.textContent = beatTimes.length + " beats";
          audioAnalysisLabelElement.textContent = "Beat grid detected";
        } else {
          audioBeatCountLabelElement.textContent = "No strong beats";
          audioAnalysisLabelElement.textContent = "Try a more percussive track";
        }
      }

      function snapKeyframesToBeats() {
        if (!appState.audio.beatTimes || appState.audio.beatTimes.length === 0) {
          return;
        }
        if (appState.keyframes.length === 0) {
          return;
        }
        var beatTimes = appState.audio.beatTimes;
        for (var index = 0; index < appState.keyframes.length; index += 1) {
          var keyframe = appState.keyframes[index];
          var originalTime = keyframe.time;
          var bestTime = beatTimes[0];
          var bestDistance = Math.abs(originalTime - bestTime);
          for (var beatIndex = 1; beatIndex < beatTimes.length; beatIndex += 1) {
            var beatTime = beatTimes[beatIndex];
            var distance = Math.abs(originalTime - beatTime);
            if (distance < bestDistance) {
              bestDistance = distance;
              bestTime = beatTime;
            }
          }
          keyframe.time = Math.max(0, Math.min(appState.duration, bestTime));
        }
        appState.keyframes.sort(function (a, b) { return a.time - b.time; });
        syncTimelineRange();
        renderTimelineKeyframes();
        renderKeyframeList();
      }

      function createKeyframeAt(timeValue) {
        return {
          time: timeValue,
          positionX: appState.positionX,
          positionY: appState.positionY,
          scale: appState.scale,
          rotation: appState.rotation,
          opacity: appState.opacity,
          letterOffset: appState.letterOffset,
          wordOffset: appState.wordOffset,
          easingPreset: appState.easingPreset,
          customBezier: {
            p1x: appState.customBezier.p1x,
            p1y: appState.customBezier.p1y,
            p2x: appState.customBezier.p2x,
            p2y: appState.customBezier.p2y
          }
        };
      }

      function ensureDefaultKeyframes() {
        if (appState.keyframes.length === 0) {
          appState.currentTime = 0;
          var firstKeyframe = createKeyframeAt(0);
          appState.currentTime = appState.duration;
          appState.positionY = 80;
          appState.opacity = 0;
          var lastKeyframe = createKeyframeAt(appState.duration);
          appState.keyframes.push(firstKeyframe);
          appState.keyframes.push(lastKeyframe);
          appState.currentTime = 0;
          appState.positionY = 0;
          appState.opacity = 1;
        }
      }

      function addKeyframeAtCurrentTime() {
        var timeValue = appState.currentTime;
        var hasExisting = false;
        for (var index = 0; index < appState.keyframes.length; index += 1) {
          if (Math.abs(appState.keyframes[index].time - timeValue) < 0.001) {
            appState.keyframes[index] = createKeyframeAt(timeValue);
            hasExisting = true;
            appState.selectedKeyframeIndex = index;
            break;
          }
        }
        if (!hasExisting) {
          var keyframe = createKeyframeAt(timeValue);
          appState.keyframes.push(keyframe);
          appState.keyframes.sort(function (a, b) { return a.time - b.time; });
          appState.selectedKeyframeIndex = appState.keyframes.indexOf(keyframe);
        }
        renderTimelineKeyframes();
        renderKeyframeList();
      }

      function deleteKeyframeAtIndex(index) {
        if (index < 0 || index >= appState.keyframes.length) {
          return;
        }
        appState.keyframes.splice(index, 1);
        if (appState.selectedKeyframeIndex === index) {
          appState.selectedKeyframeIndex = null;
        }
        renderTimelineKeyframes();
        renderKeyframeList();
      }

      function renderTimelineKeyframes() {
        while (timelineKeyframesElement.firstChild) {
          timelineKeyframesElement.removeChild(timelineKeyframesElement.firstChild);
        }
        var gridRect = timelineGridElement.getBoundingClientRect();
        for (var index = 0; index < appState.keyframes.length; index += 1) {
          var keyframe = appState.keyframes[index];
          var ratio = keyframe.time / appState.duration;
          if (ratio < 0) {
            ratio = 0;
          }
          if (ratio > 1) {
            ratio = 1;
          }
          var markerElement = document.createElement("div");
          markerElement.className = "keyframe-marker" + (index % 2 === 1 ? " secondary" : "");
          markerElement.style.left = (gridRect.width * ratio) + "px";
          markerElement.style.top = "50%";
          markerElement.setAttribute("data-index", String(index));
          markerElement.title = "t=" + keyframe.time.toFixed(2) + "s";
          markerElement.addEventListener("click", function (event) {
            var element = event.currentTarget;
            var keyframeIndex = parseInt(element.getAttribute("data-index"), 10);
            var frame = appState.keyframes[keyframeIndex];
            appState.currentTime = frame.time;
            appState.positionX = frame.positionX;
            appState.positionY = frame.positionY;
            appState.scale = frame.scale;
            appState.rotation = frame.rotation;
            appState.opacity = frame.opacity;
            appState.letterOffset = frame.letterOffset;
            appState.wordOffset = frame.wordOffset;
            appState.easingPreset = frame.easingPreset;
            appState.customBezier = {
              p1x: frame.customBezier.p1x,
              p1y: frame.customBezier.p1y,
              p2x: frame.customBezier.p2x,
              p2y: frame.customBezier.p2y
            };
            appState.selectedKeyframeIndex = keyframeIndex;
            syncControlsFromState();
            syncTimelineRange();
            renderCurrentFrame();
            renderKeyframeList();
          });
          timelineKeyframesElement.appendChild(markerElement);
        }
        syncTimelineRange();
      }

      function renderKeyframeList() {
        while (keyframeListElement.firstChild) {
          keyframeListElement.removeChild(keyframeListElement.firstChild);
        }
        for (var index = 0; index < appState.keyframes.length; index += 1) {
          var keyframe = appState.keyframes[index];
          var rowElement = document.createElement("div");
          rowElement.className = "keyframe-row" + (appState.selectedKeyframeIndex === index ? " active" : "");
          var timeElement = document.createElement("div");
          timeElement.textContent = keyframe.time.toFixed(2) + "s";
          var summaryElement = document.createElement("div");
          summaryElement.textContent = "X " + keyframe.positionX.toFixed(0) + " · Y " + keyframe.positionY.toFixed(0) + " · Sc " + keyframe.scale.toFixed(2) + " · Op " + keyframe.opacity.toFixed(2);
          var actionsElement = document.createElement("div");
          var focusButton = document.createElement("button");
          focusButton.type = "button";
          focusButton.textContent = "Focus";
          focusButton.addEventListener("click", function (event) {
            var targetElement = event.currentTarget;
            var parentRow = targetElement.parentElement.parentElement;
            var rowIndex = Array.prototype.indexOf.call(keyframeListElement.children, parentRow);
            if (rowIndex >= 0 && rowIndex < appState.keyframes.length) {
              var frame = appState.keyframes[rowIndex];
              appState.currentTime = frame.time;
              appState.positionX = frame.positionX;
              appState.positionY = frame.positionY;
              appState.scale = frame.scale;
              appState.rotation = frame.rotation;
              appState.opacity = frame.opacity;
              appState.letterOffset = frame.letterOffset;
              appState.wordOffset = frame.wordOffset;
              appState.easingPreset = frame.easingPreset;
              appState.customBezier = {
                p1x: frame.customBezier.p1x,
                p1y: frame.customBezier.p1y,
                p2x: frame.customBezier.p2x,
                p2y: frame.customBezier.p2y
              };
              appState.selectedKeyframeIndex = rowIndex;
              syncControlsFromState();
              syncTimelineRange();
              renderCurrentFrame();
              renderKeyframeList();
            }
          });
          var deleteButton = document.createElement("button");
          deleteButton.type = "button";
          deleteButton.textContent = "Delete";
          deleteButton.addEventListener("click", function (event) {
            var targetElement = event.currentTarget;
            var parentRow = targetElement.parentElement.parentElement;
            var rowIndex = Array.prototype.indexOf.call(keyframeListElement.children, parentRow);
            deleteKeyframeAtIndex(rowIndex);
          });
          actionsElement.appendChild(focusButton);
          actionsElement.appendChild(deleteButton);
          rowElement.appendChild(timeElement);
          rowElement.appendChild(summaryElement);
          rowElement.appendChild(actionsElement);
          keyframeListElement.appendChild(rowElement);
        }
      }

      function interpolateValue(timeValue, propertyName) {
        if (appState.keyframes.length === 0) {
          return appState[propertyName];
        }
        if (appState.keyframes.length === 1) {
          return appState.keyframes[0][propertyName];
        }
        var keyframes = appState.keyframes;
        if (timeValue <= keyframes[0].time) {
          return keyframes[0][propertyName];
        }
        if (timeValue >= keyframes[keyframes.length - 1].time) {
          return keyframes[keyframes.length - 1][propertyName];
        }
        var leftIndex = 0;
        var rightIndex = keyframes.length - 1;
        var index = 0;
        for (index = 0; index < keyframes.length - 1; index += 1) {
          if (timeValue >= keyframes[index].time && timeValue <= keyframes[index + 1].time) {
            leftIndex = index;
            rightIndex = index + 1;
            break;
          }
        }
        var leftKeyframe = keyframes[leftIndex];
        var rightKeyframe = keyframes[rightIndex];
        var span = rightKeyframe.time - leftKeyframe.time;
        if (span <= 0.0001) {
          return leftKeyframe[propertyName];
        }
        var localT = (timeValue - leftKeyframe.time) / span;
        var easingName = leftKeyframe.easingPreset || appState.easingPreset;
        var eased = sampleEase(easingName, localT);
        var leftValue = leftKeyframe[propertyName];
        var rightValue = rightKeyframe[propertyName];
        return leftValue + (rightValue - leftValue) * eased;
      }

      function applyPresetToPose(timeValue, basePose) {
        var duration = appState.duration;
        var normalizedTime = duration > 0 ? timeValue / duration : 0;
        if (normalizedTime < 0) {
          normalizedTime = 0;
        }
        if (normalizedTime > 1) {
          normalizedTime = 1;
        }
        var text = appState.textContent;
        var result = {
          positionX: basePose.positionX,
          positionY: basePose.positionY,
          scale: basePose.scale,
          rotation: basePose.rotation,
          opacity: basePose.opacity,
          letterOffset: basePose.letterOffset,
          wordOffset: basePose.wordOffset,
          revealCharacters: text.length,
          perGlyphOffset: 0,
          perGlyphOpacityBoost: 0,
          verticalDrift: 0,
          horizontalJitter: 0
        };
        if (appState.reducedMotionPreferred) {
          if (appState.preset === "fadeUp") {
            var fadeAmount = sampleEase("easeInOut", normalizedTime);
            result.opacity = fadeAmount;
            result.positionY = basePose.positionY + (1 - fadeAmount) * 60;
          }
          if (appState.preset === "typewriter") {
            var charactersVisible = Math.floor(text.length * normalizedTime);
            result.revealCharacters = Math.max(1, charactersVisible);
          }
          return result;
        }
        if (appState.preset === "typewriter") {
          var characterCount = text.length;
          var visibleCharacters = Math.floor(characterCount * normalizedTime);
          result.revealCharacters = Math.max(1, visibleCharacters);
        } else if (appState.preset === "fadeUp") {
          var fadeUpValue = sampleEase("easeInOut", normalizedTime);
          result.opacity = fadeUpValue;
          result.positionY = basePose.positionY + (1 - fadeUpValue) * 120;
        } else if (appState.preset === "bounce") {
          var bounceProgress = sampleEase("easeOut", normalizedTime);
          var bounceAmplitude = 60;
          result.positionY = basePose.positionY - Math.abs(Math.sin(bounceProgress * Math.PI * 2.4)) * bounceAmplitude * (1 - normalizedTime);
          result.scale = basePose.scale + Math.sin(bounceProgress * Math.PI * 2.4) * 0.18 * (1 - normalizedTime);
        } else if (appState.preset === "liquid") {
          var wobble = Math.sin(normalizedTime * Math.PI * 4) * 0.16;
          result.rotation = basePose.rotation + wobble * 6;
          result.verticalDrift = Math.sin(normalizedTime * Math.PI * 3) * 22;
          result.horizontalJitter = Math.cos(normalizedTime * Math.PI * 2) * 14;
        } else if (appState.preset === "glitch") {
          var glitchEnergy = 1 - Math.abs(0.5 - normalizedTime) * 2;
          var randomHorizontal = (Math.random() - 0.5) * 30 * glitchEnergy;
          var randomVertical = (Math.random() - 0.5) * 16 * glitchEnergy;
          var randomRotation = (Math.random() - 0.5) * 10 * glitchEnergy;
          result.positionX = basePose.positionX + randomHorizontal;
          result.positionY = basePose.positionY + randomVertical;
          result.rotation = basePose.rotation + randomRotation;
        } else if (appState.preset === "cascadeLetters" || appState.preset === "cascadeWords" || appState.preset === "cascadeLines") {
          var cascadeAmount = sampleEase("easeInOut", normalizedTime);
          result.perGlyphOffset = basePose.letterOffset * cascadeAmount;
          result.perGlyphOpacityBoost = cascadeAmount;
        }
        if (appState.audioReactiveEnabled && appState.audio.analyser) {
          var audioLevel = getCurrentAudioLevel();
          var strength = appState.audioIntensity;
          result.scale += audioLevel * 0.25 * strength;
          result.positionY -= audioLevel * 40 * strength;
        }
        return result;
      }

      function computeCurrentPose(timeValue) {
        ensureDefaultKeyframes();
        var basePose = {
          positionX: interpolateValue(timeValue, "positionX"),
          positionY: interpolateValue(timeValue, "positionY"),
          scale: interpolateValue(timeValue, "scale"),
          rotation: interpolateValue(timeValue, "rotation"),
          opacity: interpolateValue(timeValue, "opacity"),
          letterOffset: interpolateValue(timeValue, "letterOffset"),
          wordOffset: interpolateValue(timeValue, "wordOffset")
        };
        var poseWithPreset = applyPresetToPose(timeValue, basePose);
        return poseWithPreset;
      }

      function renderCurrentFrame(showGuidesOverride) {
        var showGuides;
        if (typeof showGuidesOverride === "boolean") {
          showGuides = showGuidesOverride;
        } else {
          showGuides = true;
        }
        var context = previewCanvasContext;
        var width = appState.renderWidth;
        var height = appState.renderHeight;
        context.save();
        context.setTransform(1, 0, 0, 1, 0, 0);
        context.clearRect(0, 0, width, height);
        context.fillStyle = appState.backgroundColor || "#020617";
        context.fillRect(0, 0, width, height);
        if (appState.backgroundImage) {
          var image = appState.backgroundImage;
          var imageAspect = image.width / image.height;
          var canvasAspect = width / height;
          var drawWidth = width;
          var drawHeight = height;
          var offsetX = 0;
          var offsetY = 0;
          if (imageAspect > canvasAspect) {
            drawWidth = height * imageAspect;
            offsetX = (width - drawWidth) / 2;
          } else {
            drawHeight = width / imageAspect;
            offsetY = (height - drawHeight) / 2;
          }
          context.globalAlpha = 0.9;
          context.drawImage(image, offsetX, offsetY, drawWidth, drawHeight);
          context.globalAlpha = 1;
        }
        if (showGuides && appState.gridVisible) {
          context.save();
          context.strokeStyle = "rgba(15, 23, 42, 0.7)";
          context.lineWidth = 1;
          context.beginPath();
          var gridSpacing = width / 12;
          var lineIndex = 0;
          for (lineIndex = 0; lineIndex <= width; lineIndex += gridSpacing) {
            context.moveTo(lineIndex + 0.5, 0);
            context.lineTo(lineIndex + 0.5, height);
          }
          var verticalSpacing = height / 16;
          for (lineIndex = 0; lineIndex <= height; lineIndex += verticalSpacing) {
            context.moveTo(0, lineIndex + 0.5);
            context.lineTo(width, lineIndex + 0.5);
          }
          context.stroke();
          context.restore();
        }
        if (showGuides && appState.safeAreaVisible) {
          context.save();
          var margin = appState.safeMarginPercent / 100;
          var marginX = width * margin;
          var marginY = height * margin;
          context.strokeStyle = "rgba(56, 189, 248, 0.9)";
          context.lineWidth = 2;
          context.setLineDash([10, 6]);
          context.strokeRect(marginX, marginY, width - marginX * 2, height - marginY * 2);
          context.restore();
        }
        var pose = computeCurrentPose(appState.currentTime);
        var fontStyle = appState.isItalic ? "italic " : "";
        var fontWeight = appState.fontWeight;
        var fontSize = appState.fontSize;
        context.save();
        context.translate(width / 2, height / 2);
        context.translate(pose.positionX, pose.positionY + pose.verticalDrift);
        context.scale(pose.scale, pose.scale * 1.02);
        context.rotate(pose.rotation * Math.PI / 180);
        var maxSafeWidth = width * (1 - appState.safeMarginPercent / 100);
        var align = appState.textAlign;
        var lines = appState.textContent.split("\n");
        var lineIndex;
        var lineHeight = fontSize * 1.2;
        context.font = fontStyle + " " + fontWeight + " " + fontSize + "px " + appState.fontFamily;
        context.textBaseline = "middle";
        context.textAlign = align === "left" ? "left" : align === "right" ? "right" : "center";
        var startY = -((lines.length - 1) * lineHeight) / 2;
        var textMetrics = [];
        for (lineIndex = 0; lineIndex < lines.length; lineIndex += 1) {
          var measurement = context.measureText(lines[lineIndex]);
          var widthValue = measurement.width;
          if (widthValue > maxSafeWidth) {
            var scaleFactor = maxSafeWidth / widthValue;
            widthValue = maxSafeWidth;
            textMetrics.push({ width: widthValue, scaleX: scaleFactor });
          } else {
            textMetrics.push({ width: widthValue, scaleX: 1 });
          }
        }
        if (appState.motionBlurEnabled && !appState.reducedMotionPreferred) {
          var blurSamples = 4;
          var blurSpan = 1 / appState.framesPerSecond;
          var blurIndex = 0;
          for (blurIndex = 0; blurIndex < blurSamples; blurIndex += 1) {
            var offsetTime = appState.currentTime - blurSpan * blurIndex / blurSamples;
            if (offsetTime < 0) {
              continue;
            }
            var blurPose = computeCurrentPose(offsetTime);
            var blurAlpha = (1 - blurIndex / blurSamples) * 0.25;
            drawTextAtPose(blurPose, blurAlpha, textMetrics, lines, startY, lineHeight, maxSafeWidth);
          }
        }
        drawTextAtPose(pose, pose.opacity, textMetrics, lines, startY, lineHeight, maxSafeWidth);
        context.restore();
        context.restore();
      }

      function drawTextAtPose(pose, opacity, textMetrics, lines, startY, lineHeight, maxSafeWidth) {
        var context = previewCanvasContext;
        var lineIndex;
        var globalAlpha = opacity;
        var text = appState.textContent;
        var glyphCount = text.length;
        var revealCharacters = pose.revealCharacters;
        if (revealCharacters < 0) {
          revealCharacters = 0;
        }
        if (revealCharacters > glyphCount) {
          revealCharacters = glyphCount;
        }
        var glyphCounter = 0;
        for (lineIndex = 0; lineIndex < lines.length; lineIndex += 1) {
          var lineText = lines[lineIndex];
          var metrics = textMetrics[lineIndex];
          var lineWidth = metrics.width;
          var centerX = 0;
          var xPosition = centerX;
          if (appState.textAlign === "left") {
            xPosition = -maxSafeWidth / 2;
          }
          if (appState.textAlign === "right") {
            xPosition = maxSafeWidth / 2;
          }
          var yPosition = startY + lineIndex * lineHeight;
          var units = [];
          if (appState.cascadeMode === "words" || appState.preset === "cascadeWords") {
            units = lineText.split(" ");
          } else if (appState.cascadeMode === "lines" || appState.preset === "cascadeLines") {
            units = [lineText];
          } else {
            var characters = [];
            var charIndex = 0;
            for (charIndex = 0; charIndex < lineText.length; charIndex += 1) {
              characters.push(lineText.charAt(charIndex));
            }
            units = characters;
          }
          var unitIndex;
          var offsetX = 0;
          for (unitIndex = 0; unitIndex < units.length; unitIndex += 1) {
            var unitText = units[unitIndex];
            var glyphStartIndex = glyphCounter;
            var glyphEndIndex = glyphStartIndex + unitText.length;
            var unitCenterOffsetX = offsetX;
            var measurement = context.measureText(unitText);
            var unitWidth = measurement.width;
            var cascadeDelay = appState.staggerSeconds * unitIndex;
            var normalizedTime = appState.duration > 0 ? appState.currentTime / appState.duration : 0;
            var localTime = Math.max(0, normalizedTime - cascadeDelay / Math.max(appState.duration, 0.0001));
            var cascadeAmount = sampleEase("easeInOut", localTime);
            var localOpacity = globalAlpha;
            var localY = yPosition;
            if (appState.preset.indexOf("cascade") === 0 || appState.cascadeMode !== "letters") {
              localY += (1 - cascadeAmount) * pose.perGlyphOffset;
              localOpacity *= Math.max(0, Math.min(1, pose.perGlyphOpacityBoost));
            }
            var shouldDraw = glyphEndIndex <= revealCharacters || appState.preset !== "typewriter";
            if (shouldDraw) {
              var fullTextToDraw = unitText;
              if (appState.preset === "typewriter") {
                if (glyphStartIndex >= revealCharacters) {
                  fullTextToDraw = "";
                } else if (glyphEndIndex > revealCharacters) {
                  var visibleCount = revealCharacters - glyphStartIndex;
                  fullTextToDraw = unitText.slice(0, visibleCount);
                }
              }
              if (fullTextToDraw.length > 0) {
                var effectiveX = xPosition + unitCenterOffsetX;
                drawStyledText(fullTextToDraw, effectiveX, localY, lineWidth, unitWidth, localOpacity);
              }
            }
            offsetX += unitWidth + appState.wordOffset;
            glyphCounter += unitText.length;
          }
        }
      }

      function drawStyledText(text, xPosition, yPosition, fullLineWidth, unitWidth, opacity) {
        var context = previewCanvasContext;
        var fillColor = appState.fillColor;
        var gradientColor = appState.gradientColor;
        var outlineColor = appState.outlineColor;
        var outlineWidth = appState.outlineWidth;
        context.save();
        context.globalAlpha = opacity;
        context.font = (appState.isItalic ? "italic " : "") + appState.fontWeight + " " + appState.fontSize + "px " + appState.fontFamily;
        context.textBaseline = "middle";
        context.textAlign = appState.textAlign === "left" ? "left" : appState.textAlign === "right" ? "right" : "center";
        context.shadowColor = "rgba(15, 23, 42, 0.95)";
        context.shadowBlur = appState.shadowBlur;
        var gradient;
        if (appState.fillMode === "gradient") {
          gradient = context.createLinearGradient(xPosition - unitWidth / 2, yPosition - appState.fontSize, xPosition + unitWidth / 2, yPosition + appState.fontSize);
          gradient.addColorStop(0, fillColor);
          gradient.addColorStop(0.5, gradientColor);
          gradient.addColorStop(1, fillColor);
          context.fillStyle = gradient;
          context.fillText(text, xPosition, yPosition);
        } else if (appState.fillMode === "outline") {
          context.fillStyle = "rgba(15,23,42,0.96)";
          context.fillText(text, xPosition, yPosition);
        } else {
          context.fillStyle = fillColor;
          context.fillText(text, xPosition, yPosition);
        }
        if (outlineWidth > 0) {
          context.shadowBlur = Math.max(0, appState.shadowBlur - 6);
          context.lineWidth = outlineWidth;
          context.strokeStyle = outlineColor;
          context.strokeText(text, xPosition, yPosition);
        }
        context.restore();
      }

      function startPlayback() {
        if (appState.isPlaying || exportInProgress) {
          return;
        }
        appState.isPlaying = true;
        appState.lastFrameTimestamp = performance.now();
        if (appState.audio.element) {
          if (appState.audio.context && appState.audio.context.state === "suspended") {
            appState.audio.context.resume();
          }
          try {
            appState.audio.element.currentTime = appState.currentTime;
            appState.audio.element.play();
          } catch (error) {
          }
        }
        playPauseButtonElement.innerHTML = "&#10074;&#10074;";
        animationFrameRequestId = requestAnimationFrame(stepPlayback);
      }

      function stopPlayback() {
        appState.isPlaying = false;
        if (appState.audio.element) {
          try {
            appState.audio.element.pause();
          } catch (error) {
          }
        }
        playPauseButtonElement.innerHTML = "&#9658;";
        if (animationFrameRequestId !== null) {
          cancelAnimationFrame(animationFrameRequestId);
          animationFrameRequestId = null;
        }
      }

      function stepPlayback(timestamp) {
        if (!appState.isPlaying) {
          return;
        }
        var deltaSeconds = (timestamp - appState.lastFrameTimestamp) / 1000;
        if (deltaSeconds > 0.1) {
          deltaSeconds = 0.1;
        }
        appState.lastFrameTimestamp = timestamp;
        if (appState.audio.element) {
          appState.currentTime = appState.audio.element.currentTime;
        } else {
          appState.currentTime += deltaSeconds;
        }
        if (appState.currentTime >= appState.duration) {
          appState.currentTime = appState.duration;
          stopPlayback();
        }
        syncTimelineRange();
        renderCurrentFrame();
        animationFrameRequestId = requestAnimationFrame(stepPlayback);
      }

      function exportWebM() {
        if (!previewCanvasElement.captureStream || typeof MediaRecorder === "undefined") {
          alert("WebM export is not supported in this browser.");
          return;
        }
        if (exportInProgress) {
          return;
        }
        exportInProgress = true;
        var previousPlaying = appState.isPlaying;
        var previousTime = appState.currentTime;
        stopPlayback();
        var stream = previewCanvasElement.captureStream(appState.framesPerSecond);
        var chunks = [];
        var recorder;
        try {
          recorder = new MediaRecorder(stream, { mimeType: "video/webm;codecs=vp9" });
        } catch (error) {
          try {
            recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
          } catch (error2) {
            alert("MediaRecorder could not start for WebM export.");
            exportInProgress = false;
            return;
          }
        }
        recorder.ondataavailable = function (event) {
          if (event.data && event.data.size > 0) {
            chunks.push(event.data);
          }
        };
        recorder.onstop = function () {
          var blob = new Blob(chunks, { type: "video/webm" });
          var url = URL.createObjectURL(blob);
          var link = document.createElement("a");
          link.href = url;
          link.download = "kinetic-typography.webm";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          setTimeout(function () { URL.revokeObjectURL(url); }, 2000);
          exportInProgress = false;
          appState.currentTime = previousTime;
          renderCurrentFrame();
          syncTimelineRange();
          if (previousPlaying) {
            startPlayback();
          }
        };
        appState.currentTime = 0;
        renderCurrentFrame(false);
        recorder.start();
        var startTime = performance.now();
        function stepExport(timestamp) {
          var elapsed = (timestamp - startTime) / 1000;
          if (elapsed > appState.duration) {
            appState.currentTime = appState.duration;
            renderCurrentFrame(false);
            recorder.stop();
            return;
          }
          appState.currentTime = elapsed;
          renderCurrentFrame(false);
          requestAnimationFrame(stepExport);
        }
        requestAnimationFrame(stepExport);
      }

      function exportPngSequence() {
        if (exportInProgress) {
          return;
        }
        exportInProgress = true;
        var previousPlaying = appState.isPlaying;
        var previousTime = appState.currentTime;
        stopPlayback();
        var frameCount = Math.max(1, Math.round(appState.duration * appState.framesPerSecond));
        var frameIndex = 0;
        function saveNext() {
          if (frameIndex >= frameCount) {
            appState.currentTime = previousTime;
            renderCurrentFrame();
            syncTimelineRange();
            if (previousPlaying) {
              startPlayback();
            }
            exportInProgress = false;
            return;
          }
          var timeValue = frameIndex / appState.framesPerSecond;
          appState.currentTime = timeValue;
          renderCurrentFrame(false);
          var dataUrl = previewCanvasElement.toDataURL("image/png");
          var link = document.createElement("a");
          link.href = dataUrl;
          var paddedIndex = String(frameIndex).padStart(4, "0");
          link.download = "kt-frame-" + paddedIndex + ".png";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          frameIndex += 1;
          setTimeout(saveNext, 40);
        }
        saveNext();
      }

      function exportGif() {
        if (typeof GIF === "undefined") {
          alert("GIF export library did not load.");
          return;
        }
        if (exportInProgress) {
          return;
        }
        exportInProgress = true;
        var previousPlaying = appState.isPlaying;
        var previousTime = appState.currentTime;
        stopPlayback();
        var frameDelayMs = Math.round(1000 / appState.framesPerSecond);
        var frameCount = Math.max(1, Math.round(appState.duration * appState.framesPerSecond));
        var gif = new GIF({
          workers: 2,
          quality: 8,
          workerScript: undefined,
          width: appState.renderWidth,
          height: appState.renderHeight
        });
        var frameIndex = 0;
        function addNextFrame() {
          if (frameIndex >= frameCount) {
            gif.on("finished", function (blob) {
              var url = URL.createObjectURL(blob);
              var link = document.createElement("a");
              link.href = url;
              link.download = "kinetic-typography.gif";
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              setTimeout(function () { URL.revokeObjectURL(url); }, 2000);
              exportInProgress = false;
              appState.currentTime = previousTime;
              renderCurrentFrame();
              syncTimelineRange();
              if (previousPlaying) {
                startPlayback();
              }
            });
            gif.render();
            return;
          }
          var timeValue = frameIndex / appState.framesPerSecond;
          appState.currentTime = timeValue;
          renderCurrentFrame(false);
          gif.addFrame(previewCanvasElement, { copy: true, delay: frameDelayMs });
          frameIndex += 1;
          setTimeout(addNextFrame, 10);
        }
        addNextFrame();
      }

      function syncControlsFromState() {
        textInputElement.value = appState.textContent;
        presetSelectElement.value = appState.preset;
        staggerRangeElement.value = appState.staggerSeconds.toFixed(3);
        staggerValueElement.value = appState.staggerSeconds.toFixed(3);
        fontFamilySelectElement.value = appState.fontFamily;
        fontWeightSelectElement.value = String(appState.fontWeight);
        italicToggleElement.checked = appState.isItalic;
        fontSizeRangeElement.value = String(appState.fontSize);
        fontSizeValueElement.value = String(appState.fontSize);
        trackingRangeElement.value = String(appState.tracking);
        trackingValueElement.value = String(appState.tracking);
        positionXRangeElement.value = String(appState.positionX);
        positionXValueElement.value = String(appState.positionX);
        positionYRangeElement.value = String(appState.positionY);
        positionYValueElement.value = String(appState.positionY);
        scaleRangeElement.value = String(appState.scale);
        scaleValueElement.value = String(appState.scale);
        rotationRangeElement.value = String(appState.rotation);
        rotationValueElement.value = String(appState.rotation);
        opacityRangeElement.value = String(appState.opacity);
        opacityValueElement.value = String(appState.opacity);
        letterOffsetRangeElement.value = String(appState.letterOffset);
        letterOffsetValueElement.value = String(appState.letterOffset);
        wordOffsetRangeElement.value = String(appState.wordOffset);
        wordOffsetValueElement.value = String(appState.wordOffset);
        outlineWidthRangeElement.value = String(appState.outlineWidth);
        outlineWidthValueElement.value = String(appState.outlineWidth);
        shadowBlurRangeElement.value = String(appState.shadowBlur);
        shadowBlurValueElement.value = String(appState.shadowBlur);
        fillColorInputElement.value = appState.fillColor;
        gradientColorInputElement.value = appState.gradientColor;
        outlineColorInputElement.value = appState.outlineColor;
        motionBlurToggleElement.checked = appState.motionBlurEnabled;
        easingSelectElement.value = appState.easingPreset;
        bezierP1XElement.value = String(appState.customBezier.p1x);
        bezierP1YElement.value = String(appState.customBezier.p1y);
        bezierP2XElement.value = String(appState.customBezier.p2x);
        bezierP2YElement.value = String(appState.customBezier.p2y);
        safeAreaToggleElement.checked = appState.safeAreaVisible;
        gridToggleElement.checked = appState.gridVisible;
        safeMarginRangeElement.value = String(appState.safeMarginPercent);
        safeMarginValueElement.value = String(appState.safeMarginPercent);
        audioReactiveToggleElement.checked = appState.audioReactiveEnabled;
        audioIntensityRangeElement.value = String(appState.audioIntensity);
        if (appState.preset === "none") {
          presetStatusTextElement.textContent = "Preset: None";
        } else {
          presetStatusTextElement.textContent = "Preset: " + appState.preset;
        }
        easingLabelElement.textContent = easingSelectElement.options[easingSelectElement.selectedIndex].textContent;
        if (appState.reducedMotionPreferred) {
          reducedMotionBadgeElement.textContent = "Reduced motion";
        } else {
          reducedMotionBadgeElement.textContent = "";
        }
        drawEasingPreview();
      }

      function setUpEventListeners() {
        textInputElement.addEventListener("input", function () {
          appState.textContent = textInputElement.value;
          renderCurrentFrame();
        });
        presetSelectElement.addEventListener("change", function () {
          appState.preset = presetSelectElement.value;
          presetStatusTextElement.textContent = "Preset: " + (appState.preset === "none" ? "None" : appState.preset);
          renderCurrentFrame();
        });
        setupChips(cascadeChipsElement, "data-cascade", function (value) {
          appState.cascadeMode = value;
          renderCurrentFrame();
        });
        setupChips(alignChipsElement, "data-align", function (value) {
          appState.textAlign = value;
          renderCurrentFrame();
        });
        setupChips(fillModeChipsElement, "data-fill-mode", function (value) {
          appState.fillMode = value;
          renderCurrentFrame();
        });
        syncNumberAndRange(staggerRangeElement, staggerValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.staggerSeconds = value;
          renderCurrentFrame();
        });
        fontFamilySelectElement.addEventListener("change", function () {
          appState.fontFamily = fontFamilySelectElement.value;
          renderCurrentFrame();
        });
        fontWeightSelectElement.addEventListener("change", function () {
          appState.fontWeight = parseInt(fontWeightSelectElement.value, 10);
          renderCurrentFrame();
        });
        italicToggleElement.addEventListener("change", function () {
          appState.isItalic = italicToggleElement.checked;
          renderCurrentFrame();
        });
        syncNumberAndRange(fontSizeRangeElement, fontSizeValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.fontSize = value;
          renderCurrentFrame();
        });
        syncNumberAndRange(trackingRangeElement, trackingValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.tracking = value;
          renderCurrentFrame();
        });
        syncNumberAndRange(positionXRangeElement, positionXValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.positionX = value;
          renderCurrentFrame();
          renderTimelineKeyframes();
        });
        syncNumberAndRange(positionYRangeElement, positionYValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.positionY = value;
          renderCurrentFrame();
          renderTimelineKeyframes();
        });
        syncNumberAndRange(scaleRangeElement, scaleValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.scale = value;
          renderCurrentFrame();
          renderTimelineKeyframes();
        });
        syncNumberAndRange(rotationRangeElement, rotationValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.rotation = value;
          renderCurrentFrame();
          renderTimelineKeyframes();
        });
        syncNumberAndRange(opacityRangeElement, opacityValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.opacity = value;
          renderCurrentFrame();
          renderTimelineKeyframes();
        });
        syncNumberAndRange(letterOffsetRangeElement, letterOffsetValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.letterOffset = value;
          renderCurrentFrame();
          renderTimelineKeyframes();
        });
        syncNumberAndRange(wordOffsetRangeElement, wordOffsetValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.wordOffset = value;
          renderCurrentFrame();
          renderTimelineKeyframes();
        });
        syncNumberAndRange(outlineWidthRangeElement, outlineWidthValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.outlineWidth = value;
          renderCurrentFrame();
        });
        syncNumberAndRange(shadowBlurRangeElement, shadowBlurValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.shadowBlur = value;
          renderCurrentFrame();
        });
        fillColorInputElement.addEventListener("input", function () {
          appState.fillColor = fillColorInputElement.value;
          renderCurrentFrame();
        });
        gradientColorInputElement.addEventListener("input", function () {
          appState.gradientColor = gradientColorInputElement.value;
          renderCurrentFrame();
        });
        outlineColorInputElement.addEventListener("input", function () {
          appState.outlineColor = outlineColorInputElement.value;
          renderCurrentFrame();
        });
        motionBlurToggleElement.addEventListener("change", function () {
          appState.motionBlurEnabled = motionBlurToggleElement.checked && !appState.reducedMotionPreferred;
          renderCurrentFrame();
        });
        easingSelectElement.addEventListener("change", function () {
          appState.easingPreset = easingSelectElement.value;
          easingLabelElement.textContent = easingSelectElement.options[easingSelectElement.selectedIndex].textContent;
          bezierRowElement.style.display = appState.easingPreset === "custom" ? "grid" : "none";
          drawEasingPreview();
          renderTimelineKeyframes();
        });
        function updateBezierFromInputs() {
          var p1x = parseFloat(bezierP1XElement.value);
          var p1y = parseFloat(bezierP1YElement.value);
          var p2x = parseFloat(bezierP2XElement.value);
          var p2y = parseFloat(bezierP2YElement.value);
          if (!isNaN(p1x)) {
            appState.customBezier.p1x = p1x;
          }
          if (!isNaN(p1y)) {
            appState.customBezier.p1y = p1y;
          }
          if (!isNaN(p2x)) {
            appState.customBezier.p2x = p2x;
          }
          if (!isNaN(p2y)) {
            appState.customBezier.p2y = p2y;
          }
          drawEasingPreview();
        }
        bezierP1XElement.addEventListener("change", updateBezierFromInputs);
        bezierP1YElement.addEventListener("change", updateBezierFromInputs);
        bezierP2XElement.addEventListener("change", updateBezierFromInputs);
        bezierP2YElement.addEventListener("change", updateBezierFromInputs);
        timelineRangeElement.addEventListener("input", function () {
          var ratio = parseInt(timelineRangeElement.value, 10) / 1000;
          if (isNaN(ratio)) {
            return;
          }
          appState.currentTime = ratio * appState.duration;
          if (appState.audio.element) {
            try {
              appState.audio.element.currentTime = appState.currentTime;
            } catch (error) {
            }
          }
          syncTimelineRange();
          renderCurrentFrame();
        });
        function handleTimelinePointer(event) {
          var rect = timelineGridElement.getBoundingClientRect();
          var pointerX = event.clientX;
          if (event.touches && event.touches.length > 0) {
            pointerX = event.touches[0].clientX;
          }
          var ratio = (pointerX - rect.left) / rect.width;
          if (ratio < 0) {
            ratio = 0;
          }
          if (ratio > 1) {
            ratio = 1;
          }
          appState.currentTime = ratio * appState.duration;
          syncTimelineRange();
          renderCurrentFrame();
        }
        var isDraggingTimeline = false;
        timelineGridElement.addEventListener("pointerdown", function (event) {
          isDraggingTimeline = true;
          timelineGridElement.setPointerCapture(event.pointerId);
          handleTimelinePointer(event);
        });
        window.addEventListener("pointermove", function (event) {
          if (isDraggingTimeline) {
            handleTimelinePointer(event);
          }
        });
        window.addEventListener("pointerup", function (event) {
          if (isDraggingTimeline) {
            isDraggingTimeline = false;
          }
        });
        safeAreaToggleElement.addEventListener("change", function () {
          appState.safeAreaVisible = safeAreaToggleElement.checked;
          safeBadgeElement.style.opacity = appState.safeAreaVisible ? "1" : "0.35";
          renderCurrentFrame();
        });
        gridToggleElement.addEventListener("change", function () {
          appState.gridVisible = gridToggleElement.checked;
          renderCurrentFrame();
        });
        syncNumberAndRange(safeMarginRangeElement, safeMarginValueElement, function (value) {
          if (isNaN(value)) {
            return;
          }
          appState.safeMarginPercent = value;
          renderCurrentFrame();
        });
        backgroundColorInputElement.addEventListener("input", function () {
          appState.backgroundColor = backgroundColorInputElement.value;
          renderCurrentFrame();
        });
        backgroundImageInputElement.addEventListener("change", function () {
          var file = backgroundImageInputElement.files && backgroundImageInputElement.files[0];
          if (!file) {
            appState.backgroundImage = null;
            renderCurrentFrame();
            return;
          }
          var reader = new FileReader();
          reader.onload = function (event) {
            var image = new Image();
            image.onload = function () {
              appState.backgroundImage = image;
              renderCurrentFrame();
            };
            image.src = event.target.result;
          };
          reader.readAsDataURL(file);
        });
        aspectSelectElement.addEventListener("change", resizeCanvasToAspect);
        resolutionSelectElement.addEventListener("change", resizeCanvasToAspect);
        fpsSelectElement.addEventListener("change", function () {
          var fps = parseInt(fpsSelectElement.value, 10);
          if (!isNaN(fps)) {
            appState.framesPerSecond = fps;
            updatePreviewDescriptor();
          }
        });
        durationSelectElement.addEventListener("change", function () {
          var duration = parseFloat(durationSelectElement.value);
          if (!isNaN(duration)) {
            appState.duration = duration;
            updatePreviewDescriptor();
          }
        });
        playPauseButtonElement.addEventListener("click", function () {
          if (appState.isPlaying) {
            stopPlayback();
          } else {
            startPlayback();
          }
        });
        jumpBackButtonElement.addEventListener("click", function () {
          appState.currentTime = Math.max(0, appState.currentTime - 0.15);
          if (appState.audio.element) {
            appState.audio.element.currentTime = appState.currentTime;
          }
          syncTimelineRange();
          renderCurrentFrame();
        });
        jumpForwardButtonElement.addEventListener("click", function () {
          appState.currentTime = Math.min(appState.duration, appState.currentTime + 0.15);
          if (appState.audio.element) {
            appState.audio.element.currentTime = appState.currentTime;
          }
          syncTimelineRange();
          renderCurrentFrame();
        });
        addKeyframeButtonElement.addEventListener("click", function () {
          addKeyframeAtCurrentTime();
        });
        exportVideoButtonElement.addEventListener("click", exportWebM);
        exportGifButtonElement.addEventListener("click", exportGif);
        exportPngButtonElement.addEventListener("click", exportPngSequence);
        audioReactiveToggleElement.addEventListener("change", function () {
          appState.audioReactiveEnabled = audioReactiveToggleElement.checked;
          audioStatusTextElement.textContent = appState.audioReactiveEnabled ? "Audio reactive on" : "Audio reactive idle";
        });
        audioIntensityRangeElement.addEventListener("input", function () {
          var value = parseFloat(audioIntensityRangeElement.value);
          if (!isNaN(value)) {
            appState.audioIntensity = value;
          }
        });
        audioFileInputElement.addEventListener("change", function () {
          var file = audioFileInputElement.files && audioFileInputElement.files[0];
          if (!file) {
            return;
          }
          var audioContext = appState.audio.context;
          if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            appState.audio.context = audioContext;
          }
          var fileReader = new FileReader();
          fileReader.onload = function (event) {
            var arrayBuffer = event.target.result;
            audioContext.decodeAudioData(arrayBuffer).then(function (buffer) {
              appState.audio.decodedBuffer = buffer;
              detectBeats(buffer);
              audioAnalysisLabelElement.textContent = "Audio decoded";
            });
          };
          fileReader.readAsArrayBuffer(file);
          if (appState.audio.element) {
            try {
              appState.audio.element.pause();
            } catch (error) {
            }
          }
          var audioElement = new Audio();
          audioElement.src = URL.createObjectURL(file);
          audioElement.crossOrigin = "anonymous";
          appState.audio.element = audioElement;
          audioStatusTextElement.textContent = "Audio ready";
          var sourceNode = audioContext.createMediaElementSource(audioElement);
          var analyser = audioContext.createAnalyser();
          analyser.fftSize = 256;
          var dataArray = new Uint8Array(analyser.frequencyBinCount);
          sourceNode.connect(analyser);
          analyser.connect(audioContext.destination);
          appState.audio.analyser = analyser;
          appState.audio.dataArray = dataArray;
        });
        detectBeatsButtonElement.addEventListener("click", function () {
          if (appState.audio.decodedBuffer) {
            detectBeats(appState.audio.decodedBuffer);
          }
        });
        snapToBeatsButtonElement.addEventListener("click", function () {
          snapKeyframesToBeats();
        });
        window.addEventListener("keydown", function (event) {
          if (event.target && (event.target.tagName === "INPUT" || event.target.tagName === "TEXTAREA" || event.target.tagName === "SELECT")) {
            return;
          }
          var key = event.key.toLowerCase();
          if (key === " ") {
            event.preventDefault();
            if (appState.isPlaying) {
              stopPlayback();
            } else {
              startPlayback();
            }
          } else if (key === "j") {
            event.preventDefault();
            appState.currentTime = Math.max(0, appState.currentTime - 0.12);
            if (appState.audio.element) {
              appState.audio.element.currentTime = appState.currentTime;
            }
            syncTimelineRange();
            renderCurrentFrame();
          } else if (key === "k") {
            event.preventDefault();
            stopPlayback();
          } else if (key === "l") {
            event.preventDefault();
            appState.currentTime = Math.min(appState.duration, appState.currentTime + 0.12);
            if (appState.audio.element) {
              appState.audio.element.currentTime = appState.currentTime;
            }
            syncTimelineRange();
            renderCurrentFrame();
          } else if (key === "a") {
            event.preventDefault();
            addKeyframeAtCurrentTime();
          } else if (key === "r") {
            event.preventDefault();
            appState.audioReactiveEnabled = !appState.audioReactiveEnabled;
            audioReactiveToggleElement.checked = appState.audioReactiveEnabled;
            audioStatusTextElement.textContent = appState.audioReactiveEnabled ? "Audio reactive on" : "Audio reactive idle";
          }
        });
      }

      function detectReducedMotion() {
        var query = window.matchMedia("(prefers-reduced-motion: reduce)");
        var handleChange = function () {
          appState.reducedMotionPreferred = query.matches;
          appState.motionBlurEnabled = false;
          motionBlurToggleElement.checked = false;
          reducedMotionBadgeElement.textContent = appState.reducedMotionPreferred ? "Reduced motion" : "";
          renderCurrentFrame();
        };
        handleChange();
        if (typeof query.addEventListener === "function") {
          query.addEventListener("change", handleChange);
        } else if (typeof query.addListener === "function") {
          query.addListener(handleChange);
        }
      }

      function initialize() {
        detectReducedMotion();
        ensureDefaultKeyframes();
        setUpEventListeners();
        resizeCanvasToAspect();
        syncTimelineRange();
        renderTimelineKeyframes();
        renderKeyframeList();
        syncControlsFromState();
        renderCurrentFrame();
        drawEasingPreview();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initialize);
      } else {
        initialize();
      }
    }());
  </script>
</body>
</html>

