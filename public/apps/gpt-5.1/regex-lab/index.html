<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>Regex Lab â€“ Interactive Playground</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      --font-mono: SFMono-Regular, ui-monospace, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.45);
      --accent: 170 100% 60%;
      --accent-soft: 170 95% 16%;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: var(--font-sans);
      -webkit-font-smoothing: antialiased;
      background: radial-gradient(circle at top left, #121826, #05070b 52%, #020308);
      color: #f9fafb;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 10% 0%, rgba(56, 189, 248, 0.12), transparent 55%),
        radial-gradient(circle at 90% 0%, rgba(94, 234, 212, 0.12), transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.7;
      z-index: -1;
    }

    [data-theme="light"] body {
      background: radial-gradient(circle at top left, #f3f4f6, #e5e7eb 50%, #e5e7eb);
      color: #020617;
    }

    .page {
      max-width: 1120px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 4px 6px;
    }

    .title-main {
      display: flex;
      align-items: baseline;
      gap: 10px;
    }

    .title {
      font-size: 1.4rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-weight: 650;
    }

    .subtitle {
      font-size: 0.85rem;
      opacity: 0.7;
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 3px 10px;
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.8), rgba(12, 148, 136, 0.85));
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.45);
      font-size: 0.78rem;
      cursor: pointer;
      color: #e5f4ff;
      user-select: none;
    }

    .theme-toggle span.icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.9);
      font-size: 0.85rem;
    }

    [data-theme="light"] .theme-toggle {
      background: radial-gradient(circle at top left, rgba(253, 224, 71, 0.9), rgba(249, 115, 22, 0.85));
      color: #111827;
      border-color: rgba(148, 163, 184, 0.7);
    }

    [data-theme="light"] .theme-toggle span.icon {
      background: rgba(255, 255, 255, 0.9);
    }

    .terminal {
      flex: 1;
      min-height: 0;
      background: radial-gradient(circle at top left, #020617, #020617 45%, #020617);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    [data-theme="light"] .terminal {
      background: radial-gradient(circle at top left, #f9fafb, #f3f4f6);
      border-color: rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
    }

    .term-header {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
      border-bottom: 1px solid rgba(15, 23, 42, 0.85);
    }

    [data-theme="light"] .term-header {
      background: linear-gradient(to bottom, #e5e7eb, #d1d5db);
      border-bottom-color: rgba(148, 163, 184, 0.8);
    }

    .traffic-lights {
      display: flex;
      gap: 6px;
    }

    .traffic-lights span {
      width: 12px;
      height: 12px;
      border-radius: 100%;
      display: block;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.4);
    }

    .traffic-lights span:nth-child(1) {
      background: radial-gradient(circle at 30% 30%, #fecaca, #f97373);
    }

    .traffic-lights span:nth-child(2) {
      background: radial-gradient(circle at 30% 30%, #fee2b3, #fbbf24);
    }

    .traffic-lights span:nth-child(3) {
      background: radial-gradient(circle at 30% 30%, #bbf7d0, #22c55e);
    }

    .term-title {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      opacity: 0.75;
      margin-left: 6px;
    }

    .term-body {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1.1fr);
      gap: 0;
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 900px) {
      body {
        padding: 12px;
      }
      .term-body {
        grid-template-columns: minmax(0, 1fr);
        grid-auto-rows: auto;
      }
    }

    .pane {
      padding: 14px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pane + .pane {
      border-left: 1px solid rgba(30, 64, 175, 0.4);
    }

    @media (max-width: 900px) {
      .pane + .pane {
        border-left: none;
        border-top: 1px solid rgba(30, 64, 175, 0.45);
      }
    }

    .pane-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 2px;
    }

    .pane-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(148, 163, 184, 0.9);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pane-title code {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      padding: 1px 5px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(30, 64, 175, 0.85);
      color: #e5f4ff;
    }

    [data-theme="light"] .pane-title {
      color: rgba(55, 65, 81, 0.95);
    }

    [data-theme="light"] .pane-title code {
      background: #f3f4f6;
      border-color: rgba(59, 130, 246, 0.7);
      color: #111827;
    }

    .pill {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: linear-gradient(to right, rgba(15, 23, 42, 0.8), rgba(15, 23, 42, 0.9));
      color: rgba(226, 232, 240, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    [data-theme="light"] .pill {
      background: linear-gradient(to right, #f3f4f6, #e5e7eb);
      color: #111827;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #a5b4fc, #4f46e5);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.9);
    }

    .field-label {
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: rgba(148, 163, 184, 0.9);
      margin-bottom: 4px;
    }

    [data-theme="light"] .field-label {
      color: rgba(55, 65, 81, 0.9);
    }

    .pattern-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 10px;
      align-items: center;
    }

    @media (max-width: 640px) {
      .pattern-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .pattern-input-wrap {
      display: flex;
      align-items: stretch;
      background: radial-gradient(circle at top left, #020617, #020617 55%, #020617);
      border-radius: var(--radius-md);
      border: 1px solid rgba(30, 64, 175, 0.7);
      padding: 6px 8px;
      gap: 4px;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9), 0 0 0 1px rgba(15, 23, 42, 0.6);
    }

    [data-theme="light"] .pattern-input-wrap {
      background: radial-gradient(circle at top left, #f9fafb, #e5e7eb);
      border-color: rgba(59, 130, 246, 0.7);
      box-shadow: inset 0 0 0 1px rgba(229, 231, 235, 0.9), 0 0 0 1px rgba(148, 163, 184, 0.6);
    }

    .pattern-delims {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      color: rgba(148, 163, 184, 0.95);
      display: inline-flex;
      align-items: center;
      padding: 0 2px 0 4px;
    }

    [data-theme="light"] .pattern-delims {
      color: rgba(75, 85, 99, 0.95);
    }

    #pattern {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: inherit;
      font-family: var(--font-mono);
      font-size: 0.9rem;
      padding: 0 2px;
      min-width: 0;
    }

    #pattern::placeholder {
      color: rgba(100, 116, 139, 0.85);
    }

    [data-theme="light"] #pattern::placeholder {
      color: rgba(148, 163, 184, 0.9);
    }

    .flags {
      display: inline-flex;
      gap: 6px;
      padding: 2px 6px 2px 4px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9));
      align-items: center;
    }

    [data-theme="light"] .flags {
      background: linear-gradient(to right, #f3f4f6, #e5e7eb);
      border-color: rgba(148, 163, 184, 0.7);
    }

    .flags-label {
      font-family: var(--font-mono);
      font-size: 0.72rem;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.95);
      padding-right: 3px;
    }

    [data-theme="light"] .flags-label {
      color: rgba(55, 65, 81, 0.95);
    }

    .flag-btn {
      border-radius: 999px;
      padding: 2px 6px;
      background: transparent;
      border: none;
      color: rgba(148, 163, 184, 0.95);
      font-family: var(--font-mono);
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 120ms ease, color 120ms ease, box-shadow 120ms ease;
      position: relative;
      min-width: 22px;
    }

    .flag-btn::after {
      content: attr(aria-label);
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -1.5em;
      font-family: var(--font-sans);
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      white-space: nowrap;
      color: rgba(148, 163, 184, 0.8);
      opacity: 0;
      pointer-events: none;
    }

    .flags:hover .flag-btn::after {
      opacity: 1;
    }

    .flag-btn.active {
      background: radial-gradient(circle at 30% 0%, rgba(94, 234, 212, 0.6), rgba(56, 189, 248, 0.9));
      color: #020617;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    [data-theme="light"] .flag-btn {
      color: rgba(75, 85, 99, 0.95);
    }

    [data-theme="light"] .flag-btn.active {
      background: radial-gradient(circle at 30% 0%, rgba(14, 165, 233, 0.8), rgba(59, 130, 246, 0.95));
      color: #f9fafb;
    }

    .quick-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .quick-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(148, 163, 184, 0.85);
      margin-right: 4px;
    }

    [data-theme="light"] .quick-label {
      color: rgba(75, 85, 99, 0.9);
    }

    .chip {
      font-family: var(--font-mono);
      font-size: 0.78rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 3px 7px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.96));
      color: rgba(226, 232, 240, 0.95);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      transition: background 120ms ease, border-color 120ms ease, transform 80ms ease;
    }

    .chip small {
      font-family: var(--font-sans);
      font-size: 0.62rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      opacity: 0.7;
    }

    .chip:hover {
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.7), rgba(15, 23, 42, 0.98));
      border-color: rgba(129, 140, 248, 0.9);
      transform: translateY(-0.5px);
    }

    [data-theme="light"] .chip {
      background: radial-gradient(circle at top left, #f9fafb, #e5e7eb);
      color: #111827;
      border-color: rgba(148, 163, 184, 0.8);
    }

    [data-theme="light"] .chip:hover {
      background: radial-gradient(circle at top left, #e0f2fe, #dbeafe);
      border-color: rgba(96, 165, 250, 0.95);
    }

    .textarea-wrap {
      margin-top: 8px;
    }

    textarea {
      width: 100%;
      min-height: 160px;
      resize: vertical;
      border-radius: var(--radius-md);
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.98));
      color: #e5e7eb;
      padding: 9px 10px;
      box-sizing: border-box;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      line-height: 1.5;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.95);
    }

    textarea::placeholder {
      color: rgba(100, 116, 139, 0.9);
    }

    [data-theme="light"] textarea {
      background: radial-gradient(circle at top left, #f9fafb, #e5e7eb);
      border-color: rgba(148, 163, 184, 0.9);
      color: #020617;
      box-shadow: inset 0 0 0 1px rgba(226, 232, 240, 0.95);
    }

    [data-theme="light"] textarea::placeholder {
      color: rgba(148, 163, 184, 0.9);
    }

    .actions-row {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: linear-gradient(to right, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.94));
      color: rgba(226, 232, 240, 0.98);
      padding: 4px 10px;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
      transition: background 120ms ease, transform 80ms ease, box-shadow 120ms ease;
    }

    .btn-icon {
      font-size: 0.9rem;
    }

    .btn-primary {
      background: radial-gradient(circle at 20% 0%, rgba(56, 189, 248, 0.98), rgba(16, 185, 129, 0.98));
      border-color: rgba(34, 211, 238, 0.9);
      color: #022c22;
    }

    .btn-ghost {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
      border-style: dashed;
      border-color: rgba(148, 163, 184, 0.6);
    }

    .btn:hover {
      transform: translateY(-0.5px);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.9);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.9);
    }

    [data-theme="light"] .btn {
      background: linear-gradient(to right, #111827, #020617);
      color: #f9fafb;
      border-color: rgba(148, 163, 184, 0.7);
    }

    [data-theme="light"] .btn-ghost {
      background: linear-gradient(to right, #f3f4f6, #e5e7eb);
      color: #111827;
    }

    [data-theme="light"] .btn-primary {
      background: radial-gradient(circle at 20% 0%, #22c55e, #16a34a);
      border-color: rgba(34, 197, 94, 0.9);
      color: #ecfdf3;
    }

    .status-text {
      font-size: 0.72rem;
      color: rgba(148, 163, 184, 0.9);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.9);
    }

    .status-text span.value {
      font-family: var(--font-mono);
      font-size: 0.72rem;
    }

    .output-section {
      flex: 1;
      min-height: 0;
      display: grid;
      grid-template-rows: minmax(0, 1.2fr) minmax(0, 1fr) minmax(0, 0.85fr);
      gap: 10px;
    }

    @media (max-width: 900px) {
      .output-section {
        grid-template-rows: minmax(0, 1.1fr) minmax(0, 1fr) minmax(0, 0.7fr);
      }
    }

    .card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(30, 64, 175, 0.75);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.94), rgba(15, 23, 42, 0.98));
      padding: 8px 10px 9px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.95);
      min-height: 0;
    }

    [data-theme="light"] .card {
      background: radial-gradient(circle at top left, #f9fafb, #e5e7eb);
      border-color: rgba(96, 165, 250, 0.9);
      box-shadow: inset 0 0 0 1px rgba(226, 232, 240, 0.95);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }

    .card-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(148, 163, 184, 0.9);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card-title span.icon {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid rgba(129, 140, 248, 0.9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.78rem;
      background: radial-gradient(circle at top left, rgba(55, 65, 81, 0.95), rgba(15, 23, 42, 0.98));
      color: #e5e7eb;
    }

    [data-theme="light"] .card-title {
      color: rgba(55, 65, 81, 0.9);
    }

    [data-theme="light"] .card-title span.icon {
      background: radial-gradient(circle at top left, #eff6ff, #e0f2fe);
      color: #111827;
      border-color: rgba(59, 130, 246, 0.95);
    }

    .card-meta {
      font-size: 0.7rem;
      color: rgba(148, 163, 184, 0.85);
      font-family: var(--font-mono);
    }

    [data-theme="light"] .card-meta {
      color: rgba(75, 85, 99, 0.9);
    }

    .scroll {
      flex: 1;
      min-height: 0;
      border-radius: calc(var(--radius-md) - 4px);
      background: rgba(15, 23, 42, 0.92);
      padding: 6px 7px;
      overflow: auto;
      font-family: var(--font-mono);
      font-size: 0.84rem;
      line-height: 1.5;
      color: #e5e7eb;
      border: 1px solid rgba(15, 23, 42, 0.95);
    }

    [data-theme="light"] .scroll {
      background: #f9fafb;
      border-color: rgba(226, 232, 240, 0.95);
      color: #020617;
    }

    .scroll pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .scroll code {
      font-family: inherit;
      font-size: inherit;
    }

    /* Highlighted matches */
    .match {
      padding: 0 1px;
      border-radius: 4px;
      background: rgba(56, 189, 248, 0.18);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
    }

    .no-match {
      opacity: 0.6;
      font-style: italic;
      color: rgba(148, 163, 184, 0.9);
    }

    [data-theme="light"] .no-match {
      color: rgba(107, 114, 128, 0.95);
    }

    .match-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: rgba(148, 163, 184, 0.9);
    }

    [data-theme="light"] .match-legend {
      color: rgba(75, 85, 99, 0.9);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 1px 4px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
    }

    [data-theme="light"] .legend-item {
      background: #e5e7eb;
    }

    .legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.9);
    }

    /* Matches table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    th,
    td {
      padding: 3px 5px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.4);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      color: rgba(148, 163, 184, 0.95);
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.96);
      backdrop-filter: blur(6px);
      z-index: 1;
    }

    [data-theme="light"] th {
      color: rgba(75, 85, 99, 0.95);
      background: rgba(249, 250, 251, 0.96);
    }

    td {
      color: #e5e7eb;
    }

    [data-theme="light"] td {
      color: #020617;
    }

    .td-muted {
      opacity: 0.6;
      font-style: italic;
    }

    .group-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 1px 5px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
    }

    [data-theme="light"] .group-chip {
      background: #e5e7eb;
      border-color: rgba(148, 163, 184, 0.8);
    }

    .group-chip span {
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 16px;
      padding: 0 4px;
      border-radius: 999px;
      font-size: 0.68rem;
      font-family: var(--font-mono);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(226, 232, 240, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.8);
    }

    [data-theme="light"] .badge {
      background: #f9fafb;
      color: #111827;
      border-color: rgba(148, 163, 184, 0.8);
    }

    /* Explanation list */
    .explain-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.78rem;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .explain-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 6px;
      align-items: baseline;
    }

    .ex-token {
      font-family: var(--font-mono);
      padding: 1px 4px;
      border-radius: 4px;
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      border: 1px solid rgba(30, 64, 175, 0.7);
      white-space: nowrap;
    }

    [data-theme="light"] .ex-token {
      background: #e5e7eb;
      color: #111827;
      border-color: rgba(59, 130, 246, 0.85);
    }

    .ex-desc {
      color: rgba(148, 163, 184, 0.95);
    }

    [data-theme="light"] .ex-desc {
      color: rgba(75, 85, 99, 0.95);
    }

    /* Error area */
    .error {
      margin-top: 4px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(248, 113, 113, 0.9);
      background: rgba(127, 29, 29, 0.96);
      color: #fee2e2;
      font-size: 0.76rem;
      padding: 4px 6px;
      font-family: var(--font-mono);
      white-space: pre-wrap;
      word-break: break-word;
    }

    [data-theme="light"] .error {
      background: #fef2f2;
      color: #7f1d1d;
      border-color: rgba(220, 38, 38, 0.95);
    }

    .error strong {
      font-weight: 600;
    }

    .error-line {
      margin-top: 2px;
      font-family: var(--font-mono);
    }

    .error-caret {
      color: #fed7d7;
    }

    [data-theme="light"] .error-caret {
      color: #b91c1c;
    }

    /* Utility */
    ::-webkit-scrollbar {
      width: 7px;
      height: 7px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(30, 64, 175, 0.7);
      border-radius: 999px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="title-row">
      <div class="title-main">
        <div>
          <div class="title">Regex Lab</div>
          <div class="subtitle">A tiny terminal for exploring regular expressions.</div>
        </div>
      </div>
      <button id="themeToggle" class="theme-toggle" type="button">
        <span class="icon" aria-hidden="true">ðŸŒ™</span>
        <span>Dark mode</span>
      </button>
    </div>

    <main class="terminal" aria-label="Regex Lab playground">
      <header class="term-header">
        <div class="traffic-lights" aria-hidden="true">
          <span></span><span></span><span></span>
        </div>
        <div class="term-title">~/regex-lab â–¶ node regex.js</div>
      </header>

      <section class="term-body">
        <!-- Left: Inputs -->
        <section class="pane" aria-label="Regex input">
          <div class="pane-header">
            <div class="pane-title">
              Pattern &amp; Text
              <code id="flagsSummary">/pattern/gi</code>
            </div>
            <div class="pill">
              <span class="pill-dot"></span>
              Live evaluating
            </div>
          </div>

          <div>
            <div class="field-label">Regular expression</div>
            <div class="pattern-row">
              <div class="pattern-input-wrap">
                <span class="pattern-delims">/</span>
                <input id="pattern" type="text" spellcheck="false" autocomplete="off"
                  placeholder="e.g. ^(?&lt;user&gt;[a-z0-9_]+)@example\\.com$" />
                <span class="pattern-delims">/</span>
                <div class="flags" aria-label="Regex flags">
                  <span class="flags-label">flags</span>
                  <button class="flag-btn active" data-flag="g" aria-label="global">g</button>
                  <button class="flag-btn" data-flag="i" aria-label="ignore case">i</button>
                  <button class="flag-btn" data-flag="m" aria-label="multiline">m</button>
                  <button class="flag-btn" data-flag="s" aria-label="dot all">s</button>
                  <button class="flag-btn" data-flag="u" aria-label="unicode">u</button>
                  <button class="flag-btn" data-flag="y" aria-label="sticky">y</button>
                </div>
              </div>
            </div>
          </div>

          <div class="quick-row" aria-label="Quick token inserts">
            <span class="quick-label">Tokens</span>
            <button class="chip" data-insert="\\d">
              \d
              <small>digit</small>
            </button>
            <button class="chip" data-insert="\\w+">
              \w+
              <small>word</small>
            </button>
            <button class="chip" data-insert="\\s*">
              \s*
              <small>whitespace</small>
            </button>
            <button class="chip" data-insert="[A-Z]">
              [A-Z]
              <small>caps</small>
            </button>
            <button class="chip" data-insert="^start">
              ^start
              <small>anchor</small>
            </button>
            <button class="chip" data-insert="end$">
              end$
              <small>anchor</small>
            </button>
            <button class="chip" data-insert="(group)">
              (group)
              <small>capture</small>
            </button>
            <button class="chip" data-insert="(?:non-capture)">
              (?: )
              <small>non-cap</small>
            </button>
            <button class="chip" data-insert="(?=lookahead)">
              (?= )
              <small>lookahead</small>
            </button>
            <button class="chip" data-insert="(?!negative)">
              (?! )
              <small>neg look</small>
            </button>
          </div>

          <div class="textarea-wrap">
            <div class="field-label">Test text</div>
            <textarea id="text" spellcheck="false"
              placeholder="Paste or type sample text here. Matches will be highlighted, indexed and explained in real-time."></textarea>
          </div>

          <div class="actions-row">
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button id="clearBtn" class="btn btn-ghost" type="button">
                <span class="btn-icon">ðŸ§¹</span>
                Clear
              </button>
              <button id="examplesBtn" class="btn btn-ghost" type="button">
                <span class="btn-icon">ðŸ“š</span>
                Examples
              </button>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
              <button id="shareBtn" class="btn btn-primary" type="button">
                <span class="btn-icon">ðŸ”—</span>
                Copy permalink
              </button>
              <div class="status-text">
                <span class="status-dot"></span>
                <span>Matches:</span>
                <span class="value" id="matchCount">0</span>
              </div>
            </div>
          </div>

          <div id="errorBox" class="error" style="display:none;" role="status" aria-live="polite"></div>
        </section>

        <!-- Right: Outputs -->
        <section class="pane" aria-label="Regex output">
          <div class="output-section">
            <!-- Highlighted text -->
            <article class="card" aria-label="Highlighted matches">
              <div class="card-header">
                <div class="card-title">
                  <span class="icon">âœ£</span>
                  Highlighted text
                </div>
                <div class="card-meta" id="rangeSummary">No pattern yet</div>
              </div>
              <div class="scroll" id="highlightPane">
                <pre><code class="no-match">Enter a pattern and some text to see matches.</code></pre>
              </div>
              <div class="match-legend" id="groupLegend"></div>
            </article>

            <!-- Matches table -->
            <article class="card" aria-label="Matches table">
              <div class="card-header">
                <div class="card-title">
                  <span class="icon">â˜°</span>
                  Match index &amp; groups
                </div>
                <div class="card-meta" id="tableMeta">0 matches</div>
              </div>
              <div class="scroll" id="tablePane">
                <div class="no-match">No matches yet.</div>
              </div>
            </article>

            <!-- Explanation -->
            <article class="card" aria-label="Pattern explanation">
              <div class="card-header">
                <div class="card-title">
                  <span class="icon">â„¹</span>
                  Pattern walkthrough
                </div>
                <div class="card-meta" id="explainMeta">Common tokens recognized automatically.</div>
              </div>
              <div class="scroll" id="explainPane">
                <div class="no-match">Start typing a regex and we'll break down familiar pieces like <code>\d</code>, <code>\w+</code>, anchors, groups, and more.</div>
              </div>
            </article>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script>
    (function () {
      const d = document;
      const patternInput = d.getElementById("pattern");
      const textInput = d.getElementById("text");
      const flagButtons = Array.from(d.querySelectorAll(".flag-btn"));
      const flagsSummary = d.getElementById("flagsSummary");
      const matchCountEl = d.getElementById("matchCount");
      const highlightPane = d.getElementById("highlightPane");
      const rangeSummary = d.getElementById("rangeSummary");
      const groupLegend = d.getElementById("groupLegend");
      const tablePane = d.getElementById("tablePane");
      const tableMeta = d.getElementById("tableMeta");
      const explainPane = d.getElementById("explainPane");
      const explainMeta = d.getElementById("explainMeta");
      const errorBox = d.getElementById("errorBox");
      const clearBtn = d.getElementById("clearBtn");
      const shareBtn = d.getElementById("shareBtn");
      const examplesBtn = d.getElementById("examplesBtn");
      const themeToggle = d.getElementById("themeToggle");

      const FLAG_ORDER = ["g", "i", "m", "s", "u", "y"];

      const EXAMPLES = [
        {
          label: "Emails with name group",
          pattern: "^(?<user>[a-z0-9._%+-]+)@example\\.com$",
          flags: "gim",
          text:
            "Contact alice@example.com or bob.smith@example.com.\n" +
            "Other domains like test@demo.net should not match.\n" +
            "Usernames: root@example.com, ADMIN@EXAMPLE.COM"
        },
        {
          label: "ISO dates (YYYY-MM-DD)",
          pattern: "\\b(?<year>\\d{4})-(?<month>\\d{2})-(?<day>\\d{2})\\b",
          flags: "g",
          text:
            "Important dates:\n" +
            " - 2023-01-05 Project start\n" +
            " - 2023-12-31 Deadline\n" +
            " - 99-01-01 (should not match)\n"
        },
        {
          label: "Quoted strings",
          pattern: "\"([^\"\\\\]*(?:\\\\.[^\"\\\\]*)*)\"",
          flags: "g",
          text:
            "JSON-ish: {\"name\":\"Ada\",\"quote\":\"We are what we repeatedly do.\"}\n" +
            "This \"simple \\\"quoted\\\" text\" has escapes."
        },
        {
          label: "Lines starting with TODO",
          pattern: "^(?<tag>TODO|FIXME):\\s*(?<body>.+)$",
          flags: "gim",
          text:
            "TODO: wire up regex lab\n" +
            "note: not captured\n" +
            "FIXME: handle invalid patterns\n"
        }
      ];

      function getActiveFlags() {
        const active = flagButtons
          .filter(btn => btn.classList.contains("active"))
          .map(btn => btn.getAttribute("data-flag"));
        active.sort((a, b) => FLAG_ORDER.indexOf(a) - FLAG_ORDER.indexOf(b));
        return active.join("");
      }

      function setActiveFlags(flags) {
        flagButtons.forEach(btn => {
          const f = btn.getAttribute("data-flag");
          btn.classList.toggle("active", flags.includes(f));
        });
      }

      function updateFlagsSummary() {
        const p = patternInput.value || "pattern";
        const f = getActiveFlags() || "g";
        flagsSummary.textContent = `/${p}/${f}`;
      }

      function createRegExp(pattern, flags) {
        try {
          return { regex: new RegExp(pattern, flags), error: null };
        } catch (err) {
          return { regex: null, error: err };
        }
      }

      function htmlEscape(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function computeErrorCaret(message, pattern) {
        if (!pattern) return 0;
        const m1 = message && message.match(/position (\d+)/i);
        if (m1) {
          const idx = parseInt(m1[1], 10);
          if (!isNaN(idx)) return Math.min(Math.max(idx, 0), pattern.length);
        }
        const m2 = message && message.match(/index (\d+)/i);
        if (m2) {
          const idx = parseInt(m2[1], 10);
          if (!isNaN(idx)) return Math.min(Math.max(idx, 0), pattern.length);
        }
        const m3 = message && message.match(/column (\d+)/i);
        if (m3) {
          const idx = parseInt(m3[1], 10) - 1;
          if (!isNaN(idx)) return Math.min(Math.max(idx, 0), pattern.length);
        }
        return pattern.length;
      }

      function showError(err, pattern) {
        if (!err) {
          errorBox.style.display = "none";
          errorBox.textContent = "";
          return;
        }
        const msg = (err && err.message) || String(err);
        const caretPos = computeErrorCaret(msg, pattern || "");
        const safePattern = pattern || "";
        const prefix = safePattern.slice(0, caretPos);
        const caretLine = " ".repeat(prefix.length) + "^";
        errorBox.innerHTML =
          "<strong>Regex error:</strong> " +
          htmlEscape(msg) +
          "\n\n" +
          '<span class="error-line">' +
          htmlEscape("/" + safePattern + "/") +
          "</span>\n" +
          '<span class="error-caret">' +
          htmlEscape(" ".repeat(1) + caretLine) +
          "</span>";
        errorBox.style.display = "block";
      }

      function groupColor(index) {
        const hue = (index * 53 + 120) % 360;
        return `hsl(${hue} 85% 65%)`;
      }

      function buildHighlight(text, regex) {
        if (!text) {
          return '<pre><code class="no-match">Enter some text to test your pattern.</code></pre>';
        }
        if (!regex) {
          return `<pre><code>${htmlEscape(text)}</code></pre>`;
        }

        let lastIndex = 0;
        let out = "<pre><code>";
        let match;
        let count = 0;

        const source = regex.source;
        const flags = regex.flags.includes("g") ? regex.flags : regex.flags + "g";
        const r = new RegExp(source, flags);

        while ((match = r.exec(text)) != null) {
          const start = match.index;
          const end = start + match[0].length;
          if (end === lastIndex) {
            if (r.lastIndex === lastIndex) {
              r.lastIndex++;
            }
          }
          out += htmlEscape(text.slice(lastIndex, start));
          const color = groupColor(count + 1);
          out += `<span class="match" style="background-color:rgba(56,189,248,0.08);box-shadow:0 0 0 1px ${color};color:inherit;">${htmlEscape(match[0] || "")}</span>`;
          lastIndex = end;
          count++;
          if (match[0].length === 0) {
            r.lastIndex++;
          }
        }
        out += htmlEscape(text.slice(lastIndex));
        out += "</code></pre>";
        return out;
      }

      function buildMatchesTable(text, regex) {
        if (!regex || !text) {
          return {
            html: '<div class="no-match">Nothing to display yet.</div>',
            count: 0,
            groupCount: 0
          };
        }
        const source = regex.source;
        const flags = regex.flags.includes("g") ? regex.flags : regex.flags + "g";
        const r = new RegExp(source, flags);
        const rows = [];
        let match;
        let maxGroups = 0;
        let idx = 0;
        const hasNames = !!(typeof r.hasIndices === "boolean"
          ? regex.source
          : (r && r.exec && (function () { const g = r.exec(""); return g && g.groups; })()));

        r.lastIndex = 0;
        while ((match = r.exec(text)) != null) {
          const start = match.index;
          const end = start + match[0].length;
          const groups = Array.prototype.slice.call(match, 1);
          maxGroups = Math.max(maxGroups, groups.length);

          rows.push({
            index: idx,
            start: start,
            end: end,
            text: match[0],
            groups: groups,
            named: match.groups || null
          });
          idx++;
          if (match[0].length === 0) {
            r.lastIndex++;
          }
        }

        if (!rows.length) {
          return {
            html: '<div class="no-match">Pattern compiled, but produced no matches.</div>',
            count: 0,
            groupCount: 0
          };
        }

        let thead = "<thead><tr>";
        thead += "<th>#</th><th>Index</th><th>Length</th><th>Match</th>";
        for (let g = 1; g <= maxGroups; g++) {
          thead += `<th>Group ${g}</th>`;
        }
        if (rows.some(rw => rw.named)) {
          thead += "<th>Named</th>";
        }
        thead += "</tr></thead>";

        let tbody = "<tbody>";
        rows.forEach(rw => {
          tbody += "<tr>";
          tbody += `<td><span class="badge">${rw.index}</span></td>`;
          tbody += `<td>${rw.start}&nbsp;â€“&nbsp;${rw.end}</td>`;
          tbody += `<td>${rw.end - rw.start}</td>`;
          tbody += `<td>${htmlEscape(rw.text)}</td>`;
          for (let g = 0; g < maxGroups; g++) {
            const val = rw.groups[g];
            if (val === undefined) {
              tbody += '<td class="td-muted">â€”</td>';
            } else if (val === null) {
              tbody += '<td class="td-muted">(missing)</td>';
            } else {
              const color = groupColor(g + 1);
              tbody += `<td><span class="group-chip" style="border-color:${color};"><span class="badge" style="background:${color};color:#020617;border-color:${color};">${g + 1}</span><span>${htmlEscape(String(val))}</span></span></td>`;
            }
          }
          if (rows.some(rw2 => rw2.named)) {
            if (rw.named) {
              const names = Object.keys(rw.named)
                .map(k => `${k}: ${rw.named[k]}`)
                .join(", ");
              tbody += `<td>${htmlEscape(names)}</td>`;
            } else {
              tbody += '<td class="td-muted">â€”</td>';
            }
          }
          tbody += "</tr>";
        });
        tbody += "</tbody>";

        const html = `<table>${thead}${tbody}</table>`;
        return { html, count: rows.length, groupCount: maxGroups };
      }

      const TOKEN_EXPLANATIONS = [
        { re: /^\^/, desc: "Beginning of the input or line (in multiline mode)." },
        { re: /\$$/, desc: "End of the input or line (in multiline mode)." },
        { re: /^\.{1}/, desc: "Any character except line breaks (or including them with the s flag)." },
        { re: /^\\d\+?/, desc: "Digit character 0â€“9 (with +, one or more digits)." },
        { re: /^\\d/, desc: "Digit character 0â€“9." },
        { re: /^\\w\+?/, desc: "Word character: letter, digit or underscore (with +, one or more characters)." },
        { re: /^\\w/, desc: "Word character: letter, digit or underscore." },
        { re: /^\\s\+?/, desc: "Whitespace: space, tab, line break, etc. (with +, one or more)." },
        { re: /^\\s/, desc: "Whitespace: space, tab, line break, etc." },
        { re: /^\\b/, desc: "Word boundary: between word and non-word characters." },
        { re: /^\\B/, desc: "Non-word boundary." },
        { re: /^\\D/, desc: "Any character that is not a digit." },
        { re: /^\\S/, desc: "Any character that is not whitespace." },
        { re: /^\\W/, desc: "Any character that is not a word character." },
        { re: /^\[.*?]/, desc: "Character class: matches any one of the characters in brackets." },
        { re: /^\[[^]]*-\s*[^]]*]/, desc: "Character class range, e.g. [A-Z] or [0-9]." },
        { re: /^\(\?:/, desc: "Non-capturing group: groups tokens without saving a capture." },
        { re: /^\(\?=.+?\)/, desc: "Positive lookahead: asserts that what follows matches the pattern." },
        { re: /^\(\?!.+?\)/, desc: "Negative lookahead: asserts that what follows does NOT match the pattern." },
        { re: /^\(\?<[^>]+>/, desc: "Named capturing group; its value can be referenced by name." },
        { re: /^\(/, desc: "Capturing group: remembers the matched substring for later use." },
        { re: /^\\[1-9][0-9]*/, desc: "Backreference: reuses the text matched by a capturing group." },
        { re: /^\|\|?/, desc: "Alternation: match the expression on the left OR the right." },
        { re: /^\*\?/, desc: "Lazy zero-or-more quantifier." },
        { re: /^\+?/, desc: "Lazy one-or-more quantifier (if followed by ?)." },
        { re: /^\{(\d+,\d*|\d+)\}\??/, desc: "Bounded quantifier: repeat the previous token a specific number of times." },
        { re: /^\*/, desc: "Zero or more of the previous token." },
        { re: /^\+/, desc: "One or more of the previous token." },
        { re: /^\?/, desc: "Zero or one of the previous token, or makes a quantifier lazy." },
        { re: /^\\./, desc: "Escaped literal character." }
      ];

      function explainPattern(pattern) {
        pattern = pattern || "";
        if (!pattern) {
          return {
            html:
              '<div class="no-match">Start typing a regex and we will highlight familiar building blocks such as character classes, anchors, groups, and quantifiers.</div>',
            count: 0
          };
        }
        const explanations = [];
        let i = 0;
        const seenTokens = new Set();

        while (i < pattern.length) {
          let substr = pattern.slice(i);
          let matched = false;
          for (let j = 0; j < TOKEN_EXPLANATIONS.length; j++) {
            const entry = TOKEN_EXPLANATIONS[j];
            const m = substr.match(entry.re);
            if (m && m.index === 0) {
              const token = m[0];
              const key = token + "::" + entry.desc;
              if (!seenTokens.has(key)) {
                explanations.push({ token, desc: entry.desc });
                seenTokens.add(key);
              }
              i += token.length;
              matched = true;
              break;
            }
          }
          if (!matched) {
            i++;
          }
        }

        if (!explanations.length) {
          return {
            html:
              '<div class="no-match">Pattern is valid, but uses constructs this helper does not recognize individually. It will still work in the matcher above.</div>',
            count: 0
          };
        }

        let html = '<ul class="explain-list">';
        explanations.forEach(item => {
          html += `<li class="explain-item"><div class="ex-token">${htmlEscape(
            item.token
          )}</div><div class="ex-desc">${htmlEscape(item.desc)}</div></li>`;
        });
        html += "</ul>";
        return { html, count: explanations.length };
      }

      function updateFromInputs() {
        const pattern = patternInput.value;
        const text = textInput.value;
        const flags = getActiveFlags();

        updateFlagsSummary();

        if (!pattern) {
          showError(null);
          highlightPane.innerHTML =
            '<pre><code class="no-match">Enter a pattern and some text to see matches.</code></pre>';
          tablePane.innerHTML = '<div class="no-match">No matches yet.</div>';
          explainPane.innerHTML =
            '<div class="no-match">Start typing a regex and we will highlight familiar building blocks such as character classes, anchors, groups, and quantifiers.</div>';
          rangeSummary.textContent = "No pattern yet";
          tableMeta.textContent = "0 matches";
          explainMeta.textContent = "Common tokens recognized automatically.";
          groupLegend.innerHTML = "";
          matchCountEl.textContent = "0";
          return;
        }

        const { regex, error } = createRegExp(pattern, flags);

        if (error || !regex) {
          showError(error, pattern);
          highlightPane.innerHTML =
            `<pre><code>${htmlEscape(text || "")}</code></pre>`;
          tablePane.innerHTML =
            '<div class="no-match">Cannot list matches until the pattern is valid.</div>';
          const exp = explainPattern(pattern);
          explainPane.innerHTML = exp.html;
          explainMeta.textContent = exp.count
            ? `${exp.count} token${exp.count === 1 ? "" : "s"} recognized before the error.`
            : "Tokens recognized before the error.";
          tableMeta.textContent = "0 matches";
          rangeSummary.textContent = "Invalid pattern";
          matchCountEl.textContent = "0";
          groupLegend.innerHTML = "";
          return;
        }

        showError(null);

        const highlightHTML = buildHighlight(text, regex);
        highlightPane.innerHTML = highlightHTML;

        const { html: tableHTML, count, groupCount } = buildMatchesTable(
          text,
          regex
        );
        tablePane.innerHTML = tableHTML;
        matchCountEl.textContent = String(count);
        if (!text) {
          rangeSummary.textContent = "Awaiting test textâ€¦";
        } else if (!count) {
          rangeSummary.textContent = "0 matches.";
        } else {
          const s = count === 1 ? "" : "es";
          rangeSummary.textContent = `${count} match${s} across ${text.length} characters.`;
        }
        tableMeta.textContent = `${count} match${count === 1 ? "" : "es"}, ${groupCount} capture group${groupCount === 1 ? "" : "s"}.`;

        const exp = explainPattern(pattern);
        explainPane.innerHTML = exp.html;
        if (exp.count) {
          explainMeta.textContent = `${exp.count} token${exp.count === 1 ? "" : "s"} recognized in the pattern.`;
        } else {
          explainMeta.textContent =
            "Pattern is valid but uses constructs not covered by this helper.";
        }

        if (groupCount > 0) {
          let legendHTML = "";
          for (let i = 1; i <= groupCount; i++) {
            const color = groupColor(i);
            legendHTML += `<span class="legend-item"><span class="legend-swatch" style="background:${color};"></span>Group&nbsp;${i}</span>`;
          }
          groupLegend.innerHTML = legendHTML;
        } else {
          groupLegend.innerHTML = "";
        }
      }

      function debounce(fn, delay) {
        let t;
        return function () {
          const args = arguments;
          clearTimeout(t);
          t = setTimeout(function () {
            fn.apply(null, args);
          }, delay);
        };
      }

      const debouncedUpdate = debounce(updateFromInputs, 80);

      flagButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          btn.classList.toggle("active");
          debouncedUpdate();
        });
      });

      patternInput.addEventListener("input", debouncedUpdate);
      textInput.addEventListener("input", debouncedUpdate);

      d.querySelectorAll(".chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const insert = chip.getAttribute("data-insert") || "";
          const el = patternInput;
          const start = el.selectionStart != null ? el.selectionStart : el.value.length;
          const end = el.selectionEnd != null ? el.selectionEnd : el.value.length;
          const before = el.value.slice(0, start);
          const after = el.value.slice(end);
          el.value = before + insert + after;
          const newPos = before.length + insert.length;
          requestAnimationFrame(() => {
            el.focus();
            try {
              el.setSelectionRange(newPos, newPos);
            } catch (_) { }
          });
          debouncedUpdate();
        });
      });

      clearBtn.addEventListener("click", () => {
        patternInput.value = "";
        textInput.value = "";
        setActiveFlags("g");
        updateFromInputs();
      });

      examplesBtn.addEventListener("click", () => {
        let nextIndex = 0;
        try {
          const current = patternInput.value;
          const idx = EXAMPLES.findIndex(e => e.pattern === current);
          nextIndex = (idx + 1) % EXAMPLES.length;
        } catch (_) {
          nextIndex = 0;
        }
        const ex = EXAMPLES[nextIndex];
        patternInput.value = ex.pattern;
        textInput.value = ex.text;
        setActiveFlags(ex.flags);
        updateFromInputs();
      });

      function encodeStateToHash() {
        const p = encodeURIComponent(patternInput.value || "");
        const f = encodeURIComponent(getActiveFlags());
        const t = encodeURIComponent(textInput.value || "");
        return `#p=${p}&f=${f}&t=${t}`;
      }

      function parseHash() {
        const hash = window.location.hash.replace(/^#/, "");
        if (!hash) return null;
        const params = {};
        hash.split("&").forEach(part => {
          const [k, v] = part.split("=");
          if (!k) return;
          try {
            params[k] = decodeURIComponent(v || "");
          } catch (_) {
            params[k] = v || "";
          }
        });
        if (!("p" in params) && !("f" in params) && !("t" in params)) {
          return null;
        }
        return {
          pattern: params.p || "",
          flags: params.f || "g",
          text: params.t || ""
        };
      }

      shareBtn.addEventListener("click", () => {
        const hash = encodeStateToHash();
        const url = window.location.origin + window.location.pathname + hash;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(
            () => {
              shareBtn.textContent = "Copied!";
              setTimeout(() => {
                shareBtn.innerHTML =
                  '<span class="btn-icon">ðŸ”—</span>Copy permalink';
              }, 1200);
            },
            () => {
              window.prompt("Copy permalink:", url);
            }
          );
        } else {
          window.prompt("Copy permalink:", url);
        }
      });

      function applyTheme(theme) {
        const html = d.documentElement;
        html.setAttribute("data-theme", theme);
        try {
          localStorage.setItem("regex-lab-theme", theme);
        } catch (_) { }
        const icon = themeToggle.querySelector(".icon");
        const label = themeToggle.querySelector("span:nth-child(2)");
        if (theme === "light") {
          if (icon) icon.textContent = "â˜€ï¸";
          if (label) label.textContent = "Light mode";
        } else {
          if (icon) icon.textContent = "ðŸŒ™";
          if (label) label.textContent = "Dark mode";
        }
      }

      themeToggle.addEventListener("click", () => {
        const current = d.documentElement.getAttribute("data-theme") || "dark";
        const next = current === "dark" ? "light" : "dark";
        applyTheme(next);
      });

      (function initTheme() {
        let stored = null;
        try {
          stored = localStorage.getItem("regex-lab-theme");
        } catch (_) { }
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        const theme = stored || (prefersDark ? "dark" : "dark");
        applyTheme(theme);
      })();

      function initFromHash() {
        const state = parseHash();
        if (!state) {
          patternInput.value = "";
          textInput.value =
            "The quick brown fox jumps over 13 lazy dogs.\n" +
            "Emails like alice@example.com and root@demo.net.\n" +
            "Dates: 2023-01-05, 1999-12-31.\n";
          setActiveFlags("g");
          updateFromInputs();
          return;
        }
        patternInput.value = state.pattern || "";
        textInput.value = state.text || "";
        setActiveFlags(state.flags || "g");
        updateFromInputs();
      }

      window.addEventListener("hashchange", () => {
        const state = parseHash();
        if (!state) return;
        patternInput.value = state.pattern || "";
        textInput.value = state.text || "";
        setActiveFlags(state.flags || "g");
        updateFromInputs();
      });

      initFromHash();
    })();
  </script>
</body>
</html>

