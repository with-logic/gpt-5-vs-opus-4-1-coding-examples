<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cloud Painter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Cloud Painter â€“ a soft, whimsical sky painting app for kids. Draw fluffy clouds, watch them drift, and let airplanes glide through your custom sky."
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;600&family=Quicksand:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-gradient-top: #79c7f7;
        --bg-gradient-bottom: #ffe8ff;
        --panel-bg: rgba(255, 255, 255, 0.92);
        --panel-border: rgba(255, 255, 255, 0.9);
        --accent: #ff9cc9;
        --accent-soft: #ffe1f0;
        --accent-strong: #ff6fa9;
        --text-main: #2c3a4f;
        --text-soft: #6c7a92;
        --sky-border: rgba(255, 255, 255, 0.65);
        --shadow-soft: 0 18px 45px rgba(65, 80, 120, 0.25);
        --radius-lg: 26px;
        --radius-md: 18px;
        --transition-fast: 150ms ease-out;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      body {
        font-family: "Quicksand", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text-main);
        background: radial-gradient(circle at top left, #fdf5ff 0, #e4f4ff 32%, #bedfff 70%, #8cc4ff 100%);
        display: flex;
        align-items: stretch;
        justify-content: center;
        -webkit-font-smoothing: antialiased;
      }

      .app-shell {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 1120px;
        margin: 10px auto;
        padding: 14px 14px 16px;
        border-radius: 26px;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.96), rgba(255, 250, 255, 0.96));
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(255, 255, 255, 0.9);
        position: relative;
        overflow: hidden;
      }

      .app-shell::before {
        content: "";
        position: absolute;
        inset: -120px;
        background-image: radial-gradient(circle at 0% 0%, rgba(255, 210, 252, 0.7), transparent 60%),
          radial-gradient(circle at 100% 0%, rgba(199, 231, 255, 0.9), transparent 60%),
          radial-gradient(circle at 50% 120%, rgba(255, 241, 213, 0.9), transparent 60%);
        opacity: 0.35;
        pointer-events: none;
        z-index: -1;
      }

      .app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px 8px 10px;
        gap: 12px;
      }

      .title-group {
        display: flex;
        align-items: baseline;
        gap: 10px;
      }

      .app-title {
        font-family: "Baloo 2", cursive;
        font-size: 1.9rem;
        letter-spacing: 0.03em;
        color: #26435b;
        text-shadow: 0 3px 0 rgba(255, 255, 255, 0.7);
      }

      .app-subtitle {
        font-size: 0.95rem;
        color: var(--text-soft);
      }

      .header-badge {
        padding: 6px 12px;
        border-radius: 999px;
        background: linear-gradient(120deg, rgba(255, 198, 224, 0.9), rgba(255, 232, 214, 0.95));
        border: 1px solid rgba(255, 255, 255, 0.9);
        font-size: 0.8rem;
        color: #5b3045;
        box-shadow: 0 10px 24px rgba(255, 155, 205, 0.35);
        white-space: nowrap;
      }

      .app-main {
        display: grid;
        grid-template-columns: minmax(250px, 290px) minmax(0, 1fr);
        gap: 14px;
        padding: 8px 4px 0;
        min-height: 0;
        flex: 1;
      }

      .control-panel {
        background: var(--panel-bg);
        border-radius: var(--radius-lg);
        padding: 14px 14px 12px;
        border: 1px solid var(--panel-border);
        backdrop-filter: blur(16px);
        box-shadow: 0 10px 30px rgba(150, 170, 210, 0.35);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .control-section {
        padding: 7px 8px 8px;
        border-radius: var(--radius-md);
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(245, 245, 255, 0.98));
        border: 1px solid rgba(255, 255, 255, 0.95);
        position: relative;
        overflow: hidden;
      }

      .control-section::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at top left, rgba(255, 214, 244, 0.6), transparent 55%);
        opacity: 0;
        transition: opacity var(--transition-fast);
        pointer-events: none;
      }

      .control-section:hover::before {
        opacity: 1;
      }

      .control-title {
        font-size: 0.8rem;
        letter-spacing: 0.11em;
        text-transform: uppercase;
        color: var(--text-soft);
        margin-bottom: 6px;
      }

      .brush-list {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .brush-button {
        flex: 1 1 30%;
        min-width: 0;
        padding: 8px 6px;
        border-radius: 999px;
        border: 1px solid rgba(200, 210, 240, 0.9);
        background: linear-gradient(145deg, #fdfbff, #f3f0ff);
        color: var(--text-main);
        font-size: 0.78rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        cursor: pointer;
        transition: background var(--transition-fast), transform var(--transition-fast),
          box-shadow var(--transition-fast), border-color var(--transition-fast);
        box-shadow: 0 6px 14px rgba(145, 168, 210, 0.25);
      }

      .brush-swatch {
        width: 16px;
        height: 12px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #ffffff, #f2f7ff);
        box-shadow: 0 0 0 1px rgba(226, 233, 255, 0.9), 0 0 0 4px rgba(195, 215, 255, 0.55);
      }

      .brush-button[data-brush="puffy"] .brush-swatch {
        background: radial-gradient(circle at 20% 30%, #ffffff, #f7f6ff);
        box-shadow: 0 0 0 1px rgba(230, 220, 255, 0.9), 0 0 0 4px rgba(214, 201, 255, 0.6);
      }

      .brush-button[data-brush="wispy"] .brush-swatch {
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.9), rgba(240, 249, 255, 0.3));
        box-shadow: 0 0 0 1px rgba(214, 235, 255, 0.9), 0 0 0 4px rgba(183, 227, 255, 0.6);
      }

      .brush-button span.label {
        white-space: nowrap;
      }

      .brush-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 22px rgba(145, 168, 210, 0.4);
      }

      .brush-button.active {
        background: linear-gradient(140deg, #ffe8f5, #ffeefb);
        border-color: var(--accent-strong);
        color: #662842;
        box-shadow: 0 12px 26px rgba(240, 157, 206, 0.7);
      }

      .brush-button.active .brush-swatch {
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.95), 0 0 0 5px rgba(255, 184, 223, 0.85);
      }

      .slider-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .slider-label {
        font-size: 0.8rem;
        color: var(--text-soft);
        flex: 0 0 auto;
      }

      .slider-value {
        font-size: 0.8rem;
        color: var(--text-main);
        min-width: 2.5rem;
        text-align: right;
        flex: 0 0 auto;
      }

      .slider-track {
        flex: 1 1 auto;
      }

      input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 7px;
        border-radius: 999px;
        background: linear-gradient(90deg, #ffe6f4, #ffdce3, #f2f4ff);
        outline: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #ffffff, #ffe4f4);
        border: 1px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 4px 10px rgba(180, 110, 160, 0.45);
        cursor: pointer;
        margin-top: -5px;
      }

      input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #ffffff, #ffe4f4);
        border: 1px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 4px 10px rgba(180, 110, 160, 0.45);
        cursor: pointer;
      }

      input[type="range"]::-moz-range-track {
        height: 7px;
        border-radius: 999px;
        background: linear-gradient(90deg, #ffe6f4, #ffdce3, #f2f4ff);
      }

      .toggle-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        color: var(--text-soft);
        cursor: pointer;
      }

      .toggle input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }

      .toggle-track {
        position: relative;
        width: 32px;
        height: 18px;
        border-radius: 999px;
        background: linear-gradient(135deg, #e1e7ff, #fde8ff);
        box-shadow: inset 0 0 0 1px rgba(200, 210, 240, 0.9);
        flex: 0 0 auto;
      }

      .toggle-thumb {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 14px;
        height: 14px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #ffffff, #ffe2f2);
        box-shadow: 0 3px 8px rgba(145, 120, 175, 0.55);
        transition: transform var(--transition-fast);
      }

      .toggle input:checked + .toggle-track .toggle-thumb {
        transform: translateX(14px);
      }

      .toggle-label-text {
        flex: 1 1 auto;
      }

      .hint-text {
        margin-top: 6px;
        font-size: 0.76rem;
        color: var(--text-soft);
      }

      .action-row {
        display: flex;
        gap: 6px;
        margin-top: 2px;
      }

      .primary-button,
      .ghost-button {
        flex: 1 1 0;
        padding: 9px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        font-size: 0.82rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: transform 130ms ease-out, box-shadow 130ms ease-out, background 130ms ease-out,
          border-color 130ms ease-out, color 130ms ease-out;
        user-select: none;
        white-space: nowrap;
      }

      .primary-button {
        background: linear-gradient(135deg, var(--accent), var(--accent-strong));
        color: white;
        box-shadow: 0 11px 26px rgba(255, 138, 191, 0.8);
      }

      .primary-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 32px rgba(255, 138, 191, 0.9);
      }

      .primary-button:active {
        transform: translateY(0);
        box-shadow: 0 9px 20px rgba(240, 124, 180, 0.8);
      }

      .ghost-button {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(247, 247, 255, 0.98));
        color: var(--text-main);
        border-color: rgba(215, 220, 245, 0.98);
        box-shadow: 0 6px 16px rgba(175, 188, 220, 0.55);
      }

      .ghost-button:hover {
        transform: translateY(-1px);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(247, 247, 255, 1));
        box-shadow: 0 11px 24px rgba(165, 180, 220, 0.75);
      }

      .ghost-button:active {
        transform: translateY(0);
        box-shadow: 0 7px 18px rgba(150, 170, 215, 0.7);
      }

      .button-icon {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.9);
        background: radial-gradient(circle at 30% 30%, #ffffff, #ffeef7);
        box-shadow: 0 0 0 3px rgba(255, 208, 235, 0.75);
      }

      .button-icon.plane {
        border-radius: 6px;
        box-shadow: 0 0 0 3px rgba(203, 228, 255, 0.9);
        background: linear-gradient(130deg, #fdfdff, #e0f1ff);
      }

      .canvas-panel {
        border-radius: var(--radius-lg);
        background: radial-gradient(circle at top, rgba(255, 255, 255, 0.9), rgba(233, 244, 255, 0.95));
        border: 1px solid rgba(255, 255, 255, 0.95);
        box-shadow: 0 12px 40px rgba(144, 167, 213, 0.55);
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 0;
      }

      .canvas-header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .canvas-title {
        font-size: 0.86rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-soft);
      }

      .mini-legend {
        font-size: 0.78rem;
        color: var(--text-soft);
      }

      .mini-key {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-left: 10px;
      }

      .mini-key-cloud {
        width: 14px;
        height: 10px;
        border-radius: 999px;
        background: radial-gradient(circle at 25% 30%, #ffffff, #f2f7ff);
        box-shadow: 0 0 0 1px rgba(209, 225, 255, 0.9);
      }

      .mini-key-plane {
        width: 14px;
        height: 10px;
        border-radius: 4px;
        background: linear-gradient(120deg, #fdfdff, #dff0ff);
        box-shadow: 0 0 0 1px rgba(186, 214, 255, 0.9);
      }

      .sky-frame {
        position: relative;
        flex: 1 1 auto;
        border-radius: 22px;
        overflow: hidden;
        background: linear-gradient(to bottom, var(--bg-gradient-top), var(--bg-gradient-bottom));
        border: 1px solid var(--sky-border);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
        min-height: 260px;
      }

      canvas#cloudCanvas {
        width: 100%;
        height: 100%;
        display: block;
        cursor: crosshair;
        touch-action: none;
      }

      .hint-overlay {
        position: absolute;
        left: 50%;
        top: 18px;
        transform: translateX(-50%);
        padding: 7px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.96);
        border: 1px solid rgba(255, 255, 255, 0.95);
        box-shadow: 0 14px 30px rgba(146, 165, 209, 0.55);
        font-size: 0.78rem;
        color: var(--text-soft);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        pointer-events: none;
        opacity: 1;
        transition: opacity 220ms ease-out, transform 220ms ease-out;
      }

      .hint-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #ffffff, #ffeef8);
        box-shadow: 0 0 0 4px rgba(255, 206, 230, 0.85);
      }

      .hint-overlay.hidden {
        opacity: 0;
        transform: translate(-50%, -6px);
      }

      .footer-row {
        margin-top: 8px;
        font-size: 0.76rem;
        color: var(--text-soft);
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }

      .footer-row span {
        white-space: nowrap;
      }

      .footer-row span strong {
        font-weight: 600;
        color: var(--text-main);
      }

      @media (max-width: 880px) {
        .app-shell {
          margin: 0;
          border-radius: 0;
          box-shadow: none;
        }
      }

      @media (max-width: 780px) {
        .app-main {
          grid-template-columns: minmax(0, 1fr);
        }

        .canvas-panel {
          order: -1;
        }
      }

      @media (max-width: 520px) {
        .app-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
        }

        .title-group {
          flex-direction: column;
          align-items: flex-start;
          gap: 2px;
        }

        .app-title {
          font-size: 1.7rem;
        }

        .header-badge {
          align-self: flex-start;
        }

        .control-panel {
          padding: 12px 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="app-header">
        <div class="title-group">
          <h1 class="app-title">Cloud Painter</h1>
          <p class="app-subtitle">Draw your own dreamy sky.</p>
        </div>
        <div class="header-badge">Made for gentle little artists</div>
      </header>
      <main class="app-main">
        <aside class="control-panel" aria-label="Cloud Painter controls">
          <section class="control-section" aria-label="Brush shapes">
            <h2 class="control-title">Cloud brush</h2>
            <div class="brush-list" role="radiogroup" aria-label="Choose brush shape">
              <button
                class="brush-button active"
                type="button"
                data-brush="fluffy"
                aria-pressed="true"
                aria-label="Fluffy cotton clouds"
              >
                <span class="brush-swatch" aria-hidden="true"></span>
                <span class="label">Fluffy</span>
              </button>
              <button
                class="brush-button"
                type="button"
                data-brush="puffy"
                aria-pressed="false"
                aria-label="Round puffy clouds"
              >
                <span class="brush-swatch" aria-hidden="true"></span>
                <span class="label">Puffy</span>
              </button>
              <button
                class="brush-button"
                type="button"
                data-brush="wispy"
                aria-pressed="false"
                aria-label="Soft wispy streaks"
              >
                <span class="brush-swatch" aria-hidden="true"></span>
                <span class="label">Wispy</span>
              </button>
            </div>
          </section>

          <section class="control-section" aria-label="Brush size">
            <h2 class="control-title">Brush size</h2>
            <div class="slider-row">
              <div class="slider-label">Cloud scale</div>
              <div class="slider-track">
                <input
                  type="range"
                  id="sizeSlider"
                  min="20"
                  max="160"
                  value="80"
                  aria-label="Cloud brush size"
                />
              </div>
              <div class="slider-value">
                <span id="sizeValue">Medium</span>
              </div>
            </div>
          </section>

          <section class="control-section" aria-label="Sky animation">
            <h2 class="control-title">Sky motion</h2>
            <div class="toggle-list">
              <label class="toggle">
                <input type="checkbox" id="driftToggle" checked />
                <span class="toggle-track">
                  <span class="toggle-thumb"></span>
                </span>
                <span class="toggle-label-text">Gentle cloud drift</span>
              </label>
              <label class="toggle">
                <input type="checkbox" id="autoPlanesToggle" checked />
                <span class="toggle-track">
                  <span class="toggle-thumb"></span>
                </span>
                <span class="toggle-label-text">Friendly airplanes from time to time</span>
              </label>
            </div>
            <p class="hint-text">Turn these off for a quiet, still sky.</p>
          </section>

          <section class="control-section" aria-label="Actions">
            <h2 class="control-title">Sky actions</h2>
            <div class="action-row">
              <button class="primary-button" type="button" id="saveButton">
                <span class="button-icon" aria-hidden="true"></span>
                <span>Save sky</span>
              </button>
              <button class="ghost-button" type="button" id="clearButton">
                <span>Clear</span>
              </button>
            </div>
            <div class="action-row" style="margin-top: 6px">
              <button class="ghost-button" type="button" id="planeButton">
                <span class="button-icon plane" aria-hidden="true"></span>
                <span>Add airplane</span>
              </button>
            </div>
            <p class="hint-text">Tip: Use big fluffy brushes for soft clouds, then add slender wisps on top.</p>
          </section>
        </aside>

        <section class="canvas-panel" aria-label="Drawing area">
          <div class="canvas-header-row">
            <div class="canvas-title">Sky canvas</div>
            <div class="mini-legend">
              <span class="mini-key">
                <span class="mini-key-cloud" aria-hidden="true"></span>
                clouds
              </span>
              <span class="mini-key">
                <span class="mini-key-plane" aria-hidden="true"></span>
                airplanes
              </span>
            </div>
          </div>
          <div class="sky-frame">
            <canvas id="cloudCanvas" aria-label="Paintable sky canvas"></canvas>
            <div class="hint-overlay" id="hintOverlay">
              <span class="hint-dot" aria-hidden="true"></span>
              Hold and drag inside the sky to paint clouds.
            </div>
          </div>
          <div class="footer-row">
            <span><strong>Cloud Painter</strong> keeps everything inside this one page.</span>
            <span>Saving downloads a picture of your sky.</span>
          </div>
        </section>
      </main>
    </div>

    <script>
      (function () {
        const canvas = document.getElementById("cloudCanvas");
        const ctx = canvas.getContext("2d");

        const brushButtons = document.querySelectorAll(".brush-button");
        const sizeSlider = document.getElementById("sizeSlider");
        const sizeValue = document.getElementById("sizeValue");
        const driftToggle = document.getElementById("driftToggle");
        const autoPlanesToggle = document.getElementById("autoPlanesToggle");
        const saveButton = document.getElementById("saveButton");
        const clearButton = document.getElementById("clearButton");
        const planeButton = document.getElementById("planeButton");
        const hintOverlay = document.getElementById("hintOverlay");

        let activeBrush = "fluffy";
        let brushSize = parseInt(sizeSlider.value, 10);
        let driftEnabled = driftToggle.checked;
        let autoPlanesEnabled = autoPlanesToggle.checked;

        let canvasCssWidth = 0;
        let canvasCssHeight = 0;

        const clouds = [];
        const airplanes = [];

        let isDrawing = false;
        let pointerId = null;

        let lastTimestamp = 0;
        let planeSpawnTimer = 0;

        function updateSizeLabel() {
          const value = brushSize;
          let label = "Small";
          if (value > 120) {
            label = "Giant";
          } else if (value > 90) {
            label = "Big";
          } else if (value > 55) {
            label = "Medium";
          } else if (value > 30) {
            label = "Little";
          }
          sizeValue.textContent = label;
        }

        updateSizeLabel();

        function resizeCanvas() {
          const rect = canvas.getBoundingClientRect();
          canvasCssWidth = rect.width || 1;
          canvasCssHeight = rect.height || 1;
          const dpr = window.devicePixelRatio || 1;
          canvas.width = canvasCssWidth * dpr;
          canvas.height = canvasCssHeight * dpr;
        }

        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        brushButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const brush = button.getAttribute("data-brush");
            activeBrush = brush;
            brushButtons.forEach((b) => {
              const isActive = b === button;
              b.classList.toggle("active", isActive);
              b.setAttribute("aria-pressed", String(isActive));
            });
          });
        });

        sizeSlider.addEventListener("input", () => {
          brushSize = parseInt(sizeSlider.value, 10);
          updateSizeLabel();
        });

        driftToggle.addEventListener("change", () => {
          driftEnabled = driftToggle.checked;
        });

        autoPlanesToggle.addEventListener("change", () => {
          autoPlanesEnabled = autoPlanesToggle.checked;
        });

        function hideHintOverlay() {
          if (hintOverlay && !hintOverlay.classList.contains("hidden")) {
            hintOverlay.classList.add("hidden");
          }
        }

        function canvasToNormalized(clientX, clientY) {
          const rect = canvas.getBoundingClientRect();
          const nx = (clientX - rect.left) / rect.width;
          const ny = (clientY - rect.top) / rect.height;
          return {
            x: Math.min(1, Math.max(0, nx)),
            y: Math.min(1, Math.max(0, ny)),
          };
        }

        function addCloudParticle(nx, ny, fromDrag) {
          const type = activeBrush;
          const sizeBase = brushSize;
          const sizeRandom = sizeBase * (0.85 + Math.random() * 0.35);
          const opacityBase = fromDrag ? 0.82 : 0.9;

          const driftBase = type === "wispy" ? 0.04 : type === "puffy" ? 0.02 : 0.03;
          const drift = driftBase * (0.7 + Math.random() * 0.7);
          const bobAmount = 0.003 + Math.random() * 0.004;

          clouds.push({
            x: nx,
            y: ny,
            type,
            size: sizeRandom,
            opacity: opacityBase,
            drift,
            bobAmount,
            phase: Math.random() * Math.PI * 2,
          });

          if (clouds.length > 2500) {
            clouds.splice(0, clouds.length - 2500);
          }
        }

        function handlePointerDown(event) {
          event.preventDefault();
          hideHintOverlay();
          canvas.setPointerCapture(event.pointerId);
          isDrawing = true;
          pointerId = event.pointerId;
          const pos = canvasToNormalized(event.clientX, event.clientY);
          addCloudParticle(pos.x, pos.y, false);
        }

        function handlePointerMove(event) {
          if (!isDrawing || event.pointerId !== pointerId) return;
          event.preventDefault();
          const pos = canvasToNormalized(event.clientX, event.clientY);
          addCloudParticle(pos.x, pos.y, true);
        }

        function stopDrawing(event) {
          if (event && event.pointerId !== pointerId) return;
          isDrawing = false;
          pointerId = null;
        }

        canvas.addEventListener("pointerdown", handlePointerDown);
        canvas.addEventListener("pointermove", handlePointerMove);
        canvas.addEventListener("pointerup", stopDrawing);
        canvas.addEventListener("pointercancel", stopDrawing);
        canvas.addEventListener("pointerleave", stopDrawing);

        function addAirplane(randomStart) {
          const direction = Math.random() > 0.5 ? 1 : -1;
          const speed = 0.06 + Math.random() * 0.04;
          const y = 0.18 + Math.random() * 0.4;
          const size = 18 + Math.random() * 9;

          let x;
          if (randomStart) {
            x = Math.random();
          } else {
            x = direction === 1 ? -0.16 : 1.16;
          }

          airplanes.push({
            x,
            y,
            speed,
            direction,
            size,
            bobPhase: Math.random() * Math.PI * 2,
          });

          if (airplanes.length > 14) {
            airplanes.splice(0, airplanes.length - 14);
          }
        }

        planeButton.addEventListener("click", () => {
          addAirplane(false);
          hideHintOverlay();
        });

        function clearSky() {
          clouds.length = 0;
          airplanes.length = 0;
        }

        clearButton.addEventListener("click", () => {
          clearSky();
        });

        function saveSky() {
          try {
            const dataUrl = canvas.toDataURL("image/png");
            const link = document.createElement("a");
            const timestamp = new Date()
              .toISOString()
              .replaceAll(":", "-")
              .replaceAll(".", "-");
            link.download = "cloud-painter-sky-" + timestamp + ".png";
            link.href = dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } catch (error) {
            console.error("Unable to save image", error);
          }
        }

        saveButton.addEventListener("click", saveSky);

        function drawSkyBackground() {
          const dpr = window.devicePixelRatio || 1;
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
          const width = canvasCssWidth;
          const height = canvasCssHeight;

          const gradient = ctx.createLinearGradient(0, 0, 0, height);
          gradient.addColorStop(0, "#79c7f7");
          gradient.addColorStop(0.45, "#a9ddff");
          gradient.addColorStop(0.75, "#ffeaf5");
          gradient.addColorStop(1, "#ffe8ff");
          ctx.fillStyle = gradient;
          ctx.fillRect(0, 0, width, height);

          const sunX = width * 0.18;
          const sunY = height * 0.18;
          const sunRadius = Math.min(width, height) * 0.09;
          const sunGradient = ctx.createRadialGradient(sunX, sunY, sunRadius * 0.1, sunX, sunY, sunRadius);
          sunGradient.addColorStop(0, "rgba(255,255,255,0.98)");
          sunGradient.addColorStop(0.4, "rgba(255,250,219,0.9)");
          sunGradient.addColorStop(1, "rgba(255,250,219,0)");
          ctx.fillStyle = sunGradient;
          ctx.beginPath();
          ctx.arc(sunX, sunY, sunRadius, 0, Math.PI * 2);
          ctx.fill();

          const hazeGradient = ctx.createLinearGradient(0, height * 0.5, 0, height);
          hazeGradient.addColorStop(0, "rgba(255,255,255,0.12)");
          hazeGradient.addColorStop(0.7, "rgba(255,255,255,0.24)");
          hazeGradient.addColorStop(1, "rgba(255,255,255,0.4)");
          ctx.fillStyle = hazeGradient;
          ctx.fillRect(0, height * 0.5, width, height * 0.5);
        }

        function drawFluffyCloud(x, y, size, opacity) {
          ctx.save();
          ctx.globalAlpha = opacity;
          const puffs = [
            { dx: -0.4, dy: 0.05, rx: 0.6, ry: 0.5 },
            { dx: -0.1, dy: -0.1, rx: 0.7, ry: 0.55 },
            { dx: 0.25, dy: -0.05, rx: 0.55, ry: 0.48 },
            { dx: 0.5, dy: 0.05, rx: 0.4, ry: 0.45 },
            { dx: 0.1, dy: 0.18, rx: 0.7, ry: 0.45 },
          ];
          ctx.fillStyle = "rgba(255,255,255,0.96)";
          puffs.forEach((p) => {
            ctx.beginPath();
            ctx.ellipse(x + p.dx * size, y + p.dy * size, size * p.rx, size * p.ry, 0, 0, Math.PI * 2);
            ctx.fill();
          });
          ctx.restore();
        }

        function drawPuffyCloud(x, y, size, opacity) {
          ctx.save();
          ctx.globalAlpha = opacity;
          const baseWidth = size * 1.8;
          const baseHeight = size * 0.7;
          const baseGradient = ctx.createLinearGradient(x - baseWidth / 2, y, x + baseWidth / 2, y);
          baseGradient.addColorStop(0, "rgba(255,255,255,0.92)");
          baseGradient.addColorStop(1, "rgba(246,242,255,0.96)");
          ctx.fillStyle = baseGradient;
          ctx.beginPath();
          ctx.ellipse(x, y + size * 0.1, baseWidth / 2, baseHeight / 2, 0, 0, Math.PI * 2);
          ctx.fill();

          const caps = [
            { dx: -0.56, dy: -0.15, r: 0.55 },
            { dx: -0.15, dy: -0.3, r: 0.76 },
            { dx: 0.35, dy: -0.2, r: 0.64 },
            { dx: 0.82, dy: -0.08, r: 0.44 },
          ];
          ctx.fillStyle = "rgba(255,255,255,0.97)";
          caps.forEach((c) => {
            ctx.beginPath();
            ctx.ellipse(x + c.dx * size, y + c.dy * size, size * c.r, size * c.r * 0.9, 0, 0, Math.PI * 2);
            ctx.fill();
          });
          ctx.restore();
        }

        function drawWispyCloud(x, y, size, opacity) {
          ctx.save();
          ctx.globalAlpha = opacity;
          const length = size * 2.6;
          const height = size * 0.55;
          const gradient = ctx.createLinearGradient(x - length / 2, y, x + length / 2, y);
          gradient.addColorStop(0, "rgba(255,255,255,0.0)");
          gradient.addColorStop(0.2, "rgba(255,255,255,0.65)");
          gradient.addColorStop(0.5, "rgba(255,255,255,0.85)");
          gradient.addColorStop(0.8, "rgba(255,255,255,0.65)");
          gradient.addColorStop(1, "rgba(255,255,255,0.0)");
          ctx.fillStyle = gradient;

          ctx.beginPath();
          ctx.moveTo(x - length / 2, y);
          ctx.quadraticCurveTo(x - length * 0.18, y - height * 0.9, x + length * 0.08, y - height * 0.2);
          ctx.quadraticCurveTo(x + length * 0.32, y + height * 0.8, x + length / 2, y + height * 0.2);
          ctx.quadraticCurveTo(x + length * 0.22, y + height * 0.9, x - length * 0.14, y + height * 0.45);
          ctx.quadraticCurveTo(x - length * 0.3, y + height * 0.1, x - length / 2, y);
          ctx.closePath();
          ctx.fill();

          ctx.globalAlpha = opacity * 0.6;
          ctx.beginPath();
          ctx.moveTo(x - length * 0.2, y - height * 0.4);
          ctx.quadraticCurveTo(x + length * 0.05, y - height * 0.9, x + length * 0.45, y - height * 0.4);
          ctx.strokeStyle = "rgba(255,255,255,0.75)";
          ctx.lineWidth = Math.max(1.5, size * 0.08);
          ctx.lineCap = "round";
          ctx.stroke();
          ctx.restore();
        }

        function drawAirplane(x, y, size, direction, bobPhase) {
          ctx.save();
          ctx.translate(x, y);
          if (direction < 0) {
            ctx.scale(-1, 1);
          }

          const bobOffset = Math.sin(bobPhase) * size * 0.08;
          ctx.translate(0, bobOffset);

          ctx.beginPath();
          ctx.moveTo(-size * 1.6, size * 0.06);
          ctx.quadraticCurveTo(-size * 0.6, size * 0.15, -size * 0.05, size * 0.04);
          ctx.strokeStyle = "rgba(255,255,255,0.85)";
          ctx.lineWidth = Math.max(1.2, size * 0.08);
          ctx.lineCap = "round";
          ctx.stroke();

          const bodyLength = size * 2.1;
          const bodyHeight = size * 0.65;
          const bodyGradient = ctx.createLinearGradient(-bodyLength / 2, 0, bodyLength / 2, 0);
          bodyGradient.addColorStop(0, "#f1f6ff");
          bodyGradient.addColorStop(0.5, "#ffffff");
          bodyGradient.addColorStop(1, "#e1f1ff");
          ctx.fillStyle = bodyGradient;

          ctx.beginPath();
          ctx.moveTo(-bodyLength / 2, -bodyHeight / 2);
          ctx.lineTo(bodyLength * 0.3, -bodyHeight * 0.5);
          ctx.quadraticCurveTo(bodyLength * 0.55, 0, bodyLength * 0.3, bodyHeight * 0.5);
          ctx.lineTo(-bodyLength / 2, bodyHeight / 2);
          ctx.quadraticCurveTo(-bodyLength * 0.7, 0, -bodyLength / 2, -bodyHeight / 2);
          ctx.closePath();
          ctx.fill();

          ctx.fillStyle = "#e0e9ff";
          ctx.beginPath();
          ctx.moveTo(-bodyLength * 0.1, -bodyHeight * 0.45);
          ctx.lineTo(size * 0.5, -bodyHeight * 0.9);
          ctx.lineTo(size * 0.15, -bodyHeight * 0.2);
          ctx.closePath();
          ctx.fill();

          ctx.beginPath();
          ctx.moveTo(-size * 0.3, bodyHeight * 0.5);
          ctx.lineTo(size * 0.35, bodyHeight * 0.95);
          ctx.lineTo(-size * 0.05, bodyHeight * 0.18);
          ctx.closePath();
          ctx.fill();

          ctx.fillStyle = "#bcc9ea";
          const windowRadius = size * 0.11;
          const windowSpacing = size * 0.45;
          ctx.beginPath();
          ctx.arc(-windowSpacing, -windowRadius * 0.4, windowRadius, 0, Math.PI * 2);
          ctx.arc(0, -windowRadius * 0.5, windowRadius, 0, Math.PI * 2);
          ctx.arc(windowSpacing, -windowRadius * 0.3, windowRadius, 0, Math.PI * 2);
          ctx.fill();

          ctx.restore();
        }

        function render(timestamp) {
          const dt = lastTimestamp ? Math.min((timestamp - lastTimestamp) / 1000, 0.05) : 0;
          lastTimestamp = timestamp;

          drawSkyBackground();
          const width = canvasCssWidth;
          const height = canvasCssHeight;

          if (driftEnabled) {
            const driftScale = dt || 0.016;
            for (let i = 0; i < clouds.length; i++) {
              const c = clouds[i];
              c.x += c.drift * driftScale;
              c.phase += driftScale * 1.5;
              if (c.x > 1.35) c.x = -0.35;
              if (c.x < -0.35) c.x = 1.35;
            }
          }

          for (let i = 0; i < clouds.length; i++) {
            const c = clouds[i];
            const x = c.x * width;
            const baseY = c.y * height;
            const y = baseY + Math.sin(c.phase) * c.bobAmount * height;
            if (c.type === "fluffy") {
              drawFluffyCloud(x, y, c.size, c.opacity);
            } else if (c.type === "puffy") {
              drawPuffyCloud(x, y, c.size, c.opacity);
            } else {
              drawWispyCloud(x, y, c.size * 0.7, c.opacity);
            }
          }

          planeSpawnTimer += dt;
          if (autoPlanesEnabled && planeSpawnTimer > 16) {
            addAirplane(true);
            planeSpawnTimer = 0;
          }

          for (let i = airplanes.length - 1; i >= 0; i--) {
            const p = airplanes[i];
            p.x += p.direction * p.speed * (dt || 0.016);
            p.bobPhase += (dt || 0.016) * 3;
            const px = p.x * width;
            const py = p.y * height * 0.9;
            drawAirplane(px, py, p.size, p.direction, p.bobPhase);
            if (p.direction === 1 && px > width * 1.3) {
              airplanes.splice(i, 1);
            } else if (p.direction === -1 && px < -width * 0.3) {
              airplanes.splice(i, 1);
            }
          }

          requestAnimationFrame(render);
        }

        requestAnimationFrame(render);

        window.addEventListener("load", () => {
          if (airplanes.length === 0) {
            addAirplane(true);
          }
        });
      })();
    </script>
  </body>
</html>

