<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Imperial Tic Tac Toe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --accent-gold: #d4af37;
        --accent-gold-soft: #e6c97a;
        --accent-crimson: #b43b3b;
        --accent-emerald: #237a57;
        --shadow-soft: 0 18px 40px rgba(15, 9, 0, 0.18);
        --radius-pill: 999px;
        --radius-panel: 24px;
        --radius-board: 28px;
        --radius-tile: 22px;
        --transition-fast: 140ms ease-out;
        --transition-med: 220ms ease-out;
        --font-sans: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        --font-display: "Cinzel", "Times New Roman", serif;

        --bg-body: #f6f1ea;
        --bg-body-texture: radial-gradient(
            circle at 10% 20%,
            rgba(255, 255, 255, 0.7) 0,
            transparent 55%
          ),
          radial-gradient(
            circle at 80% 0,
            rgba(255, 255, 255, 0.6) 0,
            transparent 45%
          ),
          radial-gradient(
            circle at 0 100%,
            rgba(222, 203, 181, 0.55) 0,
            transparent 60%
          );
        --bg-panel: rgba(255, 255, 255, 0.86);
        --bg-elevated: rgba(255, 255, 255, 0.92);
        --bg-board: rgba(248, 242, 232, 0.95);
        --bg-cell: rgba(255, 255, 255, 0.85);
        --bg-cell-hover: rgba(255, 255, 255, 0.98);
        --bg-cell-active: rgba(247, 234, 216, 1);
        --border-soft: rgba(173, 152, 126, 0.45);
        --border-strong: rgba(96, 74, 45, 0.6);
        --text-main: #2b2220;
        --text-soft: #6e5c54;
        --glyph-x: #a63131;
        --glyph-o: #32526b;
        --banner-win: linear-gradient(
          135deg,
          #f5e7c3 0%,
          #fdf4d0 30%,
          #f1e0b4 52%,
          #f8e9c7 70%,
          #fef9e9 100%
        );
        --overlay-backdrop: rgba(10, 4, 0, 0.46);
      }

      body.theme-night {
        --bg-body: #050608;
        --bg-body-texture: radial-gradient(
            circle at 0 0,
            rgba(72, 66, 80, 0.55) 0,
            transparent 55%
          ),
          radial-gradient(
            circle at 100% 0,
            rgba(82, 68, 70, 0.45) 0,
            transparent 55%
          ),
          radial-gradient(
            circle at 50% 100%,
            rgba(33, 32, 40, 0.9) 0,
            transparent 70%
          );
        --bg-panel: rgba(16, 14, 22, 0.96);
        --bg-elevated: rgba(22, 19, 28, 0.98);
        --bg-board: radial-gradient(
          circle at 20% 0,
          rgba(88, 73, 51, 0.5) 0,
          rgba(36, 28, 34, 0.85) 45%,
          rgba(10, 8, 14, 0.98) 100%
        );
        --bg-cell: rgba(19, 15, 26, 0.98);
        --bg-cell-hover: rgba(31, 23, 40, 1);
        --bg-cell-active: rgba(54, 39, 60, 1);
        --border-soft: rgba(160, 133, 80, 0.35);
        --border-strong: rgba(209, 169, 97, 0.7);
        --text-main: #f6eee2;
        --text-soft: #c6b49c;
        --glyph-x: #f2725b;
        --glyph-o: #72b7ff;
        --banner-win: radial-gradient(
          circle at 10% 0,
          rgba(255, 231, 179, 0.9) 0,
          rgba(180, 113, 63, 0.7) 35%,
          rgba(36, 18, 5, 0.98) 75%
        );
        --overlay-backdrop: rgba(3, 1, 9, 0.75);
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
      }

      body {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: stretch;
        font-family: var(--font-sans);
        color: var(--text-main);
        background-color: var(--bg-body);
        background-image: var(--bg-body-texture),
          radial-gradient(circle at 15% 100%, rgba(197, 178, 152, 0.19), transparent 60%),
          radial-gradient(circle at 85% 92%, rgba(215, 182, 150, 0.22), transparent 60%),
          conic-gradient(
            from 180deg at 50% 110%,
            rgba(152, 126, 87, 0.4),
            rgba(60, 48, 36, 0.1),
            rgba(152, 126, 87, 0.5),
            rgba(60, 48, 36, 0.05),
            rgba(152, 126, 87, 0.4)
          );
        background-attachment: fixed;
        -webkit-font-smoothing: antialiased;
      }

      #confetti-canvas {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
      }

      .app {
        position: relative;
        z-index: 1;
        width: 100%;
        max-width: 980px;
        padding: clamp(14px, 2.4vmin, 26px);
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: clamp(10px, 1.8vmin, 16px);
      }

      .top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1.4rem;
        background: linear-gradient(
            135deg,
            rgba(246, 235, 210, 0.9),
            rgba(255, 255, 255, 0.94)
          );
        border-radius: var(--radius-pill);
        border: 1px solid rgba(193, 165, 132, 0.6);
        box-shadow: 0 16px 40px rgba(33, 18, 6, 0.22);
        backdrop-filter: blur(22px);
        gap: 1.4rem;
      }

      body.theme-night .top-bar {
        background: radial-gradient(
            circle at 0 0,
            rgba(219, 196, 144, 0.18),
            transparent 60%
          ),
          radial-gradient(
            circle at 100% 0,
            rgba(255, 221, 146, 0.12),
            transparent 50%
          ),
          linear-gradient(135deg, rgba(21, 16, 32, 0.98), rgba(32, 25, 45, 0.98));
        border-color: rgba(217, 189, 140, 0.8);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 0.9rem;
        min-width: 0;
      }

      .crest {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 20%, #fff4d2 0, #f0d281 38%, #a7692f 100%);
        border: 2px solid rgba(114, 72, 27, 0.95);
        box-shadow: 0 0 0 2px rgba(240, 222, 180, 0.9),
          0 12px 26px rgba(64, 32, 10, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: var(--font-display);
        font-weight: 700;
        font-size: 0.85rem;
        letter-spacing: 0.12em;
        color: #412208;
        text-shadow: 0 1px 1px rgba(255, 255, 255, 0.5);
      }

      body.theme-night .crest {
        background: radial-gradient(circle at 25% 20%, #fff7d4 0, #e3c16a 36%, #81401a 100%);
        box-shadow: 0 0 0 2px rgba(255, 247, 210, 0.9),
          0 14px 35px rgba(0, 0, 0, 0.9);
      }

      .title-wrap {
        display: flex;
        flex-direction: column;
      }

      .title {
        font-family: var(--font-display);
        font-weight: 600;
        font-size: clamp(1.15rem, 1.6vmin + 0.6rem, 1.5rem);
        letter-spacing: 0.18em;
        text-transform: uppercase;
        white-space: nowrap;
      }

      .subtitle {
        font-size: 0.7rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: var(--text-soft);
        white-space: nowrap;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 0.55rem;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .control-btn {
        border-radius: var(--radius-pill);
        border: 1px solid rgba(170, 140, 101, 0.7);
        background: linear-gradient(
          135deg,
          rgba(255, 243, 210, 0.95),
          rgba(249, 230, 194, 0.92)
        );
        color: #55351a;
        padding: 0.45rem 0.9rem;
        min-width: 7.5rem;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 10px 22px rgba(92, 54, 24, 0.35);
        transition: transform var(--transition-fast), box-shadow var(--transition-fast),
          background var(--transition-fast), border-color var(--transition-fast);
      }

      body.theme-night .control-btn {
        background: linear-gradient(135deg, #312017, #5a3820);
        color: #f8f0dc;
        border-color: rgba(235, 196, 126, 0.95);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.9);
      }

      .control-btn:focus-visible {
        outline: 2px solid var(--accent-gold-soft);
        outline-offset: 2px;
      }

      .control-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 30px rgba(56, 33, 14, 0.42);
      }

      .control-btn:active {
        transform: translateY(1px) scale(0.99);
        box-shadow: 0 8px 16px rgba(46, 26, 10, 0.5);
        background: linear-gradient(
          135deg,
          rgba(247, 225, 183, 0.99),
          rgba(236, 206, 166, 0.98)
        );
      }

      body.theme-night .control-btn:active {
        background: linear-gradient(135deg, #231510, #44291a);
      }

      .banner-row {
        margin-top: 0.2rem;
      }

      .banner {
        min-height: 2.2rem;
        border-radius: var(--radius-pill);
        padding: 0.4rem 1.1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.8rem;
        font-size: 0.85rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        background: linear-gradient(
          120deg,
          rgba(255, 255, 255, 0.9),
          rgba(244, 231, 210, 0.96)
        );
        border: 1px solid rgba(186, 159, 126, 0.7);
        box-shadow: 0 10px 26px rgba(47, 30, 16, 0.2);
      }

      body.theme-night .banner {
        background: radial-gradient(
            circle at 10% 0,
            rgba(255, 244, 204, 0.2),
            transparent 55%
          ),
          linear-gradient(105deg, rgba(21, 16, 25, 0.95), rgba(38, 24, 12, 0.96));
        border-color: rgba(216, 178, 117, 0.8);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.8);
      }

      .banner-label {
        display: inline-flex;
        align-items: center;
        gap: 0.48rem;
        font-weight: 600;
      }

      .banner-label span:first-child {
        font-family: var(--font-display);
        font-size: 1.1rem;
        letter-spacing: 0.16em;
      }

      .banner-detail {
        color: var(--text-soft);
        font-size: 0.8rem;
      }

      .layout-main {
        flex: 1;
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.9fr);
        gap: clamp(14px, 2.6vmin, 22px);
        align-items: center;
        margin-top: clamp(10px, 2.3vmin, 18px);
      }

      @media (max-width: 800px) {
        .layout-main {
          grid-template-columns: minmax(0, 1fr);
          grid-auto-rows: auto;
        }
      }

      .board-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .board-shell {
        width: min(86vmin, 520px);
        aspect-ratio: 1 / 1;
        padding: clamp(0.6rem, 1.6vmin, 1.2rem);
        border-radius: var(--radius-board);
        background: var(--bg-board);
        box-shadow: 0 26px 60px rgba(28, 18, 9, 0.6);
        border: 1px solid rgba(143, 118, 87, 0.7);
        position: relative;
        overflow: hidden;
        display: flex;
      }

      .board-shell::before {
        content: "";
        position: absolute;
        inset: -40%;
        background-image: radial-gradient(
            circle at 20% 10%,
            rgba(255, 255, 255, 0.16),
            transparent 65%
          ),
          radial-gradient(circle at 80% 0, rgba(255, 255, 255, 0.16), transparent 60%),
          repeating-conic-gradient(
            from 180deg,
            rgba(117, 96, 67, 0.36) 0deg,
            rgba(117, 96, 67, 0.36) 10deg,
            rgba(196, 172, 132, 0.1) 12deg,
            rgba(196, 172, 132, 0.1) 20deg
          );
        opacity: 0.26;
        mix-blend-mode: soft-light;
        pointer-events: none;
      }

      .board {
        position: relative;
        z-index: 1;
        flex: 1;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: clamp(0.5rem, 1.6vmin, 0.9rem);
      }

      .cell {
        border-radius: var(--radius-tile);
        border: 1px solid var(--border-soft);
        background: var(--bg-cell);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: var(--font-display);
        font-weight: 600;
        font-size: clamp(2.4rem, 6.2vmin, 4.1rem);
        color: var(--glyph-x);
        cursor: pointer;
        box-shadow: 0 12px 26px rgba(37, 22, 9, 0.45);
        transition: transform var(--transition-fast), box-shadow var(--transition-fast),
          background var(--transition-fast), border-color var(--transition-fast),
          color var(--transition-fast);
      }

      .cell[data-player="X"] {
        color: var(--glyph-x);
        text-shadow: 0 0 10px rgba(180, 77, 77, 0.22),
          0 0 24px rgba(118, 33, 33, 0.28);
      }

      .cell[data-player="O"] {
        color: var(--glyph-o);
        text-shadow: 0 0 10px rgba(81, 123, 173, 0.3),
          0 0 24px rgba(46, 82, 129, 0.35);
      }

      .cell:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 28px rgba(24, 15, 6, 0.5);
        background: var(--bg-cell-hover);
      }

      .cell:active {
        transform: translateY(1px) scale(0.985);
        box-shadow: 0 10px 18px rgba(24, 15, 6, 0.5);
        background: var(--bg-cell-active);
        border-color: rgba(166, 138, 102, 0.8);
      }

      .cell:focus-visible {
        outline: 2px solid var(--accent-gold-soft);
        outline-offset: 2px;
      }

      .cell.win {
        background: radial-gradient(
          circle at 20% 0,
          rgba(255, 246, 215, 0.98),
          rgba(242, 214, 142, 0.97)
        );
        border-color: rgba(198, 153, 69, 0.98);
        box-shadow: 0 0 0 2px rgba(251, 243, 208, 0.95),
          0 0 24px rgba(252, 218, 130, 0.8), 0 20px 40px rgba(40, 24, 7, 0.85);
        transform: translateY(-1px) scale(1.012);
      }

      .cell.disabled {
        cursor: default;
        opacity: 0.7;
        box-shadow: 0 8px 16px rgba(21, 13, 6, 0.3);
      }

      .side-panel {
        display: flex;
        flex-direction: column;
        gap: 0.9rem;
      }

      .score-panel {
        background: var(--bg-panel);
        border-radius: var(--radius-panel);
        padding: 0.8rem 1.1rem 0.95rem;
        box-shadow: 0 14px 34px rgba(23, 14, 7, 0.28);
        border: 1px solid rgba(186, 160, 130, 0.65);
        backdrop-filter: blur(20px);
      }

      body.theme-night .score-panel {
        background: radial-gradient(
            circle at 10% 0,
            rgba(214, 178, 117, 0.12),
            transparent 60%
          ),
          linear-gradient(145deg, rgba(17, 14, 22, 0.97), rgba(22, 17, 30, 0.99));
        border-color: rgba(208, 172, 118, 0.8);
      }

      .score-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.6rem;
        margin-bottom: 0.55rem;
      }

      .score-title {
        font-family: var(--font-display);
        font-size: 1.05rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
      }

      .mode-pill {
        font-size: 0.65rem;
        padding: 0.25rem 0.7rem;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(152, 124, 90, 0.9);
        background: linear-gradient(
          120deg,
          rgba(255, 252, 246, 0.9),
          rgba(242, 223, 194, 0.9)
        );
        letter-spacing: 0.16em;
        text-transform: uppercase;
        font-weight: 600;
      }

      body.theme-night .mode-pill {
        background: linear-gradient(135deg, rgba(36, 27, 41, 0.98), rgba(54, 36, 22, 0.98));
        border-color: rgba(214, 184, 128, 0.9);
      }

      .score-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.5rem;
      }

      .score-card {
        border-radius: 18px;
        border: 1px solid rgba(166, 142, 112, 0.7);
        background: linear-gradient(
          145deg,
          rgba(255, 253, 249, 0.98),
          rgba(240, 223, 199, 0.96)
        );
        padding: 0.45rem 0.55rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.15rem;
      }

      body.theme-night .score-card {
        background: linear-gradient(150deg, #221518, #3d2632);
        border-color: rgba(220, 186, 134, 0.9);
      }

      .score-label {
        font-size: 0.7rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--text-soft);
      }

      .score-value {
        font-family: var(--font-display);
        font-size: 1.45rem;
      }

      .score-card.player-x .score-value {
        color: var(--glyph-x);
      }

      .score-card.player-o .score-value {
        color: var(--glyph-o);
      }

      .score-card.draws .score-value {
        color: #aa813f;
      }

      .meta-row {
        margin-top: 0.6rem;
        font-size: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        color: var(--text-soft);
      }

      .meta-row strong {
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-size: 0.7rem;
      }

      .status-line {
        margin-top: 0.6rem;
        font-size: 0.88rem;
        padding: 0.45rem 0.75rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid rgba(177, 150, 118, 0.7);
        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
      }

      body.theme-night .status-line {
        background: linear-gradient(135deg, rgba(23, 18, 30, 0.98), rgba(38, 24, 17, 0.98));
        border-color: rgba(209, 180, 126, 0.9);
      }

      .status-pill {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--accent-emerald);
        box-shadow: 0 0 0 3px rgba(35, 122, 87, 0.35);
      }

      .status-pill.waiting {
        background: #b7832a;
        box-shadow: 0 0 0 3px rgba(183, 131, 42, 0.4);
      }

      .status-pill.idle {
        background: #767676;
        box-shadow: 0 0 0 3px rgba(118, 118, 118, 0.4);
      }

      .status-text {
        white-space: nowrap;
      }

      @media (max-width: 800px) {
        .top-bar {
          flex-direction: column;
          align-items: stretch;
          border-radius: 20px;
        }

        .brand {
          justify-content: center;
        }

        .controls {
          justify-content: center;
        }

        .score-panel {
          order: 2;
        }
      }

      @media (max-width: 540px) {
        .controls {
          gap: 0.4rem;
        }

        .control-btn {
          min-width: 0;
          flex: 1 1 28%;
          padding-inline: 0.5rem;
        }

        .banner {
          flex-direction: column;
          align-items: flex-start;
          padding-inline: 0.85rem;
        }

        .status-line {
          width: 100%;
          justify-content: center;
        }

        .board-shell {
          width: min(92vmin, 480px);
        }
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: var(--overlay-backdrop);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }

      .modal {
        max-width: 560px;
        width: min(96vw, 560px);
        background: var(--bg-elevated);
        border-radius: 24px;
        padding: 1.2rem 1.4rem 1.25rem;
        box-shadow: 0 24px 70px rgba(5, 2, 0, 0.9);
        border: 1px solid rgba(192, 164, 126, 0.9);
      }

      body.theme-night .modal {
        background: radial-gradient(
            circle at 0 0,
            rgba(231, 202, 145, 0.16),
            transparent 55%
          ),
          linear-gradient(140deg, #130f21, #221525);
        border-color: rgba(219, 188, 132, 0.9);
      }

      .modal-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.6rem;
        margin-bottom: 0.75rem;
      }

      .modal-title {
        font-family: var(--font-display);
        font-size: 1.1rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
      }

      .modal-subtitle {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-soft);
      }

      .modal-body {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 0.8rem 1.1rem;
        margin-bottom: 0.85rem;
      }

      @media (max-width: 640px) {
        .modal-body {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .field {
        border-radius: 18px;
        background: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.94),
          rgba(244, 229, 205, 0.96)
        );
        padding: 0.6rem 0.7rem 0.55rem;
        border: 1px solid rgba(184, 163, 134, 0.8);
      }

      body.theme-night .field {
        background: linear-gradient(145deg, rgba(20, 16, 30, 0.98), rgba(35, 22, 33, 0.98));
        border-color: rgba(214, 187, 136, 0.8);
      }

      .field legend,
      .field-title {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        margin-bottom: 0.25rem;
        color: var(--text-soft);
      }

      .option-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
      }

      .chip {
        border-radius: 999px;
        padding: 0.25rem 0.65rem;
        border: 1px solid rgba(175, 149, 120, 0.8);
        background: rgba(255, 255, 255, 0.9);
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        transition: background var(--transition-fast), border-color var(--transition-fast),
          transform var(--transition-fast), box-shadow var(--transition-fast),
          color var(--transition-fast), opacity var(--transition-fast);
      }

      body.theme-night .chip {
        background: rgba(27, 19, 36, 0.98);
        color: #f7efe0;
      }

      .chip input {
        display: none;
      }

      .chip span.symbol {
        font-family: var(--font-display);
        font-size: 0.8rem;
      }

      .chip.selected {
        background: linear-gradient(135deg, #f3e0bf, #f9f0da);
        border-color: rgba(208, 174, 118, 0.98);
        box-shadow: 0 10px 22px rgba(71, 43, 15, 0.5);
        color: #3a2110;
        transform: translateY(-1px);
      }

      body.theme-night .chip.selected {
        background: linear-gradient(135deg, #e7c787, #b97b40);
        color: #120707;
      }

      .chip[aria-disabled="true"] {
        opacity: 0.48;
        cursor: default;
        box-shadow: none;
      }

      .chip[aria-disabled="true"].selected {
        opacity: 0.68;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 0.3rem;
      }

      .modal-btn {
        border-radius: 16px;
        border: 1px solid rgba(168, 141, 111, 0.8);
        padding: 0.38rem 0.9rem;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.94);
      }

      body.theme-night .modal-btn {
        background: rgba(29, 22, 35, 0.96);
        color: #f4ebdd;
        border-color: rgba(215, 183, 130, 0.9);
      }

      .modal-btn.primary {
        background: linear-gradient(135deg, #e6c578, #f3dfb1);
        border-color: rgba(168, 121, 46, 0.9);
        color: #3c2407;
        box-shadow: 0 10px 22px rgba(73, 44, 10, 0.55);
      }

      body.theme-night .modal-btn.primary {
        background: linear-gradient(135deg, #f1d58a, #b56a2e);
        color: #130501;
      }

      .modal-btn:focus-visible {
        outline: 2px solid var(--accent-gold-soft);
        outline-offset: 2px;
      }

      .hidden {
        display: none !important;
      }

      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          scroll-behavior: auto !important;
          animation-duration: 0.001ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.001ms !important;
        }
      }
    </style>
  </head>
  <body class="theme-day">
    <canvas id="confetti-canvas" aria-hidden="true"></canvas>
    <div class="app">
      <header class="top-bar">
        <div class="brand">
          <div class="crest" aria-hidden="true">SPQR</div>
          <div class="title-wrap">
            <div class="title">Imperial Arena</div>
            <div class="subtitle">Tic Tac Toe Â· Colosseum Edition</div>
          </div>
        </div>
        <div class="controls">
          <button class="control-btn" id="new-round-btn" type="button">
            New Round
          </button>
          <button class="control-btn" id="customize-btn" type="button">
            Customize
          </button>
          <button class="control-btn" id="reset-scores-btn" type="button">
            Reset Scores
          </button>
        </div>
      </header>

      <section class="banner-row" aria-live="polite">
        <div class="banner" id="banner">
          <div class="banner-label">
            <span>ARENA</span>
            <span id="banner-main">Let the match begin.</span>
          </div>
          <div class="banner-detail" id="banner-detail">
            Configure your legion, then claim the marble.
          </div>
        </div>
      </section>

      <main class="layout-main">
        <section class="board-wrapper">
          <div
            class="board-shell"
            aria-label="Imperial Tic Tac Toe board"
            role="group"
          >
            <div
              class="board"
              id="board"
              role="grid"
              aria-label="Tic Tac Toe grid"
              aria-describedby="status-text"
            >
              <button
                class="cell"
                type="button"
                data-index="0"
                role="gridcell"
                aria-label="Row 1, column 1, empty"
                aria-rowindex="1"
                aria-colindex="1"
              ></button>
              <button
                class="cell"
                type="button"
                data-index="1"
                role="gridcell"
                aria-label="Row 1, column 2, empty"
                aria-rowindex="1"
                aria-colindex="2"
              ></button>
              <button
                class="cell"
                type="button"
                data-index="2"
                role="gridcell"
                aria-label="Row 1, column 3, empty"
                aria-rowindex="1"
                aria-colindex="3"
              ></button>
              <button
                class="cell"
                type="button"
                data-index="3"
                role="gridcell"
                aria-label="Row 2, column 1, empty"
                aria-rowindex="2"
                aria-colindex="1"
              ></button>
              <button
                class="cell"
                type="button"
                data-index="4"
                role="gridcell"
                aria-label="Row 2, column 2, empty"
                aria-rowindex="2"
                aria-colindex="2"
              ></button>
              <button
                class="cell"
                type="button"
                data-index="5"
                role="gridcell"
                aria-label="Row 2, column 3, empty"
                aria-rowindex="2"
                aria-colindex="3"
              ></button>
              <button
                class="cell"
                type="button"
                data-index="6"
                role="gridcell"
                aria-label="Row 3, column 1, empty"
                aria-rowindex="3"
                aria-colindex="1"
              ></button>
              <button
                class="cell"
                type="button"
                data-index="7"
                role="gridcell"
                aria-label="Row 3, column 2, empty"
                aria-rowindex="3"
                aria-colindex="2"
              ></button>
              <button
                class="cell"
                type="button"
                data-index="8"
                role="gridcell"
                aria-label="Row 3, column 3, empty"
                aria-rowindex="3"
                aria-colindex="3"
              ></button>
            </div>
          </div>
        </section>

        <aside class="side-panel" aria-label="Match information">
          <section class="score-panel" aria-label="Scoreboard">
            <div class="score-header">
              <div>
                <div class="score-title">Scoreboard</div>
                <div class="modal-subtitle">
                  Glory tallied in laurel and steel
                </div>
              </div>
              <div
                class="mode-pill"
                id="mode-pill"
                aria-live="polite"
              ></div>
            </div>
            <div class="score-grid" role="group" aria-label="Scores">
              <div class="score-card player-x">
                <div class="score-label" id="label-x">Legion X</div>
                <div class="score-value" id="score-x">0</div>
              </div>
              <div class="score-card player-o">
                <div class="score-label" id="label-o">Legion O</div>
                <div class="score-value" id="score-o">0</div>
              </div>
              <div class="score-card draws">
                <div class="score-label">Truce</div>
                <div class="score-value" id="score-draws">0</div>
              </div>
            </div>
            <div class="meta-row">
              <div id="meta-turn"></div>
              <div id="meta-discipline"></div>
            </div>
            <div
              class="status-line"
              id="status-line"
              aria-live="polite"
              aria-atomic="true"
            >
              <span class="status-pill" id="status-pill"></span>
              <span id="status-text" class="status-text"></span>
            </div>
          </section>
        </aside>
      </main>
    </div>

    <div
      class="modal-backdrop hidden"
      id="customize-backdrop"
      role="dialog"
      aria-modal="true"
      aria-labelledby="customize-title"
    >
      <div class="modal" aria-describedby="customize-subtitle">
        <header class="modal-header">
          <div>
            <div class="modal-title" id="customize-title">Customize Legion</div>
            <div class="modal-subtitle" id="customize-subtitle">
              Themes, glyphs, and discipline
            </div>
          </div>
        </header>
        <div class="modal-body">
          <fieldset class="field" id="field-theme">
            <legend>Theme</legend>
            <div class="option-row" role="radiogroup" aria-label="Theme">
              <label class="chip" data-setting="theme" data-value="day">
                <input type="radio" name="theme" value="day" />
                <span class="symbol">â›°</span>
                <span>Marble Day</span>
              </label>
              <label class="chip" data-setting="theme" data-value="night">
                <input type="radio" name="theme" value="night" />
                <span class="symbol">ðŸ›¡</span>
                <span>Night Legion</span>
              </label>
            </div>
          </fieldset>

          <fieldset class="field" id="field-glyphs">
            <legend>Glyphs</legend>
            <div class="option-row" role="radiogroup" aria-label="Glyph style">
              <label class="chip" data-setting="glyphs" data-value="standard">
                <input type="radio" name="glyphs" value="standard" />
                <span class="symbol">X/O</span>
                <span>Standard</span>
              </label>
              <label class="chip" data-setting="glyphs" data-value="roman">
                <input type="radio" name="glyphs" value="roman" />
                <span class="symbol">âš”ðŸŒ¿</span>
                <span>Gladius/Laurel</span>
              </label>
            </div>
          </fieldset>

          <fieldset class="field" id="field-mode">
            <legend>Mode</legend>
            <div class="option-row" role="radiogroup" aria-label="Game mode">
              <label class="chip" data-setting="mode" data-value="pvp">
                <input type="radio" name="mode" value="pvp" />
                <span class="symbol">II</span>
                <span>Two Players</span>
              </label>
              <label class="chip" data-setting="mode" data-value="ai">
                <input type="radio" name="mode" value="ai" />
                <span class="symbol">AI</span>
                <span>Vs AI</span>
              </label>
            </div>
          </fieldset>

          <fieldset class="field" id="field-first">
            <legend>First Move</legend>
            <div class="option-row" role="radiogroup" aria-label="First move">
              <label class="chip" data-setting="firstMove" data-value="X">
                <input type="radio" name="firstMove" value="X" />
                <span class="symbol">X</span>
                <span>Goes First</span>
              </label>
              <label class="chip" data-setting="firstMove" data-value="O">
                <input type="radio" name="firstMove" value="O" />
                <span class="symbol">O</span>
                <span>Goes First</span>
              </label>
            </div>
          </fieldset>

          <fieldset class="field" id="field-discipline">
            <legend>AI Discipline</legend>
            <div
              class="option-row"
              role="radiogroup"
              aria-label="AI discipline"
            >
              <label class="chip" data-setting="discipline" data-value="perfect">
                <input type="radio" name="discipline" value="perfect" />
                <span class="symbol">â™œ</span>
                <span>Perfect</span>
              </label>
              <label class="chip" data-setting="discipline" data-value="pragmatic">
                <input type="radio" name="discipline" value="pragmatic" />
                <span class="symbol">âš–</span>
                <span>Pragmatic</span>
              </label>
              <label class="chip" data-setting="discipline" data-value="reckless">
                <input type="radio" name="discipline" value="reckless" />
                <span class="symbol">âš¡</span>
                <span>Reckless</span>
              </label>
            </div>
          </fieldset>
        </div>
        <footer class="modal-footer">
          <button
            type="button"
            class="modal-btn"
            id="cancel-customize-btn"
          >
            Cancel
          </button>
          <button
            type="button"
            class="modal-btn primary"
            id="apply-customize-btn"
          >
            Apply &amp; New Round
          </button>
        </footer>
      </div>
    </div>

    <script>
      (function () {
        const prefersReducedMotion =
          window.matchMedia &&
          window.matchMedia("(prefers-reduced-motion: reduce)").matches;

        const Confetti = (function () {
          const canvas = document.getElementById("confetti-canvas");
          const ctx = canvas.getContext("2d");
          let particles = [];
          let animationFrame = null;
          let running = false;

          function resize() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
          }

          function createParticles() {
            const count = 160;
            const colors = [
              "#f5d97e",
              "#e1b972",
              "#c76d3d",
              "#a33e2a",
              "#f6f2e8",
              "#5a7496"
            ];
            particles = [];
            const w = canvas.clientWidth || window.innerWidth;
            const h = canvas.clientHeight || window.innerHeight;
            for (let i = 0; i < count; i++) {
              particles.push({
                x: Math.random() * w,
                y: -20 - Math.random() * h * 0.2,
                radius: 3 + Math.random() * 4,
                color: colors[Math.floor(Math.random() * colors.length)],
                vy: 2 + Math.random() * 3.5,
                vx: -1.2 + Math.random() * 2.4,
                rot: Math.random() * Math.PI * 2,
                vr: -0.1 + Math.random() * 0.2,
                life: 0,
                maxLife: 180 + Math.random() * 80
              });
            }
          }

          function step() {
            if (!running) return;
            const w = canvas.clientWidth || window.innerWidth;
            const h = canvas.clientHeight || window.innerHeight;
            ctx.clearRect(0, 0, w, h);
            particles.forEach((p) => {
              p.x += p.vx;
              p.y += p.vy;
              p.rot += p.vr;
              p.life++;
            });
            particles = particles.filter((p) => p.life < p.maxLife && p.y < h + 40);
            particles.forEach((p) => {
              ctx.save();
              ctx.translate(p.x, p.y);
              ctx.rotate(p.rot);
              const alpha = Math.max(0, 1 - p.life / p.maxLife);
              ctx.fillStyle = p.color;
              ctx.globalAlpha = alpha;
              ctx.fillRect(-p.radius, -p.radius * 0.5, p.radius * 2, p.radius);
              ctx.restore();
            });
            if (particles.length === 0) {
              running = false;
              return;
            }
            animationFrame = window.requestAnimationFrame(step);
          }

          function fire() {
            if (prefersReducedMotion) return;
            resize();
            createParticles();
            if (!running) {
              running = true;
              if (animationFrame) cancelAnimationFrame(animationFrame);
              animationFrame = window.requestAnimationFrame(step);
            }
          }

          window.addEventListener("resize", resize);
          resize();

          return { fire };
        })();

        const boardEl = document.getElementById("board");
        const cellEls = Array.from(boardEl.querySelectorAll(".cell"));
        const bannerMainEl = document.getElementById("banner-main");
        const bannerDetailEl = document.getElementById("banner-detail");
        const statusTextEl = document.getElementById("status-text");
        const statusPillEl = document.getElementById("status-pill");
        const statusLineEl = document.getElementById("status-line");
        const metaTurnEl = document.getElementById("meta-turn");
        const metaDisciplineEl = document.getElementById("meta-discipline");
        const modePillEl = document.getElementById("mode-pill");
        const scoreXEl = document.getElementById("score-x");
        const scoreOEl = document.getElementById("score-o");
        const scoreDrawsEl = document.getElementById("score-draws");
        const labelXEl = document.getElementById("label-x");
        const labelOEl = document.getElementById("label-o");

        const newRoundBtn = document.getElementById("new-round-btn");
        const customizeBtn = document.getElementById("customize-btn");
        const resetScoresBtn = document.getElementById("reset-scores-btn");

        const backdropEl = document.getElementById("customize-backdrop");
        const applyCustomizeBtn = document.getElementById("apply-customize-btn");
        const cancelCustomizeBtn = document.getElementById("cancel-customize-btn");

        const STORAGE_KEY_SETTINGS = "imperial-ttt-settings";
        const STORAGE_KEY_SCORES = "imperial-ttt-scores";

        const defaultSettings = {
          theme: "day",
          glyphs: "standard",
          mode: "ai",
          firstMove: "X",
          discipline: "pragmatic"
        };

        const state = {
          board: Array(9).fill(null),
          currentPlayer: "X",
          gameOver: false,
          aiThinking: false,
          settings: { ...defaultSettings },
          scores: { X: 0, O: 0, draws: 0 },
          modalOpen: false,
          lastFocusedControl: null
        };

        function loadPersisted() {
          try {
            const rawSettings = window.localStorage.getItem(STORAGE_KEY_SETTINGS);
            if (rawSettings) {
              const parsed = JSON.parse(rawSettings);
              state.settings = { ...state.settings, ...parsed };
            }
          } catch (e) {
            /* ignore */
          }
          try {
            const rawScores = window.localStorage.getItem(STORAGE_KEY_SCORES);
            if (rawScores) {
              const parsed = JSON.parse(rawScores);
              if (
                typeof parsed.X === "number" &&
                typeof parsed.O === "number" &&
                typeof parsed.draws === "number"
              ) {
                state.scores = parsed;
              }
            }
          } catch (e) {
            /* ignore */
          }
        }

        function persistSettings() {
          try {
            window.localStorage.setItem(
              STORAGE_KEY_SETTINGS,
              JSON.stringify(state.settings)
            );
          } catch (e) {
            /* ignore */
          }
        }

        function persistScores() {
          try {
            window.localStorage.setItem(
              STORAGE_KEY_SCORES,
              JSON.stringify(state.scores)
            );
          } catch (e) {
            /* ignore */
          }
        }

        function applyTheme() {
          document.body.classList.toggle("theme-night", state.settings.theme === "night");
          document.body.classList.toggle("theme-day", state.settings.theme !== "night");
        }

        function glyphFor(player) {
          if (state.settings.glyphs === "roman") {
            return player === "X" ? "âš”" : "ðŸŒ¿";
          }
          return player;
        }

        function updateScoreboard() {
          scoreXEl.textContent = state.scores.X;
          scoreOEl.textContent = state.scores.O;
          scoreDrawsEl.textContent = state.scores.draws;

          if (state.settings.glyphs === "roman") {
            labelXEl.textContent = "Gladius";
            labelOEl.textContent = "Laurel";
          } else {
            labelXEl.textContent = "Legion X";
            labelOEl.textContent = "Legion O";
          }
        }

        function updateMeta() {
          const vsAi = state.settings.mode === "ai";
          const discipline = state.settings.discipline;
          modePillEl.textContent = vsAi ? "VS IMPERIAL AI" : "DUAL COMMANDERS";

          const humanSide = "X";
          const aiSide = "O";

          if (vsAi) {
            const disciplineLabel =
              discipline === "perfect"
                ? "Perfect legion: flawless response."
                : discipline === "pragmatic"
                ? "Pragmatic legion: sharp, occasionally merciful."
                : "Reckless legion: bold, fallible, entertaining.";
            metaDisciplineEl.innerHTML =
              "<strong>AI Discipline</strong> Â· " + disciplineLabel;
            metaTurnEl.innerHTML =
              "<strong>Sides</strong> Â· You command " +
              glyphFor(humanSide) +
              ", AI commands " +
              glyphFor(aiSide) +
              ".";
          } else {
            metaDisciplineEl.innerHTML =
              "<strong>AI Discipline</strong> Â· Not applicable in twoâ€“commander mode.";
            metaTurnEl.innerHTML =
              "<strong>Sides</strong> Â· " +
              glyphFor("X") +
              " and " +
              glyphFor("O") +
              " alternate command.";
          }
        }

        function setStatusPill(mode) {
          statusPillEl.classList.remove("waiting", "idle");
          if (mode === "thinking") {
            statusPillEl.classList.add("waiting");
          } else if (mode === "idle") {
            statusPillEl.classList.add("idle");
          }
        }

        function updateStatusText() {
          if (state.gameOver) {
            statusTextEl.textContent = "Round complete. Start a new round to continue.";
            setStatusPill("idle");
            return;
          }
          if (state.aiThinking) {
            statusTextEl.textContent =
              "Imperial AI is contemplating its next formationâ€¦";
            setStatusPill("thinking");
            return;
          }
          const vsAi = state.settings.mode === "ai";
          const currentGlyph = glyphFor(state.currentPlayer);
          if (vsAi) {
            if (state.currentPlayer === "X") {
              statusTextEl.textContent =
                currentGlyph + " to move â€” your legion awaits orders.";
            } else {
              statusTextEl.textContent =
                currentGlyph +
                " to move â€” the AI legion maneuvers on the marble.";
            }
          } else {
            statusTextEl.textContent =
              currentGlyph + " to move â€” pass the fasces to the next consul.";
          }
          setStatusPill("active");
        }

        function resetBoardState() {
          state.board = Array(9).fill(null);
          state.gameOver = false;
          state.aiThinking = false;
          state.currentPlayer = state.settings.firstMove === "O" ? "O" : "X";
        }

        function updateBoardUI() {
          cellEls.forEach((cell) => {
            const index = Number(cell.dataset.index);
            const val = state.board[index];
            cell.textContent = val ? glyphFor(val) : "";
            cell.dataset.player = val || "";
            cell.classList.toggle("disabled", !!val || state.gameOver);
            cell.classList.remove("win");
            const row = Math.floor(index / 3) + 1;
            const col = (index % 3) + 1;
            const labelCore = val ? glyphFor(val) + " placed" : "empty";
            cell.setAttribute(
              "aria-label",
              "Row " + row + ", column " + col + ", " + labelCore
            );
          });
        }

        function announceBanner(title, detail) {
          bannerMainEl.textContent = title;
          bannerDetailEl.textContent = detail;
        }

        function getWinner(board) {
          const combos = [
            [0, 1, 2],
            [3, 4, 5],
            [6, 7, 8],
            [0, 3, 6],
            [1, 4, 7],
            [2, 5, 8],
            [0, 4, 8],
            [2, 4, 6]
          ];
          for (let i = 0; i < combos.length; i++) {
            const [a, b, c] = combos[i];
            if (board[a] && board[a] === board[b] && board[a] === board[c]) {
              return { winner: board[a], line: [a, b, c] };
            }
          }
          if (board.every((cell) => cell !== null)) {
            return { winner: null, line: null };
          }
          return null;
        }

        function handleRoundEnd(result) {
          state.gameOver = true;
          const versusAI = state.settings.mode === "ai";
          if (result.winner) {
            state.scores[result.winner]++;
            persistScores();
            updateScoreboard();

            if (result.line) {
              result.line.forEach((i) => {
                cellEls[i].classList.add("win");
              });
            }

            const glyph = glyphFor(result.winner);
            const humanSide = "X";
            const winnerIsHuman = !versusAI || result.winner === humanSide;
            const title = winnerIsHuman
              ? "Victory â€” " + glyph + " claims the arena."
              : "Defeat â€” " + glyph + " holds the marble.";

            const detail = winnerIsHuman
              ? "Laurels to the victor. Begin a new round to defend your honor."
              : "The imperial AI stands triumphant. Adjust discipline or strike again.";

            announceBanner(title, detail);
            statusLineEl.setAttribute("aria-live", "assertive");
            statusTextEl.textContent =
              glyph + " has assembled an unbroken line. Round concluded.";
            setStatusPill("idle");
            Confetti.fire();
          } else {
            state.scores.draws++;
            persistScores();
            updateScoreboard();
            announceBanner(
              "Stalemate on the stone.",
              "Neither side yields. Record a truce and call for a rematch."
            );
            statusLineEl.setAttribute("aria-live", "assertive");
            statusTextEl.textContent =
              "The board is full â€” no victor this round.";
            setStatusPill("idle");
          }
        }

        function makeMove(index, player) {
          if (state.board[index] !== null || state.gameOver) return;
          state.board[index] = player;
          updateBoardUI();
          const outcome = getWinner(state.board);
          if (outcome) {
            handleRoundEnd(outcome);
            return true;
          }
          return false;
        }

        function otherPlayer(p) {
          return p === "X" ? "O" : "X";
        }

        function evaluateBoard(board, aiPlayer, depth) {
          const outcome = getWinner(board);
          if (!outcome) return null;
          if (outcome.winner === aiPlayer) {
            return 10 - depth;
          } else if (outcome.winner === null) {
            return 0;
          }
          return depth - 10;
        }

        function minimax(board, current, aiPlayer, depth, maxDepth) {
          const evalScore = evaluateBoard(board, aiPlayer, depth);
          if (evalScore !== null || depth === maxDepth) {
            return evalScore !== null ? evalScore : 0;
          }
          const isMaximizing = current === aiPlayer;
          let best = isMaximizing ? -Infinity : Infinity;
          for (let i = 0; i < 9; i++) {
            if (board[i] !== null) continue;
            board[i] = current;
            const score = minimax(board, otherPlayer(current), aiPlayer, depth + 1, maxDepth);
            board[i] = null;
            if (isMaximizing) {
              if (score > best) best = score;
            } else {
              if (score < best) best = score;
            }
          }
          return best;
        }

        function computeAiMove() {
          const aiPlayer = "O";
          const humanPlayer = "X";
          const discipline = state.settings.discipline;

          const moves = [];
          for (let i = 0; i < 9; i++) {
            if (state.board[i] !== null) continue;
            state.board[i] = aiPlayer;
            const maxDepth =
              discipline === "perfect" ? 9 : discipline === "pragmatic" ? 5 : 3;
            const score = minimax(
              state.board,
              humanPlayer,
              aiPlayer,
              0,
              maxDepth
            );
            state.board[i] = null;
            moves.push({ index: i, score });
          }

          if (moves.length === 0) return null;

          moves.sort((a, b) => b.score - a.score);

          if (discipline === "perfect") {
            return moves[0].index;
          }

          if (discipline === "pragmatic") {
            const topGroup = moves.slice(0, Math.min(3, moves.length));
            const withSoftNoise = topGroup.map((m) => ({
              index: m.index,
              score: m.score + (Math.random() * 2 - 1)
            }));
            withSoftNoise.sort((a, b) => b.score - a.score);
            return withSoftNoise[0].index;
          }

          if (discipline === "reckless") {
            const top = moves[0];
            const randomChance = Math.random();
            if (randomChance < 0.5) {
              const pool = moves.slice(0, Math.min(4, moves.length));
              const picked = pool[Math.floor(Math.random() * pool.length)];
              return picked.index;
            }
            return top.index;
          }

          return moves[0].index;
        }

        function maybeTriggerAiTurn() {
          if (state.settings.mode !== "ai") return;
          const aiPlayer = "O";
          if (state.currentPlayer !== aiPlayer || state.gameOver) return;
          state.aiThinking = true;
          updateStatusText();
          const delay = state.settings.discipline === "perfect" ? 420 : 260;
          window.setTimeout(() => {
            if (state.gameOver) {
              state.aiThinking = false;
              updateStatusText();
              return;
            }
            const moveIndex = computeAiMove();
            state.aiThinking = false;
            if (moveIndex == null) {
              updateStatusText();
              return;
            }
            const finished = makeMove(moveIndex, aiPlayer);
            if (!finished) {
              state.currentPlayer = otherPlayer(aiPlayer);
              updateStatusText();
            }
          }, delay);
        }

        function handleHumanMove(index) {
          if (state.gameOver || state.aiThinking) return;
          const vsAi = state.settings.mode === "ai";
          const current = state.currentPlayer;

          if (vsAi && current !== "X") return;
          if (state.board[index] !== null) return;

          const finished = makeMove(index, current);
          if (!finished) {
            state.currentPlayer = otherPlayer(current);
          }
          updateStatusText();
          if (!finished) {
            maybeTriggerAiTurn();
          }
        }

        function newRound(options) {
          options = options || {};
          resetBoardState();
          updateBoardUI();
          announceBanner(
            "New round prepared.",
            "First move: " +
              glyphFor(state.currentPlayer) +
              ". Command your legion across the marble."
          );
          statusLineEl.setAttribute("aria-live", "polite");
          updateMeta();
          updateStatusText();
          if (!options.silent && state.settings.mode === "ai") {
            if (state.currentPlayer === "O") {
              maybeTriggerAiTurn();
            }
          }
        }

        function resetScores() {
          state.scores = { X: 0, O: 0, draws: 0 };
          persistScores();
          updateScoreboard();
          announceBanner(
            "Ledgers wiped clean.",
            "All laurels and truces erased. Begin anew."
          );
          statusTextEl.textContent =
            "Scores reset. Current round continues with existing positions.";
          setStatusPill("active");
        }

        function openModal() {
          if (state.modalOpen) return;
          state.modalOpen = true;
          backdropEl.classList.remove("hidden");
          state.lastFocusedControl = document.activeElement;
          applySettingsToModal();
          disableDisciplineChipsIfNecessary();
          const firstChip = backdropEl.querySelector(".chip");
          if (firstChip) firstChip.focus();
          document.addEventListener("keydown", handleModalKeydown);
        }

        function closeModal() {
          if (!state.modalOpen) return;
          state.modalOpen = false;
          backdropEl.classList.add("hidden");
          document.removeEventListener("keydown", handleModalKeydown);
          if (state.lastFocusedControl && state.lastFocusedControl.focus) {
            state.lastFocusedControl.focus();
          }
        }

        function handleModalKeydown(event) {
          if (event.key === "Escape") {
            event.preventDefault();
            closeModal();
            return;
          }
          if (event.key === "Tab") {
            const focusable = Array.from(
              backdropEl.querySelectorAll(
                "button, [href], input, [tabindex]:not([tabindex='-1'])"
              )
            ).filter((el) => !el.hasAttribute("disabled") && !el.classList.contains("hidden"));
            if (focusable.length === 0) return;
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            if (event.shiftKey) {
              if (document.activeElement === first) {
                event.preventDefault();
                last.focus();
              }
            } else {
              if (document.activeElement === last) {
                event.preventDefault();
                first.focus();
              }
            }
          }
        }

        function applySettingsToModal() {
          const chips = backdropEl.querySelectorAll(".chip[data-setting]");
          chips.forEach((chip) => {
            const setting = chip.dataset.setting;
            const value = chip.dataset.value;
            const selected = state.settings[setting] === value;
            chip.classList.toggle("selected", selected);
            const input = chip.querySelector("input");
            if (input) {
              input.checked = selected;
            }
          });
        }

        function disableDisciplineChipsIfNecessary() {
          const vsAi = state.settings.mode === "ai";
          const disciplineField = document.getElementById("field-discipline");
          const chips = disciplineField.querySelectorAll(".chip");
          chips.forEach((chip) => {
            if (!vsAi) {
              chip.setAttribute("aria-disabled", "true");
            } else {
              chip.removeAttribute("aria-disabled");
            }
          });
        }

        function applyModalSelections() {
          const chips = backdropEl.querySelectorAll(".chip[data-setting]");
          chips.forEach((chip) => {
            if (!chip.classList.contains("selected")) return;
            const setting = chip.dataset.setting;
            const value = chip.dataset.value;
            if (setting in state.settings) {
              state.settings[setting] = value;
            }
          });
          persistSettings();
          applyTheme();
          updateScoreboard();
          updateMeta();
          newRound({ silent: false });
        }

        function handleChipClick(event) {
          const chip = event.currentTarget;
          if (chip.getAttribute("aria-disabled") === "true") return;
          const setting = chip.dataset.setting;
          const value = chip.dataset.value;
          if (!setting) return;
          const groupChips = backdropEl.querySelectorAll(
            '.chip[data-setting="' + setting + '"]'
          );
          groupChips.forEach((c) => {
            c.classList.toggle("selected", c === chip);
            const input = c.querySelector("input");
            if (input) input.checked = c === chip;
          });
          if (setting === "mode") {
            const tempSettings = { ...state.settings, mode: value };
            const vsAi = tempSettings.mode === "ai";
            const disciplineField = document.getElementById("field-discipline");
            const chips = disciplineField.querySelectorAll(".chip");
            chips.forEach((c) => {
              if (!vsAi) {
                c.setAttribute("aria-disabled", "true");
              } else {
                c.removeAttribute("aria-disabled");
              }
            });
          }
        }

        function onCellKeydown(ev) {
          const key = ev.key;
          if (!["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(key)) return;
          ev.preventDefault();
          const currentIndex = cellEls.indexOf(ev.currentTarget);
          if (currentIndex < 0) return;
          let targetIndex = currentIndex;
          const row = Math.floor(currentIndex / 3);
          const col = currentIndex % 3;
          if (key === "ArrowUp" && row > 0) targetIndex = (row - 1) * 3 + col;
          if (key === "ArrowDown" && row < 2) targetIndex = (row + 1) * 3 + col;
          if (key === "ArrowLeft" && col > 0) targetIndex = row * 3 + (col - 1);
          if (key === "ArrowRight" && col < 2) targetIndex = row * 3 + (col + 1);
          if (targetIndex !== currentIndex) {
            cellEls[targetIndex].focus();
          }
        }

        function attachEventListeners() {
          cellEls.forEach((cell) => {
            cell.addEventListener("click", () => {
              const index = Number(cell.dataset.index);
              handleHumanMove(index);
            });
            cell.addEventListener("keydown", onCellKeydown);
          });

          newRoundBtn.addEventListener("click", () => {
            newRound({ silent: false });
          });

          resetScoresBtn.addEventListener("click", () => {
            resetScores();
          });

          customizeBtn.addEventListener("click", () => {
            openModal();
          });

          applyCustomizeBtn.addEventListener("click", () => {
            applyModalSelections();
            closeModal();
          });

          cancelCustomizeBtn.addEventListener("click", () => {
            closeModal();
          });

          backdropEl.addEventListener("click", (ev) => {
            if (ev.target === backdropEl) {
              closeModal();
            }
          });

          const chips = backdropEl.querySelectorAll(".chip[data-setting]");
          chips.forEach((chip) => {
            chip.tabIndex = 0;
            chip.addEventListener("click", handleChipClick);
            chip.addEventListener("keydown", (ev) => {
              if (ev.key === " " || ev.key === "Enter") {
                ev.preventDefault();
                handleChipClick(ev);
              }
            });
          });
        }

        function init() {
          loadPersisted();
          applyTheme();
          updateScoreboard();
          updateMeta();
          resetBoardState();
          updateBoardUI();
          announceBanner(
            "Imperial arena is ready.",
            "Choose settings via Customize. Default: you vs AI, Pragmatic discipline."
          );
          statusLineEl.setAttribute("aria-live", "polite");
          updateStatusText();
          attachEventListeners();
          if (state.settings.mode === "ai" && state.currentPlayer === "O") {
            maybeTriggerAiTurn();
          }
        }

        init();
      })();
    </script>
  </body>
</html>

