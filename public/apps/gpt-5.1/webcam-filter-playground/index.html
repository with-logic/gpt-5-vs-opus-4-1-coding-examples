<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Webcam Filter Playground</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark;
        --accent: #4f46e5;
        --accent-soft: rgba(79, 70, 229, 0.22);
        --accent-strong: rgba(129, 140, 248, 0.9);
        --background: #050816;
        --background-elevated: #020617;
        --border-subtle: rgba(148, 163, 184, 0.35);
        --border-strong: rgba(148, 163, 184, 0.6);
        --text-primary: #e5e7eb;
        --text-muted: #9ca3af;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        color: var(--text-primary);
        background:
          radial-gradient(circle at top, #1f2937 0, transparent 45%),
          radial-gradient(circle at bottom, #020617 0, transparent 45%),
          radial-gradient(circle at 80% 0, rgba(59, 130, 246, 0.4) 0, transparent 55%),
          radial-gradient(circle at 15% 100%, rgba(236, 72, 153, 0.32) 0, transparent 55%),
          var(--background);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px 16px;
      }

      .app-shell {
        width: 100%;
        max-width: 1120px;
      }

      header {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 18px;
      }

      header h1 {
        margin: 0 0 4px;
        font-weight: 650;
        letter-spacing: 0.03em;
        font-size: clamp(1.7rem, 1.3rem + 1.2vw, 2.1rem);
      }

      header p {
        margin: 0;
        max-width: 32rem;
        font-size: 0.9rem;
        line-height: 1.5;
        color: var(--text-muted);
      }

      .chip {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        background:
          linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
        color: var(--text-muted);
        font-size: 0.78rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
      }

      .chip-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: rgba(52, 211, 153, 0.72);
        box-shadow: 0 0 10px rgba(52, 211, 153, 0.9);
      }

      .main-card {
        background:
          linear-gradient(135deg, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.99));
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        box-shadow:
          0 26px 70px rgba(15, 23, 42, 0.95),
          0 0 0 1px rgba(15, 23, 42, 0.9);
        padding: 18px 18px 14px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      @media (min-width: 900px) {
        .main-card {
          flex-direction: row;
          padding: 20px;
        }
      }

      .preview-column {
        flex: 3;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .controls-column {
        flex: 2;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .preview-frame {
        position: relative;
        border-radius: 14px;
        background:
          radial-gradient(circle at 20% 0, #111827 0, transparent 35%),
          radial-gradient(circle at 80% 100%, #020617 0, transparent 55%),
          #020617;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      .preview-inner {
        position: relative;
        padding-top: 56.25%;
      }

      canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        display: block;
        background:
          radial-gradient(circle at 50% 0%, rgba(17, 24, 39, 0.9) 0, transparent 48%),
          radial-gradient(circle at 50% 100%, rgba(15, 23, 42, 0.98) 0, transparent 50%),
          radial-gradient(circle at 20% 0%, rgba(37, 99, 235, 0.3) 0, transparent 55%),
          radial-gradient(circle at 80% 100%, rgba(236, 72, 153, 0.32) 0, transparent 55%),
          #020617;
      }

      .preview-overlay-scanlines {
        position: absolute;
        inset: 0;
        pointer-events: none;
        opacity: 0.12;
        mix-blend-mode: soft-light;
        background-image: linear-gradient(
          to bottom,
          rgba(15, 23, 42, 0.9) 1px,
          transparent 1px
        );
        background-size: 100% 3px;
      }

      .preview-status-bar {
        position: absolute;
        left: 10px;
        right: 10px;
        bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        font-size: 0.72rem;
        color: var(--text-muted);
        pointer-events: none;
      }

      .live-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 9px;
        border-radius: 999px;
        background: radial-gradient(
          circle at 10% 0,
          rgba(15, 23, 42, 0.9) 0,
          rgba(15, 23, 42, 0.98) 70%
        );
        backdrop-filter: blur(16px);
        border: 1px solid rgba(248, 113, 113, 0.6);
      }

      .live-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #f97373;
        box-shadow: 0 0 12px rgba(248, 113, 113, 0.95);
      }

      .live-label {
        letter-spacing: 0.11em;
        font-size: 0.7rem;
        font-weight: 650;
      }

      .filter-label {
        padding: 3px 10px;
        border-radius: 999px;
        background: radial-gradient(
          circle at 100% 0,
          rgba(15, 23, 42, 0.96) 0,
          rgba(2, 6, 23, 0.98) 70%
        );
        backdrop-filter: blur(14px);
        border: 1px solid rgba(148, 163, 184, 0.6);
        max-width: 60%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: right;
      }

      .filter-label span {
        font-weight: 550;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .hidden-video {
        position: absolute;
        width: 0;
        height: 0;
        opacity: 0;
        pointer-events: none;
      }

      .controls-section {
        background:
          radial-gradient(circle at 0% 0%, rgba(37, 99, 235, 0.25) 0, transparent 55%),
          radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.18) 0, transparent 55%),
          rgba(15, 23, 42, 0.98);
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        padding: 10px 12px 11px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .controls-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .controls-header span:first-child {
        text-transform: uppercase;
        letter-spacing: 0.14em;
        font-weight: 600;
        font-size: 0.73rem;
      }

      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        font-size: 0.78rem;
        color: var(--text-muted);
        cursor: pointer;
        user-select: none;
      }

      .toggle input {
        appearance: none;
        width: 30px;
        height: 16px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.7);
        background: rgba(15, 23, 42, 0.9);
        position: relative;
        outline: none;
        transition: background-color 0.18s ease, border-color 0.18s ease;
      }

      .toggle input::before {
        content: "";
        position: absolute;
        top: 1.5px;
        left: 2px;
        width: 11px;
        height: 11px;
        border-radius: 999px;
        background: #e5e7eb;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.8);
        transition: transform 0.18s ease;
      }

      .toggle input:checked {
        background: linear-gradient(135deg, #22c55e, #4ade80);
        border-color: rgba(134, 239, 172, 0.95);
      }

      .toggle input:checked::before {
        transform: translateX(12px);
      }

      .filter-button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .filter-button {
        position: relative;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background:
          radial-gradient(circle at 0 0, rgba(37, 99, 235, 0.2) 0, transparent 55%),
          rgba(15, 23, 42, 0.96);
        color: var(--text-primary);
        font-size: 0.8rem;
        padding: 6px 10px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        outline: none;
        transition:
          border-color 0.18s ease,
          background-color 0.18s ease,
          transform 0.1s ease,
          box-shadow 0.18s ease;
      }

      .filter-button span {
        pointer-events: none;
      }

      .filter-badge {
        font-size: 0.68rem;
        text-transform: uppercase;
        letter-spacing: 0.13em;
        opacity: 0.8;
        color: #e5e7eb;
      }

      .filter-title {
        opacity: 0.86;
      }

      .filter-button:hover {
        border-color: var(--accent);
        background:
          radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.4) 0, transparent 55%),
          rgba(15, 23, 42, 0.98);
        transform: translateY(-0.5px);
        box-shadow: 0 6px 18px rgba(37, 99, 235, 0.55);
      }

      .filter-button.active {
        border-color: var(--accent-strong);
        color: #e5e7eb;
        background:
          linear-gradient(135deg, rgba(37, 99, 235, 0.98), rgba(129, 140, 248, 0.98));
        box-shadow:
          0 11px 28px rgba(37, 99, 235, 0.85),
          0 0 0 1px rgba(15, 23, 42, 0.95);
      }

      .filter-button.active .filter-title {
        opacity: 1;
      }

      .filter-button:focus-visible {
        outline: 2px solid #f9fafb;
        outline-offset: 2px;
      }

      .intensity-row {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .intensity-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .intensity-header span:first-child {
        text-transform: uppercase;
        letter-spacing: 0.14em;
        font-weight: 600;
        font-size: 0.73rem;
      }

      .intensity-value {
        font-variant-numeric: tabular-nums;
      }

      .range-input {
        width: 100%;
        appearance: none;
        height: 4px;
        border-radius: 999px;
        background:
          linear-gradient(
            to right,
            rgba(37, 99, 235, 0.85),
            rgba(129, 140, 248, 0.9),
            rgba(236, 72, 153, 0.9)
          );
        outline: none;
      }

      .range-input::-webkit-slider-thumb {
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #f9fafb;
        border: 2px solid rgba(15, 23, 42, 0.95);
        box-shadow:
          0 0 0 4px rgba(79, 70, 229, 0.45),
          0 8px 16px rgba(15, 23, 42, 0.95);
        cursor: pointer;
        margin-top: -6px;
      }

      .range-input::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #f9fafb;
        border: 2px solid rgba(15, 23, 42, 0.95);
        box-shadow:
          0 0 0 4px rgba(79, 70, 229, 0.45),
          0 8px 16px rgba(15, 23, 42, 0.95);
        cursor: pointer;
      }

      .range-input::-moz-range-track {
        height: 4px;
        border-radius: 999px;
        background:
          linear-gradient(
            to right,
            rgba(37, 99, 235, 0.85),
            rgba(129, 140, 248, 0.9),
            rgba(236, 72, 153, 0.9)
          );
      }

      .filter-description {
        margin: 2px 0 0;
        font-size: 0.78rem;
        color: var(--text-muted);
        line-height: 1.4;
      }

      .action-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .primary-button,
      .secondary-button {
        border-radius: 999px;
        font-size: 0.86rem;
        padding: 7px 14px;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        outline: none;
        white-space: nowrap;
        transition:
          transform 0.1s ease,
          box-shadow 0.18s ease,
          background-color 0.18s ease,
          opacity 0.18s ease;
      }

      .primary-button {
        background:
          radial-gradient(circle at 0 0, rgba(248, 113, 113, 0.42) 0, transparent 45%),
          linear-gradient(135deg, #fb7185, #fb923c);
        color: #111827;
        font-weight: 600;
        box-shadow:
          0 12px 28px rgba(248, 113, 113, 0.58),
          0 0 0 1px rgba(30, 64, 175, 0.7);
      }

      .primary-button:hover {
        transform: translateY(-0.5px);
        box-shadow:
          0 16px 32px rgba(248, 113, 113, 0.75),
          0 0 0 1px rgba(30, 64, 175, 0.8);
      }

      .primary-button:active {
        transform: translateY(0);
        box-shadow:
          0 8px 20px rgba(248, 113, 113, 0.7),
          0 0 0 1px rgba(30, 64, 175, 0.8);
      }

      .secondary-button {
        background: rgba(15, 23, 42, 0.96);
        border: 1px solid rgba(148, 163, 184, 0.55);
        color: var(--text-muted);
      }

      .secondary-button:hover {
        background: rgba(15, 23, 42, 0.98);
        transform: translateY(-0.5px);
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
        color: var(--text-primary);
      }

      .secondary-button:active {
        transform: translateY(0);
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.9);
      }

      .primary-button:focus-visible,
      .secondary-button:focus-visible {
        outline: 2px solid #e5e7eb;
        outline-offset: 2px;
      }

      .primary-dot {
        width: 9px;
        height: 9px;
        border-radius: 999px;
        background: #b91c1c;
        box-shadow:
          0 0 0 1px rgba(248, 113, 113, 0.95),
          0 0 15px rgba(248, 113, 113, 0.95);
      }

      .status-message {
        margin-top: 4px;
        min-height: 1.1em;
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .status-message[data-variant="ok"] {
        color: #bbf7d0;
      }

      .status-message[data-variant="warn"] {
        color: #fed7aa;
      }

      .status-message[data-variant="error"] {
        color: #fecaca;
      }

      .snapshots-card {
        margin-top: 14px;
        background:
          radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.22) 0, transparent 50%),
          radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.22) 0, transparent 55%),
          rgba(15, 23, 42, 0.98);
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        padding: 10px 14px 11px;
      }

      .snapshots-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
        font-size: 0.82rem;
        color: var(--text-muted);
      }

      .snapshots-header span:first-child {
        text-transform: uppercase;
        letter-spacing: 0.13em;
        font-size: 0.76rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .snapshots-hint {
        font-size: 0.78rem;
      }

      .snapshots-empty {
        margin-top: 8px;
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .snapshots-grid {
        margin-top: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        max-height: 190px;
        overflow-y: auto;
      }

      .snapshot-link {
        position: relative;
        display: block;
        width: 114px;
        aspect-ratio: 4 / 3;
        border-radius: 9px;
        border: 1px solid rgba(148, 163, 184, 0.55);
        overflow: hidden;
        background:
          radial-gradient(circle at 0 0, rgba(37, 99, 235, 0.3) 0, transparent 55%),
          #020617;
        cursor: pointer;
        text-decoration: none;
      }

      .snapshot-link img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        filter: saturate(1.1) contrast(1.02);
        transition: transform 0.2s ease;
      }

      .snapshot-link:hover img {
        transform: scale(1.03);
      }

      .snapshot-download-badge {
        position: absolute;
        left: 6px;
        bottom: 6px;
        padding: 2px 7px;
        border-radius: 999px;
        font-size: 0.7rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        background:
          linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
        color: #e5e7eb;
        border: 1px solid rgba(148, 163, 184, 0.75);
      }

      @media (max-width: 720px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .snapshots-grid {
          max-height: 160px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header>
        <div>
          <h1>Webcam Filter Playground</h1>
          <p>
            Paint your world in real time with bold, experimental filters.
            Capture your favorite looks as high-quality snapshots that never
            leave this browser.
          </p>
        </div>
        <span class="chip">
          <span class="chip-dot"></span>
          Live camera · Local only
        </span>
      </header>

      <section
        class="main-card"
        aria-label="Webcam Filter Playground live preview and controls"
      >
        <div class="preview-column">
          <div class="preview-frame">
            <div class="preview-inner">
              <canvas
                id="outputCanvas"
                aria-label="Filtered live webcam preview"
              ></canvas>
              <div class="preview-overlay-scanlines"></div>
              <video
                id="webcamVideo"
                class="hidden-video"
                autoplay
                playsinline
                muted
              ></video>
              <div class="preview-status-bar">
                <div class="live-pill">
                  <span class="live-dot"></span>
                  <span class="live-label">LIVE</span>
                </div>
                <div class="filter-label">
                  <span id="activeFilterLabel">Starting camera…</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="controls-column">
          <div class="controls-section" aria-label="Filter controls">
            <div class="controls-header">
              <span>Filter presets</span>
              <label class="toggle">
                <input id="mirrorToggle" type="checkbox" checked />
                <span>Mirror preview</span>
              </label>
            </div>
            <div
              id="filterButtons"
              class="filter-button-row"
              role="radiogroup"
              aria-label="Filter presets"
            ></div>
            <div class="intensity-row">
              <div class="intensity-header">
                <span>Intensity</span>
                <span id="intensityValue" class="intensity-value">70%</span>
              </div>
              <input
                id="intensityRange"
                class="range-input"
                type="range"
                min="0"
                max="100"
                value="70"
              />
            </div>
            <p id="filterDescription" class="filter-description">
              Grant camera permission to begin. Everything runs locally in your
              browser.
            </p>
          </div>

          <div class="controls-section" aria-label="Snapshot controls">
            <div class="controls-header">
              <span>Snapshot</span>
              <span class="chip">Instant PNG download</span>
            </div>
            <div class="action-row">
              <button id="captureButton" class="primary-button" type="button">
                <span class="primary-dot"></span>
                <span>Capture frame</span>
              </button>
              <button
                id="clearSnapshotsButton"
                class="secondary-button"
                type="button"
              >
                Clear gallery
              </button>
            </div>
            <div
              id="statusMessage"
              class="status-message"
              role="status"
              aria-live="polite"
            ></div>
          </div>
        </div>
      </section>

      <section class="snapshots-card" aria-label="Captured snapshots">
        <div class="snapshots-header">
          <span>Snapshots</span>
          <span class="snapshots-hint">Click any image to save it.</span>
        </div>
        <div id="snapshotsEmpty" class="snapshots-empty">
          No snapshots yet. Capture your favorite filtered frames and they will
          appear here.
        </div>
        <div
          id="snapshotsGrid"
          class="snapshots-grid"
          aria-live="polite"
        ></div>
      </section>
    </div>

    <script>
      (function () {
        "use strict";

        var videoElement = document.getElementById("webcamVideo");
        var canvasElement = document.getElementById("outputCanvas");
        var canvasContext = canvasElement.getContext("2d");
        var filterButtonsContainer = document.getElementById("filterButtons");
        var activeFilterLabelElement =
          document.getElementById("activeFilterLabel");
        var filterDescriptionElement =
          document.getElementById("filterDescription");
        var statusMessageElement = document.getElementById("statusMessage");
        var intensityRangeElement = document.getElementById("intensityRange");
        var intensityValueElement = document.getElementById("intensityValue");
        var captureButtonElement = document.getElementById("captureButton");
        var clearSnapshotsButtonElement = document.getElementById(
          "clearSnapshotsButton"
        );
        var mirrorToggleElement = document.getElementById("mirrorToggle");
        var snapshotsGridElement = document.getElementById("snapshotsGrid");
        var snapshotsEmptyElement = document.getElementById("snapshotsEmpty");

        if (!canvasContext) {
          return;
        }

        var filterDefinitions = [
          {
            key: "natural",
            label: "Natural polish",
            badge: "Clean",
            description:
              "Balanced contrast and color for an everyday, true-to-life look.",
            buildFilter: function (intensityAmount) {
              var contrastAmount = 1 + intensityAmount * 0.18;
              var saturationAmount = 1 + intensityAmount * 0.12;
              var brightnessAmount = 1 + intensityAmount * 0.06;
              return (
                "contrast(" +
                contrastAmount.toFixed(2) +
                ") saturate(" +
                saturationAmount.toFixed(2) +
                ") brightness(" +
                brightnessAmount.toFixed(2) +
                ")"
              );
            },
          },
          {
            key: "noir",
            label: "Noir film",
            badge: "Mono",
            description:
              "High-contrast black-and-white that feels like a moody film still.",
            buildFilter: function (intensityAmount) {
              var grayscaleAmount = 0.55 + intensityAmount * 0.45;
              var contrastAmount = 1.15 + intensityAmount * 1.2;
              var brightnessAmount = 1 + intensityAmount * 0.1;
              return (
                "grayscale(" +
                grayscaleAmount.toFixed(2) +
                ") contrast(" +
                contrastAmount.toFixed(2) +
                ") brightness(" +
                brightnessAmount.toFixed(2) +
                ")"
              );
            },
          },
          {
            key: "neon",
            label: "Cyber neon",
            badge: "Glow",
            description:
              "Electric magenta-and-cyan glow that turns your room into a neon cityscape.",
            buildFilter: function (intensityAmount) {
              var contrastAmount = 1.18 + intensityAmount * 0.9;
              var saturationAmount = 1.9 + intensityAmount * 3.2;
              var hueRotation = 210 + intensityAmount * 95;
              var brightnessAmount = 1.04 + intensityAmount * 0.34;
              return (
                "contrast(" +
                contrastAmount.toFixed(2) +
                ") saturate(" +
                saturationAmount.toFixed(2) +
                ") hue-rotate(" +
                hueRotation.toFixed(0) +
                "deg) brightness(" +
                brightnessAmount.toFixed(2) +
                ")"
              );
            },
          },
          {
            key: "heat",
            label: "Heat vision",
            badge: "Thermal",
            description:
              "False-color thermal vibes with intense, posterized highlights.",
            buildFilter: function (intensityAmount) {
              var invertAmount = 0.35 + intensityAmount * 0.4;
              var contrastAmount = 1.25 + intensityAmount * 0.85;
              var saturationAmount = 2.2 + intensityAmount * 3.4;
              var hueRotation = 40 + intensityAmount * 140;
              return (
                "invert(" +
                invertAmount.toFixed(2) +
                ") contrast(" +
                contrastAmount.toFixed(2) +
                ") saturate(" +
                saturationAmount.toFixed(2) +
                ") hue-rotate(" +
                hueRotation.toFixed(0) +
                "deg)"
              );
            },
          },
          {
            key: "dream",
            label: "Dream haze",
            badge: "Soft",
            description:
              "Pastel glow that gently lifts shadows and wraps everything in color.",
            buildFilter: function (intensityAmount) {
              var sepiaAmount = 0.25 + intensityAmount * 0.35;
              var saturationAmount = 1.4 + intensityAmount * 1.6;
              var hueRotation = 290 + intensityAmount * 40;
              var brightnessAmount = 1.06 + intensityAmount * 0.32;
              var blurRadius = 0.2 + intensityAmount * 1.4;
              return (
                "sepia(" +
                sepiaAmount.toFixed(2) +
                ") saturate(" +
                saturationAmount.toFixed(2) +
                ") hue-rotate(" +
                hueRotation.toFixed(0) +
                "deg) brightness(" +
                brightnessAmount.toFixed(2) +
                ") blur(" +
                blurRadius.toFixed(2) +
                "px)"
              );
            },
          },
          {
            key: "night",
            label: "Night vision",
            badge: "Green",
            description:
              "Grainy green night-vision style that thrives in darker scenes.",
            buildFilter: function (intensityAmount) {
              var grayscaleAmount = 0.7 + intensityAmount * 0.25;
              var contrastAmount = 1.2 + intensityAmount * 0.8;
              var saturationAmount = 1.8 + intensityAmount * 1.8;
              var brightnessAmount = 0.98 + intensityAmount * 0.24;
              var hueRotation = 90;
              return (
                "grayscale(" +
                grayscaleAmount.toFixed(2) +
                ") contrast(" +
                contrastAmount.toFixed(2) +
                ") saturate(" +
                saturationAmount.toFixed(2) +
                ") hue-rotate(" +
                hueRotation.toFixed(0) +
                "deg) brightness(" +
                brightnessAmount.toFixed(2) +
                ")"
              );
            },
          },
        ];

        var filterRegistry = {};
        var initialFilterKey = "neon";
        var currentFilterKey = initialFilterKey;
        var isMirrored = true;
        var isStreaming = false;
        var animationFrameIdentifier = null;

        filterDefinitions.forEach(function (filterDefinition) {
          filterRegistry[filterDefinition.key] = filterDefinition;
        });

        function updateFilterCopy(filterDefinition) {
          if (!filterDefinition) {
            return;
          }
          activeFilterLabelElement.textContent = filterDefinition.label;
          filterDescriptionElement.textContent = filterDefinition.description;
        }

        function setStatusMessage(message, variant) {
          statusMessageElement.textContent = message;
          if (!variant) {
            statusMessageElement.dataset.variant = "";
            return;
          }
          statusMessageElement.dataset.variant = variant;
        }

        function updateIntensityLabel() {
          var intensityAmount = parseInt(intensityRangeElement.value, 10) || 0;
          intensityValueElement.textContent = intensityAmount + "%";
        }

        function setActiveFilter(filterKey) {
          if (filterKey === currentFilterKey) {
            return;
          }
          currentFilterKey = filterKey;
          var activeDefinition = filterRegistry[filterKey];
          var buttonElements = filterButtonsContainer.children;
          var buttonCount = buttonElements.length;
          for (
            var buttonIndex = 0;
            buttonIndex < buttonCount;
            buttonIndex += 1
          ) {
            var buttonElement = buttonElements[buttonIndex];
            var buttonFilterKey = buttonElement.dataset.filterKey;
            var isSelected = buttonFilterKey === filterKey;
            buttonElement.classList.toggle("active", isSelected);
            buttonElement.setAttribute(
              "aria-checked",
              isSelected ? "true" : "false"
            );
          }
          updateFilterCopy(activeDefinition);
        }

        function createFilterButtons() {
          filterDefinitions.forEach(function (filterDefinition) {
            var buttonElement = document.createElement("button");
            buttonElement.type = "button";
            buttonElement.className = "filter-button";
            buttonElement.dataset.filterKey = filterDefinition.key;
            buttonElement.setAttribute("role", "radio");
            var isSelected = filterDefinition.key === currentFilterKey;
            if (isSelected) {
              buttonElement.classList.add("active");
              buttonElement.setAttribute("aria-checked", "true");
              updateFilterCopy(filterDefinition);
            } else {
              buttonElement.setAttribute("aria-checked", "false");
            }
            var badgeElement = document.createElement("span");
            badgeElement.className = "filter-badge";
            badgeElement.textContent = filterDefinition.badge;
            var titleElement = document.createElement("span");
            titleElement.className = "filter-title";
            titleElement.textContent = filterDefinition.label;
            buttonElement.appendChild(badgeElement);
            buttonElement.appendChild(titleElement);
            buttonElement.addEventListener("click", function () {
              setActiveFilter(filterDefinition.key);
            });
            filterButtonsContainer.appendChild(buttonElement);
          });
        }

        function padWithTwoDigits(numberValue) {
          return numberValue < 10
            ? "0" + numberValue
            : String(numberValue);
        }

        function captureSnapshot() {
          if (!isStreaming) {
            setStatusMessage("Camera is not ready yet.", "error");
            return;
          }
          var frameWidth = canvasElement.width;
          var frameHeight = canvasElement.height;
          if (!frameWidth || !frameHeight) {
            return;
          }
          var dataUrl = canvasElement.toDataURL("image/png");
          var timestamp = new Date();
          var fileName =
            "webcam-filter-" +
            timestamp.getFullYear().toString() +
            padWithTwoDigits(timestamp.getMonth() + 1) +
            padWithTwoDigits(timestamp.getDate()) +
            "-" +
            padWithTwoDigits(timestamp.getHours()) +
            padWithTwoDigits(timestamp.getMinutes()) +
            padWithTwoDigits(timestamp.getSeconds()) +
            ".png";
          var snapshotLinkElement = document.createElement("a");
          snapshotLinkElement.href = dataUrl;
          snapshotLinkElement.download = fileName;
          snapshotLinkElement.className = "snapshot-link";
          snapshotLinkElement.setAttribute(
            "aria-label",
            "Snapshot " + fileName
          );
          var imageElement = document.createElement("img");
          imageElement.src = dataUrl;
          imageElement.alt = "Snapshot preview";
          snapshotLinkElement.appendChild(imageElement);
          var snapshotBadgeElement = document.createElement("span");
          snapshotBadgeElement.className = "snapshot-download-badge";
          snapshotBadgeElement.textContent = "Save";
          snapshotLinkElement.appendChild(snapshotBadgeElement);
          snapshotsGridElement.prepend(snapshotLinkElement);
          snapshotsEmptyElement.style.display = "none";
        }

        function configureCanvasFromVideo() {
          var sourceWidth = videoElement.videoWidth;
          var sourceHeight = videoElement.videoHeight;
          if (!sourceWidth || !sourceHeight) {
            return;
          }
          var maximumWidth = 960;
          var targetWidth = sourceWidth;
          var targetHeight = sourceHeight;
          if (targetWidth > maximumWidth) {
            var scaleRatio = maximumWidth / targetWidth;
            targetWidth = Math.round(targetWidth * scaleRatio);
            targetHeight = Math.round(targetHeight * scaleRatio);
          }
          canvasElement.width = targetWidth;
          canvasElement.height = targetHeight;
          if (!isStreaming) {
            isStreaming = true;
            if (animationFrameIdentifier !== null) {
              window.cancelAnimationFrame(animationFrameIdentifier);
            }
            animationFrameIdentifier = window.requestAnimationFrame(
              renderFrame
            );
            setStatusMessage(
              "Camera live. Capture whenever you like.",
              "ok"
            );
          }
        }

        function renderFrame() {
          if (!isStreaming) {
            return;
          }
          var frameWidth = canvasElement.width;
          var frameHeight = canvasElement.height;
          if (!frameWidth || !frameHeight) {
            animationFrameIdentifier =
              window.requestAnimationFrame(renderFrame);
            return;
          }
          var readyState = videoElement.readyState || 0;
          if (readyState >= HTMLMediaElement.HAVE_CURRENT_DATA) {
            var normalizedIntensity =
              (parseInt(intensityRangeElement.value, 10) || 0) / 100;
            var filterDefinition = filterRegistry[currentFilterKey];
            var filterString = filterDefinition
              ? filterDefinition.buildFilter(normalizedIntensity)
              : "none";
            canvasContext.save();
            canvasContext.filter = filterString;
            if (isMirrored) {
              canvasContext.translate(frameWidth, 0);
              canvasContext.scale(-1, 1);
            }
            canvasContext.drawImage(
              videoElement,
              0,
              0,
              frameWidth,
              frameHeight
            );
            canvasContext.restore();
          }
          animationFrameIdentifier = window.requestAnimationFrame(renderFrame);
        }

        function initialiseCamera() {
          if (
            !navigator.mediaDevices ||
            !navigator.mediaDevices.getUserMedia
          ) {
            setStatusMessage(
              "This browser cannot access a webcam stream.",
              "error"
            );
            activeFilterLabelElement.textContent = "Unsupported";
            return;
          }
          setStatusMessage("Waiting for camera permission…", "warn");
          var mediaConstraints = {
            video: {
              width: { ideal: 1280 },
              height: { ideal: 720 },
              facingMode: "user",
            },
            audio: false,
          };
          navigator.mediaDevices
            .getUserMedia(mediaConstraints)
            .then(function (mediaStream) {
              videoElement.srcObject = mediaStream;
              var playPromise = videoElement.play();
              if (playPromise && typeof playPromise.then === "function") {
                playPromise.catch(function () {
                  setStatusMessage(
                    "Tap the preview to start playback.",
                    "warn"
                  );
                });
              }
            })
            .catch(function () {
              setStatusMessage(
                "Camera permission was blocked. Enable access and reload.",
                "error"
              );
              activeFilterLabelElement.textContent = "Camera blocked";
            });
        }

        mirrorToggleElement.addEventListener("change", function () {
          isMirrored = mirrorToggleElement.checked;
        });

        intensityRangeElement.addEventListener("input", updateIntensityLabel);

        captureButtonElement.addEventListener("click", captureSnapshot);

        clearSnapshotsButtonElement.addEventListener("click", function () {
          snapshotsGridElement.innerHTML = "";
          snapshotsEmptyElement.style.display = "";
        });

        videoElement.addEventListener("loadedmetadata", configureCanvasFromVideo);
        videoElement.addEventListener("resize", configureCanvasFromVideo);

        createFilterButtons();
        updateIntensityLabel();
        initialiseCamera();
      })();
    </script>
  </body>
</html>

