<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Data Visualization Playground â€“ CSV to Charts</title>
    <!-- Fonts -->
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Chart.js & PapaParse from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
      :root {
        --bg: #020617;
        --bg-elevated: rgba(15, 23, 42, 0.92);
        --bg-elevated-strong: rgba(15, 23, 42, 0.98);
        --border-subtle: rgba(148, 163, 184, 0.28);
        --text: #e5e7eb;
        --text-muted: #9ca3af;
        --accent: #6366f1;
        --accent-soft: rgba(99, 102, 241, 0.18);
        --accent-strong: #4f46e5;
        --danger: #f97373;
        --success: #22c55e;
        --radius-xl: 18px;
        --radius-lg: 14px;
        --radius-md: 10px;
        --shadow-soft: 0 24px 80px rgba(15, 23, 42, 0.65);
        --shadow-subtle: 0 18px 50px rgba(15, 23, 42, 0.55);
        --input-bg: rgba(15, 23, 42, 0.8);
        --scrollbar: rgba(148, 163, 184, 0.6);
        --scrollbar-bg: transparent;
        --accent-gradient: linear-gradient(135deg, #6366f1, #22c55e);
      }

      [data-theme="light"] {
        --bg: #f3f4f6;
        --bg-elevated: rgba(255, 255, 255, 0.96);
        --bg-elevated-strong: rgba(255, 255, 255, 0.99);
        --border-subtle: rgba(148, 163, 184, 0.35);
        --text: #111827;
        --text-muted: #6b7280;
        --accent-soft: rgba(99, 102, 241, 0.16);
        --shadow-soft: 0 26px 80px rgba(15, 23, 42, 0.18);
        --shadow-subtle: 0 18px 45px rgba(15, 23, 42, 0.18);
        --input-bg: rgba(249, 250, 251, 0.92);
        --scrollbar: rgba(148, 163, 184, 0.8);
      }

      * {
        box-sizing: border-box;
      }

      ::selection {
        background: rgba(79, 70, 229, 0.3);
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        color: var(--text);
        background: radial-gradient(circle at top left, #0f172a 0, #020617 40%),
          radial-gradient(circle at bottom right, #1e293b 0, #020617 55%);
      }

      body {
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: 24px;
      }

      .page {
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 18px;
        width: 100%;
        max-width: 1240px;
        margin: 0 auto;
      }

      .page::before {
        content: "";
        position: fixed;
        inset: 0;
        background:
          radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), transparent 55%),
          radial-gradient(circle at bottom right, rgba(129, 140, 248, 0.16), transparent 55%);
        pointer-events: none;
        z-index: -2;
      }

      .shell {
        display: grid;
        grid-template-columns: minmax(0, 360px) minmax(0, 1.6fr);
        gap: 18px;
        padding: 18px;
        border-radius: 28px;
        background: linear-gradient(
              120deg,
              rgba(148, 163, 184, 0.4),
              transparent 28%,
              transparent 68%,
              rgba(59, 130, 246, 0.5)
            )
            border-box,
          radial-gradient(circle at top left, rgba(56, 189, 248, 0.16), transparent 55%),
          radial-gradient(circle at bottom right, rgba(99, 102, 241, 0.3), transparent 60%);
        background-clip: padding-box, border-box, border-box;
        border: 1px solid rgba(148, 163, 184, 0.45);
        box-shadow: var(--shadow-soft);
      }

      @media (max-width: 960px) {
        body {
          padding: 16px;
        }

        .shell {
          grid-template-columns: minmax(0, 1fr);
          padding: 14px;
        }
      }

      @media (max-width: 640px) {
        body {
          padding: 10px;
        }

        .shell {
          padding: 10px;
        }
      }

      .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding: 6px 4px 2px;
      }

      .title-block h1 {
        margin: 0;
        font-size: 1.4rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .title-pill {
        padding: 3px 9px;
        border-radius: 999px;
        font-size: 0.68rem;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.22), transparent 55%);
      }

      .title-main {
        margin-top: 8px;
        font-size: 1.9rem;
        font-weight: 600;
        letter-spacing: -0.03em;
      }

      .title-sub {
        margin-top: 4px;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .badge {
        padding: 4px 9px;
        border-radius: 999px;
        font-size: 0.7rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border: 1px solid rgba(148, 163, 184, 0.55);
        background: linear-gradient(120deg, rgba(148, 163, 184, 0.08), rgba(37, 99, 235, 0.22));
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .badge-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: linear-gradient(135deg, #22c55e, #a3e635);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
      }

      .theme-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.4);
        cursor: pointer;
        font-size: 0.72rem;
      }

      .theme-toggle input {
        display: none;
      }

      .toggle-pill {
        width: 30px;
        height: 16px;
        border-radius: 999px;
        padding: 2px;
        background: radial-gradient(circle at 30% 0, rgba(254, 243, 199, 0.9), #f97316)
          border-box;
        border: 1px solid rgba(248, 250, 252, 0.5);
        display: flex;
        align-items: center;
        justify-content: flex-start;
        transition: all 0.18s ease-out;
      }

      [data-theme="light"] .toggle-pill {
        background: radial-gradient(circle at 30% 0, rgba(191, 219, 254, 0.8), #1d4ed8)
          border-box;
      }

      .toggle-thumb {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: white;
        box-shadow: 0 2px 4px rgba(15, 23, 42, 0.4);
        transform: translateX(0);
        transition: transform 0.18s ease-out;
      }

      [data-theme="light"] .toggle-thumb {
        transform: translateX(12px);
      }

      .sidebar,
      .chart-panel {
        border-radius: var(--radius-xl);
        background: linear-gradient(
              145deg,
              rgba(148, 163, 184, 0.22),
              transparent 32%,
              transparent 68%,
              rgba(99, 102, 241, 0.32)
            ),
          linear-gradient(160deg, rgba(15, 23, 42, 0.96), var(--bg-elevated-strong));
        border: 1px solid var(--border-subtle);
        box-shadow: var(--shadow-subtle);
        padding: 16px 14px 14px;
        position: relative;
        overflow: hidden;
      }

      .sidebar::before {
        content: "";
        position: absolute;
        inset: -40%;
        background: radial-gradient(circle at 0 0, rgba(96, 165, 250, 0.16), transparent 60%);
        opacity: 0.9;
        mix-blend-mode: screen;
        pointer-events: none;
      }

      .chart-panel::before {
        content: "";
        position: absolute;
        inset: -40%;
        background:
          radial-gradient(circle at 0 0, rgba(96, 165, 250, 0.16), transparent 60%),
          radial-gradient(circle at 100% 100%, rgba(74, 222, 128, 0.12), transparent 60%);
        opacity: 0.9;
        mix-blend-mode: screen;
        pointer-events: none;
      }

      .sidebar-inner,
      .chart-panel-inner {
        position: relative;
        z-index: 1;
      }

      .section-title {
        font-size: 0.82rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--text-muted);
        margin: 0 0 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .section-title span {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .section-pill {
        padding: 2px 7px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.45);
        font-size: 0.62rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-muted);
      }

      .upload-zone {
        margin-top: 2px;
        border-radius: var(--radius-lg);
        padding: 14px 11px;
        border: 1px dashed rgba(148, 163, 184, 0.65);
        background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.13), transparent 65%),
          radial-gradient(circle at 100% 100%, rgba(129, 140, 248, 0.2), transparent 70%),
          rgba(15, 23, 42, 0.88);
        display: flex;
        flex-direction: column;
        gap: 10px;
        cursor: pointer;
        transition: border-color 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease,
          background 0.2s ease;
      }

      .upload-zone:hover {
        border-color: rgba(129, 140, 248, 0.95);
        box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.7);
        transform: translateY(-1px);
      }

      .upload-zone.dragover {
        border-style: solid;
        border-color: rgba(56, 189, 248, 1);
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.8), 0 18px 60px rgba(8, 47, 73, 0.9);
        transform: translateY(-2px) scale(1.01);
      }

      .upload-main {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .upload-icon {
        width: 34px;
        height: 34px;
        border-radius: 14px;
        background: radial-gradient(circle at 30% 0, rgba(56, 189, 248, 0.8), #1d4ed8);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 16px 35px rgba(37, 99, 235, 0.7);
        color: #e5f5ff;
        flex-shrink: 0;
      }

      .upload-text-primary {
        font-size: 0.93rem;
        font-weight: 500;
      }

      .upload-text-secondary {
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .upload-cta-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-top: 4px;
      }

      .upload-cta {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent-strong);
        font-size: 0.78rem;
        border: 1px solid rgba(129, 140, 248, 0.7);
      }

      .upload-hint {
        font-size: 0.72rem;
        color: var(--text-muted);
      }

      .file-input {
        display: none;
      }

      .actions-row {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }

      .btn {
        position: relative;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.92));
        color: var(--text);
        font-size: 0.76rem;
        padding: 5px 10px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        white-space: nowrap;
        transition: border-color 0.16s ease, background 0.16s ease, transform 0.12s ease,
          box-shadow 0.12s ease;
      }

      .btn-primary {
        border-color: transparent;
        background: linear-gradient(130deg, #6366f1, #22c55e);
        color: white;
        box-shadow: 0 15px 35px rgba(79, 70, 229, 0.6);
      }

      .btn-soft {
        background: rgba(15, 23, 42, 0.9);
      }

      .btn-ghost {
        background: transparent;
      }

      .btn span.icon {
        font-size: 0.95em;
      }

      .btn:hover {
        transform: translateY(-1px);
        border-color: rgba(148, 163, 184, 0.8);
        box-shadow: 0 14px 32px rgba(15, 23, 42, 0.7);
      }

      .btn-primary:hover {
        box-shadow: 0 22px 45px rgba(79, 70, 229, 0.7);
      }

      .btn:active {
        transform: translateY(0);
        box-shadow: none;
      }

      .btn[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .sidebar-section {
        margin-top: 14px;
        padding-top: 10px;
        border-top: 1px solid rgba(148, 163, 184, 0.25);
      }

      .field-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 8px;
      }

      .field-label {
        font-size: 0.78rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
      }

      .field-label strong {
        font-weight: 500;
        color: var(--text);
      }

      .field-label small {
        font-size: 0.7rem;
      }

      .field-control {
        position: relative;
      }

      select,
      input[type="color"],
      input[type="number"],
      input[type="text"] {
        width: 100%;
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.45);
        padding: 7px 9px;
        font-size: 0.8rem;
        background: var(--input-bg);
        color: var(--text);
        outline: none;
        transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
      }

      select:focus,
      input[type="color"]:focus,
      input[type="number"]:focus,
      input[type="text"]:focus {
        border-color: rgba(129, 140, 248, 0.9);
        box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.9);
      }

      input[type="color"] {
        padding: 0;
        height: 30px;
        cursor: pointer;
      }

      .checkbox-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.5);
        font-size: 0.75rem;
        cursor: pointer;
      }

      .chip input {
        pointer-events: none;
      }

      .chip input[type="checkbox"] {
        accent-color: #6366f1;
      }

      .chip.active {
        background: rgba(79, 70, 229, 0.2);
        border-color: rgba(129, 140, 248, 0.9);
        box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.9);
      }

      .mini-toggle {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.72rem;
        color: var(--text-muted);
      }

      .mini-toggle input[type="checkbox"] {
        width: 28px;
        height: 14px;
        border-radius: 999px;
        appearance: none;
        border: 1px solid rgba(148, 163, 184, 0.7);
        background: rgba(15, 23, 42, 0.9);
        position: relative;
        outline: none;
        cursor: pointer;
        transition: background 0.15s ease, border-color 0.15s ease;
      }

      .mini-toggle input[type="checkbox"]::before {
        content: "";
        position: absolute;
        top: 1px;
        left: 1px;
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #e5e7eb;
        transition: transform 0.16s ease;
      }

      .mini-toggle input[type="checkbox"]:checked {
        background: var(--accent-gradient);
        border-color: transparent;
      }

      .mini-toggle input[type="checkbox"]:checked::before {
        transform: translateX(12px);
      }

      .preview-section {
        margin-top: 10px;
        border-radius: var(--radius-lg);
        padding: 9px 9px 7px;
        background: rgba(15, 23, 42, 0.86);
        border: 1px solid rgba(148, 163, 184, 0.35);
        max-height: 170px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      .preview-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 3px 6px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(148, 163, 184, 0.38);
        font-size: 0.68rem;
      }

      .preview-table-wrapper {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), #020617);
        border: 1px solid rgba(15, 23, 42, 0.9);
      }

      .preview-table-scroll {
        max-height: 120px;
        overflow: auto;
      }

      .preview-table-scroll::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      .preview-table-scroll::-webkit-scrollbar-thumb {
        background: var(--scrollbar);
        border-radius: 999px;
      }

      .preview-table-scroll::-webkit-scrollbar-track {
        background: var(--scrollbar-bg);
      }

      table.preview-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.7rem;
      }

      table.preview-table thead {
        position: sticky;
        top: 0;
        z-index: 1;
        background: rgba(15, 23, 42, 0.96);
      }

      table.preview-table th,
      table.preview-table td {
        padding: 4px 6px;
        border-bottom: 1px solid rgba(30, 64, 175, 0.45);
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }

      table.preview-table th {
        font-weight: 500;
        color: #bfdbfe;
      }

      table.preview-table tbody tr:nth-child(2n) {
        background: rgba(15, 23, 42, 0.9);
      }

      table.preview-table tbody tr:hover {
        background: rgba(79, 70, 229, 0.2);
      }

      .empty-state {
        text-align: center;
        font-size: 0.8rem;
        color: var(--text-muted);
        padding: 16px 0 4px;
      }

      .chart-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }

      .chart-toolbar-main {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
      }

      .chart-toolbar-sub {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
        font-size: 0.76rem;
        color: var(--text-muted);
      }

      .pill-select {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: rgba(15, 23, 42, 0.9);
        font-size: 0.76rem;
      }

      .pill-select select {
        width: auto;
        border-radius: 999px;
        border: none;
        background: transparent;
        padding: 0 2px 0 0;
        font-size: 0.76rem;
      }

      .chart-canvas-wrap {
        position: relative;
        border-radius: var(--radius-lg);
        overflow: hidden;
        background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(2, 6, 23, 0.98));
        border: 1px solid rgba(30, 64, 175, 0.8);
        min-height: 280px;
      }

      @media (min-height: 800px) {
        .chart-canvas-wrap {
          min-height: 340px;
        }
      }

      .chart-gradient-overlay {
        position: absolute;
        inset: -30%;
        background:
          radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.18), transparent 60%),
          radial-gradient(circle at 100% 0, rgba(129, 140, 248, 0.16), transparent 60%),
          radial-gradient(circle at 0 100%, rgba(45, 212, 191, 0.16), transparent 60%);
        opacity: 0.9;
        mix-blend-mode: screen;
        pointer-events: none;
      }

      .chart-canvas {
        position: relative;
        z-index: 1;
        padding: 12px;
      }

      .chart-placeholder {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 10px;
        z-index: 0;
        pointer-events: none;
        color: var(--text-muted);
        text-align: center;
      }

      .chart-placeholder-icon {
        width: 56px;
        height: 56px;
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      }

      .chart-placeholder-title {
        font-size: 0.96rem;
        font-weight: 500;
      }

      .chart-placeholder-sub {
        font-size: 0.8rem;
        max-width: 260px;
      }

      .badge-subtle {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 7px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.45);
        font-size: 0.66rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .pill-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #6366f1;
      }

      .chart-footer {
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        font-size: 0.74rem;
        color: var(--text-muted);
      }

      .chart-footer span strong {
        font-weight: 500;
        color: var(--text);
      }

      .pill-inline {
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.4);
        font-size: 0.68rem;
      }

      .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 0, #22c55e, #15803d);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.35);
      }

      .status-text {
        font-size: 0.72rem;
      }

      .pill-counter {
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.45);
        font-size: 0.7rem;
      }

      .text-danger {
        color: #f97373;
      }

      .text-success {
        color: #4ade80;
      }

      .fade-in {
        animation: fadeIn 0.35s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="page" id="root">
      <header class="header-row">
        <div class="title-block">
          <h1>
            Data Visualization Playground
            <span class="title-pill">CSV â†’ Interactive Charts</span>
          </h1>
          <div class="title-main">Turn raw CSV into polished visuals.</div>
          <div class="title-sub">
            Upload data, map your columns, fineâ€‘tune colors, and export beautiful chart
            images in seconds.
          </div>
        </div>
        <div class="header-actions">
          <div class="badge">
            <span class="badge-dot"></span>
            Live preview
          </div>
          <label class="theme-toggle" id="themeToggle">
            <span id="themeLabel">Dark</span>
            <div class="toggle-pill">
              <div class="toggle-thumb"></div>
            </div>
            <input type="checkbox" aria-label="Toggle theme" />
          </label>
        </div>
      </header>

      <main class="shell">
        <aside class="sidebar">
          <div class="sidebar-inner">
            <h2 class="section-title">
              <span>1. Data source</span>
              <span class="section-pill">CSV upload</span>
            </h2>

            <label class="upload-zone" id="dropZone">
              <div class="upload-main">
                <div class="upload-icon" aria-hidden="true">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.6"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="16 16 12 12 8 16"></polyline>
                    <line x1="12" y1="12" x2="12" y2="21"></line>
                    <path
                      d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"
                    ></path>
                  </svg>
                </div>
                <div>
                  <div class="upload-text-primary">
                    Drop a CSV file here
                  </div>
                  <div class="upload-text-secondary">
                    Or browse from your device to get started.
                  </div>
                </div>
              </div>
              <div class="upload-cta-row">
                <button
                  type="button"
                  class="btn btn-primary"
                  id="browseButton"
                  aria-label="Browse for CSV file"
                >
                  <span class="icon">ðŸ“‚</span>
                  Choose CSV
                </button>
                <div class="upload-hint">
                  <span>Supports headers, numbers & dates.</span>
                </div>
              </div>
              <input
                id="csvInput"
                class="file-input"
                type="file"
                accept=".csv,text/csv"
              />
            </label>

            <div class="actions-row">
              <button type="button" class="btn btn-soft" id="sampleDataBtn">
                <span class="icon">âœ¨</span>
                Load sample data
              </button>
              <button
                type="button"
                class="btn btn-ghost"
                id="resetBtn"
                title="Clear data and start fresh"
              >
                <span class="icon">â†º</span>
                Reset
              </button>
            </div>

            <section class="sidebar-section">
              <h2 class="section-title">
                <span>2. Map columns</span>
                <span class="section-pill" id="columnCountLabel">Waiting for CSVâ€¦</span>
              </h2>

              <div id="mappingControls">
                <div class="empty-state" id="mappingEmptyState">
                  Once your CSV is loaded, choose which columns to use on the axes and in each
                  series.
                </div>
                <div id="mappingForm" class="fade-in" style="display: none">
                  <div class="field-group">
                    <label class="field-label" for="labelColumn">
                      <strong>Label axis</strong>
                      <small>Typically a category or date</small>
                    </label>
                    <div class="field-control">
                      <select id="labelColumn"></select>
                    </div>
                  </div>
                  <div class="field-group">
                    <div class="field-label">
                      <strong>Value columns</strong>
                      <small id="valueHint">Select numeric fields</small>
                    </div>
                    <div class="checkbox-row" id="valueColumns"></div>
                  </div>
                  <div class="field-group">
                    <div class="field-label">
                      <strong>Interpretation</strong>
                      <small>How to treat xâ€‘axis</small>
                    </div>
                    <div class="checkbox-row">
                      <label class="chip active" id="asCategoryChip">
                        <input
                          type="radio"
                          name="xMode"
                          id="xAsCategory"
                          checked
                        />
                        Categories
                      </label>
                      <label class="chip" id="asContinuousChip">
                        <input
                          type="radio"
                          name="xMode"
                          id="xAsContinuous"
                        />
                        Continuous (index)
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="preview-section" id="previewSection" style="display: none">
                <div class="preview-header">
                  <span>Data preview</span>
                  <span class="preview-badge" id="rowCountBadge">
                    0 rows
                  </span>
                </div>
                <div class="preview-table-wrapper">
                  <div class="preview-table-scroll" id="previewTableWrapper"></div>
                </div>
              </div>
            </section>

            <section class="sidebar-section">
              <h2 class="section-title">
                <span>3. Style</span>
                <span class="section-pill">Color & options</span>
              </h2>
              <div class="field-group">
                <label class="field-label" for="chartType">
                  <strong>Chart type</strong>
                  <small id="chartTypeHint">Bar Â· Line Â· Area Â· Pieâ€¦</small>
                </label>
                <div class="field-control">
                  <select id="chartType">
                    <option value="line">Line</option>
                    <option value="area">Area</option>
                    <option value="bar" selected>Bar</option>
                    <option value="radar">Radar</option>
                    <option value="pie">Pie</option>
                    <option value="doughnut">Doughnut</option>
                    <option value="scatter">Scatter</option>
                  </select>
                </div>
              </div>
              <div class="field-group">
                <label class="field-label" for="baseColor">
                  <strong>Palette seed</strong>
                  <small>Used to generate series colors</small>
                </label>
                <div class="field-control">
                  <input type="color" id="baseColor" value="#6366f1" />
                </div>
              </div>
              <div class="field-group">
                <div class="field-label">
                  <strong>Chart options</strong>
                  <small>Fineâ€‘tune look & feel</small>
                </div>
                <div class="checkbox-row">
                  <label class="mini-toggle">
                    <input type="checkbox" id="smoothLines" checked />
                    Smooth lines
                  </label>
                  <label class="mini-toggle">
                    <input type="checkbox" id="stacked" />
                    Stack series
                  </label>
                  <label class="mini-toggle">
                    <input type="checkbox" id="showGrid" checked />
                    Gridlines
                  </label>
                </div>
              </div>
              <div class="field-group">
                <div class="field-label">
                  <strong>Legend & tooltips</strong>
                </div>
                <div class="checkbox-row">
                  <label class="mini-toggle">
                    <input type="checkbox" id="showLegend" checked />
                    Show legend
                  </label>
                  <label class="mini-toggle">
                    <input type="checkbox" id="showPoints" checked />
                    Data points
                  </label>
                </div>
              </div>
            </section>
          </div>
        </aside>

        <section class="chart-panel" aria-live="polite">
          <div class="chart-panel-inner">
            <div class="chart-toolbar">
              <div class="chart-toolbar-main">
                <div class="pill-select">
                  <span style="opacity: 0.7">Layout</span>
                  <select id="aspectRatio">
                    <option value="1.8">Widescreen</option>
                    <option value="1.4" selected>Standard</option>
                    <option value="1">Square</option>
                  </select>
                </div>
                <button
                  type="button"
                  class="btn btn-primary"
                  id="generateBtn"
                  disabled
                >
                  <span class="icon">â–¶</span>
                  Render chart
                </button>
                <button
                  type="button"
                  class="btn btn-soft"
                  id="downloadBtn"
                  disabled
                >
                  <span class="icon">ðŸ“·</span>
                  Save as PNG
                </button>
              </div>
              <div class="chart-toolbar-sub">
                <span class="status-indicator">
                  <span class="status-dot" id="statusDot"></span>
                  <span class="status-text" id="statusText">Waiting for dataâ€¦</span>
                </span>
                <span class="pill-counter" id="seriesBadge">0 series</span>
              </div>
            </div>

            <div class="chart-canvas-wrap">
              <div class="chart-gradient-overlay"></div>
              <div class="chart-placeholder" id="chartPlaceholder">
                <div class="chart-placeholder-icon">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="30"
                    height="30"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.7"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 3v18h18"
                    ></path>
                    <rect x="7" y="10" width="2.5" height="7" rx="0.6"></rect>
                    <rect x="11" y="7" width="2.5" height="10" rx="0.6"></rect>
                    <rect x="15" y="5" width="2.5" height="12" rx="0.6"></rect>
                  </svg>
                </div>
                <div>
                  <div class="chart-placeholder-title">
                    Your chart will appear here.
                  </div>
                  <div class="chart-placeholder-sub">
                    Upload a CSV, map the columns, then hit
                    <strong>Render chart</strong> to see your data come alive.
                  </div>
                </div>
                <div class="badge-subtle">
                  <span class="pill-dot"></span>
                  Tip: Hover the chart to inspect exact values.
                </div>
              </div>
              <div class="chart-canvas">
                <canvas id="chartCanvas"></canvas>
              </div>
            </div>

            <footer class="chart-footer">
              <span>
                <strong>CSV To Charts</strong> Â· Data Visualization Playground
              </span>
              <span>
                <span class="pill-inline" id="insightPill">
                  Ready when your data is.
                </span>
              </span>
            </footer>
          </div>
        </section>
      </main>
    </div>

    <script>
      (function () {
        const root = document.documentElement;
        const themeToggle = document.getElementById("themeToggle");
        const themeLabel = document.getElementById("themeLabel");
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("csvInput");
        const browseButton = document.getElementById("browseButton");
        const sampleDataBtn = document.getElementById("sampleDataBtn");
        const resetBtn = document.getElementById("resetBtn");
        const mappingEmptyState = document.getElementById("mappingEmptyState");
        const mappingForm = document.getElementById("mappingForm");
        const labelColumnSelect = document.getElementById("labelColumn");
        const valueColumnsContainer = document.getElementById("valueColumns");
        const xAsCategory = document.getElementById("xAsCategory");
        const xAsContinuous = document.getElementById("xAsContinuous");
        const asCategoryChip = document.getElementById("asCategoryChip");
        const asContinuousChip = document.getElementById("asContinuousChip");
        const previewSection = document.getElementById("previewSection");
        const previewTableWrapper = document.getElementById("previewTableWrapper");
        const rowCountBadge = document.getElementById("rowCountBadge");
        const columnCountLabel = document.getElementById("columnCountLabel");
        const chartTypeSelect = document.getElementById("chartType");
        const baseColorInput = document.getElementById("baseColor");
        const smoothLinesCheckbox = document.getElementById("smoothLines");
        const stackedCheckbox = document.getElementById("stacked");
        const showGridCheckbox = document.getElementById("showGrid");
        const showLegendCheckbox = document.getElementById("showLegend");
        const showPointsCheckbox = document.getElementById("showPoints");
        const generateBtn = document.getElementById("generateBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const aspectRatioSelect = document.getElementById("aspectRatio");
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");
        const seriesBadge = document.getElementById("seriesBadge");
        const chartPlaceholder = document.getElementById("chartPlaceholder");
        const chartCanvas = document.getElementById("chartCanvas");
        const insightPill = document.getElementById("insightPill");

        let parsedRows = [];
        let parsedFields = [];
        let currentChart = null;
        let lastInsightTimeout = null;

        function setTheme(mode) {
          root.setAttribute("data-theme", mode);
          themeLabel.textContent = mode === "light" ? "Light" : "Dark";
        }

        setTheme("dark");

        themeToggle.addEventListener("click", function () {
          const current = root.getAttribute("data-theme") || "dark";
          const next = current === "dark" ? "light" : "dark";
          setTheme(next);
        });

        function showStatus(message, variant) {
          statusText.textContent = message;
          if (variant === "error") {
            statusDot.style.background =
              "radial-gradient(circle at 30% 0, #f97373, #b91c1c)";
            statusDot.style.boxShadow = "0 0 0 3px rgba(248, 113, 113, 0.45)";
          } else if (variant === "success") {
            statusDot.style.background =
              "radial-gradient(circle at 30% 0, #22c55e, #15803d)";
            statusDot.style.boxShadow = "0 0 0 3px rgba(34, 197, 94, 0.35)";
          } else if (variant === "working") {
            statusDot.style.background =
              "radial-gradient(circle at 30% 0, #38bdf8, #075985)";
            statusDot.style.boxShadow = "0 0 0 3px rgba(56, 189, 248, 0.4)";
          } else {
            statusDot.style.background =
              "radial-gradient(circle at 30% 0, #6366f1, #312e81)";
            statusDot.style.boxShadow = "0 0 0 3px rgba(129, 140, 248, 0.45)";
          }
        }

        function setInsight(text) {
          if (!insightPill) return;
          insightPill.textContent = text;
        }

        function resetState() {
          parsedRows = [];
          parsedFields = [];
          if (currentChart) {
            currentChart.destroy();
            currentChart = null;
          }
          chartCanvas.getContext("2d").clearRect(0, 0, chartCanvas.width, chartCanvas.height);
          chartPlaceholder.style.display = "flex";
          previewSection.style.display = "none";
          mappingForm.style.display = "none";
          mappingEmptyState.style.display = "block";
          columnCountLabel.textContent = "Waiting for CSVâ€¦";
          rowCountBadge.textContent = "0 rows";
          valueColumnsContainer.innerHTML = "";
          labelColumnSelect.innerHTML = "";
          seriesBadge.textContent = "0 series";
          generateBtn.disabled = true;
          downloadBtn.disabled = true;
          setInsight("Ready when your data is.");
          showStatus("Waiting for dataâ€¦");
        }

        resetState();

        function parseCsvFile(file) {
          if (!file) return;
          showStatus("Parsing CSVâ€¦", "working");
          setInsight("Analyzing column types and headers.");

          Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: "greedy",
            complete: function (result) {
              handleParseResult(result, file && file.name);
            },
            error: function () {
              showStatus("Could not read the file. Try again.", "error");
              setInsight("The CSV could not be read.");
            },
          });
        }

        function handleParseResult(result, sourceName) {
          if (!result || !Array.isArray(result.data)) {
            showStatus("Unexpected CSV structure.", "error");
            return;
          }

          const rows = result.data.filter(function (row) {
            return row && Object.values(row).some(function (v) {
              return v !== null && v !== "";
            });
          });

          if (!rows.length) {
            showStatus("CSV appears to be empty.", "error");
            setInsight("Try a file with at least one row.");
            return;
          }

          const fields =
            (result.meta && result.meta.fields && result.meta.fields.length
              ? result.meta.fields
              : Object.keys(rows[0])) || [];

          if (!fields.length) {
            showStatus("Could not detect any columns.", "error");
            return;
          }

          parsedRows = rows;
          parsedFields = fields;

          setupMappingControls(fields, rows);
          renderPreviewTable(fields, rows);

          columnCountLabel.textContent =
            fields.length + " column" + (fields.length > 1 ? "s" : "");
          rowCountBadge.textContent =
            rows.length + " row" + (rows.length > 1 ? "s" : "");

          chartPlaceholder.style.display = "flex";
          generateBtn.disabled = false;
          showStatus(
            "Parsed " +
              rows.length +
              " rows from " +
              fields.length +
              " column" +
              (fields.length > 1 ? "s" : "") +
              (sourceName ? " (" + sourceName + ")" : ""),
            "success"
          );
          setInsight("Pick a chart type and hit Render.");
        }

        function isNumericColumn(field, rows) {
          let numericCount = 0;
          let sampled = 0;
          for (let i = 0; i < rows.length && sampled < 24; i++) {
            const v = rows[i][field];
            if (v === null || v === "" || typeof v === "undefined") continue;
            sampled++;
            if (typeof v === "number") numericCount++;
            else if (typeof v === "string" && v.trim() !== "") {
              const num = Number(v.replace(/,/g, ""));
              if (!isNaN(num)) numericCount++;
            }
          }
          if (!sampled) return false;
          return numericCount / sampled >= 0.6;
        }

        function setupMappingControls(fields, rows) {
          mappingEmptyState.style.display = "none";
          mappingForm.style.display = "block";
          labelColumnSelect.innerHTML = "";
          valueColumnsContainer.innerHTML = "";

          fields.forEach(function (field, index) {
            const opt = document.createElement("option");
            opt.value = field;
            opt.textContent = field;
            labelColumnSelect.appendChild(opt);
            if (index === 0) {
              opt.selected = true;
            }
          });

          let numericFields = [];
          fields.forEach(function (field) {
            if (isNumericColumn(field, rows)) {
              numericFields.push(field);
            }
          });

          if (!numericFields.length && fields.length > 1) {
            numericFields = fields.slice(1);
          }

          fields.forEach(function (field) {
            const id = "value-" + field.replace(/\W+/g, "_");
            const isNumeric = numericFields.indexOf(field) !== -1;
            const chip = document.createElement("label");
            chip.className = "chip" + (isNumeric ? " active" : "");

            const input = document.createElement("input");
            input.type = "checkbox";
            input.id = id;
            input.value = field;
            input.checked = isNumeric;

            chip.appendChild(input);
            chip.appendChild(document.createTextNode(field));

            chip.addEventListener("click", function (ev) {
              if (ev.target.tagName.toLowerCase() !== "input") {
                input.checked = !input.checked;
              }
              chip.classList.toggle("active", input.checked);
              updateSeriesBadge();
            });

            valueColumnsContainer.appendChild(chip);
          });

          xAsCategory.checked = true;
          xAsContinuous.checked = false;
          asCategoryChip.classList.add("active");
          asContinuousChip.classList.remove("active");
          updateSeriesBadge();
          previewSection.style.display = "flex";
        }

        function renderPreviewTable(fields, rows) {
          previewTableWrapper.innerHTML = "";
          const table = document.createElement("table");
          table.className = "preview-table";

          const thead = document.createElement("thead");
          const headRow = document.createElement("tr");
          fields.forEach(function (field) {
            const th = document.createElement("th");
            th.textContent = field;
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);

          const tbody = document.createElement("tbody");
          const limit = Math.min(rows.length, 24);
          for (let i = 0; i < limit; i++) {
            const row = document.createElement("tr");
            fields.forEach(function (field) {
              const td = document.createElement("td");
              let value = rows[i][field];
              if (value === null || typeof value === "undefined") {
                value = "";
              }
              if (typeof value === "number") {
                const abs = Math.abs(value);
                if (abs >= 1000) {
                  value = value.toLocaleString();
                }
              }
              td.textContent = value;
              row.appendChild(td);
            });
            tbody.appendChild(row);
          }

          table.appendChild(thead);
          table.appendChild(tbody);
          previewTableWrapper.appendChild(table);
        }

        function getSelectedValueColumns() {
          const chips = valueColumnsContainer.querySelectorAll("input[type=checkbox]");
          const fields = [];
          chips.forEach(function (input) {
            if (input.checked) fields.push(input.value);
          });
          return fields;
        }

        function updateSeriesBadge() {
          const count = getSelectedValueColumns().length;
          seriesBadge.textContent = count + " series";
        }

        asCategoryChip.addEventListener("click", function () {
          asCategoryChip.classList.add("active");
          asContinuousChip.classList.remove("active");
          xAsCategory.checked = true;
          xAsContinuous.checked = false;
        });

        asContinuousChip.addEventListener("click", function () {
          asCategoryChip.classList.remove("active");
          asContinuousChip.classList.add("active");
          xAsCategory.checked = false;
          xAsContinuous.checked = true;
        });

        browseButton.addEventListener("click", function () {
          fileInput.click();
        });

        fileInput.addEventListener("change", function (ev) {
          const file = ev.target.files && ev.target.files[0];
          parseCsvFile(file);
        });

        ["dragenter", "dragover"].forEach(function (eventName) {
          dropZone.addEventListener(
            eventName,
            function (ev) {
              ev.preventDefault();
              ev.stopPropagation();
              dropZone.classList.add("dragover");
            },
            false
          );
        });

        ["dragleave", "drop"].forEach(function (eventName) {
          dropZone.addEventListener(
            eventName,
            function (ev) {
              ev.preventDefault();
              ev.stopPropagation();
              dropZone.classList.remove("dragover");
            },
            false
          );
        });

        dropZone.addEventListener(
          "drop",
          function (ev) {
            const dt = ev.dataTransfer;
            if (dt && dt.files && dt.files.length) {
              const file = dt.files[0];
              parseCsvFile(file);
            }
          },
          false
        );

        const SAMPLE_CSV = [
          "Month,Revenue,Cost,Visitors",
          "Jan,42000,28000,120000",
          "Feb,46000,31000,136000",
          "Mar,51000,33000,142000",
          "Apr,53000,34000,150000",
          "May,58000,36000,158000",
          "Jun,60000,39000,164000",
          "Jul,64000,41000,172000",
          "Aug,66000,43000,178000",
          "Sep,69000,45000,182000",
          "Oct,71000,46000,188000",
          "Nov,73000,47000,190000",
          "Dec,76000,49000,196000",
        ].join("\n");

        sampleDataBtn.addEventListener("click", function () {
          showStatus("Loading sample SaaS metricsâ€¦", "working");
          setInsight("Great for trying out chart types.");

          Papa.parse(SAMPLE_CSV, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function (result) {
              handleParseResult(result, "Sample SaaS metrics");
            },
          });
        });

        resetBtn.addEventListener("click", function () {
          fileInput.value = "";
          resetState();
        });

        function hexToHsl(hex) {
          let c = hex.replace("#", "").trim();
          if (c.length === 3) {
            c = c
              .split("")
              .map(function (ch) {
                return ch + ch;
              })
              .join("");
          }
          if (c.length !== 6) {
            return { h: 230, s: 85, l: 60 };
          }
          const r = parseInt(c.slice(0, 2), 16) / 255;
          const g = parseInt(c.slice(2, 4), 16) / 255;
          const b = parseInt(c.slice(4, 6), 16) / 255;
          const max = Math.max(r, g, b);
          const min = Math.min(r, g, b);
          const delta = max - min;
          let h = 0;
          let s = 0;
          const l = (max + min) / 2;

          if (delta !== 0) {
            if (max === r) {
              h = ((g - b) / delta) % 6;
            } else if (max === g) {
              h = (b - r) / delta + 2;
            } else {
              h = (r - g) / delta + 4;
            }
            h = Math.round(h * 60);
            if (h < 0) h += 360;
            s = delta / (1 - Math.abs(2 * l - 1));
          }
          return { h: h, s: Math.round(s * 100), l: Math.round(l * 100) };
        }

        function hslToCss(h, s, l, alpha) {
          if (typeof alpha === "number") {
            return "hsla(" + h + ", " + s + "%, " + l + "%, " + alpha + ")";
          }
          return "hsl(" + h + ", " + s + "%, " + l + "%)";
        }

        function generatePalette(count, baseHex) {
          const base = hexToHsl(baseHex || "#6366f1");
          const colors = [];
          const step = count > 1 ? 280 / Math.max(count - 1, 1) : 0;
          for (let i = 0; i < count; i++) {
            const h = (base.h + i * step) % 360;
            const l = Math.min(80, Math.max(25, base.l + (i - count / 2) * 5));
            const solid = hslToCss(h, Math.min(95, base.s + 5), l);
            const soft = hslToCss(h, Math.min(95, base.s + 5), Math.min(90, l + 18), 0.18);
            colors.push({ solid: solid, soft: soft });
          }
          return colors;
        }

        function buildChartConfig() {
          if (!parsedRows.length || !parsedFields.length) {
            showStatus("Load a CSV first.", "error");
            return null;
          }

          const chartType = chartTypeSelect.value || "bar";
          const labelField = labelColumnSelect.value || parsedFields[0];
          const valueFields = getSelectedValueColumns();

          if (!valueFields.length) {
            showStatus("Select at least one value column.", "error");
            setInsight("Pick one or more numeric columns.");
            return null;
          }

          if (chartType === "scatter" && valueFields.length < 2) {
            showStatus("Scatter requires two numeric columns.", "error");
            setInsight("Choose two columns: one for X, one for Y.");
            return null;
          }

          const asCategory = xAsCategory.checked || chartType === "pie" || chartType === "doughnut";

          let labels = [];
          const datasets = [];

          if (chartType === "scatter") {
            const xField = valueFields[0];
            const yField = valueFields[1];
            labels = [];
            parsedRows.forEach(function (row) {
              const x = Number(row[xField]);
              const y = Number(row[yField]);
              if (!isNaN(x) && !isNaN(y)) {
                labels.push({ x: x, y: y });
              }
            });

            const palette = generatePalette(1, baseColorInput.value);
            datasets.push({
              label: xField + " vs " + yField,
              data: labels,
              backgroundColor: palette[0].solid,
              borderColor: palette[0].solid,
              pointRadius: showPointsCheckbox.checked ? 4 : 0,
            });
          } else if (chartType === "pie" || chartType === "doughnut") {
            labels = [];
            const sums = {};
            parsedRows.forEach(function (row) {
              const key = String(row[labelField]);
              if (!sums[key]) sums[key] = 0;
              const field = valueFields[0];
              const num = Number(row[field]);
              if (!isNaN(num)) sums[key] += num;
            });
            Object.keys(sums).forEach(function (k) {
              labels.push(k);
            });
            const data = labels.map(function (label) {
              return sums[label];
            });

            const palette = generatePalette(labels.length, baseColorInput.value);
            datasets.push({
              label: valueFields[0],
              data: data,
              backgroundColor: palette.map(function (c) {
                return c.soft;
              }),
              borderColor: palette.map(function (c) {
                return c.solid;
              }),
              borderWidth: 1.4,
            });
          } else {
            if (asCategory) {
              labels = parsedRows.map(function (row, idx) {
                const value = row[labelField];
                if (typeof value === "undefined" || value === null || value === "") {
                  return "Row " + (idx + 1);
                }
                return String(value);
              });
            } else {
              labels = parsedRows.map(function (_row, idx) {
                return idx + 1;
              });
            }

            const palette = generatePalette(valueFields.length, baseColorInput.value);
            valueFields.forEach(function (field, index) {
              const data = parsedRows.map(function (row) {
                const v = row[field];
                if (typeof v === "number") return v;
                if (typeof v === "string" && v.trim() !== "") {
                  const num = Number(v.replace(/,/g, ""));
                  return isNaN(num) ? null : num;
                }
                return null;
              });
              const filteredData = data.map(function (v) {
                return typeof v === "number" ? v : null;
              });

              const paletteItem = palette[index];
              const solidColor = paletteItem.solid;
              const softColor = paletteItem.soft;

              const common = {
                label: field,
                data: filteredData,
                borderColor: solidColor,
                backgroundColor:
                  chartType === "bar" || chartType === "radar"
                    ? softColor
                    : hslToCss(
                        hexToHsl(baseColorInput.value).h,
                        hexToHsl(baseColorInput.value).s,
                        Math.max(25, hexToHsl(baseColorInput.value).l - 8),
                        0.18
                      ),
                borderWidth: chartType === "bar" ? 1.4 : 2,
                pointRadius: showPointsCheckbox.checked && chartType !== "radar" ? 3 : 0,
                pointHoverRadius: showPointsCheckbox.checked && chartType !== "radar" ? 5 : 0,
                tension: smoothLinesCheckbox.checked ? 0.35 : 0.04,
              };

              datasets.push(common);
            });
          }

          const isLineLike = chartType === "line" || chartType === "area";
          const isBar = chartType === "bar";

          const mainType =
            chartType === "area" ? "line" : chartType === "scatter" ? "scatter" : chartType;

          if (chartType === "area") {
            datasets.forEach(function (ds) {
              ds.fill = true;
              if (!ds.backgroundColor || typeof ds.backgroundColor === "string") {
                ds.backgroundColor = "rgba(99, 102, 241, 0.16)";
              }
            });
          }

          const ratio = Number(aspectRatioSelect.value) || 1.4;
          const options = {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: ratio,
            interaction: {
              mode: chartType === "pie" || chartType === "doughnut" ? "nearest" : "index",
              intersect: false,
            },
            plugins: {
              legend: {
                display: showLegendCheckbox.checked,
                labels: {
                  usePointStyle: true,
                  padding: 18,
                  boxWidth: 8,
                  color: getComputedStyle(root).getPropertyValue("--text"),
                },
              },
              tooltip: {
                enabled: true,
                displayColors: true,
                backgroundColor: "rgba(15, 23, 42, 0.95)",
                borderColor: "rgba(148, 163, 184, 0.65)",
                borderWidth: 1,
                padding: 10,
                titleFont: { weight: "600" },
                bodySpacing: 6,
              },
              title: {
                display: false,
              },
            },
            scales: {},
          };

          if (!["pie", "doughnut"].includes(chartType)) {
            options.scales.x = {
              grid: {
                display: showGridCheckbox.checked,
                color: "rgba(30, 64, 175, 0.5)",
                drawBorder: false,
              },
              ticks: {
                maxRotation: 60,
                minRotation: 0,
                color: getComputedStyle(root).getPropertyValue("--text-muted"),
              },
            };
            options.scales.y = {
              beginAtZero: true,
              grid: {
                display: showGridCheckbox.checked,
                color: "rgba(15, 23, 42, 0.7)",
                drawBorder: false,
              },
              ticks: {
                color: getComputedStyle(root).getPropertyValue("--text-muted"),
              },
              stacked: stackedCheckbox.checked && (isBar || isLineLike),
            };
          }

          if (isBar || isLineLike) {
            options.scales.x.stacked = stackedCheckbox.checked;
          }

          const config = {
            type: mainType,
            data: {
              labels: chartType === "scatter" ? undefined : labels,
              datasets: datasets,
            },
            options: options,
          };

          return config;
        }

        function renderChart() {
          const config = buildChartConfig();
          if (!config) return;

          if (currentChart) {
            currentChart.destroy();
          }

          chartPlaceholder.style.display = "none";
          showStatus("Rendering chartâ€¦", "working");

          currentChart = new Chart(chartCanvas.getContext("2d"), config);
          downloadBtn.disabled = false;

          const valueFields = getSelectedValueColumns();
          if (valueFields.length === 1) {
            setInsight("Singleâ€‘series chart ready. Try adding more measures.");
          } else if (valueFields.length >= 3) {
            setInsight("Multiâ€‘series view: toggle legend labels to isolate trends.");
          } else {
            setInsight("Hover the chart to inspect exact values.");
          }

          showStatus("Chart updated with " + valueFields.length + " series.", "success");

          if (lastInsightTimeout) {
            clearTimeout(lastInsightTimeout);
          }
          lastInsightTimeout = setTimeout(function () {
            if (chartTypeSelect.value === "pie" || chartTypeSelect.value === "doughnut") {
              setInsight("Pie labels too crowded? Try Bar or Line.");
            }
          }, 4000);
        }

        generateBtn.addEventListener("click", renderChart);

        [chartTypeSelect, baseColorInput, smoothLinesCheckbox, stackedCheckbox, showGridCheckbox,
        showLegendCheckbox, showPointsCheckbox, aspectRatioSelect].forEach(function (el) {
          el.addEventListener("change", function () {
            if (currentChart) {
              renderChart();
            }
          });
        });

        [labelColumnSelect, valueColumnsContainer, xAsCategory, xAsContinuous].forEach(function (
          el
        ) {
          if (!el) return;
          el.addEventListener("change", function () {
            updateSeriesBadge();
            if (currentChart) renderChart();
          });
        });

        downloadBtn.addEventListener("click", function () {
          if (!currentChart) return;
          try {
            const dataUrl = currentChart.toBase64Image("image/png", 1);
            const link = document.createElement("a");
            const now = new Date();
            const timestamp =
              now.getFullYear().toString() +
              "-" +
              String(now.getMonth() + 1).padStart(2, "0") +
              "-" +
              String(now.getDate()).padStart(2, "0") +
              "_" +
              String(now.getHours()).padStart(2, "0") +
              String(now.getMinutes()).padStart(2, "0");
            link.href = dataUrl;
            link.download = "csv-chart-" + timestamp + ".png";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus("PNG exported successfully.", "success");
            setInsight("Saved snapshot. Try another chart angle.");
          } catch (e) {
            showStatus("Could not save chart image.", "error");
            setInsight("Some browsers block automatic downloads.");
          }
        });

        window.addEventListener("resize", function () {
          if (currentChart) {
            currentChart.resize();
          }
        });
      })();
    </script>
  </body>
</html>

