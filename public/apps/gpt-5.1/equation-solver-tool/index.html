<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Equation Solver Tool</title>

  <!-- External math library (used for safe parsing & evaluation) -->
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.9.1/lib/browser/math.min.js"></script>

  <style>
    :root {
      --bg-page: #f7f7fb;
      --bg-card: #ffffff;
      --accent: #1b4f72;
      --accent-soft: #e1ecfa;
      --accent-strong: #0b3a5e;
      --border-subtle: #d0d5dd;
      --text-main: #111827;
      --text-muted: #6b7280;
      --danger: #b91c1c;
      --danger-soft: #fee2e2;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
      --shadow-subtle: 0 1px 3px rgba(15, 23, 42, 0.08);
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      --font-mono: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: var(--font-sans);
      background: radial-gradient(circle at top left, #f0f4ff 0, var(--bg-page) 50%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .shell {
      max-width: 1120px;
      margin: 32px auto 40px;
      padding: 0 16px;
      width: 100%;
    }

    header.app-header {
      margin-bottom: 24px;
    }

    .app-title-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .app-title {
      font-size: 1.9rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-weight: 650;
      color: var(--accent-strong);
    }

    .app-subtitle {
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .badge {
      font-size: 0.68rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(27, 79, 114, 0.16);
      background-color: rgba(255, 255, 255, 0.8);
      color: var(--accent-strong);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.18);
    }

    .card-frame {
      background-color: rgba(255, 255, 255, 0.85);
      border-radius: 32px;
      box-shadow: var(--shadow-soft);
      padding: 2px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      backdrop-filter: blur(18px);
    }

    main.app-main {
      background-color: var(--bg-card);
      border-radius: 28px;
      padding: 22px 24px 24px;
      position: relative;
      overflow: hidden;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 24px;
    }

    @media (max-width: 880px) {
      .shell {
        margin-top: 20px;
      }

      main.app-main {
        padding: 18px 16px 18px;
      }

      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .column {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section-label {
      font-size: 0.8rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .panel {
      background-color: #f9fafb;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 16px 16px 14px;
      box-shadow: var(--shadow-subtle);
      position: relative;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid rgba(37, 99, 235, 0.04);
      pointer-events: none;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 8px;
    }

    .panel-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent-strong);
    }

    .panel-meta {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      padding: 8px 10px;
      font-size: 0.92rem;
      font-family: var(--font-mono);
      resize: vertical;
      min-height: 42px;
      background-color: #ffffff;
      transition: border-color 0.12s ease, box-shadow 0.12s ease,
        background-color 0.12s ease;
    }

    textarea {
      min-height: 72px;
      line-height: 1.4;
    }

    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: rgba(37, 99, 235, 0.6);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
      background-color: #ffffff;
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .variable-field {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .variable-input {
      width: 40px;
      padding-inline: 6px;
      text-align: center;
    }

    .hint {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .hint code {
      font-family: var(--font-mono);
      background-color: rgba(15, 23, 42, 0.04);
      padding: 1px 4px;
      border-radius: 4px;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    button {
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.85rem;
      font-weight: 500;
      padding: 7px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background-color: #f3f4f6;
      color: var(--text-main);
      transition: background-color 0.12s ease, box-shadow 0.12s ease,
        transform 0.06s ease, border-color 0.12s ease, color 0.12s ease;
    }

    button:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.45);
    }

    button.primary {
      background: radial-gradient(circle at 10% 0, #4f9cff, #1d4ed8);
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
    }

    button.primary:hover {
      background: radial-gradient(circle at 10% 0, #387ff5, #1d4ed8);
      transform: translateY(-0.5px);
      box-shadow: 0 10px 26px rgba(37, 99, 235, 0.42);
    }

    button.secondary {
      background-color: #f3f4f6;
      color: var(--text-muted);
      border-color: rgba(148, 163, 184, 0.6);
    }

    button.secondary:hover {
      background-color: #e5e7eb;
      color: #374151;
    }

    button.ghost {
      background-color: transparent;
      border-color: transparent;
      color: var(--accent-strong);
      padding-inline: 6px;
    }

    button.ghost:hover {
      background-color: rgba(37, 99, 235, 0.06);
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .icon {
      font-size: 0.95em;
      line-height: 1;
    }

    .error-banner {
      display: none;
      margin-top: 10px;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid var(--danger);
      background-color: var(--danger-soft);
      color: var(--danger);
      font-size: 0.8rem;
      line-height: 1.35;
    }

    .error-banner.active {
      display: block;
    }

    .error-banner strong {
      font-weight: 600;
    }

    .pseudo-label {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .solution-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .solution-main {
      font-size: 1.12rem;
      font-weight: 600;
      color: var(--accent-strong);
      font-family: var(--font-mono);
    }

    .solution-tag {
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(27, 79, 114, 0.35);
      background-color: rgba(27, 79, 114, 0.05);
      color: var(--accent-strong);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .solution-summary {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .steps {
      list-style: none;
      padding: 0;
      margin: 0;
      counter-reset: step-counter;
    }

    .step-item {
      position: relative;
      padding-left: 28px;
      padding-top: 4px;
      padding-bottom: 4px;
    }

    .step-item + .step-item {
      margin-top: 6px;
      border-top: 1px dashed rgba(148, 163, 184, 0.6);
      padding-top: 10px;
    }

    .step-index {
      position: absolute;
      left: 0;
      top: 6px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background-color: var(--accent-soft);
      color: var(--accent-strong);
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .step-title {
      font-size: 0.86rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .step-text {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .step-expression {
      font-family: var(--font-mono);
      font-size: 0.78rem;
      padding: 2px 5px;
      border-radius: 6px;
      background-color: rgba(15, 23, 42, 0.03);
      margin-top: 3px;
      display: inline-block;
    }

    .placeholder {
      font-size: 0.82rem;
      color: var(--text-muted);
      background-color: #f9fafb;
      border-radius: var(--radius-md);
      border: 1px dashed rgba(156, 163, 175, 0.7);
      padding: 10px 12px;
    }

    .toolbar {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }

    .toolbar-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .toolbar-note {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .toolbar-note code {
      font-family: var(--font-mono);
      background-color: rgba(15, 23, 42, 0.04);
      padding: 1px 4px;
      border-radius: 4px;
    }

    .history {
      margin-top: 3px;
      border-radius: var(--radius-lg);
      border: 1px dashed rgba(156, 163, 175, 0.7);
      padding: 8px 10px 8px;
      background-color: #f9fafb;
    }

    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .history-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }

    .history-content {
      display: flex;
      flex-direction: column;
      gap: 3px;
      max-height: 156px;
      overflow-y: auto;
    }

    .history-empty {
      font-size: 0.78rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .history-item {
      font-size: 0.8rem;
      padding: 5px 7px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: baseline;
      gap: 6px;
      transition: background-color 0.12s ease, transform 0.06s ease;
    }

    .history-item:hover {
      background-color: rgba(37, 99, 235, 0.06);
      transform: translateY(-0.5px);
    }

    .history-item-label {
      font-family: var(--font-mono);
      white-space: nowrap;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-item-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .history-chip {
      font-size: 0.68rem;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      color: #4b5563;
      background-color: rgba(248, 250, 252, 0.9);
    }

    .math-note {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    footer.app-footer {
      margin-top: 12px;
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    footer.app-footer code {
      font-family: var(--font-mono);
    }

    .pill-caption {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 2px 8px;
      background-color: rgba(248, 250, 252, 0.9);
    }

    .math-engine-warning {
      display: none;
      margin-top: 8px;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid rgba(202, 138, 4, 0.9);
      background-color: #fef3c7;
      color: #92400e;
      font-size: 0.8rem;
    }

    .math-engine-warning.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="shell">
      <header class="app-header">
        <div class="app-title-row">
          <div>
            <div class="app-title">Equation Solver Tool</div>
            <div class="app-subtitle">
              Solve a single-variable equation and follow a clear, academic derivation from statement to solution.
            </div>
          </div>
          <div class="badge" aria-label="Interactive math workspace">
            <span class="badge-dot"></span>
            <span>Interactive Workspace</span>
          </div>
        </div>
      </header>

      <div class="card-frame">
        <main class="app-main" aria-label="Equation solver">
          <div class="grid">
            <!-- Input column -->
            <section class="column" aria-label="Equation input">
              <div>
                <div class="section-label">Input</div>
                <div class="panel">
                  <div class="panel-header">
                    <div class="panel-title">1. Enter an equation</div>
                    <div class="panel-meta">Linear, one variable (e.g. <code style="font-family: var(--font-mono);">x</code>)</div>
                  </div>

                  <label for="equation-input">Equation</label>
                  <textarea id="equation-input" spellcheck="false" autocomplete="off" rows="3"
                    placeholder="Examples:&#10;  2x + 3 = 11&#10;  3(x − 2) + 4 = 10&#10;  0.5x − 4 = 2"></textarea>

                  <div class="field-row">
                    <div class="variable-field">
                      <span>Solve for</span>
                      <input id="variable-name" class="variable-input" type="text" maxlength="8" value="x"
                        aria-label="Variable to solve for" />
                    </div>
                    <div class="hint">
                      The tool currently explains <strong>linear equations in one variable</strong>.
                    </div>
                  </div>

                  <div class="button-row">
                    <button id="solve-button" class="primary" type="button">
                      <span class="icon">⇒</span>
                      <span>Solve &amp; explain</span>
                    </button>
                    <button id="clear-button" class="secondary" type="button">
                      <span class="icon">⌫</span>
                      <span>Clear</span>
                    </button>
                    <button id="sample-button" class="ghost" type="button">
                      <span class="icon">★</span>
                      <span>Insert sample</span>
                    </button>
                  </div>

                  <div id="input-error" class="error-banner" role="alert" aria-live="polite"></div>

                  <div id="math-engine-warning" class="math-engine-warning" role="alert">
                    The underlying math engine did not load. You can still type equations, but solving is disabled until
                    the page can access the math library (math.js).
                  </div>
                </div>
              </div>

              <div>
                <div class="section-label">Notes</div>
                <div class="panel">
                  <div class="panel-header">
                    <div class="panel-title">How to read the derivation</div>
                  </div>
                  <div class="math-note">
                    - Each step states <strong>what</strong> algebraic move is applied and
                    <strong>why</strong> it is valid.<br />
                    - Coefficients and constants are simplified numerically (rounded sensibly).<br />
                    - If the equation is not linear in the chosen variable, the solver will indicate that the method no
                    longer applies.
                  </div>
                </div>
              </div>
            </section>

            <!-- Output column -->
            <section class="column" aria-label="Solution and explanation">
              <div>
                <div class="section-label">Solution</div>
                <div class="panel" id="solution-panel">
                  <div class="solution-header">
                    <div class="solution-main" id="solution-main">No equation solved yet</div>
                    <div class="solution-tag" id="solution-tag">Ready</div>
                  </div>
                  <div class="solution-summary" id="solution-summary">
                    Enter an equation on the left and choose <strong>Solve &amp; explain</strong> to see a structured
                    derivation here.
                  </div>

                  <div id="steps-container">
                    <div class="placeholder" id="steps-placeholder">
                      The full step-by-step derivation will appear here, with each algebraic move justified in plain
                      language.
                    </div>
                    <ol class="steps" id="steps-list" aria-live="polite"></ol>
                  </div>

                  <div class="toolbar">
                    <div class="toolbar-group">
                      <button id="export-txt-button" class="secondary" type="button" disabled>
                        <span class="icon">⬇︎</span>
                        <span>Export as text</span>
                      </button>
                      <button id="copy-button" class="secondary" type="button" disabled>
                        <span class="icon">⧉</span>
                        <span>Copy summary</span>
                      </button>
                    </div>
                    <div class="toolbar-note">
                      Export includes the original equation, solution classification, and all derivation steps.
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <div class="section-label">History</div>
                <div class="history" aria-label="Recent equations">
                  <div class="history-header">
                    <div class="history-title">Recent equations</div>
                    <span class="history-chip" id="history-chip">0 stored</span>
                  </div>
                  <div id="history-content" class="history-content">
                    <div class="history-empty">No equations solved yet. Your last few derivations will appear here.</div>
                  </div>
                </div>
              </div>
            </section>
          </div>

          <footer class="app-footer">
            <div>
              <span class="pill-caption">
                Scope: linear equations in one variable (e.g. <code>x</code>)
              </span>
            </div>
            <div>
              Method: collect like terms, isolate the variable, and solve <code>a·x + b = 0</code> analytically.
            </div>
          </footer>
        </main>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const eqInput = document.getElementById("equation-input");
      const varInput = document.getElementById("variable-name");
      const solveButton = document.getElementById("solve-button");
      const clearButton = document.getElementById("clear-button");
      const sampleButton = document.getElementById("sample-button");
      const inputError = document.getElementById("input-error");
      const mathEngineWarning = document.getElementById("math-engine-warning");

      const solutionMain = document.getElementById("solution-main");
      const solutionTag = document.getElementById("solution-tag");
      const solutionSummary = document.getElementById("solution-summary");
      const stepsPlaceholder = document.getElementById("steps-placeholder");
      const stepsList = document.getElementById("steps-list");

      const exportTxtButton = document.getElementById("export-txt-button");
      const copyButton = document.getElementById("copy-button");

      const historyContent = document.getElementById("history-content");
      const historyChip = document.getElementById("history-chip");

      const history = [];
      const MAX_HISTORY = 7;
      const EPS = 1e-10;
      let currentResult = null;

      function mathAvailable() {
        return typeof window.math !== "undefined";
      }

      function setMathEngineStatus() {
        if (!mathAvailable()) {
          mathEngineWarning.classList.add("active");
          solveButton.disabled = true;
        } else {
          mathEngineWarning.classList.remove("active");
          solveButton.disabled = false;
        }
      }

      function showError(message) {
        inputError.textContent = "";
        if (!message) {
          inputError.classList.remove("active");
          return;
        }
        const strong = document.createElement("strong");
        strong.textContent = "Unable to solve: ";
        const span = document.createElement("span");
        span.textContent = message;
        inputError.appendChild(strong);
        inputError.appendChild(span);
        inputError.classList.add("active");
      }

      function formatNumber(value) {
        if (!isFinite(value)) {
          return String(value);
        }
        if (Math.abs(value) < EPS) {
          return "0";
        }
        const roundedToInt = Math.round(value);
        if (Math.abs(value - roundedToInt) < 1e-8) {
          return String(roundedToInt);
        }
        const abs = Math.abs(value);
        if ((abs !== 0 && (abs >= 1e4 || abs <= 1e-4))) {
          return value.toExponential(4).replace("+", "");
        }
        return Number(value.toFixed(6)).toString();
      }

      function formatLinearExpression(a, b, variable) {
        const parts = [];
        const hasA = Math.abs(a) > EPS;
        const hasB = Math.abs(b) > EPS;

        if (!hasA && !hasB) {
          return "0";
        }

        if (hasA) {
          const coeff = formatNumber(a);
          if (coeff === "1") {
            parts.push(variable);
          } else if (coeff === "-1") {
            parts.push("-" + variable);
          } else {
            parts.push(coeff + variable);
          }
        }

        if (hasB) {
          const absB = Math.abs(b);
          const bStr = formatNumber(absB);
          if (!hasA) {
            parts.push((b < 0 ? "-" : "") + bStr);
          } else {
            const sign = b < 0 ? " - " : " + ";
            parts.push(sign + bStr);
          }
        }

        return parts.join("");
      }

      function classifySolution(a, b) {
        const aZero = Math.abs(a) < EPS;
        const bZero = Math.abs(b) < EPS;
        if (aZero && bZero) {
          return "infinite";
        }
        if (aZero && !bZero) {
          return "none";
        }
        return "unique";
      }

      function parseEquation(raw) {
        const text = raw.replace(/\s+/g, " ").trim();
        if (!text) {
          throw new Error("Please enter an equation to solve.");
        }
        const eqIndex = text.indexOf("=");
        if (eqIndex === -1) {
          throw new Error("Include an '=' sign, e.g. 2x + 3 = 11.");
        }
        const left = text.slice(0, eqIndex).trim();
        const right = text.slice(eqIndex + 1).trim();
        if (!left || !right) {
          throw new Error("Provide non-empty expressions on both sides of '='.");
        }
        return { lhs: left, rhs: right, canonical: left + " = " + right };
      }

      function detectSymbols(node) {
        const symbols = new Set();
        node.traverse(function (child, path, parent) {
          if (child.isSymbolNode) {
            if (parent && parent.isFunctionNode && parent.fn === child) {
              return;
            }
            const name = child.name;
            if (name === "pi" || name === "e" || name === "i") {
              return;
            }
            symbols.add(name);
          }
        });
        return Array.from(symbols);
      }

      function computeLinearCoefficients(node, variable) {
        const f = (x) => node.evaluate({ [variable]: x });
        const f0 = f(0);
        const f1 = f(1);
        const f2 = f(2);
        const a = f1 - f0;
        const b = f0;
        const curvature = f2 - 2 * f1 + f0;
        return { a, b, curvature };
      }

      function buildSteps(equation, variable, coeffs) {
        const { aL, bL, aR, bR, a, b } = coeffs;
        const steps = [];

        steps.push({
          title: "State the equation",
          text: "We begin from the equation exactly as written.",
          expression: equation,
        });

        const leftLinear = formatLinearExpression(aL, bL, variable);
        const rightLinear = formatLinearExpression(aR, bR, variable);
        steps.push({
          title: "View each side as linear in " + variable,
          text:
            "Each side can be written in the standard linear form a·" +
            variable +
            " + b.",
          expression: leftLinear + " = " + rightLinear,
        });

        const collected = formatLinearExpression(a, b, variable);
        steps.push({
          title: "Collect variable terms on one side",
          text:
            "Subtract the right-hand side from both sides so that all " +
            variable +
            "-terms appear on the left.",
          expression: collected + " = 0",
        });

        const rhsConstant = formatNumber(-b);
        const leftCoeff = formatLinearExpression(a, 0, variable);
        steps.push({
          title: "Move constant terms to the other side",
          text:
            "Add or subtract the constant term on both sides to leave only the variable term on the left.",
          expression: leftCoeff + " = " + rhsConstant,
        });

        const aStr = formatNumber(a);
        const solutionValue = -b / a;
        const solutionStr = formatNumber(solutionValue);
        steps.push({
          title: "Isolate the variable",
          text:
            "Divide both sides by the coefficient of " +
            variable +
            " to obtain the unique solution.",
          expression: variable + " = " + solutionStr + "  (since " + variable + " = " + rhsConstant + " / " + aStr + ")",
        });

        return { steps, value: solutionValue };
      }

      function solveLinearEquation(rawEquation, requestedVariable) {
        if (!mathAvailable()) {
          throw new Error("The math engine is not available.");
        }

        const { lhs, rhs, canonical } = parseEquation(rawEquation);
        const exprLeft = window.math.parse(lhs);
        const exprRight = window.math.parse(rhs);

        const symbolsLeft = detectSymbols(exprLeft);
        const symbolsRight = detectSymbols(exprRight);
        const allSymbols = Array.from(
          new Set(symbolsLeft.concat(symbolsRight))
        );

        let variable = (requestedVariable || "").trim();
        if (!variable) {
          variable = allSymbols[0] || "x";
        }

        if (allSymbols.length > 1) {
          throw new Error(
            "Detected multiple symbols (" +
            allSymbols.join(", ") +
            "). This tool explains equations in a single variable at a time."
          );
        }

        if (allSymbols.length === 1 && allSymbols[0] !== variable) {
          throw new Error(
            "The equation uses the symbol '" +
            allSymbols[0] +
            "'. Either change the variable field to '" +
            allSymbols[0] +
            "' or edit the equation."
          );
        }

        const { a: aL, b: bL, curvature: curvL } = computeLinearCoefficients(
          exprLeft,
          variable
        );
        const { a: aR, b: bR, curvature: curvR } = computeLinearCoefficients(
          exprRight,
          variable
        );

        if (Math.abs(curvL) > 1e-6 || Math.abs(curvR) > 1e-6) {
          return {
            status: "unsupported",
            reason:
              "The equation is not linear in " +
              variable +
              ". The current method requires linearity (a·" +
              variable +
              " + b).",
            equation: canonical,
            variable,
          };
        }

        const a = aL - aR;
        const b = bL - bR;
        const classification = classifySolution(a, b);

        if (classification === "infinite") {
          return {
            status: "success",
            type: "infinite",
            variable,
            equation: canonical,
            steps: [
              {
                title: "State the equation",
                text: "We begin from the equation exactly as written.",
                expression: canonical,
              },
              {
                title: "Bring all terms to one side",
                text:
                  "After simplifying, both sides of the equation match for every value of " +
                  variable +
                  ".",
                expression: "0 = 0",
              },
            ],
            summary:
              "Every real value of " +
              variable +
              " satisfies this equation (infinitely many solutions).",
            value: null,
          };
        }

        if (classification === "none") {
          return {
            status: "success",
            type: "none",
            variable,
            equation: canonical,
            steps: [
              {
                title: "State the equation",
                text: "We begin from the equation exactly as written.",
                expression: canonical,
              },
              {
                title: "Bring all terms to one side",
                text:
                  "Simplifying leads to a contradiction: a non-zero constant equals zero.",
                expression: "0 = " + formatNumber(-b),
              },
            ],
            summary:
              "There is no real value of " +
              variable +
              " that satisfies this equation (no solution).",
            value: null,
          };
        }

        const stepData = buildSteps(canonical, variable, {
          aL,
          bL,
          aR,
          bR,
          a,
          b,
        });

        return {
          status: "success",
          type: "unique",
          variable,
          equation: canonical,
          steps: stepData.steps,
          summary:
            "The equation has a unique real solution " +
            variable +
            " = " +
            formatNumber(stepData.value) +
            ".",
          value: stepData.value,
        };
      }

      function renderSteps(steps) {
        stepsList.innerHTML = "";
        if (!steps || !steps.length) {
          stepsPlaceholder.style.display = "block";
          return;
        }
        stepsPlaceholder.style.display = "none";

        steps.forEach(function (step, index) {
          const li = document.createElement("li");
          li.className = "step-item";

          const badge = document.createElement("div");
          badge.className = "step-index";
          badge.textContent = String(index + 1);

          const title = document.createElement("div");
          title.className = "step-title";
          title.textContent = step.title;

          const text = document.createElement("div");
          text.className = "step-text";
          text.textContent = step.text;

          li.appendChild(badge);
          li.appendChild(title);
          li.appendChild(text);

          if (step.expression) {
            const expr = document.createElement("div");
            expr.className = "step-expression";
            expr.textContent = step.expression;
            li.appendChild(expr);
          }

          stepsList.appendChild(li);
        });
      }

      function renderResult(result) {
        if (!result) {
          solutionMain.textContent = "No equation solved yet";
          solutionTag.textContent = "Ready";
          solutionSummary.textContent =
            "Enter an equation on the left and choose Solve & explain.";
          renderSteps([]);
          exportTxtButton.disabled = true;
          copyButton.disabled = true;
          return;
        }

        if (result.status === "unsupported") {
          solutionMain.textContent = "Unsupported equation";
          solutionTag.textContent = "Method Limit";
          solutionSummary.textContent = result.reason;
          renderSteps([]);
          exportTxtButton.disabled = true;
          copyButton.disabled = true;
          return;
        }

        if (result.type === "unique") {
          solutionMain.textContent =
            result.variable + " = " + formatNumber(result.value);
          solutionTag.textContent = "Unique solution";
        } else if (result.type === "none") {
          solutionMain.textContent = "No solution";
          solutionTag.textContent = "Inconsistent";
        } else if (result.type === "infinite") {
          solutionMain.textContent = "Infinitely many solutions";
          solutionTag.textContent = "Identity";
        } else {
          solutionMain.textContent = "Result";
          solutionTag.textContent = "Solved";
        }

        solutionSummary.textContent = result.summary;
        renderSteps(result.steps || []);

        exportTxtButton.disabled = false;
        copyButton.disabled = false;
      }

      function updateHistoryChip() {
        historyChip.textContent = history.length + " stored";
      }

      function renderHistory() {
        historyContent.innerHTML = "";

        if (!history.length) {
          const empty = document.createElement("div");
          empty.className = "history-empty";
          empty.textContent =
            "No equations solved yet. Your last few derivations will appear here.";
          historyContent.appendChild(empty);
          updateHistoryChip();
          return;
        }

        history.forEach(function (item, idx) {
          const row = document.createElement("div");
          row.className = "history-item";
          row.setAttribute("role", "button");
          row.setAttribute("tabindex", "0");
          row.dataset.index = String(idx);

          const label = document.createElement("div");
          label.className = "history-item-label";
          label.textContent = item.equation;

          const meta = document.createElement("div");
          meta.className = "history-item-meta";
          let kind = "";
          if (item.type === "unique") {
            kind = "unique solution";
          } else if (item.type === "none") {
            kind = "no solution";
          } else if (item.type === "infinite") {
            kind = "infinitely many";
          } else {
            kind = "unsupported";
          }
          meta.textContent = kind + " in " + item.variable;

          row.appendChild(label);
          row.appendChild(meta);

          row.addEventListener("click", function () {
            const index = Number(this.dataset.index);
            const chosen = history[index];
            if (chosen) {
              currentResult = chosen;
              eqInput.value = chosen.equation;
              varInput.value = chosen.variable;
              showError("");
              renderResult(chosen);
            }
          });

          row.addEventListener("keydown", function (evt) {
            if (evt.key === "Enter" || evt.key === " ") {
              evt.preventDefault();
              this.click();
            }
          });

          historyContent.appendChild(row);
        });

        updateHistoryChip();
      }

      function buildExportText(result) {
        const lines = [];
        const now = new Date();
        lines.push("Equation Solver Tool");
        lines.push("====================");
        lines.push("");
        lines.push("Solved at: " + now.toISOString());
        lines.push("");
        lines.push("Original equation:");
        lines.push("  " + result.equation);
        lines.push("");
        lines.push("Variable:");
        lines.push("  " + result.variable);
        lines.push("");
        lines.push("Classification:");
        if (result.type === "unique") {
          lines.push(
            "  Unique real solution, " +
            result.variable +
            " = " +
            formatNumber(result.value)
          );
        } else if (result.type === "none") {
          lines.push("  No real solution (inconsistent equation)");
        } else if (result.type === "infinite") {
          lines.push("  Infinitely many real solutions");
        } else {
          lines.push("  " + (result.summary || "Result"));
        }
        lines.push("");
        if (result.steps && result.steps.length) {
          lines.push("Derivation:");
          result.steps.forEach(function (step, idx) {
            lines.push("");
            lines.push("  Step " + (idx + 1) + ": " + step.title);
            if (step.text) {
              lines.push("    " + step.text);
            }
            if (step.expression) {
              lines.push("    " + step.expression);
            }
          });
        }
        lines.push("");
        lines.push(
          "Method: rewrite each side in linear form a·" +
          result.variable +
          " + b, collect like terms, and solve a·" +
          result.variable +
          " + b = 0."
        );
        return lines.join("\n");
      }

      function triggerDownload(filename, text) {
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function handleSolve() {
        showError("");
        if (!mathAvailable()) {
          showError("The math engine is currently unavailable.");
          setMathEngineStatus();
          return;
        }

        const rawEquation = eqInput.value;
        const requestedVariable = varInput.value;

        try {
          const result = solveLinearEquation(rawEquation, requestedVariable);
          currentResult = result;

          if (result.status === "success") {
            history.unshift(result);
            if (history.length > MAX_HISTORY) {
              history.length = MAX_HISTORY;
            }
          }

          renderResult(result);
          renderHistory();
        } catch (err) {
          console.error(err);
          showError(err.message || "An unexpected error occurred.");
          currentResult = null;
          renderResult(null);
        }
      }

      function handleClear() {
        eqInput.value = "";
        showError("");
        currentResult = null;
        renderResult(null);
      }

      function handleSample() {
        const samples = [
          "2x + 3 = 11",
          "3(x - 2) + 4 = 10",
          "0.5x - 4 = 2",
          "7 - 2x = x + 1",
        ];
        const existing = eqInput.value.trim();
        let next = samples[0];
        const index = samples.indexOf(existing);
        if (index >= 0 && index < samples.length - 1) {
          next = samples[index + 1];
        } else if (!existing) {
          next = samples[0];
        } else {
          next = samples[0];
        }
        eqInput.value = next;
        eqInput.focus();
        eqInput.setSelectionRange(next.length, next.length);
      }

      function handleExport() {
        if (!currentResult || currentResult.status !== "success") {
          return;
        }
        const text = buildExportText(currentResult);
        const safeVar = (currentResult.variable || "x").replace(/[^a-zA-Z0-9]+/g, "");
        const timestamp = new Date()
          .toISOString()
          .replace(/[:.]/g, "-")
          .slice(0, 19);
        const filename =
          "equation-" + safeVar.toLowerCase() + "-" + timestamp + ".txt";
        triggerDownload(filename, text);
      }

      function handleCopy() {
        if (!currentResult || currentResult.status !== "success") {
          return;
        }
        const text = buildExportText(currentResult);
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).catch(function () {
            try {
              const textarea = document.createElement("textarea");
              textarea.value = text;
              textarea.style.position = "fixed";
              textarea.style.opacity = "0";
              document.body.appendChild(textarea);
              textarea.focus();
              textarea.select();
              document.execCommand("copy");
              document.body.removeChild(textarea);
            } catch (e) {
              console.error("Copy failed:", e);
            }
          });
        } else {
          try {
            const textarea = document.createElement("textarea");
            textarea.value = text;
            textarea.style.position = "fixed";
            textarea.style.opacity = "0";
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
          } catch (e) {
            console.error("Copy failed:", e);
          }
        }
      }

      solveButton.addEventListener("click", handleSolve);
      clearButton.addEventListener("click", handleClear);
      sampleButton.addEventListener("click", handleSample);
      exportTxtButton.addEventListener("click", handleExport);
      copyButton.addEventListener("click", handleCopy);

      eqInput.addEventListener("keydown", function (evt) {
        if (evt.key === "Enter" && (evt.ctrlKey || evt.metaKey || !evt.shiftKey)) {
          evt.preventDefault();
          handleSolve();
        }
      });

      window.addEventListener("load", setMathEngineStatus);
      setMathEngineStatus();
      renderResult(null);
      renderHistory();
    })();
  </script>
</body>
</html>

