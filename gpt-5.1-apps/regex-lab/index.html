<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Regex Lab</title>
    <style>
      :root {
        color-scheme: dark;
        --bg: #050810;
        --panel: #0f172a;
        --text: #e2e8f0;
        --accent: #38bdf8;
      }
      body.light {
        --bg: #f8fafc;
        --panel: #ffffff;
        --text: #111827;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "JetBrains Mono", "Space Mono", monospace;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        padding: 1rem;
      }
      .shell {
        max-width: 1000px;
        margin: 0 auto;
        border-radius: 1.5rem;
        background: var(--panel);
        padding: 1.5rem;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      input,
      textarea,
      button {
        font: inherit;
        border-radius: 0.6rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.04);
        color: inherit;
        padding: 0.5rem 0.8rem;
      }
      textarea {
        width: 100%;
        min-height: 120px;
      }
      .flags label {
        margin-right: 0.8rem;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }
      .panel {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 1rem;
        padding: 1rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }
      th,
      td {
        padding: 0.3rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .match-highlight span {
        border-radius: 0.2rem;
        padding: 0 2px;
      }
      .tokens button {
        margin: 0.2rem;
        cursor: pointer;
      }
      .error {
        color: #f87171;
        font-size: 0.9rem;
      }
      .actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <strong>Regex Lab</strong>
        <button id="theme">Toggle light/dark</button>
      </header>
      <label>Pattern<input id="pattern" value="(\\w+)" /></label>
      <div class="flags" id="flags">
        <label><input type="checkbox" value="g" checked /> g</label>
        <label><input type="checkbox" value="i" /> i</label>
        <label><input type="checkbox" value="m" /> m</label>
        <label><input type="checkbox" value="s" /> s</label>
        <label><input type="checkbox" value="u" /> u</label>
        <label><input type="checkbox" value="y" /> y</label>
      </div>
      <div class="tokens" id="tokens"></div>
      <textarea id="text">Words, words everywhere.</textarea>
      <div class="actions">
        <button id="clear">Clear</button>
        <button id="share">Share permalink</button>
      </div>
      <div class="error" id="error"></div>
      <div class="grid">
        <div class="panel">
          <h3>Highlighted text</h3>
          <div class="match-highlight" id="highlight"></div>
        </div>
        <div class="panel">
          <h3>Matches</h3>
          <table>
            <thead>
              <tr><th>#</th><th>Match</th><th>Index</th><th>Groups</th></tr>
            </thead>
            <tbody id="table"></tbody>
          </table>
        </div>
        <div class="panel">
          <h3>Explanation</h3>
          <div id="explain"></div>
        </div>
      </div>
    </div>

    <script>
      const patternInput = document.getElementById("pattern");
      const textInput = document.getElementById("text");
      const flagsBox = document.querySelectorAll("#flags input");
      const highlight = document.getElementById("highlight");
      const tableBody = document.getElementById("table");
      const explain = document.getElementById("explain");
      const errorEl = document.getElementById("error");
      const themeBtn = document.getElementById("theme");
      const clearBtn = document.getElementById("clear");
      const shareBtn = document.getElementById("share");
      const tokenBar = document.getElementById("tokens");
      const quickTokens = ["\\d", "\\w", "\\s", "[A-Z]", "(?: )", "(?= )", ".*?", "^$"];
      quickTokens.forEach((token) => {
        const btn = document.createElement("button");
        btn.textContent = token;
        btn.addEventListener("click", () => insertToken(token.replace(" ", "")));
        tokenBar.appendChild(btn);
      });

      function insertToken(token) {
        const start = patternInput.selectionStart;
        const end = patternInput.selectionEnd;
        const current = patternInput.value;
        patternInput.value = current.slice(0, start) + token + current.slice(end);
        patternInput.focus();
        patternInput.selectionStart = patternInput.selectionEnd = start + token.length;
        run();
      }

      function getFlags() {
        const selected = [...flagsBox].filter((box) => box.checked).map((box) => box.value);
        return [...new Set(selected)].join("");
      }

      function explainPattern(pattern) {
        const tokens = {
          "\\\\d": "Digit",
          "\\\\w": "Word char",
          "\\\\s": "Whitespace",
          "\\\\b": "Word boundary",
          "\\[A-Z\]": "Uppercase range",
          "\\.": "Any char",
          "\\+": "One or more",
          "\\*": "Zero or more",
          "\\?": "Optional",
          "\\^": "Start",
          "\\$": "End",
        };
        let explanation = pattern;
        Object.entries(tokens).forEach(([key, desc]) => {
          const regex = new RegExp(key, "g");
          explanation = explanation.replace(regex, (match) => `<span>${match}</span> (${desc})`);
        });
        return explanation;
      }

      function highlightMatches(regex, text) {
        const colors = ["#f472b6", "#60a5fa", "#34d399", "#facc15"];
        let lastIndex = 0;
        let result = "";
        let match;
        let idx = 0;
        while ((match = regex.exec(text)) && match[0]) {
          result += text.slice(lastIndex, match.index);
          const color = colors[idx % colors.length];
          result += `<span style="background:${color}33;color:${color}">${match[0]}</span>`;
          lastIndex = regex.lastIndex;
          if (regex.lastIndex === match.index) break; // avoid zero-length loops
          idx++;
        }
        result += text.slice(lastIndex);
        return result;
      }

      function renderTable(matches) {
        tableBody.innerHTML = matches
          .map(
            (match, idx) => `
              <tr>
                <td>${idx + 1}</td>
                <td>${match[0]}</td>
                <td>${match.index}</td>
                <td>${match.slice(1).join(" | ")}</td>
              </tr>`
          )
          .join("");
      }

      function run() {
        const pattern = patternInput.value;
        const flags = getFlags();
        const text = textInput.value;
        try {
          errorEl.textContent = "";
          const baseRegex = new RegExp(pattern, flags || undefined);
          const globalFlags = flags.includes("g") ? flags : flags + "g";
          const regex = new RegExp(pattern, globalFlags);
          const matches = [];
          let match;
          while ((match = regex.exec(text))) {
            matches.push(match);
            if (match[0] === "") {
              regex.lastIndex++;
            }
          }
          highlight.innerHTML = highlightMatches(new RegExp(pattern, globalFlags), text);
          renderTable(matches);
          explain.innerHTML = explainPattern(pattern);
          updateHash(pattern, flags, text);
        } catch (err) {
          errorEl.textContent = err.message;
          highlight.textContent = text;
          tableBody.innerHTML = "";
        }
      }

      function updateHash(pattern, flags, text) {
        const payload = encodeURIComponent(pattern) + "|" + flags + "|" + encodeURIComponent(text);
        history.replaceState(null, "", "#" + payload);
      }

      function loadFromHash() {
        if (!location.hash) return;
        const [pattern, flags, text] = location.hash.slice(1).split("|");
        if (!pattern) return;
        patternInput.value = decodeURIComponent(pattern);
        [...flagsBox].forEach((box) => (box.checked = flags.includes(box.value)));
        if (text) textInput.value = decodeURIComponent(text);
      }

      function copyShare() {
        navigator.clipboard.writeText(location.href);
      }

      patternInput.addEventListener("input", run);
      textInput.addEventListener("input", run);
      flagsBox.forEach((box) => box.addEventListener("change", run));
      themeBtn.addEventListener("click", () => document.body.classList.toggle("light"));
      clearBtn.addEventListener("click", () => {
        patternInput.value = "";
        textInput.value = "";
        run();
      });
      shareBtn.addEventListener("click", copyShare);
      loadFromHash();
      run();
    </script>
  </body>
</html>
