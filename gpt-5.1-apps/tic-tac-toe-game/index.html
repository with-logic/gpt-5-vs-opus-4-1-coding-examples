<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Legion Tic Tac Toe</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Space+Grotesk:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
        --marble: #f7f1e7;
        --stone: #101216;
        --gold: #d4af37;
        --blood: #6c2a2a;
      }
      body {
        margin: 0;
        font-family: "Space Grotesk", system-ui;
        min-height: 100vh;
        background: radial-gradient(circle at top, rgba(180, 174, 161, 0.3), rgba(7, 7, 7, 0.95)), url('https://images.unsplash.com/photo-1503301360696-e1c62238efc2?auto=format&fit=crop&w=1600&q=60')
          center/cover;
        color: #fdf5e1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
      }
      .hud {
        width: min(900px, 100%);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        gap: 1rem;
      }
      .crest {
        font-family: "Playfair Display", serif;
        letter-spacing: 0.3em;
      }
      .hud button {
        border: none;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 999px;
        padding: 0.6rem 1.4rem;
        color: var(--gold);
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .hud button:hover {
        transform: translateY(-2px);
      }
      .board-wrapper {
        position: relative;
      }
      .board {
        width: min(80vmin, 520px);
        height: min(80vmin, 520px);
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        background: rgba(255, 255, 255, 0.08);
        padding: 1rem;
        border-radius: 2rem;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
      }
      .cell {
        aspect-ratio: 1;
        border-radius: 1rem;
        background: rgba(255, 255, 255, 0.12);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: clamp(2rem, 8vmin, 4rem);
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.1s;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .cell:hover {
        box-shadow: inset 0 0 10px rgba(212, 175, 55, 0.7);
      }
      .cell.win {
        background: rgba(212, 175, 55, 0.4);
        color: var(--stone);
      }
      .scoreboard {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .scoreboard div {
        background: rgba(0, 0, 0, 0.4);
        padding: 0.5rem 1.2rem;
        border-radius: 999px;
      }
      .banner {
        margin-top: 1rem;
        min-height: 2rem;
        font-size: 1.2rem;
        text-align: center;
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .panel {
        background: rgba(10, 10, 10, 0.85);
        padding: 2rem;
        border-radius: 1.5rem;
        width: min(420px, 90%);
        display: grid;
        gap: 1rem;
      }
      .panel label {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }
      select {
        padding: 0.6rem;
        border-radius: 0.8rem;
        border: none;
        background: rgba(255, 255, 255, 0.08);
        color: #fff;
      }
      canvas#confetti {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="hud">
      <div class="crest">SPQR</div>
      <div class="scoreboard" aria-live="polite">
        <div>X <span id="scoreX">0</span></div>
        <div>O <span id="scoreO">0</span></div>
        <div>Draw <span id="scoreD">0</span></div>
      </div>
      <div class="actions">
        <button id="newRound">New Round</button>
        <button id="customize">Customize</button>
        <button id="reset">Reset Scores</button>
      </div>
    </div>
    <div class="banner" id="banner" aria-live="assertive"></div>
    <div class="board-wrapper">
      <canvas id="confetti"></canvas>
      <div class="board" role="grid" aria-label="Tic tac toe board" id="board"></div>
    </div>

    <div class="modal" id="modal" role="dialog" aria-modal="true">
      <div class="panel">
        <h2>Customize</h2>
        <label>Theme
          <select id="theme">
            <option value="day">Marble Day</option>
            <option value="night">Night Legion</option>
          </select>
        </label>
        <label>Glyphs
          <select id="glyphs">
            <option value="classic">X / O</option>
            <option value="legion">Gladius / Laurel</option>
          </select>
        </label>
        <label>Mode
          <select id="mode">
            <option value="pvp">2 players</option>
            <option value="ai">vs AI</option>
          </select>
        </label>
        <label>First move
          <select id="first">
            <option value="X">X</option>
            <option value="O">O</option>
          </select>
        </label>
        <label>AI discipline
          <select id="ai">
            <option value="perfect">Perfect</option>
            <option value="pragmatic">Pragmatic</option>
            <option value="reckless">Reckless</option>
          </select>
        </label>
        <button id="apply">Apply</button>
      </div>
    </div>

    <script>
      const boardEl = document.getElementById("board");
      const banner = document.getElementById("banner");
      const confettiCanvas = document.getElementById("confetti");
      const ctx = confettiCanvas.getContext("2d");
      const modal = document.getElementById("modal");
      const config = {
        theme: "day",
        glyphs: "classic",
        mode: "pvp",
        first: "X",
        ai: "perfect",
      };
      let board = Array(9).fill(null);
      let current = config.first;
      let scores = { X: 0, O: 0, D: 0 };
      const glyphSets = {
        classic: { X: "X", O: "O" },
        legion: { X: "âš”", O: "ðŸŒ¿" },
      };

      function renderBoard() {
        boardEl.innerHTML = "";
        board.forEach((value, index) => {
          const cell = document.createElement("button");
          cell.className = "cell";
          cell.setAttribute("role", "gridcell");
          cell.setAttribute("aria-label", `Cell ${index + 1}`);
          cell.dataset.index = index;
          cell.tabIndex = 0;
          cell.textContent = value ? glyphSets[config.glyphs][value] : "";
          cell.addEventListener("click", () => play(index));
          cell.addEventListener("keydown", (event) => handleKey(event, index));
          boardEl.appendChild(cell);
        });
      }

      function handleKey(event, index) {
        const key = event.key;
        if (key === "Enter" || key === " ") {
          play(index);
        }
        const row = Math.floor(index / 3);
        const col = index % 3;
        if (key === "ArrowRight" && col < 2) boardEl.children[index + 1].focus();
        if (key === "ArrowLeft" && col > 0) boardEl.children[index - 1].focus();
        if (key === "ArrowDown" && row < 2) boardEl.children[index + 3].focus();
        if (key === "ArrowUp" && row > 0) boardEl.children[index - 3].focus();
      }

      function play(index) {
        if (board[index] || checkWin(board)) return;
        board[index] = current;
        renderBoard();
        const win = checkWin(board);
        if (win) return finish(win);
        if (board.every(Boolean)) return finish("draw");
        current = current === "X" ? "O" : "X";
        banner.textContent = `${glyphSets[config.glyphs][current]} to play`;
        if (config.mode === "ai" && current === "O") {
          setTimeout(aiMove, 300);
        }
      }

      function finish(result) {
        if (result === "draw") {
          scores.D += 1;
          banner.textContent = "Draw declared";
        } else {
          scores[result.player] += 1;
          highlightWin(result.line);
          banner.textContent = `${glyphSets[config.glyphs][result.player]} triumphs!`;
          celebrate();
        }
        updateScores();
      }

      function updateScores() {
        document.getElementById("scoreX").textContent = scores.X;
        document.getElementById("scoreO").textContent = scores.O;
        document.getElementById("scoreD").textContent = scores.D;
      }

      function checkWin(state) {
        const lines = [
          [0, 1, 2],
          [3, 4, 5],
          [6, 7, 8],
          [0, 3, 6],
          [1, 4, 7],
          [2, 5, 8],
          [0, 4, 8],
          [2, 4, 6],
        ];
        for (const line of lines) {
          const [a, b, c] = line;
          if (state[a] && state[a] === state[b] && state[a] === state[c]) {
            return { player: state[a], line };
          }
        }
        return null;
      }

      function highlightWin(line) {
        line.forEach((i) => boardEl.children[i].classList.add("win"));
      }

      function aiMove() {
        const move = chooseAiMove();
        play(move);
      }

      function chooseAiMove() {
        if (config.ai === "reckless") {
          const available = board.map((v, i) => (v ? null : i)).filter((v) => v !== null);
          return available[Math.floor(Math.random() * available.length)];
        }
        const best = minimax(board.slice(), "O");
        if (config.ai === "pragmatic" && Math.random() < 0.4) {
          const available = board.map((v, i) => (v ? null : i)).filter((v) => v !== null);
          return available[Math.floor(Math.random() * available.length)];
        }
        return best.index;
      }

      function minimax(state, player) {
        const winner = checkWin(state);
        if (winner && winner.player === "X") return { score: -10 };
        if (winner && winner.player === "O") return { score: 10 };
        if (state.every(Boolean)) return { score: 0 };
        const moves = [];
        state.forEach((cell, index) => {
          if (!cell) {
            state[index] = player;
            const result = minimax(state, player === "O" ? "X" : "O");
            moves.push({ index, score: result.score });
            state[index] = null;
          }
        });
        let bestMove;
        if (player === "O") {
          let bestScore = -Infinity;
          moves.forEach((move) => {
            if (move.score > bestScore) {
              bestScore = move.score;
              bestMove = move;
            }
          });
        } else {
          let bestScore = Infinity;
          moves.forEach((move) => {
            if (move.score < bestScore) {
              bestScore = move.score;
              bestMove = move;
            }
          });
        }
        return bestMove;
      }

      function celebrate() {
        if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;
        confettiCanvas.width = boardEl.offsetWidth;
        confettiCanvas.height = boardEl.offsetHeight;
        const pieces = Array.from({ length: 80 }, () => ({
          x: Math.random() * confettiCanvas.width,
          y: Math.random() * confettiCanvas.height,
          size: Math.random() * 4 + 2,
          speed: Math.random() * 2 + 1,
          color: `hsl(${Math.random() * 60 + 40},80%,60%)`,
        }));
        let frames = 0;
        function draw() {
          ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
          pieces.forEach((p) => {
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, p.size, p.size * 2);
            p.y += p.speed;
            if (p.y > confettiCanvas.height) p.y = -10;
          });
          frames++;
          if (frames < 120) requestAnimationFrame(draw);
          else ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
        }
        draw();
      }

      document.getElementById("newRound").addEventListener("click", () => {
        board = Array(9).fill(null);
        current = config.first;
        banner.textContent = `${glyphSets[config.glyphs][current]} to play`;
        renderBoard();
      });
      document.getElementById("reset").addEventListener("click", () => {
        scores = { X: 0, O: 0, D: 0 };
        updateScores();
      });
      document.getElementById("customize").addEventListener("click", () => (modal.classList.toggle("active")));
      document.getElementById("apply").addEventListener("click", () => {
        config.theme = document.getElementById("theme").value;
        config.glyphs = document.getElementById("glyphs").value;
        config.mode = document.getElementById("mode").value;
        config.first = document.getElementById("first").value;
        config.ai = document.getElementById("ai").value;
        modal.classList.remove("active");
        document.body.style.filter = config.theme === "night" ? "hue-rotate(330deg)" : "none";
        document.body.style.backgroundBlendMode = config.theme === "night" ? "multiply" : "normal";
        document.getElementById("newRound").click();
      });
      modal.addEventListener("click", (event) => {
        if (event.target === modal) modal.classList.remove("active");
      });

      renderBoard();
      banner.textContent = `${glyphSets[config.glyphs][current]} to play`;
    </script>
  </body>
</html>
