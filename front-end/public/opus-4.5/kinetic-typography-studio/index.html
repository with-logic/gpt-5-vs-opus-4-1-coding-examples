<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinetic Typography Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #1a1a2e;
            --panel: #16213e;
            --accent: #4ecdc4;
            --text: #ffffff;
            --text-dim: #888;
            --border: #333;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
        }

        /* Header */
        header {
            grid-column: 1 / -1;
            background: var(--panel);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg);
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Left Panel - Controls */
        .left-panel {
            background: var(--panel);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border);
        }

        .panel-section {
            margin-bottom: 25px;
        }

        .panel-section h3 {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 6px;
            color: var(--text-dim);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text);
            font-size: 0.9rem;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .color-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-input input[type="color"] {
            width: 40px;
            height: 40px;
            padding: 0;
            border: none;
            cursor: pointer;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-group input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-value {
            min-width: 40px;
            text-align: right;
            font-size: 0.85rem;
            color: var(--accent);
        }

        /* Preset buttons */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .preset-btn {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            border-color: var(--accent);
            background: rgba(78, 205, 196, 0.1);
        }

        .preset-btn.active {
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
        }

        /* Canvas Area */
        .canvas-area {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0f0f1a;
            position: relative;
            overflow: hidden;
        }

        .preview-container {
            position: relative;
            background: #000;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .safe-area {
            position: absolute;
            border: 1px dashed rgba(255, 255, 255, 0.2);
            pointer-events: none;
        }

        #textCanvas {
            display: block;
        }

        .canvas-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 30px;
        }

        .canvas-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            padding: 5px;
        }

        .canvas-btn:hover {
            color: var(--accent);
            transform: scale(1.1);
        }

        /* Right Panel - Timeline */
        .right-panel {
            background: var(--panel);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid var(--border);
        }

        .keyframe-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .keyframe-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .keyframe-item:hover {
            border-color: var(--accent);
        }

        .keyframe-item.active {
            border-color: var(--accent);
            background: rgba(78, 205, 196, 0.1);
        }

        .keyframe-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .keyframe-time {
            font-weight: 600;
            color: var(--accent);
        }

        .keyframe-delete {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
        }

        .keyframe-props {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .add-keyframe-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: rgba(78, 205, 196, 0.2);
            border: 1px dashed var(--accent);
            border-radius: 8px;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .add-keyframe-btn:hover {
            background: rgba(78, 205, 196, 0.3);
        }

        /* Timeline Bar */
        .timeline-bar {
            grid-column: 1 / -1;
            background: var(--panel);
            padding: 15px 20px;
            border-top: 1px solid var(--border);
        }

        .timeline-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .time-display {
            font-family: monospace;
            font-size: 1.2rem;
            color: var(--accent);
            min-width: 100px;
        }

        .timeline-track {
            flex: 1;
            height: 40px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            position: relative;
            cursor: pointer;
        }

        .timeline-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), rgba(78, 205, 196, 0.3));
            border-radius: 6px;
            position: relative;
        }

        .timeline-scrubber {
            position: absolute;
            right: -2px;
            top: -5px;
            width: 4px;
            height: 50px;
            background: var(--accent);
            border-radius: 2px;
        }

        .timeline-markers {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .timeline-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        /* Export Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--panel);
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
        }

        .modal h3 {
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        /* Aspect ratio buttons */
        .aspect-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 250px 1fr;
            }

            .right-panel {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }

            .left-panel {
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">Kinetic Typography Studio</div>
            <div class="header-controls">
                <select id="aspectRatio" onchange="changeAspect()">
                    <option value="16:9">16:9 (Landscape)</option>
                    <option value="9:16">9:16 (Portrait)</option>
                    <option value="1:1">1:1 (Square)</option>
                </select>
                <button class="btn btn-secondary" onclick="openExportModal()">Export</button>
                <button class="btn btn-primary" id="playBtn" onclick="togglePlay()">‚ñ∂ Play</button>
            </div>
        </header>

        <!-- Left Panel -->
        <div class="left-panel">
            <div class="panel-section">
                <h3>Text Content</h3>
                <div class="form-group">
                    <textarea id="textInput" placeholder="Enter your text here..." onchange="updateText()">KINETIC</textarea>
                </div>
            </div>

            <div class="panel-section">
                <h3>Font</h3>
                <div class="form-group">
                    <select id="fontFamily" onchange="updateStyle()">
                        <option value="Arial">Arial</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Impact" selected>Impact</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Trebuchet MS">Trebuchet MS</option>
                        <option value="Verdana">Verdana</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Size</label>
                    <div class="slider-group">
                        <input type="range" id="fontSize" min="20" max="200" value="80" oninput="updateStyle()">
                        <span class="slider-value" id="fontSizeValue">80px</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Weight</label>
                    <select id="fontWeight" onchange="updateStyle()">
                        <option value="400">Normal</option>
                        <option value="700" selected>Bold</option>
                        <option value="900">Black</option>
                    </select>
                </div>
            </div>

            <div class="panel-section">
                <h3>Colors</h3>
                <div class="form-group">
                    <label>Text Color</label>
                    <div class="color-input">
                        <input type="color" id="textColor" value="#ffffff" onchange="updateStyle()">
                        <input type="text" id="textColorHex" value="#ffffff" onchange="syncColor('text')">
                    </div>
                </div>
                <div class="form-group">
                    <label>Background</label>
                    <div class="color-input">
                        <input type="color" id="bgColor" value="#000000" onchange="updateStyle()">
                        <input type="text" id="bgColorHex" value="#000000" onchange="syncColor('bg')">
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h3>Animation Preset</h3>
                <div class="preset-grid">
                    <button class="preset-btn active" onclick="setPreset('typewriter')">Typewriter</button>
                    <button class="preset-btn" onclick="setPreset('bounce')">Bounce</button>
                    <button class="preset-btn" onclick="setPreset('fade')">Fade Up</button>
                    <button class="preset-btn" onclick="setPreset('glitch')">Glitch</button>
                    <button class="preset-btn" onclick="setPreset('cascade')">Cascade</button>
                    <button class="preset-btn" onclick="setPreset('wave')">Wave</button>
                </div>
            </div>

            <div class="panel-section">
                <h3>Effects</h3>
                <div class="form-group">
                    <label>Letter Spacing</label>
                    <div class="slider-group">
                        <input type="range" id="letterSpacing" min="-10" max="50" value="0" oninput="updateStyle()">
                        <span class="slider-value" id="letterSpacingValue">0px</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Stagger Delay</label>
                    <div class="slider-group">
                        <input type="range" id="staggerDelay" min="0" max="200" value="50" oninput="updateAnimation()">
                        <span class="slider-value" id="staggerDelayValue">50ms</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-area">
            <div class="preview-container" id="previewContainer">
                <canvas id="textCanvas" width="854" height="480"></canvas>
                <div class="safe-area" id="safeArea"></div>
            </div>

            <div class="canvas-controls">
                <button class="canvas-btn" onclick="zoomOut()">‚ûñ</button>
                <button class="canvas-btn" onclick="resetZoom()">üî≤</button>
                <button class="canvas-btn" onclick="zoomIn()">‚ûï</button>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="panel-section">
                <h3>Keyframes</h3>
                <div class="keyframe-list" id="keyframeList"></div>
                <button class="add-keyframe-btn" onclick="addKeyframe()">+ Add Keyframe</button>
            </div>

            <div class="panel-section">
                <h3>Easing</h3>
                <div class="form-group">
                    <select id="easingPreset" onchange="updateAnimation()">
                        <option value="linear">Linear</option>
                        <option value="ease" selected>Ease</option>
                        <option value="ease-in">Ease In</option>
                        <option value="ease-out">Ease Out</option>
                        <option value="ease-in-out">Ease In Out</option>
                        <option value="bounce">Bounce</option>
                    </select>
                </div>
            </div>

            <div class="panel-section">
                <h3>Duration</h3>
                <div class="form-group">
                    <div class="slider-group">
                        <input type="range" id="duration" min="0.5" max="10" step="0.1" value="3" oninput="updateDuration()">
                        <span class="slider-value" id="durationValue">3.0s</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="timeline-bar">
            <div class="timeline-controls">
                <button class="canvas-btn" onclick="goToStart()">‚èÆ</button>
                <button class="canvas-btn" onclick="stepBack()">‚è™</button>
                <button class="canvas-btn" id="playBtnTimeline" onclick="togglePlay()">‚ñ∂</button>
                <button class="canvas-btn" onclick="stepForward()">‚è©</button>
                <button class="canvas-btn" onclick="goToEnd()">‚è≠</button>
                <span class="time-display" id="timeDisplay">0:00.00</span>
                <div class="timeline-track" id="timelineTrack" onclick="scrubTimeline(event)">
                    <div class="timeline-progress" id="timelineProgress" style="width: 0%">
                        <div class="timeline-scrubber"></div>
                    </div>
                    <div class="timeline-markers" id="timelineMarkers"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h3>Export Animation</h3>
            <div class="form-group">
                <label>Format</label>
                <select id="exportFormat">
                    <option value="gif">GIF</option>
                    <option value="webm">WebM</option>
                    <option value="png">PNG Sequence</option>
                </select>
            </div>
            <div class="form-group">
                <label>Resolution</label>
                <select id="exportResolution">
                    <option value="720">720p (1280x720)</option>
                    <option value="1080" selected>1080p (1920x1080)</option>
                    <option value="4k">4K (3840x2160)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Frame Rate</label>
                <select id="exportFps">
                    <option value="24">24 fps</option>
                    <option value="30" selected>30 fps</option>
                    <option value="60">60 fps</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="exportAnimation()">Export</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let state = {
            text: 'KINETIC',
            fontSize: 80,
            fontFamily: 'Impact',
            fontWeight: '700',
            textColor: '#ffffff',
            bgColor: '#000000',
            letterSpacing: 0,
            staggerDelay: 50,
            duration: 3,
            preset: 'typewriter',
            easing: 'ease',
            aspect: '16:9',
            playing: false,
            currentTime: 0,
            zoom: 1
        };

        let keyframes = [
            { time: 0, opacity: 0, y: 50, scale: 0.8 },
            { time: 1, opacity: 1, y: 0, scale: 1 },
            { time: 2.5, opacity: 1, y: 0, scale: 1 },
            { time: 3, opacity: 0, y: -30, scale: 1.1 }
        ];

        let animationFrame;
        let startTime;

        const canvas = document.getElementById('textCanvas');
        const ctx = canvas.getContext('2d');

        // Initialize
        function init() {
            updateStyle();
            renderKeyframes();
            render();
        }

        // Update text
        function updateText() {
            state.text = document.getElementById('textInput').value || 'TEXT';
            render();
        }

        // Update style
        function updateStyle() {
            state.fontSize = parseInt(document.getElementById('fontSize').value);
            state.fontFamily = document.getElementById('fontFamily').value;
            state.fontWeight = document.getElementById('fontWeight').value;
            state.textColor = document.getElementById('textColor').value;
            state.bgColor = document.getElementById('bgColor').value;
            state.letterSpacing = parseInt(document.getElementById('letterSpacing').value);

            document.getElementById('fontSizeValue').textContent = state.fontSize + 'px';
            document.getElementById('letterSpacingValue').textContent = state.letterSpacing + 'px';
            document.getElementById('textColorHex').value = state.textColor;
            document.getElementById('bgColorHex').value = state.bgColor;

            render();
        }

        // Sync color inputs
        function syncColor(type) {
            if (type === 'text') {
                const hex = document.getElementById('textColorHex').value;
                document.getElementById('textColor').value = hex;
            } else {
                const hex = document.getElementById('bgColorHex').value;
                document.getElementById('bgColor').value = hex;
            }
            updateStyle();
        }

        // Update animation params
        function updateAnimation() {
            state.staggerDelay = parseInt(document.getElementById('staggerDelay').value);
            state.easing = document.getElementById('easingPreset').value;

            document.getElementById('staggerDelayValue').textContent = state.staggerDelay + 'ms';
        }

        // Update duration
        function updateDuration() {
            state.duration = parseFloat(document.getElementById('duration').value);
            document.getElementById('durationValue').textContent = state.duration.toFixed(1) + 's';
        }

        // Set animation preset
        function setPreset(preset) {
            state.preset = preset;
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === preset);
            });

            // Update keyframes based on preset
            switch (preset) {
                case 'typewriter':
                    keyframes = [
                        { time: 0, opacity: 1, y: 0, scale: 1, chars: 0 },
                        { time: state.duration, opacity: 1, y: 0, scale: 1, chars: 1 }
                    ];
                    break;
                case 'bounce':
                    keyframes = [
                        { time: 0, opacity: 0, y: -100, scale: 1 },
                        { time: 0.6, opacity: 1, y: 20, scale: 1 },
                        { time: 0.8, opacity: 1, y: -10, scale: 1 },
                        { time: 1, opacity: 1, y: 0, scale: 1 }
                    ];
                    break;
                case 'fade':
                    keyframes = [
                        { time: 0, opacity: 0, y: 30, scale: 1 },
                        { time: 1, opacity: 1, y: 0, scale: 1 }
                    ];
                    break;
                case 'glitch':
                    keyframes = [
                        { time: 0, opacity: 0, x: -20, glitch: 1 },
                        { time: 0.1, opacity: 1, x: 10, glitch: 0.5 },
                        { time: 0.2, opacity: 1, x: -5, glitch: 0.3 },
                        { time: 0.3, opacity: 1, x: 0, glitch: 0 }
                    ];
                    break;
                case 'cascade':
                    keyframes = [
                        { time: 0, opacity: 0, y: 50, cascade: true },
                        { time: state.duration, opacity: 1, y: 0, cascade: true }
                    ];
                    break;
                case 'wave':
                    keyframes = [
                        { time: 0, wave: 0 },
                        { time: state.duration, wave: 1 }
                    ];
                    break;
            }

            renderKeyframes();
            render();
        }

        // Easing functions
        const easings = {
            linear: t => t,
            ease: t => t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2,
            'ease-in': t => t * t,
            'ease-out': t => 1 - (1 - t) * (1 - t),
            'ease-in-out': t => t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2,
            bounce: t => {
                const n1 = 7.5625;
                const d1 = 2.75;
                if (t < 1 / d1) return n1 * t * t;
                if (t < 2 / d1) return n1 * (t -= 1.5 / d1) * t + 0.75;
                if (t < 2.5 / d1) return n1 * (t -= 2.25 / d1) * t + 0.9375;
                return n1 * (t -= 2.625 / d1) * t + 0.984375;
            }
        };

        // Render canvas
        function render() {
            const progress = state.currentTime / state.duration;
            const easedProgress = easings[state.easing](Math.min(1, Math.max(0, progress)));

            // Clear canvas
            ctx.fillStyle = state.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Setup text style
            ctx.font = `${state.fontWeight} ${state.fontSize}px ${state.fontFamily}`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.letterSpacing = state.letterSpacing + 'px';

            const chars = state.text.split('');
            const charWidth = ctx.measureText('M').width + state.letterSpacing;
            const totalWidth = chars.length * charWidth;
            const startX = canvas.width / 2 - totalWidth / 2 + charWidth / 2;
            const centerY = canvas.height / 2;

            // Draw based on preset
            switch (state.preset) {
                case 'typewriter':
                    const visibleChars = Math.floor(easedProgress * chars.length);
                    ctx.fillStyle = state.textColor;
                    chars.slice(0, visibleChars + 1).forEach((char, i) => {
                        const charProgress = i < visibleChars ? 1 : (easedProgress * chars.length) % 1;
                        ctx.globalAlpha = charProgress;
                        ctx.fillText(char, startX + i * charWidth, centerY);
                    });
                    ctx.globalAlpha = 1;
                    break;

                case 'bounce':
                case 'fade':
                    const animY = interpolateKeyframe('y', progress);
                    const animOpacity = interpolateKeyframe('opacity', progress);
                    ctx.fillStyle = state.textColor;
                    ctx.globalAlpha = animOpacity;
                    ctx.fillText(state.text, canvas.width / 2, centerY + animY);
                    ctx.globalAlpha = 1;
                    break;

                case 'glitch':
                    const glitchAmount = interpolateKeyframe('glitch', progress) || 0;
                    const offsetX = interpolateKeyframe('x', progress) || 0;
                    const glitchOpacity = interpolateKeyframe('opacity', progress);

                    // Red channel
                    ctx.fillStyle = '#ff0000';
                    ctx.globalAlpha = glitchOpacity * 0.5 * glitchAmount;
                    ctx.fillText(state.text, canvas.width / 2 + offsetX - 3 * glitchAmount, centerY);

                    // Blue channel
                    ctx.fillStyle = '#0000ff';
                    ctx.fillText(state.text, canvas.width / 2 + offsetX + 3 * glitchAmount, centerY);

                    // Main text
                    ctx.fillStyle = state.textColor;
                    ctx.globalAlpha = glitchOpacity;
                    ctx.fillText(state.text, canvas.width / 2 + offsetX, centerY);
                    ctx.globalAlpha = 1;
                    break;

                case 'cascade':
                    ctx.fillStyle = state.textColor;
                    chars.forEach((char, i) => {
                        const charDelay = i * (state.staggerDelay / 1000);
                        const charProgress = Math.max(0, Math.min(1, (state.currentTime - charDelay) / (state.duration * 0.5)));
                        const easedChar = easings[state.easing](charProgress);
                        const y = centerY + (1 - easedChar) * 50;
                        ctx.globalAlpha = easedChar;
                        ctx.fillText(char, startX + i * charWidth, y);
                    });
                    ctx.globalAlpha = 1;
                    break;

                case 'wave':
                    ctx.fillStyle = state.textColor;
                    chars.forEach((char, i) => {
                        const waveOffset = Math.sin(progress * Math.PI * 2 + i * 0.5) * 20;
                        ctx.fillText(char, startX + i * charWidth, centerY + waveOffset);
                    });
                    break;

                default:
                    ctx.fillStyle = state.textColor;
                    ctx.fillText(state.text, canvas.width / 2, centerY);
            }
        }

        // Interpolate keyframe values
        function interpolateKeyframe(prop, progress) {
            const time = progress * state.duration;
            let prev = keyframes[0];
            let next = keyframes[keyframes.length - 1];

            for (let i = 0; i < keyframes.length - 1; i++) {
                if (keyframes[i].time <= time && keyframes[i + 1].time >= time) {
                    prev = keyframes[i];
                    next = keyframes[i + 1];
                    break;
                }
            }

            if (prev[prop] === undefined || next[prop] === undefined) return prev[prop] ?? 0;

            const segmentProgress = (time - prev.time) / (next.time - prev.time);
            const easedProgress = easings[state.easing](segmentProgress);

            return prev[prop] + (next[prop] - prev[prop]) * easedProgress;
        }

        // Render keyframes list
        function renderKeyframes() {
            const list = document.getElementById('keyframeList');
            list.innerHTML = keyframes.map((kf, i) => `
                <div class="keyframe-item ${i === 0 ? 'active' : ''}" onclick="selectKeyframe(${i})">
                    <div class="keyframe-header">
                        <span class="keyframe-time">${kf.time.toFixed(2)}s</span>
                        <button class="keyframe-delete" onclick="deleteKeyframe(${i}, event)">√ó</button>
                    </div>
                    <div class="keyframe-props">
                        ${kf.opacity !== undefined ? `opacity: ${kf.opacity}` : ''}
                        ${kf.y !== undefined ? ` y: ${kf.y}` : ''}
                        ${kf.scale !== undefined ? ` scale: ${kf.scale}` : ''}
                    </div>
                </div>
            `).join('');

            // Update timeline markers
            const markers = document.getElementById('timelineMarkers');
            markers.innerHTML = keyframes.map(kf => `
                <div class="timeline-marker" style="left: ${(kf.time / state.duration) * 100}%"></div>
            `).join('');
        }

        // Keyframe actions
        function addKeyframe() {
            const newTime = state.currentTime;
            keyframes.push({ time: newTime, opacity: 1, y: 0, scale: 1 });
            keyframes.sort((a, b) => a.time - b.time);
            renderKeyframes();
        }

        function selectKeyframe(index) {
            state.currentTime = keyframes[index].time;
            updateTimeDisplay();
            render();
        }

        function deleteKeyframe(index, e) {
            e.stopPropagation();
            if (keyframes.length > 2) {
                keyframes.splice(index, 1);
                renderKeyframes();
            }
        }

        // Playback controls
        function togglePlay() {
            state.playing = !state.playing;
            document.getElementById('playBtn').textContent = state.playing ? '‚è∏ Pause' : '‚ñ∂ Play';
            document.getElementById('playBtnTimeline').textContent = state.playing ? '‚è∏' : '‚ñ∂';

            if (state.playing) {
                startTime = performance.now() - state.currentTime * 1000;
                animate();
            } else {
                cancelAnimationFrame(animationFrame);
            }
        }

        function animate() {
            if (!state.playing) return;

            state.currentTime = (performance.now() - startTime) / 1000;

            if (state.currentTime >= state.duration) {
                state.currentTime = 0;
                startTime = performance.now();
            }

            updateTimeDisplay();
            render();
            animationFrame = requestAnimationFrame(animate);
        }

        function updateTimeDisplay() {
            const minutes = Math.floor(state.currentTime / 60);
            const seconds = state.currentTime % 60;
            document.getElementById('timeDisplay').textContent =
                `${minutes}:${seconds.toFixed(2).padStart(5, '0')}`;

            const progress = (state.currentTime / state.duration) * 100;
            document.getElementById('timelineProgress').style.width = progress + '%';
        }

        function goToStart() {
            state.currentTime = 0;
            startTime = performance.now();
            updateTimeDisplay();
            render();
        }

        function goToEnd() {
            state.currentTime = state.duration;
            updateTimeDisplay();
            render();
        }

        function stepBack() {
            state.currentTime = Math.max(0, state.currentTime - 0.1);
            startTime = performance.now() - state.currentTime * 1000;
            updateTimeDisplay();
            render();
        }

        function stepForward() {
            state.currentTime = Math.min(state.duration, state.currentTime + 0.1);
            startTime = performance.now() - state.currentTime * 1000;
            updateTimeDisplay();
            render();
        }

        function scrubTimeline(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const progress = (e.clientX - rect.left) / rect.width;
            state.currentTime = progress * state.duration;
            startTime = performance.now() - state.currentTime * 1000;
            updateTimeDisplay();
            render();
        }

        // Aspect ratio
        function changeAspect() {
            const aspect = document.getElementById('aspectRatio').value;
            state.aspect = aspect;

            const baseWidth = 854;
            switch (aspect) {
                case '16:9':
                    canvas.width = baseWidth;
                    canvas.height = Math.round(baseWidth * 9 / 16);
                    break;
                case '9:16':
                    canvas.width = Math.round(baseWidth * 9 / 16);
                    canvas.height = baseWidth;
                    break;
                case '1:1':
                    canvas.width = baseWidth;
                    canvas.height = baseWidth;
                    break;
            }

            render();
        }

        // Zoom controls
        function zoomIn() {
            state.zoom = Math.min(2, state.zoom + 0.1);
            document.getElementById('previewContainer').style.transform = `scale(${state.zoom})`;
        }

        function zoomOut() {
            state.zoom = Math.max(0.5, state.zoom - 0.1);
            document.getElementById('previewContainer').style.transform = `scale(${state.zoom})`;
        }

        function resetZoom() {
            state.zoom = 1;
            document.getElementById('previewContainer').style.transform = `scale(1)`;
        }

        // Export modal
        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function exportAnimation() {
            const format = document.getElementById('exportFormat').value;
            const resolution = document.getElementById('exportResolution').value;
            const fps = document.getElementById('exportFps').value;

            alert(`Export settings:\n- Format: ${format.toUpperCase()}\n- Resolution: ${resolution}p\n- Frame Rate: ${fps}fps\n\nIn a full implementation, this would render and download the animation.`);
            closeExportModal();
        }

        // Close modal on overlay click
        document.getElementById('exportModal').addEventListener('click', (e) => {
            if (e.target.id === 'exportModal') closeExportModal();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch (e.code) {
                case 'Space':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowLeft':
                    stepBack();
                    break;
                case 'ArrowRight':
                    stepForward();
                    break;
                case 'Home':
                    goToStart();
                    break;
                case 'End':
                    goToEnd();
                    break;
            }
        });

        // Initialize
        init();
    </script>
</body>
</html>
